module.exports=[841210,e=>{"use strict";e.s(["handler",()=>L,"patchFetch",()=>b,"routeModule",()=>N,"serverHooks",()=>O,"workAsyncStorage",()=>M,"workUnitAsyncStorage",()=>H],841210);var t=e.i(747909),a=e.i(174017),n=e.i(996250),r=e.i(759756),i=e.i(561916),o=e.i(869741),s=e.i(316795),l=e.i(487718),u=e.i(995169),c=e.i(47587),d=e.i(666012),p=e.i(570101),m=e.i(626937),h=e.i(10372),y=e.i(193695);e.i(52474);var E=e.i(600220);e.s(["POST",()=>T],56019);var g=e.i(89171),f=e.i(720689),w=e.i(53438),v=e.i(444384),R=e.i(21564),C=e.i(919822),q=e.i(831120),D=e.i(508930);let P=new w.RealAtomiqSwapClient("MAINNET");new class{nodeEndpoint;macaroon;tlsCert;constructor(e,t,a){this.nodeEndpoint=e,this.macaroon=t,this.tlsCert=a}async decodeInvoice(e){if(e.includes("mock")){let t=e.match(/lnbc(\d+)u/);return{invoice:e,amountMsat:t?1e3*parseInt(t[1]):1e3,settled:!1,paymentHash:"hash_"+e.slice(-10),description:"Mock Lightning payment",expiry:Math.floor(Date.now()/1e3)+3600}}try{if(!e||!e.startsWith("ln"))throw Error('Invalid invoice format: must start with "ln"');let t=(0,v.decode)(e);return{invoice:e,amountMsat:"number"==typeof t.millisatoshis?t.millisatoshis:"string"==typeof t.millisatoshis?parseInt(t.millisatoshis):0,settled:!1,paymentHash:t.tagsObject.payment_hash,description:t.tagsObject.description,expiry:t.timeExpireDate?Math.floor(t.timeExpireDate/1e3):void 0,cltvExpiry:t.tagsObject.min_final_cltv_expiry}}catch(t){throw console.error("Failed to decode Lightning invoice:",e,t),Error(`Failed to decode invoice: ${t instanceof Error?t.message:"Unknown error"}`)}}async createInvoice(e,t,a=3600){if(this.nodeEndpoint&&this.macaroon)try{let n=await this.lndCall("POST","/v1/invoices",{value_msat:e.toString(),memo:t||"",expiry:a.toString()});return{invoice:n.payment_request,amountMsat:e,settled:!1,paymentHash:n.r_hash,description:t,expiry:Math.floor(Date.now()/1e3)+a}}catch(e){console.warn("LND API call failed, using fallback:",e)}let n=this.generatePaymentHash();return{invoice:this.generateMockInvoice(e,n,t,a),amountMsat:e,settled:!1,paymentHash:n,description:t,expiry:Math.floor(Date.now()/1e3)+a}}async payInvoice(e,t=60){let a=await this.decodeInvoice(e);if(this.nodeEndpoint&&this.macaroon)try{let n=await this.lndCall("POST","/v1/channels/transactions",{payment_request:e,timeout_seconds:t});return{paymentHash:n.payment_hash||a.paymentHash||"",paymentPreimage:n.payment_preimage,status:n.payment_error?"FAILED":"SUCCEEDED",failureReason:n.payment_error,amountMsat:a.amountMsat,creationTime:Date.now()}}catch(e){return console.warn("LND payment failed, using fallback:",e),{paymentHash:a.paymentHash||"",status:"FAILED",failureReason:e instanceof Error?e.message:"Unknown error",amountMsat:a.amountMsat,creationTime:Date.now()}}return{paymentHash:a.paymentHash||"",paymentPreimage:this.generatePreimage(),status:"SUCCEEDED",amountMsat:a.amountMsat,creationTime:Date.now()}}async payInvoiceSync(e){return this.payInvoice(e,30)}async sendPaymentMultiPath(e,t=16){let a=await this.decodeInvoice(e);return{paymentHash:a.paymentHash||"",paymentPreimage:this.generatePreimage(),status:"SUCCEEDED",amountMsat:a.amountMsat,creationTime:Date.now()}}async trackPayment(e){return{paymentHash:e,status:"SUCCEEDED",amountMsat:1e3,creationTime:Date.now()}}async listPayments(e=!1){return[]}async getChannelBalance(){return{localBalance:1e6,remoteBalance:5e5}}async estimateRoutingFee(e,t){return{feeMsat:Math.floor(.001*t)}}async sendKeysend(e,t,a){return{paymentHash:this.generatePaymentHash(),paymentPreimage:this.generatePreimage(),status:"SUCCEEDED",amountMsat:t,creationTime:Date.now()}}async getNodeInfo(){return{pubkey:"02"+"0".repeat(64),alias:"SLPM Lightning Node",version:"0.17.0"}}generatePaymentHash(){return Array.from(crypto.getRandomValues(new Uint8Array(32))).map(e=>e.toString(16).padStart(2,"0")).join("")}generatePreimage(){return Array.from(crypto.getRandomValues(new Uint8Array(32))).map(e=>e.toString(16).padStart(2,"0")).join("")}generateMockInvoice(e,t,a,n=3600){return`lnbc${Math.floor(e/1e3)}u1p${t.slice(0,8)}...mock`}async lndCall(e,t,a){if(!this.nodeEndpoint)throw Error("LND endpoint not configured");let n=`${this.nodeEndpoint}${t}`,r={"Content-Type":"application/json"};this.macaroon&&(r["Grpc-Metadata-macaroon"]=this.macaroon);let i={method:e,headers:r};a&&"GET"!==e&&(i.body=JSON.stringify(a)),this.tlsCert;let o=await fetch(n,i);if(!o.ok)throw Error(`LND API error: ${o.status} ${o.statusText}`);return o.json()}}(process.env.LND_URL||"",process.env.LND_MACAROON||"",process.env.LND_TLS||""),new R.RealCashuClient(process.env.CASHU_MINT||C.ENV.CASHU_DEFAULT_MINT);let S=new Map,_=new class{async initiate(e,t,a){let n=(0,f.randomHex)(12),r={id:n,from:e,to:"redacted",amountStrk:a,createdAt:Date.now(),updatedAt:Date.now(),state:"PIPELINE_CREATED"};return S.set(n,r),D.globalEventBus.emit({id:(0,f.randomHex)(8),type:"pipeline.created",at:Date.now(),payload:{transfer:r}}),this.run(n),r}get(e){return S.get(e)}update(e,t){let a=S.get(e);if(!a)throw Error("transfer not found");let n=a.state,r={...a,...t,updatedAt:Date.now()};return S.set(e,r),D.globalEventBus.emit({id:(0,f.randomHex)(8),type:"pipeline.updated",at:Date.now(),payload:{transfer:r}}),n!==r.state&&D.globalEventBus.emit({id:(0,f.randomHex)(8),type:"pipeline.state_changed",at:Date.now(),payload:{id:e,from:n,to:r.state}}),r}async run(e){try{this.update(e,{state:"SWAP_OUT_STRK_PENDING"});let t=await P.getQuote("STRK","BTC_LN",this.get(e).amountStrk);await P.execute(t.id),this.update(e,{state:"SWAP_OUT_STRK_COMPLETED",intermediateBtcMsat:1000n*BigInt(t.amountOut)});let a=function(e,t,a){let n=1e3*e,r="";n>=1e3?r=Math.floor(n/1e3).toString()+"m":n>=1&&(r=n.toString()+"p");let i=a||Math.random().toString(36).substring(2,10),o=`pp5qqqsysgq9q5sqqqqqq5sqqqqq5qz8d5qhqqqqqeqq8z5sq9q5sqqqq8z5sq5qqqqqqqqqqqqqqq${i}`;return`lnbc${r}1${o}`}(Number(t.amountOut),0,e.slice(-6));this.update(e,{state:"LN_DEPOSIT_PENDING",lnInvoice:a}),this.update(e,{state:"LN_DEPOSIT_SETTLED"});let n=[{secret:"sec_"+e,signature:"sig_"+e,amount:BigInt(t.amountOut),currency:"SAT",keysetId:"mock"}];this.update(e,{state:"ECASH_MINTED",ecashProofs:n});let r=await q.mixerEngine.createSession({currency:"SAT",targetAmounts:[n[0].amount]});await q.mixerEngine.deposit(r.session.id,n),await q.mixerEngine.startMixing(r.session.id);let i=(await q.mixerEngine.getSession(r.session.id))?.outputs??[];this.update(e,{sessionId:r.session.id,state:"REISSUED",mixedProofs:i}),this.update(e,{state:"SWAP_BACK_PENDING"});let o=await P.getQuote("BTC_LN","STRK",BigInt(t.amountOut)),s=await P.execute(o.id);this.update(e,{state:"SWAP_BACK_COMPLETED",swapBackTxId:s.txId}),this.update(e,{state:"PIPELINE_COMPLETED"}),D.globalEventBus.emit({id:(0,f.randomHex)(8),type:"pipeline.completed",at:Date.now(),payload:{id:e}})}catch(a){let t=a instanceof Error?a.message:"error";this.update(e,{state:"PIPELINE_FAILED",error:t}),D.globalEventBus.emit({id:(0,f.randomHex)(8),type:"pipeline.failed",at:Date.now(),payload:{id:e,error:t}})}}};var x=e.i(322632);let A=x.z.object({from:x.z.string(),to:x.z.string(),amountStrk:x.z.string().transform(e=>BigInt(e))});async function T(e){try{let t=await e.json(),a=A.parse(t),n=await _.initiate(a.from,a.to,a.amountStrk);return g.NextResponse.json(n)}catch(t){let e=t instanceof Error?t.message:"error";return g.NextResponse.json({error:e},{status:400})}}var I=e.i(56019);let N=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/pipeline/transfer/route",pathname:"/api/pipeline/transfer",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/pipeline/transfer/route.ts",nextConfigOutput:"",userland:I}),{workAsyncStorage:M,workUnitAsyncStorage:H,serverHooks:O}=N;function b(){return(0,n.patchFetch)({workAsyncStorage:M,workUnitAsyncStorage:H})}async function L(e,t,n){var g;let f="/api/pipeline/transfer/route";f=f.replace(/\/index$/,"")||"/";let w=await N.prepare(e,t,{srcPage:f,multiZoneDraftMode:!1});if(!w)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:v,params:R,nextConfig:C,isDraftMode:q,prerenderManifest:D,routerServerContext:P,isOnDemandRevalidate:S,revalidateOnlyGenerated:_,resolvedPathname:x}=w,A=(0,o.normalizeAppPath)(f),T=!!(D.dynamicRoutes[A]||D.routes[x]);if(T&&!q){let e=!!D.routes[x],t=D.dynamicRoutes[A];if(t&&!1===t.fallback&&!e)throw new y.NoFallbackError}let I=null;!T||N.isDev||q||(I="/index"===(I=x)?"/":I);let M=!0===N.isDev||!T,H=T&&!M,O=e.method||"GET",b=(0,i.getTracer)(),L=b.getActiveScopeSpan(),U={params:R,prerenderManifest:D,renderOpts:{experimental:{cacheComponents:!!C.experimental.cacheComponents,authInterrupts:!!C.experimental.authInterrupts},supportsDynamicResponse:M,incrementalCache:(0,r.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:null==(g=C.experimental)?void 0:g.cacheLife,isRevalidate:H,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,n)=>N.onRequestError(e,t,n,P)},sharedContext:{buildId:v}},k=new s.NodeNextRequest(e),B=new s.NodeNextResponse(t),$=l.NextRequestAdapter.fromNodeNextRequest(k,(0,l.signalFromNodeResponse)(t));try{let o=async a=>N.handle($,U).finally(()=>{if(!a)return;a.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let n=b.getRootSpanAttributes();if(!n)return;if(n.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${n.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=n.get("next.route");if(r){let e=`${O} ${r}`;a.setAttributes({"next.route":r,"http.route":r,"next.span_name":e}),a.updateName(e)}else a.updateName(`${O} ${e.url}`)}),s=async i=>{var s,l;let u=async({previousCacheEntry:a})=>{try{if(!(0,r.getRequestMeta)(e,"minimalMode")&&S&&_&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await o(i);e.fetchMetrics=U.renderOpts.fetchMetrics;let l=U.renderOpts.pendingWaitUntil;l&&n.waitUntil&&(n.waitUntil(l),l=void 0);let u=U.renderOpts.collectedTags;if(!T)return await (0,d.sendResponse)(k,B,s,U.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,p.toNodeOutgoingHttpHeaders)(s.headers);u&&(t[h.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==U.renderOpts.collectedRevalidate&&!(U.renderOpts.collectedRevalidate>=h.INFINITE_CACHE)&&U.renderOpts.collectedRevalidate,n=void 0===U.renderOpts.collectedExpire||U.renderOpts.collectedExpire>=h.INFINITE_CACHE?void 0:U.renderOpts.collectedExpire;return{value:{kind:E.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:n}}}}catch(t){throw(null==a?void 0:a.isStale)&&await N.onRequestError(e,t,{routerKind:"App Router",routePath:f,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isRevalidate:H,isOnDemandRevalidate:S})},P),t}},y=await N.handleResponse({req:e,nextConfig:C,cacheKey:I,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:D,isRoutePPREnabled:!1,isOnDemandRevalidate:S,revalidateOnlyGenerated:_,responseGenerator:u,waitUntil:n.waitUntil});if(!T)return null;if((null==y||null==(s=y.value)?void 0:s.kind)!==E.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==y||null==(l=y.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,r.getRequestMeta)(e,"minimalMode")||t.setHeader("x-nextjs-cache",S?"REVALIDATED":y.isMiss?"MISS":y.isStale?"STALE":"HIT"),q&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let g=(0,p.fromNodeOutgoingHttpHeaders)(y.value.headers);return(0,r.getRequestMeta)(e,"minimalMode")&&T||g.delete(h.NEXT_CACHE_TAGS_HEADER),!y.cacheControl||t.getHeader("Cache-Control")||g.get("Cache-Control")||g.set("Cache-Control",(0,m.getCacheControlHeader)(y.cacheControl)),await (0,d.sendResponse)(k,B,new Response(y.value.body,{headers:g,status:y.value.status||200})),null};L?await s(L):await b.withPropagatedContext(e.headers,()=>b.trace(u.BaseServerSpan.handleRequest,{spanName:`${O} ${e.url}`,kind:i.SpanKind.SERVER,attributes:{"http.method":O,"http.target":e.url}},s))}catch(t){if(L||t instanceof y.NoFallbackError||await N.onRequestError(e,t,{routerKind:"App Router",routePath:A,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isRevalidate:H,isOnDemandRevalidate:S})}),T)throw t;return await (0,d.sendResponse)(k,B,new Response(null,{status:500})),null}}}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_8e78c123.js.map