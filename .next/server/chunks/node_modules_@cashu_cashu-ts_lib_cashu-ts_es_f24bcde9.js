module.exports=[662951,t=>{"use strict";let e;t.s(["CashuAuthMint",()=>nP,"CashuAuthWallet",()=>nO,"CashuMint",()=>nA,"CashuWallet",()=>nR,"CheckStateEnum",()=>nl,"ConsoleLogger",()=>na,"HttpResponseError",()=>np,"LogLevel",()=>ni,"MeltQuoteState",()=>nh,"MintOperationError",()=>ng,"MintQuoteState",()=>nc,"NetworkError",()=>ny,"OutputData",()=>nU,"PaymentRequest",()=>rN,"PaymentRequestTransportType",()=>nd,"decodePaymentRequest",()=>r8,"deriveKeysetId",()=>rY,"getBlindedAuthToken",()=>nM,"getDecodedToken",()=>rG,"getDecodedTokenBinary",()=>nt,"getEncodedAuthToken",()=>nq,"getEncodedToken",()=>rj,"getEncodedTokenBinary",()=>r9,"getEncodedTokenV4",()=>rV,"getTokenMetadata",()=>rW,"hasValidDleq",()=>r7,"injectWebSocketImpl",()=>nn,"setGlobalRequestOptions",()=>nw],662951);var r,n=t.i(666680);let i=n&&"object"==typeof n&&"webcrypto"in n?n.webcrypto:n&&"object"==typeof n&&"randomBytes"in n?n:void 0;function o(t){return t instanceof Uint8Array||ArrayBuffer.isView(t)&&"Uint8Array"===t.constructor.name}function s(t){if(!Number.isSafeInteger(t)||t<0)throw Error("positive integer expected, got "+t)}function a(t,...e){if(!o(t))throw Error("Uint8Array expected");if(e.length>0&&!e.includes(t.length))throw Error("Uint8Array expected of length "+e+", got length="+t.length)}function u(t){if("function"!=typeof t||"function"!=typeof t.create)throw Error("Hash should be wrapped by utils.createHasher");s(t.outputLen),s(t.blockLen)}function f(t,e=!0){if(t.destroyed)throw Error("Hash instance has been destroyed");if(e&&t.finished)throw Error("Hash#digest() has already been called")}function l(...t){for(let e=0;e<t.length;e++)t[e].fill(0)}function h(t){return new DataView(t.buffer,t.byteOffset,t.byteLength)}function c(t,e){return t<<32-e|t>>>e}function d(t,e){return t<<e|t>>>32-e>>>0}let p="function"==typeof Uint8Array.from([]).toHex&&"function"==typeof Uint8Array.fromHex,y=Array.from({length:256},(t,e)=>e.toString(16).padStart(2,"0"));function g(t){if(a(t),p)return t.toHex();let e="";for(let r=0;r<t.length;r++)e+=y[t[r]];return e}let m={_0:48,_9:57,A:65,F:70,a:97,f:102};function b(t){return t>=m._0&&t<=m._9?t-m._0:t>=m.A&&t<=m.F?t-(m.A-10):t>=m.a&&t<=m.f?t-(m.a-10):void 0}function w(t){if("string"!=typeof t)throw Error("hex string expected, got "+typeof t);if(p)return Uint8Array.fromHex(t);let e=t.length,r=e/2;if(e%2)throw Error("hex string expected, got unpadded hex of length "+e);let n=new Uint8Array(r);for(let e=0,i=0;e<r;e++,i+=2){let r=b(t.charCodeAt(i)),o=b(t.charCodeAt(i+1));if(void 0===r||void 0===o)throw Error('hex string expected, got non-hex character "'+(t[i]+t[i+1])+'" at index '+i);n[e]=16*r+o}return n}function E(t){if("string"!=typeof t)throw Error("string expected");return new Uint8Array(new TextEncoder().encode(t))}function v(t){return"string"==typeof t&&(t=E(t)),a(t),t}function x(...t){let e=0;for(let r=0;r<t.length;r++){let n=t[r];a(n),e+=n.length}let r=new Uint8Array(e);for(let e=0,n=0;e<t.length;e++){let i=t[e];r.set(i,n),n+=i.length}return r}class B{}function k(t){let e=e=>t().update(v(e)).digest(),r=t();return e.outputLen=r.outputLen,e.blockLen=r.blockLen,e.create=()=>t(),e}function A(t=32){if(i&&"function"==typeof i.getRandomValues)return i.getRandomValues(new Uint8Array(t));if(i&&"function"==typeof i.randomBytes)return Uint8Array.from(i.randomBytes(t));throw Error("crypto.getRandomValues must be defined")}class _ extends B{constructor(t,e,r,n){super(),this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=t,this.outputLen=e,this.padOffset=r,this.isLE=n,this.buffer=new Uint8Array(t),this.view=h(this.buffer)}update(t){f(this),a(t=v(t));let{view:e,buffer:r,blockLen:n}=this,i=t.length;for(let o=0;o<i;){let s=Math.min(n-this.pos,i-o);if(s===n){let e=h(t);for(;n<=i-o;o+=n)this.process(e,o);continue}r.set(t.subarray(o,o+s),this.pos),this.pos+=s,o+=s,this.pos===n&&(this.process(e,0),this.pos=0)}return this.length+=t.length,this.roundClean(),this}digestInto(t){f(this);a(t);let e=this.outputLen;if(t.length<e)throw Error("digestInto() expects output buffer of length at least "+e);this.finished=!0;let{buffer:r,view:n,blockLen:i,isLE:o}=this,{pos:s}=this;r[s++]=128,l(this.buffer.subarray(s)),this.padOffset>i-s&&(this.process(n,0),s=0);for(let t=s;t<i;t++)r[t]=0;!function(t,e,r,n){if("function"==typeof t.setBigUint64)return t.setBigUint64(e,r,n);let i=BigInt(32),o=BigInt(0xffffffff),s=Number(r>>i&o),a=Number(r&o),u=4*!!n,f=4*!n;t.setUint32(e+u,s,n),t.setUint32(e+f,a,n)}(n,i-8,BigInt(8*this.length),o),this.process(n,0);let u=h(t),c=this.outputLen;if(c%4)throw Error("_sha2: outputLen should be aligned to 32bit");let d=c/4,p=this.get();if(d>p.length)throw Error("_sha2: outputLen bigger than state");for(let t=0;t<d;t++)u.setUint32(4*t,p[t],o)}digest(){let{buffer:t,outputLen:e}=this;this.digestInto(t);let r=t.slice(0,e);return this.destroy(),r}_cloneInto(t){t||(t=new this.constructor),t.set(...this.get());let{blockLen:e,buffer:r,length:n,finished:i,destroyed:o,pos:s}=this;return t.destroyed=o,t.finished=i,t.length=n,t.pos=s,n%e&&t.buffer.set(r),t}clone(){return this._cloneInto()}}let I=Uint32Array.from([0x6a09e667,0xbb67ae85,0x3c6ef372,0xa54ff53a,0x510e527f,0x9b05688c,0x1f83d9ab,0x5be0cd19]),S=Uint32Array.from([0xc1059ed8,0x367cd507,0x3070dd17,0xf70e5939,0xffc00b31,0x68581511,0x64f98fa7,0xbefa4fa4]),U=Uint32Array.from([0xcbbb9d5d,0xc1059ed8,0x629a292a,0x367cd507,0x9159015a,0x3070dd17,0x152fecd8,0xf70e5939,0x67332667,0xffc00b31,0x8eb44a87,0x68581511,0xdb0c2e0d,0x64f98fa7,0x47b5481d,0xbefa4fa4]),R=Uint32Array.from([0x6a09e667,0xf3bcc908,0xbb67ae85,0x84caa73b,0x3c6ef372,0xfe94f82b,0xa54ff53a,0x5f1d36f1,0x510e527f,0xade682d1,0x9b05688c,0x2b3e6c1f,0x1f83d9ab,0xfb41bd6b,0x5be0cd19,0x137e2179]),P=BigInt(0x100000000-1),O=BigInt(32),q=(t,e,r)=>t>>>r,M=(t,e,r)=>t<<32-r|e>>>r,T=(t,e,r)=>t>>>r|e<<32-r,N=(t,e,r)=>t<<32-r|e>>>r,K=(t,e,r)=>t<<64-r|e>>>r-32,C=(t,e,r)=>t>>>r-32|e<<64-r;function F(t,e,r,n){let i=(e>>>0)+(n>>>0);return{h:t+r+(i/0x100000000|0)|0,l:0|i}}let D=(t,e,r)=>(t>>>0)+(e>>>0)+(r>>>0),L=(t,e,r,n)=>e+r+n+(t/0x100000000|0)|0,$=(t,e,r,n)=>(t>>>0)+(e>>>0)+(r>>>0)+(n>>>0),H=(t,e,r,n,i)=>e+r+n+i+(t/0x100000000|0)|0,j=(t,e,r,n,i)=>(t>>>0)+(e>>>0)+(r>>>0)+(n>>>0)+(i>>>0),V=(t,e,r,n,i,o)=>e+r+n+i+o+(t/0x100000000|0)|0,z=Uint32Array.from([0x428a2f98,0x71374491,0xb5c0fbcf,0xe9b5dba5,0x3956c25b,0x59f111f1,0x923f82a4,0xab1c5ed5,0xd807aa98,0x12835b01,0x243185be,0x550c7dc3,0x72be5d74,0x80deb1fe,0x9bdc06a7,0xc19bf174,0xe49b69c1,0xefbe4786,0xfc19dc6,0x240ca1cc,0x2de92c6f,0x4a7484aa,0x5cb0a9dc,0x76f988da,0x983e5152,0xa831c66d,0xb00327c8,0xbf597fc7,0xc6e00bf3,0xd5a79147,0x6ca6351,0x14292967,0x27b70a85,0x2e1b2138,0x4d2c6dfc,0x53380d13,0x650a7354,0x766a0abb,0x81c2c92e,0x92722c85,0xa2bfe8a1,0xa81a664b,0xc24b8b70,0xc76c51a3,0xd192e819,0xd6990624,0xf40e3585,0x106aa070,0x19a4c116,0x1e376c08,0x2748774c,0x34b0bcb5,0x391c0cb3,0x4ed8aa4a,0x5b9cca4f,0x682e6ff3,0x748f82ee,0x78a5636f,0x84c87814,0x8cc70208,0x90befffa,0xa4506ceb,0xbef9a3f7,0xc67178f2]),Q=new Uint32Array(64);class G extends _{constructor(t=32){super(64,t,8,!1),this.A=0|I[0],this.B=0|I[1],this.C=0|I[2],this.D=0|I[3],this.E=0|I[4],this.F=0|I[5],this.G=0|I[6],this.H=0|I[7]}get(){let{A:t,B:e,C:r,D:n,E:i,F:o,G:s,H:a}=this;return[t,e,r,n,i,o,s,a]}set(t,e,r,n,i,o,s,a){this.A=0|t,this.B=0|e,this.C=0|r,this.D=0|n,this.E=0|i,this.F=0|o,this.G=0|s,this.H=0|a}process(t,e){for(let r=0;r<16;r++,e+=4)Q[r]=t.getUint32(e,!1);for(let t=16;t<64;t++){let e=Q[t-15],r=Q[t-2],n=c(e,7)^c(e,18)^e>>>3,i=c(r,17)^c(r,19)^r>>>10;Q[t]=i+Q[t-7]+n+Q[t-16]|0}let{A:r,B:n,C:i,D:o,E:s,F:a,G:u,H:f}=this;for(let t=0;t<64;t++){var l,h,d,p;let e=f+(c(s,6)^c(s,11)^c(s,25))+((l=s)&a^~l&u)+z[t]+Q[t]|0,y=(c(r,2)^c(r,13)^c(r,22))+((h=r)&(d=n)^h&(p=i)^d&p)|0;f=u,u=a,a=s,s=o+e|0,o=i,i=n,n=r,r=e+y|0}r=r+this.A|0,n=n+this.B|0,i=i+this.C|0,o=o+this.D|0,s=s+this.E|0,a=a+this.F|0,u=u+this.G|0,f=f+this.H|0,this.set(r,n,i,o,s,a,u,f)}roundClean(){l(Q)}destroy(){this.set(0,0,0,0,0,0,0,0),l(this.buffer)}}let W=function(t,e=!1){let r=t.length,n=new Uint32Array(r),i=new Uint32Array(r);for(let o=0;o<r;o++){let{h:r,l:s}=function(t,e=!1){return e?{h:Number(t&P),l:Number(t>>O&P)}:{h:0|Number(t>>O&P),l:0|Number(t&P)}}(t[o],e);[n[o],i[o]]=[r,s]}return[n,i]}(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(t=>BigInt(t))),Z=W[0],Y=W[1],J=new Uint32Array(80),X=new Uint32Array(80);class tt extends _{constructor(t=64){super(128,t,16,!1),this.Ah=0|R[0],this.Al=0|R[1],this.Bh=0|R[2],this.Bl=0|R[3],this.Ch=0|R[4],this.Cl=0|R[5],this.Dh=0|R[6],this.Dl=0|R[7],this.Eh=0|R[8],this.El=0|R[9],this.Fh=0|R[10],this.Fl=0|R[11],this.Gh=0|R[12],this.Gl=0|R[13],this.Hh=0|R[14],this.Hl=0|R[15]}get(){let{Ah:t,Al:e,Bh:r,Bl:n,Ch:i,Cl:o,Dh:s,Dl:a,Eh:u,El:f,Fh:l,Fl:h,Gh:c,Gl:d,Hh:p,Hl:y}=this;return[t,e,r,n,i,o,s,a,u,f,l,h,c,d,p,y]}set(t,e,r,n,i,o,s,a,u,f,l,h,c,d,p,y){this.Ah=0|t,this.Al=0|e,this.Bh=0|r,this.Bl=0|n,this.Ch=0|i,this.Cl=0|o,this.Dh=0|s,this.Dl=0|a,this.Eh=0|u,this.El=0|f,this.Fh=0|l,this.Fl=0|h,this.Gh=0|c,this.Gl=0|d,this.Hh=0|p,this.Hl=0|y}process(t,e){for(let r=0;r<16;r++,e+=4)J[r]=t.getUint32(e),X[r]=t.getUint32(e+=4);for(let t=16;t<80;t++){let e=0|J[t-15],r=0|X[t-15],n=T(e,r,1)^T(e,r,8)^q(e,r,7),i=N(e,r,1)^N(e,r,8)^M(e,r,7),o=0|J[t-2],s=0|X[t-2],a=T(o,s,19)^K(o,s,61)^q(o,s,6),u=$(i,N(o,s,19)^C(o,s,61)^M(o,s,6),X[t-7],X[t-16]),f=H(u,n,a,J[t-7],J[t-16]);J[t]=0|f,X[t]=0|u}let{Ah:r,Al:n,Bh:i,Bl:o,Ch:s,Cl:a,Dh:u,Dl:f,Eh:l,El:h,Fh:c,Fl:d,Gh:p,Gl:y,Hh:g,Hl:m}=this;for(let t=0;t<80;t++){let e=T(l,h,14)^T(l,h,18)^K(l,h,41),b=N(l,h,14)^N(l,h,18)^C(l,h,41),w=l&c^~l&p,E=j(m,b,h&d^~h&y,Y[t],X[t]),v=V(E,g,e,w,Z[t],J[t]),x=0|E,B=T(r,n,28)^K(r,n,34)^K(r,n,39),k=N(r,n,28)^C(r,n,34)^C(r,n,39),A=r&i^r&s^i&s,_=n&o^n&a^o&a;g=0|p,m=0|y,p=0|c,y=0|d,c=0|l,d=0|h,({h:l,l:h}=F(0|u,0|f,0|v,0|x)),u=0|s,f=0|a,s=0|i,a=0|o,i=0|r,o=0|n;let I=D(x,k,_);r=L(I,v,B,A),n=0|I}({h:r,l:n}=F(0|this.Ah,0|this.Al,0|r,0|n)),({h:i,l:o}=F(0|this.Bh,0|this.Bl,0|i,0|o)),({h:s,l:a}=F(0|this.Ch,0|this.Cl,0|s,0|a)),({h:u,l:f}=F(0|this.Dh,0|this.Dl,0|u,0|f)),({h:l,l:h}=F(0|this.Eh,0|this.El,0|l,0|h)),({h:c,l:d}=F(0|this.Fh,0|this.Fl,0|c,0|d)),({h:p,l:y}=F(0|this.Gh,0|this.Gl,0|p,0|y)),({h:g,l:m}=F(0|this.Hh,0|this.Hl,0|g,0|m)),this.set(r,n,i,o,s,a,u,f,l,h,c,d,p,y,g,m)}roundClean(){l(J,X)}destroy(){l(this.buffer),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}}let te=k(()=>new G),tr=k(()=>new tt);class tn extends B{constructor(t,e){super(),this.finished=!1,this.destroyed=!1,u(t);let r=v(e);if(this.iHash=t.create(),"function"!=typeof this.iHash.update)throw Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;let n=this.blockLen,i=new Uint8Array(n);i.set(r.length>n?t.create().update(r).digest():r);for(let t=0;t<i.length;t++)i[t]^=54;this.iHash.update(i),this.oHash=t.create();for(let t=0;t<i.length;t++)i[t]^=106;this.oHash.update(i),l(i)}update(t){return f(this),this.iHash.update(t),this}digestInto(t){f(this),a(t,this.outputLen),this.finished=!0,this.iHash.digestInto(t),this.oHash.update(t),this.oHash.digestInto(t),this.destroy()}digest(){let t=new Uint8Array(this.oHash.outputLen);return this.digestInto(t),t}_cloneInto(t){t||(t=Object.create(Object.getPrototypeOf(this),{}));let{oHash:e,iHash:r,finished:n,destroyed:i,blockLen:o,outputLen:s}=this;return t.finished=n,t.destroyed=i,t.blockLen=o,t.outputLen=s,t.oHash=e._cloneInto(t.oHash),t.iHash=r._cloneInto(t.iHash),t}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}let ti=(t,e,r)=>new tn(t,e).update(r).digest();ti.create=(t,e)=>new tn(t,e);let to=BigInt(0),ts=BigInt(1);function ta(t,e=""){if("boolean"!=typeof t)throw Error((e&&`"${e}"`)+"expected boolean, got type="+typeof t);return t}function tu(t,e,r=""){let n=o(t),i=t?.length,s=void 0!==e;if(!n||s&&i!==e)throw Error((r&&`"${r}" `)+"expected Uint8Array"+(s?` of length ${e}`:"")+", got "+(n?`length=${i}`:`type=${typeof t}`));return t}function tf(t){let e=t.toString(16);return 1&e.length?"0"+e:e}function tl(t){if("string"!=typeof t)throw Error("hex string expected, got "+typeof t);return""===t?to:BigInt("0x"+t)}function th(t){return tl(g(t))}function tc(t){return a(t),tl(g(Uint8Array.from(t).reverse()))}function td(t,e){return w(t.toString(16).padStart(2*e,"0"))}function tp(t,e){return td(t,e).reverse()}function ty(t,e,r){let n;if("string"==typeof e)try{n=w(e)}catch(e){throw Error(t+" must be hex string or Uint8Array, cause: "+e)}else if(o(e))n=Uint8Array.from(e);else throw Error(t+" must be hex string or Uint8Array");let i=n.length;if("number"==typeof r&&i!==r)throw Error(t+" of length "+r+" expected, got "+i);return n}let tg=t=>"bigint"==typeof t&&to<=t;function tm(t,e,r){return tg(t)&&tg(e)&&tg(r)&&e<=t&&t<r}function tb(t){let e;for(e=0;t>to;t>>=ts,e+=1);return e}let tw=t=>(ts<<BigInt(t))-ts;function tE(t,e,r={}){if(!t||"object"!=typeof t)throw Error("expected valid options object");function n(e,r,n){let i=t[e];if(n&&void 0===i)return;let o=typeof i;if(o!==r||null===i)throw Error(`param "${e}" is invalid: expected ${r}, got ${o}`)}Object.entries(e).forEach(([t,e])=>n(t,e,!1)),Object.entries(r).forEach(([t,e])=>n(t,e,!0))}function tv(t){let e=new WeakMap;return(r,...n)=>{let i=e.get(r);if(void 0!==i)return i;let o=t(r,...n);return e.set(r,o),o}}let tx=BigInt(0),tB=BigInt(1),tk=BigInt(2),tA=BigInt(3),t_=BigInt(4),tI=BigInt(5),tS=BigInt(7),tU=BigInt(8),tR=BigInt(9),tP=BigInt(16);function tO(t,e){let r=t%e;return r>=tx?r:e+r}function tq(t,e,r){let n=t;for(;e-- >tx;)n*=n,n%=r;return n}function tM(t,e){if(t===tx)throw Error("invert: expected non-zero number");if(e<=tx)throw Error("invert: expected positive modulus, got "+e);let r=tO(t,e),n=e,i=tx,o=tB,s=tB,a=tx;for(;r!==tx;){let t=n/r,e=n%r,u=i-s*t,f=o-a*t;n=r,r=e,i=s,o=a,s=u,a=f}if(n!==tB)throw Error("invert: does not exist");return tO(i,e)}function tT(t,e,r){if(!t.eql(t.sqr(e),r))throw Error("Cannot find square root")}function tN(t,e){let r=(t.ORDER+tB)/t_,n=t.pow(e,r);return tT(t,n,e),n}function tK(t,e){let r=(t.ORDER-tI)/tU,n=t.mul(e,tk),i=t.pow(n,r),o=t.mul(e,i),s=t.mul(t.mul(o,tk),i),a=t.mul(o,t.sub(s,t.ONE));return tT(t,a,e),a}function tC(t){if(t<tA)throw Error("sqrt is not defined for small field");let e=t-tB,r=0;for(;e%tk===tx;)e/=tk,r++;let n=tk,i=tj(t);for(;1===t$(i,n);)if(n++>1e3)throw Error("Cannot find square root: probably non-prime P");if(1===r)return tN;let o=i.pow(n,e),s=(e+tB)/tk;return function(t,n){if(t.is0(n))return n;if(1!==t$(t,n))throw Error("Cannot find square root");let i=r,a=t.mul(t.ONE,o),u=t.pow(n,e),f=t.pow(n,s);for(;!t.eql(u,t.ONE);){if(t.is0(u))return t.ZERO;let e=1,r=t.sqr(u);for(;!t.eql(r,t.ONE);)if(e++,r=t.sqr(r),e===i)throw Error("Cannot find square root");let n=tB<<BigInt(i-e-1),o=t.pow(a,n);i=e,a=t.sqr(o),u=t.mul(u,a),f=t.mul(f,o)}return f}}let tF=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function tD(t){return tE(t,tF.reduce((t,e)=>(t[e]="function",t),{ORDER:"bigint",MASK:"bigint",BYTES:"number",BITS:"number"})),t}function tL(t,e,r=!1){let n=Array(e.length).fill(r?t.ZERO:void 0),i=e.reduce((e,r,i)=>t.is0(r)?e:(n[i]=e,t.mul(e,r)),t.ONE),o=t.inv(i);return e.reduceRight((e,r,i)=>t.is0(r)?e:(n[i]=t.mul(e,n[i]),t.mul(e,r)),o),n}function t$(t,e){let r=(t.ORDER-tB)/tk,n=t.pow(e,r),i=t.eql(n,t.ONE),o=t.eql(n,t.ZERO),s=t.eql(n,t.neg(t.ONE));if(!i&&!o&&!s)throw Error("invalid Legendre symbol result");return i?1:o?0:-1}function tH(t,e){void 0!==e&&s(e);let r=void 0!==e?e:t.toString(2).length,n=Math.ceil(r/8);return{nBitLength:r,nByteLength:n}}function tj(t,e,r=!1,n={}){let i,o,s,a;if(t<=tx)throw Error("invalid field: expected ORDER > 0, got "+t);let u=!1;if("object"==typeof e&&null!=e){if(n.sqrt||r)throw Error("cannot specify opts in two arguments");e.BITS&&(o=e.BITS),e.sqrt&&(s=e.sqrt),"boolean"==typeof e.isLE&&(r=e.isLE),"boolean"==typeof e.modFromBytes&&(u=e.modFromBytes),a=e.allowedLengths}else"number"==typeof e&&(o=e),n.sqrt&&(s=n.sqrt);let{nBitLength:f,nByteLength:l}=tH(t,o);if(l>2048)throw Error("invalid field: expected ORDER of <= 2048 bytes");let h=Object.freeze({ORDER:t,isLE:r,BITS:f,BYTES:l,MASK:tw(f),ZERO:tx,ONE:tB,allowedLengths:a,create:e=>tO(e,t),isValid:e=>{if("bigint"!=typeof e)throw Error("invalid field element: expected bigint, got "+typeof e);return tx<=e&&e<t},is0:t=>t===tx,isValidNot0:t=>!h.is0(t)&&h.isValid(t),isOdd:t=>(t&tB)===tB,neg:e=>tO(-e,t),eql:(t,e)=>t===e,sqr:e=>tO(e*e,t),add:(e,r)=>tO(e+r,t),sub:(e,r)=>tO(e-r,t),mul:(e,r)=>tO(e*r,t),pow:(t,e)=>(function(t,e,r){if(r<tx)throw Error("invalid exponent, negatives unsupported");if(r===tx)return t.ONE;if(r===tB)return e;let n=t.ONE,i=e;for(;r>tx;)r&tB&&(n=t.mul(n,i)),i=t.sqr(i),r>>=tB;return n})(h,t,e),div:(e,r)=>tO(e*tM(r,t),t),sqrN:t=>t*t,addN:(t,e)=>t+e,subN:(t,e)=>t-e,mulN:(t,e)=>t*e,inv:e=>tM(e,t),sqrt:s||(e=>(i||(i=t%t_===tA?tN:t%tU===tI?tK:t%tP===tR?function(t){let e=tj(t),r=tC(t),n=r(e,e.neg(e.ONE)),i=r(e,n),o=r(e,e.neg(n)),s=(t+tS)/tP;return(t,e)=>{let r=t.pow(e,s),a=t.mul(r,n),u=t.mul(r,i),f=t.mul(r,o),l=t.eql(t.sqr(a),e),h=t.eql(t.sqr(u),e);r=t.cmov(r,a,l),a=t.cmov(f,u,h);let c=t.eql(t.sqr(a),e),d=t.cmov(r,a,c);return tT(t,d,e),d}}(t):tC(t)),i(h,e))),toBytes:t=>r?tp(t,l):td(t,l),fromBytes:(e,n=!0)=>{if(a){if(!a.includes(e.length)||e.length>l)throw Error("Field.fromBytes: expected "+a+" bytes, got "+e.length);let t=new Uint8Array(l);t.set(e,r?0:t.length-e.length),e=t}if(e.length!==l)throw Error("Field.fromBytes: expected "+l+" bytes, got "+e.length);let i=r?tc(e):th(e);if(u&&(i=tO(i,t)),!n&&!h.isValid(i))throw Error("invalid field element: outside of range 0..ORDER");return i},invertBatch:t=>tL(h,t),cmov:(t,e,r)=>r?e:t});return Object.freeze(h)}function tV(t){if("bigint"!=typeof t)throw Error("field order must be bigint");return Math.ceil(t.toString(2).length/8)}function tz(t){let e=tV(t);return e+Math.ceil(e/2)}function tQ(t,e,r=!1){let n=t.length,i=tV(e),o=tz(e);if(n<16||n<o||n>1024)throw Error("expected "+o+"-1024 bytes of input, got "+n);let s=tO(r?tc(t):th(t),e-tB)+tB;return r?tp(s,i):td(s,i)}let tG=BigInt(0),tW=BigInt(1);function tZ(t,e){let r=e.negate();return t?r:e}function tY(t,e){let r=tL(t.Fp,e.map(t=>t.Z));return e.map((e,n)=>t.fromAffine(e.toAffine(r[n])))}function tJ(t,e){if(!Number.isSafeInteger(t)||t<=0||t>e)throw Error("invalid window size, expected [1.."+e+"], got W="+t)}function tX(t,e){tJ(t,e);let r=Math.ceil(e/t)+1,n=2**(t-1),i=2**t;return{windows:r,windowSize:n,mask:tw(t),maxNumber:i,shiftBy:BigInt(t)}}function t0(t,e,r){let{windowSize:n,mask:i,maxNumber:o,shiftBy:s}=r,a=Number(t&i),u=t>>s;a>n&&(a-=o,u+=tW);let f=e*n,l=f+Math.abs(a)-1,h=0===a;return{nextN:u,offset:l,isZero:h,isNeg:a<0,isNegF:e%2!=0,offsetF:f}}let t1=new WeakMap,t2=new WeakMap;function t8(t){return t2.get(t)||1}function t6(t){if(t!==tG)throw Error("invalid wNAF")}class t5{constructor(t,e){this.BASE=t.BASE,this.ZERO=t.ZERO,this.Fn=t.Fn,this.bits=e}_unsafeLadder(t,e,r=this.ZERO){let n=t;for(;e>tG;)e&tW&&(r=r.add(n)),n=n.double(),e>>=tW;return r}precomputeWindow(t,e){let{windows:r,windowSize:n}=tX(e,this.bits),i=[],o=t,s=o;for(let t=0;t<r;t++){s=o,i.push(s);for(let t=1;t<n;t++)s=s.add(o),i.push(s);o=s.double()}return i}wNAF(t,e,r){if(!this.Fn.isValid(r))throw Error("invalid scalar");let n=this.ZERO,i=this.BASE,o=tX(t,this.bits);for(let t=0;t<o.windows;t++){let{nextN:s,offset:a,isZero:u,isNeg:f,isNegF:l,offsetF:h}=t0(r,t,o);r=s,u?i=i.add(tZ(l,e[h])):n=n.add(tZ(f,e[a]))}return t6(r),{p:n,f:i}}wNAFUnsafe(t,e,r,n=this.ZERO){let i=tX(t,this.bits);for(let t=0;t<i.windows&&r!==tG;t++){let{nextN:o,offset:s,isZero:a,isNeg:u}=t0(r,t,i);if(r=o,!a){let t=e[s];n=n.add(u?t.negate():t)}}return t6(r),n}getPrecomputes(t,e,r){let n=t1.get(e);return n||(n=this.precomputeWindow(e,t),1!==t&&("function"==typeof r&&(n=r(n)),t1.set(e,n))),n}cached(t,e,r){let n=t8(t);return this.wNAF(n,this.getPrecomputes(n,t,r),e)}unsafe(t,e,r,n){let i=t8(t);return 1===i?this._unsafeLadder(t,e,n):this.wNAFUnsafe(i,this.getPrecomputes(i,t,r),e,n)}createCache(t,e){tJ(e,this.bits),t2.set(t,e),t1.delete(t)}hasCache(t){return 1!==t8(t)}}function t3(t,e,r){if(!e)return tj(t,{isLE:r});if(e.ORDER!==t)throw Error("Field.ORDER must match order: Fp == p, Fn == n");return tD(e),e}let t4=(t,e)=>(t+(t>=0?e:-e)/en)/e;function t7(t){if(!["compact","recovered","der"].includes(t))throw Error('Signature format must be "compact", "recovered", or "der"');return t}function t9(t,e){let r={};for(let n of Object.keys(e))r[n]=void 0===t[n]?e[n]:t[n];return ta(r.lowS,"lowS"),ta(r.prehash,"prehash"),void 0!==r.format&&t7(r.format),r}let et={Err:class extends Error{constructor(t=""){super(t)}},_tlv:{encode:(t,e)=>{let{Err:r}=et;if(t<0||t>256)throw new r("tlv.encode: wrong tag");if(1&e.length)throw new r("tlv.encode: unpadded data");let n=e.length/2,i=tf(n);if(i.length/2&128)throw new r("tlv.encode: long form length too big");let o=n>127?tf(i.length/2|128):"";return tf(t)+o+i+e},decode(t,e){let{Err:r}=et,n=0;if(t<0||t>256)throw new r("tlv.encode: wrong tag");if(e.length<2||e[n++]!==t)throw new r("tlv.decode: wrong tlv");let i=e[n++],o=0;if(128&i){let t=127&i;if(!t)throw new r("tlv.decode(long): indefinite length not supported");if(t>4)throw new r("tlv.decode(long): byte length is too big");let s=e.subarray(n,n+t);if(s.length!==t)throw new r("tlv.decode: length bytes not complete");if(0===s[0])throw new r("tlv.decode(long): zero leftmost byte");for(let t of s)o=o<<8|t;if(n+=t,o<128)throw new r("tlv.decode(long): not minimal encoding")}else o=i;let s=e.subarray(n,n+o);if(s.length!==o)throw new r("tlv.decode: wrong value length");return{v:s,l:e.subarray(n+o)}}},_int:{encode(t){let{Err:e}=et;if(t<ee)throw new e("integer: negative integers are not allowed");let r=tf(t);if(8&Number.parseInt(r[0],16)&&(r="00"+r),1&r.length)throw new e("unexpected DER parsing assertion: unpadded hex");return r},decode(t){let{Err:e}=et;if(128&t[0])throw new e("invalid signature integer: negative");if(0===t[0]&&!(128&t[1]))throw new e("invalid signature integer: unnecessary leading zero");return th(t)}},toSig(t){let{Err:e,_int:r,_tlv:n}=et,i=ty("signature",t),{v:o,l:s}=n.decode(48,i);if(s.length)throw new e("invalid signature: left bytes after parsing");let{v:a,l:u}=n.decode(2,o),{v:f,l:l}=n.decode(2,u);if(l.length)throw new e("invalid signature: left bytes after parsing");return{r:r.decode(a),s:r.decode(f)}},hexFromSig(t){let{_tlv:e,_int:r}=et,n=e.encode(2,r.encode(t.r)),i=e.encode(2,r.encode(t.s));return e.encode(48,n+i)}},ee=BigInt(0),er=BigInt(1),en=BigInt(2),ei=BigInt(3),eo=BigInt(4);function es(t,e){let r,{BYTES:n}=t;if("bigint"==typeof e)r=e;else{let i=ty("private key",e);try{r=t.fromBytes(i)}catch(t){throw Error(`invalid private key: expected ui8a of size ${n}, got ${typeof e}`)}}if(!t.isValidNot0(r))throw Error("invalid private key: out of range [1..N-1]");return r}function ea(t){return Uint8Array.of(t?2:3)}function eu(t,e){return{secretKey:e.BYTES,publicKey:1+t.BYTES,publicKeyUncompressed:1+2*t.BYTES,publicKeyHasPrefix:!0,signature:2*e.BYTES}}E("HashToScalar-");let ef={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),n:BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),h:BigInt(1),a:BigInt(0),b:BigInt(7),Gx:BigInt("0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798"),Gy:BigInt("0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8")},el={beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),basises:[[BigInt("0x3086d221a7d46bcde86c90e49284eb15"),-BigInt("0xe4437ed6010e88286f547fa90abfe4c3")],[BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),BigInt("0x3086d221a7d46bcde86c90e49284eb15")]]},eh=BigInt(0),ec=BigInt(1),ed=BigInt(2),ep=tj(ef.p,{sqrt:function(t){let e=ef.p,r=BigInt(3),n=BigInt(6),i=BigInt(11),o=BigInt(22),s=BigInt(23),a=BigInt(44),u=BigInt(88),f=t*t*t%e,l=f*f*t%e,h=tq(l,r,e)*l%e,c=tq(h,r,e)*l%e,d=tq(c,ed,e)*f%e,p=tq(d,i,e)*d%e,y=tq(p,o,e)*p%e,g=tq(y,a,e)*y%e,m=tq(g,u,e)*g%e,b=tq(m,a,e)*y%e,w=tq(b,r,e)*l%e,E=tq(w,s,e)*p%e,v=tq(E,n,e)*f%e,x=tq(v,ed,e);if(!ep.eql(ep.sqr(x),t))throw Error("Cannot find square root");return x}}),ey=function(t,e){let r=e=>(function(t){let{CURVE:e,curveOpts:r,hash:n,ecdsaOpts:i}=function(t){let{CURVE:e,curveOpts:r}=function(t){let e={a:t.a,b:t.b,p:t.Fp.ORDER,n:t.n,h:t.h,Gx:t.Gx,Gy:t.Gy},r=t.Fp,n=t.allowedPrivateKeyLengths?Array.from(new Set(t.allowedPrivateKeyLengths.map(t=>Math.ceil(t/2)))):void 0,i={Fp:r,Fn:tj(e.n,{BITS:t.nBitLength,allowedLengths:n,modFromBytes:t.wrapPrivateKey}),allowInfinityPoint:t.allowInfinityPoint,endo:t.endo,isTorsionFree:t.isTorsionFree,clearCofactor:t.clearCofactor,fromBytes:t.fromBytes,toBytes:t.toBytes};return{CURVE:e,curveOpts:i}}(t),n={hmac:t.hmac,randomBytes:t.randomBytes,lowS:t.lowS,bits2int:t.bits2int,bits2int_modN:t.bits2int_modN};return{CURVE:e,curveOpts:r,hash:t.hash,ecdsaOpts:n}}(t),s=function(t,e,r={}){u(e),tE(r,{},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"});let n=r.randomBytes||A,i=r.hmac||((t,...r)=>ti(e,t,x(...r))),{Fp:s,Fn:a}=t,{ORDER:f,BITS:l}=a,{keygen:h,getPublicKey:c,getSharedSecret:d,utils:p,lengths:y}=function(t,e={}){let{Fn:r}=t,n=e.randomBytes||A,i=Object.assign(eu(t.Fp,r),{seed:tz(r.ORDER)});function o(t){try{return!!es(r,t)}catch(t){return!1}}function s(t=n(i.seed)){return tQ(tu(t,i.seed,"seed"),r.ORDER)}function a(e,n=!0){return t.BASE.multiply(es(r,e)).toBytes(n)}function u(e){if("bigint"==typeof e)return!1;if(e instanceof t)return!0;let{secretKey:n,publicKey:o,publicKeyUncompressed:s}=i;if(r.allowedLengths||n===o)return;let a=ty("key",e).length;return a===o||a===s}return Object.freeze({getPublicKey:a,getSharedSecret:function(e,n,i=!0){if(!0===u(e))throw Error("first arg must be private key");if(!1===u(n))throw Error("second arg must be public key");let o=es(r,e);return t.fromHex(n).multiply(o).toBytes(i)},keygen:function(t){let e=s(t);return{secretKey:e,publicKey:a(e)}},Point:t,utils:{isValidSecretKey:o,isValidPublicKey:function(e,r){let{publicKey:n,publicKeyUncompressed:o}=i;try{let i=e.length;if(!0===r&&i!==n||!1===r&&i!==o)return!1;return!!t.fromBytes(e)}catch(t){return!1}},randomSecretKey:s,isValidPrivateKey:o,randomPrivateKey:s,normPrivateKeyToScalar:t=>es(r,t),precompute:(e=8,r=t.BASE)=>r.precompute(e,!1)},lengths:i})}(t,r),m={prehash:!1,lowS:"boolean"==typeof r.lowS&&r.lowS,format:void 0,extraEntropy:!1},b="compact";function E(t,e){if(!a.isValidNot0(e))throw Error(`invalid signature ${t}: out of range 1..Point.Fn.ORDER`);return e}class v{constructor(t,e,r){this.r=E("r",t),this.s=E("s",e),null!=r&&(this.recovery=r),Object.freeze(this)}static fromBytes(t,e=b){let r;if(!function(t,e){t7(e);let r=y.signature;tu(t,"compact"===e?r:"recovered"===e?r+1:void 0,`${e} signature`)}(t,e),"der"===e){let{r:e,s:r}=et.toSig(tu(t));return new v(e,r)}"recovered"===e&&(r=t[0],e="compact",t=t.subarray(1));let n=a.BYTES,i=t.subarray(0,n),o=t.subarray(n,2*n);return new v(a.fromBytes(i),a.fromBytes(o),r)}static fromHex(t,e){return this.fromBytes(w(t),e)}addRecoveryBit(t){return new v(this.r,this.s,t)}recoverPublicKey(e){let r=s.ORDER,{r:n,s:i,recovery:o}=this;if(null==o||![0,1,2,3].includes(o))throw Error("recovery id invalid");if(f*en<r&&o>1)throw Error("recovery id is ambiguous for h>1 curve");let u=2===o||3===o?n+f:n;if(!s.isValid(u))throw Error("recovery id 2 or 3 invalid");let l=s.toBytes(u),h=t.fromBytes(x(ea((1&o)==0),l)),c=a.inv(u),d=k(ty("msgHash",e)),p=a.create(-d*c),y=a.create(i*c),g=t.BASE.multiplyUnsafe(p).add(h.multiplyUnsafe(y));if(g.is0())throw Error("point at infinify");return g.assertValidity(),g}hasHighS(){return this.s>f>>er}toBytes(t=b){if(t7(t),"der"===t)return w(et.hexFromSig(this));let e=a.toBytes(this.r),r=a.toBytes(this.s);if("recovered"===t){if(null==this.recovery)throw Error("recovery bit must be present");return x(Uint8Array.of(this.recovery),e,r)}return x(e,r)}toHex(t){return g(this.toBytes(t))}assertValidity(){}static fromCompact(t){return v.fromBytes(ty("sig",t),"compact")}static fromDER(t){return v.fromBytes(ty("sig",t),"der")}normalizeS(){return this.hasHighS()?new v(this.r,a.neg(this.s),this.recovery):this}toDERRawBytes(){return this.toBytes("der")}toDERHex(){return g(this.toBytes("der"))}toCompactRawBytes(){return this.toBytes("compact")}toCompactHex(){return g(this.toBytes("compact"))}}let B=r.bits2int||function(t){if(t.length>8192)throw Error("input is too large");let e=th(t),r=8*t.length-l;return r>0?e>>BigInt(r):e},k=r.bits2int_modN||function(t){return a.create(B(t))},_=tw(l);function I(t){var e="num < 2^"+l;if(!tm(t,ee,_))throw Error("expected valid "+e+": "+ee+" <= n < "+_+", got "+t);return a.toBytes(t)}function S(t,r){return tu(t,void 0,"message"),r?tu(e(t),void 0,"prehashed message"):t}return Object.freeze({keygen:h,getPublicKey:c,getSharedSecret:d,utils:p,lengths:y,Point:t,sign:function(r,o,s={}){let{seed:u,k2sig:l}=function(e,r,i){if(["recovered","canonical"].some(t=>t in i))throw Error("sign() legacy options not supported");let{lowS:o,prehash:s,extraEntropy:u}=t9(i,m),l=k(e=S(e,s)),h=es(a,r),c=[I(h),I(l)];if(null!=u&&!1!==u){let t=!0===u?n(y.secretKey):u;c.push(ty("extraEntropy",t))}return{seed:x(...c),k2sig:function(e){let r=B(e);if(!a.isValidNot0(r))return;let n=a.inv(r),i=t.BASE.multiply(r).toAffine(),s=a.create(i.x);if(s===ee)return;let u=a.create(n*a.create(l+s*h));if(u===ee)return;let c=2*(i.x!==s)|Number(i.y&er),d=u;return o&&u>f>>er&&(d=a.neg(u),c^=1),new v(s,d,c)}}}(r=ty("message",r),o,s);return(function(t,e,r){if("number"!=typeof t||t<2)throw Error("hashLen must be a number");if("number"!=typeof e||e<2)throw Error("qByteLen must be a number");if("function"!=typeof r)throw Error("hmacFn must be a function");let n=t=>new Uint8Array(t),i=t=>Uint8Array.of(t),o=n(t),s=n(t),a=0,u=()=>{o.fill(1),s.fill(0),a=0},f=(...t)=>r(s,o,...t),l=(t=n(0))=>{s=f(i(0),t),o=f(),0!==t.length&&(s=f(i(1),t),o=f())},h=()=>{if(a++>=1e3)throw Error("drbg: tried 1000 values");let t=0,r=[];for(;t<e;){let e=(o=f()).slice();r.push(e),t+=o.length}return x(...r)};return(t,e)=>{let r;for(u(),l(t);!(r=e(h()));)l();return u(),r}})(e.outputLen,a.BYTES,i)(u,l)},verify:function(e,r,n,i={}){let{lowS:s,prehash:u,format:f}=t9(i,m);if(n=ty("publicKey",n),r=S(ty("message",r),u),"strict"in i)throw Error("options.strict was renamed to lowS");let l=void 0===f?function(t){let e,r="string"==typeof t||o(t),n=!r&&null!==t&&"object"==typeof t&&"bigint"==typeof t.r&&"bigint"==typeof t.s;if(!r&&!n)throw Error("invalid signature, expected Uint8Array, hex string or Signature instance");if(n)e=new v(t.r,t.s);else if(r){try{e=v.fromBytes(ty("sig",t),"der")}catch(t){if(!(t instanceof et.Err))throw t}if(!e)try{e=v.fromBytes(ty("sig",t),"compact")}catch(t){return!1}}return!!e&&e}(e):v.fromBytes(ty("sig",e),f);if(!1===l)return!1;try{let e=t.fromBytes(n);if(s&&l.hasHighS())return!1;let{r:i,s:o}=l,u=k(r),f=a.inv(o),h=a.create(u*f),c=a.create(i*f),d=t.BASE.multiplyUnsafe(h).add(e.multiplyUnsafe(c));if(d.is0())return!1;return a.create(d.x)===i}catch(t){return!1}},recoverPublicKey:function(t,e,r={}){let{prehash:n}=t9(r,m);return e=S(e,n),v.fromBytes(t,"recovered").recoverPublicKey(e).toBytes()},Signature:v,hash:e})}(function(t,e={}){let r=function(t,e,r={},n){if(void 0===n&&(n="edwards"===t),!e||"object"!=typeof e)throw Error(`expected valid ${t} CURVE object`);for(let t of["p","n","h"]){let r=e[t];if(!("bigint"==typeof r&&r>tG))throw Error(`CURVE.${t} must be positive bigint`)}let i=t3(e.p,r.Fp,n),o=t3(e.n,r.Fn,n);for(let r of["Gx","Gy","a","weierstrass"===t?"b":"d"])if(!i.isValid(e[r]))throw Error(`CURVE.${r} must be valid field element of CURVE.Fp`);return{CURVE:e=Object.freeze(Object.assign({},e)),Fp:i,Fn:o}}("weierstrass",t,e),{Fp:n,Fn:i}=r,o=r.CURVE,{h:s,n:a}=o;tE(e,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object",wrapPrivateKey:"boolean"});let{endo:u}=e;if(u&&(!n.is0(o.a)||"bigint"!=typeof u.beta||!Array.isArray(u.basises)))throw Error('invalid endo: expected "beta": bigint and "basises": array');let f=eu(n,i);function l(){if(!n.isOdd)throw Error("compression is not supported: Field does not have .isOdd()")}let h=e.toBytes||function(t,e,r){let{x:i,y:o}=e.toAffine(),s=n.toBytes(i);return(ta(r,"isCompressed"),r)?(l(),x(ea(!n.isOdd(o)),s)):x(Uint8Array.of(4),s,n.toBytes(o))},c=e.fromBytes||function(t){tu(t,void 0,"Point");let{publicKey:e,publicKeyUncompressed:r}=f,i=t.length,o=t[0],s=t.subarray(1);if(i===e&&(2===o||3===o)){let t,e=n.fromBytes(s);if(!n.isValid(e))throw Error("bad point: is not on curve, wrong x");let r=d(e);try{t=n.sqrt(r)}catch(t){throw Error("bad point: is not on curve, sqrt error"+(t instanceof Error?": "+t.message:""))}return l(),(1&o)==1!==n.isOdd(t)&&(t=n.neg(t)),{x:e,y:t}}if(i===r&&4===o){let t=n.BYTES,e=n.fromBytes(s.subarray(0,t)),r=n.fromBytes(s.subarray(t,2*t));if(!p(e,r))throw Error("bad point: is not on curve");return{x:e,y:r}}throw Error(`bad point: got length ${i}, expected compressed=${e} or uncompressed=${r}`)};function d(t){let e=n.sqr(t),r=n.mul(e,t);return n.add(n.add(r,n.mul(t,o.a)),o.b)}function p(t,e){let r=n.sqr(e),i=d(t);return n.eql(r,i)}if(!p(o.Gx,o.Gy))throw Error("bad curve params: generator point");let y=n.mul(n.pow(o.a,ei),eo),m=n.mul(n.sqr(o.b),BigInt(27));if(n.is0(n.add(y,m)))throw Error("bad curve params: a or b");function b(t,e,r=!1){if(!n.isValid(e)||r&&n.is0(e))throw Error(`bad point coordinate ${t}`);return e}function w(t){if(!(t instanceof A))throw Error("ProjectivePoint expected")}function E(t){if(!u||!u.basises)throw Error("no endo");return function(t,e,r){let[[n,i],[o,s]]=e,a=t4(s*t,r),u=t4(-i*t,r),f=t-a*n-u*o,l=-a*i-u*s,h=f<ee,c=l<ee;h&&(f=-f),c&&(l=-l);let d=tw(Math.ceil(tb(r)/2))+er;if(f<ee||f>=d||l<ee||l>=d)throw Error("splitScalar (endomorphism): failed, k="+t);return{k1neg:h,k1:f,k2neg:c,k2:l}}(t,u.basises,i.ORDER)}let v=tv((t,e)=>{let{X:r,Y:i,Z:o}=t;if(n.eql(o,n.ONE))return{x:r,y:i};let s=t.is0();null==e&&(e=s?n.ONE:n.inv(o));let a=n.mul(r,e),u=n.mul(i,e),f=n.mul(o,e);if(s)return{x:n.ZERO,y:n.ZERO};if(!n.eql(f,n.ONE))throw Error("invZ was invalid");return{x:a,y:u}}),B=tv(t=>{if(t.is0()){if(e.allowInfinityPoint&&!n.is0(t.Y))return;throw Error("bad point: ZERO")}let{x:r,y:i}=t.toAffine();if(!n.isValid(r)||!n.isValid(i))throw Error("bad point: x or y not field elements");if(!p(r,i))throw Error("bad point: equation left != right");if(!t.isTorsionFree())throw Error("bad point: not in prime-order subgroup");return!0});function k(t,e,r,i,o){return r=new A(n.mul(r.X,t),r.Y,r.Z),e=tZ(i,e),r=tZ(o,r),e.add(r)}class A{constructor(t,e,r){this.X=b("x",t),this.Y=b("y",e,!0),this.Z=b("z",r),Object.freeze(this)}static CURVE(){return o}static fromAffine(t){let{x:e,y:r}=t||{};if(!t||!n.isValid(e)||!n.isValid(r))throw Error("invalid affine point");if(t instanceof A)throw Error("projective point not allowed");return n.is0(e)&&n.is0(r)?A.ZERO:new A(e,r,n.ONE)}static fromBytes(t){let e=A.fromAffine(c(tu(t,void 0,"point")));return e.assertValidity(),e}static fromHex(t){return A.fromBytes(ty("pointHex",t))}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(t=8,e=!0){return I.createCache(this,t),e||this.multiply(ei),this}assertValidity(){B(this)}hasEvenY(){let{y:t}=this.toAffine();if(!n.isOdd)throw Error("Field doesn't support isOdd");return!n.isOdd(t)}equals(t){w(t);let{X:e,Y:r,Z:i}=this,{X:o,Y:s,Z:a}=t,u=n.eql(n.mul(e,a),n.mul(o,i)),f=n.eql(n.mul(r,a),n.mul(s,i));return u&&f}negate(){return new A(this.X,n.neg(this.Y),this.Z)}double(){let{a:t,b:e}=o,r=n.mul(e,ei),{X:i,Y:s,Z:a}=this,u=n.ZERO,f=n.ZERO,l=n.ZERO,h=n.mul(i,i),c=n.mul(s,s),d=n.mul(a,a),p=n.mul(i,s);return p=n.add(p,p),l=n.mul(i,a),l=n.add(l,l),u=n.mul(t,l),f=n.mul(r,d),f=n.add(u,f),u=n.sub(c,f),f=n.add(c,f),f=n.mul(u,f),u=n.mul(p,u),l=n.mul(r,l),d=n.mul(t,d),p=n.sub(h,d),p=n.mul(t,p),p=n.add(p,l),l=n.add(h,h),h=n.add(l,h),h=n.add(h,d),h=n.mul(h,p),f=n.add(f,h),d=n.mul(s,a),d=n.add(d,d),h=n.mul(d,p),u=n.sub(u,h),l=n.mul(d,c),l=n.add(l,l),new A(u,f,l=n.add(l,l))}add(t){w(t);let{X:e,Y:r,Z:i}=this,{X:s,Y:a,Z:u}=t,f=n.ZERO,l=n.ZERO,h=n.ZERO,c=o.a,d=n.mul(o.b,ei),p=n.mul(e,s),y=n.mul(r,a),g=n.mul(i,u),m=n.add(e,r),b=n.add(s,a);m=n.mul(m,b),b=n.add(p,y),m=n.sub(m,b),b=n.add(e,i);let E=n.add(s,u);return b=n.mul(b,E),E=n.add(p,g),b=n.sub(b,E),E=n.add(r,i),f=n.add(a,u),E=n.mul(E,f),f=n.add(y,g),E=n.sub(E,f),h=n.mul(c,b),f=n.mul(d,g),h=n.add(f,h),f=n.sub(y,h),h=n.add(y,h),l=n.mul(f,h),y=n.add(p,p),y=n.add(y,p),g=n.mul(c,g),b=n.mul(d,b),y=n.add(y,g),g=n.sub(p,g),g=n.mul(c,g),b=n.add(b,g),p=n.mul(y,b),l=n.add(l,p),p=n.mul(E,b),f=n.mul(m,f),f=n.sub(f,p),p=n.mul(m,y),h=n.mul(E,h),new A(f,l,h=n.add(h,p))}subtract(t){return this.add(t.negate())}is0(){return this.equals(A.ZERO)}multiply(t){let r,n,{endo:o}=e;if(!i.isValidNot0(t))throw Error("invalid scalar: out of range");let s=t=>I.cached(this,t,t=>tY(A,t));if(o){let{k1neg:e,k1:i,k2neg:a,k2:u}=E(t),{p:f,f:l}=s(i),{p:h,f:c}=s(u);n=l.add(c),r=k(o.beta,f,h,e,a)}else{let{p:e,f:i}=s(t);r=e,n=i}return tY(A,[r,n])[0]}multiplyUnsafe(t){let{endo:r}=e;if(!i.isValid(t))throw Error("invalid scalar: out of range");if(t===ee||this.is0())return A.ZERO;if(t===er)return this;if(I.hasCache(this))return this.multiply(t);if(!r)return I.unsafe(this,t);{let{k1neg:e,k1:n,k2neg:i,k2:o}=E(t),{p1:s,p2:a}=function(t,e,r,n){let i=e,o=t.ZERO,s=t.ZERO;for(;r>tG||n>tG;)r&tW&&(o=o.add(i)),n&tW&&(s=s.add(i)),i=i.double(),r>>=tW,n>>=tW;return{p1:o,p2:s}}(A,this,n,o);return k(r.beta,s,a,e,i)}}multiplyAndAddUnsafe(t,e,r){let n=this.multiplyUnsafe(e).add(t.multiplyUnsafe(r));return n.is0()?void 0:n}toAffine(t){return v(this,t)}isTorsionFree(){let{isTorsionFree:t}=e;return s===er||(t?t(A,this):I.unsafe(this,a).is0())}clearCofactor(){let{clearCofactor:t}=e;return s===er?this:t?t(A,this):this.multiplyUnsafe(s)}isSmallOrder(){return this.multiplyUnsafe(s).is0()}toBytes(t=!0){return ta(t,"isCompressed"),this.assertValidity(),h(A,this,t)}toHex(t=!0){return g(this.toBytes(t))}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}get px(){return this.X}get py(){return this.X}get pz(){return this.Z}toRawBytes(t=!0){return this.toBytes(t)}_setWindowSize(t){this.precompute(t)}static normalizeZ(t){return tY(A,t)}static msm(t,e){return function(t,e,r,n){if(!Array.isArray(r))throw Error("array expected");r.forEach((e,r)=>{if(!(e instanceof t))throw Error("invalid point at index "+r)});if(!Array.isArray(n))throw Error("array of scalars expected");n.forEach((t,r)=>{if(!e.isValid(t))throw Error("invalid scalar at index "+r)});let i=r.length,o=n.length;if(i!==o)throw Error("arrays of points and scalars must have equal length");let s=t.ZERO,a=tb(BigInt(i)),u=1;a>12?u=a-3:a>4?u=a-2:a>0&&(u=2);let f=tw(u),l=Array(Number(f)+1).fill(s),h=Math.floor((e.BITS-1)/u)*u,c=s;for(let t=h;t>=0;t-=u){l.fill(s);for(let e=0;e<o;e++){let i=Number(n[e]>>BigInt(t)&f);l[i]=l[i].add(r[e])}let e=s;for(let t=l.length-1,r=s;t>0;t--)r=r.add(l[t]),e=e.add(r);if(c=c.add(e),0!==t)for(let t=0;t<u;t++)c=c.double()}return c}(A,i,t,e)}static fromPrivateKey(t){return A.BASE.multiply(es(i,t))}}A.BASE=new A(o.Gx,o.Gy,n.ONE),A.ZERO=new A(n.ZERO,n.ONE,n.ZERO),A.Fp=n,A.Fn=i;let _=i.BITS,I=new t5(A,e.endo?Math.ceil(_/2):_);return A.BASE.precompute(8),A}(e,r),n,i),a=s.Point;return Object.assign({},s,{ProjectivePoint:a,CURVE:Object.assign({},t,tH(a.Fn.ORDER,a.Fn.BITS))})})({...t,hash:e});return{...r(e),create:r}}({...ef,Fp:ep,lowS:!0,endo:el},te),eg={};function em(t,...e){let r=eg[t];if(void 0===r){let e=te(E(t));r=x(e,e),eg[t]=r}return te(x(r,...e))}let eb=t=>t.toBytes(!0).slice(1),ew=ey.Point;function eE(t){let{Fn:e,BASE:r}=ew,n=es(e,t),i=r.multiply(n);return{scalar:i.y%ed===eh?n:e.neg(n),bytes:eb(i)}}function ev(t){if(!ep.isValidNot0(t))throw Error("invalid x: Fail if x â‰¥ p");let e=ep.create(t*t),r=ep.create(e*t+BigInt(7)),n=ep.sqrt(r);n%ed!==eh&&(n=ep.neg(n));let i=ew.fromAffine({x:t,y:n});return i.assertValidity(),i}function ex(...t){return ew.Fn.create(th(em("BIP0340/challenge",...t)))}function eB(t){return eE(t).bytes}function ek(t,e,r=A(32)){let{Fn:n}=ew,i=ty("message",t),{bytes:o,scalar:s}=eE(e),a=ty("auxRand",r,32),u=n.toBytes(s^th(em("BIP0340/aux",a))),{bytes:f,scalar:l}=eE(em("BIP0340/nonce",u,o,i)),h=ex(f,o,i),c=new Uint8Array(64);if(c.set(f,0),c.set(n.toBytes(n.create(l+h*s)),32),!eA(c,i,o))throw Error("sign: Invalid signature produced");return c}function eA(t,e,r){let{Fn:n,BASE:i}=ew,o=ty("signature",t,64),s=ty("message",e),a=ty("publicKey",r,32);try{let t=ev(th(a)),e=th(o.subarray(0,32));if(!tm(e,ec,ef.p))return!1;let r=th(o.subarray(32,64));if(!tm(r,ec,ef.n))return!1;let u=ex(n.toBytes(e),eb(t),s),f=i.multiplyUnsafe(r).add(t.multiplyUnsafe(n.neg(u))),{x:l,y:h}=f.toAffine();if(f.is0()||h%ed!==eh||l!==e)return!1;return!0}catch(t){return!1}}let e_=(()=>{let t=48,e=(e=A(t))=>tQ(e,ef.n);return ey.utils.randomSecretKey,{keygen:function(t){let r=e(t);return{secretKey:r,publicKey:eB(r)}},getPublicKey:eB,sign:ek,verify:eA,Point:ew,utils:{randomSecretKey:e,randomPrivateKey:e,taggedHash:em,lift_x:ev,pointToBytes:eb,numberToBytesBE:td,bytesToNumberBE:th,mod:tO},lengths:{secretKey:32,publicKey:32,publicKeyHasPrefix:!1,signature:64,seed:t}}})(),eI=function(t,e){let r=e.map(t=>Array.from(t).reverse());return(e,n)=>{let[i,o,s,a]=r.map(r=>r.reduce((r,n)=>t.add(t.mul(r,e),n))),[u,f]=tL(t,[o,a],!0);return e=t.mul(i,u),n=t.mul(n,t.mul(s,f)),{x:e,y:n}}}(ep,[["0x8e38e38e38e38e38e38e38e38e38e38e38e38e38e38e38e38e38e38daaaaa8c7","0x7d3d4c80bc321d5b9f315cea7fd44c5d595d2fc0bf63b92dfff1044f17c6581","0x534c328d23f234e6e2a413deca25caece4506144037c40314ecbd0b53d9dd262","0x8e38e38e38e38e38e38e38e38e38e38e38e38e38e38e38e38e38e38daaaaa88c"],["0xd35771193d94918a9ca34ccbb7b640dd86cd409542f8487d9fe6b745781eb49b","0xedadc6f64383dc1df7c4b2d51b54225406d36b641f5e41bbc52a56612a8c6d14","0x0000000000000000000000000000000000000000000000000000000000000001"],["0x4bda12f684bda12f684bda12f684bda12f684bda12f684bda12f684b8e38e23c","0xc75e0c32d5cb7c0fa9d0a54b12a0a6d5647ab046d686da6fdffc90fc201d71a3","0x29a6194691f91a73715209ef6512e576722830a201be2018a765e85a9ecee931","0x2f684bda12f684bda12f684bda12f684bda12f684bda12f684bda12f38e38d84"],["0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffff93b","0x7a06534bb8bdb49fd5e9e6632722c2989467c1bfc8e8d978dfb425d2685c2573","0x6484aa716545ca2cf3a70c3fa8fe337e0a3d21162f0d6299a7bf8192bfd2a76f","0x0000000000000000000000000000000000000000000000000000000000000001"]].map(t=>t.map(t=>BigInt(t)))),eS=function(t,e){tD(t);let{A:r,B:n,Z:i}=e;if(!t.isValid(r)||!t.isValid(n)||!t.isValid(i))throw Error("mapToCurveSimpleSWU: invalid opts");let o=function(t,e){let r=t.ORDER,n=ee;for(let t=r-er;t%en===ee;t/=en)n+=er;let i=n,o=en<<i-er-er,s=o*en,a=(r-er)/s,u=(a-er)/en,f=s-er,l=t.pow(e,a),h=t.pow(e,(a+er)/en),c=(e,r)=>{let n=l,s=t.pow(r,f),a=t.sqr(s);a=t.mul(a,r);let c=t.mul(e,a);c=t.pow(c,u),c=t.mul(c,s),s=t.mul(c,r),a=t.mul(c,e);let d=t.mul(a,s);c=t.pow(d,o);let p=t.eql(c,t.ONE);s=t.mul(a,h),c=t.mul(d,n),a=t.cmov(s,a,p),d=t.cmov(c,d,p);for(let e=i;e>er;e--){let r=e-en;r=en<<r-er;let i=t.pow(d,r),o=t.eql(i,t.ONE);s=t.mul(a,n),n=t.mul(n,n),i=t.mul(d,n),a=t.cmov(s,a,o),d=t.cmov(i,d,o)}return{isValid:p,value:a}};if(t.ORDER%eo===ei){let r=(t.ORDER-ei)/eo,n=t.sqrt(t.neg(e));c=(e,i)=>{let o=t.sqr(i),s=t.mul(e,i);o=t.mul(o,s);let a=t.pow(o,r);a=t.mul(a,s);let u=t.mul(a,n),f=t.mul(t.sqr(a),i),l=t.eql(f,e),h=t.cmov(u,a,l);return{isValid:l,value:h}}}return c}(t,i);if(!t.isOdd)throw Error("Field does not have .isOdd()");return e=>{let s,a,u,f,l,h,c,d;s=t.sqr(e),s=t.mul(s,i),a=t.sqr(s),a=t.add(a,s),u=t.add(a,t.ONE),u=t.mul(u,n),f=t.cmov(i,t.neg(a),!t.eql(a,t.ZERO)),f=t.mul(f,r),a=t.sqr(u),h=t.sqr(f),l=t.mul(h,r),a=t.add(a,l),a=t.mul(a,u),h=t.mul(h,f),l=t.mul(h,n),a=t.add(a,l),c=t.mul(s,u);let{isValid:p,value:y}=o(a,h);d=t.mul(s,e),d=t.mul(d,y),c=t.cmov(c,u,p),d=t.cmov(d,y,p);let g=t.isOdd(e)===t.isOdd(d);d=t.cmov(t.neg(d),d,g);let m=tL(t,[f],!0)[0];return{x:c=t.mul(c,m),y:d}}}(ep,{A:BigInt("0x3f8731abdd661adca08a5558f0f5d272e953d363cb6f0e5d405447c01a444533"),B:BigInt("1771"),Z:ep.create(BigInt("-11"))});!function(t,e,r){if("function"!=typeof e)throw Error("mapToCurve() must be defined")}(ey.Point,t=>{let{x:e,y:r}=eS(ep.create(t[0]));return eI(e,r)},ep.ORDER);var eU={},eR={};eR.byteLength=function(t){var e=eK(t),r=e[0],n=e[1];return(r+n)*3/4-n},eR.toByteArray=function(t){var e,r,n=eK(t),i=n[0],o=n[1],s=new eq((i+o)*3/4-o),a=0,u=o>0?i-4:i;for(r=0;r<u;r+=4)e=eO[t.charCodeAt(r)]<<18|eO[t.charCodeAt(r+1)]<<12|eO[t.charCodeAt(r+2)]<<6|eO[t.charCodeAt(r+3)],s[a++]=e>>16&255,s[a++]=e>>8&255,s[a++]=255&e;return 2===o&&(e=eO[t.charCodeAt(r)]<<2|eO[t.charCodeAt(r+1)]>>4,s[a++]=255&e),1===o&&(e=eO[t.charCodeAt(r)]<<10|eO[t.charCodeAt(r+1)]<<4|eO[t.charCodeAt(r+2)]>>2,s[a++]=e>>8&255,s[a++]=255&e),s},eR.fromByteArray=function(t){for(var e,r=t.length,n=r%3,i=[],o=0,s=r-n;o<s;o+=16383)i.push(function(t,e,r){for(var n,i=[],o=e;o<r;o+=3)i.push(eP[(n=(t[o]<<16&0xff0000)+(t[o+1]<<8&65280)+(255&t[o+2]))>>18&63]+eP[n>>12&63]+eP[n>>6&63]+eP[63&n]);return i.join("")}(t,o,o+16383>s?s:o+16383));return 1===n?i.push(eP[(e=t[r-1])>>2]+eP[e<<4&63]+"=="):2===n&&i.push(eP[(e=(t[r-2]<<8)+t[r-1])>>10]+eP[e>>4&63]+eP[e<<2&63]+"="),i.join("")};for(var eP=[],eO=[],eq="u">typeof Uint8Array?Uint8Array:Array,eM="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",eT=0,eN=eM.length;eT<eN;++eT)eP[eT]=eM[eT],eO[eM.charCodeAt(eT)]=eT;function eK(t){var e=t.length;if(e%4>0)throw Error("Invalid string. Length must be a multiple of 4");var r=t.indexOf("=");-1===r&&(r=e);var n=r===e?0:4-r%4;return[r,n]}eO[45]=62,eO[95]=63;var eC={};eC.read=function(t,e,r,n,i){var o,s,a=8*i-n-1,u=(1<<a)-1,f=u>>1,l=-7,h=r?i-1:0,c=r?-1:1,d=t[e+h];for(h+=c,o=d&(1<<-l)-1,d>>=-l,l+=a;l>0;o=256*o+t[e+h],h+=c,l-=8);for(s=o&(1<<-l)-1,o>>=-l,l+=n;l>0;s=256*s+t[e+h],h+=c,l-=8);if(0===o)o=1-f;else{if(o===u)return s?NaN:1/0*(d?-1:1);s+=Math.pow(2,n),o-=f}return(d?-1:1)*s*Math.pow(2,o-n)},eC.write=function(t,e,r,n,i,o){var s,a,u,f=8*o-i-1,l=(1<<f)-1,h=l>>1,c=5960464477539062e-23*(23===i),d=n?0:o-1,p=n?1:-1,y=+(e<0||0===e&&1/e<0);for(isNaN(e=Math.abs(e))||e===1/0?(a=+!!isNaN(e),s=l):(s=Math.floor(Math.log(e)/Math.LN2),e*(u=Math.pow(2,-s))<1&&(s--,u*=2),s+h>=1?e+=c/u:e+=c*Math.pow(2,1-h),e*u>=2&&(s++,u/=2),s+h>=l?(a=0,s=l):s+h>=1?(a=(e*u-1)*Math.pow(2,i),s+=h):(a=e*Math.pow(2,h-1)*Math.pow(2,i),s=0));i>=8;t[r+d]=255&a,d+=p,a/=256,i-=8);for(s=s<<i|a,f+=i;f>0;t[r+d]=255&s,d+=p,s/=256,f-=8);t[r+d-p]|=128*y},function(t){let e="function"==typeof Symbol&&"function"==typeof Symbol.for?Symbol.for("nodejs.util.inspect.custom"):null;t.Buffer=s,t.SlowBuffer=function(t){return+t!=t&&(t=0),s.alloc(+t)},t.INSPECT_MAX_BYTES=50,t.kMaxLength=0x7fffffff;let{Uint8Array:r,ArrayBuffer:n,SharedArrayBuffer:i}=globalThis;function o(t){if(t>0x7fffffff)throw RangeError('The value "'+t+'" is invalid for option "size"');let e=new r(t);return Object.setPrototypeOf(e,s.prototype),e}function s(t,e,r){if("number"==typeof t){if("string"==typeof e)throw TypeError('The "string" argument must be of type string. Received type number');return f(t)}return a(t,e,r)}function a(t,e,a){if("string"==typeof t){var u=t,f=e;if(("string"!=typeof f||""===f)&&(f="utf8"),!s.isEncoding(f))throw TypeError("Unknown encoding: "+f);let r=0|d(u,f),n=o(r),i=n.write(u,f);return i!==r&&(n=n.slice(0,i)),n}if(n.isView(t)){var p=t;if(N(p,r)){let t=new r(p);return h(t.buffer,t.byteOffset,t.byteLength)}return l(p)}if(null==t)throw TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof t);if(N(t,n)||t&&N(t.buffer,n)||"u">typeof i&&(N(t,i)||t&&N(t.buffer,i)))return h(t,e,a);if("number"==typeof t)throw TypeError('The "value" argument must not be of type number. Received type number');let y=t.valueOf&&t.valueOf();if(null!=y&&y!==t)return s.from(y,e,a);let g=function(t){if(s.isBuffer(t)){let e=0|c(t.length),r=o(e);return 0===r.length||t.copy(r,0,0,e),r}return void 0!==t.length?"number"!=typeof t.length||function(t){return t!=t}(t.length)?o(0):l(t):"Buffer"===t.type&&Array.isArray(t.data)?l(t.data):void 0}(t);if(g)return g;if("u">typeof Symbol&&null!=Symbol.toPrimitive&&"function"==typeof t[Symbol.toPrimitive])return s.from(t[Symbol.toPrimitive]("string"),e,a);throw TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof t)}function u(t){if("number"!=typeof t)throw TypeError('"size" argument must be of type number');if(t<0)throw RangeError('The value "'+t+'" is invalid for option "size"')}function f(t){return u(t),o(t<0?0:0|c(t))}function l(t){let e=t.length<0?0:0|c(t.length),r=o(e);for(let n=0;n<e;n+=1)r[n]=255&t[n];return r}function h(t,e,n){let i;if(e<0||t.byteLength<e)throw RangeError('"offset" is outside of buffer bounds');if(t.byteLength<e+(n||0))throw RangeError('"length" is outside of buffer bounds');return Object.setPrototypeOf(i=void 0===e&&void 0===n?new r(t):void 0===n?new r(t,e):new r(t,e,n),s.prototype),i}function c(t){if(t>=0x7fffffff)throw RangeError("Attempt to allocate Buffer larger than maximum size: 0x7fffffff bytes");return 0|t}function d(t,e){if(s.isBuffer(t))return t.length;if(n.isView(t)||N(t,n))return t.byteLength;if("string"!=typeof t)throw TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof t);let r=t.length,i=arguments.length>2&&!0===arguments[2];if(!i&&0===r)return 0;let o=!1;for(;;)switch(e){case"ascii":case"latin1":case"binary":return r;case"utf8":case"utf-8":return q(t).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*r;case"hex":return r>>>1;case"base64":return M(t).length;default:if(o)return i?-1:q(t).length;e=(""+e).toLowerCase(),o=!0}}function p(t,e,r){let n=!1;if((void 0===e||e<0)&&(e=0),e>this.length||((void 0===r||r>this.length)&&(r=this.length),r<=0)||(r>>>=0)<=(e>>>=0))return"";for(t||(t="utf8");;)switch(t){case"hex":return function(t,e,r){let n=t.length;(!e||e<0)&&(e=0),(!r||r<0||r>n)&&(r=n);let i="";for(let n=e;n<r;++n)i+=K[t[n]];return i}(this,e,r);case"utf8":case"utf-8":return b(this,e,r);case"ascii":return function(t,e,r){let n="";r=Math.min(t.length,r);for(let i=e;i<r;++i)n+=String.fromCharCode(127&t[i]);return n}(this,e,r);case"latin1":case"binary":return function(t,e,r){let n="";r=Math.min(t.length,r);for(let i=e;i<r;++i)n+=String.fromCharCode(t[i]);return n}(this,e,r);case"base64":var i,o,s;return i=this,o=e,s=r,0===o&&s===i.length?eR.fromByteArray(i):eR.fromByteArray(i.slice(o,s));case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return function(t,e,r){let n=t.slice(e,r),i="";for(let t=0;t<n.length-1;t+=2)i+=String.fromCharCode(n[t]+256*n[t+1]);return i}(this,e,r);default:if(n)throw TypeError("Unknown encoding: "+t);t=(t+"").toLowerCase(),n=!0}}function y(t,e,r){let n=t[e];t[e]=t[r],t[r]=n}function g(t,e,n,i,o){var a;if(0===t.length)return -1;if("string"==typeof n?(i=n,n=0):n>0x7fffffff?n=0x7fffffff:n<-0x80000000&&(n=-0x80000000),(a=n*=1)!=a&&(n=o?0:t.length-1),n<0&&(n=t.length+n),n>=t.length){if(o)return -1;n=t.length-1}else if(n<0)if(!o)return -1;else n=0;if("string"==typeof e&&(e=s.from(e,i)),s.isBuffer(e))return 0===e.length?-1:m(t,e,n,i,o);if("number"==typeof e)return e&=255,"function"==typeof r.prototype.indexOf?o?r.prototype.indexOf.call(t,e,n):r.prototype.lastIndexOf.call(t,e,n):m(t,[e],n,i,o);throw TypeError("val must be string, number or Buffer")}function m(t,e,r,n,i){let o,s=1,a=t.length,u=e.length;if(void 0!==n&&("ucs2"===(n=String(n).toLowerCase())||"ucs-2"===n||"utf16le"===n||"utf-16le"===n)){if(t.length<2||e.length<2)return -1;s=2,a/=2,u/=2,r/=2}function f(t,e){return 1===s?t[e]:t.readUInt16BE(e*s)}if(i){let n=-1;for(o=r;o<a;o++)if(f(t,o)===f(e,-1===n?0:o-n)){if(-1===n&&(n=o),o-n+1===u)return n*s}else -1!==n&&(o-=o-n),n=-1}else for(r+u>a&&(r=a-u),o=r;o>=0;o--){let r=!0;for(let n=0;n<u;n++)if(f(t,o+n)!==f(e,n)){r=!1;break}if(r)return o}return -1}function b(t,e,r){r=Math.min(t.length,r);let n=[],i=e;for(;i<r;){let e=t[i],o=null,s=e>239?4:e>223?3:e>191?2:1;if(i+s<=r){let r,n,a,u;switch(s){case 1:e<128&&(o=e);break;case 2:(192&(r=t[i+1]))==128&&(u=(31&e)<<6|63&r)>127&&(o=u);break;case 3:r=t[i+1],n=t[i+2],(192&r)==128&&(192&n)==128&&(u=(15&e)<<12|(63&r)<<6|63&n)>2047&&(u<55296||u>57343)&&(o=u);break;case 4:r=t[i+1],n=t[i+2],a=t[i+3],(192&r)==128&&(192&n)==128&&(192&a)==128&&(u=(15&e)<<18|(63&r)<<12|(63&n)<<6|63&a)>65535&&u<1114112&&(o=u)}}null===o?(o=65533,s=1):o>65535&&(o-=65536,n.push(o>>>10&1023|55296),o=56320|1023&o),n.push(o),i+=s}var o=n;let s=o.length;if(s<=4096)return String.fromCharCode.apply(String,o);let a="",u=0;for(;u<s;)a+=String.fromCharCode.apply(String,o.slice(u,u+=4096));return a}function w(t,e,r){if(t%1!=0||t<0)throw RangeError("offset is not uint");if(t+e>r)throw RangeError("Trying to access beyond buffer length")}function E(t,e,r,n,i,o){if(!s.isBuffer(t))throw TypeError('"buffer" argument must be a Buffer instance');if(e>i||e<o)throw RangeError('"value" argument is out of bounds');if(r+n>t.length)throw RangeError("Index out of range")}function v(t,e,r,n,i){U(e,n,i,t,r,7);let o=Number(e&BigInt(0xffffffff));t[r++]=o,o>>=8,t[r++]=o,o>>=8,t[r++]=o,o>>=8,t[r++]=o;let s=Number(e>>BigInt(32)&BigInt(0xffffffff));return t[r++]=s,s>>=8,t[r++]=s,s>>=8,t[r++]=s,s>>=8,t[r++]=s,r}function x(t,e,r,n,i){U(e,n,i,t,r,7);let o=Number(e&BigInt(0xffffffff));t[r+7]=o,o>>=8,t[r+6]=o,o>>=8,t[r+5]=o,o>>=8,t[r+4]=o;let s=Number(e>>BigInt(32)&BigInt(0xffffffff));return t[r+3]=s,s>>=8,t[r+2]=s,s>>=8,t[r+1]=s,s>>=8,t[r]=s,r+8}function B(t,e,r,n,i,o){if(r+n>t.length||r<0)throw RangeError("Index out of range")}function k(t,e,r,n,i){return e*=1,r>>>=0,i||B(t,e,r,4),eC.write(t,e,r,n,23,4),r+4}function A(t,e,r,n,i){return e*=1,r>>>=0,i||B(t,e,r,8),eC.write(t,e,r,n,52,8),r+8}s.TYPED_ARRAY_SUPPORT=function(){try{let t=new r(1),e={foo:function(){return 42}};return Object.setPrototypeOf(e,r.prototype),Object.setPrototypeOf(t,e),42===t.foo()}catch{return!1}}(),!s.TYPED_ARRAY_SUPPORT&&"u">typeof console&&"function"==typeof console.error&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support."),Object.defineProperty(s.prototype,"parent",{enumerable:!0,get:function(){if(s.isBuffer(this))return this.buffer}}),Object.defineProperty(s.prototype,"offset",{enumerable:!0,get:function(){if(s.isBuffer(this))return this.byteOffset}}),s.poolSize=8192,s.from=function(t,e,r){return a(t,e,r)},Object.setPrototypeOf(s.prototype,r.prototype),Object.setPrototypeOf(s,r),s.alloc=function(t,e,r){return u(t),t<=0?o(t):void 0!==e?"string"==typeof r?o(t).fill(e,r):o(t).fill(e):o(t)},s.allocUnsafe=function(t){return f(t)},s.allocUnsafeSlow=function(t){return f(t)},s.isBuffer=function(t){return null!=t&&!0===t._isBuffer&&t!==s.prototype},s.compare=function(t,e){if(N(t,r)&&(t=s.from(t,t.offset,t.byteLength)),N(e,r)&&(e=s.from(e,e.offset,e.byteLength)),!s.isBuffer(t)||!s.isBuffer(e))throw TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(t===e)return 0;let n=t.length,i=e.length;for(let r=0,o=Math.min(n,i);r<o;++r)if(t[r]!==e[r]){n=t[r],i=e[r];break}return n<i?-1:+(i<n)},s.isEncoding=function(t){switch(String(t).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},s.concat=function(t,e){let n;if(!Array.isArray(t))throw TypeError('"list" argument must be an Array of Buffers');if(0===t.length)return s.alloc(0);if(void 0===e)for(e=0,n=0;n<t.length;++n)e+=t[n].length;let i=s.allocUnsafe(e),o=0;for(n=0;n<t.length;++n){let e=t[n];if(N(e,r))o+e.length>i.length?(s.isBuffer(e)||(e=s.from(e)),e.copy(i,o)):r.prototype.set.call(i,e,o);else if(s.isBuffer(e))e.copy(i,o);else throw TypeError('"list" argument must be an Array of Buffers');o+=e.length}return i},s.byteLength=d,s.prototype._isBuffer=!0,s.prototype.swap16=function(){let t=this.length;if(t%2!=0)throw RangeError("Buffer size must be a multiple of 16-bits");for(let e=0;e<t;e+=2)y(this,e,e+1);return this},s.prototype.swap32=function(){let t=this.length;if(t%4!=0)throw RangeError("Buffer size must be a multiple of 32-bits");for(let e=0;e<t;e+=4)y(this,e,e+3),y(this,e+1,e+2);return this},s.prototype.swap64=function(){let t=this.length;if(t%8!=0)throw RangeError("Buffer size must be a multiple of 64-bits");for(let e=0;e<t;e+=8)y(this,e,e+7),y(this,e+1,e+6),y(this,e+2,e+5),y(this,e+3,e+4);return this},s.prototype.toString=function(){let t=this.length;return 0===t?"":0==arguments.length?b(this,0,t):p.apply(this,arguments)},s.prototype.toLocaleString=s.prototype.toString,s.prototype.equals=function(t){if(!s.isBuffer(t))throw TypeError("Argument must be a Buffer");return this===t||0===s.compare(this,t)},s.prototype.inspect=function(){let e="",r=t.INSPECT_MAX_BYTES;return e=this.toString("hex",0,r).replace(/(.{2})/g,"$1 ").trim(),this.length>r&&(e+=" ... "),"<Buffer "+e+">"},e&&(s.prototype[e]=s.prototype.inspect),s.prototype.compare=function(t,e,n,i,o){if(N(t,r)&&(t=s.from(t,t.offset,t.byteLength)),!s.isBuffer(t))throw TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof t);if(void 0===e&&(e=0),void 0===n&&(n=t?t.length:0),void 0===i&&(i=0),void 0===o&&(o=this.length),e<0||n>t.length||i<0||o>this.length)throw RangeError("out of range index");if(i>=o&&e>=n)return 0;if(i>=o)return -1;if(e>=n)return 1;if(e>>>=0,n>>>=0,i>>>=0,o>>>=0,this===t)return 0;let a=o-i,u=n-e,f=Math.min(a,u),l=this.slice(i,o),h=t.slice(e,n);for(let t=0;t<f;++t)if(l[t]!==h[t]){a=l[t],u=h[t];break}return a<u?-1:+(u<a)},s.prototype.includes=function(t,e,r){return -1!==this.indexOf(t,e,r)},s.prototype.indexOf=function(t,e,r){return g(this,t,e,r,!0)},s.prototype.lastIndexOf=function(t,e,r){return g(this,t,e,r,!1)},s.prototype.write=function(t,e,r,n){var i,o,s,a,u,f,l,h;if(void 0===e)n="utf8",r=this.length,e=0;else if(void 0===r&&"string"==typeof e)n=e,r=this.length,e=0;else if(isFinite(e))e>>>=0,isFinite(r)?(r>>>=0,void 0===n&&(n="utf8")):(n=r,r=void 0);else throw Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");let c=this.length-e;if((void 0===r||r>c)&&(r=c),t.length>0&&(r<0||e<0)||e>this.length)throw RangeError("Attempt to write outside buffer bounds");n||(n="utf8");let d=!1;for(;;)switch(n){case"hex":return function(t,e,r,n){let i;r=Number(r)||0;let o=t.length-r;n?(n=Number(n))>o&&(n=o):n=o;let s=e.length;for(n>s/2&&(n=s/2),i=0;i<n;++i){var a;let n=parseInt(e.substr(2*i,2),16);if((a=n)!=a)break;t[r+i]=n}return i}(this,t,e,r);case"utf8":case"utf-8":return i=e,o=r,T(q(t,this.length-i),this,i,o);case"ascii":case"latin1":case"binary":return s=e,a=r,T(function(t){let e=[];for(let r=0;r<t.length;++r)e.push(255&t.charCodeAt(r));return e}(t),this,s,a);case"base64":return u=e,f=r,T(M(t),this,u,f);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return l=e,h=r,T(function(t,e){let r,n,i=[];for(let o=0;o<t.length&&!((e-=2)<0);++o)n=(r=t.charCodeAt(o))>>8,i.push(r%256),i.push(n);return i}(t,this.length-l),this,l,h);default:if(d)throw TypeError("Unknown encoding: "+n);n=(""+n).toLowerCase(),d=!0}},s.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}},s.prototype.slice=function(t,e){let r=this.length;t=~~t,e=void 0===e?r:~~e,t<0?(t+=r)<0&&(t=0):t>r&&(t=r),e<0?(e+=r)<0&&(e=0):e>r&&(e=r),e<t&&(e=t);let n=this.subarray(t,e);return Object.setPrototypeOf(n,s.prototype),n},s.prototype.readUintLE=s.prototype.readUIntLE=function(t,e,r){t>>>=0,e>>>=0,r||w(t,e,this.length);let n=this[t],i=1,o=0;for(;++o<e&&(i*=256);)n+=this[t+o]*i;return n},s.prototype.readUintBE=s.prototype.readUIntBE=function(t,e,r){t>>>=0,e>>>=0,r||w(t,e,this.length);let n=this[t+--e],i=1;for(;e>0&&(i*=256);)n+=this[t+--e]*i;return n},s.prototype.readUint8=s.prototype.readUInt8=function(t,e){return t>>>=0,e||w(t,1,this.length),this[t]},s.prototype.readUint16LE=s.prototype.readUInt16LE=function(t,e){return t>>>=0,e||w(t,2,this.length),this[t]|this[t+1]<<8},s.prototype.readUint16BE=s.prototype.readUInt16BE=function(t,e){return t>>>=0,e||w(t,2,this.length),this[t]<<8|this[t+1]},s.prototype.readUint32LE=s.prototype.readUInt32LE=function(t,e){return t>>>=0,e||w(t,4,this.length),(this[t]|this[t+1]<<8|this[t+2]<<16)+0x1000000*this[t+3]},s.prototype.readUint32BE=s.prototype.readUInt32BE=function(t,e){return t>>>=0,e||w(t,4,this.length),0x1000000*this[t]+(this[t+1]<<16|this[t+2]<<8|this[t+3])},s.prototype.readBigUInt64LE=C(function(t){R(t>>>=0,"offset");let e=this[t],r=this[t+7];(void 0===e||void 0===r)&&P(t,this.length-8);let n=e+256*this[++t]+65536*this[++t]+0x1000000*this[++t],i=this[++t]+256*this[++t]+65536*this[++t]+0x1000000*r;return BigInt(n)+(BigInt(i)<<BigInt(32))}),s.prototype.readBigUInt64BE=C(function(t){R(t>>>=0,"offset");let e=this[t],r=this[t+7];(void 0===e||void 0===r)&&P(t,this.length-8);let n=0x1000000*e+65536*this[++t]+256*this[++t]+this[++t],i=0x1000000*this[++t]+65536*this[++t]+256*this[++t]+r;return(BigInt(n)<<BigInt(32))+BigInt(i)}),s.prototype.readIntLE=function(t,e,r){t>>>=0,e>>>=0,r||w(t,e,this.length);let n=this[t],i=1,o=0;for(;++o<e&&(i*=256);)n+=this[t+o]*i;return n>=(i*=128)&&(n-=Math.pow(2,8*e)),n},s.prototype.readIntBE=function(t,e,r){t>>>=0,e>>>=0,r||w(t,e,this.length);let n=e,i=1,o=this[t+--n];for(;n>0&&(i*=256);)o+=this[t+--n]*i;return o>=(i*=128)&&(o-=Math.pow(2,8*e)),o},s.prototype.readInt8=function(t,e){return t>>>=0,e||w(t,1,this.length),128&this[t]?-((255-this[t]+1)*1):this[t]},s.prototype.readInt16LE=function(t,e){t>>>=0,e||w(t,2,this.length);let r=this[t]|this[t+1]<<8;return 32768&r?0xffff0000|r:r},s.prototype.readInt16BE=function(t,e){t>>>=0,e||w(t,2,this.length);let r=this[t+1]|this[t]<<8;return 32768&r?0xffff0000|r:r},s.prototype.readInt32LE=function(t,e){return t>>>=0,e||w(t,4,this.length),this[t]|this[t+1]<<8|this[t+2]<<16|this[t+3]<<24},s.prototype.readInt32BE=function(t,e){return t>>>=0,e||w(t,4,this.length),this[t]<<24|this[t+1]<<16|this[t+2]<<8|this[t+3]},s.prototype.readBigInt64LE=C(function(t){R(t>>>=0,"offset");let e=this[t],r=this[t+7];return(void 0===e||void 0===r)&&P(t,this.length-8),(BigInt(this[t+4]+256*this[t+5]+65536*this[t+6]+(r<<24))<<BigInt(32))+BigInt(e+256*this[++t]+65536*this[++t]+0x1000000*this[++t])}),s.prototype.readBigInt64BE=C(function(t){R(t>>>=0,"offset");let e=this[t],r=this[t+7];return(void 0===e||void 0===r)&&P(t,this.length-8),(BigInt((e<<24)+65536*this[++t]+256*this[++t]+this[++t])<<BigInt(32))+BigInt(0x1000000*this[++t]+65536*this[++t]+256*this[++t]+r)}),s.prototype.readFloatLE=function(t,e){return t>>>=0,e||w(t,4,this.length),eC.read(this,t,!0,23,4)},s.prototype.readFloatBE=function(t,e){return t>>>=0,e||w(t,4,this.length),eC.read(this,t,!1,23,4)},s.prototype.readDoubleLE=function(t,e){return t>>>=0,e||w(t,8,this.length),eC.read(this,t,!0,52,8)},s.prototype.readDoubleBE=function(t,e){return t>>>=0,e||w(t,8,this.length),eC.read(this,t,!1,52,8)},s.prototype.writeUintLE=s.prototype.writeUIntLE=function(t,e,r,n){if(t*=1,e>>>=0,r>>>=0,!n){let n=Math.pow(2,8*r)-1;E(this,t,e,r,n,0)}let i=1,o=0;for(this[e]=255&t;++o<r&&(i*=256);)this[e+o]=t/i&255;return e+r},s.prototype.writeUintBE=s.prototype.writeUIntBE=function(t,e,r,n){if(t*=1,e>>>=0,r>>>=0,!n){let n=Math.pow(2,8*r)-1;E(this,t,e,r,n,0)}let i=r-1,o=1;for(this[e+i]=255&t;--i>=0&&(o*=256);)this[e+i]=t/o&255;return e+r},s.prototype.writeUint8=s.prototype.writeUInt8=function(t,e,r){return t*=1,e>>>=0,r||E(this,t,e,1,255,0),this[e]=255&t,e+1},s.prototype.writeUint16LE=s.prototype.writeUInt16LE=function(t,e,r){return t*=1,e>>>=0,r||E(this,t,e,2,65535,0),this[e]=255&t,this[e+1]=t>>>8,e+2},s.prototype.writeUint16BE=s.prototype.writeUInt16BE=function(t,e,r){return t*=1,e>>>=0,r||E(this,t,e,2,65535,0),this[e]=t>>>8,this[e+1]=255&t,e+2},s.prototype.writeUint32LE=s.prototype.writeUInt32LE=function(t,e,r){return t*=1,e>>>=0,r||E(this,t,e,4,0xffffffff,0),this[e+3]=t>>>24,this[e+2]=t>>>16,this[e+1]=t>>>8,this[e]=255&t,e+4},s.prototype.writeUint32BE=s.prototype.writeUInt32BE=function(t,e,r){return t*=1,e>>>=0,r||E(this,t,e,4,0xffffffff,0),this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=255&t,e+4},s.prototype.writeBigUInt64LE=C(function(t,e=0){return v(this,t,e,BigInt(0),BigInt("0xffffffffffffffff"))}),s.prototype.writeBigUInt64BE=C(function(t,e=0){return x(this,t,e,BigInt(0),BigInt("0xffffffffffffffff"))}),s.prototype.writeIntLE=function(t,e,r,n){if(t*=1,e>>>=0,!n){let n=Math.pow(2,8*r-1);E(this,t,e,r,n-1,-n)}let i=0,o=1,s=0;for(this[e]=255&t;++i<r&&(o*=256);)t<0&&0===s&&0!==this[e+i-1]&&(s=1),this[e+i]=(t/o|0)-s&255;return e+r},s.prototype.writeIntBE=function(t,e,r,n){if(t*=1,e>>>=0,!n){let n=Math.pow(2,8*r-1);E(this,t,e,r,n-1,-n)}let i=r-1,o=1,s=0;for(this[e+i]=255&t;--i>=0&&(o*=256);)t<0&&0===s&&0!==this[e+i+1]&&(s=1),this[e+i]=(t/o|0)-s&255;return e+r},s.prototype.writeInt8=function(t,e,r){return t*=1,e>>>=0,r||E(this,t,e,1,127,-128),t<0&&(t=255+t+1),this[e]=255&t,e+1},s.prototype.writeInt16LE=function(t,e,r){return t*=1,e>>>=0,r||E(this,t,e,2,32767,-32768),this[e]=255&t,this[e+1]=t>>>8,e+2},s.prototype.writeInt16BE=function(t,e,r){return t*=1,e>>>=0,r||E(this,t,e,2,32767,-32768),this[e]=t>>>8,this[e+1]=255&t,e+2},s.prototype.writeInt32LE=function(t,e,r){return t*=1,e>>>=0,r||E(this,t,e,4,0x7fffffff,-0x80000000),this[e]=255&t,this[e+1]=t>>>8,this[e+2]=t>>>16,this[e+3]=t>>>24,e+4},s.prototype.writeInt32BE=function(t,e,r){return t*=1,e>>>=0,r||E(this,t,e,4,0x7fffffff,-0x80000000),t<0&&(t=0xffffffff+t+1),this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=255&t,e+4},s.prototype.writeBigInt64LE=C(function(t,e=0){return v(this,t,e,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),s.prototype.writeBigInt64BE=C(function(t,e=0){return x(this,t,e,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),s.prototype.writeFloatLE=function(t,e,r){return k(this,t,e,!0,r)},s.prototype.writeFloatBE=function(t,e,r){return k(this,t,e,!1,r)},s.prototype.writeDoubleLE=function(t,e,r){return A(this,t,e,!0,r)},s.prototype.writeDoubleBE=function(t,e,r){return A(this,t,e,!1,r)},s.prototype.copy=function(t,e,n,i){if(!s.isBuffer(t))throw TypeError("argument should be a Buffer");if(n||(n=0),i||0===i||(i=this.length),e>=t.length&&(e=t.length),e||(e=0),i>0&&i<n&&(i=n),i===n||0===t.length||0===this.length)return 0;if(e<0)throw RangeError("targetStart out of bounds");if(n<0||n>=this.length)throw RangeError("Index out of range");if(i<0)throw RangeError("sourceEnd out of bounds");i>this.length&&(i=this.length),t.length-e<i-n&&(i=t.length-e+n);let o=i-n;return this===t&&"function"==typeof r.prototype.copyWithin?this.copyWithin(e,n,i):r.prototype.set.call(t,this.subarray(n,i),e),o},s.prototype.fill=function(t,e,r,n){let i;if("string"==typeof t){if("string"==typeof e?(n=e,e=0,r=this.length):"string"==typeof r&&(n=r,r=this.length),void 0!==n&&"string"!=typeof n)throw TypeError("encoding must be a string");if("string"==typeof n&&!s.isEncoding(n))throw TypeError("Unknown encoding: "+n);if(1===t.length){let e=t.charCodeAt(0);("utf8"===n&&e<128||"latin1"===n)&&(t=e)}}else"number"==typeof t?t&=255:"boolean"==typeof t&&(t=Number(t));if(e<0||this.length<e||this.length<r)throw RangeError("Out of range index");if(r<=e)return this;if(e>>>=0,r=void 0===r?this.length:r>>>0,t||(t=0),"number"==typeof t)for(i=e;i<r;++i)this[i]=t;else{let o=s.isBuffer(t)?t:s.from(t,n),a=o.length;if(0===a)throw TypeError('The value "'+t+'" is invalid for argument "value"');for(i=0;i<r-e;++i)this[i+e]=o[i%a]}return this};let _={};function I(t,e,r){_[t]=class extends r{constructor(){super(),Object.defineProperty(this,"message",{value:e.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${t}]`,this.stack,delete this.name}get code(){return t}set code(t){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:t,writable:!0})}toString(){return`${this.name} [${t}]: ${this.message}`}}}function S(t){let e="",r=t.length,n=+("-"===t[0]);for(;r>=n+4;r-=3)e=`_${t.slice(r-3,r)}${e}`;return`${t.slice(0,r)}${e}`}function U(t,e,r,n,i,o){if(t>r||t<e){let r,n="bigint"==typeof e?"n":"";throw r=0===e||e===BigInt(0)?`>= 0${n} and < 2${n} ** ${(o+1)*8}${n}`:`>= -(2${n} ** ${(o+1)*8-1}${n}) and < 2 ** ${(o+1)*8-1}${n}`,new _.ERR_OUT_OF_RANGE("value",r,t)}R(i,"offset"),(void 0===n[i]||void 0===n[i+o])&&P(i,n.length-(o+1))}function R(t,e){if("number"!=typeof t)throw new _.ERR_INVALID_ARG_TYPE(e,"number",t)}function P(t,e,r){throw Math.floor(t)!==t?(R(t,r),new _.ERR_OUT_OF_RANGE("offset","an integer",t)):e<0?new _.ERR_BUFFER_OUT_OF_BOUNDS:new _.ERR_OUT_OF_RANGE("offset",`>= 0 and <= ${e}`,t)}I("ERR_BUFFER_OUT_OF_BOUNDS",function(t){return t?`${t} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),I("ERR_INVALID_ARG_TYPE",function(t,e){return`The "${t}" argument must be of type number. Received type ${typeof e}`},TypeError),I("ERR_OUT_OF_RANGE",function(t,e,r){let n=`The value of "${t}" is out of range.`,i=r;return Number.isInteger(r)&&Math.abs(r)>0x100000000?i=S(String(r)):"bigint"==typeof r&&(i=String(r),(r>BigInt(2)**BigInt(32)||r<-(BigInt(2)**BigInt(32)))&&(i=S(i)),i+="n"),n+=` It must be ${e}. Received ${i}`},RangeError);let O=/[^+/0-9A-Za-z-_]/g;function q(t,e){let r;e=e||1/0;let n=t.length,i=null,o=[];for(let s=0;s<n;++s){if((r=t.charCodeAt(s))>55295&&r<57344){if(!i){if(r>56319||s+1===n){(e-=3)>-1&&o.push(239,191,189);continue}i=r;continue}if(r<56320){(e-=3)>-1&&o.push(239,191,189),i=r;continue}r=(i-55296<<10|r-56320)+65536}else i&&(e-=3)>-1&&o.push(239,191,189);if(i=null,r<128){if((e-=1)<0)break;o.push(r)}else if(r<2048){if((e-=2)<0)break;o.push(r>>6|192,63&r|128)}else if(r<65536){if((e-=3)<0)break;o.push(r>>12|224,r>>6&63|128,63&r|128)}else if(r<1114112){if((e-=4)<0)break;o.push(r>>18|240,r>>12&63|128,r>>6&63|128,63&r|128)}else throw Error("Invalid code point")}return o}function M(t){return eR.toByteArray(function(t){if((t=(t=t.split("=")[0]).trim().replace(O,"")).length<2)return"";for(;t.length%4!=0;)t+="=";return t}(t))}function T(t,e,r,n){let i;for(i=0;i<n&&!(i+r>=e.length||i>=t.length);++i)e[i+r]=t[i];return i}function N(t,e){return t instanceof e||null!=t&&null!=t.constructor&&null!=t.constructor.name&&t.constructor.name===e.name}let K=function(){let t="0123456789abcdef",e=Array(256);for(let r=0;r<16;++r){let n=16*r;for(let i=0;i<16;++i)e[n+i]=t[r]+t[i]}return e}();function C(t){return typeof BigInt>"u"?F:t}function F(){throw Error("BigInt not supported")}}(eU);let eF=eU.Buffer;class eD{static fromHex(t){if(0===(t=t.trim()).length)return new Uint8Array(0);if(t.length<2||1&t.length)throw Error("Invalid hex string: odd length.");if((t.startsWith("0x")||t.startsWith("0X"))&&(t=t.slice(2)),!t.match(/^[0-9a-fA-F]*$/))throw Error("Invalid hex string: contains non-hex characters");let e=t.match(/.{1,2}/g);if(!e)throw Error("Invalid hex string");return new Uint8Array(e.map(t=>parseInt(t,16)))}static toHex(t){return Array.from(t,t=>t.toString(16).padStart(2,"0")).join("")}static fromString(t){return t=t.trim(),new TextEncoder().encode(t)}static toString(t){return new TextDecoder("utf-8").decode(t)}static concat(...t){let e=new Uint8Array(t.reduce((t,e)=>t+e.length,0)),r=0;for(let n of t)e.set(n,r),r+=n.length;return e}static alloc(t){return new Uint8Array(t)}static writeBigUint64BE(t){let e=new ArrayBuffer(8);return new DataView(e).setBigUint64(0,t,!1),new Uint8Array(e)}static toBase64(t){if("u">typeof eF)return eF.from(t).toString("base64");if(t.length>32768){let e="";for(let r=0;r<t.length;r+=32768)e+=btoa(String.fromCharCode(...t.slice(r,r+32768)));return e}return btoa(String.fromCharCode(...t))}static fromBase64(t){if(t=t.trim(),"u">typeof eF)return new Uint8Array(eF.from(t,"base64"));let e=t.replace(/-/g,"+").replace(/_/g,"/");for(;e.length%4;)e+="=";return new Uint8Array([...atob(e)].map(t=>t.charCodeAt(0)))}static equals(t,e){if(t.length!==e.length)return!1;let r=0;for(let n=0;n<t.length;n++)r|=t[n]^e[n];return 0===r}static compare(t,e){let r=Math.min(t.length,e.length);for(let n=0;n<r;n++){if(t[n]<e[n])return -1;if(t[n]>e[n])return 1}return t.length-e.length}}function eL(t){return e$(g(t))}function e$(t){return BigInt(`0x${t}`)}let eH=w("536563703235366b315f48617368546f43757276655f43617368755f");function ej(t){let e=te(eD.concat(eH,t)),r=new Uint32Array(1);for(let t=0;t<65536;t++){let t=new Uint8Array(r.buffer),n=te(eD.concat(e,t));try{return eV(g(eD.concat(new Uint8Array([2]),n)))}catch{r[0]++}}throw Error("No valid point found")}function eV(t){return ey.ProjectivePoint.fromHex(t)}let ez=Uint32Array.from([0x67452301,0xefcdab89,0x98badcfe,0x10325476,0xc3d2e1f0]),eQ=new Uint32Array(80);(t,e)=>Math.floor(0x100000000*Math.abs(Math.sin(e+1)));let eG=Uint8Array.from([7,4,13,1,10,6,15,3,12,0,9,5,2,14,11,8]),eW=Uint8Array.from(Array(16).fill(0).map((t,e)=>e)),eZ=eW.map(t=>(9*t+5)%16),eY=(()=>{let t=[[eW],[eZ]];for(let e=0;e<4;e++)for(let r of t)r.push(r[e].map(t=>eG[t]));return t})(),eJ=eY[0],eX=eY[1],e0=[[11,14,15,12,5,8,7,9,11,13,14,15,6,7,9,8],[12,13,11,15,6,9,9,7,12,15,11,13,7,8,7,7],[13,15,14,11,7,7,6,8,13,14,13,12,5,5,6,9],[14,11,12,14,8,6,5,5,15,12,15,14,9,9,8,6],[15,12,13,13,9,5,8,6,14,11,12,11,8,6,5,5]].map(t=>Uint8Array.from(t)),e1=eJ.map((t,e)=>t.map(t=>e0[e][t])),e2=eX.map((t,e)=>t.map(t=>e0[e][t])),e8=Uint32Array.from([0,0x5a827999,0x6ed9eba1,0x8f1bbcdc,0xa953fd4e]),e6=Uint32Array.from([0x50a28be6,0x5c4dd124,0x6d703ef3,0x7a6d76e9,0]);function e5(t,e,r,n){return 0===t?e^r^n:1===t?e&r|~e&n:2===t?(e|~r)^n:3===t?e&n|r&~n:e^(r|~n)}let e3=new Uint32Array(16);class e4 extends _{constructor(){super(64,20,8,!0),this.h0=0x67452301,this.h1=-0x10325477,this.h2=-0x67452302,this.h3=0x10325476,this.h4=-0x3c2d1e10}get(){let{h0:t,h1:e,h2:r,h3:n,h4:i}=this;return[t,e,r,n,i]}set(t,e,r,n,i){this.h0=0|t,this.h1=0|e,this.h2=0|r,this.h3=0|n,this.h4=0|i}process(t,e){for(let r=0;r<16;r++,e+=4)e3[r]=t.getUint32(e,!0);let r=0|this.h0,n=r,i=0|this.h1,o=i,s=0|this.h2,a=s,u=0|this.h3,f=u,l=0|this.h4,h=l;for(let t=0;t<5;t++){let e=4-t,c=e8[t],p=e6[t],y=eJ[t],g=eX[t],m=e1[t],b=e2[t];for(let e=0;e<16;e++){let n=d(r+e5(t,i,s,u)+e3[y[e]]+c,m[e])+l|0;r=l,l=u,u=0|d(s,10),s=i,i=n}for(let t=0;t<16;t++){let r=d(n+e5(e,o,a,f)+e3[g[t]]+p,b[t])+h|0;n=h,h=f,f=0|d(a,10),a=o,o=r}}this.set(this.h1+s+f|0,this.h2+u+h|0,this.h3+l+n|0,this.h4+r+o|0,this.h0+i+a|0)}roundClean(){l(e3)}destroy(){this.destroyed=!0,l(this.buffer),this.set(0,0,0,0,0)}}let e7=k(()=>new e4);function e9(t){return t instanceof Uint8Array||ArrayBuffer.isView(t)&&"Uint8Array"===t.constructor.name}function rt(t,e){return!!Array.isArray(e)&&(0===e.length||(t?e.every(t=>"string"==typeof t):e.every(t=>Number.isSafeInteger(t))))}function re(t){if("function"!=typeof t)throw Error("function expected");return!0}function rr(t,e){if("string"!=typeof e)throw Error(`${t}: string expected`);return!0}function rn(t){if(!Number.isSafeInteger(t))throw Error(`invalid integer: ${t}`)}function ri(t){if(!Array.isArray(t))throw Error("array expected")}function ro(t,e){if(!rt(!0,e))throw Error(`${t}: array of strings expected`)}function rs(t,e){if(!rt(!1,e))throw Error(`${t}: array of numbers expected`)}function ra(...t){let e=t=>t,r=(t,e)=>r=>t(e(r));return{encode:t.map(t=>t.encode).reduceRight(r,e),decode:t.map(t=>t.decode).reduce(r,e)}}function ru(t){let e="string"==typeof t?t.split(""):t,r=e.length;ro("alphabet",e);let n=new Map(e.map((t,e)=>[t,e]));return{encode:n=>(ri(n),n.map(n=>{if(!Number.isSafeInteger(n)||n<0||n>=r)throw Error(`alphabet.encode: digit index outside alphabet "${n}". Allowed: ${t}`);return e[n]})),decode:e=>(ri(e),e.map(e=>{rr("alphabet.decode",e);let r=n.get(e);if(void 0===r)throw Error(`Unknown letter: "${e}". Allowed: ${t}`);return r}))}}function rf(t=""){return rr("join",t),{encode:e=>(ro("join.decode",e),e.join(t)),decode:e=>(rr("join.decode",e),e.split(t))}}function rl(t,e,r){if(e<2)throw Error(`convertRadix: invalid from=${e}, base cannot be less than 2`);if(r<2)throw Error(`convertRadix: invalid to=${r}, base cannot be less than 2`);if(ri(t),!t.length)return[];let n=0,i=[],o=Array.from(t,t=>{if(rn(t),t<0||t>=e)throw Error(`invalid integer: ${t}`);return t}),s=o.length;for(;;){let t=0,a=!0;for(let i=n;i<s;i++){let s=o[i],u=e*t,f=u+s;if(!Number.isSafeInteger(f)||u/e!==t||f-s!==u)throw Error("convertRadix: carry overflow");let l=f/r;t=f%r;let h=Math.floor(l);if(o[i]=h,!Number.isSafeInteger(h)||h*r+t!==f)throw Error("convertRadix: carry overflow");a&&(h?a=!1:n=i)}if(i.push(t),a)break}for(let e=0;e<t.length-1&&0===t[e];e++)i.push(0);return i.reverse()}let rh=(t,e)=>0===e?t:rh(e,t%e),rc=(()=>{let t=[];for(let e=0;e<40;e++)t.push(2**e);return t})();"function"==typeof Uint8Array.from([]).toBase64&&Uint8Array.fromBase64;let rd=ra((r=58,rn(58),{encode:t=>{if(!e9(t))throw Error("radix.encode input should be Uint8Array");return rl(Array.from(t),256,58)},decode:t=>(rs("radix.decode",t),Uint8Array.from(rl(t,58,256)))}),ru("123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"),rf("")),rp=ra(ru("qpzry9x8gf2tvdw0s3jn54khce6mua7l"),rf(""));"function"==typeof Uint8Array.from([]).toHex&&Uint8Array.fromHex;let ry=ey.ProjectivePoint,rg=(t=>ra(function(t,e){return rn(4),re(e),{encode(r){if(!e9(r))throw Error("checksum.encode: input should be Uint8Array");let n=e(r).slice(0,4),i=new Uint8Array(r.length+t);return i.set(r),i.set(n,r.length),i},decode(r){if(!e9(r))throw Error("checksum.decode: input should be Uint8Array");let n=r.slice(0,-t),i=r.slice(-t),o=e(n).slice(0,t);for(let e=0;e<t;e++)if(o[e]!==i[e])throw Error("Invalid checksum");return n}}}(4,e=>t(t(e))),rd))(te);function rm(t){return a(t),BigInt("0x"+(0===t.length?"0":g(t)))}let rb=E("Bitcoin seed"),rw={private:0x488ade4,public:0x488b21e},rE=t=>{if(!Number.isSafeInteger(t)||t<0||t>0x100000000-1)throw Error("invalid number, should be from 0 to 2**32-1, got "+t);let e=new Uint8Array(4);return h(e).setUint32(0,t,!1),e};class rv{get fingerprint(){if(!this.pubHash)throw Error("No publicKey set!");return h(this.pubHash).getUint32(0,!1)}get identifier(){return this.pubHash}get pubKeyHash(){return this.pubHash}get privateKey(){return this.privKeyBytes||null}get publicKey(){return this.pubKey||null}get privateExtendedKey(){let t=this.privateKey;if(!t)throw Error("No private key");return rg.encode(this.serialize(this.versions.private,x(new Uint8Array([0]),t)))}get publicExtendedKey(){if(!this.pubKey)throw Error("No public key");return rg.encode(this.serialize(this.versions.public,this.pubKey))}static fromMasterSeed(t,e=rw){if(a(t),8*t.length<128||8*t.length>512)throw Error("HDKey: seed length must be between 128 and 512 bits; 256 bits is advised, got "+t.length);let r=ti(tr,rb,t);return new rv({versions:e,chainCode:r.slice(32),privateKey:r.slice(0,32)})}static fromExtendedKey(t,e=rw){let r=rg.decode(t),n=h(r),i=n.getUint32(0,!1),o={versions:e,depth:r[4],parentFingerprint:n.getUint32(5,!1),index:n.getUint32(9,!1),chainCode:r.slice(13,45)},s=r.slice(45),a=0===s[0];if(i!==e[a?"private":"public"])throw Error("Version mismatch");return new rv(a?{...o,privateKey:s.slice(1)}:{...o,publicKey:s})}static fromJSON(t){return rv.fromExtendedKey(t.xpriv)}constructor(t){if(this.depth=0,this.index=0,this.chainCode=null,this.parentFingerprint=0,!t||"object"!=typeof t)throw Error("HDKey.constructor must not be called directly");if(this.versions=t.versions||rw,this.depth=t.depth||0,this.chainCode=t.chainCode||null,this.index=t.index||0,this.parentFingerprint=t.parentFingerprint||0,!this.depth&&(this.parentFingerprint||this.index))throw Error("HDKey: zero depth with non-zero index/parent fingerprint");if(t.publicKey&&t.privateKey)throw Error("HDKey: publicKey and privateKey at same time.");if(t.privateKey){if(!ey.utils.isValidPrivateKey(t.privateKey))throw Error("Invalid private key");this.privKey="bigint"==typeof t.privateKey?t.privateKey:rm(t.privateKey),this.privKeyBytes=function(t){if("bigint"!=typeof t)throw Error("bigint expected");return w(t.toString(16).padStart(64,"0"))}(this.privKey),this.pubKey=ey.getPublicKey(t.privateKey,!0)}else if(t.publicKey)this.pubKey=ry.fromHex(t.publicKey).toRawBytes(!0);else throw Error("HDKey: no public or private key provided");this.pubHash=e7(te(this.pubKey))}derive(t){if(!/^[mM]'?/.test(t))throw Error('Path must start with "m" or "M"');if(/^[mM]'?$/.test(t))return this;let e=t.replace(/^[mM]'?\//,"").split("/"),r=this;for(let t of e){let e=/^(\d+)('?)$/.exec(t),n=e&&e[1];if(!e||3!==e.length||"string"!=typeof n)throw Error("invalid child index: "+t);let i=+n;if(!Number.isSafeInteger(i)||i>=0x80000000)throw Error("Invalid index");"'"===e[2]&&(i+=0x80000000),r=r.deriveChild(i)}return r}deriveChild(t){if(!this.pubKey||!this.chainCode)throw Error("No publicKey or chainCode set");let e=rE(t);if(t>=0x80000000){let t=this.privateKey;if(!t)throw Error("Could not derive hardened child key");e=x(new Uint8Array([0]),t,e)}else e=x(this.pubKey,e);let r=ti(tr,this.chainCode,e),n=rm(r.slice(0,32)),i=r.slice(32);if(!ey.utils.isValidPrivateKey(n))throw Error("Tweak bigger than curve order");let o={versions:this.versions,chainCode:i,depth:this.depth+1,parentFingerprint:this.fingerprint,index:t};try{if(this.privateKey){let t=tO(this.privKey+n,ey.CURVE.n);if(!ey.utils.isValidPrivateKey(t))throw Error("The tweak was out of range or the resulted private key is invalid");o.privateKey=t}else{let t=ry.fromHex(this.pubKey).add(ry.fromPrivateKey(n));if(t.equals(ry.ZERO))throw Error("The tweak was equal to negative P, which made the result key invalid");o.publicKey=t.toRawBytes(!0)}return new rv(o)}catch(e){return this.deriveChild(t+1)}}sign(t){if(!this.privateKey)throw Error("No privateKey set!");return a(t,32),ey.sign(t,this.privKey).toCompactRawBytes()}verify(t,e){let r;if(a(t,32),a(e,64),!this.publicKey)throw Error("No publicKey set!");try{r=ey.Signature.fromCompact(e)}catch(t){return!1}return ey.verify(r,t,this.publicKey)}wipePrivateData(){return this.privKey=void 0,this.privKeyBytes&&(this.privKeyBytes.fill(0),this.privKeyBytes=void 0),this}toJSON(){return{xpriv:this.privateExtendedKey,xpub:this.publicExtendedKey}}serialize(t,e){if(!this.chainCode)throw Error("No chainCode set");return a(e,33),x(rE(t),new Uint8Array([this.depth]),rE(this.parentFingerprint),rE(this.index),this.chainCode,e)}}function rx(t){return eD.fromBase64(t)}function rB(t){let e=JSON.stringify(t);return eD.toBase64(eD.fromString(e)).replace(/\+/g,"-").replace(/\//g,"_").split("=")[0]}function rk(t){if("string"!=typeof t||0===t.length||!/^[A-Za-z0-9\-_]+={0,2}$/.test(t)&&!/^[A-Za-z0-9+/]+={0,2}$/.test(t))return!1;let e=t.replace(/-/g,"+").replace(/_/g,"/"),r=(4-e.length%4)%4;if(r>2)return!1;let n=e+"=".repeat(r);try{let t=eD.fromBase64(n),r=eD.toBase64(t),i=r.replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,""),o=e.replace(/=+$/,"");return r.replace(/=+$/,"")===o||i===o}catch{return!1}}let rA=(t,e,r,n)=>{let i=eD.concat(eD.fromString("Cashu_KDF_HMAC_SHA256"),eD.fromHex(e),eD.writeBigUint64BE(BigInt(r)));switch(n){case 0:i=eD.concat(i,eD.fromHex("00"));break;case 1:i=eD.concat(i,eD.fromHex("01"))}return ti(te,t,i)},r_=(t,e,r,n)=>{let i=rv.fromMasterSeed(t),o=(t=>/^[a-fA-F0-9]+$/.test(t)?e$(t)%BigInt(0x80000000-1):eL(eD.fromBase64(t))%BigInt(0x80000000-1))(e),s=`m/129372'/0'/${o}'/${r}'/${n}`,a=i.derive(s);if(null===a.privateKey)throw Error("Could not derive private key");return a.privateKey},rI=t=>{try{return t instanceof Uint8Array&&(t=new TextDecoder().decode(t)),JSON.parse(t)}catch{throw Error("can't parse secret")}},rS=(t,e,r=!1)=>{let n=Array.isArray(e)?e:[e];return t.map((t,e)=>{let i=t;for(let t of n)try{i=rU(i,t)}catch(n){let t=n instanceof Error?n.message:"Unknown error";if(r)throw Error(`Failed signing proof #${e+1}: ${t}`);console.warn(`Proof #${e+1}: ${t}`)}return i})},rU=(t,e)=>{let r=rI(t.secret);if("P2PK"!==r[0])throw Error("not a P2PK secret");let n=g(e_.getPublicKey(e)),i=function(t){try{let e="string"==typeof t?rI(t):t;if("P2PK"!==e[0])throw Error('Invalid P2PK secret: must start with "P2PK"');let r=Math.floor(Date.now()/1e3);return function(t){let e="string"==typeof t?rI(t):t;if("P2PK"!==e[0])throw Error('Invalid P2PK secret: must start with "P2PK"');let{tags:r}=e[1],n=r&&r.find(t=>"locktime"===t[0]);return n&&n.length>1?parseInt(n[1],10):1/0}(e)>r?function(t){let e="string"==typeof t?rI(t):t;if("P2PK"!==e[0])throw Error('Invalid P2PK secret: must start with "P2PK"');let{data:r,tags:n}=e[1],i=n&&n.find(t=>"pubkeys"===t[0]);return[r,...i&&i.length>1?i.slice(1):[]].filter(Boolean)}(e):function(t){let e="string"==typeof t?rI(t):t;if("P2PK"!==e[0])throw Error('Invalid P2PK secret: must start with "P2PK"');let{tags:r}=e[1],n=r&&r.find(t=>"refund"===t[0]);return n&&n.length>1?n.slice(1).filter(Boolean):[]}(e)}catch{}return[]}(r);if(!i.length||!i.some(t=>t.includes(n)))throw Error(`Signature not required from [02|03]${n}`);let o=(t=>{if(!t)return[];if("string"==typeof t)try{return JSON.parse(t).signatures||[]}catch(t){return console.error("Failed to parse witness string:",t),[]}return t.signatures||[]})(t.witness);if(o.some(e=>{try{return((t,e,r)=>{try{let n=te(e),i=66===r.length?r.slice(2):r;if(e_.verify(t,n,w(i)))return!0}catch(t){console.error("verifyP2PKsecret error:",t)}return!1})(e,t.secret,n)}catch{return!1}}))throw Error(`Proof already signed by [02|03]${n}`);let s=((t,e)=>{let r=te(t);return g(e_.sign(r,e))})(t.secret,e);return o.push(s),{...t,witness:{signatures:o}}};function rR(t,e,r){let n=ej(t);e||(e=eL(ey.utils.randomPrivateKey()));let i=ey.ProjectivePoint.BASE.multiply(e),o=n.add(i);return void 0!==r?((t,e)=>{let r=((t,e)=>{let r=te(t);return g(e_.sign(r,e))})(t.B_.toHex(!0),e);return t.witness={signatures:[r]},t})({B_:o,r:e,secret:t},r):{B_:o,r:e,secret:t}}function rP(t){let e=[];return function t(e,r){if(null===e)r.push(246);else if(void 0===e)r.push(247);else if("boolean"==typeof e)r.push(e?245:244);else if("number"==typeof e)rO(e,r);else if("string"==typeof e)rq(e,r);else if(Array.isArray(e)){var n=e,i=r;let o=n.length;if(o<24)i.push(128|o);else if(o<256)i.push(152,o);else if(o<65536)i.push(153,o>>8,255&o);else throw Error("Unsupported array length");for(let e of n)t(e,i)}else if(e instanceof Uint8Array){var o=e,s=r;let t=o.length;if(t<24)s.push(64+t);else if(t<256)s.push(88,t);else if(t<65536)s.push(89,t>>8&255,255&t);else if(t<0x100000000)s.push(90,t>>24&255,t>>16&255,t>>8&255,255&t);else throw Error("Byte string too long to encode");for(let t=0;t<o.length;t++)s.push(o[t])}else if("object"!=typeof e||null===e||Array.isArray(e))throw Error("Unsupported type");else{var a=e,u=r;let n=Object.keys(a);for(let e of(rO(n.length,u),u[u.length-1]|=160,n))rq(e,u),t(a[e],u)}}(t,e),new Uint8Array(e)}function rO(t,e){if(t<24)e.push(t);else if(t<256)e.push(24,t);else if(t<65536)e.push(25,t>>8,255&t);else if(t<0x100000000)e.push(26,t>>24,t>>16&255,t>>8&255,255&t);else throw Error("Unsupported integer size")}function rq(t,e){let r=new TextEncoder().encode(t),n=r.length;if(n<24)e.push(96+n);else if(n<256)e.push(120,n);else if(n<65536)e.push(121,n>>8&255,255&n);else if(n<0x100000000)e.push(122,n>>24&255,n>>16&255,n>>8&255,255&n);else throw Error("String too long to encode");for(let t=0;t<r.length;t++)e.push(r[t])}function rM(t){return function t(e,r){if(r>=e.byteLength)throw Error("Unexpected end of data");let n=e.getUint8(r++),i=n>>5,o=31&n;switch(i){case 0:var s=e,a=r,u=o;let{value:f,offset:l}=rT(s,a,u);return{value:f,offset:l};case 1:var h=e,c=r,d=o;let{value:p,offset:y}=rT(h,c,d);return{value:-1-p,offset:y};case 2:var g=e,m=r,b=o;let{value:w,offset:E}=rT(g,m,b);if(E+w>g.byteLength)throw Error("Byte string length exceeds data length");return{value:new Uint8Array(g.buffer,g.byteOffset+E,w),offset:E+w};case 3:var v=e,x=r,B=o;let{value:k,offset:A}=rT(v,x,B);if(A+k>v.byteLength)throw Error("String length exceeds data length");let _=new Uint8Array(v.buffer,v.byteOffset+A,k);return{value:new TextDecoder().decode(_),offset:A+k};case 4:return function(e,r,n){let{value:i,offset:o}=rT(e,r,n),s=[],a=o;for(let r=0;r<i;r++){let r=t(e,a);s.push(r.value),a=r.offset}return{value:s,offset:a}}(e,r,o);case 5:return function(e,r,n){let{value:i,offset:o}=rT(e,r,n),s={},a=o;for(let r=0;r<i;r++){var u;let r=t(e,a);if("number"!=typeof(u=r.value)&&"string"!=typeof u)throw Error("Invalid key type");let n=t(e,r.offset);s[r.value]=n.value,a=n.offset}return{value:s,offset:a}}(e,r,o);case 7:var I=e,S=r,U=o;if(U<24)switch(U){case 20:return{value:!1,offset:S};case 21:return{value:!0,offset:S};case 22:return{value:null,offset:S};case 23:return{value:void 0,offset:S};default:throw Error(`Unknown simple value: ${U}`)}if(24===U)return{value:I.getUint8(S++),offset:S};if(25===U)return{value:function(t){let e=(31744&t)>>10,r=1023&t,n=32768&t?-1:1;return 0===e?6103515625e-14*n*(r/1024):31===e?r?NaN:1/0*n:n*2**(e-15)*(1+r/1024)}(I.getUint16(S,!1)),offset:S+=2};if(26===U)return{value:I.getFloat32(S,!1),offset:S+=4};if(27===U)return{value:I.getFloat64(S,!1),offset:S+=8};throw Error(`Unknown simple or float value: ${U}`);default:throw Error(`Unsupported major type: ${i}`)}}(new DataView(t.buffer,t.byteOffset,t.byteLength),0).value}function rT(t,e,r){if(r<24)return{value:r,offset:e};if(24===r)return{value:t.getUint8(e++),offset:e};if(25===r)return{value:t.getUint16(e,!1),offset:e+=2};if(26===r)return{value:t.getUint32(e,!1),offset:e+=4};if(27===r)return{value:0x100000000*t.getUint32(e,!1)+t.getUint32(e+4,!1),offset:e+=8};throw Error(`Unsupported length: ${r}`)}class rN{constructor(t,e,r,n,i,o,s=!1,a){this.transport=t,this.id=e,this.amount=r,this.unit=n,this.mints=i,this.description=o,this.singleUse=s,this.nut10=a}toRawRequest(){let t={};return this.transport&&(t.t=this.transport.map(t=>({t:t.type,a:t.target,g:t.tags}))),this.id&&(t.i=this.id),this.amount&&(t.a=this.amount),this.unit&&(t.u=this.unit),this.mints&&(t.m=this.mints),this.description&&(t.d=this.description),this.singleUse&&(t.s=this.singleUse),this.nut10&&(t.nut10={k:this.nut10.kind,d:this.nut10.data,t:this.nut10.tags}),t}toEncodedRequest(){let t=rP(this.toRawRequest());return"creqA"+eD.toBase64(t)}getTransport(t){return this.transport?.find(e=>e.type===t)}static fromRawRequest(t){let e=t.t?t.t.map(t=>({type:t.t,target:t.a,tags:t.g})):void 0,r=t.nut10?{kind:t.nut10.k,data:t.nut10.d,tags:t.nut10.t}:void 0;return new rN(e,t.i,t.a,t.u,t.m,t.d,t.s,r)}static fromEncodedRequest(t){if(!t.startsWith("creq"))throw Error("unsupported pr: invalid prefix");if("A"!==t[4])throw Error("unsupported pr version");let e=rM(rx(t.slice(5)));return this.fromRawRequest(e)}}function rK(t,e,r,n){if(r){let n=ne(r);if(0===t&&0===n)return r;let i=r.filter(t=>t>0),o=ne(i);if(o>t)throw Error(`Split is greater than total amount: ${o} > ${t}`);if(i.some(t=>!(t in e)))throw Error("Provided amount preferences do not match the amounts of the mint keyset.");if(o===t)return i;r=i,t-=o}else r=[];let i=rF(e,"desc");if(!i||0===i.length)throw Error("Cannot split amount, keyset is inactive or contains no keys");if(i.forEach(e=>{if(t<=0||e<=0)return;let n=Math.floor(t/e);for(let t=0;t<n;++t)r.push(e);t%=e}),0!==t)throw Error(`Unable to split remaining amount: ${t}`);return r.sort((t,e)=>t-e)}function rC(t,e,r,n){let i=[],o=t.map(t=>t.amount);rF(r,"asc").forEach(t=>{let r=Math.max(n-o.filter(e=>e===t).length,0);for(let n=0;n<r&&!(i.reduce((t,e)=>t+e,0)+t>e);++n)i.push(t)});let s=e-i.reduce((t,e)=>t+e,0);return s&&rK(s,r).forEach(t=>{i.push(t)}),i.sort((t,e)=>t-e)}function rF(t,e="desc"){return"desc"==e?Object.keys(t).map(t=>parseInt(t)).sort((t,e)=>e-t):Object.keys(t).map(t=>parseInt(t)).sort((t,e)=>t-e)}function rD(t){return BigInt(`0x${t}`)}function rL(t){return/^[a-f0-9]*$/i.test(t)}function r$(t){return Array.isArray(t)?t.some(t=>!rL(t.id)):!rL(t.id)}function rH(t){return t.map(t=>{let e={...t};return e.id=e.id.slice(0,16),e})}function rj(t,e){if(r$(t.proofs)||e?.version===3){if(e?.version===4)throw Error("can not encode to v4 token if proofs contain non-hex keyset id");var r=e?.removeDleq;r$(t.proofs)||(t.proofs=rH(t.proofs)),r&&(t.proofs=r3(t.proofs));let n={token:[{mint:t.mint,proofs:t.proofs}]};return t.unit&&(n.unit=t.unit),t.memo&&(n.memo=t.memo),"cashuA"+rB(n)}return rV(t,e?.removeDleq)}function rV(t,e){var r;if(e&&(t.proofs=r3(t.proofs)),t.proofs.forEach(t=>{if(t.dleq&&null==t.dleq.r)throw Error("Missing blinding factor in included DLEQ proof")}),r$(t.proofs))throw Error("can not encode to v4 token if proofs contain non-hex keyset id");return t.proofs=rH(t.proofs),"cashuB"+(r=rP(rz(t)),eD.toBase64(r).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,""))}function rz(t){let e={},r=t.mint;for(let r=0;r<t.proofs.length;r++){let n=t.proofs[r];e[n.id]?e[n.id].push(n):e[n.id]=[n]}let n={m:r,u:t.unit||"sat",t:Object.keys(e).map(t=>({i:w(t),p:e[t].map(t=>({a:t.amount,s:t.secret,c:w(t.C),...t.dleq&&{d:{e:w(t.dleq.e),s:w(t.dleq.s),r:w(t.dleq.r??"00")}},...t.witness&&{w:JSON.stringify(t.witness)}}))}))};return t.memo&&(n.d=t.memo),n}function rQ(t){let e=[];t.t.forEach(t=>t.p.forEach(r=>{e.push({secret:r.s,C:g(r.c),amount:r.a,id:g(t.i),...r.d&&{dleq:{r:g(r.d.r),s:g(r.d.s),e:g(r.d.e)}},...r.w&&{witness:r.w}})}));let r={mint:t.m,proofs:e,unit:t.u||"sat"};return t.d&&(r.memo=t.d),r}function rG(t,e){let r=rZ(t=nr(t));return r.proofs=function(t,e){let r=[];for(let n of t){let t;try{t=w(n.id)}catch{r.push(n);continue}if(0===t[0])r.push(n);else if(1===t[0]){if(!e)throw Error("A short keyset ID v2 was encountered, but got no keysets to map it to.");let t=!1;for(let i of e)if(n.id===i.id.slice(0,n.id.length)){n.id=i.id,r.push(n),t=!0;break}if(!t)throw Error(`Couldn't map short keyset ID ${n.id} to any known keysets of the current Mint`)}else throw Error(`Unknown keyset ID version: ${t[0]}`)}return r}(r.proofs,e),r}function rW(t){let e=rZ(t=nr(t));return{unit:e.unit||"sat",mint:e.mint,amount:r2(e.proofs),incompleteProofs:e.proofs.map(t=>({secret:t.secret,C:t.C,amount:t.amount,...t.dleq&&{dleq:t.dleq}})),...e.memo&&{memo:e.memo}}}function rZ(t){let e=t.slice(0,1),r=t.slice(1);if("A"===e){let t=JSON.parse(eD.toString(eD.fromBase64(r.replace(/-/g,"+").replace(/_/g,"/").split("=")[0])));if(t.token.length>1)throw Error("Multi entry token are not supported");let e=t.token[0],n={mint:e.mint,proofs:e.proofs,unit:t.unit||"sat"};return t.memo&&(n.memo=t.memo),n}if("B"===e)return rQ(rM(rx(r)));throw Error("Token version is not supported")}function rY(t,e,r,n=0,i=!1){if(i){let e=te(Object.entries(t).sort((t,e)=>t[0]-e[0]).map(([,t])=>t).reduce((t,e)=>t+e,""));return eD.toBase64(e).slice(0,12)}let o=Object.entries(t).sort((t,e)=>t[0]-e[0]).map(([,t])=>w(t)).reduce((t,e)=>rJ(t,e),new Uint8Array),s;switch(n){case 0:return s=te(o),"00"+eD.toHex(s).slice(0,14);case 1:if(!e)throw Error("Cannot compute keyset ID version 01: unit is required.");return o=rJ(o,eD.fromString("unit:"+e)),r&&(o=rJ(o,eD.fromString("final_expiry:"+r.toString()))),s=te(o),"01"+eD.toHex(s);default:throw Error(`Unrecognized keyset ID version: ${n}`)}}function rJ(t,e){let r=new Uint8Array(t.length+e.length);return r.set(t),r.set(e,t.length),r}function rX(t){return"object"==typeof t}function r0(...t){return t.map(t=>t.replace(/(^\/+|\/+$)/g,"")).join("/")}function r1(t){return t.replace(/\/$/,"")}function r2(t){return t.reduce((t,e)=>t+e.amount,0)}function r8(t){return rN.fromEncodedRequest(t)}class r6{get value(){return this._value}set value(t){this._value=t}get next(){return this._next}set next(t){this._next=t}constructor(t){this._value=t,this._next=null}}class r5{get first(){return this._first}set first(t){this._first=t}get last(){return this._last}set last(t){this._last=t}get size(){return this._size}set size(t){this._size=t}constructor(){this._first=null,this._last=null,this._size=0}enqueue(t){let e=new r6(t);return 0!==this._size&&this._last?this._last.next=e:this._first=e,this._last=e,this._size++,!0}dequeue(){if(0===this._size||!this._first)return null;let t=this._first;return this._first=t.next,t.next=null,this._size--,t.value}}function r3(t){return t.map(t=>{let e={...t};return delete e.dleq,e})}function r4(t){let e=rk(t.id),r=/^[a-fA-F0-9]+$/.test(t.id),n=r?w(t.id)[0]:0;return rY(t.keys,t.unit,t.final_expiry,n,e&&!r)===t.id}function r7(t,e){if(null==t.dleq)return!1;let r={e:w(t.dleq.e),s:w(t.dleq.s),r:rD(t.dleq.r??"00")};if(!(t.amount in e.keys))throw Error(`undefined key for amount ${t.amount}`);let n=e.keys[t.amount];return((t,e,r,n)=>{if(void 0===e.r)throw Error("verifyDLEQProof_reblind: Undefined blinding factor");let i=ej(t),o=r.add(n.multiply(e.r)),s=ey.ProjectivePoint.fromPrivateKey(e.r);return((t,e,r,n)=>{let i=ey.ProjectivePoint.fromPrivateKey(g(t.s)),o=n.multiply(eL(t.e)),s=e.multiply(eL(t.s)),a=r.multiply(eL(t.e));return function(t,e){if(t.length!==e.length)return!1;for(let r=0;r<t.length;r++)if(t[r]!==e[r])return!1;return!0}(function(t){let e=t.map(t=>t.toHex(!1)).join("");return te(new TextEncoder().encode(e))}([i.subtract(o),s.subtract(a),n,r]),t.e)})(e,i.add(s),o,n)})(new TextEncoder().encode(t.secret),r,eV(t.C),eV(n))}function r9(t){let e=new TextEncoder,r=rP(rz(t));return function(...t){let e=new Uint8Array(t.reduce((t,e)=>t+e.length,0)),r=0;for(let n=0;n<t.length;n++)e.set(t[n],r),r+=t[n].length;return e}(e.encode("craw"),e.encode("B"),r)}function nt(t){let e=new TextDecoder,r=e.decode(t.slice(0,4)),n=e.decode(new Uint8Array([t[4]]));if("craw"!==r||"B"!==n)throw Error("not a valid binary token");return rQ(rM(t.slice(5)))}function ne(t){return t.reduce((t,e)=>t+e,0)}function nr(t){return["web+cashu://","cashu://","cashu:","cashu"].forEach(e=>{t.startsWith(e)&&(t=t.slice(e.length))}),t}function nn(t){e=t}"u">typeof WebSocket&&(e=WebSocket);let ni={FATAL:"FATAL",ERROR:"ERROR",WARN:"WARN",INFO:"INFO",DEBUG:"DEBUG",TRACE:"TRACE"},no={fatal(){},error(){},warn(){},info(){},debug(){},trace(){},log(){}},ns=class t{constructor(t=ni.INFO){this.minLevel=t}logToConsole(e,r,n){if(t.SEVERITY[e]>t.SEVERITY[this.minLevel])return;let i=`[${e}] `,o=r,s=new Set;if(n){let t=Object.fromEntries(Object.entries(n).map(([t,e])=>[t,e instanceof Error?{message:e.message,stack:e.stack}:e]));o=r.replace(/\{(\w+)\}/g,(e,r)=>{if(r in t&&void 0!==t[r]){s.add(r);let e=t[r];return"string"==typeof e?e:"number"==typeof e||"boolean"==typeof e?e.toString():null==e?"":JSON.stringify(e)}return e});let a=Object.fromEntries(Object.entries(t).filter(([t])=>!s.has(t))),u=this.getConsoleMethod(e);Object.keys(a).length>0?u(i+o,a):u(i+o)}else this.getConsoleMethod(e)(i+o)}getConsoleMethod(t){switch(t){case ni.FATAL:case ni.ERROR:return console.error;case ni.WARN:return console.warn;case ni.INFO:return console.info;case ni.DEBUG:return console.debug;case ni.TRACE:return console.trace;default:return console.log}}fatal(t,e){this.logToConsole(ni.FATAL,t,e)}error(t,e){this.logToConsole(ni.ERROR,t,e)}warn(t,e){this.logToConsole(ni.WARN,t,e)}info(t,e){this.logToConsole(ni.INFO,t,e)}debug(t,e){this.logToConsole(ni.DEBUG,t,e)}trace(t,e){this.logToConsole(ni.TRACE,t,e)}log(t,e,r){this.logToConsole(t,e,r)}};ns.SEVERITY={[ni.FATAL]:0,[ni.ERROR]:1,[ni.WARN]:2,[ni.INFO]:3,[ni.DEBUG]:4,[ni.TRACE]:5};let na=ns;class nu{constructor(){this.connectionMap=new Map}static getInstance(){return nu.instance||(nu.instance=new nu),nu.instance}getConnection(t,e){if(this.connectionMap.has(t))return this.connectionMap.get(t);let r=new nf(t,e);return this.connectionMap.set(t,r),r}}class nf{constructor(t,r){this.subListeners={},this.rpcListeners={},this.rpcId=0,this.onCloseCallbacks=[],this._WS=function(){if(void 0===e)throw Error("WebSocket implementation not initialized");return e}(),this.url=new URL(t),this.messageQueue=new r5,this._logger=r??no}connect(){return this.connectionPromise||(this.connectionPromise=new Promise((t,e)=>{try{this.ws=new this._WS(this.url.toString()),this.onCloseCallbacks=[]}catch(t){e(t instanceof Error?t:Error(String(t)));return}this.ws.onopen=()=>{t()},this.ws.onerror=()=>{e(Error("Failed to open WebSocket"))},this.ws.onmessage=t=>{this.messageQueue.enqueue(t.data),this.handlingInterval||(this.handlingInterval=setInterval(this.handleNextMessage.bind(this),0))},this.ws.onclose=t=>{this.connectionPromise=void 0,this.onCloseCallbacks.forEach(e=>e(t))}})),this.connectionPromise}sendRequest(t,e){if(this.ws?.readyState!==1){if("unsubscribe"===t)return;throw this._logger.error("Attempted sendRequest, but socket was not open"),Error("Socket not open")}let r=this.rpcId;this.rpcId++;let n=JSON.stringify({jsonrpc:"2.0",method:t,params:e,id:r});this.ws?.send(n)}closeSubscription(t){this.ws?.send(JSON.stringify(["CLOSE",t]))}addSubListener(t,e){(this.subListeners[t]=this.subListeners[t]||[]).push(e)}addRpcListener(t,e,r){this.rpcListeners[r]={callback:t,errorCallback:e}}removeRpcListener(t){delete this.rpcListeners[t]}removeListener(t,e){if(this.subListeners[t]){if(1===this.subListeners[t].length)return void delete this.subListeners[t];this.subListeners[t]=this.subListeners[t].filter(t=>t!==e)}}async ensureConnection(){this.ws?.readyState!==1&&await this.connect()}handleNextMessage(){let t;if(0===this.messageQueue.size){clearInterval(this.handlingInterval),this.handlingInterval=void 0;return}let e=this.messageQueue.dequeue();try{if(t=JSON.parse(e),"result"in t&&null!=t.id)this.rpcListeners[t.id]&&(this.rpcListeners[t.id].callback(),this.removeRpcListener(t.id));else if("error"in t&&null!=t.id)this.rpcListeners[t.id]&&(this.rpcListeners[t.id].errorCallback(Error(t.error.message)),this.removeRpcListener(t.id));else if("method"in t&&!("id"in t)){let e=t.params?.subId;if(!e)return;this.subListeners[e]?.length>0&&this.subListeners[e].forEach(e=>e(t.params?.payload))}}catch(t){this._logger.error("Error doing handleNextMessage",{e:t});return}}createSubscription(t,e,r){if(this.ws?.readyState!==1)throw this._logger.error("Attempted createSubscription, but socket was not open"),Error("Socket is not open");let n=(Math.random()+1).toString(36).substring(7);return this.addRpcListener(()=>{this.addSubListener(n,e)},r,this.rpcId),this.sendRequest("subscribe",{...t,subId:n}),this.rpcId++,n}cancelSubscription(t,e,r){this.removeListener(t,e),this.addRpcListener(()=>{this._logger.info("Unsubscribed {subId}",{subId:t})},r||(t=>this._logger.error("Unsubscribe failed",{e:t})),this.rpcId),this.sendRequest("unsubscribe",{subId:t})}get activeSubscriptions(){return Object.keys(this.subListeners)}close(){this.ws&&this.ws?.close()}onClose(t){this.onCloseCallbacks.push(t)}}let nl={UNSPENT:"UNSPENT",PENDING:"PENDING",SPENT:"SPENT"},nh={UNPAID:"UNPAID",PENDING:"PENDING",PAID:"PAID"},nc={UNPAID:"UNPAID",PAID:"PAID",ISSUED:"ISSUED"};var nd=(t=>(t.POST="post",t.NOSTR="nostr",t))(nd||{});class np extends Error{constructor(t,e){super(t),this.status=e,this.name="HttpResponseError",Object.setPrototypeOf(this,np.prototype)}}class ny extends Error{constructor(t){super(t),this.name="NetworkError",Object.setPrototypeOf(this,ny.prototype)}}class ng extends np{constructor(t,e){super(e||"Unknown mint operation error",400),this.code=t,this.name="MintOperationError",Object.setPrototypeOf(this,ng.prototype)}}let nm={},nb=no;function nw(t){nm=t}async function nE({endpoint:t,requestBody:e,headers:r,...n}){let i,o=e?JSON.stringify(e):void 0,s={Accept:"application/json, text/plain, */*",...o?{"Content-Type":"application/json"}:void 0,...r};try{i=await fetch(t,{body:o,headers:s,...n})}catch(t){throw new ny(t instanceof Error?t.message:"Network request failed")}if(!i.ok){let t;try{t=await i.json()}catch{t={error:"bad response"}}if(400===i.status&&"code"in t&&"number"==typeof t.code&&"detail"in t&&"string"==typeof t.detail)throw new ng(t.code,t.detail);let e="HTTP request failed";throw"error"in t&&"string"==typeof t.error?e=t.error:"detail"in t&&"string"==typeof t.detail&&(e=t.detail),new np(e,i.status)}try{return await i.json()}catch(t){throw nb.error("Failed to parse HTTP response",{err:t}),new np("bad response",i.status)}}async function nv(t){return await nE({...t,...nm})}function nx(t,e){return t.state||(e.warn("Field 'state' not found in MeltQuoteResponse. Update NUT-05 of mint: https://github.com/cashubtc/nuts/pull/136)"),"boolean"==typeof t.paid&&(t.state=t.paid?nh.PAID:nh.UNPAID)),t}function nB(t,e){return t.state||(e.warn("Field 'state' not found in MintQuoteResponse. Update NUT-04 of mint: https://github.com/cashubtc/nuts/pull/141)"),"boolean"==typeof t.paid&&(t.state=t.paid?nc.PAID:nc.UNPAID)),t}class nk{constructor(t){this._mintInfo=t,t.nuts[22]&&(this._protectedEnpoints={cache:{},apiReturn:t.nuts[22].protected_endpoints.map(t=>({method:t.method,regex:new RegExp(t.path)}))})}isSupported(t){switch(t){case 4:case 5:return this.checkMintMelt(t);case 7:case 8:case 9:case 10:case 11:case 12:case 14:case 20:return this.checkGenericNut(t);case 17:return this.checkNut17();case 15:return this.checkNut15();default:throw Error("nut is not supported by cashu-ts")}}requiresBlindAuthToken(t){if(!this._protectedEnpoints)return!1;if("boolean"==typeof this._protectedEnpoints.cache[t])return this._protectedEnpoints.cache[t];let e=this._protectedEnpoints.apiReturn.some(e=>e.regex.test(t));return this._protectedEnpoints.cache[t]=e,e}checkGenericNut(t){return this._mintInfo.nuts[t]?.supported?{supported:!0}:{supported:!1}}checkMintMelt(t){let e=this._mintInfo.nuts[t];return e&&e.methods.length>0&&!e.disabled?{disabled:!1,params:e.methods}:{disabled:!0,params:e.methods}}checkNut17(){return this._mintInfo.nuts[17]&&this._mintInfo.nuts[17].supported.length>0?{supported:!0,params:this._mintInfo.nuts[17].supported}:{supported:!1}}checkNut15(){return this._mintInfo.nuts[15]&&this._mintInfo.nuts[15].methods.length>0?{supported:!0,params:this._mintInfo.nuts[15].methods}:{supported:!1}}get contact(){return this._mintInfo.contact}get description(){return this._mintInfo.description}get description_long(){return this._mintInfo.description_long}get name(){return this._mintInfo.name}get pubkey(){return this._mintInfo.pubkey}get nuts(){return this._mintInfo.nuts}get version(){return this._mintInfo.version}get motd(){return this._mintInfo.motd}get supportsBolt12Description(){return this._mintInfo.nuts[4]?.methods.some(t=>"bolt12"===t.method&&t.options?.description===!0)}}class nA{constructor(t,e,r,n){this._mintUrl=t,this._customRequest=e,this._checkNut22=!1,this._mintUrl=r1(t),this._customRequest=e,r&&(this._checkNut22=!0,this._authTokenGetter=r),this._logger=n?.logger??no,nb=this._logger}get mintUrl(){return this._mintUrl}static async getInfo(t,e,r){var n,i;return n=await (e||nv)({endpoint:r0(t,"/v1/info")}),i=r??no,Array.isArray(n?.contact)&&n?.contact.length>0&&(n.contact=n.contact.map(t=>Array.isArray(t)&&2===t.length&&"string"==typeof t[0]&&"string"==typeof t[1]?(i.warn("Mint returned deprecated 'contact' field: Update NUT-06: https://github.com/cashubtc/nuts/pull/117"),{method:t[0],info:t[1]}):t)),n}async getInfo(){return nA.getInfo(this._mintUrl,this._customRequest,this._logger)}async getLazyMintInfo(){if(this._mintInfo)return this._mintInfo;let t=await nA.getInfo(this._mintUrl,this._customRequest);return this._mintInfo=new nk(t),this._mintInfo}static async swap(t,e,r,n){let i=r||nv,o=await i({endpoint:r0(t,"/v1/swap"),method:"POST",requestBody:e,headers:n?{"Blind-auth":n}:{}});if(!rX(o)||!Array.isArray(o?.signatures))throw Error(o.detail??"bad response");return o}async swap(t){let e=await this.handleBlindAuth("/v1/swap");return nA.swap(this._mintUrl,t,this._customRequest,e)}static async createMintQuote(t,e,r,n,i){let o=r||nv;return nB(await o({endpoint:r0(t,"/v1/mint/quote/bolt11"),method:"POST",requestBody:e,headers:n?{"Blind-auth":n}:{}}),i??no)}async createMintQuote(t){let e=await this.handleBlindAuth("/v1/mint/quote/bolt11");return nA.createMintQuote(this._mintUrl,t,this._customRequest,e)}static async createMintQuoteBolt12(t,e,r,n){let i=r||nv;return await i({endpoint:r0(t,"/v1/mint/quote/bolt12"),method:"POST",requestBody:e,headers:n?{"Blind-auth":n}:{}})}async createMintQuoteBolt12(t){let e=await this.handleBlindAuth("/v1/mint/quote/bolt12");return nA.createMintQuoteBolt12(this._mintUrl,t,this._customRequest,e)}static async checkMintQuote(t,e,r,n,i){let o=r||nv;return nB(await o({endpoint:r0(t,"/v1/mint/quote/bolt11",e),method:"GET",headers:n?{"Blind-auth":n}:{}}),i??no)}async checkMintQuote(t){let e=await this.handleBlindAuth(`/v1/mint/quote/bolt11/${t}`);return nA.checkMintQuote(this._mintUrl,t,this._customRequest,e)}static async checkMintQuoteBolt12(t,e,r,n){let i=r||nv;return await i({endpoint:r0(t,"/v1/mint/quote/bolt12",e),method:"GET",headers:n?{"Blind-auth":n}:{}})}async checkMintQuoteBolt12(t){let e=await this.handleBlindAuth(`/v1/mint/quote/bolt12/${t}`);return nA.checkMintQuoteBolt12(this._mintUrl,t,this._customRequest,e)}static async mint(t,e,r,n){let i=r||nv,o=await i({endpoint:r0(t,"/v1/mint/bolt11"),method:"POST",requestBody:e,headers:n?{"Blind-auth":n}:{}});if(!rX(o)||!Array.isArray(o?.signatures))throw Error("bad response");return o}async mint(t){let e=await this.handleBlindAuth("/v1/mint/bolt11");return nA.mint(this._mintUrl,t,this._customRequest,e)}static async mintBolt12(t,e,r,n){let i=r||nv,o=await i({endpoint:r0(t,"/v1/mint/bolt12"),method:"POST",requestBody:e,headers:n?{"Blind-auth":n}:{}});if(!rX(o)||!Array.isArray(o?.signatures))throw Error("bad response");return o}async mintBolt12(t){let e=await this.handleBlindAuth("/v1/mint/bolt12");return nA.mintBolt12(this._mintUrl,t,this._customRequest,e)}static async createMeltQuote(t,e,r,n,i){let o=r||nv,s=nx(await o({endpoint:r0(t,"/v1/melt/quote/bolt11"),method:"POST",requestBody:e,headers:n?{"Blind-auth":n}:{}}),i??no);if(!rX(s)||"number"!=typeof s?.amount||"number"!=typeof s?.fee_reserve||"string"!=typeof s?.quote)throw Error("bad response");return s}async createMeltQuote(t){let e=await this.handleBlindAuth("/v1/melt/quote/bolt11");return nA.createMeltQuote(this._mintUrl,t,this._customRequest,e)}static async createMeltQuoteBolt12(t,e,r,n){let i=r||nv;return await i({endpoint:r0(t,"/v1/melt/quote/bolt12"),method:"POST",requestBody:e,headers:n?{"Blind-auth":n}:{}})}async createMeltQuoteBolt12(t){let e=await this.handleBlindAuth("/v1/melt/quote/bolt12");return nA.createMeltQuoteBolt12(this._mintUrl,t,this._customRequest,e)}static async checkMeltQuote(t,e,r,n,i){let o=r||nv,s=nx(await o({endpoint:r0(t,"/v1/melt/quote/bolt11",e),method:"GET",headers:n?{"Blind-auth":n}:{}}),i??no);if(!rX(s)||"number"!=typeof s?.amount||"number"!=typeof s?.fee_reserve||"string"!=typeof s?.quote||"string"!=typeof s?.state||!Object.values(nh).includes(s.state))throw Error("bad response");return s}async checkMeltQuote(t){let e=await this.handleBlindAuth(`/v1/melt/quote/bolt11/${t}`);return nA.checkMeltQuote(this._mintUrl,t,this._customRequest,e)}static async checkMeltQuoteBolt12(t,e,r,n){let i=r||nv;return await i({endpoint:r0(t,"/v1/melt/quote/bolt12",e),method:"GET",headers:n?{"Blind-auth":n}:{}})}async checkMeltQuoteBolt12(t){let e=await this.handleBlindAuth(`/v1/melt/quote/bolt12/${t}`);return nA.checkMeltQuoteBolt12(this._mintUrl,t,this._customRequest,e)}static async melt(t,e,r,n,i){let o=r||nv,s=nx(await o({endpoint:r0(t,"/v1/melt/bolt11"),method:"POST",requestBody:e,headers:n?{"Blind-auth":n}:{}}),i??no);if(!rX(s)||"string"!=typeof s?.state||!Object.values(nh).includes(s.state))throw Error("bad response");return s}async melt(t){let e=await this.handleBlindAuth("/v1/melt/bolt11");return nA.melt(this._mintUrl,t,this._customRequest,e)}static async meltBolt12(t,e,r,n){let i=r||nv;return await i({endpoint:r0(t,"/v1/melt/bolt12"),method:"POST",requestBody:e,headers:n?{"Blind-auth":n}:{}})}async meltBolt12(t){let e=await this.handleBlindAuth("/v1/melt/bolt12");return nA.meltBolt12(this._mintUrl,t,this._customRequest,e)}static async check(t,e,r){let n=await (r||nv)({endpoint:r0(t,"/v1/checkstate"),method:"POST",requestBody:e});if(!rX(n)||!Array.isArray(n?.states))throw Error("bad response");return n}static async getKeys(t,e,r){e&&(e=e.replace(/\//g,"_").replace(/\+/g,"-"));let n=await (r||nv)({endpoint:e?r0(t,"/v1/keys",e):r0(t,"/v1/keys")});if(!rX(n)||!Array.isArray(n.keysets))throw Error("bad response");return n}async getKeys(t,e){return await nA.getKeys(e||this._mintUrl,t,this._customRequest)}static async getKeySets(t,e){return(e||nv)({endpoint:r0(t,"/v1/keysets")})}async getKeySets(){return nA.getKeySets(this._mintUrl,this._customRequest)}async check(t){return nA.check(this._mintUrl,t,this._customRequest)}static async restore(t,e,r){let n=await (r||nv)({endpoint:r0(t,"/v1/restore"),method:"POST",requestBody:e});if(!rX(n)||!Array.isArray(n?.outputs)||!Array.isArray(n?.signatures))throw Error("bad response");return n}async restore(t){return nA.restore(this._mintUrl,t,this._customRequest)}async connectWebSocket(){if(this.ws)await this.ws.ensureConnection();else{let t=new URL(this._mintUrl),e="v1/ws";t.pathname&&(t.pathname.endsWith("/")?t.pathname+=e:t.pathname+="/"+e),this.ws=nu.getInstance().getConnection(`${"https:"===t.protocol?"wss":"ws"}://${t.host}${t.pathname}`);try{await this.ws.connect()}catch(t){throw this._logger.error("Failed to connect to WebSocket...",{e:t}),Error("Failed to connect to WebSocket...")}}}disconnectWebSocket(){this.ws&&this.ws.close()}get webSocketConnection(){return this.ws}async handleBlindAuth(t){if(this._checkNut22&&(await this.getLazyMintInfo()).requiresBlindAuthToken(t)){if(!this._authTokenGetter)throw Error("Can not call a protected endpoint without authProofGetter");return this._authTokenGetter()}}}class n_{constructor(t,e,r){this.amount=t,this.B_=e,this.id=r}getSerializedBlindedMessage(){return{amount:this.amount,B_:this.B_.toHex(!0),id:this.id}}}function nI(t){return"function"==typeof t}let nS=new Set(["locktime","pubkeys","n_sigs","refund","n_sigs_refund"]);class nU{constructor(t,e,r){this.secret=r,this.blindingFactor=e,this.blindedMessage=t}toProof(t,e){let r,n;t.dleq&&(r={s:w(t.dleq.s),e:w(t.dleq.e),r:this.blindingFactor});let i={id:t.id,amount:t.amount,C_:eV(t.C_)},o=eV(e.keys[t.amount]);return{...{amount:(n=function(t,e,r,n){var i;let o=(i=t.C_,i.subtract(n.multiply(e)));return{id:t.id,amount:t.amount,secret:r,C:o}}(i,this.blindingFactor,this.secret,o)).amount,C:n.C.toHex(!0),id:n.id,secret:new TextDecoder().decode(n.secret),witness:JSON.stringify(n.witness)},...r&&{dleq:{s:g(r.s),e:g(r.e),r:(r.r??BigInt(0)).toString(16).padStart(64,"0")}}}}static createP2PKData(t,e,r,n){return rK(e,r.keys,n).map(e=>this.createSingleP2PKData(t,e,r.id))}static createSingleP2PKData(t,e,r){let n=Array.isArray(t.pubkey)?t.pubkey:[t.pubkey],i=t.refundKeys??[],o=Math.max(1,Math.min(t.requiredSignatures??1,n.length)),s=Math.max(1,Math.min(t.requiredRefundSignatures??1,i.length||1)),a=n[0],u=n.slice(1),f=[],l=t.locktime??NaN;if(Number.isSafeInteger(l)&&l>=0&&f.push(["locktime",String(l)]),u.length>0&&(f.push(["pubkeys",...u]),o>1&&f.push(["n_sigs",String(o)])),i.length>0&&(f.push(["refund",...i]),s>1&&f.push(["n_sigs_refund",String(s)])),t.additionalTags?.length){let e=t.additionalTags.map(([t,...e],r)=>{if("string"!=typeof t||!t)throw Error(`additionalTags[${r}][0] must be a non empty string`);if(nS.has(t))throw Error(`additionalTags must not use reserved key "${t}"`);return[t,...e.map(String)]});f.push(...e)}let h=JSON.stringify(["P2PK",{nonce:g(A(32)),data:a,tags:f}]),c=[...h].length;if(c>1024)throw Error(`Secret too long (${c} characters), maximum is 1024`);let d=new TextEncoder().encode(h),{r:p,B_:y}=rR(d);return new nU(new n_(e,y,r).getSerializedBlindedMessage(),p,d)}static createRandomData(t,e,r){return rK(t,e.keys,r).map(t=>this.createSingleRandomData(t,e.id))}static createSingleRandomData(t,e){let r=g(A(32)),n=new TextEncoder().encode(r),{r:i,B_:o}=rR(n);return new nU(new n_(t,o,e).getSerializedBlindedMessage(),i,n)}static createDeterministicData(t,e,r,n,i){return rK(t,n.keys,i).map((t,i)=>this.createSingleDeterministicData(t,e,r+i,n.id))}static createSingleDeterministicData(t,e,r,n){let i=g(((t,e,r)=>{let n=/^[a-fA-F0-9]+$/.test(e);if(!n&&rk(e)||n&&e.startsWith("00"))return r_(t,e,r,0);if(n&&e.startsWith("01"))return rA(t,e,r,0);throw Error(`Unrecognized keyset ID version ${e.slice(0,2)}`)})(e,n,r)),o=new TextEncoder().encode(i),{r:s,B_:a}=rR(o,rD(g(((t,e,r)=>{let n=/^[a-fA-F0-9]+$/.test(e);if(!n&&rk(e)||n&&e.startsWith("00"))return r_(t,e,r,1);if(n&&e.startsWith("01"))return rA(t,e,r,1);throw Error(`Unrecognized keyset ID version ${e.slice(0,2)}`)})(e,n,r))));return new nU(new n_(t,a,n).getSerializedBlindedMessage(),s,o)}}class nR{constructor(t,e){this._keys=new Map,this._keysets=[],this._seed=void 0,this._unit="sat",this._mintInfo=void 0,this._denominationTarget=3,this.mint=t,this._logger=e?.logger??no,this._logger.warn("cashu-ts v3 has been released. Please upgrade to access the latest features. v2 is now in minimal maintenance mode.");let r=[];if(e?.keys&&!Array.isArray(e.keys)?r=[e.keys]:e?.keys&&Array.isArray(e?.keys)&&(r=e?.keys),r&&r.forEach(t=>this._keys.set(t.id,t)),e?.unit&&(this._unit=e?.unit),e?.keysets&&(this._keysets=e.keysets),e?.mintInfo&&(this._mintInfo=new nk(e.mintInfo)),e?.denominationTarget&&(this._denominationTarget=e.denominationTarget),e?.bip39seed){if(e.bip39seed instanceof Uint8Array){this._seed=e.bip39seed;return}throw Error("bip39seed must be a valid UInt8Array")}e?.keepFactory&&(this._keepFactory=e.keepFactory)}get unit(){return this._unit}get keys(){return this._keys}get keysetId(){if(!this._keysetId)throw Error("No keysetId set");return this._keysetId}set keysetId(t){this._keysetId=t}get keysets(){return this._keysets}get mintInfo(){if(!this._mintInfo)throw Error("Mint info not loaded");return this._mintInfo}async getMintInfo(){let t=await this.mint.getInfo();return this._mintInfo=new nk(t),this._mintInfo}async lazyGetMintInfo(){return this._mintInfo?this._mintInfo:await this.getMintInfo()}async loadMint(){await Promise.all([this.getMintInfo(),this.getKeys()])}getActiveKeyset(t){let e=t.filter(t=>t.active&&t.unit===this._unit),r=(e=e.filter(t=>rL(t.id))).sort((t,e)=>(t.input_fee_ppk??0)-(e.input_fee_ppk??0))[0];if(!r)throw Error("No active keyset found");return r}async getKeySets(){let t=(await this.mint.getKeySets()).keysets.filter(t=>t.unit===this._unit);return this._keysets=t,this._keysets}async getAllKeys(){let t=await this.mint.getKeys();return t.keysets.forEach(t=>{if(!r4(t))throw Error(`Couldn't verify keyset ID ${t.id}`)}),this._keys=new Map(t.keysets.map(t=>[t.id,t])),this.keysetId=this.getActiveKeyset(this._keysets).id,t.keysets}async getKeys(t,e){if((!(this._keysets.length>0)||e)&&await this.getKeySets(),t||(t=this.getActiveKeyset(this._keysets).id),!this._keysets.find(e=>e.id===t)&&(await this.getKeySets(),!this._keysets.find(e=>e.id===t)))throw Error(`could not initialize keys. No keyset with id '${t}' found`);if(!this._keys.get(t)){let e=await this.mint.getKeys(t);if(!r4(e.keysets[0]))throw Error(`Couldn't verify keyset ID ${e.keysets[0].id}`);this._keys.set(t,e.keysets[0])}return this.keysetId=t,this._keys.get(t)}async receive(t,e){let r,{requireDleq:n,keysetId:i,outputAmounts:o,counter:s,pubkey:a,privkey:u,outputData:f,p2pk:l}=e||{};0===this._keysets.length&&await this.getKeySets(),"string"==typeof t&&(t=rG(t,this._keysets));let h=await this.getKeys(i);if(n&&t.proofs.some(t=>!r7(t,h)))throw Error("Token contains proofs with invalid DLEQ");let c=r2(t.proofs)-this.getFeesForProofs(t.proofs);f?r={send:f}:this._keepFactory&&(r={send:this._keepFactory});let d=this.createSwapPayload(c,t.proofs,h,o,s,a,u,r,l),{signatures:p}=await this.mint.swap(d.payload),y=d.outputData.map((t,e)=>t.toProof(p[e],h)),g=[];return d.sortedIndices.forEach((t,e)=>{g[t]=y[e]}),g}async send(t,e,r){let{offline:n,includeFees:i,includeDleq:o,keysetId:s,outputAmounts:a,pubkey:u,privkey:f,outputData:l}=r||{};if(o&&(e=e.filter(t=>null!=t.dleq)),r2(e)<t)throw Error("Not enough funds available to send");let{keep:h,send:c}=this.selectProofsToSend(e,t,r?.includeFees),d=i?this.getFeesForProofs(c):0;if(!n&&(r2(c)!=t+d||a||u||f||s||l)){let n=await this.swap(t,e,r),{keep:i,send:o}=n;return{keep:i,send:o,serialized:n.serialized}}if(r2(c)<t+d)throw Error("Not enough funds available to send");return{keep:h,send:c}}selectProofsToSend(t,e,r=!1){let n=function(){let t=Date.now();return{elapsed:()=>Date.now()-t}}(),i=null,o=1/0,s=0,a=0,u=(t,e)=>t-(r?Math.ceil(e/1e3):0),f=t=>{let e=[...t];for(let t=e.length-1;t>0;t--){let r=Math.floor(Math.random()*(t+1));[e[t],e[r]]=[e[r],e[t]]}return e},l=(t,e,r)=>{let n=0,i=t.length-1,o=null;for(;n<=i;){let s=Math.floor((n+i)/2),a=t[s].exFee;(r?a<=e:a>=e)?(o=s,r?n=s+1:i=s-1):r?i=s-1:n=s+1}return r?o:n<t.length?n:null},h=(t,e)=>{let r=e.exFee,n=0,i=t.length;for(;n<i;){let e=Math.floor((n+i)/2);t[e].exFee<r?n=e+1:i=e}t.splice(n,0,e)},c=(t,r)=>u(t,r)<e?1/0:t+r/1e3-e,d=0,p=0,y=t.map(t=>{let e=this.getProofFeePPK(t),n=r?t.amount-e/1e3:t.amount;return(!r||n>0)&&(d+=t.amount,p+=e),{proof:t,exFee:n,ppkfee:e}}),g=r?y.filter(t=>t.exFee>0):y;if(g.sort((t,e)=>t.exFee-e.exFee),g.length>0){let t;{let r=l(g,e,!1);if(null!==r){let e=g[r].exFee,n=l(g,e,!0);if(null===n)throw Error("Unexpected null rightIndex in binary search");t=n+1}else t=g.length}for(let e=t;e<g.length;e++)d-=g[e].proof.amount,p-=g[e].ppkfee;g=g.slice(0,t)}let m=u(d,p);if(e<=0||e>m)return{keep:t,send:[]};let b=Math.min(Math.ceil(+e),e+0,m);for(let t=0;t<60;t++){let r=[],d=0,p=0;for(let t of f(g)){let n=d+t.proof.amount,i=p+t.ppkfee,o=u(n,i);if(r.push(t),d=n,p=i,o>=e)break}let y=new Set(r),m=g.filter(t=>!y.has(t));for(let t of f(Array.from({length:r.length},(t,e)=>e)).slice(0,5e3)){let n=u(d,p);if(n===e||n>=e&&n<=b)break;let i=r[t],o=d-i.proof.amount,s=p-i.ppkfee,a=e-u(o,s),f=l(m,a,!1);if(null!==f){let e=m[f];(a>=0||e.exFee<=i.exFee)&&(r[t]=e,d=o+e.proof.amount,p=s+e.ppkfee,m.splice(f,1),h(m,i))}}let w=c(d,p);if(w<o){this._logger.debug("selectProofsToSend: best solution found in trial #{trial} - amount: {amount}, delta: {delta}",{trial:t,amount:d,delta:w}),i=[...r].sort((t,e)=>e.exFee-t.exFee),o=w,s=d,a=p;let e=[...i];for(;e.length>1&&o>0;){let t=e.pop(),r=d-t.proof.amount,n=p-t.ppkfee,u=c(r,n);if(u==1/0)break;u<o&&(i=[...e],o=u,s=r,a=n,d=r,p=n)}}if(i&&o<1/0){let t=u(s,a);if(t===e||t>=e&&t<=b)break}if(n.elapsed()>1e3){this._logger.warn("Proof selection took too long. Returning best selection so far.");break}}if(i&&o<1/0){let e=i.map(t=>t.proof),r=new Set(e),o=t.filter(t=>!r.has(t));return this._logger.info("Proof selection took {time}ms",{time:n.elapsed()}),{keep:o,send:e}}return{keep:t,send:[]}}getFeesForProofs(t){return Math.ceil(t.reduce((t,e)=>t+this.getProofFeePPK(e),0)/1e3)}getProofFeePPK(t){let e=this._keysets.find(e=>e.id===t.id);if(!e)throw Error(`Could not get fee. No keyset found for keyset id: ${t.id}`);return e?.input_fee_ppk||0}getFeesForKeyset(t,e){return Math.floor(Math.max((t*(this._keysets.find(t=>t.id===e)?.input_fee_ppk||0)+999)/1e3,0))}async swap(t,e,r){let n,{outputAmounts:i}=r||{},{includeFees:o,keysetId:s,counter:a,pubkey:u,privkey:f,proofsWeHave:l,outputData:h,p2pk:c}=r||{},d=await this.getKeys(s),p=t,y=r2(e),g=i?.sendAmounts||rK(p,d.keys);if(o){let t=this.getFeesForKeyset(g.length,d.id),e=rK(t,d.keys);for(;this.getFeesForKeyset(g.concat(e).length,d.id)>t;)e=rK(++t,d.keys);g=g.concat(e),p+=t}let{keep:m,send:b}=this.selectProofsToSend(e,p,!0),w=r2(b)-this.getFeesForProofs(b)-p;if(w<0)throw Error("Not enough balance to send");if(i?.keepAmounts||l){if(!i?.keepAmounts&&l)n=rC(l,w,d.keys,this._denominationTarget);else if(i){if(i.keepAmounts?.reduce((t,e)=>t+e,0)!=w)throw Error("Keep amounts do not match amount to keep");n=i.keepAmounts}}else n=rK(w,d.keys);if(p+this.getFeesForProofs(b)>y)throw this._logger.error(`Not enough funds available (${y}) for swap amountToSend: ${p} + fee: ${this.getFeesForProofs(b)} | length: ${b.length}`),Error("Not enough funds available for swap");i={keepAmounts:n,sendAmounts:g};let E=h?.keep||this._keepFactory,v=h?.send,x=this.createSwapPayload(p,b,d,i,a,u,f,{keep:E,send:v},c),{signatures:B}=await this.mint.swap(x.payload),k=x.outputData.map((t,e)=>t.toProof(B[e],d)),A=[],_=[],I=Array(x.keepVector.length),S=Array(k.length);return x.sortedIndices.forEach((t,e)=>{I[t]=x.keepVector[e],S[t]=k[e]}),S.forEach((t,e)=>{I[e]?A.push(t):_.push(t)}),{keep:[...A,...m],send:_}}async batchRestore(t=300,e=100,r=0,n){let i=Math.ceil(t/e),o=[],s,a=0;for(;a<i;){let t=await this.restore(r,e,{keysetId:n});t.proofs.length>0?(a=0,o.push(...t.proofs),s=t.lastCounterWithSignature):a++,r+=e}return{proofs:o,lastCounterWithSignature:s}}async restore(t,e,r){let n,{keysetId:i}=r||{},o=await this.getKeys(i);if(!this._seed)throw Error("CashuWallet must be initialized with a seed to use restore");let s=Array(e).fill(0),a=nU.createDeterministicData(0,this._seed,t,o,s),{outputs:u,signatures:f}=await this.mint.restore({outputs:a.map(t=>t.blindedMessage)}),l={};u.forEach((t,e)=>l[t.B_]=f[e]);let h=[];for(let e=0;e<a.length;e++){let r=l[a[e].blindedMessage.B_];r&&(n=t+e,a[e].blindedMessage.amount=r.amount,h.push(a[e].toProof(r,o)))}return{proofs:h,lastCounterWithSignature:n}}async createMintQuote(t,e){let r={unit:this._unit,amount:t,description:e},n=await this.mint.createMintQuote(r);return{...n,amount:n.amount||t,unit:n.unit||this.unit}}async createLockedMintQuote(t,e,r){let{supported:n}=(await this.lazyGetMintInfo()).isSupported(20);if(!n)throw Error("Mint does not support NUT-20");let i={unit:this._unit,amount:t,description:r,pubkey:e},o=await this.mint.createMintQuote(i);if("string"!=typeof o.pubkey)throw Error("Mint returned unlocked mint quote");{let e=o.pubkey;return{...o,pubkey:e,amount:o.amount||t,unit:o.unit||this.unit}}}async createMintQuoteBolt12(t,e){let r=await this.lazyGetMintInfo();if(e?.description&&!r.supportsBolt12Description)throw Error("Mint does not support description for bolt12");let n={pubkey:t,unit:this._unit,amount:e?.amount,description:e?.description};return this.mint.createMintQuoteBolt12(n)}async checkMintQuote(t){let e="string"==typeof t?t:t.quote,r=await this.mint.checkMintQuote(e);return"string"==typeof t?r:{...r,amount:r.amount||t.amount,unit:r.unit||t.unit}}async checkMintQuoteBolt12(t){return this.mint.checkMintQuoteBolt12(t)}async mintProofs(t,e,r){return this._mintProofs("bolt11",t,e,r)}async mintProofsBolt12(t,e,r,n){return this._mintProofs("bolt12",t,e,{...n,privateKey:r})}async createMeltQuote(t){let e={unit:this._unit,request:t},r=await this.mint.createMeltQuote(e);return{...r,unit:r.unit||this.unit,request:r.request||t}}async createMeltQuoteBolt12(t,e){return this.mint.createMeltQuoteBolt12({unit:this._unit,request:t,options:e?{amountless:{amount_msat:e}}:void 0})}async createMultiPathMeltQuote(t,e){let{supported:r,params:n}=(await this.lazyGetMintInfo()).isSupported(15);if(!r)throw Error("Mint does not support NUT-15");if(!n?.some(t=>"bolt11"===t.method&&t.unit===this.unit))throw Error(`Mint does not support MPP for bolt11 and ${this.unit}`);let i={unit:this._unit,request:t,options:{mpp:{amount:e}}};return{...await this.mint.createMeltQuote(i),request:t,unit:this._unit}}async checkMeltQuote(t){let e="string"==typeof t?t:t.quote,r=await this.mint.checkMeltQuote(e);return"string"==typeof t?r:{...r,request:t.request,unit:t.unit}}async checkMeltQuoteBolt12(t){return this.mint.checkMeltQuoteBolt12(t)}async meltProofs(t,e,r){return this._meltProofs("bolt11",t,e,r)}async meltProofsBolt12(t,e,r){return this._meltProofs("bolt12",t,e,r)}createSwapPayload(t,e,r,n,i,o,s,a,u){let f=e.reduce((t,e)=>t+e.amount,0);n&&n.sendAmounts&&!n.keepAmounts&&(n.keepAmounts=rK(f-t-this.getFeesForProofs(e),r.keys));let l=f-t-this.getFeesForProofs(e),h=[],c=[];if(a?.keep)if(nI(a.keep)){let t=a.keep;rK(l,r.keys).forEach(e=>{h.push(t(e,r))})}else h=a.keep;else h=this.createOutputData(l,r,i,void 0,n?.keepAmounts,void 0,this._keepFactory);if(a?.send)if(nI(a.send)){let e=a.send;rK(t,r.keys).forEach(t=>{c.push(e(t,r))})}else c=a.send;else c=this.createOutputData(t,r,i?i+h.length:void 0,o,n?.sendAmounts,u);s&&(e=rS(e,s)),e=(e=r3(e)).map(t=>{let e=t.witness&&"string"!=typeof t.witness?JSON.stringify(t.witness):t.witness;return{...t,witness:e}});let d=[...h,...c],p=d.map((t,e)=>e).sort((t,e)=>d[t].blindedMessage.amount-d[e].blindedMessage.amount),y=[...Array.from({length:h.length},()=>!0),...Array.from({length:c.length},()=>!1)],g=p.map(t=>d[t]),m=p.map(t=>y[t]);return{payload:{inputs:e,outputs:g.map(t=>t.blindedMessage)},outputData:g,keepVector:m,sortedIndices:p}}async checkProofsStates(t){let e=new TextEncoder,r=t.map(t=>ej(e.encode(t.secret)).toHex(!0)),n=[];for(let t=0;t<r.length;t+=100){let e=r.slice(t,t+100),{states:i}=await this.mint.check({Ys:e}),o={};i.forEach(t=>{o[t.Y]=t});for(let t=0;t<e.length;t++){let r=o[e[t]];if(!r)throw Error("Could not find state for proof with Y: "+e[t]);n.push(r)}}return n}async onMintQuoteUpdates(t,e,r){if(await this.mint.connectWebSocket(),!this.mint.webSocketConnection)throw Error("failed to establish WebSocket connection.");let n=this.mint.webSocketConnection.createSubscription({kind:"bolt11_mint_quote",filters:t},e,r);return()=>{this.mint.webSocketConnection?.cancelSubscription(n,e)}}async onMeltQuotePaid(t,e,r){return this.onMeltQuoteUpdates([t],t=>{t.state===nh.PAID&&e(t)},r)}async onMintQuotePaid(t,e,r){return this.onMintQuoteUpdates([t],t=>{t.state===nc.PAID&&e(t)},r)}async onMeltQuoteUpdates(t,e,r){if(await this.mint.connectWebSocket(),!this.mint.webSocketConnection)throw Error("failed to establish WebSocket connection.");let n=this.mint.webSocketConnection.createSubscription({kind:"bolt11_melt_quote",filters:t},e,r);return()=>{this.mint.webSocketConnection?.cancelSubscription(n,e)}}async onProofStateUpdates(t,e,r){if(await this.mint.connectWebSocket(),!this.mint.webSocketConnection)throw Error("failed to establish WebSocket connection.");let n=new TextEncoder,i={};for(let e=0;e<t.length;e++)i[ej(n.encode(t[e].secret)).toHex(!0)]=t[e];let o=Object.keys(i),s=this.mint.webSocketConnection.createSubscription({kind:"proof_state",filters:o},t=>{e({...t,proof:i[t.Y]})},r);return()=>{this.mint.webSocketConnection?.cancelSubscription(s,e)}}createOutputData(t,e,r,n,i,o,s){let a;if(n)a=nU.createP2PKData({pubkey:n,additionalTags:o?.additionalTags},t,e,i);else if(r||0===r){if(!this._seed)throw Error("cannot create deterministic messages without seed");a=nU.createDeterministicData(t,this._seed,r,e,i)}else a=o?nU.createP2PKData(o,t,e,i):s?rK(t,e.keys).map(t=>s(t,e)):nU.createRandomData(t,e,i);return a}createBlankOutputs(t,e,r,n){let i=Math.ceil(Math.log2(t))||1;i<0&&(i=0);let o=i?Array(i).fill(0):[];return this.createOutputData(0,e,r,void 0,o,void 0,n)}async _mintProofs(t,e,r,n){let{outputAmounts:i}=n||{},{counter:o,pubkey:s,p2pk:a,keysetId:u,proofsWeHave:f,outputData:l,privateKey:h}=n||{},c=await this.getKeys(u);!i&&f&&(i={keepAmounts:rC(f,e,c.keys,this._denominationTarget),sendAmounts:[]});let d=[];if(l)if(nI(l)){let t=rK(e,c.keys,i?.keepAmounts);for(let e=0;e<t.length;e++)d.push(l(t[e],c))}else d=l;else if(this._keepFactory){let t=rK(e,c.keys,i?.keepAmounts);for(let e=0;e<t.length;e++)d.push(this._keepFactory(t[e],c))}else d=this.createOutputData(e,c,o,s,i?.keepAmounts,a);let p=d.map(t=>t.blindedMessage),y={outputs:p,quote:"string"==typeof r?r:r.quote};if("string"!=typeof r&&r.pubkey){if(!h)throw Error("Can not sign locked quote without private key");y.signature=function(t,e,r){let n=function(t,e){let r=t;for(let t of e)r+=t.B_;return te(new TextEncoder().encode(r))}(e,r),i=w(t);return g(e_.sign(n,i))}(h,r.quote,p)}if("bolt12"===t){let{signatures:t}=await this.mint.mintBolt12(y);return d.map((e,r)=>e.toProof(t[r],c))}let{signatures:m}=await this.mint.mint(y);return d.map((t,e)=>t.toProof(m[e],c))}async _meltProofs(t,e,r,n){let{keysetId:i,counter:o,privkey:s}=n||{},a=await this.getKeys(i),u=this.createBlankOutputs(r2(r)-e.amount,a,o,this._keepFactory);null!=s&&(r=rS(r,s)),r=(r=r3(r)).map(t=>{let e=t.witness&&"string"!=typeof t.witness?JSON.stringify(t.witness):t.witness;return{...t,witness:e}});let f={quote:e.quote,inputs:r,outputs:u.map(t=>t.blindedMessage)};if("bolt12"===t){let t=await this.mint.meltBolt12(f);return{quote:{...t,unit:e.unit,request:e.request},change:t.change?.map((t,e)=>u[e].toProof(t,a))??[]}}let l=await this.mint.melt(f);return{quote:{...l,unit:e.unit,request:e.request},change:l.change?.map((t,e)=>u[e].toProof(t,a))??[]}}}class nP{constructor(t,e){this._mintUrl=t,this._customRequest=e,this._mintUrl=r1(t),this._customRequest=e}get mintUrl(){return this._mintUrl}static async mint(t,e,r,n){let i=n||nv,o={"Clear-auth":`${r}`},s=await i({endpoint:r0(t,"/v1/auth/blind/mint"),method:"POST",requestBody:e,headers:o});if(!rX(s)||!Array.isArray(s?.signatures))throw Error("bad response");return s}async mint(t,e){return nP.mint(this._mintUrl,t,e,this._customRequest)}static async getKeys(t,e,r){let n=await (r||nv)({endpoint:e?r0(t,"/v1/auth/blind/keys",e):r0(t,"/v1/auth/blind/keys")});if(!rX(n)||!Array.isArray(n.keysets))throw Error("bad response");return n}async getKeys(t,e){return await nP.getKeys(e||this._mintUrl,t,this._customRequest)}static async getKeySets(t,e){return(e||nv)({endpoint:r0(t,"/v1/auth/blind/keysets")})}async getKeySets(){return nP.getKeySets(this._mintUrl,this._customRequest)}}class nO{constructor(t,e){this._keys=new Map,this._keysets=[],this._unit="auth",this.mint=t;let r=[];e?.keys&&!Array.isArray(e.keys)?r=[e.keys]:e?.keys&&Array.isArray(e?.keys)&&(r=e?.keys),r&&r.forEach(t=>this._keys.set(t.id,t)),e?.keysets&&(this._keysets=e.keysets)}get keys(){return this._keys}get keysetId(){if(!this._keysetId)throw Error("No keysetId set");return this._keysetId}set keysetId(t){this._keysetId=t}get keysets(){return this._keysets}async loadMint(){await this.getKeySets(),await this.getKeys()}getActiveKeyset(t){let e=t.filter(t=>t.active),r=(e=e.filter(t=>t.id.startsWith("00"))).sort((t,e)=>(t.input_fee_ppk??0)-(e.input_fee_ppk??0))[0];if(!r)throw Error("No active keyset found");return r}async getKeySets(){let t=(await this.mint.getKeySets()).keysets.filter(t=>t.unit===this._unit);return this._keysets=t,this._keysets}async getAllKeys(){let t=await this.mint.getKeys();return this._keys=new Map(t.keysets.map(t=>[t.id,t])),this.keysetId=this.getActiveKeyset(this._keysets).id,t.keysets}async getKeys(t,e){if((!(this._keysets.length>0)||e)&&await this.getKeySets(),t||(t=this.getActiveKeyset(this._keysets).id),!this._keysets.find(e=>e.id===t)&&(await this.getKeySets(),!this._keysets.find(e=>e.id===t)))throw Error(`could not initialize keys. No keyset with id '${t}' found`);if(!this._keys.get(t)){let e=await this.mint.getKeys(t);this._keys.set(t,e.keysets[0])}return this.keysetId=t,this._keys.get(t)}async mintProofs(t,e,r){let n=await this.getKeys(r?.keysetId),i=nU.createRandomData(t,n),o={outputs:i.map(t=>t.blindedMessage)},{signatures:s}=await this.mint.mint(o,e),a=i.map((t,e)=>t.toProof(s[e],n));if(a.some(t=>!r7(t,n)))throw Error("Mint returned auth proofs with invalid DLEQ");return a}}function nq(t){return"authA"+rB({id:t.id,secret:t.secret,C:t.C})}async function nM(t,e,r){let n=new nP(e);return(await new nO(n).mintProofs(t,r)).map(t=>nq(t))}}];

//# sourceMappingURL=node_modules_%40cashu_cashu-ts_lib_cashu-ts_es_f24bcde9.js.map