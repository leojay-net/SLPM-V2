{"version":3,"sources":["turbopack:///[project]/src/storage/tokenVault.server.ts"],"sourcesContent":["// Server-only token vault for persisting Cashu tokens by quoteId\n// Storage backend: JSON file under .data/cashu-tokens.json\n\nimport { promises as fs } from 'fs';\nimport path from 'path';\n\nexport interface StoredTokenRecord {\n    quote: string;\n    token: string;\n    mintUrl: string;\n    amountSats: number;\n    proofsCount?: number;\n    createdAt: number; // epoch ms\n}\n\ninterface VaultFileShape {\n    version: number;\n    records: Record<string, StoredTokenRecord>; // keyed by quote\n}\n\nconst DATA_DIR = path.join(process.cwd(), '.data');\nconst VAULT_FILE = path.join(DATA_DIR, 'cashu-tokens.json');\n\nasync function ensureDir(): Promise<void> {\n    try {\n        await fs.mkdir(DATA_DIR, { recursive: true });\n    } catch (_) {\n        // ignore\n    }\n}\n\nasync function loadFile(): Promise<VaultFileShape> {\n    await ensureDir();\n    try {\n        const raw = await fs.readFile(VAULT_FILE, 'utf8');\n        const parsed = JSON.parse(raw);\n        if (parsed && typeof parsed === 'object' && parsed.records) {\n            return { version: parsed.version || 1, records: parsed.records };\n        }\n    } catch (_) { }\n    return { version: 1, records: {} };\n}\n\nasync function saveFile(data: VaultFileShape): Promise<void> {\n    const content = JSON.stringify(data, null, 2);\n    await fs.writeFile(VAULT_FILE, content, 'utf8');\n}\n\nconst TokenVault = {\n    async get(quote: string): Promise<StoredTokenRecord | null> {\n        const data = await loadFile();\n        return data.records[quote] || null;\n    },\n\n    async set(record: StoredTokenRecord): Promise<void> {\n        const data = await loadFile();\n        data.records[record.quote] = record;\n        await saveFile(data);\n    },\n\n    async has(quote: string): Promise<boolean> {\n        const rec = await this.get(quote);\n        return !!rec;\n    },\n\n    async list(limit = 100): Promise<StoredTokenRecord[]> {\n        const data = await loadFile();\n        const all = Object.values(data.records);\n        all.sort((a, b) => b.createdAt - a.createdAt);\n        return all.slice(0, limit);\n    }\n};\n\nexport default TokenVault;\n"],"names":[],"mappings":"+DAGA,IAAA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,EAAA,CAAA,CAAA,QAgBA,IAAM,EAAW,EAAA,OAAI,CAAC,IAAI,CAAC,QAAQ,GAAG,GAAI,SACpC,EAAa,EAAA,OAAI,CAAC,IAAI,CAAC,EAAU,qBAEvC,eAAe,IACX,GAAI,CACA,MAAM,EAAA,QAAE,CAAC,KAAK,CAAC,EAAU,CAAE,WAAW,CAAK,EAC/C,CAAE,MAAO,EAAG,CAEZ,CACJ,CAEA,eAAe,IACX,MAAM,IACN,GAAI,CACA,IAAM,EAAM,MAAM,EAAA,QAAE,CAAC,QAAQ,CAAC,EAAY,QACpC,EAAS,KAAK,KAAK,CAAC,GAC1B,GAAI,GAA4B,UAAlB,OAAO,GAAuB,EAAO,OAAO,CACtD,CADwD,KACjD,CAAE,QAAS,EAAO,OAAO,EAAI,EAAG,QAAS,EAAO,OAAO,AAAC,CAEvE,CAAE,MAAO,EAAG,CAAE,CACd,MAAO,CAAE,QAAS,EAAG,QAAS,CAAC,CAAE,CACrC,CAEA,eAAe,EAAS,CAAoB,EACxC,IAAM,EAAU,KAAK,SAAS,CAAC,EAAM,KAAM,EAC3C,OAAM,EAAA,QAAE,CAAC,SAAS,CAAC,EAAY,EAAS,OAC5C,OAEmB,CACT,IAAN,MAAU,GAEC,CADM,CADM,KACA,GAAA,EACP,KAsBL,EAtBY,CAAC,EAAM,EAAI,KAGlC,MAAM,IAAI,CAAyB,EAC/B,IAAM,EAAO,MAAM,IACnB,EAAK,OAAO,CAAC,EAAO,KAAK,CAAC,CAAG,EAC7B,MAAM,EAAS,EACnB,EAEA,MAAM,IAAI,CAAa,EAEnB,MAAO,CAAC,CADI,AACH,MADS,IAAI,CAAC,GAAG,CAAC,EAE/B,EAEA,MAAM,KAAK,EAAQ,GAAG,EAElB,IAAM,EAAM,OAAO,MAAM,CAAC,CADb,MAAM,GAAA,EACY,OAAO,EAEtC,OADA,EAAI,IAAI,CAAC,CAAC,EAAG,IAAM,EAAE,SAAS,CAAG,EAAE,SAAS,EACrC,EAAI,KAAK,CAAC,EAAG,EACxB,CACJ"}