module.exports=[961724,(e,t,o)=>{t.exports=e.x("next/dist/compiled/next-server/app-route-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-route-turbo.runtime.prod.js"))},918622,(e,t,o)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},556704,(e,t,o)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},832319,(e,t,o)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},120635,(e,t,o)=>{t.exports=e.x("next/dist/server/app-render/action-async-storage.external.js",()=>require("next/dist/server/app-render/action-async-storage.external.js"))},324725,(e,t,o)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},270406,(e,t,o)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},193695,(e,t,o)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},666680,(e,t,o)=>{t.exports=e.x("node:crypto",()=>require("node:crypto"))},962695,(e,t,o)=>{},363059,e=>{"use strict";e.s(["handler",()=>w,"patchFetch",()=>M,"routeModule",()=>I,"serverHooks",()=>T,"workAsyncStorage",()=>P,"workUnitAsyncStorage",()=>C],363059);var t=e.i(747909),o=e.i(174017),r=e.i(996250),n=e.i(759756),a=e.i(561916),s=e.i(869741),i=e.i(316795),l=e.i(487718),c=e.i(995169),u=e.i(47587),d=e.i(666012),p=e.i(570101),E=e.i(626937),m=e.i(10372),g=e.i(193695);e.i(52474);var f=e.i(600220);e.s(["POST",()=>x,"dynamic",()=>R],776831);var A=e.i(89171),h=e.i(662951);let R="force-dynamic";async function x(e){try{let t,o,{encodedToken:r,invoice:n}=await e.json();if(console.log("üîç [RECEIVE-AND-MELT API] Client should have calculated invoice using fee formula"),console.log("üìã [RECEIVE-AND-MELT API] Expected: invoice_amount = balance - max(2, 0.01*amount) - 1"),!r||!n)return A.NextResponse.json({error:"Missing required fields: encodedToken and invoice"},{status:400});try{o=(t=(0,h.getDecodedToken)(r)).mint;let e=t.proofs.reduce((e,t)=>e+t.amount,0);console.log("üí∞ [RECEIVE-AND-MELT API] Token details:",{mint:o,proofCount:t.proofs.length,tokenAmount:e})}catch(e){return console.error("‚ùå [RECEIVE-AND-MELT API] Failed to decode token:",e),A.NextResponse.json({error:"Invalid encoded token"},{status:400})}console.log("üè≠ [RECEIVE-AND-MELT API] Connecting to mint:",o);let a=new h.CashuMint(o),s=new h.CashuWallet(a);await s.loadMint(),console.log("üì• [RECEIVE-AND-MELT API] Receiving token (trusting client calculation)...");let i=await s.receive(r),l=i.reduce((e,t)=>e+t.amount,0);console.log("üí∞ [RECEIVE-AND-MELT API] Token received:",{proofCount:i.length,totalAmount:l}),console.log("‚è≥ [RECEIVE-AND-MELT API] Waiting for mint to fully process received proofs..."),console.log('   Checking proof states before attempting melt (preventing "proofs are pending")');let c=!1;for(let e=1;e<=6;e++){let t=Math.min(5e3*e,2e4);console.log(`üîç [RECEIVE-AND-MELT API] Proof state check ${e}/6 (waiting ${t}ms first)...`),await new Promise(e=>setTimeout(e,t));try{let t=(await s.checkProofsStates(i)).filter(e=>"UNSPENT"!==e.state).length;if(console.log(`üìä [RECEIVE-AND-MELT API] Proof states check ${e}:`,{totalProofs:i.length,unspentProofs:i.length-t,pendingProofs:t}),0===t){console.log("‚úÖ [RECEIVE-AND-MELT API] All proofs are ready (UNSPENT state)!"),c=!0;break}console.log(`‚è≥ [RECEIVE-AND-MELT API] ${t} proofs still pending...`)}catch(t){console.log(`‚ö†Ô∏è [RECEIVE-AND-MELT API] Could not check proof states (attempt ${e}):`,t instanceof Error?t.message:String(t))}}c||console.log("‚ö†Ô∏è [RECEIVE-AND-MELT API] Proofs may still be pending, but proceeding with melt attempts..."),console.log("‚ö° [RECEIVE-AND-MELT API] Creating melt quote and executing...");let u=await s.createMeltQuote(n);console.log("üìä [RECEIVE-AND-MELT API] Melt quote details:",{invoiceAmount:u.amount,feeReserve:u.fee_reserve,totalRequired:u.amount+u.fee_reserve,available:l}),console.log("‚ö° [RECEIVE-AND-MELT API] Executing melt with retry capability...");let d=null,p="";for(let e=1;e<=8;e++)try{console.log(`üîÑ [RECEIVE-AND-MELT API] Melt attempt ${e}/8...`);let t=await s.createMeltQuote(n),o=t.amount+t.fee_reserve;console.log(`üìä [RECEIVE-AND-MELT API] Melt quote details:`,{invoiceAmount:t.amount,feeReserve:t.fee_reserve,totalNeeded:o,availableProofs:l}),console.log(`üîÑ [RECEIVE-AND-MELT API] Preparing proofs for melt using wallet.send()...`);let{keep:r,send:a}=await s.send(o,i,{includeFees:!0});console.log(`üí∞ [RECEIVE-AND-MELT API] Proofs prepared:`,{sendProofs:a.length,sendAmount:a.reduce((e,t)=>e+t.amount,0),keepProofs:r.length,keepAmount:r.reduce((e,t)=>e+t.amount,0)});let c=new Promise((e,t)=>setTimeout(()=>t(Error("Melt operation timed out")),6e4));console.log("‚ö° [RECEIVE-AND-MELT API] Executing melt with prepared proofs...");let u=s.meltProofs(t,a),p=await Promise.race([u,c]);console.log("üîç [RECEIVE-AND-MELT API] Verifying melt completion (following guide pattern)..."),await new Promise(e=>setTimeout(e,2e3));let E=await s.checkMeltQuote(t.quote);if(console.log("üìä [RECEIVE-AND-MELT API] Melt quote verification:",{state:E.state,quoteId:t.quote.slice(0,10)+"...",hasPreimage:!!E.payment_preimage}),"PAID"!==E.state)throw Error(`Melt executed but quote state is: ${E.state}. Expected: PAID`);console.log("‚úÖ [RECEIVE-AND-MELT API] Melt confirmed successful by mint!"),E.payment_preimage&&console.log("üîê [RECEIVE-AND-MELT API] Payment preimage received");let m=[...p.change||[],...r];d={change:m,changeAmount:m.reduce((e,t)=>e+t.amount,0),invoiceAmount:t.amount,feeAmount:t.fee_reserve,paymentPreimage:E.payment_preimage},console.log(`‚úÖ [RECEIVE-AND-MELT API] Melt succeeded on attempt ${e}!`);break}catch(r){p=r instanceof Error?r.message:String(r),console.log(`‚ö†Ô∏è [RECEIVE-AND-MELT API] Melt attempt ${e} failed: ${p}`);let t=p.toLowerCase().includes("pending"),o=p.includes("quote state is:");if(e<8){let r;t?(r=Math.min(1e4*e,45e3),console.log(`‚è≥ [RECEIVE-AND-MELT API] üîÑ Proofs pending - very extended mint sync delay: ${r}ms...`),console.log(`   Coinos mint appears to need extra time - this is attempt ${e}/8`),console.log(`   Total wait time so far: ~${1e4*e/1e3}+ seconds`)):o?(r=3e3,console.log(`‚è≥ [RECEIVE-AND-MELT API] üìã Quote state check failed - waiting ${r}ms for mint processing...`)):(r=Math.min(2e3*e,1e4),console.log(`‚è≥ [RECEIVE-AND-MELT API] Standard retry delay: ${r}ms...`)),await new Promise(e=>setTimeout(e,r))}}if(!d)throw Error(`Melt failed after 8 attempts. Last error: ${p}`);let E=d.change?.reduce((e,t)=>e+t.amount,0)||0;return console.log("‚úÖ [RECEIVE-AND-MELT API] Melt completed successfully:",{invoiceAmount:u.amount,changeAmount:E,changeProofs:d.change?.length||0}),A.NextResponse.json({success:!0,result:{invoiceAmount:u.amount,change:d.change||[],changeAmount:E,mintUrl:o}})}catch(t){let e=t instanceof Error?t.message:String(t);if(console.error("‚ùå [RECEIVE-AND-MELT API] Error:",{message:e,errorType:t instanceof Error?t.constructor.name:typeof t}),e.includes("Token already spent")||e.includes("bad response"))return A.NextResponse.json({error:"Token already spent or invalid"},{status:400});if(e.includes("timed out"))return A.NextResponse.json({error:"Mint operation timed out"},{status:408});return A.NextResponse.json({error:`Receive and melt failed: ${e}`},{status:500})}}var v=e.i(776831);let I=new t.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/cashu/receive-and-melt/route",pathname:"/api/cashu/receive-and-melt",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/cashu/receive-and-melt/route.ts",nextConfigOutput:"",userland:v}),{workAsyncStorage:P,workUnitAsyncStorage:C,serverHooks:T}=I;function M(){return(0,r.patchFetch)({workAsyncStorage:P,workUnitAsyncStorage:C})}async function w(e,t,r){var A;let h="/api/cashu/receive-and-melt/route";h=h.replace(/\/index$/,"")||"/";let R=await I.prepare(e,t,{srcPage:h,multiZoneDraftMode:!1});if(!R)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:x,params:v,nextConfig:P,isDraftMode:C,prerenderManifest:T,routerServerContext:M,isOnDemandRevalidate:w,revalidateOnlyGenerated:N,resolvedPathname:y}=R,D=(0,s.normalizeAppPath)(h),k=!!(T.dynamicRoutes[D]||T.routes[y]);if(k&&!C){let e=!!T.routes[y],t=T.dynamicRoutes[D];if(t&&!1===t.fallback&&!e)throw new g.NoFallbackError}let L=null;!k||I.isDev||C||(L="/index"===(L=y)?"/":L);let b=!0===I.isDev||!k,V=k&&!b,q=e.method||"GET",_=(0,a.getTracer)(),j=_.getActiveScopeSpan(),S={params:v,prerenderManifest:T,renderOpts:{experimental:{cacheComponents:!!P.experimental.cacheComponents,authInterrupts:!!P.experimental.authInterrupts},supportsDynamicResponse:b,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:null==(A=P.experimental)?void 0:A.cacheLife,isRevalidate:V,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,o,r)=>I.onRequestError(e,t,r,M)},sharedContext:{buildId:x}},$=new i.NodeNextRequest(e),O=new i.NodeNextResponse(t),U=l.NextRequestAdapter.fromNodeNextRequest($,(0,l.signalFromNodeResponse)(t));try{let s=async o=>I.handle(U,S).finally(()=>{if(!o)return;o.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=_.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let e=`${q} ${n}`;o.setAttributes({"next.route":n,"http.route":n,"next.span_name":e}),o.updateName(e)}else o.updateName(`${q} ${e.url}`)}),i=async a=>{var i,l;let c=async({previousCacheEntry:o})=>{try{if(!(0,n.getRequestMeta)(e,"minimalMode")&&w&&N&&!o)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await s(a);e.fetchMetrics=S.renderOpts.fetchMetrics;let l=S.renderOpts.pendingWaitUntil;l&&r.waitUntil&&(r.waitUntil(l),l=void 0);let c=S.renderOpts.collectedTags;if(!k)return await (0,d.sendResponse)($,O,i,S.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,p.toNodeOutgoingHttpHeaders)(i.headers);c&&(t[m.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let o=void 0!==S.renderOpts.collectedRevalidate&&!(S.renderOpts.collectedRevalidate>=m.INFINITE_CACHE)&&S.renderOpts.collectedRevalidate,r=void 0===S.renderOpts.collectedExpire||S.renderOpts.collectedExpire>=m.INFINITE_CACHE?void 0:S.renderOpts.collectedExpire;return{value:{kind:f.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:o,expire:r}}}}catch(t){throw(null==o?void 0:o.isStale)&&await I.onRequestError(e,t,{routerKind:"App Router",routePath:h,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isRevalidate:V,isOnDemandRevalidate:w})},M),t}},g=await I.handleResponse({req:e,nextConfig:P,cacheKey:L,routeKind:o.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:T,isRoutePPREnabled:!1,isOnDemandRevalidate:w,revalidateOnlyGenerated:N,responseGenerator:c,waitUntil:r.waitUntil});if(!k)return null;if((null==g||null==(i=g.value)?void 0:i.kind)!==f.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==g||null==(l=g.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,n.getRequestMeta)(e,"minimalMode")||t.setHeader("x-nextjs-cache",w?"REVALIDATED":g.isMiss?"MISS":g.isStale?"STALE":"HIT"),C&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let A=(0,p.fromNodeOutgoingHttpHeaders)(g.value.headers);return(0,n.getRequestMeta)(e,"minimalMode")&&k||A.delete(m.NEXT_CACHE_TAGS_HEADER),!g.cacheControl||t.getHeader("Cache-Control")||A.get("Cache-Control")||A.set("Cache-Control",(0,E.getCacheControlHeader)(g.cacheControl)),await (0,d.sendResponse)($,O,new Response(g.value.body,{headers:A,status:g.value.status||200})),null};j?await i(j):await _.withPropagatedContext(e.headers,()=>_.trace(c.BaseServerSpan.handleRequest,{spanName:`${q} ${e.url}`,kind:a.SpanKind.SERVER,attributes:{"http.method":q,"http.target":e.url}},i))}catch(t){if(j||t instanceof g.NoFallbackError||await I.onRequestError(e,t,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isRevalidate:V,isOnDemandRevalidate:w})}),k)throw t;return await (0,d.sendResponse)($,O,new Response(null,{status:500})),null}}}];

//# sourceMappingURL=%5Broot-of-the-server%5D__8d7b6c5b._.js.map