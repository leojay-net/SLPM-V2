module.exports=[545750,a=>{"use strict";async function b(a,b,c){try{console.log("ðŸ” Server-side Cashu Melt: Starting single-API melt with retry...");let c=await fetch("/api/cashu/receive-and-melt",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({encodedToken:a,invoice:b})}),d=await c.json();if(!c.ok){if(console.error("âŒ Server-side Cashu Melt: API error:",d),"INSUFFICIENT_BALANCE"===d.error)return{success:!1,error:"Insufficient balance for invoice + fees",details:d.details};return{success:!1,error:d.error||"Server-side melt failed"}}return console.log("âœ… Server-side Cashu Melt: Completed successfully:",d.result),{success:!0,result:d.result}}catch(a){return console.error("âŒ Server-side Cashu Melt: Network error:",a),{success:!1,error:a instanceof Error?a.message:"Network error during melt"}}}async function c(b){try{console.log("ðŸ§® Calculating max invoice amount from token balance...");let{getDecodedToken:c}=await a.A(12246),d=c(b).proofs.reduce((a,b)=>a+b.amount,0),e=0;for(let a=1;a<=d;a++){let b=Math.max(2,Math.ceil(.01*a))+1;if(a+b<=d)e=a;else break}return console.log("âœ… Max invoice calculation:",{availableBalance:d,maxAmount:e,estimatedFee:Math.max(2,Math.ceil(.01*e))+1}),{success:!0,maxAmount:e,availableBalance:d}}catch(a){return console.error("âŒ Failed to calculate max invoice amount:",a),{success:!1,error:a instanceof Error?a.message:"Calculation failed"}}}async function d(b){console.log("ðŸ” Getting encoded token from storage for quote:",b);try{try{let{default:c}=await a.A(361010),d=await c.get(b);if(d?.token)return console.log("âœ… Found token in server vault"),d.token}catch(a){console.warn("âš ï¸ Could not access server vault:",a)}return console.warn("âŒ No encoded token found for quote:",b),null}catch(a){return console.error("âŒ Error retrieving encoded token:",a),null}}a.s(["calculateMaxInvoiceAmount",()=>c,"getEncodedTokenFromStorage",()=>d,"serverSideCashuMelt",()=>b])},736174,a=>{"use strict";a.s(["redeemCashuToken",()=>e,"redeemToLightning",()=>f]);var b=a.i(729521),c=a.i(545750),d=a.i(140707);async function e(e,f,g){try{let h,i;g({type:"redeem:validating",message:"Validating ecash token"});let j=await (0,c.calculateMaxInvoiceAmount)(e);if(!j.success)throw Error(j.error);let k=j.maxAmount;console.log("Safe invoice amount:",k,"sats"),g({type:"redeem:creating_swap",message:"Creating Lightning to STRK swap"});let l=(0,d.getSharedSwapAddress)(),m=l||f,n=new b.RealAtomiqSwapClient,o=await n.beginLightningToStrkSwap(k,m);console.log("Atomiq swap created:",{id:o.id,invoice:o.invoice.slice(0,50)+"..."}),g({type:"redeem:melting",message:"Melting ecash to Lightning payment"});let p=await (0,c.serverSideCashuMelt)(e,o.invoice);if(!p.success)throw Error(p.error);if(console.log("Ecash melted successfully"),g({type:"redeem:claiming",message:"Waiting for payment confirmation"}),!await n.waitLightningToStrkCompletion(o.id,3e5))throw Error("Swap timed out waiting for payment");if(await n.claimLightningToStrkSwap(o.id),console.log("Swap claimed on Starknet"),l&&l.toLowerCase()!==f.toLowerCase()){g({type:"redeem:forwarding",message:"Forwarding STRK to recipient"});let a=(await n.getStatus(o.id)).amountOut??0n;console.log("Forwarding STRK:",{from:l,to:f,amount:a.toString()}),h=await (0,d.transferStrkFromShared)(f,a)}if(p.result.change&&p.result.change.length>0){let{getEncodedTokenV4:b}=await a.A(12246);i=b({mint:p.result.mintUrl,proofs:p.result.change}),console.log("Change token available:",p.result.changeAmount,"sats")}g({type:"redeem:complete",message:"Redemption complete",txHash:h||o.id,changeToken:i})}catch(a){throw console.error("Redeem error:",a),g({type:"redeem:error",message:a instanceof Error?a.message:"Redemption failed"}),a}}async function f(b,d,e){try{let f;e({type:"redeem:validating",message:"Validating ecash token and invoice"}),console.log("ðŸ”„ Direct Lightning redemption starting"),console.log("Invoice:",d.slice(0,50)+"..."),e({type:"redeem:melting",message:"Melting ecash to Lightning payment"});let g=await (0,c.serverSideCashuMelt)(b,d);if(!g.success)throw Error(g.error);if(console.log("âœ… Lightning invoice paid successfully"),g.result.change&&g.result.change.length>0){let{getEncodedTokenV4:b}=await a.A(12246);f=b({mint:g.result.mintUrl,proofs:g.result.change}),console.log("ðŸ’° Change token available:",g.result.changeAmount,"sats")}e({type:"redeem:complete",message:"Lightning invoice paid successfully",changeToken:f})}catch(a){throw console.error("âŒ Lightning redemption error:",a),e({type:"redeem:error",message:a instanceof Error?a.message:"Payment failed"}),a}}},12246,a=>{a.v(a=>Promise.resolve().then(()=>a(43445)))},361010,a=>{a.v(b=>Promise.all(["server/chunks/ssr/src_storage_tokenVault_server_ts_563da3b1._.js"].map(b=>a.l(b))).then(()=>b(662124)))}];

//# sourceMappingURL=_62e63a2b._.js.map