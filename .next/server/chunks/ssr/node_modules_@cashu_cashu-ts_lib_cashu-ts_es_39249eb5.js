module.exports=[43445,a=>{"use strict";let b;a.s(["CashuAuthMint",()=>dG,"CashuAuthWallet",()=>dH,"CashuMint",()=>dA,"CashuWallet",()=>dF,"CheckStateEnum",()=>dk,"ConsoleLogger",()=>dh,"HttpResponseError",()=>dp,"LogLevel",()=>de,"MeltQuoteState",()=>dl,"MintOperationError",()=>dr,"MintQuoteState",()=>dm,"NetworkError",()=>dq,"OutputData",()=>dE,"PaymentRequest",()=>cK,"PaymentRequestTransportType",()=>dn,"decodePaymentRequest",()=>c3,"deriveKeysetId",()=>cZ,"getBlindedAuthToken",()=>dJ,"getDecodedToken",()=>cW,"getDecodedTokenBinary",()=>da,"getEncodedAuthToken",()=>dI,"getEncodedToken",()=>cS,"getEncodedTokenBinary",()=>c9,"getEncodedTokenV4",()=>cT,"getTokenMetadata",()=>cX,"hasValidDleq",()=>c8,"injectWebSocketImpl",()=>dd,"setGlobalRequestOptions",()=>du],43445);var c,d=a.i(666680);let e=d&&"object"==typeof d&&"webcrypto"in d?d.webcrypto:d&&"object"==typeof d&&"randomBytes"in d?d:void 0;function f(a){return a instanceof Uint8Array||ArrayBuffer.isView(a)&&"Uint8Array"===a.constructor.name}function g(a){if(!Number.isSafeInteger(a)||a<0)throw Error("positive integer expected, got "+a)}function h(a,...b){if(!f(a))throw Error("Uint8Array expected");if(b.length>0&&!b.includes(a.length))throw Error("Uint8Array expected of length "+b+", got length="+a.length)}function i(a){if("function"!=typeof a||"function"!=typeof a.create)throw Error("Hash should be wrapped by utils.createHasher");g(a.outputLen),g(a.blockLen)}function j(a,b=!0){if(a.destroyed)throw Error("Hash instance has been destroyed");if(b&&a.finished)throw Error("Hash#digest() has already been called")}function k(...a){for(let b=0;b<a.length;b++)a[b].fill(0)}function l(a){return new DataView(a.buffer,a.byteOffset,a.byteLength)}function m(a,b){return a<<32-b|a>>>b}function n(a,b){return a<<b|a>>>32-b>>>0}let o="function"==typeof Uint8Array.from([]).toHex&&"function"==typeof Uint8Array.fromHex,p=Array.from({length:256},(a,b)=>b.toString(16).padStart(2,"0"));function q(a){if(h(a),o)return a.toHex();let b="";for(let c=0;c<a.length;c++)b+=p[a[c]];return b}let r={_0:48,_9:57,A:65,F:70,a:97,f:102};function s(a){return a>=r._0&&a<=r._9?a-r._0:a>=r.A&&a<=r.F?a-(r.A-10):a>=r.a&&a<=r.f?a-(r.a-10):void 0}function t(a){if("string"!=typeof a)throw Error("hex string expected, got "+typeof a);if(o)return Uint8Array.fromHex(a);let b=a.length,c=b/2;if(b%2)throw Error("hex string expected, got unpadded hex of length "+b);let d=new Uint8Array(c);for(let b=0,e=0;b<c;b++,e+=2){let c=s(a.charCodeAt(e)),f=s(a.charCodeAt(e+1));if(void 0===c||void 0===f)throw Error('hex string expected, got non-hex character "'+(a[e]+a[e+1])+'" at index '+e);d[b]=16*c+f}return d}function u(a){if("string"!=typeof a)throw Error("string expected");return new Uint8Array(new TextEncoder().encode(a))}function v(a){return"string"==typeof a&&(a=u(a)),h(a),a}function w(...a){let b=0;for(let c=0;c<a.length;c++){let d=a[c];h(d),b+=d.length}let c=new Uint8Array(b);for(let b=0,d=0;b<a.length;b++){let e=a[b];c.set(e,d),d+=e.length}return c}class x{}function y(a){let b=b=>a().update(v(b)).digest(),c=a();return b.outputLen=c.outputLen,b.blockLen=c.blockLen,b.create=()=>a(),b}function z(a=32){if(e&&"function"==typeof e.getRandomValues)return e.getRandomValues(new Uint8Array(a));if(e&&"function"==typeof e.randomBytes)return Uint8Array.from(e.randomBytes(a));throw Error("crypto.getRandomValues must be defined")}class A extends x{constructor(a,b,c,d){super(),this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=a,this.outputLen=b,this.padOffset=c,this.isLE=d,this.buffer=new Uint8Array(a),this.view=l(this.buffer)}update(a){j(this),h(a=v(a));let{view:b,buffer:c,blockLen:d}=this,e=a.length;for(let f=0;f<e;){let g=Math.min(d-this.pos,e-f);if(g===d){let b=l(a);for(;d<=e-f;f+=d)this.process(b,f);continue}c.set(a.subarray(f,f+g),this.pos),this.pos+=g,f+=g,this.pos===d&&(this.process(b,0),this.pos=0)}return this.length+=a.length,this.roundClean(),this}digestInto(a){j(this);h(a);let b=this.outputLen;if(a.length<b)throw Error("digestInto() expects output buffer of length at least "+b);this.finished=!0;let{buffer:c,view:d,blockLen:e,isLE:f}=this,{pos:g}=this;c[g++]=128,k(this.buffer.subarray(g)),this.padOffset>e-g&&(this.process(d,0),g=0);for(let a=g;a<e;a++)c[a]=0;!function(a,b,c,d){if("function"==typeof a.setBigUint64)return a.setBigUint64(b,c,d);let e=BigInt(32),f=BigInt(0xffffffff),g=Number(c>>e&f),h=Number(c&f),i=4*!!d,j=4*!d;a.setUint32(b+i,g,d),a.setUint32(b+j,h,d)}(d,e-8,BigInt(8*this.length),f),this.process(d,0);let i=l(a),m=this.outputLen;if(m%4)throw Error("_sha2: outputLen should be aligned to 32bit");let n=m/4,o=this.get();if(n>o.length)throw Error("_sha2: outputLen bigger than state");for(let a=0;a<n;a++)i.setUint32(4*a,o[a],f)}digest(){let{buffer:a,outputLen:b}=this;this.digestInto(a);let c=a.slice(0,b);return this.destroy(),c}_cloneInto(a){a||(a=new this.constructor),a.set(...this.get());let{blockLen:b,buffer:c,length:d,finished:e,destroyed:f,pos:g}=this;return a.destroyed=f,a.finished=e,a.length=d,a.pos=g,d%b&&a.buffer.set(c),a}clone(){return this._cloneInto()}}let B=Uint32Array.from([0x6a09e667,0xbb67ae85,0x3c6ef372,0xa54ff53a,0x510e527f,0x9b05688c,0x1f83d9ab,0x5be0cd19]),C=Uint32Array.from([0xc1059ed8,0x367cd507,0x3070dd17,0xf70e5939,0xffc00b31,0x68581511,0x64f98fa7,0xbefa4fa4]),D=Uint32Array.from([0xcbbb9d5d,0xc1059ed8,0x629a292a,0x367cd507,0x9159015a,0x3070dd17,0x152fecd8,0xf70e5939,0x67332667,0xffc00b31,0x8eb44a87,0x68581511,0xdb0c2e0d,0x64f98fa7,0x47b5481d,0xbefa4fa4]),E=Uint32Array.from([0x6a09e667,0xf3bcc908,0xbb67ae85,0x84caa73b,0x3c6ef372,0xfe94f82b,0xa54ff53a,0x5f1d36f1,0x510e527f,0xade682d1,0x9b05688c,0x2b3e6c1f,0x1f83d9ab,0xfb41bd6b,0x5be0cd19,0x137e2179]),F=BigInt(0x100000000-1),G=BigInt(32),H=(a,b,c)=>a>>>c,I=(a,b,c)=>a<<32-c|b>>>c,J=(a,b,c)=>a>>>c|b<<32-c,K=(a,b,c)=>a<<32-c|b>>>c,L=(a,b,c)=>a<<64-c|b>>>c-32,M=(a,b,c)=>a>>>c-32|b<<64-c;function N(a,b,c,d){let e=(b>>>0)+(d>>>0);return{h:a+c+(e/0x100000000|0)|0,l:0|e}}let O=(a,b,c)=>(a>>>0)+(b>>>0)+(c>>>0),P=(a,b,c,d)=>b+c+d+(a/0x100000000|0)|0,Q=(a,b,c,d)=>(a>>>0)+(b>>>0)+(c>>>0)+(d>>>0),R=(a,b,c,d,e)=>b+c+d+e+(a/0x100000000|0)|0,S=(a,b,c,d,e)=>(a>>>0)+(b>>>0)+(c>>>0)+(d>>>0)+(e>>>0),T=(a,b,c,d,e,f)=>b+c+d+e+f+(a/0x100000000|0)|0,U=Uint32Array.from([0x428a2f98,0x71374491,0xb5c0fbcf,0xe9b5dba5,0x3956c25b,0x59f111f1,0x923f82a4,0xab1c5ed5,0xd807aa98,0x12835b01,0x243185be,0x550c7dc3,0x72be5d74,0x80deb1fe,0x9bdc06a7,0xc19bf174,0xe49b69c1,0xefbe4786,0xfc19dc6,0x240ca1cc,0x2de92c6f,0x4a7484aa,0x5cb0a9dc,0x76f988da,0x983e5152,0xa831c66d,0xb00327c8,0xbf597fc7,0xc6e00bf3,0xd5a79147,0x6ca6351,0x14292967,0x27b70a85,0x2e1b2138,0x4d2c6dfc,0x53380d13,0x650a7354,0x766a0abb,0x81c2c92e,0x92722c85,0xa2bfe8a1,0xa81a664b,0xc24b8b70,0xc76c51a3,0xd192e819,0xd6990624,0xf40e3585,0x106aa070,0x19a4c116,0x1e376c08,0x2748774c,0x34b0bcb5,0x391c0cb3,0x4ed8aa4a,0x5b9cca4f,0x682e6ff3,0x748f82ee,0x78a5636f,0x84c87814,0x8cc70208,0x90befffa,0xa4506ceb,0xbef9a3f7,0xc67178f2]),V=new Uint32Array(64);class W extends A{constructor(a=32){super(64,a,8,!1),this.A=0|B[0],this.B=0|B[1],this.C=0|B[2],this.D=0|B[3],this.E=0|B[4],this.F=0|B[5],this.G=0|B[6],this.H=0|B[7]}get(){let{A:a,B:b,C:c,D:d,E:e,F:f,G:g,H:h}=this;return[a,b,c,d,e,f,g,h]}set(a,b,c,d,e,f,g,h){this.A=0|a,this.B=0|b,this.C=0|c,this.D=0|d,this.E=0|e,this.F=0|f,this.G=0|g,this.H=0|h}process(a,b){for(let c=0;c<16;c++,b+=4)V[c]=a.getUint32(b,!1);for(let a=16;a<64;a++){let b=V[a-15],c=V[a-2],d=m(b,7)^m(b,18)^b>>>3,e=m(c,17)^m(c,19)^c>>>10;V[a]=e+V[a-7]+d+V[a-16]|0}let{A:c,B:d,C:e,D:f,E:g,F:h,G:i,H:j}=this;for(let a=0;a<64;a++){var k,l,n,o;let b=j+(m(g,6)^m(g,11)^m(g,25))+((k=g)&h^~k&i)+U[a]+V[a]|0,p=(m(c,2)^m(c,13)^m(c,22))+((l=c)&(n=d)^l&(o=e)^n&o)|0;j=i,i=h,h=g,g=f+b|0,f=e,e=d,d=c,c=b+p|0}c=c+this.A|0,d=d+this.B|0,e=e+this.C|0,f=f+this.D|0,g=g+this.E|0,h=h+this.F|0,i=i+this.G|0,j=j+this.H|0,this.set(c,d,e,f,g,h,i,j)}roundClean(){k(V)}destroy(){this.set(0,0,0,0,0,0,0,0),k(this.buffer)}}let X=function(a,b=!1){let c=a.length,d=new Uint32Array(c),e=new Uint32Array(c);for(let f=0;f<c;f++){let{h:c,l:g}=function(a,b=!1){return b?{h:Number(a&F),l:Number(a>>G&F)}:{h:0|Number(a>>G&F),l:0|Number(a&F)}}(a[f],b);[d[f],e[f]]=[c,g]}return[d,e]}(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(a=>BigInt(a))),Y=X[0],Z=X[1],$=new Uint32Array(80),_=new Uint32Array(80);class aa extends A{constructor(a=64){super(128,a,16,!1),this.Ah=0|E[0],this.Al=0|E[1],this.Bh=0|E[2],this.Bl=0|E[3],this.Ch=0|E[4],this.Cl=0|E[5],this.Dh=0|E[6],this.Dl=0|E[7],this.Eh=0|E[8],this.El=0|E[9],this.Fh=0|E[10],this.Fl=0|E[11],this.Gh=0|E[12],this.Gl=0|E[13],this.Hh=0|E[14],this.Hl=0|E[15]}get(){let{Ah:a,Al:b,Bh:c,Bl:d,Ch:e,Cl:f,Dh:g,Dl:h,Eh:i,El:j,Fh:k,Fl:l,Gh:m,Gl:n,Hh:o,Hl:p}=this;return[a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p]}set(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){this.Ah=0|a,this.Al=0|b,this.Bh=0|c,this.Bl=0|d,this.Ch=0|e,this.Cl=0|f,this.Dh=0|g,this.Dl=0|h,this.Eh=0|i,this.El=0|j,this.Fh=0|k,this.Fl=0|l,this.Gh=0|m,this.Gl=0|n,this.Hh=0|o,this.Hl=0|p}process(a,b){for(let c=0;c<16;c++,b+=4)$[c]=a.getUint32(b),_[c]=a.getUint32(b+=4);for(let a=16;a<80;a++){let b=0|$[a-15],c=0|_[a-15],d=J(b,c,1)^J(b,c,8)^H(b,c,7),e=K(b,c,1)^K(b,c,8)^I(b,c,7),f=0|$[a-2],g=0|_[a-2],h=J(f,g,19)^L(f,g,61)^H(f,g,6),i=Q(e,K(f,g,19)^M(f,g,61)^I(f,g,6),_[a-7],_[a-16]),j=R(i,d,h,$[a-7],$[a-16]);$[a]=0|j,_[a]=0|i}let{Ah:c,Al:d,Bh:e,Bl:f,Ch:g,Cl:h,Dh:i,Dl:j,Eh:k,El:l,Fh:m,Fl:n,Gh:o,Gl:p,Hh:q,Hl:r}=this;for(let a=0;a<80;a++){let b=J(k,l,14)^J(k,l,18)^L(k,l,41),s=K(k,l,14)^K(k,l,18)^M(k,l,41),t=k&m^~k&o,u=S(r,s,l&n^~l&p,Z[a],_[a]),v=T(u,q,b,t,Y[a],$[a]),w=0|u,x=J(c,d,28)^L(c,d,34)^L(c,d,39),y=K(c,d,28)^M(c,d,34)^M(c,d,39),z=c&e^c&g^e&g,A=d&f^d&h^f&h;q=0|o,r=0|p,o=0|m,p=0|n,m=0|k,n=0|l,({h:k,l:l}=N(0|i,0|j,0|v,0|w)),i=0|g,j=0|h,g=0|e,h=0|f,e=0|c,f=0|d;let B=O(w,y,A);c=P(B,v,x,z),d=0|B}({h:c,l:d}=N(0|this.Ah,0|this.Al,0|c,0|d)),({h:e,l:f}=N(0|this.Bh,0|this.Bl,0|e,0|f)),({h:g,l:h}=N(0|this.Ch,0|this.Cl,0|g,0|h)),({h:i,l:j}=N(0|this.Dh,0|this.Dl,0|i,0|j)),({h:k,l:l}=N(0|this.Eh,0|this.El,0|k,0|l)),({h:m,l:n}=N(0|this.Fh,0|this.Fl,0|m,0|n)),({h:o,l:p}=N(0|this.Gh,0|this.Gl,0|o,0|p)),({h:q,l:r}=N(0|this.Hh,0|this.Hl,0|q,0|r)),this.set(c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r)}roundClean(){k($,_)}destroy(){k(this.buffer),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}}let ab=y(()=>new W),ac=y(()=>new aa);class ad extends x{constructor(a,b){super(),this.finished=!1,this.destroyed=!1,i(a);let c=v(b);if(this.iHash=a.create(),"function"!=typeof this.iHash.update)throw Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;let d=this.blockLen,e=new Uint8Array(d);e.set(c.length>d?a.create().update(c).digest():c);for(let a=0;a<e.length;a++)e[a]^=54;this.iHash.update(e),this.oHash=a.create();for(let a=0;a<e.length;a++)e[a]^=106;this.oHash.update(e),k(e)}update(a){return j(this),this.iHash.update(a),this}digestInto(a){j(this),h(a,this.outputLen),this.finished=!0,this.iHash.digestInto(a),this.oHash.update(a),this.oHash.digestInto(a),this.destroy()}digest(){let a=new Uint8Array(this.oHash.outputLen);return this.digestInto(a),a}_cloneInto(a){a||(a=Object.create(Object.getPrototypeOf(this),{}));let{oHash:b,iHash:c,finished:d,destroyed:e,blockLen:f,outputLen:g}=this;return a.finished=d,a.destroyed=e,a.blockLen=f,a.outputLen=g,a.oHash=b._cloneInto(a.oHash),a.iHash=c._cloneInto(a.iHash),a}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}let ae=(a,b,c)=>new ad(a,b).update(c).digest();ae.create=(a,b)=>new ad(a,b);let af=BigInt(0),ag=BigInt(1);function ah(a,b=""){if("boolean"!=typeof a)throw Error((b&&`"${b}"`)+"expected boolean, got type="+typeof a);return a}function ai(a,b,c=""){let d=f(a),e=a?.length,g=void 0!==b;if(!d||g&&e!==b)throw Error((c&&`"${c}" `)+"expected Uint8Array"+(g?` of length ${b}`:"")+", got "+(d?`length=${e}`:`type=${typeof a}`));return a}function aj(a){let b=a.toString(16);return 1&b.length?"0"+b:b}function ak(a){if("string"!=typeof a)throw Error("hex string expected, got "+typeof a);return""===a?af:BigInt("0x"+a)}function al(a){return ak(q(a))}function am(a){return h(a),ak(q(Uint8Array.from(a).reverse()))}function an(a,b){return t(a.toString(16).padStart(2*b,"0"))}function ao(a,b){return an(a,b).reverse()}function ap(a,b,c){let d;if("string"==typeof b)try{d=t(b)}catch(b){throw Error(a+" must be hex string or Uint8Array, cause: "+b)}else if(f(b))d=Uint8Array.from(b);else throw Error(a+" must be hex string or Uint8Array");let e=d.length;if("number"==typeof c&&e!==c)throw Error(a+" of length "+c+" expected, got "+e);return d}let aq=a=>"bigint"==typeof a&&af<=a;function ar(a,b,c){return aq(a)&&aq(b)&&aq(c)&&b<=a&&a<c}function as(a){let b;for(b=0;a>af;a>>=ag,b+=1);return b}let at=a=>(ag<<BigInt(a))-ag;function au(a,b,c={}){if(!a||"object"!=typeof a)throw Error("expected valid options object");function d(b,c,d){let e=a[b];if(d&&void 0===e)return;let f=typeof e;if(f!==c||null===e)throw Error(`param "${b}" is invalid: expected ${c}, got ${f}`)}Object.entries(b).forEach(([a,b])=>d(a,b,!1)),Object.entries(c).forEach(([a,b])=>d(a,b,!0))}function av(a){let b=new WeakMap;return(c,...d)=>{let e=b.get(c);if(void 0!==e)return e;let f=a(c,...d);return b.set(c,f),f}}let aw=BigInt(0),ax=BigInt(1),ay=BigInt(2),az=BigInt(3),aA=BigInt(4),aB=BigInt(5),aC=BigInt(7),aD=BigInt(8),aE=BigInt(9),aF=BigInt(16);function aG(a,b){let c=a%b;return c>=aw?c:b+c}function aH(a,b,c){let d=a;for(;b-- >aw;)d*=d,d%=c;return d}function aI(a,b){if(a===aw)throw Error("invert: expected non-zero number");if(b<=aw)throw Error("invert: expected positive modulus, got "+b);let c=aG(a,b),d=b,e=aw,f=ax,g=ax,h=aw;for(;c!==aw;){let a=d/c,b=d%c,i=e-g*a,j=f-h*a;d=c,c=b,e=g,f=h,g=i,h=j}if(d!==ax)throw Error("invert: does not exist");return aG(e,b)}function aJ(a,b,c){if(!a.eql(a.sqr(b),c))throw Error("Cannot find square root")}function aK(a,b){let c=(a.ORDER+ax)/aA,d=a.pow(b,c);return aJ(a,d,b),d}function aL(a,b){let c=(a.ORDER-aB)/aD,d=a.mul(b,ay),e=a.pow(d,c),f=a.mul(b,e),g=a.mul(a.mul(f,ay),e),h=a.mul(f,a.sub(g,a.ONE));return aJ(a,h,b),h}function aM(a){if(a<az)throw Error("sqrt is not defined for small field");let b=a-ax,c=0;for(;b%ay===aw;)b/=ay,c++;let d=ay,e=aS(a);for(;1===aQ(e,d);)if(d++>1e3)throw Error("Cannot find square root: probably non-prime P");if(1===c)return aK;let f=e.pow(d,b),g=(b+ax)/ay;return function(a,d){if(a.is0(d))return d;if(1!==aQ(a,d))throw Error("Cannot find square root");let e=c,h=a.mul(a.ONE,f),i=a.pow(d,b),j=a.pow(d,g);for(;!a.eql(i,a.ONE);){if(a.is0(i))return a.ZERO;let b=1,c=a.sqr(i);for(;!a.eql(c,a.ONE);)if(b++,c=a.sqr(c),b===e)throw Error("Cannot find square root");let d=ax<<BigInt(e-b-1),f=a.pow(h,d);e=b,h=a.sqr(f),i=a.mul(i,h),j=a.mul(j,f)}return j}}let aN=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function aO(a){return au(a,aN.reduce((a,b)=>(a[b]="function",a),{ORDER:"bigint",MASK:"bigint",BYTES:"number",BITS:"number"})),a}function aP(a,b,c=!1){let d=Array(b.length).fill(c?a.ZERO:void 0),e=b.reduce((b,c,e)=>a.is0(c)?b:(d[e]=b,a.mul(b,c)),a.ONE),f=a.inv(e);return b.reduceRight((b,c,e)=>a.is0(c)?b:(d[e]=a.mul(b,d[e]),a.mul(b,c)),f),d}function aQ(a,b){let c=(a.ORDER-ax)/ay,d=a.pow(b,c),e=a.eql(d,a.ONE),f=a.eql(d,a.ZERO),g=a.eql(d,a.neg(a.ONE));if(!e&&!f&&!g)throw Error("invalid Legendre symbol result");return e?1:f?0:-1}function aR(a,b){void 0!==b&&g(b);let c=void 0!==b?b:a.toString(2).length,d=Math.ceil(c/8);return{nBitLength:c,nByteLength:d}}function aS(a,b,c=!1,d={}){let e,f,g,h;if(a<=aw)throw Error("invalid field: expected ORDER > 0, got "+a);let i=!1;if("object"==typeof b&&null!=b){if(d.sqrt||c)throw Error("cannot specify opts in two arguments");b.BITS&&(f=b.BITS),b.sqrt&&(g=b.sqrt),"boolean"==typeof b.isLE&&(c=b.isLE),"boolean"==typeof b.modFromBytes&&(i=b.modFromBytes),h=b.allowedLengths}else"number"==typeof b&&(f=b),d.sqrt&&(g=d.sqrt);let{nBitLength:j,nByteLength:k}=aR(a,f);if(k>2048)throw Error("invalid field: expected ORDER of <= 2048 bytes");let l=Object.freeze({ORDER:a,isLE:c,BITS:j,BYTES:k,MASK:at(j),ZERO:aw,ONE:ax,allowedLengths:h,create:b=>aG(b,a),isValid:b=>{if("bigint"!=typeof b)throw Error("invalid field element: expected bigint, got "+typeof b);return aw<=b&&b<a},is0:a=>a===aw,isValidNot0:a=>!l.is0(a)&&l.isValid(a),isOdd:a=>(a&ax)===ax,neg:b=>aG(-b,a),eql:(a,b)=>a===b,sqr:b=>aG(b*b,a),add:(b,c)=>aG(b+c,a),sub:(b,c)=>aG(b-c,a),mul:(b,c)=>aG(b*c,a),pow:(a,b)=>(function(a,b,c){if(c<aw)throw Error("invalid exponent, negatives unsupported");if(c===aw)return a.ONE;if(c===ax)return b;let d=a.ONE,e=b;for(;c>aw;)c&ax&&(d=a.mul(d,e)),e=a.sqr(e),c>>=ax;return d})(l,a,b),div:(b,c)=>aG(b*aI(c,a),a),sqrN:a=>a*a,addN:(a,b)=>a+b,subN:(a,b)=>a-b,mulN:(a,b)=>a*b,inv:b=>aI(b,a),sqrt:g||(b=>(e||(e=a%aA===az?aK:a%aD===aB?aL:a%aF===aE?function(a){let b=aS(a),c=aM(a),d=c(b,b.neg(b.ONE)),e=c(b,d),f=c(b,b.neg(d)),g=(a+aC)/aF;return(a,b)=>{let c=a.pow(b,g),h=a.mul(c,d),i=a.mul(c,e),j=a.mul(c,f),k=a.eql(a.sqr(h),b),l=a.eql(a.sqr(i),b);c=a.cmov(c,h,k),h=a.cmov(j,i,l);let m=a.eql(a.sqr(h),b),n=a.cmov(c,h,m);return aJ(a,n,b),n}}(a):aM(a)),e(l,b))),toBytes:a=>c?ao(a,k):an(a,k),fromBytes:(b,d=!0)=>{if(h){if(!h.includes(b.length)||b.length>k)throw Error("Field.fromBytes: expected "+h+" bytes, got "+b.length);let a=new Uint8Array(k);a.set(b,c?0:a.length-b.length),b=a}if(b.length!==k)throw Error("Field.fromBytes: expected "+k+" bytes, got "+b.length);let e=c?am(b):al(b);if(i&&(e=aG(e,a)),!d&&!l.isValid(e))throw Error("invalid field element: outside of range 0..ORDER");return e},invertBatch:a=>aP(l,a),cmov:(a,b,c)=>c?b:a});return Object.freeze(l)}function aT(a){if("bigint"!=typeof a)throw Error("field order must be bigint");return Math.ceil(a.toString(2).length/8)}function aU(a){let b=aT(a);return b+Math.ceil(b/2)}function aV(a,b,c=!1){let d=a.length,e=aT(b),f=aU(b);if(d<16||d<f||d>1024)throw Error("expected "+f+"-1024 bytes of input, got "+d);let g=aG(c?am(a):al(a),b-ax)+ax;return c?ao(g,e):an(g,e)}let aW=BigInt(0),aX=BigInt(1);function aY(a,b){let c=b.negate();return a?c:b}function aZ(a,b){let c=aP(a.Fp,b.map(a=>a.Z));return b.map((b,d)=>a.fromAffine(b.toAffine(c[d])))}function a$(a,b){if(!Number.isSafeInteger(a)||a<=0||a>b)throw Error("invalid window size, expected [1.."+b+"], got W="+a)}function a_(a,b){a$(a,b);let c=Math.ceil(b/a)+1,d=2**(a-1),e=2**a;return{windows:c,windowSize:d,mask:at(a),maxNumber:e,shiftBy:BigInt(a)}}function a0(a,b,c){let{windowSize:d,mask:e,maxNumber:f,shiftBy:g}=c,h=Number(a&e),i=a>>g;h>d&&(h-=f,i+=aX);let j=b*d,k=j+Math.abs(h)-1,l=0===h;return{nextN:i,offset:k,isZero:l,isNeg:h<0,isNegF:b%2!=0,offsetF:j}}let a1=new WeakMap,a2=new WeakMap;function a3(a){return a2.get(a)||1}function a4(a){if(a!==aW)throw Error("invalid wNAF")}class a5{constructor(a,b){this.BASE=a.BASE,this.ZERO=a.ZERO,this.Fn=a.Fn,this.bits=b}_unsafeLadder(a,b,c=this.ZERO){let d=a;for(;b>aW;)b&aX&&(c=c.add(d)),d=d.double(),b>>=aX;return c}precomputeWindow(a,b){let{windows:c,windowSize:d}=a_(b,this.bits),e=[],f=a,g=f;for(let a=0;a<c;a++){g=f,e.push(g);for(let a=1;a<d;a++)g=g.add(f),e.push(g);f=g.double()}return e}wNAF(a,b,c){if(!this.Fn.isValid(c))throw Error("invalid scalar");let d=this.ZERO,e=this.BASE,f=a_(a,this.bits);for(let a=0;a<f.windows;a++){let{nextN:g,offset:h,isZero:i,isNeg:j,isNegF:k,offsetF:l}=a0(c,a,f);c=g,i?e=e.add(aY(k,b[l])):d=d.add(aY(j,b[h]))}return a4(c),{p:d,f:e}}wNAFUnsafe(a,b,c,d=this.ZERO){let e=a_(a,this.bits);for(let a=0;a<e.windows&&c!==aW;a++){let{nextN:f,offset:g,isZero:h,isNeg:i}=a0(c,a,e);if(c=f,!h){let a=b[g];d=d.add(i?a.negate():a)}}return a4(c),d}getPrecomputes(a,b,c){let d=a1.get(b);return d||(d=this.precomputeWindow(b,a),1!==a&&("function"==typeof c&&(d=c(d)),a1.set(b,d))),d}cached(a,b,c){let d=a3(a);return this.wNAF(d,this.getPrecomputes(d,a,c),b)}unsafe(a,b,c,d){let e=a3(a);return 1===e?this._unsafeLadder(a,b,d):this.wNAFUnsafe(e,this.getPrecomputes(e,a,c),b,d)}createCache(a,b){a$(b,this.bits),a2.set(a,b),a1.delete(a)}hasCache(a){return 1!==a3(a)}}function a6(a,b,c){if(!b)return aS(a,{isLE:c});if(b.ORDER!==a)throw Error("Field.ORDER must match order: Fp == p, Fn == n");return aO(b),b}let a7=(a,b)=>(a+(a>=0?b:-b)/bd)/b;function a8(a){if(!["compact","recovered","der"].includes(a))throw Error('Signature format must be "compact", "recovered", or "der"');return a}function a9(a,b){let c={};for(let d of Object.keys(b))c[d]=void 0===a[d]?b[d]:a[d];return ah(c.lowS,"lowS"),ah(c.prehash,"prehash"),void 0!==c.format&&a8(c.format),c}let ba={Err:class extends Error{constructor(a=""){super(a)}},_tlv:{encode:(a,b)=>{let{Err:c}=ba;if(a<0||a>256)throw new c("tlv.encode: wrong tag");if(1&b.length)throw new c("tlv.encode: unpadded data");let d=b.length/2,e=aj(d);if(e.length/2&128)throw new c("tlv.encode: long form length too big");let f=d>127?aj(e.length/2|128):"";return aj(a)+f+e+b},decode(a,b){let{Err:c}=ba,d=0;if(a<0||a>256)throw new c("tlv.encode: wrong tag");if(b.length<2||b[d++]!==a)throw new c("tlv.decode: wrong tlv");let e=b[d++],f=0;if(128&e){let a=127&e;if(!a)throw new c("tlv.decode(long): indefinite length not supported");if(a>4)throw new c("tlv.decode(long): byte length is too big");let g=b.subarray(d,d+a);if(g.length!==a)throw new c("tlv.decode: length bytes not complete");if(0===g[0])throw new c("tlv.decode(long): zero leftmost byte");for(let a of g)f=f<<8|a;if(d+=a,f<128)throw new c("tlv.decode(long): not minimal encoding")}else f=e;let g=b.subarray(d,d+f);if(g.length!==f)throw new c("tlv.decode: wrong value length");return{v:g,l:b.subarray(d+f)}}},_int:{encode(a){let{Err:b}=ba;if(a<bb)throw new b("integer: negative integers are not allowed");let c=aj(a);if(8&Number.parseInt(c[0],16)&&(c="00"+c),1&c.length)throw new b("unexpected DER parsing assertion: unpadded hex");return c},decode(a){let{Err:b}=ba;if(128&a[0])throw new b("invalid signature integer: negative");if(0===a[0]&&!(128&a[1]))throw new b("invalid signature integer: unnecessary leading zero");return al(a)}},toSig(a){let{Err:b,_int:c,_tlv:d}=ba,e=ap("signature",a),{v:f,l:g}=d.decode(48,e);if(g.length)throw new b("invalid signature: left bytes after parsing");let{v:h,l:i}=d.decode(2,f),{v:j,l:k}=d.decode(2,i);if(k.length)throw new b("invalid signature: left bytes after parsing");return{r:c.decode(h),s:c.decode(j)}},hexFromSig(a){let{_tlv:b,_int:c}=ba,d=b.encode(2,c.encode(a.r)),e=b.encode(2,c.encode(a.s));return b.encode(48,d+e)}},bb=BigInt(0),bc=BigInt(1),bd=BigInt(2),be=BigInt(3),bf=BigInt(4);function bg(a,b){let c,{BYTES:d}=a;if("bigint"==typeof b)c=b;else{let e=ap("private key",b);try{c=a.fromBytes(e)}catch(a){throw Error(`invalid private key: expected ui8a of size ${d}, got ${typeof b}`)}}if(!a.isValidNot0(c))throw Error("invalid private key: out of range [1..N-1]");return c}function bh(a){return Uint8Array.of(a?2:3)}function bi(a,b){return{secretKey:b.BYTES,publicKey:1+a.BYTES,publicKeyUncompressed:1+2*a.BYTES,publicKeyHasPrefix:!0,signature:2*b.BYTES}}u("HashToScalar-");let bj={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),n:BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),h:BigInt(1),a:BigInt(0),b:BigInt(7),Gx:BigInt("0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798"),Gy:BigInt("0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8")},bk={beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),basises:[[BigInt("0x3086d221a7d46bcde86c90e49284eb15"),-BigInt("0xe4437ed6010e88286f547fa90abfe4c3")],[BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),BigInt("0x3086d221a7d46bcde86c90e49284eb15")]]},bl=BigInt(0),bm=BigInt(1),bn=BigInt(2),bo=aS(bj.p,{sqrt:function(a){let b=bj.p,c=BigInt(3),d=BigInt(6),e=BigInt(11),f=BigInt(22),g=BigInt(23),h=BigInt(44),i=BigInt(88),j=a*a*a%b,k=j*j*a%b,l=aH(k,c,b)*k%b,m=aH(l,c,b)*k%b,n=aH(m,bn,b)*j%b,o=aH(n,e,b)*n%b,p=aH(o,f,b)*o%b,q=aH(p,h,b)*p%b,r=aH(q,i,b)*q%b,s=aH(r,h,b)*p%b,t=aH(s,c,b)*k%b,u=aH(t,g,b)*o%b,v=aH(u,d,b)*j%b,w=aH(v,bn,b);if(!bo.eql(bo.sqr(w),a))throw Error("Cannot find square root");return w}}),bp=function(a,b){let c=b=>(function(a){let{CURVE:b,curveOpts:c,hash:d,ecdsaOpts:e}=function(a){let{CURVE:b,curveOpts:c}=function(a){let b={a:a.a,b:a.b,p:a.Fp.ORDER,n:a.n,h:a.h,Gx:a.Gx,Gy:a.Gy},c=a.Fp,d=a.allowedPrivateKeyLengths?Array.from(new Set(a.allowedPrivateKeyLengths.map(a=>Math.ceil(a/2)))):void 0,e={Fp:c,Fn:aS(b.n,{BITS:a.nBitLength,allowedLengths:d,modFromBytes:a.wrapPrivateKey}),allowInfinityPoint:a.allowInfinityPoint,endo:a.endo,isTorsionFree:a.isTorsionFree,clearCofactor:a.clearCofactor,fromBytes:a.fromBytes,toBytes:a.toBytes};return{CURVE:b,curveOpts:e}}(a),d={hmac:a.hmac,randomBytes:a.randomBytes,lowS:a.lowS,bits2int:a.bits2int,bits2int_modN:a.bits2int_modN};return{CURVE:b,curveOpts:c,hash:a.hash,ecdsaOpts:d}}(a),g=function(a,b,c={}){i(b),au(c,{},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"});let d=c.randomBytes||z,e=c.hmac||((a,...c)=>ae(b,a,w(...c))),{Fp:g,Fn:h}=a,{ORDER:j,BITS:k}=h,{keygen:l,getPublicKey:m,getSharedSecret:n,utils:o,lengths:p}=function(a,b={}){let{Fn:c}=a,d=b.randomBytes||z,e=Object.assign(bi(a.Fp,c),{seed:aU(c.ORDER)});function f(a){try{return!!bg(c,a)}catch(a){return!1}}function g(a=d(e.seed)){return aV(ai(a,e.seed,"seed"),c.ORDER)}function h(b,d=!0){return a.BASE.multiply(bg(c,b)).toBytes(d)}function i(b){if("bigint"==typeof b)return!1;if(b instanceof a)return!0;let{secretKey:d,publicKey:f,publicKeyUncompressed:g}=e;if(c.allowedLengths||d===f)return;let h=ap("key",b).length;return h===f||h===g}return Object.freeze({getPublicKey:h,getSharedSecret:function(b,d,e=!0){if(!0===i(b))throw Error("first arg must be private key");if(!1===i(d))throw Error("second arg must be public key");let f=bg(c,b);return a.fromHex(d).multiply(f).toBytes(e)},keygen:function(a){let b=g(a);return{secretKey:b,publicKey:h(b)}},Point:a,utils:{isValidSecretKey:f,isValidPublicKey:function(b,c){let{publicKey:d,publicKeyUncompressed:f}=e;try{let e=b.length;if(!0===c&&e!==d||!1===c&&e!==f)return!1;return!!a.fromBytes(b)}catch(a){return!1}},randomSecretKey:g,isValidPrivateKey:f,randomPrivateKey:g,normPrivateKeyToScalar:a=>bg(c,a),precompute:(b=8,c=a.BASE)=>c.precompute(b,!1)},lengths:e})}(a,c),r={prehash:!1,lowS:"boolean"==typeof c.lowS&&c.lowS,format:void 0,extraEntropy:!1},s="compact";function u(a,b){if(!h.isValidNot0(b))throw Error(`invalid signature ${a}: out of range 1..Point.Fn.ORDER`);return b}class v{constructor(a,b,c){this.r=u("r",a),this.s=u("s",b),null!=c&&(this.recovery=c),Object.freeze(this)}static fromBytes(a,b=s){let c;if(!function(a,b){a8(b);let c=p.signature;ai(a,"compact"===b?c:"recovered"===b?c+1:void 0,`${b} signature`)}(a,b),"der"===b){let{r:b,s:c}=ba.toSig(ai(a));return new v(b,c)}"recovered"===b&&(c=a[0],b="compact",a=a.subarray(1));let d=h.BYTES,e=a.subarray(0,d),f=a.subarray(d,2*d);return new v(h.fromBytes(e),h.fromBytes(f),c)}static fromHex(a,b){return this.fromBytes(t(a),b)}addRecoveryBit(a){return new v(this.r,this.s,a)}recoverPublicKey(b){let c=g.ORDER,{r:d,s:e,recovery:f}=this;if(null==f||![0,1,2,3].includes(f))throw Error("recovery id invalid");if(j*bd<c&&f>1)throw Error("recovery id is ambiguous for h>1 curve");let i=2===f||3===f?d+j:d;if(!g.isValid(i))throw Error("recovery id 2 or 3 invalid");let k=g.toBytes(i),l=a.fromBytes(w(bh((1&f)==0),k)),m=h.inv(i),n=y(ap("msgHash",b)),o=h.create(-n*m),p=h.create(e*m),q=a.BASE.multiplyUnsafe(o).add(l.multiplyUnsafe(p));if(q.is0())throw Error("point at infinify");return q.assertValidity(),q}hasHighS(){return this.s>j>>bc}toBytes(a=s){if(a8(a),"der"===a)return t(ba.hexFromSig(this));let b=h.toBytes(this.r),c=h.toBytes(this.s);if("recovered"===a){if(null==this.recovery)throw Error("recovery bit must be present");return w(Uint8Array.of(this.recovery),b,c)}return w(b,c)}toHex(a){return q(this.toBytes(a))}assertValidity(){}static fromCompact(a){return v.fromBytes(ap("sig",a),"compact")}static fromDER(a){return v.fromBytes(ap("sig",a),"der")}normalizeS(){return this.hasHighS()?new v(this.r,h.neg(this.s),this.recovery):this}toDERRawBytes(){return this.toBytes("der")}toDERHex(){return q(this.toBytes("der"))}toCompactRawBytes(){return this.toBytes("compact")}toCompactHex(){return q(this.toBytes("compact"))}}let x=c.bits2int||function(a){if(a.length>8192)throw Error("input is too large");let b=al(a),c=8*a.length-k;return c>0?b>>BigInt(c):b},y=c.bits2int_modN||function(a){return h.create(x(a))},A=at(k);function B(a){var b="num < 2^"+k;if(!ar(a,bb,A))throw Error("expected valid "+b+": "+bb+" <= n < "+A+", got "+a);return h.toBytes(a)}function C(a,c){return ai(a,void 0,"message"),c?ai(b(a),void 0,"prehashed message"):a}return Object.freeze({keygen:l,getPublicKey:m,getSharedSecret:n,utils:o,lengths:p,Point:a,sign:function(c,f,g={}){let{seed:i,k2sig:k}=function(b,c,e){if(["recovered","canonical"].some(a=>a in e))throw Error("sign() legacy options not supported");let{lowS:f,prehash:g,extraEntropy:i}=a9(e,r),k=y(b=C(b,g)),l=bg(h,c),m=[B(l),B(k)];if(null!=i&&!1!==i){let a=!0===i?d(p.secretKey):i;m.push(ap("extraEntropy",a))}return{seed:w(...m),k2sig:function(b){let c=x(b);if(!h.isValidNot0(c))return;let d=h.inv(c),e=a.BASE.multiply(c).toAffine(),g=h.create(e.x);if(g===bb)return;let i=h.create(d*h.create(k+g*l));if(i===bb)return;let m=2*(e.x!==g)|Number(e.y&bc),n=i;return f&&i>j>>bc&&(n=h.neg(i),m^=1),new v(g,n,m)}}}(c=ap("message",c),f,g);return(function(a,b,c){if("number"!=typeof a||a<2)throw Error("hashLen must be a number");if("number"!=typeof b||b<2)throw Error("qByteLen must be a number");if("function"!=typeof c)throw Error("hmacFn must be a function");let d=a=>new Uint8Array(a),e=a=>Uint8Array.of(a),f=d(a),g=d(a),h=0,i=()=>{f.fill(1),g.fill(0),h=0},j=(...a)=>c(g,f,...a),k=(a=d(0))=>{g=j(e(0),a),f=j(),0!==a.length&&(g=j(e(1),a),f=j())},l=()=>{if(h++>=1e3)throw Error("drbg: tried 1000 values");let a=0,c=[];for(;a<b;){let b=(f=j()).slice();c.push(b),a+=f.length}return w(...c)};return(a,b)=>{let c;for(i(),k(a);!(c=b(l()));)k();return i(),c}})(b.outputLen,h.BYTES,e)(i,k)},verify:function(b,c,d,e={}){let{lowS:g,prehash:i,format:j}=a9(e,r);if(d=ap("publicKey",d),c=C(ap("message",c),i),"strict"in e)throw Error("options.strict was renamed to lowS");let k=void 0===j?function(a){let b,c="string"==typeof a||f(a),d=!c&&null!==a&&"object"==typeof a&&"bigint"==typeof a.r&&"bigint"==typeof a.s;if(!c&&!d)throw Error("invalid signature, expected Uint8Array, hex string or Signature instance");if(d)b=new v(a.r,a.s);else if(c){try{b=v.fromBytes(ap("sig",a),"der")}catch(a){if(!(a instanceof ba.Err))throw a}if(!b)try{b=v.fromBytes(ap("sig",a),"compact")}catch(a){return!1}}return!!b&&b}(b):v.fromBytes(ap("sig",b),j);if(!1===k)return!1;try{let b=a.fromBytes(d);if(g&&k.hasHighS())return!1;let{r:e,s:f}=k,i=y(c),j=h.inv(f),l=h.create(i*j),m=h.create(e*j),n=a.BASE.multiplyUnsafe(l).add(b.multiplyUnsafe(m));if(n.is0())return!1;return h.create(n.x)===e}catch(a){return!1}},recoverPublicKey:function(a,b,c={}){let{prehash:d}=a9(c,r);return b=C(b,d),v.fromBytes(a,"recovered").recoverPublicKey(b).toBytes()},Signature:v,hash:b})}(function(a,b={}){let c=function(a,b,c={},d){if(void 0===d&&(d="edwards"===a),!b||"object"!=typeof b)throw Error(`expected valid ${a} CURVE object`);for(let a of["p","n","h"]){let c=b[a];if(!("bigint"==typeof c&&c>aW))throw Error(`CURVE.${a} must be positive bigint`)}let e=a6(b.p,c.Fp,d),f=a6(b.n,c.Fn,d);for(let c of["Gx","Gy","a","weierstrass"===a?"b":"d"])if(!e.isValid(b[c]))throw Error(`CURVE.${c} must be valid field element of CURVE.Fp`);return{CURVE:b=Object.freeze(Object.assign({},b)),Fp:e,Fn:f}}("weierstrass",a,b),{Fp:d,Fn:e}=c,f=c.CURVE,{h:g,n:h}=f;au(b,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object",wrapPrivateKey:"boolean"});let{endo:i}=b;if(i&&(!d.is0(f.a)||"bigint"!=typeof i.beta||!Array.isArray(i.basises)))throw Error('invalid endo: expected "beta": bigint and "basises": array');let j=bi(d,e);function k(){if(!d.isOdd)throw Error("compression is not supported: Field does not have .isOdd()")}let l=b.toBytes||function(a,b,c){let{x:e,y:f}=b.toAffine(),g=d.toBytes(e);return(ah(c,"isCompressed"),c)?(k(),w(bh(!d.isOdd(f)),g)):w(Uint8Array.of(4),g,d.toBytes(f))},m=b.fromBytes||function(a){ai(a,void 0,"Point");let{publicKey:b,publicKeyUncompressed:c}=j,e=a.length,f=a[0],g=a.subarray(1);if(e===b&&(2===f||3===f)){let a,b=d.fromBytes(g);if(!d.isValid(b))throw Error("bad point: is not on curve, wrong x");let c=n(b);try{a=d.sqrt(c)}catch(a){throw Error("bad point: is not on curve, sqrt error"+(a instanceof Error?": "+a.message:""))}return k(),(1&f)==1!==d.isOdd(a)&&(a=d.neg(a)),{x:b,y:a}}if(e===c&&4===f){let a=d.BYTES,b=d.fromBytes(g.subarray(0,a)),c=d.fromBytes(g.subarray(a,2*a));if(!o(b,c))throw Error("bad point: is not on curve");return{x:b,y:c}}throw Error(`bad point: got length ${e}, expected compressed=${b} or uncompressed=${c}`)};function n(a){let b=d.sqr(a),c=d.mul(b,a);return d.add(d.add(c,d.mul(a,f.a)),f.b)}function o(a,b){let c=d.sqr(b),e=n(a);return d.eql(c,e)}if(!o(f.Gx,f.Gy))throw Error("bad curve params: generator point");let p=d.mul(d.pow(f.a,be),bf),r=d.mul(d.sqr(f.b),BigInt(27));if(d.is0(d.add(p,r)))throw Error("bad curve params: a or b");function s(a,b,c=!1){if(!d.isValid(b)||c&&d.is0(b))throw Error(`bad point coordinate ${a}`);return b}function t(a){if(!(a instanceof z))throw Error("ProjectivePoint expected")}function u(a){if(!i||!i.basises)throw Error("no endo");return function(a,b,c){let[[d,e],[f,g]]=b,h=a7(g*a,c),i=a7(-e*a,c),j=a-h*d-i*f,k=-h*e-i*g,l=j<bb,m=k<bb;l&&(j=-j),m&&(k=-k);let n=at(Math.ceil(as(c)/2))+bc;if(j<bb||j>=n||k<bb||k>=n)throw Error("splitScalar (endomorphism): failed, k="+a);return{k1neg:l,k1:j,k2neg:m,k2:k}}(a,i.basises,e.ORDER)}let v=av((a,b)=>{let{X:c,Y:e,Z:f}=a;if(d.eql(f,d.ONE))return{x:c,y:e};let g=a.is0();null==b&&(b=g?d.ONE:d.inv(f));let h=d.mul(c,b),i=d.mul(e,b),j=d.mul(f,b);if(g)return{x:d.ZERO,y:d.ZERO};if(!d.eql(j,d.ONE))throw Error("invZ was invalid");return{x:h,y:i}}),x=av(a=>{if(a.is0()){if(b.allowInfinityPoint&&!d.is0(a.Y))return;throw Error("bad point: ZERO")}let{x:c,y:e}=a.toAffine();if(!d.isValid(c)||!d.isValid(e))throw Error("bad point: x or y not field elements");if(!o(c,e))throw Error("bad point: equation left != right");if(!a.isTorsionFree())throw Error("bad point: not in prime-order subgroup");return!0});function y(a,b,c,e,f){return c=new z(d.mul(c.X,a),c.Y,c.Z),b=aY(e,b),c=aY(f,c),b.add(c)}class z{constructor(a,b,c){this.X=s("x",a),this.Y=s("y",b,!0),this.Z=s("z",c),Object.freeze(this)}static CURVE(){return f}static fromAffine(a){let{x:b,y:c}=a||{};if(!a||!d.isValid(b)||!d.isValid(c))throw Error("invalid affine point");if(a instanceof z)throw Error("projective point not allowed");return d.is0(b)&&d.is0(c)?z.ZERO:new z(b,c,d.ONE)}static fromBytes(a){let b=z.fromAffine(m(ai(a,void 0,"point")));return b.assertValidity(),b}static fromHex(a){return z.fromBytes(ap("pointHex",a))}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(a=8,b=!0){return B.createCache(this,a),b||this.multiply(be),this}assertValidity(){x(this)}hasEvenY(){let{y:a}=this.toAffine();if(!d.isOdd)throw Error("Field doesn't support isOdd");return!d.isOdd(a)}equals(a){t(a);let{X:b,Y:c,Z:e}=this,{X:f,Y:g,Z:h}=a,i=d.eql(d.mul(b,h),d.mul(f,e)),j=d.eql(d.mul(c,h),d.mul(g,e));return i&&j}negate(){return new z(this.X,d.neg(this.Y),this.Z)}double(){let{a,b}=f,c=d.mul(b,be),{X:e,Y:g,Z:h}=this,i=d.ZERO,j=d.ZERO,k=d.ZERO,l=d.mul(e,e),m=d.mul(g,g),n=d.mul(h,h),o=d.mul(e,g);return o=d.add(o,o),k=d.mul(e,h),k=d.add(k,k),i=d.mul(a,k),j=d.mul(c,n),j=d.add(i,j),i=d.sub(m,j),j=d.add(m,j),j=d.mul(i,j),i=d.mul(o,i),k=d.mul(c,k),n=d.mul(a,n),o=d.sub(l,n),o=d.mul(a,o),o=d.add(o,k),k=d.add(l,l),l=d.add(k,l),l=d.add(l,n),l=d.mul(l,o),j=d.add(j,l),n=d.mul(g,h),n=d.add(n,n),l=d.mul(n,o),i=d.sub(i,l),k=d.mul(n,m),k=d.add(k,k),new z(i,j,k=d.add(k,k))}add(a){t(a);let{X:b,Y:c,Z:e}=this,{X:g,Y:h,Z:i}=a,j=d.ZERO,k=d.ZERO,l=d.ZERO,m=f.a,n=d.mul(f.b,be),o=d.mul(b,g),p=d.mul(c,h),q=d.mul(e,i),r=d.add(b,c),s=d.add(g,h);r=d.mul(r,s),s=d.add(o,p),r=d.sub(r,s),s=d.add(b,e);let u=d.add(g,i);return s=d.mul(s,u),u=d.add(o,q),s=d.sub(s,u),u=d.add(c,e),j=d.add(h,i),u=d.mul(u,j),j=d.add(p,q),u=d.sub(u,j),l=d.mul(m,s),j=d.mul(n,q),l=d.add(j,l),j=d.sub(p,l),l=d.add(p,l),k=d.mul(j,l),p=d.add(o,o),p=d.add(p,o),q=d.mul(m,q),s=d.mul(n,s),p=d.add(p,q),q=d.sub(o,q),q=d.mul(m,q),s=d.add(s,q),o=d.mul(p,s),k=d.add(k,o),o=d.mul(u,s),j=d.mul(r,j),j=d.sub(j,o),o=d.mul(r,p),l=d.mul(u,l),new z(j,k,l=d.add(l,o))}subtract(a){return this.add(a.negate())}is0(){return this.equals(z.ZERO)}multiply(a){let c,d,{endo:f}=b;if(!e.isValidNot0(a))throw Error("invalid scalar: out of range");let g=a=>B.cached(this,a,a=>aZ(z,a));if(f){let{k1neg:b,k1:e,k2neg:h,k2:i}=u(a),{p:j,f:k}=g(e),{p:l,f:m}=g(i);d=k.add(m),c=y(f.beta,j,l,b,h)}else{let{p:b,f:e}=g(a);c=b,d=e}return aZ(z,[c,d])[0]}multiplyUnsafe(a){let{endo:c}=b;if(!e.isValid(a))throw Error("invalid scalar: out of range");if(a===bb||this.is0())return z.ZERO;if(a===bc)return this;if(B.hasCache(this))return this.multiply(a);if(!c)return B.unsafe(this,a);{let{k1neg:b,k1:d,k2neg:e,k2:f}=u(a),{p1:g,p2:h}=function(a,b,c,d){let e=b,f=a.ZERO,g=a.ZERO;for(;c>aW||d>aW;)c&aX&&(f=f.add(e)),d&aX&&(g=g.add(e)),e=e.double(),c>>=aX,d>>=aX;return{p1:f,p2:g}}(z,this,d,f);return y(c.beta,g,h,b,e)}}multiplyAndAddUnsafe(a,b,c){let d=this.multiplyUnsafe(b).add(a.multiplyUnsafe(c));return d.is0()?void 0:d}toAffine(a){return v(this,a)}isTorsionFree(){let{isTorsionFree:a}=b;return g===bc||(a?a(z,this):B.unsafe(this,h).is0())}clearCofactor(){let{clearCofactor:a}=b;return g===bc?this:a?a(z,this):this.multiplyUnsafe(g)}isSmallOrder(){return this.multiplyUnsafe(g).is0()}toBytes(a=!0){return ah(a,"isCompressed"),this.assertValidity(),l(z,this,a)}toHex(a=!0){return q(this.toBytes(a))}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}get px(){return this.X}get py(){return this.X}get pz(){return this.Z}toRawBytes(a=!0){return this.toBytes(a)}_setWindowSize(a){this.precompute(a)}static normalizeZ(a){return aZ(z,a)}static msm(a,b){return function(a,b,c,d){if(!Array.isArray(c))throw Error("array expected");c.forEach((b,c)=>{if(!(b instanceof a))throw Error("invalid point at index "+c)});if(!Array.isArray(d))throw Error("array of scalars expected");d.forEach((a,c)=>{if(!b.isValid(a))throw Error("invalid scalar at index "+c)});let e=c.length,f=d.length;if(e!==f)throw Error("arrays of points and scalars must have equal length");let g=a.ZERO,h=as(BigInt(e)),i=1;h>12?i=h-3:h>4?i=h-2:h>0&&(i=2);let j=at(i),k=Array(Number(j)+1).fill(g),l=Math.floor((b.BITS-1)/i)*i,m=g;for(let a=l;a>=0;a-=i){k.fill(g);for(let b=0;b<f;b++){let e=Number(d[b]>>BigInt(a)&j);k[e]=k[e].add(c[b])}let b=g;for(let a=k.length-1,c=g;a>0;a--)c=c.add(k[a]),b=b.add(c);if(m=m.add(b),0!==a)for(let a=0;a<i;a++)m=m.double()}return m}(z,e,a,b)}static fromPrivateKey(a){return z.BASE.multiply(bg(e,a))}}z.BASE=new z(f.Gx,f.Gy,d.ONE),z.ZERO=new z(d.ZERO,d.ONE,d.ZERO),z.Fp=d,z.Fn=e;let A=e.BITS,B=new a5(z,b.endo?Math.ceil(A/2):A);return z.BASE.precompute(8),z}(b,c),d,e),h=g.Point;return Object.assign({},g,{ProjectivePoint:h,CURVE:Object.assign({},a,aR(h.Fn.ORDER,h.Fn.BITS))})})({...a,hash:b});return{...c(b),create:c}}({...bj,Fp:bo,lowS:!0,endo:bk},ab),bq={};function br(a,...b){let c=bq[a];if(void 0===c){let b=ab(u(a));c=w(b,b),bq[a]=c}return ab(w(c,...b))}let bs=a=>a.toBytes(!0).slice(1),bt=bp.Point;function bu(a){let{Fn:b,BASE:c}=bt,d=bg(b,a),e=c.multiply(d);return{scalar:e.y%bn===bl?d:b.neg(d),bytes:bs(e)}}function bv(a){if(!bo.isValidNot0(a))throw Error("invalid x: Fail if x â‰¥ p");let b=bo.create(a*a),c=bo.create(b*a+BigInt(7)),d=bo.sqrt(c);d%bn!==bl&&(d=bo.neg(d));let e=bt.fromAffine({x:a,y:d});return e.assertValidity(),e}function bw(...a){return bt.Fn.create(al(br("BIP0340/challenge",...a)))}function bx(a){return bu(a).bytes}function by(a,b,c=z(32)){let{Fn:d}=bt,e=ap("message",a),{bytes:f,scalar:g}=bu(b),h=ap("auxRand",c,32),i=d.toBytes(g^al(br("BIP0340/aux",h))),{bytes:j,scalar:k}=bu(br("BIP0340/nonce",i,f,e)),l=bw(j,f,e),m=new Uint8Array(64);if(m.set(j,0),m.set(d.toBytes(d.create(k+l*g)),32),!bz(m,e,f))throw Error("sign: Invalid signature produced");return m}function bz(a,b,c){let{Fn:d,BASE:e}=bt,f=ap("signature",a,64),g=ap("message",b),h=ap("publicKey",c,32);try{let a=bv(al(h)),b=al(f.subarray(0,32));if(!ar(b,bm,bj.p))return!1;let c=al(f.subarray(32,64));if(!ar(c,bm,bj.n))return!1;let i=bw(d.toBytes(b),bs(a),g),j=e.multiplyUnsafe(c).add(a.multiplyUnsafe(d.neg(i))),{x:k,y:l}=j.toAffine();if(j.is0()||l%bn!==bl||k!==b)return!1;return!0}catch(a){return!1}}let bA=(()=>{let a=48,b=(b=z(a))=>aV(b,bj.n);return bp.utils.randomSecretKey,{keygen:function(a){let c=b(a);return{secretKey:c,publicKey:bx(c)}},getPublicKey:bx,sign:by,verify:bz,Point:bt,utils:{randomSecretKey:b,randomPrivateKey:b,taggedHash:br,lift_x:bv,pointToBytes:bs,numberToBytesBE:an,bytesToNumberBE:al,mod:aG},lengths:{secretKey:32,publicKey:32,publicKeyHasPrefix:!1,signature:64,seed:a}}})(),bB=function(a,b){let c=b.map(a=>Array.from(a).reverse());return(b,d)=>{let[e,f,g,h]=c.map(c=>c.reduce((c,d)=>a.add(a.mul(c,b),d))),[i,j]=aP(a,[f,h],!0);return b=a.mul(e,i),d=a.mul(d,a.mul(g,j)),{x:b,y:d}}}(bo,[["0x8e38e38e38e38e38e38e38e38e38e38e38e38e38e38e38e38e38e38daaaaa8c7","0x7d3d4c80bc321d5b9f315cea7fd44c5d595d2fc0bf63b92dfff1044f17c6581","0x534c328d23f234e6e2a413deca25caece4506144037c40314ecbd0b53d9dd262","0x8e38e38e38e38e38e38e38e38e38e38e38e38e38e38e38e38e38e38daaaaa88c"],["0xd35771193d94918a9ca34ccbb7b640dd86cd409542f8487d9fe6b745781eb49b","0xedadc6f64383dc1df7c4b2d51b54225406d36b641f5e41bbc52a56612a8c6d14","0x0000000000000000000000000000000000000000000000000000000000000001"],["0x4bda12f684bda12f684bda12f684bda12f684bda12f684bda12f684b8e38e23c","0xc75e0c32d5cb7c0fa9d0a54b12a0a6d5647ab046d686da6fdffc90fc201d71a3","0x29a6194691f91a73715209ef6512e576722830a201be2018a765e85a9ecee931","0x2f684bda12f684bda12f684bda12f684bda12f684bda12f684bda12f38e38d84"],["0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffff93b","0x7a06534bb8bdb49fd5e9e6632722c2989467c1bfc8e8d978dfb425d2685c2573","0x6484aa716545ca2cf3a70c3fa8fe337e0a3d21162f0d6299a7bf8192bfd2a76f","0x0000000000000000000000000000000000000000000000000000000000000001"]].map(a=>a.map(a=>BigInt(a)))),bC=function(a,b){aO(a);let{A:c,B:d,Z:e}=b;if(!a.isValid(c)||!a.isValid(d)||!a.isValid(e))throw Error("mapToCurveSimpleSWU: invalid opts");let f=function(a,b){let c=a.ORDER,d=bb;for(let a=c-bc;a%bd===bb;a/=bd)d+=bc;let e=d,f=bd<<e-bc-bc,g=f*bd,h=(c-bc)/g,i=(h-bc)/bd,j=g-bc,k=a.pow(b,h),l=a.pow(b,(h+bc)/bd),m=(b,c)=>{let d=k,g=a.pow(c,j),h=a.sqr(g);h=a.mul(h,c);let m=a.mul(b,h);m=a.pow(m,i),m=a.mul(m,g),g=a.mul(m,c),h=a.mul(m,b);let n=a.mul(h,g);m=a.pow(n,f);let o=a.eql(m,a.ONE);g=a.mul(h,l),m=a.mul(n,d),h=a.cmov(g,h,o),n=a.cmov(m,n,o);for(let b=e;b>bc;b--){let c=b-bd;c=bd<<c-bc;let e=a.pow(n,c),f=a.eql(e,a.ONE);g=a.mul(h,d),d=a.mul(d,d),e=a.mul(n,d),h=a.cmov(g,h,f),n=a.cmov(e,n,f)}return{isValid:o,value:h}};if(a.ORDER%bf===be){let c=(a.ORDER-be)/bf,d=a.sqrt(a.neg(b));m=(b,e)=>{let f=a.sqr(e),g=a.mul(b,e);f=a.mul(f,g);let h=a.pow(f,c);h=a.mul(h,g);let i=a.mul(h,d),j=a.mul(a.sqr(h),e),k=a.eql(j,b),l=a.cmov(i,h,k);return{isValid:k,value:l}}}return m}(a,e);if(!a.isOdd)throw Error("Field does not have .isOdd()");return b=>{let g,h,i,j,k,l,m,n;g=a.sqr(b),g=a.mul(g,e),h=a.sqr(g),h=a.add(h,g),i=a.add(h,a.ONE),i=a.mul(i,d),j=a.cmov(e,a.neg(h),!a.eql(h,a.ZERO)),j=a.mul(j,c),h=a.sqr(i),l=a.sqr(j),k=a.mul(l,c),h=a.add(h,k),h=a.mul(h,i),l=a.mul(l,j),k=a.mul(l,d),h=a.add(h,k),m=a.mul(g,i);let{isValid:o,value:p}=f(h,l);n=a.mul(g,b),n=a.mul(n,p),m=a.cmov(m,i,o),n=a.cmov(n,p,o);let q=a.isOdd(b)===a.isOdd(n);n=a.cmov(a.neg(n),n,q);let r=aP(a,[j],!0)[0];return{x:m=a.mul(m,r),y:n}}}(bo,{A:BigInt("0x3f8731abdd661adca08a5558f0f5d272e953d363cb6f0e5d405447c01a444533"),B:BigInt("1771"),Z:bo.create(BigInt("-11"))});!function(a,b,c){if("function"!=typeof b)throw Error("mapToCurve() must be defined")}(bp.Point,a=>{let{x:b,y:c}=bC(bo.create(a[0]));return bB(b,c)},bo.ORDER);var bD={},bE={};bE.byteLength=function(a){var b=bL(a),c=b[0],d=b[1];return(c+d)*3/4-d},bE.toByteArray=function(a){var b,c,d=bL(a),e=d[0],f=d[1],g=new bH((e+f)*3/4-f),h=0,i=f>0?e-4:e;for(c=0;c<i;c+=4)b=bG[a.charCodeAt(c)]<<18|bG[a.charCodeAt(c+1)]<<12|bG[a.charCodeAt(c+2)]<<6|bG[a.charCodeAt(c+3)],g[h++]=b>>16&255,g[h++]=b>>8&255,g[h++]=255&b;return 2===f&&(b=bG[a.charCodeAt(c)]<<2|bG[a.charCodeAt(c+1)]>>4,g[h++]=255&b),1===f&&(b=bG[a.charCodeAt(c)]<<10|bG[a.charCodeAt(c+1)]<<4|bG[a.charCodeAt(c+2)]>>2,g[h++]=b>>8&255,g[h++]=255&b),g},bE.fromByteArray=function(a){for(var b,c=a.length,d=c%3,e=[],f=0,g=c-d;f<g;f+=16383)e.push(function(a,b,c){for(var d,e=[],f=b;f<c;f+=3)e.push(bF[(d=(a[f]<<16&0xff0000)+(a[f+1]<<8&65280)+(255&a[f+2]))>>18&63]+bF[d>>12&63]+bF[d>>6&63]+bF[63&d]);return e.join("")}(a,f,f+16383>g?g:f+16383));return 1===d?e.push(bF[(b=a[c-1])>>2]+bF[b<<4&63]+"=="):2===d&&e.push(bF[(b=(a[c-2]<<8)+a[c-1])>>10]+bF[b>>4&63]+bF[b<<2&63]+"="),e.join("")};for(var bF=[],bG=[],bH="u">typeof Uint8Array?Uint8Array:Array,bI="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bJ=0,bK=bI.length;bJ<bK;++bJ)bF[bJ]=bI[bJ],bG[bI.charCodeAt(bJ)]=bJ;function bL(a){var b=a.length;if(b%4>0)throw Error("Invalid string. Length must be a multiple of 4");var c=a.indexOf("=");-1===c&&(c=b);var d=c===b?0:4-c%4;return[c,d]}bG[45]=62,bG[95]=63;var bM={};bM.read=function(a,b,c,d,e){var f,g,h=8*e-d-1,i=(1<<h)-1,j=i>>1,k=-7,l=c?e-1:0,m=c?-1:1,n=a[b+l];for(l+=m,f=n&(1<<-k)-1,n>>=-k,k+=h;k>0;f=256*f+a[b+l],l+=m,k-=8);for(g=f&(1<<-k)-1,f>>=-k,k+=d;k>0;g=256*g+a[b+l],l+=m,k-=8);if(0===f)f=1-j;else{if(f===i)return g?NaN:1/0*(n?-1:1);g+=Math.pow(2,d),f-=j}return(n?-1:1)*g*Math.pow(2,f-d)},bM.write=function(a,b,c,d,e,f){var g,h,i,j=8*f-e-1,k=(1<<j)-1,l=k>>1,m=5960464477539062e-23*(23===e),n=d?0:f-1,o=d?1:-1,p=+(b<0||0===b&&1/b<0);for(isNaN(b=Math.abs(b))||b===1/0?(h=+!!isNaN(b),g=k):(g=Math.floor(Math.log(b)/Math.LN2),b*(i=Math.pow(2,-g))<1&&(g--,i*=2),g+l>=1?b+=m/i:b+=m*Math.pow(2,1-l),b*i>=2&&(g++,i/=2),g+l>=k?(h=0,g=k):g+l>=1?(h=(b*i-1)*Math.pow(2,e),g+=l):(h=b*Math.pow(2,l-1)*Math.pow(2,e),g=0));e>=8;a[c+n]=255&h,n+=o,h/=256,e-=8);for(g=g<<e|h,j+=e;j>0;a[c+n]=255&g,n+=o,g/=256,j-=8);a[c+n-o]|=128*p},function(a){let b="function"==typeof Symbol&&"function"==typeof Symbol.for?Symbol.for("nodejs.util.inspect.custom"):null;a.Buffer=g,a.SlowBuffer=function(a){return+a!=a&&(a=0),g.alloc(+a)},a.INSPECT_MAX_BYTES=50,a.kMaxLength=0x7fffffff;let{Uint8Array:c,ArrayBuffer:d,SharedArrayBuffer:e}=globalThis;function f(a){if(a>0x7fffffff)throw RangeError('The value "'+a+'" is invalid for option "size"');let b=new c(a);return Object.setPrototypeOf(b,g.prototype),b}function g(a,b,c){if("number"==typeof a){if("string"==typeof b)throw TypeError('The "string" argument must be of type string. Received type number');return j(a)}return h(a,b,c)}function h(a,b,h){if("string"==typeof a){var i=a,j=b;if(("string"!=typeof j||""===j)&&(j="utf8"),!g.isEncoding(j))throw TypeError("Unknown encoding: "+j);let c=0|n(i,j),d=f(c),e=d.write(i,j);return e!==c&&(d=d.slice(0,e)),d}if(d.isView(a)){var o=a;if(K(o,c)){let a=new c(o);return l(a.buffer,a.byteOffset,a.byteLength)}return k(o)}if(null==a)throw TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof a);if(K(a,d)||a&&K(a.buffer,d)||"u">typeof e&&(K(a,e)||a&&K(a.buffer,e)))return l(a,b,h);if("number"==typeof a)throw TypeError('The "value" argument must not be of type number. Received type number');let p=a.valueOf&&a.valueOf();if(null!=p&&p!==a)return g.from(p,b,h);let q=function(a){if(g.isBuffer(a)){let b=0|m(a.length),c=f(b);return 0===c.length||a.copy(c,0,0,b),c}return void 0!==a.length?"number"!=typeof a.length||function(a){return a!=a}(a.length)?f(0):k(a):"Buffer"===a.type&&Array.isArray(a.data)?k(a.data):void 0}(a);if(q)return q;if("u">typeof Symbol&&null!=Symbol.toPrimitive&&"function"==typeof a[Symbol.toPrimitive])return g.from(a[Symbol.toPrimitive]("string"),b,h);throw TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof a)}function i(a){if("number"!=typeof a)throw TypeError('"size" argument must be of type number');if(a<0)throw RangeError('The value "'+a+'" is invalid for option "size"')}function j(a){return i(a),f(a<0?0:0|m(a))}function k(a){let b=a.length<0?0:0|m(a.length),c=f(b);for(let d=0;d<b;d+=1)c[d]=255&a[d];return c}function l(a,b,d){let e;if(b<0||a.byteLength<b)throw RangeError('"offset" is outside of buffer bounds');if(a.byteLength<b+(d||0))throw RangeError('"length" is outside of buffer bounds');return Object.setPrototypeOf(e=void 0===b&&void 0===d?new c(a):void 0===d?new c(a,b):new c(a,b,d),g.prototype),e}function m(a){if(a>=0x7fffffff)throw RangeError("Attempt to allocate Buffer larger than maximum size: 0x7fffffff bytes");return 0|a}function n(a,b){if(g.isBuffer(a))return a.length;if(d.isView(a)||K(a,d))return a.byteLength;if("string"!=typeof a)throw TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof a);let c=a.length,e=arguments.length>2&&!0===arguments[2];if(!e&&0===c)return 0;let f=!1;for(;;)switch(b){case"ascii":case"latin1":case"binary":return c;case"utf8":case"utf-8":return H(a).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*c;case"hex":return c>>>1;case"base64":return I(a).length;default:if(f)return e?-1:H(a).length;b=(""+b).toLowerCase(),f=!0}}function o(a,b,c){let d=!1;if((void 0===b||b<0)&&(b=0),b>this.length||((void 0===c||c>this.length)&&(c=this.length),c<=0)||(c>>>=0)<=(b>>>=0))return"";for(a||(a="utf8");;)switch(a){case"hex":return function(a,b,c){let d=a.length;(!b||b<0)&&(b=0),(!c||c<0||c>d)&&(c=d);let e="";for(let d=b;d<c;++d)e+=L[a[d]];return e}(this,b,c);case"utf8":case"utf-8":return s(this,b,c);case"ascii":return function(a,b,c){let d="";c=Math.min(a.length,c);for(let e=b;e<c;++e)d+=String.fromCharCode(127&a[e]);return d}(this,b,c);case"latin1":case"binary":return function(a,b,c){let d="";c=Math.min(a.length,c);for(let e=b;e<c;++e)d+=String.fromCharCode(a[e]);return d}(this,b,c);case"base64":var e,f,g;return e=this,f=b,g=c,0===f&&g===e.length?bE.fromByteArray(e):bE.fromByteArray(e.slice(f,g));case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return function(a,b,c){let d=a.slice(b,c),e="";for(let a=0;a<d.length-1;a+=2)e+=String.fromCharCode(d[a]+256*d[a+1]);return e}(this,b,c);default:if(d)throw TypeError("Unknown encoding: "+a);a=(a+"").toLowerCase(),d=!0}}function p(a,b,c){let d=a[b];a[b]=a[c],a[c]=d}function q(a,b,d,e,f){var h;if(0===a.length)return -1;if("string"==typeof d?(e=d,d=0):d>0x7fffffff?d=0x7fffffff:d<-0x80000000&&(d=-0x80000000),(h=d*=1)!=h&&(d=f?0:a.length-1),d<0&&(d=a.length+d),d>=a.length){if(f)return -1;d=a.length-1}else if(d<0)if(!f)return -1;else d=0;if("string"==typeof b&&(b=g.from(b,e)),g.isBuffer(b))return 0===b.length?-1:r(a,b,d,e,f);if("number"==typeof b)return b&=255,"function"==typeof c.prototype.indexOf?f?c.prototype.indexOf.call(a,b,d):c.prototype.lastIndexOf.call(a,b,d):r(a,[b],d,e,f);throw TypeError("val must be string, number or Buffer")}function r(a,b,c,d,e){let f,g=1,h=a.length,i=b.length;if(void 0!==d&&("ucs2"===(d=String(d).toLowerCase())||"ucs-2"===d||"utf16le"===d||"utf-16le"===d)){if(a.length<2||b.length<2)return -1;g=2,h/=2,i/=2,c/=2}function j(a,b){return 1===g?a[b]:a.readUInt16BE(b*g)}if(e){let d=-1;for(f=c;f<h;f++)if(j(a,f)===j(b,-1===d?0:f-d)){if(-1===d&&(d=f),f-d+1===i)return d*g}else -1!==d&&(f-=f-d),d=-1}else for(c+i>h&&(c=h-i),f=c;f>=0;f--){let c=!0;for(let d=0;d<i;d++)if(j(a,f+d)!==j(b,d)){c=!1;break}if(c)return f}return -1}function s(a,b,c){c=Math.min(a.length,c);let d=[],e=b;for(;e<c;){let b=a[e],f=null,g=b>239?4:b>223?3:b>191?2:1;if(e+g<=c){let c,d,h,i;switch(g){case 1:b<128&&(f=b);break;case 2:(192&(c=a[e+1]))==128&&(i=(31&b)<<6|63&c)>127&&(f=i);break;case 3:c=a[e+1],d=a[e+2],(192&c)==128&&(192&d)==128&&(i=(15&b)<<12|(63&c)<<6|63&d)>2047&&(i<55296||i>57343)&&(f=i);break;case 4:c=a[e+1],d=a[e+2],h=a[e+3],(192&c)==128&&(192&d)==128&&(192&h)==128&&(i=(15&b)<<18|(63&c)<<12|(63&d)<<6|63&h)>65535&&i<1114112&&(f=i)}}null===f?(f=65533,g=1):f>65535&&(f-=65536,d.push(f>>>10&1023|55296),f=56320|1023&f),d.push(f),e+=g}var f=d;let g=f.length;if(g<=4096)return String.fromCharCode.apply(String,f);let h="",i=0;for(;i<g;)h+=String.fromCharCode.apply(String,f.slice(i,i+=4096));return h}function t(a,b,c){if(a%1!=0||a<0)throw RangeError("offset is not uint");if(a+b>c)throw RangeError("Trying to access beyond buffer length")}function u(a,b,c,d,e,f){if(!g.isBuffer(a))throw TypeError('"buffer" argument must be a Buffer instance');if(b>e||b<f)throw RangeError('"value" argument is out of bounds');if(c+d>a.length)throw RangeError("Index out of range")}function v(a,b,c,d,e){D(b,d,e,a,c,7);let f=Number(b&BigInt(0xffffffff));a[c++]=f,f>>=8,a[c++]=f,f>>=8,a[c++]=f,f>>=8,a[c++]=f;let g=Number(b>>BigInt(32)&BigInt(0xffffffff));return a[c++]=g,g>>=8,a[c++]=g,g>>=8,a[c++]=g,g>>=8,a[c++]=g,c}function w(a,b,c,d,e){D(b,d,e,a,c,7);let f=Number(b&BigInt(0xffffffff));a[c+7]=f,f>>=8,a[c+6]=f,f>>=8,a[c+5]=f,f>>=8,a[c+4]=f;let g=Number(b>>BigInt(32)&BigInt(0xffffffff));return a[c+3]=g,g>>=8,a[c+2]=g,g>>=8,a[c+1]=g,g>>=8,a[c]=g,c+8}function x(a,b,c,d,e,f){if(c+d>a.length||c<0)throw RangeError("Index out of range")}function y(a,b,c,d,e){return b*=1,c>>>=0,e||x(a,b,c,4),bM.write(a,b,c,d,23,4),c+4}function z(a,b,c,d,e){return b*=1,c>>>=0,e||x(a,b,c,8),bM.write(a,b,c,d,52,8),c+8}g.TYPED_ARRAY_SUPPORT=function(){try{let a=new c(1),b={foo:function(){return 42}};return Object.setPrototypeOf(b,c.prototype),Object.setPrototypeOf(a,b),42===a.foo()}catch{return!1}}(),!g.TYPED_ARRAY_SUPPORT&&"u">typeof console&&"function"==typeof console.error&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support."),Object.defineProperty(g.prototype,"parent",{enumerable:!0,get:function(){if(g.isBuffer(this))return this.buffer}}),Object.defineProperty(g.prototype,"offset",{enumerable:!0,get:function(){if(g.isBuffer(this))return this.byteOffset}}),g.poolSize=8192,g.from=function(a,b,c){return h(a,b,c)},Object.setPrototypeOf(g.prototype,c.prototype),Object.setPrototypeOf(g,c),g.alloc=function(a,b,c){return i(a),a<=0?f(a):void 0!==b?"string"==typeof c?f(a).fill(b,c):f(a).fill(b):f(a)},g.allocUnsafe=function(a){return j(a)},g.allocUnsafeSlow=function(a){return j(a)},g.isBuffer=function(a){return null!=a&&!0===a._isBuffer&&a!==g.prototype},g.compare=function(a,b){if(K(a,c)&&(a=g.from(a,a.offset,a.byteLength)),K(b,c)&&(b=g.from(b,b.offset,b.byteLength)),!g.isBuffer(a)||!g.isBuffer(b))throw TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(a===b)return 0;let d=a.length,e=b.length;for(let c=0,f=Math.min(d,e);c<f;++c)if(a[c]!==b[c]){d=a[c],e=b[c];break}return d<e?-1:+(e<d)},g.isEncoding=function(a){switch(String(a).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},g.concat=function(a,b){let d;if(!Array.isArray(a))throw TypeError('"list" argument must be an Array of Buffers');if(0===a.length)return g.alloc(0);if(void 0===b)for(b=0,d=0;d<a.length;++d)b+=a[d].length;let e=g.allocUnsafe(b),f=0;for(d=0;d<a.length;++d){let b=a[d];if(K(b,c))f+b.length>e.length?(g.isBuffer(b)||(b=g.from(b)),b.copy(e,f)):c.prototype.set.call(e,b,f);else if(g.isBuffer(b))b.copy(e,f);else throw TypeError('"list" argument must be an Array of Buffers');f+=b.length}return e},g.byteLength=n,g.prototype._isBuffer=!0,g.prototype.swap16=function(){let a=this.length;if(a%2!=0)throw RangeError("Buffer size must be a multiple of 16-bits");for(let b=0;b<a;b+=2)p(this,b,b+1);return this},g.prototype.swap32=function(){let a=this.length;if(a%4!=0)throw RangeError("Buffer size must be a multiple of 32-bits");for(let b=0;b<a;b+=4)p(this,b,b+3),p(this,b+1,b+2);return this},g.prototype.swap64=function(){let a=this.length;if(a%8!=0)throw RangeError("Buffer size must be a multiple of 64-bits");for(let b=0;b<a;b+=8)p(this,b,b+7),p(this,b+1,b+6),p(this,b+2,b+5),p(this,b+3,b+4);return this},g.prototype.toString=function(){let a=this.length;return 0===a?"":0==arguments.length?s(this,0,a):o.apply(this,arguments)},g.prototype.toLocaleString=g.prototype.toString,g.prototype.equals=function(a){if(!g.isBuffer(a))throw TypeError("Argument must be a Buffer");return this===a||0===g.compare(this,a)},g.prototype.inspect=function(){let b="",c=a.INSPECT_MAX_BYTES;return b=this.toString("hex",0,c).replace(/(.{2})/g,"$1 ").trim(),this.length>c&&(b+=" ... "),"<Buffer "+b+">"},b&&(g.prototype[b]=g.prototype.inspect),g.prototype.compare=function(a,b,d,e,f){if(K(a,c)&&(a=g.from(a,a.offset,a.byteLength)),!g.isBuffer(a))throw TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof a);if(void 0===b&&(b=0),void 0===d&&(d=a?a.length:0),void 0===e&&(e=0),void 0===f&&(f=this.length),b<0||d>a.length||e<0||f>this.length)throw RangeError("out of range index");if(e>=f&&b>=d)return 0;if(e>=f)return -1;if(b>=d)return 1;if(b>>>=0,d>>>=0,e>>>=0,f>>>=0,this===a)return 0;let h=f-e,i=d-b,j=Math.min(h,i),k=this.slice(e,f),l=a.slice(b,d);for(let a=0;a<j;++a)if(k[a]!==l[a]){h=k[a],i=l[a];break}return h<i?-1:+(i<h)},g.prototype.includes=function(a,b,c){return -1!==this.indexOf(a,b,c)},g.prototype.indexOf=function(a,b,c){return q(this,a,b,c,!0)},g.prototype.lastIndexOf=function(a,b,c){return q(this,a,b,c,!1)},g.prototype.write=function(a,b,c,d){var e,f,g,h,i,j,k,l;if(void 0===b)d="utf8",c=this.length,b=0;else if(void 0===c&&"string"==typeof b)d=b,c=this.length,b=0;else if(isFinite(b))b>>>=0,isFinite(c)?(c>>>=0,void 0===d&&(d="utf8")):(d=c,c=void 0);else throw Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");let m=this.length-b;if((void 0===c||c>m)&&(c=m),a.length>0&&(c<0||b<0)||b>this.length)throw RangeError("Attempt to write outside buffer bounds");d||(d="utf8");let n=!1;for(;;)switch(d){case"hex":return function(a,b,c,d){let e;c=Number(c)||0;let f=a.length-c;d?(d=Number(d))>f&&(d=f):d=f;let g=b.length;for(d>g/2&&(d=g/2),e=0;e<d;++e){var h;let d=parseInt(b.substr(2*e,2),16);if((h=d)!=h)break;a[c+e]=d}return e}(this,a,b,c);case"utf8":case"utf-8":return e=b,f=c,J(H(a,this.length-e),this,e,f);case"ascii":case"latin1":case"binary":return g=b,h=c,J(function(a){let b=[];for(let c=0;c<a.length;++c)b.push(255&a.charCodeAt(c));return b}(a),this,g,h);case"base64":return i=b,j=c,J(I(a),this,i,j);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return k=b,l=c,J(function(a,b){let c,d,e=[];for(let f=0;f<a.length&&!((b-=2)<0);++f)d=(c=a.charCodeAt(f))>>8,e.push(c%256),e.push(d);return e}(a,this.length-k),this,k,l);default:if(n)throw TypeError("Unknown encoding: "+d);d=(""+d).toLowerCase(),n=!0}},g.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}},g.prototype.slice=function(a,b){let c=this.length;a=~~a,b=void 0===b?c:~~b,a<0?(a+=c)<0&&(a=0):a>c&&(a=c),b<0?(b+=c)<0&&(b=0):b>c&&(b=c),b<a&&(b=a);let d=this.subarray(a,b);return Object.setPrototypeOf(d,g.prototype),d},g.prototype.readUintLE=g.prototype.readUIntLE=function(a,b,c){a>>>=0,b>>>=0,c||t(a,b,this.length);let d=this[a],e=1,f=0;for(;++f<b&&(e*=256);)d+=this[a+f]*e;return d},g.prototype.readUintBE=g.prototype.readUIntBE=function(a,b,c){a>>>=0,b>>>=0,c||t(a,b,this.length);let d=this[a+--b],e=1;for(;b>0&&(e*=256);)d+=this[a+--b]*e;return d},g.prototype.readUint8=g.prototype.readUInt8=function(a,b){return a>>>=0,b||t(a,1,this.length),this[a]},g.prototype.readUint16LE=g.prototype.readUInt16LE=function(a,b){return a>>>=0,b||t(a,2,this.length),this[a]|this[a+1]<<8},g.prototype.readUint16BE=g.prototype.readUInt16BE=function(a,b){return a>>>=0,b||t(a,2,this.length),this[a]<<8|this[a+1]},g.prototype.readUint32LE=g.prototype.readUInt32LE=function(a,b){return a>>>=0,b||t(a,4,this.length),(this[a]|this[a+1]<<8|this[a+2]<<16)+0x1000000*this[a+3]},g.prototype.readUint32BE=g.prototype.readUInt32BE=function(a,b){return a>>>=0,b||t(a,4,this.length),0x1000000*this[a]+(this[a+1]<<16|this[a+2]<<8|this[a+3])},g.prototype.readBigUInt64LE=M(function(a){E(a>>>=0,"offset");let b=this[a],c=this[a+7];(void 0===b||void 0===c)&&F(a,this.length-8);let d=b+256*this[++a]+65536*this[++a]+0x1000000*this[++a],e=this[++a]+256*this[++a]+65536*this[++a]+0x1000000*c;return BigInt(d)+(BigInt(e)<<BigInt(32))}),g.prototype.readBigUInt64BE=M(function(a){E(a>>>=0,"offset");let b=this[a],c=this[a+7];(void 0===b||void 0===c)&&F(a,this.length-8);let d=0x1000000*b+65536*this[++a]+256*this[++a]+this[++a],e=0x1000000*this[++a]+65536*this[++a]+256*this[++a]+c;return(BigInt(d)<<BigInt(32))+BigInt(e)}),g.prototype.readIntLE=function(a,b,c){a>>>=0,b>>>=0,c||t(a,b,this.length);let d=this[a],e=1,f=0;for(;++f<b&&(e*=256);)d+=this[a+f]*e;return d>=(e*=128)&&(d-=Math.pow(2,8*b)),d},g.prototype.readIntBE=function(a,b,c){a>>>=0,b>>>=0,c||t(a,b,this.length);let d=b,e=1,f=this[a+--d];for(;d>0&&(e*=256);)f+=this[a+--d]*e;return f>=(e*=128)&&(f-=Math.pow(2,8*b)),f},g.prototype.readInt8=function(a,b){return a>>>=0,b||t(a,1,this.length),128&this[a]?-((255-this[a]+1)*1):this[a]},g.prototype.readInt16LE=function(a,b){a>>>=0,b||t(a,2,this.length);let c=this[a]|this[a+1]<<8;return 32768&c?0xffff0000|c:c},g.prototype.readInt16BE=function(a,b){a>>>=0,b||t(a,2,this.length);let c=this[a+1]|this[a]<<8;return 32768&c?0xffff0000|c:c},g.prototype.readInt32LE=function(a,b){return a>>>=0,b||t(a,4,this.length),this[a]|this[a+1]<<8|this[a+2]<<16|this[a+3]<<24},g.prototype.readInt32BE=function(a,b){return a>>>=0,b||t(a,4,this.length),this[a]<<24|this[a+1]<<16|this[a+2]<<8|this[a+3]},g.prototype.readBigInt64LE=M(function(a){E(a>>>=0,"offset");let b=this[a],c=this[a+7];return(void 0===b||void 0===c)&&F(a,this.length-8),(BigInt(this[a+4]+256*this[a+5]+65536*this[a+6]+(c<<24))<<BigInt(32))+BigInt(b+256*this[++a]+65536*this[++a]+0x1000000*this[++a])}),g.prototype.readBigInt64BE=M(function(a){E(a>>>=0,"offset");let b=this[a],c=this[a+7];return(void 0===b||void 0===c)&&F(a,this.length-8),(BigInt((b<<24)+65536*this[++a]+256*this[++a]+this[++a])<<BigInt(32))+BigInt(0x1000000*this[++a]+65536*this[++a]+256*this[++a]+c)}),g.prototype.readFloatLE=function(a,b){return a>>>=0,b||t(a,4,this.length),bM.read(this,a,!0,23,4)},g.prototype.readFloatBE=function(a,b){return a>>>=0,b||t(a,4,this.length),bM.read(this,a,!1,23,4)},g.prototype.readDoubleLE=function(a,b){return a>>>=0,b||t(a,8,this.length),bM.read(this,a,!0,52,8)},g.prototype.readDoubleBE=function(a,b){return a>>>=0,b||t(a,8,this.length),bM.read(this,a,!1,52,8)},g.prototype.writeUintLE=g.prototype.writeUIntLE=function(a,b,c,d){if(a*=1,b>>>=0,c>>>=0,!d){let d=Math.pow(2,8*c)-1;u(this,a,b,c,d,0)}let e=1,f=0;for(this[b]=255&a;++f<c&&(e*=256);)this[b+f]=a/e&255;return b+c},g.prototype.writeUintBE=g.prototype.writeUIntBE=function(a,b,c,d){if(a*=1,b>>>=0,c>>>=0,!d){let d=Math.pow(2,8*c)-1;u(this,a,b,c,d,0)}let e=c-1,f=1;for(this[b+e]=255&a;--e>=0&&(f*=256);)this[b+e]=a/f&255;return b+c},g.prototype.writeUint8=g.prototype.writeUInt8=function(a,b,c){return a*=1,b>>>=0,c||u(this,a,b,1,255,0),this[b]=255&a,b+1},g.prototype.writeUint16LE=g.prototype.writeUInt16LE=function(a,b,c){return a*=1,b>>>=0,c||u(this,a,b,2,65535,0),this[b]=255&a,this[b+1]=a>>>8,b+2},g.prototype.writeUint16BE=g.prototype.writeUInt16BE=function(a,b,c){return a*=1,b>>>=0,c||u(this,a,b,2,65535,0),this[b]=a>>>8,this[b+1]=255&a,b+2},g.prototype.writeUint32LE=g.prototype.writeUInt32LE=function(a,b,c){return a*=1,b>>>=0,c||u(this,a,b,4,0xffffffff,0),this[b+3]=a>>>24,this[b+2]=a>>>16,this[b+1]=a>>>8,this[b]=255&a,b+4},g.prototype.writeUint32BE=g.prototype.writeUInt32BE=function(a,b,c){return a*=1,b>>>=0,c||u(this,a,b,4,0xffffffff,0),this[b]=a>>>24,this[b+1]=a>>>16,this[b+2]=a>>>8,this[b+3]=255&a,b+4},g.prototype.writeBigUInt64LE=M(function(a,b=0){return v(this,a,b,BigInt(0),BigInt("0xffffffffffffffff"))}),g.prototype.writeBigUInt64BE=M(function(a,b=0){return w(this,a,b,BigInt(0),BigInt("0xffffffffffffffff"))}),g.prototype.writeIntLE=function(a,b,c,d){if(a*=1,b>>>=0,!d){let d=Math.pow(2,8*c-1);u(this,a,b,c,d-1,-d)}let e=0,f=1,g=0;for(this[b]=255&a;++e<c&&(f*=256);)a<0&&0===g&&0!==this[b+e-1]&&(g=1),this[b+e]=(a/f|0)-g&255;return b+c},g.prototype.writeIntBE=function(a,b,c,d){if(a*=1,b>>>=0,!d){let d=Math.pow(2,8*c-1);u(this,a,b,c,d-1,-d)}let e=c-1,f=1,g=0;for(this[b+e]=255&a;--e>=0&&(f*=256);)a<0&&0===g&&0!==this[b+e+1]&&(g=1),this[b+e]=(a/f|0)-g&255;return b+c},g.prototype.writeInt8=function(a,b,c){return a*=1,b>>>=0,c||u(this,a,b,1,127,-128),a<0&&(a=255+a+1),this[b]=255&a,b+1},g.prototype.writeInt16LE=function(a,b,c){return a*=1,b>>>=0,c||u(this,a,b,2,32767,-32768),this[b]=255&a,this[b+1]=a>>>8,b+2},g.prototype.writeInt16BE=function(a,b,c){return a*=1,b>>>=0,c||u(this,a,b,2,32767,-32768),this[b]=a>>>8,this[b+1]=255&a,b+2},g.prototype.writeInt32LE=function(a,b,c){return a*=1,b>>>=0,c||u(this,a,b,4,0x7fffffff,-0x80000000),this[b]=255&a,this[b+1]=a>>>8,this[b+2]=a>>>16,this[b+3]=a>>>24,b+4},g.prototype.writeInt32BE=function(a,b,c){return a*=1,b>>>=0,c||u(this,a,b,4,0x7fffffff,-0x80000000),a<0&&(a=0xffffffff+a+1),this[b]=a>>>24,this[b+1]=a>>>16,this[b+2]=a>>>8,this[b+3]=255&a,b+4},g.prototype.writeBigInt64LE=M(function(a,b=0){return v(this,a,b,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),g.prototype.writeBigInt64BE=M(function(a,b=0){return w(this,a,b,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),g.prototype.writeFloatLE=function(a,b,c){return y(this,a,b,!0,c)},g.prototype.writeFloatBE=function(a,b,c){return y(this,a,b,!1,c)},g.prototype.writeDoubleLE=function(a,b,c){return z(this,a,b,!0,c)},g.prototype.writeDoubleBE=function(a,b,c){return z(this,a,b,!1,c)},g.prototype.copy=function(a,b,d,e){if(!g.isBuffer(a))throw TypeError("argument should be a Buffer");if(d||(d=0),e||0===e||(e=this.length),b>=a.length&&(b=a.length),b||(b=0),e>0&&e<d&&(e=d),e===d||0===a.length||0===this.length)return 0;if(b<0)throw RangeError("targetStart out of bounds");if(d<0||d>=this.length)throw RangeError("Index out of range");if(e<0)throw RangeError("sourceEnd out of bounds");e>this.length&&(e=this.length),a.length-b<e-d&&(e=a.length-b+d);let f=e-d;return this===a&&"function"==typeof c.prototype.copyWithin?this.copyWithin(b,d,e):c.prototype.set.call(a,this.subarray(d,e),b),f},g.prototype.fill=function(a,b,c,d){let e;if("string"==typeof a){if("string"==typeof b?(d=b,b=0,c=this.length):"string"==typeof c&&(d=c,c=this.length),void 0!==d&&"string"!=typeof d)throw TypeError("encoding must be a string");if("string"==typeof d&&!g.isEncoding(d))throw TypeError("Unknown encoding: "+d);if(1===a.length){let b=a.charCodeAt(0);("utf8"===d&&b<128||"latin1"===d)&&(a=b)}}else"number"==typeof a?a&=255:"boolean"==typeof a&&(a=Number(a));if(b<0||this.length<b||this.length<c)throw RangeError("Out of range index");if(c<=b)return this;if(b>>>=0,c=void 0===c?this.length:c>>>0,a||(a=0),"number"==typeof a)for(e=b;e<c;++e)this[e]=a;else{let f=g.isBuffer(a)?a:g.from(a,d),h=f.length;if(0===h)throw TypeError('The value "'+a+'" is invalid for argument "value"');for(e=0;e<c-b;++e)this[e+b]=f[e%h]}return this};let A={};function B(a,b,c){A[a]=class extends c{constructor(){super(),Object.defineProperty(this,"message",{value:b.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${a}]`,this.stack,delete this.name}get code(){return a}set code(a){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:a,writable:!0})}toString(){return`${this.name} [${a}]: ${this.message}`}}}function C(a){let b="",c=a.length,d=+("-"===a[0]);for(;c>=d+4;c-=3)b=`_${a.slice(c-3,c)}${b}`;return`${a.slice(0,c)}${b}`}function D(a,b,c,d,e,f){if(a>c||a<b){let c,d="bigint"==typeof b?"n":"";throw c=0===b||b===BigInt(0)?`>= 0${d} and < 2${d} ** ${(f+1)*8}${d}`:`>= -(2${d} ** ${(f+1)*8-1}${d}) and < 2 ** ${(f+1)*8-1}${d}`,new A.ERR_OUT_OF_RANGE("value",c,a)}E(e,"offset"),(void 0===d[e]||void 0===d[e+f])&&F(e,d.length-(f+1))}function E(a,b){if("number"!=typeof a)throw new A.ERR_INVALID_ARG_TYPE(b,"number",a)}function F(a,b,c){throw Math.floor(a)!==a?(E(a,c),new A.ERR_OUT_OF_RANGE("offset","an integer",a)):b<0?new A.ERR_BUFFER_OUT_OF_BOUNDS:new A.ERR_OUT_OF_RANGE("offset",`>= 0 and <= ${b}`,a)}B("ERR_BUFFER_OUT_OF_BOUNDS",function(a){return a?`${a} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),B("ERR_INVALID_ARG_TYPE",function(a,b){return`The "${a}" argument must be of type number. Received type ${typeof b}`},TypeError),B("ERR_OUT_OF_RANGE",function(a,b,c){let d=`The value of "${a}" is out of range.`,e=c;return Number.isInteger(c)&&Math.abs(c)>0x100000000?e=C(String(c)):"bigint"==typeof c&&(e=String(c),(c>BigInt(2)**BigInt(32)||c<-(BigInt(2)**BigInt(32)))&&(e=C(e)),e+="n"),d+=` It must be ${b}. Received ${e}`},RangeError);let G=/[^+/0-9A-Za-z-_]/g;function H(a,b){let c;b=b||1/0;let d=a.length,e=null,f=[];for(let g=0;g<d;++g){if((c=a.charCodeAt(g))>55295&&c<57344){if(!e){if(c>56319||g+1===d){(b-=3)>-1&&f.push(239,191,189);continue}e=c;continue}if(c<56320){(b-=3)>-1&&f.push(239,191,189),e=c;continue}c=(e-55296<<10|c-56320)+65536}else e&&(b-=3)>-1&&f.push(239,191,189);if(e=null,c<128){if((b-=1)<0)break;f.push(c)}else if(c<2048){if((b-=2)<0)break;f.push(c>>6|192,63&c|128)}else if(c<65536){if((b-=3)<0)break;f.push(c>>12|224,c>>6&63|128,63&c|128)}else if(c<1114112){if((b-=4)<0)break;f.push(c>>18|240,c>>12&63|128,c>>6&63|128,63&c|128)}else throw Error("Invalid code point")}return f}function I(a){return bE.toByteArray(function(a){if((a=(a=a.split("=")[0]).trim().replace(G,"")).length<2)return"";for(;a.length%4!=0;)a+="=";return a}(a))}function J(a,b,c,d){let e;for(e=0;e<d&&!(e+c>=b.length||e>=a.length);++e)b[e+c]=a[e];return e}function K(a,b){return a instanceof b||null!=a&&null!=a.constructor&&null!=a.constructor.name&&a.constructor.name===b.name}let L=function(){let a="0123456789abcdef",b=Array(256);for(let c=0;c<16;++c){let d=16*c;for(let e=0;e<16;++e)b[d+e]=a[c]+a[e]}return b}();function M(a){return typeof BigInt>"u"?N:a}function N(){throw Error("BigInt not supported")}}(bD);let bN=bD.Buffer;class bO{static fromHex(a){if(0===(a=a.trim()).length)return new Uint8Array(0);if(a.length<2||1&a.length)throw Error("Invalid hex string: odd length.");if((a.startsWith("0x")||a.startsWith("0X"))&&(a=a.slice(2)),!a.match(/^[0-9a-fA-F]*$/))throw Error("Invalid hex string: contains non-hex characters");let b=a.match(/.{1,2}/g);if(!b)throw Error("Invalid hex string");return new Uint8Array(b.map(a=>parseInt(a,16)))}static toHex(a){return Array.from(a,a=>a.toString(16).padStart(2,"0")).join("")}static fromString(a){return a=a.trim(),new TextEncoder().encode(a)}static toString(a){return new TextDecoder("utf-8").decode(a)}static concat(...a){let b=new Uint8Array(a.reduce((a,b)=>a+b.length,0)),c=0;for(let d of a)b.set(d,c),c+=d.length;return b}static alloc(a){return new Uint8Array(a)}static writeBigUint64BE(a){let b=new ArrayBuffer(8);return new DataView(b).setBigUint64(0,a,!1),new Uint8Array(b)}static toBase64(a){if("u">typeof bN)return bN.from(a).toString("base64");if(a.length>32768){let b="";for(let c=0;c<a.length;c+=32768)b+=btoa(String.fromCharCode(...a.slice(c,c+32768)));return b}return btoa(String.fromCharCode(...a))}static fromBase64(a){if(a=a.trim(),"u">typeof bN)return new Uint8Array(bN.from(a,"base64"));let b=a.replace(/-/g,"+").replace(/_/g,"/");for(;b.length%4;)b+="=";return new Uint8Array([...atob(b)].map(a=>a.charCodeAt(0)))}static equals(a,b){if(a.length!==b.length)return!1;let c=0;for(let d=0;d<a.length;d++)c|=a[d]^b[d];return 0===c}static compare(a,b){let c=Math.min(a.length,b.length);for(let d=0;d<c;d++){if(a[d]<b[d])return -1;if(a[d]>b[d])return 1}return a.length-b.length}}function bP(a){return bQ(q(a))}function bQ(a){return BigInt(`0x${a}`)}let bR=t("536563703235366b315f48617368546f43757276655f43617368755f");function bS(a){let b=ab(bO.concat(bR,a)),c=new Uint32Array(1);for(let a=0;a<65536;a++){let a=new Uint8Array(c.buffer),d=ab(bO.concat(b,a));try{return bT(q(bO.concat(new Uint8Array([2]),d)))}catch{c[0]++}}throw Error("No valid point found")}function bT(a){return bp.ProjectivePoint.fromHex(a)}let bU=Uint32Array.from([0x67452301,0xefcdab89,0x98badcfe,0x10325476,0xc3d2e1f0]),bV=new Uint32Array(80);(a,b)=>Math.floor(0x100000000*Math.abs(Math.sin(b+1)));let bW=Uint8Array.from([7,4,13,1,10,6,15,3,12,0,9,5,2,14,11,8]),bX=Uint8Array.from(Array(16).fill(0).map((a,b)=>b)),bY=bX.map(a=>(9*a+5)%16),bZ=(()=>{let a=[[bX],[bY]];for(let b=0;b<4;b++)for(let c of a)c.push(c[b].map(a=>bW[a]));return a})(),b$=bZ[0],b_=bZ[1],b0=[[11,14,15,12,5,8,7,9,11,13,14,15,6,7,9,8],[12,13,11,15,6,9,9,7,12,15,11,13,7,8,7,7],[13,15,14,11,7,7,6,8,13,14,13,12,5,5,6,9],[14,11,12,14,8,6,5,5,15,12,15,14,9,9,8,6],[15,12,13,13,9,5,8,6,14,11,12,11,8,6,5,5]].map(a=>Uint8Array.from(a)),b1=b$.map((a,b)=>a.map(a=>b0[b][a])),b2=b_.map((a,b)=>a.map(a=>b0[b][a])),b3=Uint32Array.from([0,0x5a827999,0x6ed9eba1,0x8f1bbcdc,0xa953fd4e]),b4=Uint32Array.from([0x50a28be6,0x5c4dd124,0x6d703ef3,0x7a6d76e9,0]);function b5(a,b,c,d){return 0===a?b^c^d:1===a?b&c|~b&d:2===a?(b|~c)^d:3===a?b&d|c&~d:b^(c|~d)}let b6=new Uint32Array(16);class b7 extends A{constructor(){super(64,20,8,!0),this.h0=0x67452301,this.h1=-0x10325477,this.h2=-0x67452302,this.h3=0x10325476,this.h4=-0x3c2d1e10}get(){let{h0:a,h1:b,h2:c,h3:d,h4:e}=this;return[a,b,c,d,e]}set(a,b,c,d,e){this.h0=0|a,this.h1=0|b,this.h2=0|c,this.h3=0|d,this.h4=0|e}process(a,b){for(let c=0;c<16;c++,b+=4)b6[c]=a.getUint32(b,!0);let c=0|this.h0,d=c,e=0|this.h1,f=e,g=0|this.h2,h=g,i=0|this.h3,j=i,k=0|this.h4,l=k;for(let a=0;a<5;a++){let b=4-a,m=b3[a],o=b4[a],p=b$[a],q=b_[a],r=b1[a],s=b2[a];for(let b=0;b<16;b++){let d=n(c+b5(a,e,g,i)+b6[p[b]]+m,r[b])+k|0;c=k,k=i,i=0|n(g,10),g=e,e=d}for(let a=0;a<16;a++){let c=n(d+b5(b,f,h,j)+b6[q[a]]+o,s[a])+l|0;d=l,l=j,j=0|n(h,10),h=f,f=c}}this.set(this.h1+g+j|0,this.h2+i+l|0,this.h3+k+d|0,this.h4+c+f|0,this.h0+e+h|0)}roundClean(){k(b6)}destroy(){this.destroyed=!0,k(this.buffer),this.set(0,0,0,0,0)}}let b8=y(()=>new b7);function b9(a){return a instanceof Uint8Array||ArrayBuffer.isView(a)&&"Uint8Array"===a.constructor.name}function ca(a,b){return!!Array.isArray(b)&&(0===b.length||(a?b.every(a=>"string"==typeof a):b.every(a=>Number.isSafeInteger(a))))}function cb(a){if("function"!=typeof a)throw Error("function expected");return!0}function cc(a,b){if("string"!=typeof b)throw Error(`${a}: string expected`);return!0}function cd(a){if(!Number.isSafeInteger(a))throw Error(`invalid integer: ${a}`)}function ce(a){if(!Array.isArray(a))throw Error("array expected")}function cf(a,b){if(!ca(!0,b))throw Error(`${a}: array of strings expected`)}function cg(a,b){if(!ca(!1,b))throw Error(`${a}: array of numbers expected`)}function ch(...a){let b=a=>a,c=(a,b)=>c=>a(b(c));return{encode:a.map(a=>a.encode).reduceRight(c,b),decode:a.map(a=>a.decode).reduce(c,b)}}function ci(a){let b="string"==typeof a?a.split(""):a,c=b.length;cf("alphabet",b);let d=new Map(b.map((a,b)=>[a,b]));return{encode:d=>(ce(d),d.map(d=>{if(!Number.isSafeInteger(d)||d<0||d>=c)throw Error(`alphabet.encode: digit index outside alphabet "${d}". Allowed: ${a}`);return b[d]})),decode:b=>(ce(b),b.map(b=>{cc("alphabet.decode",b);let c=d.get(b);if(void 0===c)throw Error(`Unknown letter: "${b}". Allowed: ${a}`);return c}))}}function cj(a=""){return cc("join",a),{encode:b=>(cf("join.decode",b),b.join(a)),decode:b=>(cc("join.decode",b),b.split(a))}}function ck(a,b,c){if(b<2)throw Error(`convertRadix: invalid from=${b}, base cannot be less than 2`);if(c<2)throw Error(`convertRadix: invalid to=${c}, base cannot be less than 2`);if(ce(a),!a.length)return[];let d=0,e=[],f=Array.from(a,a=>{if(cd(a),a<0||a>=b)throw Error(`invalid integer: ${a}`);return a}),g=f.length;for(;;){let a=0,h=!0;for(let e=d;e<g;e++){let g=f[e],i=b*a,j=i+g;if(!Number.isSafeInteger(j)||i/b!==a||j-g!==i)throw Error("convertRadix: carry overflow");let k=j/c;a=j%c;let l=Math.floor(k);if(f[e]=l,!Number.isSafeInteger(l)||l*c+a!==j)throw Error("convertRadix: carry overflow");h&&(l?h=!1:d=e)}if(e.push(a),h)break}for(let b=0;b<a.length-1&&0===a[b];b++)e.push(0);return e.reverse()}let cl=(a,b)=>0===b?a:cl(b,a%b),cm=(()=>{let a=[];for(let b=0;b<40;b++)a.push(2**b);return a})();"function"==typeof Uint8Array.from([]).toBase64&&Uint8Array.fromBase64;let cn=ch((c=58,cd(58),{encode:a=>{if(!b9(a))throw Error("radix.encode input should be Uint8Array");return ck(Array.from(a),256,58)},decode:a=>(cg("radix.decode",a),Uint8Array.from(ck(a,58,256)))}),ci("123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"),cj("")),co=ch(ci("qpzry9x8gf2tvdw0s3jn54khce6mua7l"),cj(""));"function"==typeof Uint8Array.from([]).toHex&&Uint8Array.fromHex;let cp=bp.ProjectivePoint,cq=(a=>ch(function(a,b){return cd(4),cb(b),{encode(c){if(!b9(c))throw Error("checksum.encode: input should be Uint8Array");let d=b(c).slice(0,4),e=new Uint8Array(c.length+a);return e.set(c),e.set(d,c.length),e},decode(c){if(!b9(c))throw Error("checksum.decode: input should be Uint8Array");let d=c.slice(0,-a),e=c.slice(-a),f=b(d).slice(0,a);for(let b=0;b<a;b++)if(f[b]!==e[b])throw Error("Invalid checksum");return d}}}(4,b=>a(a(b))),cn))(ab);function cr(a){return h(a),BigInt("0x"+(0===a.length?"0":q(a)))}let cs=u("Bitcoin seed"),ct={private:0x488ade4,public:0x488b21e},cu=a=>{if(!Number.isSafeInteger(a)||a<0||a>0x100000000-1)throw Error("invalid number, should be from 0 to 2**32-1, got "+a);let b=new Uint8Array(4);return l(b).setUint32(0,a,!1),b};class cv{get fingerprint(){if(!this.pubHash)throw Error("No publicKey set!");return l(this.pubHash).getUint32(0,!1)}get identifier(){return this.pubHash}get pubKeyHash(){return this.pubHash}get privateKey(){return this.privKeyBytes||null}get publicKey(){return this.pubKey||null}get privateExtendedKey(){let a=this.privateKey;if(!a)throw Error("No private key");return cq.encode(this.serialize(this.versions.private,w(new Uint8Array([0]),a)))}get publicExtendedKey(){if(!this.pubKey)throw Error("No public key");return cq.encode(this.serialize(this.versions.public,this.pubKey))}static fromMasterSeed(a,b=ct){if(h(a),8*a.length<128||8*a.length>512)throw Error("HDKey: seed length must be between 128 and 512 bits; 256 bits is advised, got "+a.length);let c=ae(ac,cs,a);return new cv({versions:b,chainCode:c.slice(32),privateKey:c.slice(0,32)})}static fromExtendedKey(a,b=ct){let c=cq.decode(a),d=l(c),e=d.getUint32(0,!1),f={versions:b,depth:c[4],parentFingerprint:d.getUint32(5,!1),index:d.getUint32(9,!1),chainCode:c.slice(13,45)},g=c.slice(45),h=0===g[0];if(e!==b[h?"private":"public"])throw Error("Version mismatch");return new cv(h?{...f,privateKey:g.slice(1)}:{...f,publicKey:g})}static fromJSON(a){return cv.fromExtendedKey(a.xpriv)}constructor(a){if(this.depth=0,this.index=0,this.chainCode=null,this.parentFingerprint=0,!a||"object"!=typeof a)throw Error("HDKey.constructor must not be called directly");if(this.versions=a.versions||ct,this.depth=a.depth||0,this.chainCode=a.chainCode||null,this.index=a.index||0,this.parentFingerprint=a.parentFingerprint||0,!this.depth&&(this.parentFingerprint||this.index))throw Error("HDKey: zero depth with non-zero index/parent fingerprint");if(a.publicKey&&a.privateKey)throw Error("HDKey: publicKey and privateKey at same time.");if(a.privateKey){if(!bp.utils.isValidPrivateKey(a.privateKey))throw Error("Invalid private key");this.privKey="bigint"==typeof a.privateKey?a.privateKey:cr(a.privateKey),this.privKeyBytes=function(a){if("bigint"!=typeof a)throw Error("bigint expected");return t(a.toString(16).padStart(64,"0"))}(this.privKey),this.pubKey=bp.getPublicKey(a.privateKey,!0)}else if(a.publicKey)this.pubKey=cp.fromHex(a.publicKey).toRawBytes(!0);else throw Error("HDKey: no public or private key provided");this.pubHash=b8(ab(this.pubKey))}derive(a){if(!/^[mM]'?/.test(a))throw Error('Path must start with "m" or "M"');if(/^[mM]'?$/.test(a))return this;let b=a.replace(/^[mM]'?\//,"").split("/"),c=this;for(let a of b){let b=/^(\d+)('?)$/.exec(a),d=b&&b[1];if(!b||3!==b.length||"string"!=typeof d)throw Error("invalid child index: "+a);let e=+d;if(!Number.isSafeInteger(e)||e>=0x80000000)throw Error("Invalid index");"'"===b[2]&&(e+=0x80000000),c=c.deriveChild(e)}return c}deriveChild(a){if(!this.pubKey||!this.chainCode)throw Error("No publicKey or chainCode set");let b=cu(a);if(a>=0x80000000){let a=this.privateKey;if(!a)throw Error("Could not derive hardened child key");b=w(new Uint8Array([0]),a,b)}else b=w(this.pubKey,b);let c=ae(ac,this.chainCode,b),d=cr(c.slice(0,32)),e=c.slice(32);if(!bp.utils.isValidPrivateKey(d))throw Error("Tweak bigger than curve order");let f={versions:this.versions,chainCode:e,depth:this.depth+1,parentFingerprint:this.fingerprint,index:a};try{if(this.privateKey){let a=aG(this.privKey+d,bp.CURVE.n);if(!bp.utils.isValidPrivateKey(a))throw Error("The tweak was out of range or the resulted private key is invalid");f.privateKey=a}else{let a=cp.fromHex(this.pubKey).add(cp.fromPrivateKey(d));if(a.equals(cp.ZERO))throw Error("The tweak was equal to negative P, which made the result key invalid");f.publicKey=a.toRawBytes(!0)}return new cv(f)}catch(b){return this.deriveChild(a+1)}}sign(a){if(!this.privateKey)throw Error("No privateKey set!");return h(a,32),bp.sign(a,this.privKey).toCompactRawBytes()}verify(a,b){let c;if(h(a,32),h(b,64),!this.publicKey)throw Error("No publicKey set!");try{c=bp.Signature.fromCompact(b)}catch(a){return!1}return bp.verify(c,a,this.publicKey)}wipePrivateData(){return this.privKey=void 0,this.privKeyBytes&&(this.privKeyBytes.fill(0),this.privKeyBytes=void 0),this}toJSON(){return{xpriv:this.privateExtendedKey,xpub:this.publicExtendedKey}}serialize(a,b){if(!this.chainCode)throw Error("No chainCode set");return h(b,33),w(cu(a),new Uint8Array([this.depth]),cu(this.parentFingerprint),cu(this.index),this.chainCode,b)}}function cw(a){return bO.fromBase64(a)}function cx(a){let b=JSON.stringify(a);return bO.toBase64(bO.fromString(b)).replace(/\+/g,"-").replace(/\//g,"_").split("=")[0]}function cy(a){if("string"!=typeof a||0===a.length||!/^[A-Za-z0-9\-_]+={0,2}$/.test(a)&&!/^[A-Za-z0-9+/]+={0,2}$/.test(a))return!1;let b=a.replace(/-/g,"+").replace(/_/g,"/"),c=(4-b.length%4)%4;if(c>2)return!1;let d=b+"=".repeat(c);try{let a=bO.fromBase64(d),c=bO.toBase64(a),e=c.replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,""),f=b.replace(/=+$/,"");return c.replace(/=+$/,"")===f||e===f}catch{return!1}}let cz=(a,b,c,d)=>{let e=bO.concat(bO.fromString("Cashu_KDF_HMAC_SHA256"),bO.fromHex(b),bO.writeBigUint64BE(BigInt(c)));switch(d){case 0:e=bO.concat(e,bO.fromHex("00"));break;case 1:e=bO.concat(e,bO.fromHex("01"))}return ae(ab,a,e)},cA=(a,b,c,d)=>{let e=cv.fromMasterSeed(a),f=(a=>/^[a-fA-F0-9]+$/.test(a)?bQ(a)%BigInt(0x80000000-1):bP(bO.fromBase64(a))%BigInt(0x80000000-1))(b),g=`m/129372'/0'/${f}'/${c}'/${d}`,h=e.derive(g);if(null===h.privateKey)throw Error("Could not derive private key");return h.privateKey},cB=a=>{try{return a instanceof Uint8Array&&(a=new TextDecoder().decode(a)),JSON.parse(a)}catch{throw Error("can't parse secret")}},cC=(a,b,c=!1)=>{let d=Array.isArray(b)?b:[b];return a.map((a,b)=>{let e=a;for(let a of d)try{e=cD(e,a)}catch(d){let a=d instanceof Error?d.message:"Unknown error";if(c)throw Error(`Failed signing proof #${b+1}: ${a}`);console.warn(`Proof #${b+1}: ${a}`)}return e})},cD=(a,b)=>{let c=cB(a.secret);if("P2PK"!==c[0])throw Error("not a P2PK secret");let d=q(bA.getPublicKey(b)),e=function(a){try{let b="string"==typeof a?cB(a):a;if("P2PK"!==b[0])throw Error('Invalid P2PK secret: must start with "P2PK"');let c=Math.floor(Date.now()/1e3);return function(a){let b="string"==typeof a?cB(a):a;if("P2PK"!==b[0])throw Error('Invalid P2PK secret: must start with "P2PK"');let{tags:c}=b[1],d=c&&c.find(a=>"locktime"===a[0]);return d&&d.length>1?parseInt(d[1],10):1/0}(b)>c?function(a){let b="string"==typeof a?cB(a):a;if("P2PK"!==b[0])throw Error('Invalid P2PK secret: must start with "P2PK"');let{data:c,tags:d}=b[1],e=d&&d.find(a=>"pubkeys"===a[0]);return[c,...e&&e.length>1?e.slice(1):[]].filter(Boolean)}(b):function(a){let b="string"==typeof a?cB(a):a;if("P2PK"!==b[0])throw Error('Invalid P2PK secret: must start with "P2PK"');let{tags:c}=b[1],d=c&&c.find(a=>"refund"===a[0]);return d&&d.length>1?d.slice(1).filter(Boolean):[]}(b)}catch{}return[]}(c);if(!e.length||!e.some(a=>a.includes(d)))throw Error(`Signature not required from [02|03]${d}`);let f=(a=>{if(!a)return[];if("string"==typeof a)try{return JSON.parse(a).signatures||[]}catch(a){return console.error("Failed to parse witness string:",a),[]}return a.signatures||[]})(a.witness);if(f.some(b=>{try{return((a,b,c)=>{try{let d=ab(b),e=66===c.length?c.slice(2):c;if(bA.verify(a,d,t(e)))return!0}catch(a){console.error("verifyP2PKsecret error:",a)}return!1})(b,a.secret,d)}catch{return!1}}))throw Error(`Proof already signed by [02|03]${d}`);let g=((a,b)=>{let c=ab(a);return q(bA.sign(c,b))})(a.secret,b);return f.push(g),{...a,witness:{signatures:f}}};function cE(a,b,c){let d=bS(a);b||(b=bP(bp.utils.randomPrivateKey()));let e=bp.ProjectivePoint.BASE.multiply(b),f=d.add(e);return void 0!==c?((a,b)=>{let c=((a,b)=>{let c=ab(a);return q(bA.sign(c,b))})(a.B_.toHex(!0),b);return a.witness={signatures:[c]},a})({B_:f,r:b,secret:a},c):{B_:f,r:b,secret:a}}function cF(a){let b=[];return function a(b,c){if(null===b)c.push(246);else if(void 0===b)c.push(247);else if("boolean"==typeof b)c.push(b?245:244);else if("number"==typeof b)cG(b,c);else if("string"==typeof b)cH(b,c);else if(Array.isArray(b)){var d=b,e=c;let f=d.length;if(f<24)e.push(128|f);else if(f<256)e.push(152,f);else if(f<65536)e.push(153,f>>8,255&f);else throw Error("Unsupported array length");for(let b of d)a(b,e)}else if(b instanceof Uint8Array){var f=b,g=c;let a=f.length;if(a<24)g.push(64+a);else if(a<256)g.push(88,a);else if(a<65536)g.push(89,a>>8&255,255&a);else if(a<0x100000000)g.push(90,a>>24&255,a>>16&255,a>>8&255,255&a);else throw Error("Byte string too long to encode");for(let a=0;a<f.length;a++)g.push(f[a])}else if("object"!=typeof b||null===b||Array.isArray(b))throw Error("Unsupported type");else{var h=b,i=c;let d=Object.keys(h);for(let b of(cG(d.length,i),i[i.length-1]|=160,d))cH(b,i),a(h[b],i)}}(a,b),new Uint8Array(b)}function cG(a,b){if(a<24)b.push(a);else if(a<256)b.push(24,a);else if(a<65536)b.push(25,a>>8,255&a);else if(a<0x100000000)b.push(26,a>>24,a>>16&255,a>>8&255,255&a);else throw Error("Unsupported integer size")}function cH(a,b){let c=new TextEncoder().encode(a),d=c.length;if(d<24)b.push(96+d);else if(d<256)b.push(120,d);else if(d<65536)b.push(121,d>>8&255,255&d);else if(d<0x100000000)b.push(122,d>>24&255,d>>16&255,d>>8&255,255&d);else throw Error("String too long to encode");for(let a=0;a<c.length;a++)b.push(c[a])}function cI(a){return function a(b,c){if(c>=b.byteLength)throw Error("Unexpected end of data");let d=b.getUint8(c++),e=d>>5,f=31&d;switch(e){case 0:var g=b,h=c,i=f;let{value:j,offset:k}=cJ(g,h,i);return{value:j,offset:k};case 1:var l=b,m=c,n=f;let{value:o,offset:p}=cJ(l,m,n);return{value:-1-o,offset:p};case 2:var q=b,r=c,s=f;let{value:t,offset:u}=cJ(q,r,s);if(u+t>q.byteLength)throw Error("Byte string length exceeds data length");return{value:new Uint8Array(q.buffer,q.byteOffset+u,t),offset:u+t};case 3:var v=b,w=c,x=f;let{value:y,offset:z}=cJ(v,w,x);if(z+y>v.byteLength)throw Error("String length exceeds data length");let A=new Uint8Array(v.buffer,v.byteOffset+z,y);return{value:new TextDecoder().decode(A),offset:z+y};case 4:return function(b,c,d){let{value:e,offset:f}=cJ(b,c,d),g=[],h=f;for(let c=0;c<e;c++){let c=a(b,h);g.push(c.value),h=c.offset}return{value:g,offset:h}}(b,c,f);case 5:return function(b,c,d){let{value:e,offset:f}=cJ(b,c,d),g={},h=f;for(let c=0;c<e;c++){var i;let c=a(b,h);if("number"!=typeof(i=c.value)&&"string"!=typeof i)throw Error("Invalid key type");let d=a(b,c.offset);g[c.value]=d.value,h=d.offset}return{value:g,offset:h}}(b,c,f);case 7:var B=b,C=c,D=f;if(D<24)switch(D){case 20:return{value:!1,offset:C};case 21:return{value:!0,offset:C};case 22:return{value:null,offset:C};case 23:return{value:void 0,offset:C};default:throw Error(`Unknown simple value: ${D}`)}if(24===D)return{value:B.getUint8(C++),offset:C};if(25===D)return{value:function(a){let b=(31744&a)>>10,c=1023&a,d=32768&a?-1:1;return 0===b?6103515625e-14*d*(c/1024):31===b?c?NaN:1/0*d:d*2**(b-15)*(1+c/1024)}(B.getUint16(C,!1)),offset:C+=2};if(26===D)return{value:B.getFloat32(C,!1),offset:C+=4};if(27===D)return{value:B.getFloat64(C,!1),offset:C+=8};throw Error(`Unknown simple or float value: ${D}`);default:throw Error(`Unsupported major type: ${e}`)}}(new DataView(a.buffer,a.byteOffset,a.byteLength),0).value}function cJ(a,b,c){if(c<24)return{value:c,offset:b};if(24===c)return{value:a.getUint8(b++),offset:b};if(25===c)return{value:a.getUint16(b,!1),offset:b+=2};if(26===c)return{value:a.getUint32(b,!1),offset:b+=4};if(27===c)return{value:0x100000000*a.getUint32(b,!1)+a.getUint32(b+4,!1),offset:b+=8};throw Error(`Unsupported length: ${c}`)}class cK{constructor(a,b,c,d,e,f,g=!1,h){this.transport=a,this.id=b,this.amount=c,this.unit=d,this.mints=e,this.description=f,this.singleUse=g,this.nut10=h}toRawRequest(){let a={};return this.transport&&(a.t=this.transport.map(a=>({t:a.type,a:a.target,g:a.tags}))),this.id&&(a.i=this.id),this.amount&&(a.a=this.amount),this.unit&&(a.u=this.unit),this.mints&&(a.m=this.mints),this.description&&(a.d=this.description),this.singleUse&&(a.s=this.singleUse),this.nut10&&(a.nut10={k:this.nut10.kind,d:this.nut10.data,t:this.nut10.tags}),a}toEncodedRequest(){let a=cF(this.toRawRequest());return"creqA"+bO.toBase64(a)}getTransport(a){return this.transport?.find(b=>b.type===a)}static fromRawRequest(a){let b=a.t?a.t.map(a=>({type:a.t,target:a.a,tags:a.g})):void 0,c=a.nut10?{kind:a.nut10.k,data:a.nut10.d,tags:a.nut10.t}:void 0;return new cK(b,a.i,a.a,a.u,a.m,a.d,a.s,c)}static fromEncodedRequest(a){if(!a.startsWith("creq"))throw Error("unsupported pr: invalid prefix");if("A"!==a[4])throw Error("unsupported pr version");let b=cI(cw(a.slice(5)));return this.fromRawRequest(b)}}function cL(a,b,c,d){if(c){let d=db(c);if(0===a&&0===d)return c;let e=c.filter(a=>a>0),f=db(e);if(f>a)throw Error(`Split is greater than total amount: ${f} > ${a}`);if(e.some(a=>!(a in b)))throw Error("Provided amount preferences do not match the amounts of the mint keyset.");if(f===a)return e;c=e,a-=f}else c=[];let e=cN(b,"desc");if(!e||0===e.length)throw Error("Cannot split amount, keyset is inactive or contains no keys");if(e.forEach(b=>{if(a<=0||b<=0)return;let d=Math.floor(a/b);for(let a=0;a<d;++a)c.push(b);a%=b}),0!==a)throw Error(`Unable to split remaining amount: ${a}`);return c.sort((a,b)=>a-b)}function cM(a,b,c,d){let e=[],f=a.map(a=>a.amount);cN(c,"asc").forEach(a=>{let c=Math.max(d-f.filter(b=>b===a).length,0);for(let d=0;d<c&&!(e.reduce((a,b)=>a+b,0)+a>b);++d)e.push(a)});let g=b-e.reduce((a,b)=>a+b,0);return g&&cL(g,c).forEach(a=>{e.push(a)}),e.sort((a,b)=>a-b)}function cN(a,b="desc"){return"desc"==b?Object.keys(a).map(a=>parseInt(a)).sort((a,b)=>b-a):Object.keys(a).map(a=>parseInt(a)).sort((a,b)=>a-b)}function cO(a){return BigInt(`0x${a}`)}function cP(a){return/^[a-f0-9]*$/i.test(a)}function cQ(a){return Array.isArray(a)?a.some(a=>!cP(a.id)):!cP(a.id)}function cR(a){return a.map(a=>{let b={...a};return b.id=b.id.slice(0,16),b})}function cS(a,b){if(cQ(a.proofs)||b?.version===3){if(b?.version===4)throw Error("can not encode to v4 token if proofs contain non-hex keyset id");var c=b?.removeDleq;cQ(a.proofs)||(a.proofs=cR(a.proofs)),c&&(a.proofs=c6(a.proofs));let d={token:[{mint:a.mint,proofs:a.proofs}]};return a.unit&&(d.unit=a.unit),a.memo&&(d.memo=a.memo),"cashuA"+cx(d)}return cT(a,b?.removeDleq)}function cT(a,b){var c;if(b&&(a.proofs=c6(a.proofs)),a.proofs.forEach(a=>{if(a.dleq&&null==a.dleq.r)throw Error("Missing blinding factor in included DLEQ proof")}),cQ(a.proofs))throw Error("can not encode to v4 token if proofs contain non-hex keyset id");return a.proofs=cR(a.proofs),"cashuB"+(c=cF(cU(a)),bO.toBase64(c).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,""))}function cU(a){let b={},c=a.mint;for(let c=0;c<a.proofs.length;c++){let d=a.proofs[c];b[d.id]?b[d.id].push(d):b[d.id]=[d]}let d={m:c,u:a.unit||"sat",t:Object.keys(b).map(a=>({i:t(a),p:b[a].map(a=>({a:a.amount,s:a.secret,c:t(a.C),...a.dleq&&{d:{e:t(a.dleq.e),s:t(a.dleq.s),r:t(a.dleq.r??"00")}},...a.witness&&{w:JSON.stringify(a.witness)}}))}))};return a.memo&&(d.d=a.memo),d}function cV(a){let b=[];a.t.forEach(a=>a.p.forEach(c=>{b.push({secret:c.s,C:q(c.c),amount:c.a,id:q(a.i),...c.d&&{dleq:{r:q(c.d.r),s:q(c.d.s),e:q(c.d.e)}},...c.w&&{witness:c.w}})}));let c={mint:a.m,proofs:b,unit:a.u||"sat"};return a.d&&(c.memo=a.d),c}function cW(a,b){let c=cY(a=dc(a));return c.proofs=function(a,b){let c=[];for(let d of a){let a;try{a=t(d.id)}catch{c.push(d);continue}if(0===a[0])c.push(d);else if(1===a[0]){if(!b)throw Error("A short keyset ID v2 was encountered, but got no keysets to map it to.");let a=!1;for(let e of b)if(d.id===e.id.slice(0,d.id.length)){d.id=e.id,c.push(d),a=!0;break}if(!a)throw Error(`Couldn't map short keyset ID ${d.id} to any known keysets of the current Mint`)}else throw Error(`Unknown keyset ID version: ${a[0]}`)}return c}(c.proofs,b),c}function cX(a){let b=cY(a=dc(a));return{unit:b.unit||"sat",mint:b.mint,amount:c2(b.proofs),incompleteProofs:b.proofs.map(a=>({secret:a.secret,C:a.C,amount:a.amount,...a.dleq&&{dleq:a.dleq}})),...b.memo&&{memo:b.memo}}}function cY(a){let b=a.slice(0,1),c=a.slice(1);if("A"===b){let a=JSON.parse(bO.toString(bO.fromBase64(c.replace(/-/g,"+").replace(/_/g,"/").split("=")[0])));if(a.token.length>1)throw Error("Multi entry token are not supported");let b=a.token[0],d={mint:b.mint,proofs:b.proofs,unit:a.unit||"sat"};return a.memo&&(d.memo=a.memo),d}if("B"===b)return cV(cI(cw(c)));throw Error("Token version is not supported")}function cZ(a,b,c,d=0,e=!1){if(e){let b=ab(Object.entries(a).sort((a,b)=>a[0]-b[0]).map(([,a])=>a).reduce((a,b)=>a+b,""));return bO.toBase64(b).slice(0,12)}let f=Object.entries(a).sort((a,b)=>a[0]-b[0]).map(([,a])=>t(a)).reduce((a,b)=>c$(a,b),new Uint8Array),g;switch(d){case 0:return g=ab(f),"00"+bO.toHex(g).slice(0,14);case 1:if(!b)throw Error("Cannot compute keyset ID version 01: unit is required.");return f=c$(f,bO.fromString("unit:"+b)),c&&(f=c$(f,bO.fromString("final_expiry:"+c.toString()))),g=ab(f),"01"+bO.toHex(g);default:throw Error(`Unrecognized keyset ID version: ${d}`)}}function c$(a,b){let c=new Uint8Array(a.length+b.length);return c.set(a),c.set(b,a.length),c}function c_(a){return"object"==typeof a}function c0(...a){return a.map(a=>a.replace(/(^\/+|\/+$)/g,"")).join("/")}function c1(a){return a.replace(/\/$/,"")}function c2(a){return a.reduce((a,b)=>a+b.amount,0)}function c3(a){return cK.fromEncodedRequest(a)}class c4{get value(){return this._value}set value(a){this._value=a}get next(){return this._next}set next(a){this._next=a}constructor(a){this._value=a,this._next=null}}class c5{get first(){return this._first}set first(a){this._first=a}get last(){return this._last}set last(a){this._last=a}get size(){return this._size}set size(a){this._size=a}constructor(){this._first=null,this._last=null,this._size=0}enqueue(a){let b=new c4(a);return 0!==this._size&&this._last?this._last.next=b:this._first=b,this._last=b,this._size++,!0}dequeue(){if(0===this._size||!this._first)return null;let a=this._first;return this._first=a.next,a.next=null,this._size--,a.value}}function c6(a){return a.map(a=>{let b={...a};return delete b.dleq,b})}function c7(a){let b=cy(a.id),c=/^[a-fA-F0-9]+$/.test(a.id),d=c?t(a.id)[0]:0;return cZ(a.keys,a.unit,a.final_expiry,d,b&&!c)===a.id}function c8(a,b){if(null==a.dleq)return!1;let c={e:t(a.dleq.e),s:t(a.dleq.s),r:cO(a.dleq.r??"00")};if(!(a.amount in b.keys))throw Error(`undefined key for amount ${a.amount}`);let d=b.keys[a.amount];return((a,b,c,d)=>{if(void 0===b.r)throw Error("verifyDLEQProof_reblind: Undefined blinding factor");let e=bS(a),f=c.add(d.multiply(b.r)),g=bp.ProjectivePoint.fromPrivateKey(b.r);return((a,b,c,d)=>{let e=bp.ProjectivePoint.fromPrivateKey(q(a.s)),f=d.multiply(bP(a.e)),g=b.multiply(bP(a.s)),h=c.multiply(bP(a.e));return function(a,b){if(a.length!==b.length)return!1;for(let c=0;c<a.length;c++)if(a[c]!==b[c])return!1;return!0}(function(a){let b=a.map(a=>a.toHex(!1)).join("");return ab(new TextEncoder().encode(b))}([e.subtract(f),g.subtract(h),d,c]),a.e)})(b,e.add(g),f,d)})(new TextEncoder().encode(a.secret),c,bT(a.C),bT(d))}function c9(a){let b=new TextEncoder,c=cF(cU(a));return function(...a){let b=new Uint8Array(a.reduce((a,b)=>a+b.length,0)),c=0;for(let d=0;d<a.length;d++)b.set(a[d],c),c+=a[d].length;return b}(b.encode("craw"),b.encode("B"),c)}function da(a){let b=new TextDecoder,c=b.decode(a.slice(0,4)),d=b.decode(new Uint8Array([a[4]]));if("craw"!==c||"B"!==d)throw Error("not a valid binary token");return cV(cI(a.slice(5)))}function db(a){return a.reduce((a,b)=>a+b,0)}function dc(a){return["web+cashu://","cashu://","cashu:","cashu"].forEach(b=>{a.startsWith(b)&&(a=a.slice(b.length))}),a}function dd(a){b=a}"u">typeof WebSocket&&(b=WebSocket);let de={FATAL:"FATAL",ERROR:"ERROR",WARN:"WARN",INFO:"INFO",DEBUG:"DEBUG",TRACE:"TRACE"},df={fatal(){},error(){},warn(){},info(){},debug(){},trace(){},log(){}},dg=class a{constructor(a=de.INFO){this.minLevel=a}logToConsole(b,c,d){if(a.SEVERITY[b]>a.SEVERITY[this.minLevel])return;let e=`[${b}] `,f=c,g=new Set;if(d){let a=Object.fromEntries(Object.entries(d).map(([a,b])=>[a,b instanceof Error?{message:b.message,stack:b.stack}:b]));f=c.replace(/\{(\w+)\}/g,(b,c)=>{if(c in a&&void 0!==a[c]){g.add(c);let b=a[c];return"string"==typeof b?b:"number"==typeof b||"boolean"==typeof b?b.toString():null==b?"":JSON.stringify(b)}return b});let h=Object.fromEntries(Object.entries(a).filter(([a])=>!g.has(a))),i=this.getConsoleMethod(b);Object.keys(h).length>0?i(e+f,h):i(e+f)}else this.getConsoleMethod(b)(e+f)}getConsoleMethod(a){switch(a){case de.FATAL:case de.ERROR:return console.error;case de.WARN:return console.warn;case de.INFO:return console.info;case de.DEBUG:return console.debug;case de.TRACE:return console.trace;default:return console.log}}fatal(a,b){this.logToConsole(de.FATAL,a,b)}error(a,b){this.logToConsole(de.ERROR,a,b)}warn(a,b){this.logToConsole(de.WARN,a,b)}info(a,b){this.logToConsole(de.INFO,a,b)}debug(a,b){this.logToConsole(de.DEBUG,a,b)}trace(a,b){this.logToConsole(de.TRACE,a,b)}log(a,b,c){this.logToConsole(a,b,c)}};dg.SEVERITY={[de.FATAL]:0,[de.ERROR]:1,[de.WARN]:2,[de.INFO]:3,[de.DEBUG]:4,[de.TRACE]:5};let dh=dg;class di{constructor(){this.connectionMap=new Map}static getInstance(){return di.instance||(di.instance=new di),di.instance}getConnection(a,b){if(this.connectionMap.has(a))return this.connectionMap.get(a);let c=new dj(a,b);return this.connectionMap.set(a,c),c}}class dj{constructor(a,c){this.subListeners={},this.rpcListeners={},this.rpcId=0,this.onCloseCallbacks=[],this._WS=function(){if(void 0===b)throw Error("WebSocket implementation not initialized");return b}(),this.url=new URL(a),this.messageQueue=new c5,this._logger=c??df}connect(){return this.connectionPromise||(this.connectionPromise=new Promise((a,b)=>{try{this.ws=new this._WS(this.url.toString()),this.onCloseCallbacks=[]}catch(a){b(a instanceof Error?a:Error(String(a)));return}this.ws.onopen=()=>{a()},this.ws.onerror=()=>{b(Error("Failed to open WebSocket"))},this.ws.onmessage=a=>{this.messageQueue.enqueue(a.data),this.handlingInterval||(this.handlingInterval=setInterval(this.handleNextMessage.bind(this),0))},this.ws.onclose=a=>{this.connectionPromise=void 0,this.onCloseCallbacks.forEach(b=>b(a))}})),this.connectionPromise}sendRequest(a,b){if(this.ws?.readyState!==1){if("unsubscribe"===a)return;throw this._logger.error("Attempted sendRequest, but socket was not open"),Error("Socket not open")}let c=this.rpcId;this.rpcId++;let d=JSON.stringify({jsonrpc:"2.0",method:a,params:b,id:c});this.ws?.send(d)}closeSubscription(a){this.ws?.send(JSON.stringify(["CLOSE",a]))}addSubListener(a,b){(this.subListeners[a]=this.subListeners[a]||[]).push(b)}addRpcListener(a,b,c){this.rpcListeners[c]={callback:a,errorCallback:b}}removeRpcListener(a){delete this.rpcListeners[a]}removeListener(a,b){if(this.subListeners[a]){if(1===this.subListeners[a].length)return void delete this.subListeners[a];this.subListeners[a]=this.subListeners[a].filter(a=>a!==b)}}async ensureConnection(){this.ws?.readyState!==1&&await this.connect()}handleNextMessage(){let a;if(0===this.messageQueue.size){clearInterval(this.handlingInterval),this.handlingInterval=void 0;return}let b=this.messageQueue.dequeue();try{if(a=JSON.parse(b),"result"in a&&null!=a.id)this.rpcListeners[a.id]&&(this.rpcListeners[a.id].callback(),this.removeRpcListener(a.id));else if("error"in a&&null!=a.id)this.rpcListeners[a.id]&&(this.rpcListeners[a.id].errorCallback(Error(a.error.message)),this.removeRpcListener(a.id));else if("method"in a&&!("id"in a)){let b=a.params?.subId;if(!b)return;this.subListeners[b]?.length>0&&this.subListeners[b].forEach(b=>b(a.params?.payload))}}catch(a){this._logger.error("Error doing handleNextMessage",{e:a});return}}createSubscription(a,b,c){if(this.ws?.readyState!==1)throw this._logger.error("Attempted createSubscription, but socket was not open"),Error("Socket is not open");let d=(Math.random()+1).toString(36).substring(7);return this.addRpcListener(()=>{this.addSubListener(d,b)},c,this.rpcId),this.sendRequest("subscribe",{...a,subId:d}),this.rpcId++,d}cancelSubscription(a,b,c){this.removeListener(a,b),this.addRpcListener(()=>{this._logger.info("Unsubscribed {subId}",{subId:a})},c||(a=>this._logger.error("Unsubscribe failed",{e:a})),this.rpcId),this.sendRequest("unsubscribe",{subId:a})}get activeSubscriptions(){return Object.keys(this.subListeners)}close(){this.ws&&this.ws?.close()}onClose(a){this.onCloseCallbacks.push(a)}}let dk={UNSPENT:"UNSPENT",PENDING:"PENDING",SPENT:"SPENT"},dl={UNPAID:"UNPAID",PENDING:"PENDING",PAID:"PAID"},dm={UNPAID:"UNPAID",PAID:"PAID",ISSUED:"ISSUED"};var dn=(a=>(a.POST="post",a.NOSTR="nostr",a))(dn||{});class dp extends Error{constructor(a,b){super(a),this.status=b,this.name="HttpResponseError",Object.setPrototypeOf(this,dp.prototype)}}class dq extends Error{constructor(a){super(a),this.name="NetworkError",Object.setPrototypeOf(this,dq.prototype)}}class dr extends dp{constructor(a,b){super(b||"Unknown mint operation error",400),this.code=a,this.name="MintOperationError",Object.setPrototypeOf(this,dr.prototype)}}let ds={},dt=df;function du(a){ds=a}async function dv({endpoint:a,requestBody:b,headers:c,...d}){let e,f=b?JSON.stringify(b):void 0,g={Accept:"application/json, text/plain, */*",...f?{"Content-Type":"application/json"}:void 0,...c};try{e=await fetch(a,{body:f,headers:g,...d})}catch(a){throw new dq(a instanceof Error?a.message:"Network request failed")}if(!e.ok){let a;try{a=await e.json()}catch{a={error:"bad response"}}if(400===e.status&&"code"in a&&"number"==typeof a.code&&"detail"in a&&"string"==typeof a.detail)throw new dr(a.code,a.detail);let b="HTTP request failed";throw"error"in a&&"string"==typeof a.error?b=a.error:"detail"in a&&"string"==typeof a.detail&&(b=a.detail),new dp(b,e.status)}try{return await e.json()}catch(a){throw dt.error("Failed to parse HTTP response",{err:a}),new dp("bad response",e.status)}}async function dw(a){return await dv({...a,...ds})}function dx(a,b){return a.state||(b.warn("Field 'state' not found in MeltQuoteResponse. Update NUT-05 of mint: https://github.com/cashubtc/nuts/pull/136)"),"boolean"==typeof a.paid&&(a.state=a.paid?dl.PAID:dl.UNPAID)),a}function dy(a,b){return a.state||(b.warn("Field 'state' not found in MintQuoteResponse. Update NUT-04 of mint: https://github.com/cashubtc/nuts/pull/141)"),"boolean"==typeof a.paid&&(a.state=a.paid?dm.PAID:dm.UNPAID)),a}class dz{constructor(a){this._mintInfo=a,a.nuts[22]&&(this._protectedEnpoints={cache:{},apiReturn:a.nuts[22].protected_endpoints.map(a=>({method:a.method,regex:new RegExp(a.path)}))})}isSupported(a){switch(a){case 4:case 5:return this.checkMintMelt(a);case 7:case 8:case 9:case 10:case 11:case 12:case 14:case 20:return this.checkGenericNut(a);case 17:return this.checkNut17();case 15:return this.checkNut15();default:throw Error("nut is not supported by cashu-ts")}}requiresBlindAuthToken(a){if(!this._protectedEnpoints)return!1;if("boolean"==typeof this._protectedEnpoints.cache[a])return this._protectedEnpoints.cache[a];let b=this._protectedEnpoints.apiReturn.some(b=>b.regex.test(a));return this._protectedEnpoints.cache[a]=b,b}checkGenericNut(a){return this._mintInfo.nuts[a]?.supported?{supported:!0}:{supported:!1}}checkMintMelt(a){let b=this._mintInfo.nuts[a];return b&&b.methods.length>0&&!b.disabled?{disabled:!1,params:b.methods}:{disabled:!0,params:b.methods}}checkNut17(){return this._mintInfo.nuts[17]&&this._mintInfo.nuts[17].supported.length>0?{supported:!0,params:this._mintInfo.nuts[17].supported}:{supported:!1}}checkNut15(){return this._mintInfo.nuts[15]&&this._mintInfo.nuts[15].methods.length>0?{supported:!0,params:this._mintInfo.nuts[15].methods}:{supported:!1}}get contact(){return this._mintInfo.contact}get description(){return this._mintInfo.description}get description_long(){return this._mintInfo.description_long}get name(){return this._mintInfo.name}get pubkey(){return this._mintInfo.pubkey}get nuts(){return this._mintInfo.nuts}get version(){return this._mintInfo.version}get motd(){return this._mintInfo.motd}get supportsBolt12Description(){return this._mintInfo.nuts[4]?.methods.some(a=>"bolt12"===a.method&&a.options?.description===!0)}}class dA{constructor(a,b,c,d){this._mintUrl=a,this._customRequest=b,this._checkNut22=!1,this._mintUrl=c1(a),this._customRequest=b,c&&(this._checkNut22=!0,this._authTokenGetter=c),this._logger=d?.logger??df,dt=this._logger}get mintUrl(){return this._mintUrl}static async getInfo(a,b,c){var d,e;return d=await (b||dw)({endpoint:c0(a,"/v1/info")}),e=c??df,Array.isArray(d?.contact)&&d?.contact.length>0&&(d.contact=d.contact.map(a=>Array.isArray(a)&&2===a.length&&"string"==typeof a[0]&&"string"==typeof a[1]?(e.warn("Mint returned deprecated 'contact' field: Update NUT-06: https://github.com/cashubtc/nuts/pull/117"),{method:a[0],info:a[1]}):a)),d}async getInfo(){return dA.getInfo(this._mintUrl,this._customRequest,this._logger)}async getLazyMintInfo(){if(this._mintInfo)return this._mintInfo;let a=await dA.getInfo(this._mintUrl,this._customRequest);return this._mintInfo=new dz(a),this._mintInfo}static async swap(a,b,c,d){let e=c||dw,f=await e({endpoint:c0(a,"/v1/swap"),method:"POST",requestBody:b,headers:d?{"Blind-auth":d}:{}});if(!c_(f)||!Array.isArray(f?.signatures))throw Error(f.detail??"bad response");return f}async swap(a){let b=await this.handleBlindAuth("/v1/swap");return dA.swap(this._mintUrl,a,this._customRequest,b)}static async createMintQuote(a,b,c,d,e){let f=c||dw;return dy(await f({endpoint:c0(a,"/v1/mint/quote/bolt11"),method:"POST",requestBody:b,headers:d?{"Blind-auth":d}:{}}),e??df)}async createMintQuote(a){let b=await this.handleBlindAuth("/v1/mint/quote/bolt11");return dA.createMintQuote(this._mintUrl,a,this._customRequest,b)}static async createMintQuoteBolt12(a,b,c,d){let e=c||dw;return await e({endpoint:c0(a,"/v1/mint/quote/bolt12"),method:"POST",requestBody:b,headers:d?{"Blind-auth":d}:{}})}async createMintQuoteBolt12(a){let b=await this.handleBlindAuth("/v1/mint/quote/bolt12");return dA.createMintQuoteBolt12(this._mintUrl,a,this._customRequest,b)}static async checkMintQuote(a,b,c,d,e){let f=c||dw;return dy(await f({endpoint:c0(a,"/v1/mint/quote/bolt11",b),method:"GET",headers:d?{"Blind-auth":d}:{}}),e??df)}async checkMintQuote(a){let b=await this.handleBlindAuth(`/v1/mint/quote/bolt11/${a}`);return dA.checkMintQuote(this._mintUrl,a,this._customRequest,b)}static async checkMintQuoteBolt12(a,b,c,d){let e=c||dw;return await e({endpoint:c0(a,"/v1/mint/quote/bolt12",b),method:"GET",headers:d?{"Blind-auth":d}:{}})}async checkMintQuoteBolt12(a){let b=await this.handleBlindAuth(`/v1/mint/quote/bolt12/${a}`);return dA.checkMintQuoteBolt12(this._mintUrl,a,this._customRequest,b)}static async mint(a,b,c,d){let e=c||dw,f=await e({endpoint:c0(a,"/v1/mint/bolt11"),method:"POST",requestBody:b,headers:d?{"Blind-auth":d}:{}});if(!c_(f)||!Array.isArray(f?.signatures))throw Error("bad response");return f}async mint(a){let b=await this.handleBlindAuth("/v1/mint/bolt11");return dA.mint(this._mintUrl,a,this._customRequest,b)}static async mintBolt12(a,b,c,d){let e=c||dw,f=await e({endpoint:c0(a,"/v1/mint/bolt12"),method:"POST",requestBody:b,headers:d?{"Blind-auth":d}:{}});if(!c_(f)||!Array.isArray(f?.signatures))throw Error("bad response");return f}async mintBolt12(a){let b=await this.handleBlindAuth("/v1/mint/bolt12");return dA.mintBolt12(this._mintUrl,a,this._customRequest,b)}static async createMeltQuote(a,b,c,d,e){let f=c||dw,g=dx(await f({endpoint:c0(a,"/v1/melt/quote/bolt11"),method:"POST",requestBody:b,headers:d?{"Blind-auth":d}:{}}),e??df);if(!c_(g)||"number"!=typeof g?.amount||"number"!=typeof g?.fee_reserve||"string"!=typeof g?.quote)throw Error("bad response");return g}async createMeltQuote(a){let b=await this.handleBlindAuth("/v1/melt/quote/bolt11");return dA.createMeltQuote(this._mintUrl,a,this._customRequest,b)}static async createMeltQuoteBolt12(a,b,c,d){let e=c||dw;return await e({endpoint:c0(a,"/v1/melt/quote/bolt12"),method:"POST",requestBody:b,headers:d?{"Blind-auth":d}:{}})}async createMeltQuoteBolt12(a){let b=await this.handleBlindAuth("/v1/melt/quote/bolt12");return dA.createMeltQuoteBolt12(this._mintUrl,a,this._customRequest,b)}static async checkMeltQuote(a,b,c,d,e){let f=c||dw,g=dx(await f({endpoint:c0(a,"/v1/melt/quote/bolt11",b),method:"GET",headers:d?{"Blind-auth":d}:{}}),e??df);if(!c_(g)||"number"!=typeof g?.amount||"number"!=typeof g?.fee_reserve||"string"!=typeof g?.quote||"string"!=typeof g?.state||!Object.values(dl).includes(g.state))throw Error("bad response");return g}async checkMeltQuote(a){let b=await this.handleBlindAuth(`/v1/melt/quote/bolt11/${a}`);return dA.checkMeltQuote(this._mintUrl,a,this._customRequest,b)}static async checkMeltQuoteBolt12(a,b,c,d){let e=c||dw;return await e({endpoint:c0(a,"/v1/melt/quote/bolt12",b),method:"GET",headers:d?{"Blind-auth":d}:{}})}async checkMeltQuoteBolt12(a){let b=await this.handleBlindAuth(`/v1/melt/quote/bolt12/${a}`);return dA.checkMeltQuoteBolt12(this._mintUrl,a,this._customRequest,b)}static async melt(a,b,c,d,e){let f=c||dw,g=dx(await f({endpoint:c0(a,"/v1/melt/bolt11"),method:"POST",requestBody:b,headers:d?{"Blind-auth":d}:{}}),e??df);if(!c_(g)||"string"!=typeof g?.state||!Object.values(dl).includes(g.state))throw Error("bad response");return g}async melt(a){let b=await this.handleBlindAuth("/v1/melt/bolt11");return dA.melt(this._mintUrl,a,this._customRequest,b)}static async meltBolt12(a,b,c,d){let e=c||dw;return await e({endpoint:c0(a,"/v1/melt/bolt12"),method:"POST",requestBody:b,headers:d?{"Blind-auth":d}:{}})}async meltBolt12(a){let b=await this.handleBlindAuth("/v1/melt/bolt12");return dA.meltBolt12(this._mintUrl,a,this._customRequest,b)}static async check(a,b,c){let d=await (c||dw)({endpoint:c0(a,"/v1/checkstate"),method:"POST",requestBody:b});if(!c_(d)||!Array.isArray(d?.states))throw Error("bad response");return d}static async getKeys(a,b,c){b&&(b=b.replace(/\//g,"_").replace(/\+/g,"-"));let d=await (c||dw)({endpoint:b?c0(a,"/v1/keys",b):c0(a,"/v1/keys")});if(!c_(d)||!Array.isArray(d.keysets))throw Error("bad response");return d}async getKeys(a,b){return await dA.getKeys(b||this._mintUrl,a,this._customRequest)}static async getKeySets(a,b){return(b||dw)({endpoint:c0(a,"/v1/keysets")})}async getKeySets(){return dA.getKeySets(this._mintUrl,this._customRequest)}async check(a){return dA.check(this._mintUrl,a,this._customRequest)}static async restore(a,b,c){let d=await (c||dw)({endpoint:c0(a,"/v1/restore"),method:"POST",requestBody:b});if(!c_(d)||!Array.isArray(d?.outputs)||!Array.isArray(d?.signatures))throw Error("bad response");return d}async restore(a){return dA.restore(this._mintUrl,a,this._customRequest)}async connectWebSocket(){if(this.ws)await this.ws.ensureConnection();else{let a=new URL(this._mintUrl),b="v1/ws";a.pathname&&(a.pathname.endsWith("/")?a.pathname+=b:a.pathname+="/"+b),this.ws=di.getInstance().getConnection(`${"https:"===a.protocol?"wss":"ws"}://${a.host}${a.pathname}`);try{await this.ws.connect()}catch(a){throw this._logger.error("Failed to connect to WebSocket...",{e:a}),Error("Failed to connect to WebSocket...")}}}disconnectWebSocket(){this.ws&&this.ws.close()}get webSocketConnection(){return this.ws}async handleBlindAuth(a){if(this._checkNut22&&(await this.getLazyMintInfo()).requiresBlindAuthToken(a)){if(!this._authTokenGetter)throw Error("Can not call a protected endpoint without authProofGetter");return this._authTokenGetter()}}}class dB{constructor(a,b,c){this.amount=a,this.B_=b,this.id=c}getSerializedBlindedMessage(){return{amount:this.amount,B_:this.B_.toHex(!0),id:this.id}}}function dC(a){return"function"==typeof a}let dD=new Set(["locktime","pubkeys","n_sigs","refund","n_sigs_refund"]);class dE{constructor(a,b,c){this.secret=c,this.blindingFactor=b,this.blindedMessage=a}toProof(a,b){let c,d;a.dleq&&(c={s:t(a.dleq.s),e:t(a.dleq.e),r:this.blindingFactor});let e={id:a.id,amount:a.amount,C_:bT(a.C_)},f=bT(b.keys[a.amount]);return{...{amount:(d=function(a,b,c,d){var e;let f=(e=a.C_,e.subtract(d.multiply(b)));return{id:a.id,amount:a.amount,secret:c,C:f}}(e,this.blindingFactor,this.secret,f)).amount,C:d.C.toHex(!0),id:d.id,secret:new TextDecoder().decode(d.secret),witness:JSON.stringify(d.witness)},...c&&{dleq:{s:q(c.s),e:q(c.e),r:(c.r??BigInt(0)).toString(16).padStart(64,"0")}}}}static createP2PKData(a,b,c,d){return cL(b,c.keys,d).map(b=>this.createSingleP2PKData(a,b,c.id))}static createSingleP2PKData(a,b,c){let d=Array.isArray(a.pubkey)?a.pubkey:[a.pubkey],e=a.refundKeys??[],f=Math.max(1,Math.min(a.requiredSignatures??1,d.length)),g=Math.max(1,Math.min(a.requiredRefundSignatures??1,e.length||1)),h=d[0],i=d.slice(1),j=[],k=a.locktime??NaN;if(Number.isSafeInteger(k)&&k>=0&&j.push(["locktime",String(k)]),i.length>0&&(j.push(["pubkeys",...i]),f>1&&j.push(["n_sigs",String(f)])),e.length>0&&(j.push(["refund",...e]),g>1&&j.push(["n_sigs_refund",String(g)])),a.additionalTags?.length){let b=a.additionalTags.map(([a,...b],c)=>{if("string"!=typeof a||!a)throw Error(`additionalTags[${c}][0] must be a non empty string`);if(dD.has(a))throw Error(`additionalTags must not use reserved key "${a}"`);return[a,...b.map(String)]});j.push(...b)}let l=JSON.stringify(["P2PK",{nonce:q(z(32)),data:h,tags:j}]),m=[...l].length;if(m>1024)throw Error(`Secret too long (${m} characters), maximum is 1024`);let n=new TextEncoder().encode(l),{r:o,B_:p}=cE(n);return new dE(new dB(b,p,c).getSerializedBlindedMessage(),o,n)}static createRandomData(a,b,c){return cL(a,b.keys,c).map(a=>this.createSingleRandomData(a,b.id))}static createSingleRandomData(a,b){let c=q(z(32)),d=new TextEncoder().encode(c),{r:e,B_:f}=cE(d);return new dE(new dB(a,f,b).getSerializedBlindedMessage(),e,d)}static createDeterministicData(a,b,c,d,e){return cL(a,d.keys,e).map((a,e)=>this.createSingleDeterministicData(a,b,c+e,d.id))}static createSingleDeterministicData(a,b,c,d){let e=q(((a,b,c)=>{let d=/^[a-fA-F0-9]+$/.test(b);if(!d&&cy(b)||d&&b.startsWith("00"))return cA(a,b,c,0);if(d&&b.startsWith("01"))return cz(a,b,c,0);throw Error(`Unrecognized keyset ID version ${b.slice(0,2)}`)})(b,d,c)),f=new TextEncoder().encode(e),{r:g,B_:h}=cE(f,cO(q(((a,b,c)=>{let d=/^[a-fA-F0-9]+$/.test(b);if(!d&&cy(b)||d&&b.startsWith("00"))return cA(a,b,c,1);if(d&&b.startsWith("01"))return cz(a,b,c,1);throw Error(`Unrecognized keyset ID version ${b.slice(0,2)}`)})(b,d,c))));return new dE(new dB(a,h,d).getSerializedBlindedMessage(),g,f)}}class dF{constructor(a,b){this._keys=new Map,this._keysets=[],this._seed=void 0,this._unit="sat",this._mintInfo=void 0,this._denominationTarget=3,this.mint=a,this._logger=b?.logger??df,this._logger.warn("cashu-ts v3 has been released. Please upgrade to access the latest features. v2 is now in minimal maintenance mode.");let c=[];if(b?.keys&&!Array.isArray(b.keys)?c=[b.keys]:b?.keys&&Array.isArray(b?.keys)&&(c=b?.keys),c&&c.forEach(a=>this._keys.set(a.id,a)),b?.unit&&(this._unit=b?.unit),b?.keysets&&(this._keysets=b.keysets),b?.mintInfo&&(this._mintInfo=new dz(b.mintInfo)),b?.denominationTarget&&(this._denominationTarget=b.denominationTarget),b?.bip39seed){if(b.bip39seed instanceof Uint8Array){this._seed=b.bip39seed;return}throw Error("bip39seed must be a valid UInt8Array")}b?.keepFactory&&(this._keepFactory=b.keepFactory)}get unit(){return this._unit}get keys(){return this._keys}get keysetId(){if(!this._keysetId)throw Error("No keysetId set");return this._keysetId}set keysetId(a){this._keysetId=a}get keysets(){return this._keysets}get mintInfo(){if(!this._mintInfo)throw Error("Mint info not loaded");return this._mintInfo}async getMintInfo(){let a=await this.mint.getInfo();return this._mintInfo=new dz(a),this._mintInfo}async lazyGetMintInfo(){return this._mintInfo?this._mintInfo:await this.getMintInfo()}async loadMint(){await Promise.all([this.getMintInfo(),this.getKeys()])}getActiveKeyset(a){let b=a.filter(a=>a.active&&a.unit===this._unit),c=(b=b.filter(a=>cP(a.id))).sort((a,b)=>(a.input_fee_ppk??0)-(b.input_fee_ppk??0))[0];if(!c)throw Error("No active keyset found");return c}async getKeySets(){let a=(await this.mint.getKeySets()).keysets.filter(a=>a.unit===this._unit);return this._keysets=a,this._keysets}async getAllKeys(){let a=await this.mint.getKeys();return a.keysets.forEach(a=>{if(!c7(a))throw Error(`Couldn't verify keyset ID ${a.id}`)}),this._keys=new Map(a.keysets.map(a=>[a.id,a])),this.keysetId=this.getActiveKeyset(this._keysets).id,a.keysets}async getKeys(a,b){if((!(this._keysets.length>0)||b)&&await this.getKeySets(),a||(a=this.getActiveKeyset(this._keysets).id),!this._keysets.find(b=>b.id===a)&&(await this.getKeySets(),!this._keysets.find(b=>b.id===a)))throw Error(`could not initialize keys. No keyset with id '${a}' found`);if(!this._keys.get(a)){let b=await this.mint.getKeys(a);if(!c7(b.keysets[0]))throw Error(`Couldn't verify keyset ID ${b.keysets[0].id}`);this._keys.set(a,b.keysets[0])}return this.keysetId=a,this._keys.get(a)}async receive(a,b){let c,{requireDleq:d,keysetId:e,outputAmounts:f,counter:g,pubkey:h,privkey:i,outputData:j,p2pk:k}=b||{};0===this._keysets.length&&await this.getKeySets(),"string"==typeof a&&(a=cW(a,this._keysets));let l=await this.getKeys(e);if(d&&a.proofs.some(a=>!c8(a,l)))throw Error("Token contains proofs with invalid DLEQ");let m=c2(a.proofs)-this.getFeesForProofs(a.proofs);j?c={send:j}:this._keepFactory&&(c={send:this._keepFactory});let n=this.createSwapPayload(m,a.proofs,l,f,g,h,i,c,k),{signatures:o}=await this.mint.swap(n.payload),p=n.outputData.map((a,b)=>a.toProof(o[b],l)),q=[];return n.sortedIndices.forEach((a,b)=>{q[a]=p[b]}),q}async send(a,b,c){let{offline:d,includeFees:e,includeDleq:f,keysetId:g,outputAmounts:h,pubkey:i,privkey:j,outputData:k}=c||{};if(f&&(b=b.filter(a=>null!=a.dleq)),c2(b)<a)throw Error("Not enough funds available to send");let{keep:l,send:m}=this.selectProofsToSend(b,a,c?.includeFees),n=e?this.getFeesForProofs(m):0;if(!d&&(c2(m)!=a+n||h||i||j||g||k)){let d=await this.swap(a,b,c),{keep:e,send:f}=d;return{keep:e,send:f,serialized:d.serialized}}if(c2(m)<a+n)throw Error("Not enough funds available to send");return{keep:l,send:m}}selectProofsToSend(a,b,c=!1){let d=function(){let a=Date.now();return{elapsed:()=>Date.now()-a}}(),e=null,f=1/0,g=0,h=0,i=(a,b)=>a-(c?Math.ceil(b/1e3):0),j=a=>{let b=[...a];for(let a=b.length-1;a>0;a--){let c=Math.floor(Math.random()*(a+1));[b[a],b[c]]=[b[c],b[a]]}return b},k=(a,b,c)=>{let d=0,e=a.length-1,f=null;for(;d<=e;){let g=Math.floor((d+e)/2),h=a[g].exFee;(c?h<=b:h>=b)?(f=g,c?d=g+1:e=g-1):c?e=g-1:d=g+1}return c?f:d<a.length?d:null},l=(a,b)=>{let c=b.exFee,d=0,e=a.length;for(;d<e;){let b=Math.floor((d+e)/2);a[b].exFee<c?d=b+1:e=b}a.splice(d,0,b)},m=(a,c)=>i(a,c)<b?1/0:a+c/1e3-b,n=0,o=0,p=a.map(a=>{let b=this.getProofFeePPK(a),d=c?a.amount-b/1e3:a.amount;return(!c||d>0)&&(n+=a.amount,o+=b),{proof:a,exFee:d,ppkfee:b}}),q=c?p.filter(a=>a.exFee>0):p;if(q.sort((a,b)=>a.exFee-b.exFee),q.length>0){let a;{let c=k(q,b,!1);if(null!==c){let b=q[c].exFee,d=k(q,b,!0);if(null===d)throw Error("Unexpected null rightIndex in binary search");a=d+1}else a=q.length}for(let b=a;b<q.length;b++)n-=q[b].proof.amount,o-=q[b].ppkfee;q=q.slice(0,a)}let r=i(n,o);if(b<=0||b>r)return{keep:a,send:[]};let s=Math.min(Math.ceil(+b),b+0,r);for(let a=0;a<60;a++){let c=[],n=0,o=0;for(let a of j(q)){let d=n+a.proof.amount,e=o+a.ppkfee,f=i(d,e);if(c.push(a),n=d,o=e,f>=b)break}let p=new Set(c),r=q.filter(a=>!p.has(a));for(let a of j(Array.from({length:c.length},(a,b)=>b)).slice(0,5e3)){let d=i(n,o);if(d===b||d>=b&&d<=s)break;let e=c[a],f=n-e.proof.amount,g=o-e.ppkfee,h=b-i(f,g),j=k(r,h,!1);if(null!==j){let b=r[j];(h>=0||b.exFee<=e.exFee)&&(c[a]=b,n=f+b.proof.amount,o=g+b.ppkfee,r.splice(j,1),l(r,e))}}let t=m(n,o);if(t<f){this._logger.debug("selectProofsToSend: best solution found in trial #{trial} - amount: {amount}, delta: {delta}",{trial:a,amount:n,delta:t}),e=[...c].sort((a,b)=>b.exFee-a.exFee),f=t,g=n,h=o;let b=[...e];for(;b.length>1&&f>0;){let a=b.pop(),c=n-a.proof.amount,d=o-a.ppkfee,i=m(c,d);if(i==1/0)break;i<f&&(e=[...b],f=i,g=c,h=d,n=c,o=d)}}if(e&&f<1/0){let a=i(g,h);if(a===b||a>=b&&a<=s)break}if(d.elapsed()>1e3){this._logger.warn("Proof selection took too long. Returning best selection so far.");break}}if(e&&f<1/0){let b=e.map(a=>a.proof),c=new Set(b),f=a.filter(a=>!c.has(a));return this._logger.info("Proof selection took {time}ms",{time:d.elapsed()}),{keep:f,send:b}}return{keep:a,send:[]}}getFeesForProofs(a){return Math.ceil(a.reduce((a,b)=>a+this.getProofFeePPK(b),0)/1e3)}getProofFeePPK(a){let b=this._keysets.find(b=>b.id===a.id);if(!b)throw Error(`Could not get fee. No keyset found for keyset id: ${a.id}`);return b?.input_fee_ppk||0}getFeesForKeyset(a,b){return Math.floor(Math.max((a*(this._keysets.find(a=>a.id===b)?.input_fee_ppk||0)+999)/1e3,0))}async swap(a,b,c){let d,{outputAmounts:e}=c||{},{includeFees:f,keysetId:g,counter:h,pubkey:i,privkey:j,proofsWeHave:k,outputData:l,p2pk:m}=c||{},n=await this.getKeys(g),o=a,p=c2(b),q=e?.sendAmounts||cL(o,n.keys);if(f){let a=this.getFeesForKeyset(q.length,n.id),b=cL(a,n.keys);for(;this.getFeesForKeyset(q.concat(b).length,n.id)>a;)b=cL(++a,n.keys);q=q.concat(b),o+=a}let{keep:r,send:s}=this.selectProofsToSend(b,o,!0),t=c2(s)-this.getFeesForProofs(s)-o;if(t<0)throw Error("Not enough balance to send");if(e?.keepAmounts||k){if(!e?.keepAmounts&&k)d=cM(k,t,n.keys,this._denominationTarget);else if(e){if(e.keepAmounts?.reduce((a,b)=>a+b,0)!=t)throw Error("Keep amounts do not match amount to keep");d=e.keepAmounts}}else d=cL(t,n.keys);if(o+this.getFeesForProofs(s)>p)throw this._logger.error(`Not enough funds available (${p}) for swap amountToSend: ${o} + fee: ${this.getFeesForProofs(s)} | length: ${s.length}`),Error("Not enough funds available for swap");e={keepAmounts:d,sendAmounts:q};let u=l?.keep||this._keepFactory,v=l?.send,w=this.createSwapPayload(o,s,n,e,h,i,j,{keep:u,send:v},m),{signatures:x}=await this.mint.swap(w.payload),y=w.outputData.map((a,b)=>a.toProof(x[b],n)),z=[],A=[],B=Array(w.keepVector.length),C=Array(y.length);return w.sortedIndices.forEach((a,b)=>{B[a]=w.keepVector[b],C[a]=y[b]}),C.forEach((a,b)=>{B[b]?z.push(a):A.push(a)}),{keep:[...z,...r],send:A}}async batchRestore(a=300,b=100,c=0,d){let e=Math.ceil(a/b),f=[],g,h=0;for(;h<e;){let a=await this.restore(c,b,{keysetId:d});a.proofs.length>0?(h=0,f.push(...a.proofs),g=a.lastCounterWithSignature):h++,c+=b}return{proofs:f,lastCounterWithSignature:g}}async restore(a,b,c){let d,{keysetId:e}=c||{},f=await this.getKeys(e);if(!this._seed)throw Error("CashuWallet must be initialized with a seed to use restore");let g=Array(b).fill(0),h=dE.createDeterministicData(0,this._seed,a,f,g),{outputs:i,signatures:j}=await this.mint.restore({outputs:h.map(a=>a.blindedMessage)}),k={};i.forEach((a,b)=>k[a.B_]=j[b]);let l=[];for(let b=0;b<h.length;b++){let c=k[h[b].blindedMessage.B_];c&&(d=a+b,h[b].blindedMessage.amount=c.amount,l.push(h[b].toProof(c,f)))}return{proofs:l,lastCounterWithSignature:d}}async createMintQuote(a,b){let c={unit:this._unit,amount:a,description:b},d=await this.mint.createMintQuote(c);return{...d,amount:d.amount||a,unit:d.unit||this.unit}}async createLockedMintQuote(a,b,c){let{supported:d}=(await this.lazyGetMintInfo()).isSupported(20);if(!d)throw Error("Mint does not support NUT-20");let e={unit:this._unit,amount:a,description:c,pubkey:b},f=await this.mint.createMintQuote(e);if("string"!=typeof f.pubkey)throw Error("Mint returned unlocked mint quote");{let b=f.pubkey;return{...f,pubkey:b,amount:f.amount||a,unit:f.unit||this.unit}}}async createMintQuoteBolt12(a,b){let c=await this.lazyGetMintInfo();if(b?.description&&!c.supportsBolt12Description)throw Error("Mint does not support description for bolt12");let d={pubkey:a,unit:this._unit,amount:b?.amount,description:b?.description};return this.mint.createMintQuoteBolt12(d)}async checkMintQuote(a){let b="string"==typeof a?a:a.quote,c=await this.mint.checkMintQuote(b);return"string"==typeof a?c:{...c,amount:c.amount||a.amount,unit:c.unit||a.unit}}async checkMintQuoteBolt12(a){return this.mint.checkMintQuoteBolt12(a)}async mintProofs(a,b,c){return this._mintProofs("bolt11",a,b,c)}async mintProofsBolt12(a,b,c,d){return this._mintProofs("bolt12",a,b,{...d,privateKey:c})}async createMeltQuote(a){let b={unit:this._unit,request:a},c=await this.mint.createMeltQuote(b);return{...c,unit:c.unit||this.unit,request:c.request||a}}async createMeltQuoteBolt12(a,b){return this.mint.createMeltQuoteBolt12({unit:this._unit,request:a,options:b?{amountless:{amount_msat:b}}:void 0})}async createMultiPathMeltQuote(a,b){let{supported:c,params:d}=(await this.lazyGetMintInfo()).isSupported(15);if(!c)throw Error("Mint does not support NUT-15");if(!d?.some(a=>"bolt11"===a.method&&a.unit===this.unit))throw Error(`Mint does not support MPP for bolt11 and ${this.unit}`);let e={unit:this._unit,request:a,options:{mpp:{amount:b}}};return{...await this.mint.createMeltQuote(e),request:a,unit:this._unit}}async checkMeltQuote(a){let b="string"==typeof a?a:a.quote,c=await this.mint.checkMeltQuote(b);return"string"==typeof a?c:{...c,request:a.request,unit:a.unit}}async checkMeltQuoteBolt12(a){return this.mint.checkMeltQuoteBolt12(a)}async meltProofs(a,b,c){return this._meltProofs("bolt11",a,b,c)}async meltProofsBolt12(a,b,c){return this._meltProofs("bolt12",a,b,c)}createSwapPayload(a,b,c,d,e,f,g,h,i){let j=b.reduce((a,b)=>a+b.amount,0);d&&d.sendAmounts&&!d.keepAmounts&&(d.keepAmounts=cL(j-a-this.getFeesForProofs(b),c.keys));let k=j-a-this.getFeesForProofs(b),l=[],m=[];if(h?.keep)if(dC(h.keep)){let a=h.keep;cL(k,c.keys).forEach(b=>{l.push(a(b,c))})}else l=h.keep;else l=this.createOutputData(k,c,e,void 0,d?.keepAmounts,void 0,this._keepFactory);if(h?.send)if(dC(h.send)){let b=h.send;cL(a,c.keys).forEach(a=>{m.push(b(a,c))})}else m=h.send;else m=this.createOutputData(a,c,e?e+l.length:void 0,f,d?.sendAmounts,i);g&&(b=cC(b,g)),b=(b=c6(b)).map(a=>{let b=a.witness&&"string"!=typeof a.witness?JSON.stringify(a.witness):a.witness;return{...a,witness:b}});let n=[...l,...m],o=n.map((a,b)=>b).sort((a,b)=>n[a].blindedMessage.amount-n[b].blindedMessage.amount),p=[...Array.from({length:l.length},()=>!0),...Array.from({length:m.length},()=>!1)],q=o.map(a=>n[a]),r=o.map(a=>p[a]);return{payload:{inputs:b,outputs:q.map(a=>a.blindedMessage)},outputData:q,keepVector:r,sortedIndices:o}}async checkProofsStates(a){let b=new TextEncoder,c=a.map(a=>bS(b.encode(a.secret)).toHex(!0)),d=[];for(let a=0;a<c.length;a+=100){let b=c.slice(a,a+100),{states:e}=await this.mint.check({Ys:b}),f={};e.forEach(a=>{f[a.Y]=a});for(let a=0;a<b.length;a++){let c=f[b[a]];if(!c)throw Error("Could not find state for proof with Y: "+b[a]);d.push(c)}}return d}async onMintQuoteUpdates(a,b,c){if(await this.mint.connectWebSocket(),!this.mint.webSocketConnection)throw Error("failed to establish WebSocket connection.");let d=this.mint.webSocketConnection.createSubscription({kind:"bolt11_mint_quote",filters:a},b,c);return()=>{this.mint.webSocketConnection?.cancelSubscription(d,b)}}async onMeltQuotePaid(a,b,c){return this.onMeltQuoteUpdates([a],a=>{a.state===dl.PAID&&b(a)},c)}async onMintQuotePaid(a,b,c){return this.onMintQuoteUpdates([a],a=>{a.state===dm.PAID&&b(a)},c)}async onMeltQuoteUpdates(a,b,c){if(await this.mint.connectWebSocket(),!this.mint.webSocketConnection)throw Error("failed to establish WebSocket connection.");let d=this.mint.webSocketConnection.createSubscription({kind:"bolt11_melt_quote",filters:a},b,c);return()=>{this.mint.webSocketConnection?.cancelSubscription(d,b)}}async onProofStateUpdates(a,b,c){if(await this.mint.connectWebSocket(),!this.mint.webSocketConnection)throw Error("failed to establish WebSocket connection.");let d=new TextEncoder,e={};for(let b=0;b<a.length;b++)e[bS(d.encode(a[b].secret)).toHex(!0)]=a[b];let f=Object.keys(e),g=this.mint.webSocketConnection.createSubscription({kind:"proof_state",filters:f},a=>{b({...a,proof:e[a.Y]})},c);return()=>{this.mint.webSocketConnection?.cancelSubscription(g,b)}}createOutputData(a,b,c,d,e,f,g){let h;if(d)h=dE.createP2PKData({pubkey:d,additionalTags:f?.additionalTags},a,b,e);else if(c||0===c){if(!this._seed)throw Error("cannot create deterministic messages without seed");h=dE.createDeterministicData(a,this._seed,c,b,e)}else h=f?dE.createP2PKData(f,a,b,e):g?cL(a,b.keys).map(a=>g(a,b)):dE.createRandomData(a,b,e);return h}createBlankOutputs(a,b,c,d){let e=Math.ceil(Math.log2(a))||1;e<0&&(e=0);let f=e?Array(e).fill(0):[];return this.createOutputData(0,b,c,void 0,f,void 0,d)}async _mintProofs(a,b,c,d){let{outputAmounts:e}=d||{},{counter:f,pubkey:g,p2pk:h,keysetId:i,proofsWeHave:j,outputData:k,privateKey:l}=d||{},m=await this.getKeys(i);!e&&j&&(e={keepAmounts:cM(j,b,m.keys,this._denominationTarget),sendAmounts:[]});let n=[];if(k)if(dC(k)){let a=cL(b,m.keys,e?.keepAmounts);for(let b=0;b<a.length;b++)n.push(k(a[b],m))}else n=k;else if(this._keepFactory){let a=cL(b,m.keys,e?.keepAmounts);for(let b=0;b<a.length;b++)n.push(this._keepFactory(a[b],m))}else n=this.createOutputData(b,m,f,g,e?.keepAmounts,h);let o=n.map(a=>a.blindedMessage),p={outputs:o,quote:"string"==typeof c?c:c.quote};if("string"!=typeof c&&c.pubkey){if(!l)throw Error("Can not sign locked quote without private key");p.signature=function(a,b,c){let d=function(a,b){let c=a;for(let a of b)c+=a.B_;return ab(new TextEncoder().encode(c))}(b,c),e=t(a);return q(bA.sign(d,e))}(l,c.quote,o)}if("bolt12"===a){let{signatures:a}=await this.mint.mintBolt12(p);return n.map((b,c)=>b.toProof(a[c],m))}let{signatures:r}=await this.mint.mint(p);return n.map((a,b)=>a.toProof(r[b],m))}async _meltProofs(a,b,c,d){let{keysetId:e,counter:f,privkey:g}=d||{},h=await this.getKeys(e),i=this.createBlankOutputs(c2(c)-b.amount,h,f,this._keepFactory);null!=g&&(c=cC(c,g)),c=(c=c6(c)).map(a=>{let b=a.witness&&"string"!=typeof a.witness?JSON.stringify(a.witness):a.witness;return{...a,witness:b}});let j={quote:b.quote,inputs:c,outputs:i.map(a=>a.blindedMessage)};if("bolt12"===a){let a=await this.mint.meltBolt12(j);return{quote:{...a,unit:b.unit,request:b.request},change:a.change?.map((a,b)=>i[b].toProof(a,h))??[]}}let k=await this.mint.melt(j);return{quote:{...k,unit:b.unit,request:b.request},change:k.change?.map((a,b)=>i[b].toProof(a,h))??[]}}}class dG{constructor(a,b){this._mintUrl=a,this._customRequest=b,this._mintUrl=c1(a),this._customRequest=b}get mintUrl(){return this._mintUrl}static async mint(a,b,c,d){let e=d||dw,f={"Clear-auth":`${c}`},g=await e({endpoint:c0(a,"/v1/auth/blind/mint"),method:"POST",requestBody:b,headers:f});if(!c_(g)||!Array.isArray(g?.signatures))throw Error("bad response");return g}async mint(a,b){return dG.mint(this._mintUrl,a,b,this._customRequest)}static async getKeys(a,b,c){let d=await (c||dw)({endpoint:b?c0(a,"/v1/auth/blind/keys",b):c0(a,"/v1/auth/blind/keys")});if(!c_(d)||!Array.isArray(d.keysets))throw Error("bad response");return d}async getKeys(a,b){return await dG.getKeys(b||this._mintUrl,a,this._customRequest)}static async getKeySets(a,b){return(b||dw)({endpoint:c0(a,"/v1/auth/blind/keysets")})}async getKeySets(){return dG.getKeySets(this._mintUrl,this._customRequest)}}class dH{constructor(a,b){this._keys=new Map,this._keysets=[],this._unit="auth",this.mint=a;let c=[];b?.keys&&!Array.isArray(b.keys)?c=[b.keys]:b?.keys&&Array.isArray(b?.keys)&&(c=b?.keys),c&&c.forEach(a=>this._keys.set(a.id,a)),b?.keysets&&(this._keysets=b.keysets)}get keys(){return this._keys}get keysetId(){if(!this._keysetId)throw Error("No keysetId set");return this._keysetId}set keysetId(a){this._keysetId=a}get keysets(){return this._keysets}async loadMint(){await this.getKeySets(),await this.getKeys()}getActiveKeyset(a){let b=a.filter(a=>a.active),c=(b=b.filter(a=>a.id.startsWith("00"))).sort((a,b)=>(a.input_fee_ppk??0)-(b.input_fee_ppk??0))[0];if(!c)throw Error("No active keyset found");return c}async getKeySets(){let a=(await this.mint.getKeySets()).keysets.filter(a=>a.unit===this._unit);return this._keysets=a,this._keysets}async getAllKeys(){let a=await this.mint.getKeys();return this._keys=new Map(a.keysets.map(a=>[a.id,a])),this.keysetId=this.getActiveKeyset(this._keysets).id,a.keysets}async getKeys(a,b){if((!(this._keysets.length>0)||b)&&await this.getKeySets(),a||(a=this.getActiveKeyset(this._keysets).id),!this._keysets.find(b=>b.id===a)&&(await this.getKeySets(),!this._keysets.find(b=>b.id===a)))throw Error(`could not initialize keys. No keyset with id '${a}' found`);if(!this._keys.get(a)){let b=await this.mint.getKeys(a);this._keys.set(a,b.keysets[0])}return this.keysetId=a,this._keys.get(a)}async mintProofs(a,b,c){let d=await this.getKeys(c?.keysetId),e=dE.createRandomData(a,d),f={outputs:e.map(a=>a.blindedMessage)},{signatures:g}=await this.mint.mint(f,b),h=e.map((a,b)=>a.toProof(g[b],d));if(h.some(a=>!c8(a,d)))throw Error("Mint returned auth proofs with invalid DLEQ");return h}}function dI(a){return"authA"+cx({id:a.id,secret:a.secret,C:a.C})}async function dJ(a,b,c){let d=new dG(b);return(await new dH(d).mintProofs(a,c)).map(a=>dI(a))}}];

//# sourceMappingURL=node_modules_%40cashu_cashu-ts_lib_cashu-ts_es_39249eb5.js.map