{"version":3,"sources":["turbopack:///[project]/src/integrations/cashu/direct.ts"],"sourcesContent":["/**\n * Direct Cashu integration following standalone script pattern exactly\n * Receive token ONCE, then use received proofs for all operations\n */\n\n/**\n * Server-side Cashu operations following standalone script pattern exactly\n * 1. Receive token ONCE and immediately melt (with built-in retry)\n * 2. Retry capability built into single API call\n * 3. Never try to receive same token twice\n */\nexport async function serverSideCashuMelt(\n    encodedToken: string,\n    invoice: string,\n    quoteId?: string // Optional for backward compatibility\n): Promise<{ success: true; result: { invoiceAmount: number; change: any[]; changeAmount: number; mintUrl: string } } | { success: false; error: string; details?: any }> {\n    try {\n        console.log('üîç Server-side Cashu Melt: Starting single-API melt with retry...');\n\n        const response = await fetch('/api/cashu/receive-and-melt', {\n            method: 'POST',\n            headers: {\n                'Content-Type': 'application/json',\n            },\n            body: JSON.stringify({\n                encodedToken,\n                invoice\n            }),\n        });\n\n        const data = await response.json();\n\n        if (!response.ok) {\n            console.error('‚ùå Server-side Cashu Melt: API error:', data);\n\n            // Handle specific insufficient balance error\n            if (data.error === 'INSUFFICIENT_BALANCE') {\n                return {\n                    success: false,\n                    error: 'Insufficient balance for invoice + fees',\n                    details: data.details\n                };\n            }\n\n            return {\n                success: false,\n                error: data.error || 'Server-side melt failed'\n            };\n        }\n\n        console.log('‚úÖ Server-side Cashu Melt: Completed successfully:', data.result);\n\n        return {\n            success: true,\n            result: data.result\n        };\n\n    } catch (error) {\n        console.error('‚ùå Server-side Cashu Melt: Network error:', error);\n        return {\n            success: false,\n            error: error instanceof Error ? error.message : 'Network error during melt'\n        };\n    }\n}\n\n/**\n * Pre-calculate maximum invoice amount that will fit in token balance\n * Uses fee formula: max(2 sats, 0.01 * amount) + 1\n */\nexport async function calculateMaxInvoiceAmount(encodedToken: string): Promise<{ success: true; maxAmount: number; availableBalance: number } | { success: false; error: string }> {\n    try {\n        console.log('üßÆ Calculating max invoice amount from token balance...');\n\n        // Import here to avoid issues if running client-side\n        const { getDecodedToken } = await import('@cashu/cashu-ts');\n\n        // Decode token to get available balance\n        const decoded = getDecodedToken(encodedToken);\n        const availableBalance = decoded.proofs.reduce((sum: number, p: any) => sum + p.amount, 0);\n\n        // Use fee formula to estimate fees: max(2 sats, 0.01 * amount) + 1\n        // We need to solve: amount + max(2, 0.01 * amount) + 1 <= availableBalance\n        // Since fee grows with amount, we use iterative approach\n\n        let maxAmount = 0;\n        for (let testAmount = 1; testAmount <= availableBalance; testAmount++) {\n            const estimatedFee = Math.max(2, Math.ceil(0.01 * testAmount)) + 1;\n            const totalRequired = testAmount + estimatedFee;\n\n            if (totalRequired <= availableBalance) {\n                maxAmount = testAmount;\n            } else {\n                break; // Found the limit\n            }\n        }\n\n        console.log('‚úÖ Max invoice calculation:', {\n            availableBalance,\n            maxAmount,\n            estimatedFee: Math.max(2, Math.ceil(0.01 * maxAmount)) + 1\n        });\n\n        return {\n            success: true,\n            maxAmount,\n            availableBalance\n        };\n\n    } catch (error) {\n        console.error('‚ùå Failed to calculate max invoice amount:', error);\n        return {\n            success: false,\n            error: error instanceof Error ? error.message : 'Calculation failed'\n        };\n    }\n}\n\n/**\n * Helper function to retrieve encoded token from storage\n */\nexport async function getEncodedTokenFromStorage(quoteId: string): Promise<string | null> {\n    console.log('üîç Getting encoded token from storage for quote:', quoteId);\n\n    try {\n        // Try browser localStorage first\n        if (typeof window !== 'undefined') {\n            const key = `slpm:cashu-token:${quoteId}`;\n            const token = window.localStorage.getItem(key);\n            if (token) {\n                console.log('‚úÖ Found token in localStorage');\n                return token;\n            }\n        }\n\n        // Try server-side storage\n        if (typeof window === 'undefined') {\n            try {\n                const { default: TokenVault } = await import('@/storage/tokenVault.server');\n                const tokenData = await TokenVault.get(quoteId);\n                if (tokenData?.token) {\n                    console.log('‚úÖ Found token in server vault');\n                    return tokenData.token;\n                }\n            } catch (e) {\n                console.warn('‚ö†Ô∏è Could not access server vault:', e);\n            }\n        }\n\n        console.warn('‚ùå No encoded token found for quote:', quoteId);\n        return null;\n\n    } catch (error) {\n        console.error('‚ùå Error retrieving encoded token:', error);\n        return null;\n    }\n}"],"names":[],"mappings":"wCAWO,eAAe,EAClB,CAAoB,CACpB,CAAe,CACf,CAAiB,EAEjB,GAAI,CACA,QAAQ,GAAG,CAAC,oBAHuC,iDAKnD,IAAM,EAAW,MAAM,MAAM,8BAA+B,CACxD,OAAQ,OACR,QAAS,CACL,eAAgB,kBACpB,EACA,KAAM,KAAK,SAAS,CAAC,cACjB,UACA,CACJ,EACJ,GAEM,EAAO,MAAM,EAAS,IAAI,GAEhC,GAAI,CAAC,EAAS,EAAE,CAAE,CAId,GAHA,QAAQ,KAAK,CAAC,uCAAwC,GAGnC,wBAAwB,CAAvC,EAAK,KAAK,CACV,MAAO,CACH,SAAS,EACT,MAAO,0CACP,QAAS,EAAK,OAAO,AACzB,EAGJ,MAAO,CACH,SAAS,EACT,MAAO,EAAK,KAAK,EAAI,yBACzB,CACJ,CAIA,OAFA,QAAQ,GAAG,CAAC,oDAAqD,EAAK,MAAM,EAErE,CACH,SAAS,EACT,OAAQ,EAAK,MAAM,AACvB,CAEJ,CAAE,MAAO,EAAO,CAEZ,OADA,QAAQ,KAAK,CAAC,2CAA4C,GACnD,CACH,SAAS,EACT,MAAO,aAAiB,MAAQ,EAAM,OAAO,CAAG,2BACpD,CACJ,CACJ,CAMO,eAAe,EAA0B,CAAoB,EAChE,GAAI,CACA,QAAQ,GAAG,CAAC,2DAGZ,GAAM,iBAAE,CAAe,CAAE,CAAG,MAAA,EAAA,CAAA,CAAA,OAItB,EADU,AACS,EADO,GACC,MAAM,CAAC,MAAM,CAAC,CAAC,EAAa,IAAW,EAAM,EAAE,MAAM,CAAE,GAMpF,EAAY,EAChB,IAAK,IAAI,EAAa,EAAG,GAAc,EAAkB,IAAc,CACnE,IAAM,EAAe,KAAK,GAAG,CAAC,EAAG,KAAK,IAAI,CAAC,IAAO,IAAe,EAGjE,GAFsB,AAElB,EAF+B,GAEd,EACjB,EAAY,OAEZ,KAER,CAQA,CAVe,AAH4B,MAO3C,QAAQ,GAAG,CAJsB,AAIrB,6BAA8B,kBACtC,YACA,EACA,aAAc,KAAK,GAAG,CAAC,EAAG,KAAK,IAAI,CAAC,IAAO,IAAc,CAC7D,GAEO,CACH,SAAS,YACT,EACA,kBACJ,CAEJ,CAAE,MAAO,EAAO,CAEZ,OADA,QAAQ,KAAK,CAAC,4CAA6C,GACpD,CACH,SAAS,EACT,MAAO,aAAiB,MAAQ,EAAM,OAAO,CAAG,oBACpD,CACJ,CACJ,CAKO,eAAe,EAA2B,CAAe,EAC5D,QAAQ,GAAG,CAAC,mDAAoD,GAEhE,GAAI,CAaI,GAAI,CACA,GAAM,CAAE,QAAS,CAAU,CAAE,CAAG,MAAA,EAAA,CAAA,CAAA,QAC1B,EAAY,MAAM,EAAW,GAAG,CAAC,GACvC,GAAI,GAAW,MAEX,CAFkB,MAClB,QAAQ,GAAG,CAAC,iCACL,EAAU,KAAK,AAE9B,CAAE,MAAO,EAAG,CACR,QAAQ,IAAI,CAAC,oCAAqC,EACtD,CAIJ,OADA,QAAQ,IAAI,CAAC,sCAAuC,GAC7C,IAEX,CAAE,MAAO,EAAO,CAEZ,OADA,QAAQ,KAAK,CAAC,oCAAqC,GAC5C,IACX,CACJ,CAlJC,EAAA,CAAA,CAAA"}