(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,834055,e=>{"use strict";async function t(e,t,r){try{console.log("ðŸ” Server-side Cashu Melt: Starting single-API melt with retry...");let r=await fetch("/api/cashu/receive-and-melt",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({encodedToken:e,invoice:t})}),o=await r.json();if(!r.ok){if(console.error("âŒ Server-side Cashu Melt: API error:",o),"INSUFFICIENT_BALANCE"===o.error)return{success:!1,error:"Insufficient balance for invoice + fees",details:o.details};return{success:!1,error:o.error||"Server-side melt failed"}}return console.log("âœ… Server-side Cashu Melt: Completed successfully:",o.result),{success:!0,result:o.result}}catch(e){return console.error("âŒ Server-side Cashu Melt: Network error:",e),{success:!1,error:e instanceof Error?e.message:"Network error during melt"}}}async function r(t){try{console.log("ðŸ§® Calculating max invoice amount from token balance...");let{getDecodedToken:r}=await e.A(94904),o=r(t).proofs.reduce((e,t)=>e+t.amount,0),n=0;for(let e=1;e<=o;e++){let t=Math.max(2,Math.ceil(.01*e))+1;if(e+t<=o)n=e;else break}return console.log("âœ… Max invoice calculation:",{availableBalance:o,maxAmount:n,estimatedFee:Math.max(2,Math.ceil(.01*n))+1}),{success:!0,maxAmount:n,availableBalance:o}}catch(e){return console.error("âŒ Failed to calculate max invoice amount:",e),{success:!1,error:e instanceof Error?e.message:"Calculation failed"}}}async function o(e){console.log("ðŸ” Getting encoded token from storage for quote:",e);try{{let t=window.localStorage.getItem("slpm:cashu-token:".concat(e));if(t)return console.log("âœ… Found token in localStorage"),t}return console.warn("âŒ No encoded token found for quote:",e),null}catch(e){return console.error("âŒ Error retrieving encoded token:",e),null}}e.s(["calculateMaxInvoiceAmount",()=>r,"getEncodedTokenFromStorage",()=>o,"serverSideCashuMelt",()=>t])},511077,e=>{"use strict";e.s(["redeemCashuToken",()=>n,"redeemToLightning",()=>a]);var t=e.i(516687),r=e.i(834055),o=e.i(615245);async function n(n,a,i){try{let l,c;i({type:"redeem:validating",message:"Validating ecash token"});let g=await (0,r.calculateMaxInvoiceAmount)(n);if(!g.success)throw Error(g.error);let u=g.maxAmount;console.log("Safe invoice amount:",u,"sats"),i({type:"redeem:creating_swap",message:"Creating Lightning to STRK swap"});let m=(0,o.getSharedSwapAddress)(),d=m||a,h=new t.RealAtomiqSwapClient,f=await h.beginLightningToStrkSwap(u,d);console.log("Atomiq swap created:",{id:f.id,invoice:f.invoice.slice(0,50)+"..."}),i({type:"redeem:melting",message:"Melting ecash to Lightning payment"});let p=await (0,r.serverSideCashuMelt)(n,f.invoice);if(!p.success)throw Error(p.error);if(console.log("Ecash melted successfully"),i({type:"redeem:claiming",message:"Waiting for payment confirmation"}),!await h.waitLightningToStrkCompletion(f.id,3e5))throw Error("Swap timed out waiting for payment");if(await h.claimLightningToStrkSwap(f.id),console.log("Swap claimed on Starknet"),m&&m.toLowerCase()!==a.toLowerCase()){var s;i({type:"redeem:forwarding",message:"Forwarding STRK to recipient"});let e=null!=(s=(await h.getStatus(f.id)).amountOut)?s:0n;console.log("Forwarding STRK:",{from:m,to:a,amount:e.toString()}),l=await (0,o.transferStrkFromShared)(a,e)}if(p.result.change&&p.result.change.length>0){let{getEncodedTokenV4:t}=await e.A(94904);c=t({mint:p.result.mintUrl,proofs:p.result.change}),console.log("Change token available:",p.result.changeAmount,"sats")}i({type:"redeem:complete",message:"Redemption complete",txHash:l||f.id,changeToken:c})}catch(e){throw console.error("Redeem error:",e),i({type:"redeem:error",message:e instanceof Error?e.message:"Redemption failed"}),e}}async function a(t,o,n){try{let a;n({type:"redeem:validating",message:"Validating ecash token and invoice"}),console.log("ðŸ”„ Direct Lightning redemption starting"),console.log("Invoice:",o.slice(0,50)+"..."),n({type:"redeem:melting",message:"Melting ecash to Lightning payment"});let i=await (0,r.serverSideCashuMelt)(t,o);if(!i.success)throw Error(i.error);if(console.log("âœ… Lightning invoice paid successfully"),i.result.change&&i.result.change.length>0){let{getEncodedTokenV4:t}=await e.A(94904);a=t({mint:i.result.mintUrl,proofs:i.result.change}),console.log("ðŸ’° Change token available:",i.result.changeAmount,"sats")}n({type:"redeem:complete",message:"Lightning invoice paid successfully",changeToken:a})}catch(e){throw console.error("âŒ Lightning redemption error:",e),n({type:"redeem:error",message:e instanceof Error?e.message:"Payment failed"}),e}}},94904,e=>{e.v(e=>Promise.resolve().then(()=>e(212164)))}]);