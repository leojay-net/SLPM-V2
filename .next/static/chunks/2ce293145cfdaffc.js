(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,686157,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.OutOfBoundsError=i.RequestError=void 0;class r extends Error{static parse(t,e){try{let i=JSON.parse(t);if(t=i.msg,20003===i.code||20004===i.code)return new n(i.msg,e,BigInt(i.data.min),BigInt(i.data.max))}catch(t){}return new r(t,e)}constructor(t,e){try{let e=JSON.parse(t);null!=e.msg&&(t=e.msg)}catch(t){}super(t),Object.setPrototypeOf(this,r.prototype),this.httpCode=e}}i.RequestError=r;class n extends r{constructor(t,e,i,r){super(t,e),this.max=r,this.min=i,Object.setPrototypeOf(this,n.prototype)}}i.OutOfBoundsError=n},559766,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.randomBytes=i.toCoinselectAddressType=i.toOutputScript=i.bigIntCompare=i.bigIntMax=i.bigIntMin=i.timeoutSignal=i.timeoutPromise=i.httpPost=i.httpGet=i.fetchWithTimeout=i.tryWithRetries=i.extendAbortController=i.mapToArray=i.objectMap=i.promiseAny=i.getLogger=void 0;let r=t.r(686157),n=t.r(843943),a=t.r(960474),s=t.r(857024);function o(t){return"function"==typeof t&&null!=t.prototype&&t.prototype.constructor===t}function l(e){return{debug:function(i){for(var r=arguments.length,n=Array(r>1?r-1:0),a=1;a<r;a++)n[a-1]=arguments[a];return t.g.atomiqLogLevel>=3&&console.debug(e+i,...n)},info:function(i){for(var r=arguments.length,n=Array(r>1?r-1:0),a=1;a<r;a++)n[a-1]=arguments[a];return t.g.atomiqLogLevel>=2&&console.info(e+i,...n)},warn:function(i){for(var r=arguments.length,n=Array(r>1?r-1:0),a=1;a<r;a++)n[a-1]=arguments[a];return(null==t.g.atomiqLogLevel||t.g.atomiqLogLevel>=1)&&console.warn(e+i,...n)},error:function(i){for(var r=arguments.length,n=Array(r>1?r-1:0),a=1;a<r;a++)n[a-1]=arguments[a];return(null==t.g.atomiqLogLevel||t.g.atomiqLogLevel>=0)&&console.error(e+i,...n)}}}i.getLogger=l;let u=l("Utils: ");function c(t,e){return null==e&&(e={}),null!=e.timeout&&(e.signal=p(e.timeout,Error("Network request timed out"),e.signal)),fetch(t,e).catch(t=>{if("AbortError"===t.name)throw e.signal.reason;throw t})}function h(t,e){return new Promise((i,r)=>{let n;if(null!=e&&e.aborted)return void r(e.reason);let a=setTimeout(()=>{null!=n&&e.removeEventListener("abort",n),i()},t);null!=e&&e.addEventListener("abort",n=()=>{null!=a&&clearTimeout(a),a=null,r(e.reason)})})}function p(t,e,i){if(null==t)return i;let r=new AbortController,n=setTimeout(()=>r.abort(e||Error("Timed out")),t);return null!=i&&i.addEventListener("abort",()=>{clearTimeout(n),r.abort(i.reason)}),r.signal}i.promiseAny=function(t){return new Promise((e,i)=>{let r=0,n=Array(t.length);t.forEach((a,s)=>{a.then(t=>{null!=e&&e(t),e=null}).catch(e=>{n[s]=e,++r===t.length&&i(n)})})})},i.objectMap=function(t,e){let i={};for(let r in t)i[r]=e(t[r],r);return i},i.mapToArray=function(t,e){let i=Array(t.size),r=0;for(let n of t.entries())i[r++]=e(n[0],n[1]);return i},i.extendAbortController=function(t){let e=new AbortController;return null!=t&&(t.throwIfAborted(),t.onabort=()=>e.abort(t.reason)),e},i.tryWithRetries=async function(t,e,i,r){(e=e||{}).maxRetries=e.maxRetries||5,e.delay=e.delay||500,e.exponential=null==e.exponential||e.exponential;let n=null;for(let a=0;a<e.maxRetries;a++){try{return await t(a)}catch(t){if(null!=i&&function(t,e){return Array.isArray(e)&&e.every(o)?null!=e.find(e=>t instanceof e):o(e)?t instanceof e:e(t)}(t,i))throw t;n=t,u.warn("tryWithRetries(): Error on try number: "+a,t)}if(null!=r&&r.aborted)throw r.reason||Error("Aborted");a!==e.maxRetries-1&&await h(e.exponential?e.delay*Math.pow(2,a):e.delay,r)}throw n},i.fetchWithTimeout=c,i.httpGet=async function(t,e,i){let n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],a=await c(t,{method:"GET",timeout:e,signal:i});if(200!==a.status){let t;try{t=await a.text()}catch(t){throw new r.RequestError(a.statusText,a.status)}if(n)try{return JSON.parse(t)}catch(t){}throw r.RequestError.parse(t,a.status)}return await a.json()},i.httpPost=async function(t,e,i,n){let a={method:"POST",timeout:i,body:JSON.stringify(e),headers:{"Content-Type":"application/json"},signal:n},s=null==i?await fetch(t,a):await c(t,a);if(200!==s.status){let t;try{t=await s.text()}catch(t){throw new r.RequestError(s.statusText,s.status)}throw r.RequestError.parse(t,s.status)}return await s.json()},i.timeoutPromise=h,i.timeoutSignal=p,i.bigIntMin=function(t,e){return t>e?e:t},i.bigIntMax=function(t,e){return e>t?e:t},i.bigIntCompare=function(t,e){return t>e?1:t===e?0:-1},i.toOutputScript=function(t,e){let i=(0,a.Address)(t).decode(e);switch(i.type){case"pkh":case"sh":case"wpkh":case"wsh":return n.Buffer.from(a.OutScript.encode({type:i.type,hash:i.hash}));case"tr":return n.Buffer.from(a.OutScript.encode({type:"tr",pubkey:i.pubkey}))}},i.toCoinselectAddressType=function(t){switch(a.OutScript.decode(t).type){case"pkh":return"p2pkh";case"sh":return"p2sh-p2wpkh";case"wpkh":return"p2wpkh";case"wsh":return"p2wsh";case"tr":return"p2tr"}throw Error("Unrecognized address type!")},i.randomBytes=function(t){return n.Buffer.from((0,s.randomBytes)(t))}},55532,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.MempoolBtcRelaySynchronizer=void 0;let r=t.r(559766),n=(0,r.getLogger)("MempoolBtcRelaySynchronizer: ");i.MempoolBtcRelaySynchronizer=class{async syncToLatestTxs(t,e){let i=await this.btcRelay.getTipData(),a={forkId:0,lastStoredHeader:null,tx:null,computedCommitedHeaders:null},{resultStoredHeader:s,resultBitcoinHeader:o}=await this.btcRelay.retrieveLatestKnownBlockLog();a.lastStoredHeader=s,s.getBlockheight()<i.blockheight&&(a.forkId=-1),o.getHash(),n.debug("Retrieved stored header with commitment: ",a.lastStoredHeader),n.debug("SPV tip bitcoin RPC block header: ",o);let l=o.height,u=[],c={[o.getHeight()]:o},h={[s.getBlockheight()]:s},p=null,d=e,f=e,g=async e=>{for(let r of(-1===a.forkId?(null==f&&(f=await this.btcRelay.getMainFeeRate(t)),a=await this.btcRelay.saveNewForkHeaders(t,e,a.lastStoredHeader,i.chainWork,f)):0===a.forkId?(null==f&&(f=await this.btcRelay.getMainFeeRate(t)),a=await this.btcRelay.saveMainHeaders(t,e,a.lastStoredHeader,f)):(null==d&&(d=await this.btcRelay.getForkFeeRate(t,a.forkId)),a=await this.btcRelay.saveForkHeaders(t,e,a.lastStoredHeader,a.forkId,i.chainWork,d)),-1!==a.forkId&&0!==a.forkId&&(p=a.forkId),u.push(a.tx),a.computedCommitedHeaders))h[r.getBlockheight()]=r},m=null,w=[];for(;null==m||m.length>0;){let t=(m=await this.bitcoinRpc.getPast15Blocks(l+15)).findIndex(t=>t.height===l);-1===t&&(t=m.length);for(let e=t-1;e>=0;e--){let t=m[e];c[t.height]=t,w.push(t),(0===a.forkId?w.length>=this.btcRelay.maxHeadersPerTx:w.length>=this.btcRelay.maxForkHeadersPerTx)&&(await g(w),w=[])}if(m.length>0){if(l===m[0].height)break;l=m[0].height,await (0,r.timeoutPromise)(1e3)}}if(w.length>0&&await g(w),0!==a.forkId)throw Error("Unable to synchronize on-chain bitcoin light client! Not enough chainwork at connected RPC.");return{txs:u,targetCommitedHeader:a.lastStoredHeader,blockHeaderMap:c,computedHeaderMap:h,btcRelayTipCommitedHeader:s,btcRelayTipBlockHeader:o,latestBlockHeader:o,startForkId:p}}constructor(t,e){this.btcRelay=t,this.bitcoinRpc=e}}},948839,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.MempoolApi=void 0;let r=t.r(843943),n=t.r(559766),a=t.r(686157);i.MempoolApi=class{getOperationalApi(){return this.backends.find(t=>!0===t.operational)}getMaybeOperationalApis(){let t=this.backends.filter(t=>!0===t.operational||null===t.operational);return 0===t.length&&(this.backends.forEach(t=>t.operational=null),t=this.backends),t}async _request(t,e,i){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"GET",s=arguments.length>4?arguments[4]:void 0,o=await (0,n.fetchWithTimeout)(t+e,{method:r,timeout:this.timeout,body:"string"==typeof s?s:JSON.stringify(s)});if(200!==o.status){let t;try{t=await o.text()}catch(t){throw new a.RequestError(o.statusText,o.status)}throw a.RequestError.parse(t,o.status)}return"str"===i?await o.text():await o.json()}async requestFromMaybeOperationalUrls(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"GET",r=arguments.length>3?arguments[3]:void 0;try{return await (0,n.promiseAny)(this.getMaybeOperationalApis().map(n=>(async()=>{try{let a=await this._request(n.url,t,e,i,r);return n.operational=!0,a}catch(t){if(t instanceof a.RequestError&&5!==Math.floor(t.httpCode/100))throw n.operational=!0,t;throw n.operational=!1,t}})()))}catch(t){throw t.find(t=>t instanceof a.RequestError&&5!==Math.floor(t.httpCode/100))||t[0]}}async request(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"GET",r=arguments.length>3?arguments[3]:void 0;return(0,n.tryWithRetries)(()=>{let n=this.getOperationalApi();return null!=n?this._request(n.url,t,e,i,r).catch(s=>{if(s instanceof a.RequestError&&5!==Math.floor(s.httpCode/100))throw s;return n.operational=!1,this.requestFromMaybeOperationalUrls(t,e,i,r)}):this.requestFromMaybeOperationalUrls(t,e,i,r)},null,t=>t instanceof a.RequestError&&5!==Math.floor(t.httpCode/100))}getLNNodeInfo(t){return this.request("v1/lightning/nodes/"+t,"obj").catch(t=>{if("This node does not exist, or our node is not seeing it yet"===t.message)return null;throw t})}getTransaction(t){return this.request("tx/"+t,"obj").catch(t=>{if("Transaction not found"===t.message)return null;throw t})}async getRawTransaction(t){let e=await this.request("tx/"+t+"/hex","str").catch(t=>{if("Transaction not found"===t.message)return null;throw t});return null==e?null:r.Buffer.from(e,"hex")}async getAddressBalances(t){let e=await this.request("address/"+t,"obj"),i=BigInt(e.chain_stats.funded_txo_sum),r=BigInt(e.chain_stats.spent_txo_sum);return{confirmedBalance:i-r,unconfirmedBalance:BigInt(e.mempool_stats.funded_txo_sum)-BigInt(e.mempool_stats.spent_txo_sum)}}getCPFPData(t){return this.request("v1/cpfp/"+t,"obj")}async getAddressUTXOs(t){let e=await this.request("address/"+t+"/utxo","obj");return e.forEach(t=>t.value=BigInt(t.value)),e}getFees(){return this.request("v1/fees/recommended","obj")}getAddressTransactions(t){return this.request("address/"+t+"/txs","obj")}getPendingBlocks(){return this.request("v1/fees/mempool-blocks","obj")}async getTipBlockHeight(){return parseInt(await this.request("blocks/tip/height","str"))}getBlockHeader(t){return this.request("block/"+t,"obj")}getBlockStatus(t){return this.request("block/"+t+"/status","obj")}getTransactionProof(t){return this.request("tx/"+t+"/merkle-proof","obj")}getOutspends(t){return this.request("tx/"+t+"/outspends","obj")}getBlockHash(t){return this.request("block-height/"+t,"str")}getPast15BlockHeaders(t){return this.request("v1/blocks/"+t,"obj")}sendTransaction(t){return this.request("tx","str","POST",t)}constructor(t,e){Array.isArray(t=null!=t?t:"https://mempool.space/testnet/api/")?this.backends=t.map(t=>({url:t,operational:null})):this.backends=[{url:t,operational:null}],this.timeout=e}}},123304,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.MempoolBitcoinBlock=void 0,i.MempoolBitcoinBlock=class{getHeight(){return this.height}getHash(){return this.id}getMerkleRoot(){return this.merkle_root}getNbits(){return this.bits}getNonce(){return this.nonce}getPrevBlockhash(){return this.previousblockhash}getTimestamp(){return this.timestamp}getVersion(){return this.version}getChainWork(){throw Error("Unsupported")}constructor(t){this.id=t.id,this.height=t.height,this.version=t.version,this.timestamp=t.timestamp,this.tx_count=t.tx_count,this.size=t.size,this.weight=t.weight,this.merkle_root=t.merkle_root,this.previousblockhash=t.previousblockhash,this.mediantime=t.mediantime,this.nonce=t.nonce,this.bits=t.bits,this.difficulty=t.difficulty}}},806667,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.MempoolBitcoinRpc=void 0;let r=t.r(991989),n=t.r(123304),a=t.r(948839),s=t.r(843943),o=t.r(559766),l=t.r(960474),u=t.r(14582);class c{static getTxoHash(t){return s.Buffer.from((0,u.sha256)(s.Buffer.concat([r.BigIntBufferUtils.toBuffer(BigInt(t.value),"le",8),s.Buffer.from(t.scriptpubkey,"hex")])))}async getTimeTillConfirmation(t){let e=await this.api.getPendingBlocks(),i=e.findIndex(e=>e.feeRange[0]<=t);return -1===i||i+1===e.length&&e[e.length-1].blockVSize>1048576?-1:(i+1)*6e5}async getConfirmationDelay(t,e){if(t.confirmations>e)return 0;if(0===t.confirmations){let i=await this.api.getCPFPData(t.txid);if(null==i.effectiveFeePerVsize)return null;let r=await this.getTimeTillConfirmation(i.effectiveFeePerVsize);return -1!==r&&(r+=(e-1)*6e5),r}return(e-t.confirmations)*6e5}async toBtcTx(t){var e,i;let r,n=!(arguments.length>1)||void 0===arguments[1]||arguments[1],a=n?await this.api.getRawTransaction(t.txid):null,o=0;if(null!=t.status&&t.status.confirmed&&(o=await this.api.getTipBlockHeight()-t.status.block_height+1),null!=a){let t=l.Transaction.fromRaw(a,{allowLegacyWitnessUtxo:!0,allowUnknownInputs:!0,allowUnknownOutputs:!0,disableScriptCheck:!0});r=s.Buffer.from(t.toBytes(!0,!1)).toString("hex")}return{locktime:t.locktime,version:t.version,blockheight:null==(e=t.status)?void 0:e.block_height,blockhash:null==(i=t.status)?void 0:i.block_hash,confirmations:o,txid:t.txid,vsize:t.weight/4,hex:r,raw:null==a?null:a.toString("hex"),outs:t.vout.map((t,e)=>({value:t.value,n:e,scriptPubKey:{hex:t.scriptpubkey,asm:t.scriptpubkey_asm}})),ins:t.vin.map(t=>({txid:t.txid,vout:t.vout,scriptSig:{hex:t.scriptsig,asm:t.scriptsig_asm},sequence:t.sequence,txinwitness:t.witness}))}}getTipHeight(){return this.api.getTipBlockHeight()}async getBlockHeader(t){return new n.MempoolBitcoinBlock(await this.api.getBlockHeader(t))}async getMerkleProof(t,e){let i=await this.api.getTransactionProof(t);return{reversedTxId:s.Buffer.from(t,"hex").reverse(),pos:i.pos,merkle:i.merkle.map(t=>s.Buffer.from(t,"hex").reverse()),blockheight:i.block_height}}async getTransaction(t){let e=await this.api.getTransaction(t);return null==e?null:await this.toBtcTx(e)}async isInMainChain(t){return(await this.api.getBlockStatus(t)).in_best_chain}getBlockhash(t){return this.api.getBlockHash(t)}getBlockWithTransactions(t){throw Error("Unsupported.")}async getSyncInfo(){let t=await this.api.getTipBlockHeight();return{verificationProgress:1,blocks:t,headers:t,ibd:!1}}async getPast15Blocks(t){return(await this.api.getPast15BlockHeaders(t)).map(t=>new n.MempoolBitcoinBlock(t))}async checkAddressTxos(t,e){let i=(await this.api.getAddressTransactions(t)).map(t=>({tx:t,vout:t.vout.findIndex(t=>c.getTxoHash(t).equals(e))})).filter(t=>t.vout>=0).sort((t,e)=>t.tx.status.confirmed&&!e.tx.status.confirmed?-1:!t.tx.status.confirmed&&e.tx.status.confirmed?1:t.tx.status.confirmed&&e.tx.status.confirmed?t.tx.status.block_height-e.tx.status.block_height:0);return 0===i.length?null:{tx:await this.toBtcTx(i[0].tx,!1),vout:i[0].vout}}async waitForAddressTxo(t,e,i,r,n,a){for(null!=n&&n.throwIfAborted();null==n||!n.aborted;){await (0,o.timeoutPromise)(1e3*(a||5),n);let s=await this.checkAddressTxos(t,e);if(null==s){r(null,null,null,null);continue}let l=await this.getConfirmationDelay(s.tx,i);if(null!=l&&(null!=r&&r(s.tx.confirmations,s.tx.txid,s.vout,l),0===l))return s}n.throwIfAborted()}async waitForTransaction(t,e,i,r,n){for(null!=r&&r.throwIfAborted();null==r||!r.aborted;){await (0,o.timeoutPromise)(1e3*(n||5),r);let a=await this.getTransaction(t);if(null==a){i(null,null,null);continue}let s=await this.getConfirmationDelay(a,e);if(null!=s&&(null!=i&&i(a.confirmations,a.txid,s),0===s))return a}r.throwIfAborted()}async getLNNodeLiquidity(t){let e=await this.api.getLNNodeInfo(t);return{publicKey:e.public_key,capacity:BigInt(e.capacity),numChannels:e.active_channel_count}}sendRawTransaction(t){return this.api.sendTransaction(t)}sendRawPackage(t){throw Error("Unsupported")}async isSpent(t,e){let[i,r]=t.split(":"),n=parseInt(r),a=await this.api.getOutspends(i);return null==a[n]||(e?a[n].spent&&a[n].status.confirmed:a[n].spent)}parseTransaction(t){var e;return Promise.resolve({locktime:(e=l.Transaction.fromRaw(s.Buffer.from(t,"hex"),{allowLegacyWitnessUtxo:!0,allowUnknownInputs:!0,allowUnknownOutputs:!0,disableScriptCheck:!0})).lockTime,version:e.version,blockhash:null,confirmations:0,txid:s.Buffer.from((0,u.sha256)((0,u.sha256)(e.toBytes(!0,!1)))).reverse().toString("hex"),hex:s.Buffer.from(e.toBytes(!0,!1)).toString("hex"),raw:s.Buffer.from(e.toBytes(!0,!0)).toString("hex"),vsize:e.isFinal?e.vsize:null,outs:Array.from({length:e.outputsLength},(t,e)=>e).map(t=>{let i=e.getOutput(t);return{value:Number(i.amount),n:t,scriptPubKey:{asm:l.Script.decode(i.script).map(t=>"object"==typeof t?s.Buffer.from(t).toString("hex"):t.toString()).join(" "),hex:s.Buffer.from(i.script).toString("hex")}}}),ins:Array.from({length:e.inputsLength},(t,e)=>e).map(t=>{let i=e.getInput(t);return{txid:s.Buffer.from(i.txid).toString("hex"),vout:i.index,scriptSig:{asm:l.Script.decode(i.finalScriptSig).map(t=>"object"==typeof t?s.Buffer.from(t).toString("hex"):t.toString()).join(" "),hex:s.Buffer.from(i.finalScriptSig).toString("hex")},sequence:i.sequence,txinwitness:null==i.finalScriptWitness?[]:i.finalScriptWitness.map(t=>s.Buffer.from(t).toString("hex"))}})})}getEffectiveFeeRate(t){throw Error("Unsupported.")}async getFeeRate(){return(await this.api.getFees()).fastestFee}getAddressBalances(t){return this.api.getAddressBalances(t)}async getAddressUTXOs(t){return(await this.api.getAddressUTXOs(t)).map(t=>({txid:t.txid,vout:t.vout,confirmed:t.status.confirmed,block_height:t.status.block_height,block_hash:t.status.block_hash,block_time:t.status.block_time,value:t.value}))}getCPFPData(t){return this.api.getCPFPData(t)}constructor(t){this.api=t instanceof a.MempoolApi?t:new a.MempoolApi(t)}}i.MempoolBitcoinRpc=c},705423,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0})},601612,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0})},548760,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.isIBitcoinWallet=void 0,i.isIBitcoinWallet=function(t){return null!==t&&"function"==typeof t.sendTransaction&&"function"==typeof t.fundPsbt&&"function"==typeof t.signPsbt&&"function"==typeof t.getFeeRate&&"function"==typeof t.getTransactionFee&&"function"==typeof t.getFundedPsbtFee&&"function"==typeof t.getReceiveAddress&&"function"==typeof t.getBalance&&"function"==typeof t.getSpendableBalance}},544429,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.utils=i.DUST_THRESHOLDS=void 0;let r=(0,t.r(559766).getLogger)("CoinSelect: "),n={"p2sh-p2wpkh":51,p2wpkh:27,p2tr:16.75,p2pkh:107,p2wsh:16.5};function a(t){return 41+(t.script?t.script.length:n[t.type])}let s={"p2sh-p2wpkh":23,p2wpkh:22,p2tr:34,p2pkh:25,p2wsh:34};function o(t){return 9+(t.script?t.script.length:s[t.type])}function l(t){return i.DUST_THRESHOLDS[t.type]}function u(t,e,i){let r=10,n=!1;for(let e of("p2pkh"!==i&&(r+=.5),t))n||"p2pkh"===e.type||(n=!0,r+=.5),r+=a(e);for(let t of e)r+=o(t);return Math.ceil(r)}function c(t){return"number"!=typeof t||!isFinite(t)||Math.floor(t)!==t||t<0?NaN:t}function h(t){return t.reduce((t,e)=>t+c(e.value),0)}i.DUST_THRESHOLDS={"p2sh-p2wpkh":540,p2wpkh:294,p2tr:330,p2pkh:546,p2wsh:330},i.utils={dustThreshold:l,finalize:function(t,e,i,n){let a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,s=u(t,e,n);r.debug("finalize(): Transaction bytes: ",s);let c=i*(s+o({type:n}))+a;r.debug("finalize(): TX fee after adding change output: ",c);let p=Math.floor(h(t)-(h(e)+c));r.debug("finalize(): Leaves change (changeType="+n+") value: ",p),p>=l({type:n})&&(e=e.concat({value:p,type:n}));let d=h(t)-h(e);return(r.debug("finalize(): Re-calculated total fee: ",d),isFinite(d))?{inputs:t,outputs:e,fee:d}:{fee:i*s+a}},inputBytes:a,outputBytes:o,sumOrNaN:h,sumForgiving:function(t){return t.reduce((t,e)=>t+(isFinite(e.value)?e.value:0),0)},transactionBytes:u,uintOrNaN:c}},729696,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.accumulative=void 0;let r=t.r(544429),n=(0,t.r(559766).getLogger)("CoinSelect: ");i.accumulative=function(t,e,i,a,s){if(!isFinite(r.utils.uintOrNaN(i)))return null;let o=null==s?[]:[...s],l=r.utils.transactionBytes(o,e,a),u=i*l,c=0,h=r.utils.sumOrNaN(o),p=r.utils.sumOrNaN(e);n.debug("accumulative(): total output: ",p);for(let s=0;s<t.length;++s){let d=t[s],f=r.utils.inputBytes(d),g=i*f,m=r.utils.uintOrNaN(d.value),w=0;if(null!=d.cpfp&&d.cpfp.txEffectiveFeeRate<i&&(w=Math.ceil(d.cpfp.txVsize*(i-d.cpfp.txEffectiveFeeRate))),g+w>d.value){if(n.debug("accumulative("+s+"): Skipping detrimental output, cpfpFee: "+w+" utxoFee: "+g+" value: "+d.value),s===t.length-1)return{fee:i*(l+f)+c+w};continue}if(l+=f,h+=m,c+=w,o.push(d),u=Math.ceil(i*l+c),n.debug("accumulative("+s+"): total fee: ",u),n.debug("accumulative("+s+"): input value: ",h),n.debug("accumulative("+s+"): cpfpAddFee: ",c),!(h<p+u))return n.debug("accumulative("+s+"): Finalizing transaction, inputs: ",o),n.debug("accumulative("+s+"): Finalizing transaction, outputs: ",e),n.debug("accumulative("+s+"): Finalizing transaction, feeRate: ",i),r.utils.finalize(o,e,i,a,c)}return{fee:u}}},133541,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.blackjack=void 0;let r=t.r(544429);i.blackjack=function(t,e,i,n,a){if(!isFinite(r.utils.uintOrNaN(i)))return null;let s=null==a?[]:[...a],o=r.utils.transactionBytes(s,e,n),l=r.utils.sumOrNaN(s),u=0,c=r.utils.sumOrNaN(e),h=r.utils.dustThreshold({type:n});for(let a=0;a<t.length;++a){let p=t[a],d=r.utils.inputBytes(p),f=0;null!=p.cpfp&&p.cpfp.txEffectiveFeeRate<i&&(f=Math.ceil(p.cpfp.txVsize*(i-p.cpfp.txEffectiveFeeRate)));let g=Math.ceil(i*(o+d)+u+f),m=r.utils.uintOrNaN(p.value);if(!(l+m>c+g+h)&&(o+=d,l+=m,u+=f,s.push(p),!(l<c+g)))return r.utils.finalize(s,e,i,n,u)}return{fee:i*o+u}}},431626,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.maxSendable=i.coinSelect=i.DUST_THRESHOLDS=void 0;let r=t.r(729696),n=t.r(133541),a=t.r(544429);function s(t,e){let i=t.value-e*a.utils.inputBytes(t);return null!=t.cpfp&&t.cpfp.txEffectiveFeeRate<e&&(i-=t.cpfp.txVsize*(e-t.cpfp.txEffectiveFeeRate)),i}Object.defineProperty(i,"DUST_THRESHOLDS",{enumerable:!0,get:function(){return a.DUST_THRESHOLDS}}),i.coinSelect=function(t,e,i,a,o){t=t.sort((t,e)=>s(e,i)-s(t,i));let l=(0,n.blackjack)(t,e,i,a,o);return l.inputs?l:(0,r.accumulative)(t,e,i,a,o)},i.maxSendable=function(t,e,i,r,n){if(!isFinite(a.utils.uintOrNaN(i)))return null;let s=null!=n?n:[],o=null!=r?r:[],l=a.utils.transactionBytes(o,s.concat([e]),null),u=0,c=a.utils.sumOrNaN(o),h=a.utils.sumOrNaN(s);for(let e=0;e<t.length;++e){let r=t[e],n=a.utils.inputBytes(r),s=i*n,h=0;null!=r.cpfp&&r.cpfp.txEffectiveFeeRate<i&&(h=r.cpfp.txVsize*(i-r.cpfp.txEffectiveFeeRate));let p=a.utils.uintOrNaN(r.value);s+h>r.value||(l+=n,c+=p,u+=h,o.push(r))}let p=i*l+u,d=c-p-h;return d<a.DUST_THRESHOLDS[e.type]?{fee:p,value:0}:{fee:p,value:d}}},154732,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.BitcoinWallet=i.identifyAddressType=void 0;let r=t.r(431626),n=t.r(960474),a=t.r(843943),s=t.r(559766);i.identifyAddressType=function(t,e){switch((0,n.Address)(e).decode(t).type){case"pkh":return"p2pkh";case"wpkh":return"p2wpkh";case"tr":return"p2tr";case"sh":return"p2sh-p2wpkh";case"wsh":return"p2wsh";default:return null}};let o=(0,s.getLogger)("BitcoinWallet: ");i.BitcoinWallet=class{async getFeeRate(){return null!=this.feeOverride?this.feeOverride:Math.floor(await this.rpc.getFeeRate()*this.feeMultiplier)}_sendTransaction(t){return this.rpc.sendRawTransaction(t)}_getBalance(t){return this.rpc.getAddressBalances(t)}async _getUtxoPool(t,e){let i=await this.rpc.getAddressUTXOs(t),r=0,n=(0,s.toOutputScript)(this.network,t),a=[];for(let s of i){let i=Number(s.value);r+=i,a.push({vout:s.vout,txId:s.txid,value:i,type:e,outputScript:n,address:t,cpfp:s.confirmed?null:await this.rpc.getCPFPData(s.txid).then(t=>null==t.effectiveFeePerVsize?null:{txVsize:t.adjustedVsize,txEffectiveFeeRate:t.effectiveFeePerVsize}),confirmed:s.confirmed})}return o.debug("_getUtxoPool(): Total spendable value: "+r+" num utxos: "+a.length),a}async _getPsbt(t,e,i,r){let a=new n.Transaction({PSBTVersion:0});return a.addOutput({amount:BigInt(i),script:(0,s.toOutputScript)(this.network,e)}),this._fundPsbt(t,a,r)}async _fundPsbt(t,e,i){null==i&&(i=await this.getFeeRate());let l=(await Promise.all(t.map(t=>this._getUtxoPool(t.address,t.addressType)))).flat();o.debug("_fundPsbt(): fee rate: "+i+" utxo pool: ",l);let u={};t.forEach(t=>u[t.address]=t.pubkey);let c=[];for(let t=0;t<e.inputsLength;t++){let i=e.getInput(t),r=null!=i.witnessUtxo?i.witnessUtxo.amount:i.nonWitnessUtxo.outputs[i.index].amount,n=null!=i.witnessUtxo?i.witnessUtxo.script:i.nonWitnessUtxo.outputs[i.index].script;c.push({txId:a.Buffer.from(i.txid).toString("hex"),vout:i.index,value:Number(r),type:(0,s.toCoinselectAddressType)(n)})}let h=[];for(let t=0;t<e.outputsLength;t++){let i=e.getOutput(t);h.push({value:Number(i.amount),script:a.Buffer.from(i.script)})}o.debug("_fundPsbt(): Coinselect targets: ",h);let p=(0,r.coinSelect)(l,h,i,t[0].addressType,c);if(o.debug("_fundPsbt(): Coinselect result: ",p),null==p.inputs||null==p.outputs)return{psbt:null,fee:p.fee,inputAddressIndexes:null};p.inputs.splice(0,e.inputsLength),p.outputs.splice(0,e.outputsLength);let d={};return p.inputs.forEach((t,e)=>{var i;null!=d[i=t.address]||(d[i]=[]),d[t.address].push(e)}),(await Promise.all(p.inputs.map(async t=>{switch(t.type){case"p2tr":let e=(0,n.p2tr)(a.Buffer.from(u[t.address],"hex"));return{txid:t.txId,index:t.vout,witnessUtxo:{script:t.outputScript,amount:BigInt(t.value)},tapInternalKey:e.tapInternalKey,tapMerkleRoot:e.tapMerkleRoot,tapLeafScript:e.tapLeafScript};case"p2wpkh":return{txid:t.txId,index:t.vout,witnessUtxo:{script:t.outputScript,amount:BigInt(t.value)},sighashType:1};case"p2sh-p2wpkh":return{txid:t.txId,index:t.vout,witnessUtxo:{script:t.outputScript,amount:BigInt(t.value)},redeemScript:(0,n.p2wpkh)(a.Buffer.from(u[t.address],"hex"),this.network).script,sighashType:1};case"p2pkh":return{txid:t.txId,index:t.vout,nonWitnessUtxo:(await this.rpc.getTransaction(t.txId)).raw,sighashType:1}}}))).forEach(t=>e.addInput(t)),p.outputs.forEach(i=>{if(null==i.script&&null==i.address)e.addOutput({script:(0,s.toOutputScript)(this.network,t[0].address),amount:BigInt(Math.floor(i.value))});else{var r;e.addOutput({script:null!=(r=i.script)?r:(0,s.toOutputScript)(this.network,i.address),amount:BigInt(i.value)})}}),{psbt:e,fee:p.fee,inputAddressIndexes:d}}async _getSpendableBalance(t,e,i){null!=i||(i=await this.getFeeRate());let l=(await Promise.all(t.map(t=>this._getUtxoPool(t.address,t.addressType)))).flat(),u=[];if(null!=e)for(let t=0;t<e.inputsLength;t++){let i=e.getInput(t),r=null!=i.witnessUtxo?i.witnessUtxo.amount:i.nonWitnessUtxo.outputs[i.index].amount,n=null!=i.witnessUtxo?i.witnessUtxo.script:i.nonWitnessUtxo.outputs[i.index].script;u.push({txId:a.Buffer.from(i.txid).toString("hex"),vout:i.index,value:Number(r),type:(0,s.toCoinselectAddressType)(n)})}let c=[];if(null!=e)for(let t=0;t<e.outputsLength;t++){let i=e.getOutput(t);c.push({value:Number(i.amount),script:a.Buffer.from(i.script)})}let h=n.OutScript.encode({type:"wsh",hash:(0,s.randomBytes)(32)}),p=(0,r.maxSendable)(l,{script:a.Buffer.from(h),type:"p2wsh"},i,u,c);return o.debug("_getSpendableBalance(): Max spendable result: ",p),{feeRate:i,balance:BigInt(Math.floor(p.value)),totalFee:p.fee}}constructor(t,e,i=1.25,r){this.rpc=t,this.network=e,this.feeMultiplier=i,this.feeOverride=r}}},902866,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.SingleAddressBitcoinWallet=void 0;let r=t.r(446598),n=t.r(960474),a=t.r(843943),s=t.r(154732);class o extends s.BitcoinWallet{toBitcoinWalletAccounts(){return[{pubkey:a.Buffer.from(this.pubkey).toString("hex"),address:this.address,addressType:this.addressType}]}async sendTransaction(t,e,i){if(!this.privKey)throw Error("Not supported.");let{psbt:r}=await super._getPsbt(this.toBitcoinWalletAccounts(),t,Number(e),i);r.sign(this.privKey),r.finalize();let n=a.Buffer.from(r.extract()).toString("hex");return await super._sendTransaction(n)}async fundPsbt(t,e){let{psbt:i}=await super._fundPsbt(this.toBitcoinWalletAccounts(),t,e);if(null==i)throw Error("Not enough balance!");return i}async signPsbt(t,e){if(!this.privKey)throw Error("Not supported.");for(let i of e)t.signIdx(this.privKey,i);return t}async getTransactionFee(t,e,i){let{psbt:r,fee:n}=await super._getPsbt(this.toBitcoinWalletAccounts(),t,Number(e),i);return null==r?null:n}async getFundedPsbtFee(t,e){let{psbt:i,fee:r}=await super._fundPsbt(this.toBitcoinWalletAccounts(),t,e);return null==i?null:r}getReceiveAddress(){return this.address}getBalance(){return this._getBalance(this.address)}getSpendableBalance(t,e){return this._getSpendableBalance([{address:this.address,addressType:this.addressType}],t,e)}static generateRandomPrivateKey(t){return(0,n.WIF)(t).encode((0,r.randomPrivateKeyBytes)())}constructor(t,e,i,o=1.25,l){if(super(t,e,o,l),"string"==typeof i){try{this.privKey=(0,n.WIF)(e).decode(i)}catch(t){this.privKey=(0,n.WIF)().decode(i)}this.pubkey=(0,r.pubECDSA)(this.privKey),this.address=(0,n.getAddress)("wpkh",this.privKey,e)}else this.address=i.address,this.pubkey=a.Buffer.from(i.publicKey,"hex");this.addressType=(0,s.identifyAddressType)(this.address,e)}}i.SingleAddressBitcoinWallet=o},145617,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.IntermediaryError=void 0;class r extends Error{constructor(t){super(t),Object.setPrototypeOf(this,r.prototype)}}i.IntermediaryError=r},930550,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.PaymentAuthError=void 0;class r extends Error{getCode(){return this.code}getData(){return this.data}constructor(t,e,i){super(t),this.data=i,this.code=e,Object.setPrototypeOf(this,r.prototype)}}i.PaymentAuthError=r},17061,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.UserError=void 0;class r extends Error{constructor(t){super(t),Object.setPrototypeOf(this,r.prototype)}}i.UserError=r},865854,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.SwapType=void 0,function(t){t[t.FROM_BTC=0]="FROM_BTC",t[t.FROM_BTCLN=1]="FROM_BTCLN",t[t.TO_BTC=2]="TO_BTC",t[t.TO_BTCLN=3]="TO_BTCLN",t[t.TRUSTED_FROM_BTC=4]="TRUSTED_FROM_BTC",t[t.TRUSTED_FROM_BTCLN=5]="TRUSTED_FROM_BTCLN",t[t.SPV_VAULT_FROM_BTC=6]="SPV_VAULT_FROM_BTC"}(i.SwapType||(i.SwapType={}))},506498,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.Intermediary=void 0;let r=t.r(865854),n=t.r(559766);i.Intermediary=class{getSwapLimits(t,e,i){var r,n;return null==(n=this.swapBounds[t])||null==(r=n[e])?void 0:r[i]}getSupportedTokens(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[r.SwapType.TO_BTC,r.SwapType.TO_BTCLN,r.SwapType.FROM_BTC,r.SwapType.FROM_BTCLN,r.SwapType.SPV_VAULT_FROM_BTC],i=new Set(e),n=new Set;return i.forEach(e=>{null!=this.services[e]&&null!=this.services[e].chainTokens&&null!=this.services[e].chainTokens[t]&&this.services[e].chainTokens[t].forEach(t=>n.add(t))}),n}async getReputation(t,e,i,a){var s;let o=null==i?this.getSupportedTokens(t,[r.SwapType.TO_BTC,r.SwapType.TO_BTCLN]):new Set(i),l=[],u={};for(let i of o)l.push((0,n.tryWithRetries)(()=>e.getIntermediaryReputation(this.getAddress(t),i),null,null,a).then(t=>{u[i]=t}));for(let e in await Promise.all(l),null!=this.reputation||(this.reputation={}),null!=(s=this.reputation)[t]||(s[t]={}),u)this.reputation[t][e]=u[e];return u}async getLiquidity(t,e,i,r){var a;let s=await (0,n.tryWithRetries)(()=>e.getBalance(this.getAddress(t),i,!0),null,null,r);return null!=this.liquidity||(this.liquidity={}),null!=(a=this.liquidity)[t]||(a[t]={}),this.liquidity[t][i]=s,s}supportsChain(t){return null!=this.addresses[t]&&0!==this.getSupportedTokens(t).size}getAddress(t){return this.addresses[t]}constructor(t,e,i,n={}){for(let a in this.reputation={},this.liquidity={},this.url=t,this.addresses=e,this.services=i,this.reputation=n,this.swapBounds={},this.services){let t=parseInt(a),e=this.services[a],i={min:BigInt(e.min),max:BigInt(e.max)},n=t===r.SwapType.TO_BTC||t===r.SwapType.TO_BTCLN;for(let r in this.swapBounds[t]={},e.chainTokens)for(let a of(this.swapBounds[t][r]={},e.chainTokens[r]))this.swapBounds[t][r][a]={input:n?{min:null,max:null}:i,output:n?i:{min:null,max:null}}}}}},265005,(t,e,i)=>{"use strict";var r;function n(t){if(null==t||"string"!=typeof t&&"number"!=typeof t)return null;try{return BigInt(t)}catch(t){return null}}function a(t){if("function"==typeof t)return null!=t(void 0);if("object"==typeof t){for(let e in t)if(!a(t[e]))return!1;return!0}return t>=100}function s(t,e){if(null==t)return null;let i={};for(let o in e){let l=t[o],u=e[o];if("function"==typeof u){let t=u(l);if(null==t)return null;i[o]=t;continue}if(null==l&&a(u)){i[o]=null;continue}if(u===r.Any||u===r.AnyOptional)i[o]=l;else if(u===r.Boolean||u===r.BooleanOptional){if("boolean"!=typeof l)return null;i[o]=l}else if(u===r.Number||u===r.NumberOptional){if("number"!=typeof l||isNaN(l))return null;i[o]=l}else if(u===r.BigInt||u===r.BigIntOptional){let t=n(l);if(null==t)return null;i[o]=t}else if(u===r.String||u===r.StringOptional){if("string"!=typeof l)return null;i[o]=l}else{let t=s(l,u);if(null==t)return null;i[o]=t}}return i}Object.defineProperty(i,"__esModule",{value:!0}),i.verifySchema=i.verifyField=i.isOptionalField=i.FieldTypeEnum=i.parseBigInt=void 0,i.parseBigInt=n,function(t){t[t.String=0]="String",t[t.Boolean=1]="Boolean",t[t.Number=2]="Number",t[t.BigInt=3]="BigInt",t[t.Any=4]="Any",t[t.StringOptional=100]="StringOptional",t[t.BooleanOptional=101]="BooleanOptional",t[t.NumberOptional=102]="NumberOptional",t[t.BigIntOptional=103]="BigIntOptional",t[t.AnyOptional=104]="AnyOptional"}(r=i.FieldTypeEnum||(i.FieldTypeEnum={})),i.isOptionalField=a,i.verifyField=function(t,e){if("function"==typeof t){let i=t(e);if(null==i)return;return i}if(null==e&&a(t))return null;if(t===r.Any||t===r.AnyOptional)return e;if(t===r.Boolean||t===r.BooleanOptional){if("boolean"!=typeof e)return;return e}if(t===r.Number||t===r.NumberOptional){if("number"!=typeof e||isNaN(e))return;return e}if(t===r.BigInt||t===r.BigIntOptional){let t=n(e);if(null==t)return;return t}if(t===r.String||t===r.StringOptional){if("string"!=typeof e)return;return e}else{let i=s(e,t);if(null==i)return;return i}},i.verifySchema=s},961322,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.ParamEncoder=void 0;let r=t.r(843943);i.ParamEncoder=class{writeParams(t){let e=r.Buffer.from(JSON.stringify(t)),i=r.Buffer.alloc(4);return i.writeUint32LE(e.length),this.writeFN(r.Buffer.concat([i,e]))}end(){return this.endFN()}constructor(t,e){this.writeFN=t,this.endFN=e}}},961745,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.StreamParamEncoder=void 0;let r=t.r(961322);class n extends r.ParamEncoder{getReadableStream(){return this.stream.readable}constructor(){let t=new TransformStream,e=t.writable.getWriter();e.closed.then(()=>this.closed=!0),super(e.write.bind(e),()=>this.closed?Promise.resolve():(this.closed=!0,e.close())),this.closed=!1,this.stream=t}}i.StreamParamEncoder=n},227057,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.ParamDecoder=void 0;let r=t.r(843943);i.ParamDecoder=class{onFrameRead(t){let e=JSON.parse(t.toString());for(let t in e)null==this.params[t]?this.params[t]={promise:Promise.resolve(e[t]),resolve:null,reject:null}:null!=this.params[t].resolve&&(this.params[t].resolve(e[t]),this.params[t].resolve=null,this.params[t].reject=null)}onData(t){let e=t;for(;null!=e&&e.length>0;){if(null==this.frameHeader)e.length<=4?(this.frameHeader=e,e=null):(this.frameHeader=e.subarray(0,4),e=e.subarray(4));else if(this.frameHeader.length<4){let t=4-this.frameHeader.length;e.length<=t?(this.frameHeader=r.Buffer.concat([this.frameHeader,e]),e=null):(this.frameHeader=r.Buffer.concat([this.frameHeader,e.subarray(0,t)]),e=e.subarray(t))}if(null==e||null==this.frameHeader||this.frameHeader.length<4)continue;let t=this.frameHeader.readUint32LE(),i=t-this.frameDataLength;e.length<=i?(this.frameData.push(e),this.frameDataLength+=e.length,e=null):(this.frameData.push(e.subarray(0,i)),this.frameDataLength+=i,e=e.subarray(i)),t===this.frameDataLength&&(this.onFrameRead(r.Buffer.concat(this.frameData)),this.frameHeader=null,this.frameData=[],this.frameDataLength=0)}}onEnd(){for(let t in this.params)null!=this.params[t].reject&&this.params[t].reject(Error("EOF before field seen!"));this.closed=!0}onError(t){for(let e in this.params)null!=this.params[e].reject&&this.params[e].reject(t);this.closed=!0}getParam(t){if(null==this.params[t]){let e,i;if(this.closed)return Promise.reject(Error("Stream already closed without param received!"));let r=new Promise((t,r)=>{e=t,i=r});this.params[t]={resolve:e,reject:i,promise:r}}return this.params[t].promise}constructor(){this.frameHeader=null,this.frameData=[],this.frameDataLength=0,this.closed=!1,this.params={}}}},444673,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.ResponseParamDecoder=void 0;let r=t.r(227057),n=t.r(843943),a=(0,t.r(559766).getLogger)("ResponseParamDecoder: ");class s extends r.ParamDecoder{async readResponse(){for(;;){let t=await this.reader.read().catch(t=>(a.error("readResponse(): Error reading response: ",t),null));if(null!=this.abortSignal&&this.abortSignal.aborted)return;if(null==t||t.done)return void super.onEnd();super.onData(n.Buffer.from(t.value))}}constructor(t,e){super(),this.abortSignal=e;try{this.reader=t.body.getReader(),this.readResponse()}catch(e){t.arrayBuffer().then(t=>{super.onData(n.Buffer.from(t)),super.onEnd()}).catch(t=>{super.onError(t)})}null!=e&&e.addEventListener("abort",()=>{super.onError(e.reason),this.reader.closed||this.reader.cancel(e.reason)})}}i.ResponseParamDecoder=s},225913,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.streamingFetchPromise=void 0;let r=t.r(265005),n=t.r(686157),a=t.r(559766),s=t.r(961745),o=t.r(444673),l=(0,a.getLogger)("StreamingFetch: "),u=(()=>{try{let t=!1,e=new Request("https://example.com/",{body:new ReadableStream,method:"POST",get duplex(){return t=!0,"half"}}).headers.has("Content-Type");return t&&!e}catch(t){return l.error("supportsRequestStreams: Error checking environment support for HTTP request stream",t),!1}})();l.info("Environment supports request stream: "+u),i.streamingFetchPromise=async function(t,e,i,c,h,p){null==p&&(p=u),null!=c&&(h=(0,a.timeoutSignal)(c,Error("Network request timed out"),h));let d={method:"POST",headers:{}},f=Date.now(),g={},m=[];if(p){let i=new s.StreamParamEncoder,r=!1;for(let n in e)e[n]instanceof Promise?(m.push(e[n].then(e=>(l.debug(t+": Send param ("+(Date.now()-f)+"ms) (streaming): ",{[n]:e}),i.writeParams({[n]:e})))),r=!0):g[n]=e[n];if(r){d.body=i.getReadableStream(),d.headers["content-type"]="application/x-multiple-json",d.duplex="half",l.debug(t+": Sending request ("+(Date.now()-f)+"ms) (streaming): ",g),m.push(i.writeParams(g));let e=(0,a.extendAbortController)(h);h=e.signal,Promise.all(m).then(()=>i.end()).catch(t=>{t._inputPromiseError=!0,e.abort(t)}),h.addEventListener("abort",()=>i.end())}else l.debug(t+": Sending request ("+(Date.now()-f)+"ms) (non-streaming): ",g),d.body=JSON.stringify(g),d.headers["content-type"]="application/json"}else{for(let t in e)e[t]instanceof Promise?m.push(e[t].then(e=>{g[t]=e})):g[t]=e[t];try{await Promise.all(m)}catch(t){throw t._inputPromiseError=!0,t}null!=h&&h.throwIfAborted(),l.debug(t+": Sending request ("+(Date.now()-f)+"ms) (non-streaming): ",g),d.body=JSON.stringify(g),d.headers["content-type"]="application/json"}null!=h&&(d.signal=h),d.headers.accept="application/x-multiple-json";let w=await fetch(t,d).catch(t=>{if(null!=d.signal&&"AbortError"===t.name)throw d.signal.reason;throw null!=t.message&&(t.message+=p?" (streaming req)":" (non streaming req)"),t});if(l.debug(t+": Response status ("+(Date.now()-f)+"ms) "+(p?"(streaming req)":"(non streaming req)")+": ",w.status),200!==w.status){let t;try{t=await w.text()}catch(t){throw new n.RequestError(w.statusText,w.status)}throw new n.RequestError(t,w.status)}if("application/x-multiple-json"!==w.headers.get("content-type")){let e=await w.json();return l.debug(t+": Response read ("+(Date.now()-f)+"ms) (non streaming resp): ",e),(0,a.objectMap)(i,(t,i)=>{let n=e[i],a=(0,r.verifyField)(t,n);return void 0===a?Promise.reject(Error("Invalid field value")):Promise.resolve(a)})}{let e=new o.ResponseParamDecoder(w,d.signal);return(0,a.objectMap)(i,(i,n)=>e.getParam(n).catch(t=>{if(!(0,r.isOptionalField)(i))throw t}).then(e=>{l.debug(t+": Response frame read ("+(Date.now()-f)+"ms) (streaming resp): ",{[n]:e});let a=(0,r.verifyField)(i,e);return void 0===a?Promise.reject(Error("Invalid field value")):a}))}}},366913,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.IntermediaryAPI=i.PaymentAuthorizationResponseCodes=i.RefundAuthorizationResponseCodes=void 0;let r=t.r(686157),n=t.r(265005),a=t.r(225913),s=t.r(559766);!function(t){t[t.EXPIRED=20010]="EXPIRED",t[t.REFUND_DATA=2e4]="REFUND_DATA",t[t.NOT_FOUND=20007]="NOT_FOUND",t[t.PENDING=20008]="PENDING",t[t.PAID=20006]="PAID"}(i.RefundAuthorizationResponseCodes||(i.RefundAuthorizationResponseCodes={})),function(t){t[t.AUTH_DATA=1e4]="AUTH_DATA",t[t.EXPIRED=10001]="EXPIRED",t[t.PAID=10002]="PAID",t[t.PENDING=10003]="PENDING",t[t.ALREADY_COMMITTED=10004]="ALREADY_COMMITTED"}(i.PaymentAuthorizationResponseCodes||(i.PaymentAuthorizationResponseCodes={}));let o={data:n.FieldTypeEnum.Any,prefix:n.FieldTypeEnum.String,timeout:n.FieldTypeEnum.String,signature:n.FieldTypeEnum.String},l={amount:n.FieldTypeEnum.BigInt,address:n.FieldTypeEnum.String,satsPervByte:n.FieldTypeEnum.BigInt,networkFee:n.FieldTypeEnum.BigInt,swapFee:n.FieldTypeEnum.BigInt,totalFee:n.FieldTypeEnum.BigInt,total:n.FieldTypeEnum.BigInt,minRequiredExpiry:n.FieldTypeEnum.BigInt,...o},u={maxFee:n.FieldTypeEnum.BigInt,swapFee:n.FieldTypeEnum.BigInt,total:n.FieldTypeEnum.BigInt,confidence:n.FieldTypeEnum.Number,address:n.FieldTypeEnum.String,routingFeeSats:n.FieldTypeEnum.BigInt,...o},c={amount:n.FieldTypeEnum.BigInt,reqId:n.FieldTypeEnum.String},h={amount:n.FieldTypeEnum.BigInt,btcAddress:n.FieldTypeEnum.String,address:n.FieldTypeEnum.String,swapFee:n.FieldTypeEnum.BigInt,total:n.FieldTypeEnum.BigInt,confirmations:n.FieldTypeEnum.NumberOptional,...o},p={pr:n.FieldTypeEnum.String,swapFee:n.FieldTypeEnum.BigInt,total:n.FieldTypeEnum.BigInt,intermediaryKey:n.FieldTypeEnum.String,securityDeposit:n.FieldTypeEnum.BigInt},d={quoteId:n.FieldTypeEnum.String,expiry:n.FieldTypeEnum.Number,address:n.FieldTypeEnum.String,vaultId:n.FieldTypeEnum.BigInt,vaultBtcAddress:n.FieldTypeEnum.String,btcAddress:n.FieldTypeEnum.String,btcUtxo:n.FieldTypeEnum.String,btcFeeRate:n.FieldTypeEnum.Number,btcAmount:n.FieldTypeEnum.BigInt,btcAmountSwap:n.FieldTypeEnum.BigInt,btcAmountGas:n.FieldTypeEnum.BigInt,total:n.FieldTypeEnum.BigInt,totalGas:n.FieldTypeEnum.BigInt,totalFeeBtc:n.FieldTypeEnum.BigInt,swapFeeBtc:n.FieldTypeEnum.BigInt,swapFee:n.FieldTypeEnum.BigInt,gasSwapFeeBtc:n.FieldTypeEnum.BigInt,gasSwapFee:n.FieldTypeEnum.BigInt,callerFeeShare:n.FieldTypeEnum.BigInt,frontingFeeShare:n.FieldTypeEnum.BigInt,executionFeeShare:n.FieldTypeEnum.BigInt},f={txId:n.FieldTypeEnum.String};i.IntermediaryAPI=class{static async getIntermediaryInfo(t,e,i){let r=(0,s.randomBytes)(32).toString("hex"),n=await (0,s.httpPost)(t+"/info",{nonce:r},e,i);if(r!==JSON.parse(n.envelope).nonce)throw Error("Invalid response - nonce");return n}static async getRefundAuthorization(t,e,i,n,a){return(0,s.tryWithRetries)(()=>(0,s.httpGet)(t+"/getRefundAuthorization?paymentHash="+encodeURIComponent(e)+"&sequence="+encodeURIComponent(i.toString(10)),n,a),null,r.RequestError,a)}static async getPaymentAuthorization(t,e,i,n){return(0,s.tryWithRetries)(()=>(0,s.httpGet)(t+"/getInvoicePaymentAuth?paymentHash="+encodeURIComponent(e),i,n),null,r.RequestError,n)}static initToBTC(t,e,i,s,o,u){let c=(0,a.streamingFetchPromise)(e+"/tobtc/payInvoice?chain="+encodeURIComponent(t),{...i.additionalParams,address:i.btcAddress,amount:i.amount.toString(10),exactIn:i.exactIn,confirmationTarget:i.confirmationTarget,confirmations:i.confirmations,nonce:i.nonce.toString(10),token:i.token,offerer:i.offerer,feeRate:i.feeRate},{code:n.FieldTypeEnum.Number,msg:n.FieldTypeEnum.String,data:n.FieldTypeEnum.AnyOptional,signDataPrefetch:n.FieldTypeEnum.AnyOptional},s,o,u);return{signDataPrefetch:c.then(t=>t.signDataPrefetch),response:c.then(t=>Promise.all([t.code,t.msg,t.data])).then(t=>{let[e,i,a]=t;if(2e4!==e)throw r.RequestError.parse(JSON.stringify({code:e,msg:i,data:a}),400);return(0,n.verifySchema)(a,l)})}}static initFromBTC(t,e,i,s,o,l,u){let c=(0,a.streamingFetchPromise)(e+"/frombtc/getAddress?chain="+encodeURIComponent(t)+"&depositToken="+encodeURIComponent(i),{...s.additionalParams,address:s.claimer,amount:s.amount.toString(10),token:s.token,exactOut:s.exactOut,sequence:s.sequence.toString(10),claimerBounty:s.claimerBounty.then(t=>({feePerBlock:t.feePerBlock.toString(10),safetyFactor:t.safetyFactor,startTimestamp:t.startTimestamp.toString(10),addBlock:t.addBlock,addFee:t.addFee.toString(10)})),feeRate:s.feeRate},{code:n.FieldTypeEnum.Number,msg:n.FieldTypeEnum.String,data:n.FieldTypeEnum.AnyOptional,signDataPrefetch:n.FieldTypeEnum.AnyOptional},o,l,u);return{signDataPrefetch:c.then(t=>t.signDataPrefetch),response:c.then(t=>Promise.all([t.code,t.msg,t.data])).then(t=>{let[e,i,a]=t;if(2e4!==e)throw r.RequestError.parse(JSON.stringify({code:e,msg:i,data:a}),400);return(0,n.verifySchema)(a,h)})}}static initFromBTCLN(t,e,i,s,o,l,u){let c=(0,a.streamingFetchPromise)(e+"/frombtcln/createInvoice?chain="+encodeURIComponent(t)+"&depositToken="+encodeURIComponent(i),{...s.additionalParams,paymentHash:s.paymentHash.toString("hex"),amount:s.amount.toString(),address:s.claimer,token:s.token,descriptionHash:null==s.descriptionHash?null:s.descriptionHash.toString("hex"),exactOut:s.exactOut,feeRate:s.feeRate},{code:n.FieldTypeEnum.Number,msg:n.FieldTypeEnum.String,data:n.FieldTypeEnum.AnyOptional,lnPublicKey:n.FieldTypeEnum.StringOptional},o,l,u);return{lnPublicKey:c.then(t=>t.lnPublicKey),response:c.then(t=>Promise.all([t.code,t.msg,t.data])).then(t=>{let[e,i,a]=t;if(2e4!==e)throw r.RequestError.parse(JSON.stringify({code:e,msg:i,data:a}),400);return(0,n.verifySchema)(a,p)})}}static initToBTCLN(t,e,i,s,o,l){let c=(0,a.streamingFetchPromise)(e+"/tobtcln/payInvoice?chain="+encodeURIComponent(t),{exactIn:!1,...i.additionalParams,pr:i.pr,maxFee:i.maxFee.toString(10),expiryTimestamp:i.expiryTimestamp.toString(10),token:i.token,offerer:i.offerer,feeRate:i.feeRate,amount:null},{code:n.FieldTypeEnum.Number,msg:n.FieldTypeEnum.String,data:n.FieldTypeEnum.AnyOptional,signDataPrefetch:n.FieldTypeEnum.AnyOptional},s,o,l);return{signDataPrefetch:c.then(t=>t.signDataPrefetch),response:c.then(t=>Promise.all([t.code,t.msg,t.data])).then(t=>{let[e,i,a]=t;if(2e4!==e)throw r.RequestError.parse(JSON.stringify({code:e,msg:i,data:a}),400);return(0,n.verifySchema)(a,u)})}}static async initToBTCLNExactIn(t,e,i,s,o){let l=await (0,a.streamingFetchPromise)(t+"/tobtcln/payInvoiceExactIn",{...e.additionalParams,pr:e.pr,reqId:e.reqId,feeRate:e.feeRate},{code:n.FieldTypeEnum.Number,msg:n.FieldTypeEnum.String,data:n.FieldTypeEnum.AnyOptional},i,s,o),[c,h,p]=await Promise.all([l.code,l.msg,l.data]);if(2e4!==c)throw r.RequestError.parse(JSON.stringify({code:c,msg:h,data:p}),400);return(0,n.verifySchema)(p,u)}static prepareToBTCLNExactIn(t,e,i,s,o,l){let u=(0,a.streamingFetchPromise)(e+"/tobtcln/payInvoice?chain="+encodeURIComponent(t),{exactIn:!0,...i.additionalParams,pr:i.pr,maxFee:i.maxFee.toString(10),expiryTimestamp:i.expiryTimestamp.toString(10),token:i.token,offerer:i.offerer,amount:i.amount.toString(10)},{code:n.FieldTypeEnum.Number,msg:n.FieldTypeEnum.String,data:n.FieldTypeEnum.AnyOptional,signDataPrefetch:n.FieldTypeEnum.AnyOptional},s,o,l);return{signDataPrefetch:u.then(t=>t.signDataPrefetch),response:u.then(t=>Promise.all([t.code,t.msg,t.data])).then(t=>{let[e,i,a]=t;if(2e4!==e)throw r.RequestError.parse(JSON.stringify({code:e,msg:i,data:a}),400);return(0,n.verifySchema)(a,c)})}}static prepareSpvFromBTC(t,e,i,s,o,l){return(0,a.streamingFetchPromise)(e+"/frombtc_spv/getQuote?chain="+encodeURIComponent(t),{exactOut:i.exactOut,...i.additionalParams,address:i.address,amount:i.amount.toString(10),token:i.token,gasAmount:i.gasAmount.toString(10),gasToken:i.gasToken,frontingFeeRate:i.frontingFeeRate.toString(10),callerFeeRate:i.callerFeeRate.then(t=>t.toString(10))},{code:n.FieldTypeEnum.Number,msg:n.FieldTypeEnum.String,data:n.FieldTypeEnum.AnyOptional},s,o,l).then(t=>Promise.all([t.code,t.msg,t.data])).then(t=>{let[e,i,a]=t;if(2e4!==e)throw r.RequestError.parse(JSON.stringify({code:e,msg:i,data:a}),400);return(0,n.verifySchema)(a,d)})}static initSpvFromBTC(t,e,i,s,o,l){return(0,a.streamingFetchPromise)(e+"/postQuote?chain="+encodeURIComponent(t),{quoteId:i.quoteId,psbtHex:i.psbtHex},{code:n.FieldTypeEnum.Number,msg:n.FieldTypeEnum.String,data:n.FieldTypeEnum.AnyOptional},s,o,l).then(t=>Promise.all([t.code,t.msg,t.data])).then(t=>{let[e,i,a]=t;if(2e4!==e)throw r.RequestError.parse(JSON.stringify({code:e,msg:i,data:a}),400);return(0,n.verifySchema)(a,f)})}}},22436,(t,e,i)=>{"use strict";var r;Object.defineProperty(i,"__esModule",{value:!0}),i.IntermediaryDiscovery=i.SwapHandlerType=void 0;let n=t.r(506498),a=t.r(865854),s=t.r(991989),o=t.r(219298),l=t.r(843943),u=t.r(559766),c=t.r(366913);!function(t){t.TO_BTC="TO_BTC",t.FROM_BTC="FROM_BTC",t.TO_BTCLN="TO_BTCLN",t.FROM_BTCLN="FROM_BTCLN",t.FROM_BTC_TRUSTED="FROM_BTC_TRUSTED",t.FROM_BTCLN_TRUSTED="FROM_BTCLN_TRUSTED",t.FROM_BTC_SPV="FROM_BTC_SPV"}(r=i.SwapHandlerType||(i.SwapHandlerType={}));let h=(0,u.getLogger)("IntermediaryDiscovery: ");class p extends o.EventEmitter{async getIntermediaryUrls(t){if(null!=this.overrideNodeUrls&&this.overrideNodeUrls.length>0)return this.overrideNodeUrls;let e=(await (0,u.httpGet)(this.registryUrl,this.httpRequestTimeout,t)).content.replace(RegExp("\\n","g"),"");return JSON.parse(l.Buffer.from(e,"base64").toString())}async getNodeInfo(t,e){let i=await (0,u.tryWithRetries)(()=>c.IntermediaryAPI.getIntermediaryInfo(t,this.httpRequestTimeout,e),{maxRetries:3,delay:100,exponential:!0},void 0,e),r={};for(let n in i.chains)if(null!=this.swapContracts[n]){let{signature:a,address:o}=i.chains[n];try{await (0,u.tryWithRetries)(()=>this.swapContracts[n].isValidDataSignature(l.Buffer.from(i.envelope),a,o),{maxRetries:3,delay:100,exponential:!0},s.SignatureVerificationError,e),r[n]=o}catch(e){h.warn("Failed to verify "+n+" signature for intermediary: "+t)}}null!=e&&e.throwIfAborted();let n=JSON.parse(i.envelope);for(let t in n.services){let e=n.services[t];for(let t in null==e.chainTokens&&(e.chainTokens={SOLANA:e.tokens}),e.chainTokens)null==r[t]&&delete e.chainTokens[t]}return{addresses:r,info:n}}async loadIntermediary(t,e){try{let i=await this.getNodeInfo(t,e),s={};for(let t in i.info.services)s[function(t){switch(t){case r.FROM_BTC:return a.SwapType.FROM_BTC;case r.TO_BTC:return a.SwapType.TO_BTC;case r.FROM_BTCLN:return a.SwapType.FROM_BTCLN;case r.TO_BTCLN:return a.SwapType.TO_BTCLN;case r.FROM_BTC_TRUSTED:return a.SwapType.TRUSTED_FROM_BTC;case r.FROM_BTCLN_TRUSTED:return a.SwapType.TRUSTED_FROM_BTCLN;case r.FROM_BTC_SPV:return a.SwapType.SPV_VAULT_FROM_BTC}}(t)]=i.info.services[t];return new n.Intermediary(t,i.addresses,s)}catch(e){return h.warn("fetchIntermediaries(): Error contacting intermediary "+t+": ",e),null}}async fetchIntermediaries(t){let e=await this.getIntermediaryUrls(t);h.debug("fetchIntermediaries(): Pinging intermediaries: ",e.join());let i=e.map(e=>this.loadIntermediary(e,t)),r=(await Promise.all(i)).filter(t=>null!=t);if(0===r.length)throw Error("No online intermediary found!");return r}getIntermediary(t){let e=this.intermediaries.find(e=>e.url===t);return null!=e?Promise.resolve(e):this.loadIntermediary(t)}async reloadIntermediaries(t){let e=await (0,u.tryWithRetries)(()=>this.fetchIntermediaries(t),null,null,t);this.intermediaries=e,this.emit("added",e),h.info("reloadIntermediaries(): Using active intermediaries: ",e.map(t=>t.url).join())}init(t){return h.info("init(): Initializing with registryUrl: "+this.registryUrl+" intermediary array: "+(this.overrideNodeUrls||[]).join()),this.reloadIntermediaries(t)}getMultichainSwapBounds(){let t={};return this.intermediaries.forEach(e=>{for(let i in e.services){let r=e.services[i];null!=t[i]||(t[i]={});let n=t[i];for(let t in r.chainTokens){null!=n[t]||(n[t]={});let e=n[t];for(let i of r.chainTokens[t]){let t=e[i];null==t?e[i]={min:BigInt(r.min),max:BigInt(r.max)}:(t.min=(0,u.bigIntMin)(t.min,BigInt(r.min)),t.max=(0,u.bigIntMax)(t.max,BigInt(r.max)))}}}}),t}getSwapBounds(t){let e={};return this.intermediaries.forEach(i=>{for(let r in i.services){let n=i.services[r];null==e[r]&&(e[r]={});let a=e[r];if(null!=n.chainTokens&&null!=n.chainTokens[t])for(let e of n.chainTokens[t]){let t=a[e];null==t?a[e]={min:BigInt(n.min),max:BigInt(n.max)}:(t.min=(0,u.bigIntMin)(t.min,BigInt(n.min)),t.max=(0,u.bigIntMax)(t.max,BigInt(n.max)))}}}),e}getSwapMinimum(t,e,i){let r=i.toString();return this.intermediaries.reduce((i,n)=>{let a=n.services[e];return null!=a&&null!=a.chainTokens&&null!=a.chainTokens[t]&&a.chainTokens[t].includes(r)?null==i?a.min:Math.min(i,a.min):i},null)}getSwapMaximum(t,e,i){let r=i.toString();return this.intermediaries.reduce((i,n)=>{let a=n.services[e];return null!=a&&null!=a.chainTokens&&null!=a.chainTokens[t]&&a.chainTokens[t].includes(r)?null==i?a.max:Math.max(i,a.max):i},null)}getSwapCandidates(t,e,i,r,n){let s=this.intermediaries.filter(n=>{let a=n.services[e];return!(null==a||null!=r&&r<BigInt(a.min)||null!=r&&r>BigInt(a.max))&&null!=a.chainTokens&&null!=a.chainTokens[t]&&!!a.chainTokens[t].includes(i.toString())});return(s.sort((a.SwapType.TO_BTC,(t,i)=>{if(null==r)return t.services[e].swapFeePPM-i.services[e].swapFeePPM;{let n=BigInt(t.services[e].swapBaseFee)+r*BigInt(t.services[e].swapFeePPM)/1000000n,a=BigInt(i.services[e].swapBaseFee)+r*BigInt(i.services[e].swapFeePPM)/1000000n;return n-a>0n?1:n===a?0:-1}})),null==n)?s:s.slice(0,n)}removeIntermediary(t){let e=this.intermediaries.indexOf(t);return e>=0&&(h.info("removeIntermediary(): Removing intermediary: "+t.url),this.intermediaries.splice(e,1),this.emit("removed",[t]),!0)}constructor(t,e="https://api.github.com/repos/adambor/SolLightning-registry/contents/registry.json?ref=main",i,r){super(),this.intermediaries=[],this.swapContracts=t,this.registryUrl=e,this.overrideNodeUrls=i,this.httpRequestTimeout=r}}i.IntermediaryDiscovery=p},375581,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.ISwapPrice=i.isPriceInfoType=void 0,i.isPriceInfoType=function(t){return null!=t&&"boolean"==typeof t.isValid&&"bigint"==typeof t.differencePPM&&"bigint"==typeof t.satsBaseFee&&"bigint"==typeof t.feePPM&&"bigint"==typeof t.realPriceUSatPerToken&&"bigint"==typeof t.swapPriceUSatPerToken},i.ISwapPrice=class{recomputePriceInfoSend(t,e,i,r,n,a){let s=1000000n*(e*(1000000n+r)/1000000n+i)*10n**BigInt(this.getDecimals(t,a))/n;return{isValid:!0,differencePPM:0n,satsBaseFee:i,feePPM:r,realPriceUSatPerToken:this.shouldIgnore(t,a)?null:s,swapPriceUSatPerToken:s}}async isValidAmountSend(t,e,i,r,n,a,s,o){let l=e*(1000000n+r)/1000000n+i,u=1000000n*l,c=u*10n**BigInt(this.getDecimals(t,a))/n;if(this.shouldIgnore(t,a))return{isValid:!0,differencePPM:0n,satsBaseFee:i,feePPM:r,realPriceUSatPerToken:null,swapPriceUSatPerToken:c};let h=await this.getFromBtcSwapAmount(t,l,a,s,o),p=u*10n**BigInt(this.getDecimals(t,a))/h,d=1000000n*(n-h)/h;return{isValid:d<=this.maxAllowedFeeDifferencePPM,differencePPM:d,satsBaseFee:i,feePPM:r,realPriceUSatPerToken:p,swapPriceUSatPerToken:c}}recomputePriceInfoReceive(t,e,i,r,n,a){let s=1000000n*(e*(1000000n-r)/1000000n-i)*10n**BigInt(this.getDecimals(t,a))/n;return{isValid:!0,differencePPM:0n,satsBaseFee:i,feePPM:r,realPriceUSatPerToken:this.shouldIgnore(t,a)?null:s,swapPriceUSatPerToken:s}}async isValidAmountReceive(t,e,i,r,n,a,s,o){let l=e*(1000000n-r)/1000000n-i,u=1000000n*l,c=u*10n**BigInt(this.getDecimals(t,a))/n;if(this.shouldIgnore(t,a))return{isValid:!0,differencePPM:0n,satsBaseFee:i,feePPM:r,realPriceUSatPerToken:null,swapPriceUSatPerToken:c};let h=await this.getFromBtcSwapAmount(t,l,a,s,o),p=u*10n**BigInt(this.getDecimals(t,a))/h,d=100000n*(h-n)/h;return{isValid:d<=this.maxAllowedFeeDifferencePPM,differencePPM:d,satsBaseFee:i,feePPM:r,realPriceUSatPerToken:p,swapPriceUSatPerToken:c}}preFetchPrice(t,e,i){return this.getPrice(t,e,i)}preFetchUsdPrice(t){return this.getUsdPrice(t)}async getFromBtcSwapAmount(t,e,i,r,n){if(null==this.getDecimals(t,i.toString()))throw Error("Token not found!");let a=n||await this.getPrice(t,i,r);return e*10n**BigInt(this.getDecimals(t,i.toString()))*1000000n/a}async getToBtcSwapAmount(t,e,i,r,n){if(null==this.getDecimals(t,i.toString()))throw Error("Token not found");return e*(n||await this.getPrice(t,i,r))/1000000n/10n**BigInt(this.getDecimals(t,i.toString()))}shouldIgnore(t,e){let i=this.getDecimals(t,e.toString());if(null==i)throw Error("Token not found");return -1===i}async getBtcUsdValue(t,e,i){return Number(t)*(i||await this.getUsdPrice(e))}async getTokenUsdValue(t,e,i,r,n){let[a,s]=await Promise.all([this.getToBtcSwapAmount(t,e,i,r),null==n?this.preFetchUsdPrice(r):Promise.resolve(n)]);return Number(a)*s}getUsdValue(t,e,i,r){return"BTC"===e.chain?this.getBtcUsdValue(t,i,r):this.getTokenUsdValue(e.chainId,t,e.address,i,r)}constructor(t){this.maxAllowedFeeDifferencePPM=t}}},966025,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.ICachedSwapPrice=void 0;let r=t.r(375581);class n extends r.ISwapPrice{getPrice(t,e,i){var r;let n=e.toString(),a=this.cache[t];if(null!=a){let e=a[n];if(null!=e&&e.expiry>Date.now())return e.price.catch(e=>this.fetchPrice(t,n,i))}let s=this.fetchPrice(t,n);return null!=(r=this.cache)[t]||(r[t]={}),this.cache[t][n]={price:s,expiry:Date.now()+this.cacheTimeout},s.catch(e=>{throw null!=this.cache[t]&&null!=this.cache[t][n]&&this.cache[t][n].price===s&&delete this.cache[n],e}),s}getUsdPrice(t){if(null!=this.usdCache&&this.usdCache.expiry>Date.now())return this.usdCache.price.catch(e=>this.fetchUsdPrice(t));let e=this.fetchUsdPrice();return this.usdCache={price:e,expiry:Date.now()+this.cacheTimeout},e.catch(t=>{throw null!=this.usdCache&&this.usdCache.price===e&&delete this.usdCache,t}),e}constructor(t,e){super(t),this.cache={},this.cacheTimeout=e||1e4}}i.ICachedSwapPrice=n},588164,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.IPriceProvider=void 0,i.IPriceProvider=class{getPrice(t,e,i){let r=e.toString(),n=this.coinsMap[t];if(null==n)throw Error("Chain not found");let a=n[r];if(null==a)throw Error("Token not found");return a.coinId.startsWith("$fixed-")?Promise.resolve(BigInt(Math.floor(1e6*parseFloat(a.coinId.substring(7))).toString(10))):this.fetchPrice(a,i)}getUsdPrice(t){return this.fetchUsdPrice(t)}getDecimals(t,e){let i=this.coinsMap[t];if(null==i)throw Error("Chain not found");let r=i[e.toString()];if(null==r)throw Error("Token not found");return"$ignore"===r.coinId?-1:r.decimals}constructor(t){for(let i of(this.coinsMap={},t))if(null!=i.coinId)for(let t in i.chains){var e;let{address:r,decimals:n}=i.chains[t];null!=(e=this.coinsMap)[t]||(e[t]={}),this.coinsMap[t][r.toString()]={coinId:i.coinId,decimals:n}}}}},434482,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.HttpPriceProvider=void 0;let r=t.r(588164);class n extends r.IPriceProvider{constructor(t,e,i){super(t),this.url=e,this.httpRequestTimeout=i}}i.HttpPriceProvider=n},414539,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.ExchangePriceProvider=void 0;let r=t.r(434482);class n extends r.HttpPriceProvider{async fetchPrice(t,e){let i=t.coinId.split(";");return BigInt(Math.floor(1e14*(await Promise.all(i.map(t=>{let i=t.startsWith("!");return i&&(t=t.substring(1)),this.fetchPair(t,e).then(t=>i?1/t:t)}))).reduce((t,e)=>t*e,1)))}}i.ExchangePriceProvider=n},382469,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.BinancePriceProvider=void 0;let r=t.r(414539),n=t.r(559766);class a extends r.ExchangePriceProvider{async fetchPair(t,e){return parseFloat((await (0,n.httpGet)(this.url+"/ticker/price?symbol="+t,this.httpRequestTimeout,e)).price)}async fetchUsdPrice(t){return parseFloat((await (0,n.httpGet)(this.url+"/ticker/price?symbol=BTCUSDC",this.httpRequestTimeout,t)).price)/1e8}constructor(t,e="https://api.binance.com/api/v3",i){super(t,e,i)}}i.BinancePriceProvider=a},388938,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.CoinGeckoPriceProvider=void 0;let r=t.r(434482),n=t.r(559766);class a extends r.HttpPriceProvider{async fetchPrice(t,e){return BigInt(1e6*(await (0,n.httpGet)(this.url+"/simple/price?ids="+t.coinId+"&vs_currencies=sats&precision=6",this.httpRequestTimeout,e))[t.coinId].sats)}async fetchUsdPrice(t){return(await (0,n.httpGet)(this.url+"/simple/price?ids=bitcoin&vs_currencies=usd&precision=9",this.httpRequestTimeout,t)).bitcoin.usd/1e8}constructor(t,e="https://api.coingecko.com/api/v3",i){super(t,e,i)}}i.CoinGeckoPriceProvider=a},466577,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.CoinPaprikaPriceProvider=void 0;let r=t.r(434482),n=t.r(559766);class a extends r.HttpPriceProvider{async fetchPrice(t,e){return BigInt(Math.floor(1e14*(await (0,n.httpGet)(this.url+"/tickers/"+t.coinId+"?quotes=BTC",this.httpRequestTimeout,e)).quotes.BTC.price))}async fetchUsdPrice(t){return(await (0,n.httpGet)(this.url+"/tickers/btc-bitcoin?quotes=USD",this.httpRequestTimeout,t)).quotes.USD.price/1e8}constructor(t,e="https://api.coinpaprika.com/v1",i){super(t,e,i)}}i.CoinPaprikaPriceProvider=a},963868,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.OKXPriceProvider=void 0;let r=t.r(414539),n=t.r(559766);class a extends r.ExchangePriceProvider{async fetchPair(t,e){return parseFloat((await (0,n.httpGet)(this.url+"/market/index-tickers?instId="+t,this.httpRequestTimeout,e)).data[0].idxPx)}async fetchUsdPrice(t){return parseFloat((await (0,n.httpGet)(this.url+"/market/index-tickers?instId=BTC-USD",this.httpRequestTimeout,t)).data[0].idxPx)/1e8}constructor(t,e="https://www.okx.com/api/v5",i){super(t,e,i)}}i.OKXPriceProvider=a},527556,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.CustomPriceProvider=void 0;let r=t.r(588164);class n extends r.IPriceProvider{async fetchPrice(t,e){let[i,r]=await this.getUsdPriceFn(["BTC",t.coinId],e);return BigInt(Math.floor(r/i*1e14))}async fetchUsdPrice(t){let[e]=await this.getUsdPriceFn(["BTC"],t);return e/1e8}constructor(t,e){super(t),this.getUsdPriceFn=e}}i.CustomPriceProvider=n},338012,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.KrakenPriceProvider=void 0;let r=t.r(414539),n=t.r(559766);class a extends r.ExchangePriceProvider{async fetchPair(t,e){return parseFloat((await (0,n.httpGet)(this.url+"/public/Ticker?pair="+t,this.httpRequestTimeout,e)).result[t].c[0])}async fetchUsdPrice(t){return parseFloat((await (0,n.httpGet)(this.url+"/public/Ticker?pair=XBTUSDC",this.httpRequestTimeout,t)).result.XBTUSDC.c[0])/1e8}async fetchPrice(t,e){let i=t.coinId.split(";"),r=await (0,n.httpGet)(this.url+"/public/Ticker?pair="+i.map(t=>t.startsWith("!")?t.substring(1):t).join(","),this.httpRequestTimeout,e);return BigInt(Math.floor(1e14*i.map(t=>{let e=t.startsWith("!");e&&(t=t.substring(1));let i=parseFloat(r.result[t].c[0]);return e?1/i:i}).reduce((t,e)=>t*e,1)))}constructor(t,e="https://api.kraken.com/0",i){super(t,e,i)}}i.KrakenPriceProvider=a},719555,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.RedundantSwapPrice=void 0;let r=t.r(382469),n=t.r(963868),a=t.r(388938),s=t.r(466577),o=t.r(559766),l=t.r(966025),u=t.r(686157),c=t.r(338012),h=(0,o.getLogger)("RedundantSwapPrice: ");class p extends l.ICachedSwapPrice{static createFromTokenMap(t,e,i){let o=[new r.BinancePriceProvider(e.map(t=>({coinId:t.binancePair,chains:t.chains}))),new n.OKXPriceProvider(e.map(t=>({coinId:t.okxPair,chains:t.chains}))),new a.CoinGeckoPriceProvider(e.map(t=>({coinId:t.coinGeckoCoinId,chains:t.chains}))),new s.CoinPaprikaPriceProvider(e.map(t=>({coinId:t.coinPaprikaCoinId,chains:t.chains}))),new c.KrakenPriceProvider(e.map(t=>({coinId:t.krakenPair,chains:t.chains})))];return new p(t,e,o,i)}getOperationalPriceApi(){return this.priceApis.find(t=>!0===t.operational)}getMaybeOperationalPriceApis(){let t=this.priceApis.filter(t=>!0===t.operational||null===t.operational);return 0===t.length&&(this.priceApis.forEach(t=>t.operational=null),t=this.priceApis),t}async fetchPriceFromMaybeOperationalPriceApis(t,e,i){try{return await (0,o.promiseAny)(this.getMaybeOperationalPriceApis().map(r=>(async()=>{try{let n=await r.priceApi.getPrice(t,e,i);return h.debug("fetchPrice(): Price from "+r.priceApi.constructor.name+": ",n.toString(10)),r.operational=!0,n}catch(t){throw null!=i&&i.throwIfAborted(),r.operational=!1,t}})()))}catch(t){throw null!=i&&i.throwIfAborted(),t.find(t=>!(t instanceof u.RequestError))||t[0]}}fetchPrice(t,e,i){return(0,o.tryWithRetries)(async()=>{let r=this.getOperationalPriceApi();if(null!=r)try{return await r.priceApi.getPrice(t,e,i)}catch(t){null!=i&&i.throwIfAborted(),r.operational=!1}return await this.fetchPriceFromMaybeOperationalPriceApis(t,e,i)},null,u.RequestError,i)}getDecimals(t,e){return null==this.coinsDecimals[t]?null:this.coinsDecimals[t][e.toString()]}async fetchUsdPriceFromMaybeOperationalPriceApis(t){try{return await (0,o.promiseAny)(this.getMaybeOperationalPriceApis().map(e=>(async()=>{try{let i=await e.priceApi.getUsdPrice(t);return h.debug("fetchPrice(): USD price from "+e.priceApi.constructor.name+": ",i.toString(10)),e.operational=!0,i}catch(i){throw null!=t&&t.throwIfAborted(),e.operational=!1,i}})()))}catch(e){throw null!=t&&t.throwIfAborted(),e.find(t=>!(t instanceof u.RequestError))||e[0]}}fetchUsdPrice(t){return(0,o.tryWithRetries)(()=>{let e=this.getOperationalPriceApi();return null!=e?e.priceApi.getUsdPrice(t).catch(i=>(null!=t&&t.throwIfAborted(),e.operational=!1,this.fetchUsdPriceFromMaybeOperationalPriceApis(t))):this.fetchUsdPriceFromMaybeOperationalPriceApis(t)},null,u.RequestError,t)}constructor(t,e,i,r){for(let i of(super(t,r),this.coinsDecimals={},e))for(let t in i.chains){var n;let{address:e,decimals:r}=i.chains[t];null!=(n=this.coinsDecimals)[t]||(n[t]={}),this.coinsDecimals[t][e.toString()]=r}this.priceApis=i.map(t=>({priceApi:t,operational:null}))}}i.RedundantSwapPrice=p},756491,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.SingleSwapPrice=void 0;let r=t.r(966025);class n extends r.ICachedSwapPrice{fetchPrice(t,e,i){return this.priceProvider.getPrice(t,e,i)}getDecimals(t,e){return this.priceProvider.getDecimals(t,e.toString())}fetchUsdPrice(t){return this.priceProvider.getUsdPrice(t)}constructor(t,e,i){super(t,i),this.priceProvider=e}}i.SingleSwapPrice=n},424089,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.SwapPriceWithChain=void 0,i.SwapPriceWithChain=class{async isValidAmountSend(t,e,i,r,n,a,s){return this.swapPrice.isValidAmountSend(this.chainIdentifier,t,e,i,r,n,a,s)}async isValidAmountReceive(t,e,i,r,n,a,s){return this.swapPrice.isValidAmountReceive(this.chainIdentifier,t,e,i,r,n,a,s)}preFetchPrice(t,e){return this.swapPrice.preFetchPrice(this.chainIdentifier,t,e)}preFetchUsdPrice(t){return this.swapPrice.preFetchUsdPrice(t)}async getFromBtcSwapAmount(t,e,i,r){return this.swapPrice.getFromBtcSwapAmount(this.chainIdentifier,t,e,i,r)}async getToBtcSwapAmount(t,e,i,r){return this.swapPrice.getToBtcSwapAmount(this.chainIdentifier,t,e,i,r)}shouldIgnore(t){return this.swapPrice.shouldIgnore(this.chainIdentifier,t)}async getBtcUsdValue(t,e,i){return this.swapPrice.getBtcUsdValue(t,e,i)}async getTokenUsdValue(t,e,i,r){return this.swapPrice.getTokenUsdValue(this.chainIdentifier,t,e,i,r)}getUsdValue(t,e,i,r){return this.swapPrice.getUsdValue(t,e,i,r)}constructor(t,e){this.swapPrice=t,this.chainIdentifier=e}}},768270,(t,e,i)=>{"use strict";function r(t){return"object"==typeof t&&"BTC"===t.chain&&"boolean"==typeof t.lightning&&"string"==typeof t.ticker&&"number"==typeof t.decimals&&"string"==typeof t.name}function n(t){return"object"==typeof t&&"SC"===t.chain&&"string"==typeof t.chainId&&"string"==typeof t.address&&"string"==typeof t.ticker&&"number"==typeof t.decimals&&"string"==typeof t.name}function a(t,e,i,r){if(e<=0)return t.toString(10)+"0".repeat(-e);let n=t.toString(10).padStart(e+1,"0"),a=n.length-e,s=n.substring(a,n.length),o=s.length;if(i&&o>0){for(let t=s.length-1;t--;)if("0"===s.charAt(t))o=t;else break;0===o&&(o=1)}return 0===r?n.substring(0,a):(null!=r&&o>r&&(o=r),n.substring(0,a)+"."+s.substring(0,o))}Object.defineProperty(i,"__esModule",{value:!0}),i.toTokenAmount=i.toDecimal=i.fromDecimal=i.isToken=i.isSCToken=i.BitcoinTokens=i.isBtcToken=void 0,i.isBtcToken=r,i.BitcoinTokens={BTC:{chain:"BTC",lightning:!1,ticker:"BTC",decimals:8,name:"Bitcoin (on-chain L1)"},BTCLN:{chain:"BTC",lightning:!0,ticker:"BTC",decimals:8,name:"Bitcoin (lightning L2)"}},i.isSCToken=n,i.isToken=function(t){return r(t)||n(t)},i.fromDecimal=function(t,e){if(t.includes(".")){let[i,r]=t.split(".");return e<0?BigInt(i.substring(0,i.length+e)):r.length>e?BigInt(("0"===i?"":i)+r.substring(0,e)):BigInt(("0"===i?"":i)+r.padEnd(e,"0"))}return e<0?BigInt(t.substring(0,t.length+e)):BigInt(t+"0".repeat(e))},i.toDecimal=a,i.toTokenAmount=function(t,e,i){if(null==t)return null;let r=a(t,e.decimals,void 0,e.displayDecimals);return{rawAmount:t,amount:r,_amount:parseFloat(r),token:e,usdValue:(r,n)=>i.getUsdValue(t,e,r,n),toString:()=>r+" "+e.ticker}}},127644,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.SwapDirection=void 0,function(t){t[t.FROM_BTC=0]="FROM_BTC",t[t.TO_BTC=1]="TO_BTC"}(i.SwapDirection||(i.SwapDirection={}))},958078,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.ISwap=i.ppmToPercentage=i.isISwapInit=void 0;let r=t.r(865854),n=t.r(219298),a=t.r(375581),s=t.r(559766),o=t.r(127644);function l(t){return"object"==typeof t&&null!=t&&(0,a.isPriceInfoType)(t.pricingInfo)&&"string"==typeof t.url&&"number"==typeof t.expiry&&"bigint"==typeof t.swapFee&&(null==t.swapFeeBtc||"bigint"==typeof t.swapFeeBtc)&&"boolean"==typeof t.exactIn}function u(t){if(null==t)return null;let e=Number(t)/1e4;return{ppm:t,decimal:Number(t)/1e6,percentage:e,toString:t=>(null!=t?e.toFixed(t):e)+"%"}}i.isISwapInit=l,i.ppmToPercentage=u,i.ISwap=class{waitTillState(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"eq",i=arguments.length>2?arguments[2]:void 0;return new Promise((r,n)=>{let a;a=i=>{("eq"===e?i.state===t:"gte"===e?i.state>=t:i.state!=t)&&(r(),this.events.removeListener("swapState",a))},this.events.on("swapState",a),null!=i&&i.addEventListener("abort",()=>{this.events.removeListener("swapState",a),n(i.reason)})})}tryRecomputeSwapPrice(){if(null==this.pricingInfo.swapPriceUSatPerToken)if(this.getDirection()===o.SwapDirection.TO_BTC){let t=this.getInput();this.pricingInfo=this.wrapper.prices.recomputePriceInfoSend(this.chainIdentifier,this.getOutput().rawAmount,this.pricingInfo.satsBaseFee,this.pricingInfo.feePPM,t.rawAmount,t.token.address)}else{let t=this.getOutput();this.pricingInfo=this.wrapper.prices.recomputePriceInfoReceive(this.chainIdentifier,this.getInput().rawAmount,this.pricingInfo.satsBaseFee,this.pricingInfo.feePPM,t.rawAmount,t.token.address)}}async refreshPriceData(){if(null==this.pricingInfo)return null;if(this.getDirection()===o.SwapDirection.TO_BTC){let t=this.getInput();this.pricingInfo=await this.wrapper.prices.isValidAmountSend(this.chainIdentifier,this.getOutput().rawAmount,this.pricingInfo.satsBaseFee,this.pricingInfo.feePPM,t.rawAmount,t.token.address)}else{let t=this.getOutput();this.pricingInfo=await this.wrapper.prices.isValidAmountReceive(this.chainIdentifier,this.getInput().rawAmount,this.pricingInfo.satsBaseFee,this.pricingInfo.feePPM,t.rawAmount,t.token.address)}}hasValidPrice(){return null==this.pricingInfo?null:this.pricingInfo.isValid}getPriceInfo(){let t=this.getDirection()===o.SwapDirection.TO_BTC?1e14/Number(this.pricingInfo.swapPriceUSatPerToken):Number(this.pricingInfo.swapPriceUSatPerToken)/1e14;return{marketPrice:this.getDirection()===o.SwapDirection.TO_BTC?1e14/Number(this.pricingInfo.realPriceUSatPerToken):Number(this.pricingInfo.swapPriceUSatPerToken)/1e14,swapPrice:t,difference:u(this.pricingInfo.differencePPM)}}checkSigner(t){if(("string"==typeof t?t:t.getAddress())!==this._getInitiator())throw Error("Invalid signer provided!")}isInitiated(){return this.initiated}_setInitiated(){this.initiated=!0}getQuoteExpiry(){return this.expiry}getType(){return this.TYPE}getDirection(){return this.TYPE===r.SwapType.TO_BTC||this.TYPE===r.SwapType.TO_BTCLN?o.SwapDirection.TO_BTC:o.SwapDirection.FROM_BTC}getState(){return this.state}serialize(){return null==this.pricingInfo?{}:{id:this.getId(),type:this.getType(),escrowHash:this._getEscrowHash(),initiator:this._getInitiator(),_isValid:this.pricingInfo.isValid,_differencePPM:null==this.pricingInfo.differencePPM?null:this.pricingInfo.differencePPM.toString(10),_satsBaseFee:null==this.pricingInfo.satsBaseFee?null:this.pricingInfo.satsBaseFee.toString(10),_feePPM:null==this.pricingInfo.feePPM?null:this.pricingInfo.feePPM.toString(10),_realPriceUSatPerToken:null==this.pricingInfo.realPriceUSatPerToken?null:this.pricingInfo.realPriceUSatPerToken.toString(10),_swapPriceUSatPerToken:null==this.pricingInfo.swapPriceUSatPerToken?null:this.pricingInfo.swapPriceUSatPerToken.toString(10),state:this.state,url:this.url,swapFee:null==this.swapFee?null:this.swapFee.toString(10),swapFeeBtc:null==this.swapFeeBtc?null:this.swapFeeBtc.toString(10),expiry:this.expiry,version:this.version,initiated:this.initiated,exactIn:this.exactIn,createdAt:this.createdAt,randomNonce:this.randomNonce}}_save(){return this.isQuoteExpired()?this.wrapper.removeSwapData(this):this.wrapper.saveSwapData(this)}async _saveAndEmit(t){null!=t&&(this.state=t),await this._save(),this._emitEvent()}_emitEvent(){this.wrapper.events.emit("swapState",this),this.events.emit("swapState",this)}constructor(t,e){if(this.currentVersion=1,this.initiated=!1,this.events=new n.EventEmitter,this.chainIdentifier=t.chainIdentifier,this.wrapper=t,l(e))Object.assign(this,e),this.version=this.currentVersion,this.createdAt=Date.now(),this.randomNonce=(0,s.randomBytes)(16).toString("hex");else{var i;this.expiry=e.expiry,this.url=e.url,this.state=e.state,this.pricingInfo={isValid:e._isValid,differencePPM:null==e._differencePPM?null:BigInt(e._differencePPM),satsBaseFee:null==e._satsBaseFee?null:BigInt(e._satsBaseFee),feePPM:null==e._feePPM?null:BigInt(e._feePPM),realPriceUSatPerToken:null==e._realPriceUSatPerToken?null:BigInt(e._realPriceUSatPerToken),swapPriceUSatPerToken:null==e._swapPriceUSatPerToken?null:BigInt(e._swapPriceUSatPerToken)},this.swapFee=null==e.swapFee?null:BigInt(e.swapFee),this.swapFeeBtc=null==e.swapFeeBtc?null:BigInt(e.swapFeeBtc),this.version=e.version,this.initiated=e.initiated,this.exactIn=e.exactIn,this.createdAt=null!=(i=e.createdAt)?i:e.expiry,this.randomNonce=e.randomNonce}this.version!==this.currentVersion&&this.upgradeVersion(),null==this.initiated&&(this.initiated=!0)}}},307440,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0})},462501,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.ISwapWrapper=void 0;let r=t.r(219298),n=t.r(145617),a=t.r(559766);i.ISwapWrapper=class{preFetchPrice(t,e){return this.prices.preFetchPrice(this.chainIdentifier,t.token,e).catch(t=>(this.logger.error("preFetchPrice(): Error: ",t),null))}async verifyReturnedPrice(t,e,i,r,a,s){let o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:Promise.resolve(null),l=arguments.length>7?arguments[7]:void 0,u=BigInt(t.swapBaseFee),c=BigInt(t.swapFeePPM);e&&(r-=s.networkFee);let h=await (e?this.prices.isValidAmountSend(this.chainIdentifier,i,u,c,r,a,l,await o):this.prices.isValidAmountReceive(this.chainIdentifier,i,u,c,r,a,l,await o));if(!h.isValid)throw new n.IntermediaryError("Fee too high");return h}async init(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this.isInitialized)return;let i=null!=this.processEvent,r=[];if(i&&this.unifiedChainEvents.registerListener(this.TYPE,(t,e)=>(r.push({event:t,swap:e}),Promise.resolve()),this.swapDeserializer.bind(null,this)),e||await this.checkPastSwaps(),i){for(let t of r)await this.processEvent(t.event,t.swap);this.unifiedChainEvents.unregisterListener(this.TYPE),this.unifiedChainEvents.registerListener(this.TYPE,this.processEvent.bind(this),this.swapDeserializer.bind(null,this))}t||this.startTickInterval(),this.isInitialized=!0}startTickInterval(){null!=this.tickSwapState&&0!==this.tickSwapState.length&&(this.tickInterval=setInterval(()=>{this.tick()},1e3))}async checkPastSwaps(t){null==t&&(t=await this.unifiedStorage.query([[{key:"type",value:this.TYPE},{key:"state",value:this.pendingSwapStates}]],t=>new this.swapDeserializer(this,t)));let e=[],i=[];await Promise.all(t.map(t=>t._sync(!1).then(r=>{t.isQuoteExpired()?(i.push(t),this.logger.debug("init(): Removing expired swap: "+t.getId())):r&&e.push(t)}).catch(e=>this.logger.error("init(): Error when checking swap "+t.getId()+": ",e)))),await this.unifiedStorage.removeAll(i),await this.unifiedStorage.saveAll(e)}async tick(t){for(let e of(null==t&&(t=await this.unifiedStorage.query([[{key:"type",value:this.TYPE},{key:"state",value:this.tickSwapState}]],t=>new this.swapDeserializer(this,t))),this.pendingSwaps.values())){let t=e.deref();null!=t&&t._tick(!0)}t.forEach(t=>{t._tick(!0)})}saveSwapData(t){return t.isInitiated()?(this.pendingSwaps.delete(t.getId()),this.unifiedStorage.save(t)):(this.logger.debug("saveSwapData(): Swap "+t.getId()+" not initiated, saving to pending swaps"),this.pendingSwaps.set(t.getId(),new WeakRef(t)),Promise.resolve())}removeSwapData(t){return(this.pendingSwaps.delete(t.getId()),t.isInitiated())?this.unifiedStorage.remove(t):Promise.resolve()}async stop(){this.isInitialized=!1,this.unifiedChainEvents.unregisterListener(this.TYPE),this.logger.info("stop(): Swap wrapper stopped"),null!=this.tickInterval&&clearInterval(this.tickInterval)}getNativeToken(){return this.tokens[this.chain.getNativeCurrencyAddress()]}constructor(t,e,i,n,s,o,l,u){for(let c of(this.logger=(0,a.getLogger)(this.constructor.name+": "),this.pendingSwaps=new Map,this.isInitialized=!1,this.tickInterval=null,this.unifiedStorage=e,this.unifiedChainEvents=i,this.chainIdentifier=t,this.chain=n,this.prices=s,this.events=u||new r.EventEmitter,this.options=l,this.tokens={},o)){let e=c.chains[t];null!=e&&(this.tokens[e.address]={chain:"SC",chainId:this.chainIdentifier,address:e.address,decimals:e.decimals,ticker:c.ticker,name:c.name,displayDecimals:e.displayDecimals})}}}},192892,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.hmac=i.HMAC=void 0;let r=t.r(857024);class n extends r.Hash{update(t){return(0,r.aexists)(this),this.iHash.update(t),this}digestInto(t){(0,r.aexists)(this),(0,r.abytes)(t,this.outputLen),this.finished=!0,this.iHash.digestInto(t),this.oHash.update(t),this.oHash.digestInto(t),this.destroy()}digest(){let t=new Uint8Array(this.oHash.outputLen);return this.digestInto(t),t}_cloneInto(t){t||(t=Object.create(Object.getPrototypeOf(this),{}));let{oHash:e,iHash:i,finished:r,destroyed:n,blockLen:a,outputLen:s}=this;return t.finished=r,t.destroyed=n,t.blockLen=a,t.outputLen=s,t.oHash=e._cloneInto(t.oHash),t.iHash=i._cloneInto(t.iHash),t}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}constructor(t,e){super(),this.finished=!1,this.destroyed=!1,(0,r.ahash)(t);let i=(0,r.toBytes)(e);if(this.iHash=t.create(),"function"!=typeof this.iHash.update)throw Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;let n=this.blockLen,a=new Uint8Array(n);a.set(i.length>n?t.create().update(i).digest():i);for(let t=0;t<a.length;t++)a[t]^=54;this.iHash.update(a),this.oHash=t.create();for(let t=0;t<a.length;t++)a[t]^=106;this.oHash.update(a),(0,r.clean)(a)}}i.HMAC=n,i.hmac=(t,e,i)=>new n(t,e).update(i).digest(),i.hmac.create=(t,e)=>new n(t,e)},609074,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.notImplemented=i.bitMask=i.utf8ToBytes=i.randomBytes=i.isBytes=i.hexToBytes=i.concatBytes=i.bytesToUtf8=i.bytesToHex=i.anumber=i.abytes=void 0,i.abool=function(t,e){if("boolean"!=typeof e)throw Error(t+" boolean expected, got "+e)},i._abool2=function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";if("boolean"!=typeof t)throw Error((e&&'"'.concat(e,'"'))+"expected boolean, got type="+typeof t);return t},i._abytes2=function(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",n=(0,r.isBytes)(t),a=null==t?void 0:t.length,s=void 0!==e;if(!n||s&&a!==e){let r=n?"length=".concat(a):"type=".concat(typeof t);throw Error((i&&'"'.concat(i,'" '))+"expected Uint8Array"+(s?" of length ".concat(e):"")+", got "+r)}return t},i.numberToHexUnpadded=o,i.hexToNumber=l,i.bytesToNumberBE=function(t){return l((0,r.bytesToHex)(t))},i.bytesToNumberLE=function(t){return(0,r.abytes)(t),l((0,r.bytesToHex)(Uint8Array.from(t).reverse()))},i.numberToBytesBE=u,i.numberToBytesLE=function(t,e){return u(t,e).reverse()},i.numberToVarBytesBE=function(t){return(0,r.hexToBytes)(o(t))},i.ensureBytes=function(t,e,i){let n;if("string"==typeof e)try{n=(0,r.hexToBytes)(e)}catch(e){throw Error(t+" must be hex string or Uint8Array, cause: "+e)}else if((0,r.isBytes)(e))n=Uint8Array.from(e);else throw Error(t+" must be hex string or Uint8Array");let a=n.length;if("number"==typeof i&&a!==i)throw Error(t+" of length "+i+" expected, got "+a);return n},i.equalBytes=function(t,e){if(t.length!==e.length)return!1;let i=0;for(let r=0;r<t.length;r++)i|=t[r]^e[r];return 0===i},i.copyBytes=function(t){return Uint8Array.from(t)},i.asciiToBytes=function(t){return Uint8Array.from(t,(e,i)=>{let r=e.charCodeAt(0);if(1!==e.length||r>127)throw Error('string contains non-ASCII character "'.concat(t[i],'" with code ').concat(r," at position ").concat(i));return r})},i.inRange=h,i.aInRange=function(t,e,i,r){if(!h(e,i,r))throw Error("expected valid "+t+": "+i+" <= n < "+r+", got "+e)},i.bitLen=function(t){let e;for(e=0;t>a;t>>=s,e+=1);return e},i.bitGet=function(t,e){return t>>BigInt(e)&s},i.bitSet=function(t,e,i){return t|(i?s:a)<<BigInt(e)},i.createHmacDrbg=function(t,e,i){if("number"!=typeof t||t<2)throw Error("hashLen must be a number");if("number"!=typeof e||e<2)throw Error("qByteLen must be a number");if("function"!=typeof i)throw Error("hmacFn must be a function");let n=t=>new Uint8Array(t),a=t=>Uint8Array.of(t),s=n(t),o=n(t),l=0,u=()=>{s.fill(1),o.fill(0),l=0},c=function(){for(var t=arguments.length,e=Array(t),r=0;r<t;r++)e[r]=arguments[r];return i(o,s,...e)},h=function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:n(0);o=c(a(0),t),s=c(),0!==t.length&&(o=c(a(1),t),s=c())},p=()=>{if(l++>=1e3)throw Error("drbg: tried 1000 values");let t=0,i=[];for(;t<e;){let e=(s=c()).slice();i.push(e),t+=s.length}return(0,r.concatBytes)(...i)};return(t,e)=>{let i;for(u(),h(t);!(i=e(p()));)h();return u(),i}},i.validateObject=function(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=(e,i,r)=>{let n=p[i];if("function"!=typeof n)throw Error("invalid validator function");let a=t[e];if((!r||void 0!==a)&&!n(a,t))throw Error("param "+String(e)+" is invalid. Expected "+i+", got "+a)};for(let[t,i]of Object.entries(e))r(t,i,!1);for(let[t,e]of Object.entries(i))r(t,e,!0);return t},i.isHash=function(t){return"function"==typeof t&&Number.isSafeInteger(t.outputLen)},i._validateObject=function(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(!t||"object"!=typeof t)throw Error("expected valid options object");function r(e,i,r){let n=t[e];if(r&&void 0===n)return;let a=typeof n;if(a!==i||null===n)throw Error('param "'.concat(e,'" is invalid: expected ').concat(i,", got ").concat(a))}Object.entries(e).forEach(t=>{let[e,i]=t;return r(e,i,!1)}),Object.entries(i).forEach(t=>{let[e,i]=t;return r(e,i,!0)})},i.memoized=function(t){let e=new WeakMap;return function(i){for(var r=arguments.length,n=Array(r>1?r-1:0),a=1;a<r;a++)n[a-1]=arguments[a];let s=e.get(i);if(void 0!==s)return s;let o=t(i,...n);return e.set(i,o),o}};let r=t.r(857024);var n=t.r(857024);Object.defineProperty(i,"abytes",{enumerable:!0,get:function(){return n.abytes}}),Object.defineProperty(i,"anumber",{enumerable:!0,get:function(){return n.anumber}}),Object.defineProperty(i,"bytesToHex",{enumerable:!0,get:function(){return n.bytesToHex}}),Object.defineProperty(i,"bytesToUtf8",{enumerable:!0,get:function(){return n.bytesToUtf8}}),Object.defineProperty(i,"concatBytes",{enumerable:!0,get:function(){return n.concatBytes}}),Object.defineProperty(i,"hexToBytes",{enumerable:!0,get:function(){return n.hexToBytes}}),Object.defineProperty(i,"isBytes",{enumerable:!0,get:function(){return n.isBytes}}),Object.defineProperty(i,"randomBytes",{enumerable:!0,get:function(){return n.randomBytes}}),Object.defineProperty(i,"utf8ToBytes",{enumerable:!0,get:function(){return n.utf8ToBytes}});let a=BigInt(0),s=BigInt(1);function o(t){let e=t.toString(16);return 1&e.length?"0"+e:e}function l(t){if("string"!=typeof t)throw Error("hex string expected, got "+typeof t);return""===t?a:BigInt("0x"+t)}function u(t,e){return(0,r.hexToBytes)(t.toString(16).padStart(2*e,"0"))}let c=t=>"bigint"==typeof t&&a<=t;function h(t,e,i){return c(t)&&c(e)&&c(i)&&e<=t&&t<i}i.bitMask=t=>(s<<BigInt(t))-s;let p={bigint:t=>"bigint"==typeof t,function:t=>"function"==typeof t,boolean:t=>"boolean"==typeof t,string:t=>"string"==typeof t,stringOrUint8Array:t=>"string"==typeof t||(0,r.isBytes)(t),isSafeInteger:t=>Number.isSafeInteger(t),array:t=>Array.isArray(t),field:(t,e)=>e.Fp.isValid(t),hash:t=>"function"==typeof t&&Number.isSafeInteger(t.outputLen)};i.notImplemented=()=>{throw Error("not implemented")}},284564,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.isNegativeLE=void 0,i.mod=f,i.pow=function(t,e,i){return I(A(i),t,e)},i.pow2=function(t,e,i){let r=t;for(;e-- >n;)r*=r,r%=i;return r},i.invert=g,i.tonelliShanks=T,i.FpSqrt=S,i.validateField=function(t){let e=E.reduce((t,e)=>(t[e]="function",t),{ORDER:"bigint",MASK:"bigint",BYTES:"number",BITS:"number"});return(0,r._validateObject)(t,e),t},i.FpPow=I,i.FpInvertBatch=v,i.FpDiv=function(t,e,i){return t.mul(e,"bigint"==typeof i?g(i,t.ORDER):t.inv(i))},i.FpLegendre=b,i.FpIsSquare=function(t,e){return 1===b(t,e)},i.nLength=B,i.Field=A,i.FpSqrtOdd=function(t,e){if(!t.isOdd)throw Error("Field doesn't have isOdd");let i=t.sqrt(e);return t.isOdd(i)?i:t.neg(i)},i.FpSqrtEven=function(t,e){if(!t.isOdd)throw Error("Field doesn't have isOdd");let i=t.sqrt(e);return t.isOdd(i)?t.neg(i):i},i.hashToPrivateScalar=function(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=(t=(0,r.ensureBytes)("privateHash",t)).length,s=B(e).nByteLength+8;if(s<24||n<s||n>1024)throw Error("hashToPrivateScalar: expected "+s+"-1024 bytes of input, got "+n);return f(i?(0,r.bytesToNumberLE)(t):(0,r.bytesToNumberBE)(t),e-a)+a},i.getFieldBytesLength=R,i.getMinHashLength=C,i.mapHashToField=function(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=t.length,s=R(e),o=C(e);if(n<16||n<o||n>1024)throw Error("expected "+o+"-1024 bytes of input, got "+n);let l=f(i?(0,r.bytesToNumberLE)(t):(0,r.bytesToNumberBE)(t),e-a)+a;return i?(0,r.numberToBytesLE)(l,s):(0,r.numberToBytesBE)(l,s)};let r=t.r(609074),n=BigInt(0),a=BigInt(1),s=BigInt(2),o=BigInt(3),l=BigInt(4),u=BigInt(5),c=BigInt(7),h=BigInt(8),p=BigInt(9),d=BigInt(16);function f(t,e){let i=t%e;return i>=n?i:e+i}function g(t,e){if(t===n)throw Error("invert: expected non-zero number");if(e<=n)throw Error("invert: expected positive modulus, got "+e);let i=f(t,e),r=e,s=n,o=a,l=a,u=n;for(;i!==n;){let t=r/i,e=r%i,n=s-l*t,a=o-u*t;r=i,i=e,s=l,o=u,l=n,u=a}if(r!==a)throw Error("invert: does not exist");return f(s,e)}function m(t,e,i){if(!t.eql(t.sqr(e),i))throw Error("Cannot find square root")}function w(t,e){let i=(t.ORDER+a)/l,r=t.pow(e,i);return m(t,r,e),r}function y(t,e){let i=(t.ORDER-u)/h,r=t.mul(e,s),n=t.pow(r,i),a=t.mul(e,n),o=t.mul(t.mul(a,s),n),l=t.mul(a,t.sub(o,t.ONE));return m(t,l,e),l}function T(t){if(t<o)throw Error("sqrt is not defined for small field");let e=t-a,i=0;for(;e%s===n;)e/=s,i++;let r=s,l=A(t);for(;1===b(l,r);)if(r++>1e3)throw Error("Cannot find square root: probably non-prime P");if(1===i)return w;let u=l.pow(r,e),c=(e+a)/s;return function(t,r){if(t.is0(r))return r;if(1!==b(t,r))throw Error("Cannot find square root");let n=i,s=t.mul(t.ONE,u),o=t.pow(r,e),l=t.pow(r,c);for(;!t.eql(o,t.ONE);){if(t.is0(o))return t.ZERO;let e=1,i=t.sqr(o);for(;!t.eql(i,t.ONE);)if(e++,i=t.sqr(i),e===n)throw Error("Cannot find square root");let r=a<<BigInt(n-e-1),u=t.pow(s,r);n=e,s=t.sqr(u),o=t.mul(o,s),l=t.mul(l,u)}return l}}function S(t){return t%l===o?w:t%h===u?y:t%d===p?function(t){let e=A(t),i=T(t),r=i(e,e.neg(e.ONE)),n=i(e,r),a=i(e,e.neg(r)),s=(t+c)/d;return(t,e)=>{let i=t.pow(e,s),o=t.mul(i,r),l=t.mul(i,n),u=t.mul(i,a),c=t.eql(t.sqr(o),e),h=t.eql(t.sqr(l),e);i=t.cmov(i,o,c),o=t.cmov(u,l,h);let p=t.eql(t.sqr(o),e),d=t.cmov(i,o,p);return m(t,d,e),d}}(t):T(t)}i.isNegativeLE=(t,e)=>(f(t,e)&a)===a;let E=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function I(t,e,i){if(i<n)throw Error("invalid exponent, negatives unsupported");if(i===n)return t.ONE;if(i===a)return e;let r=t.ONE,s=e;for(;i>n;)i&a&&(r=t.mul(r,s)),s=t.sqr(s),i>>=a;return r}function v(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=Array(e.length).fill(i?t.ZERO:void 0),n=e.reduce((e,i,n)=>t.is0(i)?e:(r[n]=e,t.mul(e,i)),t.ONE),a=t.inv(n);return e.reduceRight((e,i,n)=>t.is0(i)?e:(r[n]=t.mul(e,r[n]),t.mul(e,i)),a),r}function b(t,e){let i=(t.ORDER-a)/s,r=t.pow(e,i),n=t.eql(r,t.ONE),o=t.eql(r,t.ZERO),l=t.eql(r,t.neg(t.ONE));if(!n&&!o&&!l)throw Error("invalid Legendre symbol result");return n?1:o?0:-1}function B(t,e){void 0!==e&&(0,r.anumber)(e);let i=void 0!==e?e:t.toString(2).length,n=Math.ceil(i/8);return{nBitLength:i,nByteLength:n}}function A(t,e){let i,s,o,l,u=arguments.length>2&&void 0!==arguments[2]&&arguments[2],c=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};if(t<=n)throw Error("invalid field: expected ORDER > 0, got "+t);let h=!1;if("object"==typeof e&&null!=e){if(c.sqrt||u)throw Error("cannot specify opts in two arguments");e.BITS&&(i=e.BITS),e.sqrt&&(s=e.sqrt),"boolean"==typeof e.isLE&&(u=e.isLE),"boolean"==typeof e.modFromBytes&&(h=e.modFromBytes),o=e.allowedLengths}else"number"==typeof e&&(i=e),c.sqrt&&(s=c.sqrt);let{nBitLength:p,nByteLength:d}=B(t,i);if(d>2048)throw Error("invalid field: expected ORDER of <= 2048 bytes");let m=Object.freeze({ORDER:t,isLE:u,BITS:p,BYTES:d,MASK:(0,r.bitMask)(p),ZERO:n,ONE:a,allowedLengths:o,create:e=>f(e,t),isValid:e=>{if("bigint"!=typeof e)throw Error("invalid field element: expected bigint, got "+typeof e);return n<=e&&e<t},is0:t=>t===n,isValidNot0:t=>!m.is0(t)&&m.isValid(t),isOdd:t=>(t&a)===a,neg:e=>f(-e,t),eql:(t,e)=>t===e,sqr:e=>f(e*e,t),add:(e,i)=>f(e+i,t),sub:(e,i)=>f(e-i,t),mul:(e,i)=>f(e*i,t),pow:(t,e)=>I(m,t,e),div:(e,i)=>f(e*g(i,t),t),sqrN:t=>t*t,addN:(t,e)=>t+e,subN:(t,e)=>t-e,mulN:(t,e)=>t*e,inv:e=>g(e,t),sqrt:s||(e=>(l||(l=S(t)),l(m,e))),toBytes:t=>u?(0,r.numberToBytesLE)(t,d):(0,r.numberToBytesBE)(t,d),fromBytes:function(e){let i=!(arguments.length>1)||void 0===arguments[1]||arguments[1];if(o){if(!o.includes(e.length)||e.length>d)throw Error("Field.fromBytes: expected "+o+" bytes, got "+e.length);let t=new Uint8Array(d);t.set(e,u?0:t.length-e.length),e=t}if(e.length!==d)throw Error("Field.fromBytes: expected "+d+" bytes, got "+e.length);let n=u?(0,r.bytesToNumberLE)(e):(0,r.bytesToNumberBE)(e);if(h&&(n=f(n,t)),!i&&!m.isValid(n))throw Error("invalid field element: outside of range 0..ORDER");return n},invertBatch:t=>v(m,t),cmov:(t,e,i)=>i?e:t});return Object.freeze(m)}function R(t){if("bigint"!=typeof t)throw Error("field order must be bigint");return Math.ceil(t.toString(2).length/8)}function C(t){let e=R(t);return e+Math.ceil(e/2)}},138023,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.wNAF=void 0,i.negateCt=o,i.normalizeZ=function(t,e){let i=(0,n.FpInvertBatch)(t.Fp,e.map(t=>t.Z));return e.map((e,r)=>t.fromAffine(e.toAffine(i[r])))},i.mulEndoUnsafe=function(t,e,i,r){let n=e,o=t.ZERO,l=t.ZERO;for(;i>a||r>a;)i&s&&(o=o.add(n)),r&s&&(l=l.add(n)),n=n.double(),i>>=s,r>>=s;return{p1:o,p2:l}},i.pippenger=function(t,e,i,n){h(i,t),p(n,e);let a=i.length,s=n.length;if(a!==s)throw Error("arrays of points and scalars must have equal length");let o=t.ZERO,l=(0,r.bitLen)(BigInt(a)),u=1;l>12?u=l-3:l>4?u=l-2:l>0&&(u=2);let c=(0,r.bitMask)(u),d=Array(Number(c)+1).fill(o),f=Math.floor((e.BITS-1)/u)*u,g=o;for(let t=f;t>=0;t-=u){d.fill(o);for(let e=0;e<s;e++){let r=Number(n[e]>>BigInt(t)&c);d[r]=d[r].add(i[e])}let e=o;for(let t=d.length-1,i=o;t>0;t--)i=i.add(d[t]),e=e.add(i);if(g=g.add(e),0!==t)for(let t=0;t<u;t++)g=g.double()}return g},i.precomputeMSMUnsafe=function(t,e,i,n){l(n,e.BITS),h(i,t);let a=t.ZERO,s=2**n-1,o=Math.ceil(e.BITS/n),u=(0,r.bitMask)(n),c=i.map(t=>{let e=[];for(let i=0,r=t;i<s;i++)e.push(r),r=r.add(t);return e});return t=>{if(p(t,e),t.length>i.length)throw Error("array of scalars must be smaller than array of points");let r=a;for(let e=0;e<o;e++){if(r!==a)for(let t=0;t<n;t++)r=r.double();let i=BigInt(o*n-(e+1)*n);for(let e=0;e<t.length;e++){let n=Number(t[e]>>i&u);n&&(r=r.add(c[e][n-1]))}}return r}},i.validateBasic=function(t){return(0,n.validateField)(t.Fp),(0,r.validateObject)(t,{n:"bigint",h:"bigint",Gx:"field",Gy:"field"},{nBitLength:"isSafeInteger",nByteLength:"isSafeInteger"}),Object.freeze({...(0,n.nLength)(t.n,t.nBitLength),...t,...{p:t.Fp.ORDER}})},i._createCurveFields=function(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=arguments.length>3?arguments[3]:void 0;if(void 0===r&&(r="edwards"===t),!e||"object"!=typeof e)throw Error("expected valid ".concat(t," CURVE object"));for(let t of["p","n","h"]){let i=e[t];if(!("bigint"==typeof i&&i>a))throw Error("CURVE.".concat(t," must be positive bigint"))}let n=w(e.p,i.Fp,r),s=w(e.n,i.Fn,r);for(let i of["Gx","Gy","a","weierstrass"===t?"b":"d"])if(!n.isValid(e[i]))throw Error("CURVE.".concat(i," must be valid field element of CURVE.Fp"));return{CURVE:e=Object.freeze(Object.assign({},e)),Fp:n,Fn:s}};let r=t.r(609074),n=t.r(284564),a=BigInt(0),s=BigInt(1);function o(t,e){let i=e.negate();return t?i:e}function l(t,e){if(!Number.isSafeInteger(t)||t<=0||t>e)throw Error("invalid window size, expected [1.."+e+"], got W="+t)}function u(t,e){l(t,e);let i=Math.ceil(e/t)+1,n=2**(t-1),a=2**t;return{windows:i,windowSize:n,mask:(0,r.bitMask)(t),maxNumber:a,shiftBy:BigInt(t)}}function c(t,e,i){let{windowSize:r,mask:n,maxNumber:a,shiftBy:o}=i,l=Number(t&n),u=t>>o;l>r&&(l-=a,u+=s);let c=e*r,h=c+Math.abs(l)-1,p=0===l;return{nextN:u,offset:h,isZero:p,isNeg:l<0,isNegF:e%2!=0,offsetF:c}}function h(t,e){if(!Array.isArray(t))throw Error("array expected");t.forEach((t,i)=>{if(!(t instanceof e))throw Error("invalid point at index "+i)})}function p(t,e){if(!Array.isArray(t))throw Error("array of scalars expected");t.forEach((t,i)=>{if(!e.isValid(t))throw Error("invalid scalar at index "+i)})}let d=new WeakMap,f=new WeakMap;function g(t){return f.get(t)||1}function m(t){if(t!==a)throw Error("invalid wNAF")}function w(t,e,i){if(!e)return(0,n.Field)(t,{isLE:i});if(e.ORDER!==t)throw Error("Field.ORDER must match order: Fp == p, Fn == n");return(0,n.validateField)(e),e}i.wNAF=class{_unsafeLadder(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.ZERO,r=t;for(;e>a;)e&s&&(i=i.add(r)),r=r.double(),e>>=s;return i}precomputeWindow(t,e){let{windows:i,windowSize:r}=u(e,this.bits),n=[],a=t,s=a;for(let t=0;t<i;t++){s=a,n.push(s);for(let t=1;t<r;t++)s=s.add(a),n.push(s);a=s.double()}return n}wNAF(t,e,i){if(!this.Fn.isValid(i))throw Error("invalid scalar");let r=this.ZERO,n=this.BASE,a=u(t,this.bits);for(let t=0;t<a.windows;t++){let{nextN:s,offset:l,isZero:u,isNeg:h,isNegF:p,offsetF:d}=c(i,t,a);i=s,u?n=n.add(o(p,e[d])):r=r.add(o(h,e[l]))}return m(i),{p:r,f:n}}wNAFUnsafe(t,e,i){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:this.ZERO,n=u(t,this.bits);for(let t=0;t<n.windows&&i!==a;t++){let{nextN:a,offset:s,isZero:o,isNeg:l}=c(i,t,n);if(i=a,!o){let t=e[s];r=r.add(l?t.negate():t)}}return m(i),r}getPrecomputes(t,e,i){let r=d.get(e);return r||(r=this.precomputeWindow(e,t),1!==t&&("function"==typeof i&&(r=i(r)),d.set(e,r))),r}cached(t,e,i){let r=g(t);return this.wNAF(r,this.getPrecomputes(r,t,i),e)}unsafe(t,e,i,r){let n=g(t);return 1===n?this._unsafeLadder(t,e,r):this.wNAFUnsafe(n,this.getPrecomputes(n,t,i),e,r)}createCache(t,e){l(e,this.bits),f.set(t,e),d.delete(t)}hasCache(t){return 1!==g(t)}constructor(t,e){this.BASE=t.BASE,this.ZERO=t.ZERO,this.Fn=t.Fn,this.bits=e}}},176097,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.DER=i.DERErr=void 0,i._splitEndoScalar=u,i._normFnElement=y,i.weierstrassN=T,i.SWUFpSqrtRatio=E,i.mapToCurveSimpleSWU=function(t,e){(0,o.validateField)(t);let{A:i,B:r,Z:n}=e;if(!t.isValid(i)||!t.isValid(r)||!t.isValid(n))throw Error("mapToCurveSimpleSWU: invalid opts");let a=E(t,n);if(!t.isOdd)throw Error("Field does not have .isOdd()");return e=>{let s,l,u,c,h,p,d,f;s=t.sqr(e),s=t.mul(s,n),l=t.sqr(s),l=t.add(l,s),u=t.add(l,t.ONE),u=t.mul(u,r),c=t.cmov(n,t.neg(l),!t.eql(l,t.ZERO)),c=t.mul(c,i),l=t.sqr(u),p=t.sqr(c),h=t.mul(p,i),l=t.add(l,h),l=t.mul(l,u),p=t.mul(p,c),h=t.mul(p,r),l=t.add(l,h),d=t.mul(s,u);let{isValid:g,value:m}=a(l,p);f=t.mul(s,e),f=t.mul(f,m),d=t.cmov(d,u,g),f=t.cmov(f,m,g);let w=t.isOdd(e)===t.isOdd(f);f=t.cmov(t.neg(f),f,w);let y=(0,o.FpInvertBatch)(t,[c],!0)[0];return{x:d=t.mul(d,y),y:f}}},i.ecdh=v,i.ecdsa=b,i.weierstrassPoints=function(t){let{CURVE:e,curveOpts:i}=B(t);var r=t,n=T(e,i);let{Fp:s,Fn:o}=n,l=A(s,r.a,r.b);return Object.assign({},{CURVE:r,Point:n,ProjectivePoint:n,normPrivateKeyToScalar:t=>y(o,t),weierstrassEquation:l,isWithinCurveOrder:function(t){return(0,a.inRange)(t,f,o.ORDER)}})},i._legacyHelperEquat=A,i.weierstrass=function(t){let{CURVE:e,curveOpts:i,hash:r,ecdsaOpts:n}=function(t){let{CURVE:e,curveOpts:i}=B(t),r={hmac:t.hmac,randomBytes:t.randomBytes,lowS:t.lowS,bits2int:t.bits2int,bits2int_modN:t.bits2int_modN};return{CURVE:e,curveOpts:i,hash:t.hash,ecdsaOpts:r}}(t),a=b(T(e,i),r,n),s=a.Point;return Object.assign({},a,{ProjectivePoint:s,CURVE:Object.assign({},t,(0,o.nLength)(s.Fn.ORDER,s.Fn.BITS))})};let r=t.r(192892),n=t.r(857024),a=t.r(609074),s=t.r(138023),o=t.r(284564),l=(t,e)=>(t+(t>=0?e:-e)/g)/e;function u(t,e,i){let[[r,n],[s,o]]=e,u=l(o*t,i),c=l(-n*t,i),h=t-u*r-c*s,p=-u*n-c*o,g=h<d,m=p<d;g&&(h=-h),m&&(p=-p);let w=(0,a.bitMask)(Math.ceil((0,a.bitLen)(i)/2))+f;if(h<d||h>=w||p<d||p>=w)throw Error("splitScalar (endomorphism): failed, k="+t);return{k1neg:g,k1:h,k2neg:m,k2:p}}function c(t){if(!["compact","recovered","der"].includes(t))throw Error('Signature format must be "compact", "recovered", or "der"');return t}function h(t,e){let i={};for(let r of Object.keys(e))i[r]=void 0===t[r]?e[r]:t[r];return(0,a._abool2)(i.lowS,"lowS"),(0,a._abool2)(i.prehash,"prehash"),void 0!==i.format&&c(i.format),i}class p extends Error{constructor(t=""){super(t)}}i.DERErr=p,i.DER={Err:p,_tlv:{encode:(t,e)=>{let{Err:r}=i.DER;if(t<0||t>256)throw new r("tlv.encode: wrong tag");if(1&e.length)throw new r("tlv.encode: unpadded data");let n=e.length/2,s=(0,a.numberToHexUnpadded)(n);if(s.length/2&128)throw new r("tlv.encode: long form length too big");let o=n>127?(0,a.numberToHexUnpadded)(s.length/2|128):"";return(0,a.numberToHexUnpadded)(t)+o+s+e},decode(t,e){let{Err:r}=i.DER,n=0;if(t<0||t>256)throw new r("tlv.encode: wrong tag");if(e.length<2||e[n++]!==t)throw new r("tlv.decode: wrong tlv");let a=e[n++],s=0;if(128&a){let t=127&a;if(!t)throw new r("tlv.decode(long): indefinite length not supported");if(t>4)throw new r("tlv.decode(long): byte length is too big");let i=e.subarray(n,n+t);if(i.length!==t)throw new r("tlv.decode: length bytes not complete");if(0===i[0])throw new r("tlv.decode(long): zero leftmost byte");for(let t of i)s=s<<8|t;if(n+=t,s<128)throw new r("tlv.decode(long): not minimal encoding")}else s=a;let o=e.subarray(n,n+s);if(o.length!==s)throw new r("tlv.decode: wrong value length");return{v:o,l:e.subarray(n+s)}}},_int:{encode(t){let{Err:e}=i.DER;if(t<d)throw new e("integer: negative integers are not allowed");let r=(0,a.numberToHexUnpadded)(t);if(8&Number.parseInt(r[0],16)&&(r="00"+r),1&r.length)throw new e("unexpected DER parsing assertion: unpadded hex");return r},decode(t){let{Err:e}=i.DER;if(128&t[0])throw new e("invalid signature integer: negative");if(0===t[0]&&!(128&t[1]))throw new e("invalid signature integer: unnecessary leading zero");return(0,a.bytesToNumberBE)(t)}},toSig(t){let{Err:e,_int:r,_tlv:n}=i.DER,s=(0,a.ensureBytes)("signature",t),{v:o,l:l}=n.decode(48,s);if(l.length)throw new e("invalid signature: left bytes after parsing");let{v:u,l:c}=n.decode(2,o),{v:h,l:p}=n.decode(2,c);if(p.length)throw new e("invalid signature: left bytes after parsing");return{r:r.decode(u),s:r.decode(h)}},hexFromSig(t){let{_tlv:e,_int:r}=i.DER,n=e.encode(2,r.encode(t.r)),a=e.encode(2,r.encode(t.s));return e.encode(48,n+a)}};let d=BigInt(0),f=BigInt(1),g=BigInt(2),m=BigInt(3),w=BigInt(4);function y(t,e){let i,{BYTES:r}=t;if("bigint"==typeof e)i=e;else{let n=(0,a.ensureBytes)("private key",e);try{i=t.fromBytes(n)}catch(t){throw Error("invalid private key: expected ui8a of size ".concat(r,", got ").concat(typeof e))}}if(!t.isValidNot0(i))throw Error("invalid private key: out of range [1..N-1]");return i}function T(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=(0,s._createCurveFields)("weierstrass",t,e),{Fp:r,Fn:n}=i,o=i.CURVE,{h:l,n:c}=o;(0,a._validateObject)(e,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object",wrapPrivateKey:"boolean"});let{endo:h}=e;if(h&&(!r.is0(o.a)||"bigint"!=typeof h.beta||!Array.isArray(h.basises)))throw Error('invalid endo: expected "beta": bigint and "basises": array');let p=I(r,n);function g(){if(!r.isOdd)throw Error("compression is not supported: Field does not have .isOdd()")}let T=e.toBytes||function(t,e,i){let{x:n,y:s}=e.toAffine(),o=r.toBytes(n);if((0,a._abool2)(i,"isCompressed"),!i)return(0,a.concatBytes)(Uint8Array.of(4),o,r.toBytes(s));{g();let t=!r.isOdd(s);return(0,a.concatBytes)(S(t),o)}},E=e.fromBytes||function(t){(0,a._abytes2)(t,void 0,"Point");let{publicKey:e,publicKeyUncompressed:i}=p,n=t.length,s=t[0],o=t.subarray(1);if(n===e&&(2===s||3===s)){let t,e=r.fromBytes(o);if(!r.isValid(e))throw Error("bad point: is not on curve, wrong x");let i=v(e);try{t=r.sqrt(i)}catch(t){throw Error("bad point: is not on curve, sqrt error"+(t instanceof Error?": "+t.message:""))}return g(),(1&s)==1!==r.isOdd(t)&&(t=r.neg(t)),{x:e,y:t}}if(n===i&&4===s){let t=r.BYTES,e=r.fromBytes(o.subarray(0,t)),i=r.fromBytes(o.subarray(t,2*t));if(!b(e,i))throw Error("bad point: is not on curve");return{x:e,y:i}}throw Error("bad point: got length ".concat(n,", expected compressed=").concat(e," or uncompressed=").concat(i))};function v(t){let e=r.sqr(t),i=r.mul(e,t);return r.add(r.add(i,r.mul(t,o.a)),o.b)}function b(t,e){let i=r.sqr(e),n=v(t);return r.eql(i,n)}if(!b(o.Gx,o.Gy))throw Error("bad curve params: generator point");let B=r.mul(r.pow(o.a,m),w),A=r.mul(r.sqr(o.b),BigInt(27));if(r.is0(r.add(B,A)))throw Error("bad curve params: a or b");function R(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!r.isValid(e)||i&&r.is0(e))throw Error("bad point coordinate ".concat(t));return e}function C(t){if(!(t instanceof D))throw Error("ProjectivePoint expected")}function _(t){if(!h||!h.basises)throw Error("no endo");return u(t,h.basises,n.ORDER)}let F=(0,a.memoized)((t,e)=>{let{X:i,Y:n,Z:a}=t;if(r.eql(a,r.ONE))return{x:i,y:n};let s=t.is0();null==e&&(e=s?r.ONE:r.inv(a));let o=r.mul(i,e),l=r.mul(n,e),u=r.mul(a,e);if(s)return{x:r.ZERO,y:r.ZERO};if(!r.eql(u,r.ONE))throw Error("invZ was invalid");return{x:o,y:l}}),P=(0,a.memoized)(t=>{if(t.is0()){if(e.allowInfinityPoint&&!r.is0(t.Y))return;throw Error("bad point: ZERO")}let{x:i,y:n}=t.toAffine();if(!r.isValid(i)||!r.isValid(n))throw Error("bad point: x or y not field elements");if(!b(i,n))throw Error("bad point: equation left != right");if(!t.isTorsionFree())throw Error("bad point: not in prime-order subgroup");return!0});function x(t,e,i,n,a){return i=new D(r.mul(i.X,t),i.Y,i.Z),e=(0,s.negateCt)(n,e),i=(0,s.negateCt)(a,i),e.add(i)}class D{static CURVE(){return o}static fromAffine(t){let{x:e,y:i}=t||{};if(!t||!r.isValid(e)||!r.isValid(i))throw Error("invalid affine point");if(t instanceof D)throw Error("projective point not allowed");return r.is0(e)&&r.is0(i)?D.ZERO:new D(e,i,r.ONE)}static fromBytes(t){let e=D.fromAffine(E((0,a._abytes2)(t,void 0,"point")));return e.assertValidity(),e}static fromHex(t){return D.fromBytes((0,a.ensureBytes)("pointHex",t))}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:8,e=!(arguments.length>1)||void 0===arguments[1]||arguments[1];return O.createCache(this,t),e||this.multiply(m),this}assertValidity(){P(this)}hasEvenY(){let{y:t}=this.toAffine();if(!r.isOdd)throw Error("Field doesn't support isOdd");return!r.isOdd(t)}equals(t){C(t);let{X:e,Y:i,Z:n}=this,{X:a,Y:s,Z:o}=t,l=r.eql(r.mul(e,o),r.mul(a,n)),u=r.eql(r.mul(i,o),r.mul(s,n));return l&&u}negate(){return new D(this.X,r.neg(this.Y),this.Z)}double(){let{a:t,b:e}=o,i=r.mul(e,m),{X:n,Y:a,Z:s}=this,l=r.ZERO,u=r.ZERO,c=r.ZERO,h=r.mul(n,n),p=r.mul(a,a),d=r.mul(s,s),f=r.mul(n,a);return f=r.add(f,f),c=r.mul(n,s),c=r.add(c,c),l=r.mul(t,c),u=r.mul(i,d),u=r.add(l,u),l=r.sub(p,u),u=r.add(p,u),u=r.mul(l,u),l=r.mul(f,l),c=r.mul(i,c),d=r.mul(t,d),f=r.sub(h,d),f=r.mul(t,f),f=r.add(f,c),c=r.add(h,h),h=r.add(c,h),h=r.add(h,d),h=r.mul(h,f),u=r.add(u,h),d=r.mul(a,s),d=r.add(d,d),h=r.mul(d,f),l=r.sub(l,h),c=r.mul(d,p),c=r.add(c,c),new D(l,u,c=r.add(c,c))}add(t){C(t);let{X:e,Y:i,Z:n}=this,{X:a,Y:s,Z:l}=t,u=r.ZERO,c=r.ZERO,h=r.ZERO,p=o.a,d=r.mul(o.b,m),f=r.mul(e,a),g=r.mul(i,s),w=r.mul(n,l),y=r.add(e,i),T=r.add(a,s);y=r.mul(y,T),T=r.add(f,g),y=r.sub(y,T),T=r.add(e,n);let S=r.add(a,l);return T=r.mul(T,S),S=r.add(f,w),T=r.sub(T,S),S=r.add(i,n),u=r.add(s,l),S=r.mul(S,u),u=r.add(g,w),S=r.sub(S,u),h=r.mul(p,T),u=r.mul(d,w),h=r.add(u,h),u=r.sub(g,h),h=r.add(g,h),c=r.mul(u,h),g=r.add(f,f),g=r.add(g,f),w=r.mul(p,w),T=r.mul(d,T),g=r.add(g,w),w=r.sub(f,w),w=r.mul(p,w),T=r.add(T,w),f=r.mul(g,T),c=r.add(c,f),f=r.mul(S,T),u=r.mul(y,u),u=r.sub(u,f),f=r.mul(y,g),h=r.mul(S,h),new D(u,c,h=r.add(h,f))}subtract(t){return this.add(t.negate())}is0(){return this.equals(D.ZERO)}multiply(t){let i,r,{endo:a}=e;if(!n.isValidNot0(t))throw Error("invalid scalar: out of range");let o=t=>O.cached(this,t,t=>(0,s.normalizeZ)(D,t));if(a){let{k1neg:e,k1:n,k2neg:s,k2:l}=_(t),{p:u,f:c}=o(n),{p:h,f:p}=o(l);r=c.add(p),i=x(a.beta,u,h,e,s)}else{let{p:e,f:n}=o(t);i=e,r=n}return(0,s.normalizeZ)(D,[i,r])[0]}multiplyUnsafe(t){let{endo:i}=e;if(!n.isValid(t))throw Error("invalid scalar: out of range");if(t===d||this.is0())return D.ZERO;if(t===f)return this;if(O.hasCache(this))return this.multiply(t);if(!i)return O.unsafe(this,t);{let{k1neg:e,k1:r,k2neg:n,k2:a}=_(t),{p1:o,p2:l}=(0,s.mulEndoUnsafe)(D,this,r,a);return x(i.beta,o,l,e,n)}}multiplyAndAddUnsafe(t,e,i){let r=this.multiplyUnsafe(e).add(t.multiplyUnsafe(i));return r.is0()?void 0:r}toAffine(t){return F(this,t)}isTorsionFree(){let{isTorsionFree:t}=e;return l===f||(t?t(D,this):O.unsafe(this,c).is0())}clearCofactor(){let{clearCofactor:t}=e;return l===f?this:t?t(D,this):this.multiplyUnsafe(l)}isSmallOrder(){return this.multiplyUnsafe(l).is0()}toBytes(){let t=!(arguments.length>0)||void 0===arguments[0]||arguments[0];return(0,a._abool2)(t,"isCompressed"),this.assertValidity(),T(D,this,t)}toHex(){let t=!(arguments.length>0)||void 0===arguments[0]||arguments[0];return(0,a.bytesToHex)(this.toBytes(t))}toString(){return"<Point ".concat(this.is0()?"ZERO":this.toHex(),">")}get px(){return this.X}get py(){return this.X}get pz(){return this.Z}toRawBytes(){let t=!(arguments.length>0)||void 0===arguments[0]||arguments[0];return this.toBytes(t)}_setWindowSize(t){this.precompute(t)}static normalizeZ(t){return(0,s.normalizeZ)(D,t)}static msm(t,e){return(0,s.pippenger)(D,n,t,e)}static fromPrivateKey(t){return D.BASE.multiply(y(n,t))}constructor(t,e,i){this.X=R("x",t),this.Y=R("y",e,!0),this.Z=R("z",i),Object.freeze(this)}}D.BASE=new D(o.Gx,o.Gy,r.ONE),D.ZERO=new D(r.ZERO,r.ONE,r.ZERO),D.Fp=r,D.Fn=n;let k=n.BITS,O=new s.wNAF(D,e.endo?Math.ceil(k/2):k);return D.BASE.precompute(8),D}function S(t){return Uint8Array.of(t?2:3)}function E(t,e){let i=t.ORDER,r=d;for(let t=i-f;t%g===d;t/=g)r+=f;let n=r,a=g<<n-f-f,s=a*g,o=(i-f)/s,l=(o-f)/g,u=s-f,c=t.pow(e,o),h=t.pow(e,(o+f)/g),p=(e,i)=>{let r=c,s=t.pow(i,u),o=t.sqr(s);o=t.mul(o,i);let p=t.mul(e,o);p=t.pow(p,l),p=t.mul(p,s),s=t.mul(p,i),o=t.mul(p,e);let d=t.mul(o,s);p=t.pow(d,a);let m=t.eql(p,t.ONE);s=t.mul(o,h),p=t.mul(d,r),o=t.cmov(s,o,m),d=t.cmov(p,d,m);for(let e=n;e>f;e--){let i=e-g;i=g<<i-f;let n=t.pow(d,i),a=t.eql(n,t.ONE);s=t.mul(o,r),r=t.mul(r,r),n=t.mul(d,r),o=t.cmov(s,o,a),d=t.cmov(n,d,a)}return{isValid:m,value:o}};if(t.ORDER%w===m){let i=(t.ORDER-m)/w,r=t.sqrt(t.neg(e));p=(e,n)=>{let a=t.sqr(n),s=t.mul(e,n);a=t.mul(a,s);let o=t.pow(a,i);o=t.mul(o,s);let l=t.mul(o,r),u=t.mul(t.sqr(o),n),c=t.eql(u,e),h=t.cmov(l,o,c);return{isValid:c,value:h}}}return p}function I(t,e){return{secretKey:e.BYTES,publicKey:1+t.BYTES,publicKeyUncompressed:1+2*t.BYTES,publicKeyHasPrefix:!0,signature:2*e.BYTES}}function v(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{Fn:i}=t,r=e.randomBytes||a.randomBytes,n=Object.assign(I(t.Fp,i),{seed:(0,o.getMinHashLength)(i.ORDER)});function s(t){try{return!!y(i,t)}catch(t){return!1}}function l(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:r(n.seed);return(0,o.mapHashToField)((0,a._abytes2)(t,n.seed,"seed"),i.ORDER)}function u(e){let r=!(arguments.length>1)||void 0===arguments[1]||arguments[1];return t.BASE.multiply(y(i,e)).toBytes(r)}function c(e){if("bigint"==typeof e)return!1;if(e instanceof t)return!0;let{secretKey:r,publicKey:s,publicKeyUncompressed:o}=n;if(i.allowedLengths||r===s)return;let l=(0,a.ensureBytes)("key",e).length;return l===s||l===o}return Object.freeze({getPublicKey:u,getSharedSecret:function(e,r){let n=!(arguments.length>2)||void 0===arguments[2]||arguments[2];if(!0===c(e))throw Error("first arg must be private key");if(!1===c(r))throw Error("second arg must be public key");let a=y(i,e);return t.fromHex(r).multiply(a).toBytes(n)},keygen:function(t){let e=l(t);return{secretKey:e,publicKey:u(e)}},Point:t,utils:{isValidSecretKey:s,isValidPublicKey:function(e,i){let{publicKey:r,publicKeyUncompressed:a}=n;try{let n=e.length;if(!0===i&&n!==r||!1===i&&n!==a)return!1;return!!t.fromBytes(e)}catch(t){return!1}},randomSecretKey:l,isValidPrivateKey:s,randomPrivateKey:l,normPrivateKeyToScalar:t=>y(i,t),precompute(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:8,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:t.BASE;return i.precompute(e,!1)}},lengths:n})}function b(t,e){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};(0,n.ahash)(e),(0,a._validateObject)(s,{},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"});let o=s.randomBytes||a.randomBytes,l=s.hmac||function(t){for(var i=arguments.length,n=Array(i>1?i-1:0),s=1;s<i;s++)n[s-1]=arguments[s];return(0,r.hmac)(e,t,(0,a.concatBytes)(...n))},{Fp:u,Fn:p}=t,{ORDER:m,BITS:w}=p,{keygen:T,getPublicKey:E,getSharedSecret:I,utils:b,lengths:B}=v(t,s),A={prehash:!1,lowS:"boolean"==typeof s.lowS&&s.lowS,format:void 0,extraEntropy:!1},R="compact";function C(t,e){if(!p.isValidNot0(e))throw Error("invalid signature ".concat(t,": out of range 1..Point.Fn.ORDER"));return e}class _{static fromBytes(t){let e,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:R;if(!function(t,e){c(e);let i=B.signature;(0,a._abytes2)(t,"compact"===e?i:"recovered"===e?i+1:void 0,"".concat(e," signature"))}(t,r),"der"===r){let{r:e,s:r}=i.DER.toSig((0,a._abytes2)(t));return new _(e,r)}"recovered"===r&&(e=t[0],r="compact",t=t.subarray(1));let n=p.BYTES,s=t.subarray(0,n),o=t.subarray(n,2*n);return new _(p.fromBytes(s),p.fromBytes(o),e)}static fromHex(t,e){return this.fromBytes((0,a.hexToBytes)(t),e)}addRecoveryBit(t){return new _(this.r,this.s,t)}recoverPublicKey(e){let i=u.ORDER,{r,s:n,recovery:s}=this;if(null==s||![0,1,2,3].includes(s))throw Error("recovery id invalid");if(m*g<i&&s>1)throw Error("recovery id is ambiguous for h>1 curve");let o=2===s||3===s?r+m:r;if(!u.isValid(o))throw Error("recovery id 2 or 3 invalid");let l=u.toBytes(o),c=t.fromBytes((0,a.concatBytes)(S((1&s)==0),l)),h=p.inv(o),d=P((0,a.ensureBytes)("msgHash",e)),f=p.create(-d*h),w=p.create(n*h),y=t.BASE.multiplyUnsafe(f).add(c.multiplyUnsafe(w));if(y.is0())throw Error("point at infinify");return y.assertValidity(),y}hasHighS(){return this.s>m>>f}toBytes(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:R;if(c(t),"der"===t)return(0,a.hexToBytes)(i.DER.hexFromSig(this));let e=p.toBytes(this.r),r=p.toBytes(this.s);if("recovered"===t){if(null==this.recovery)throw Error("recovery bit must be present");return(0,a.concatBytes)(Uint8Array.of(this.recovery),e,r)}return(0,a.concatBytes)(e,r)}toHex(t){return(0,a.bytesToHex)(this.toBytes(t))}assertValidity(){}static fromCompact(t){return _.fromBytes((0,a.ensureBytes)("sig",t),"compact")}static fromDER(t){return _.fromBytes((0,a.ensureBytes)("sig",t),"der")}normalizeS(){return this.hasHighS()?new _(this.r,p.neg(this.s),this.recovery):this}toDERRawBytes(){return this.toBytes("der")}toDERHex(){return(0,a.bytesToHex)(this.toBytes("der"))}toCompactRawBytes(){return this.toBytes("compact")}toCompactHex(){return(0,a.bytesToHex)(this.toBytes("compact"))}constructor(t,e,i){this.r=C("r",t),this.s=C("s",e),null!=i&&(this.recovery=i),Object.freeze(this)}}let F=s.bits2int||function(t){if(t.length>8192)throw Error("input is too large");let e=(0,a.bytesToNumberBE)(t),i=8*t.length-w;return i>0?e>>BigInt(i):e},P=s.bits2int_modN||function(t){return p.create(F(t))},x=(0,a.bitMask)(w);function D(t){return(0,a.aInRange)("num < 2^"+w,t,d,x),p.toBytes(t)}function k(t,i){return(0,a._abytes2)(t,void 0,"message"),i?(0,a._abytes2)(e(t),void 0,"prehashed message"):t}return Object.freeze({keygen:T,getPublicKey:E,getSharedSecret:I,utils:b,lengths:B,Point:t,sign:function(i,r){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},{seed:s,k2sig:u}=function(e,i,r){if(["recovered","canonical"].some(t=>t in r))throw Error("sign() legacy options not supported");let{lowS:n,prehash:s,extraEntropy:l}=h(r,A),u=P(e=k(e,s)),c=y(p,i),g=[D(c),D(u)];if(null!=l&&!1!==l){let t=!0===l?o(B.secretKey):l;g.push((0,a.ensureBytes)("extraEntropy",t))}return{seed:(0,a.concatBytes)(...g),k2sig:function(e){let i=F(e);if(!p.isValidNot0(i))return;let r=p.inv(i),a=t.BASE.multiply(i).toAffine(),s=p.create(a.x);if(s===d)return;let o=p.create(r*p.create(u+s*c));if(o===d)return;let l=2*(a.x!==s)|Number(a.y&f),h=o;return n&&o>m>>f&&(h=p.neg(o),l^=1),new _(s,h,l)}}}(i=(0,a.ensureBytes)("message",i),r,n);return(0,a.createHmacDrbg)(e.outputLen,p.BYTES,l)(s,u)},verify:function(e,r,n){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},{lowS:o,prehash:l,format:u}=h(s,A);if(n=(0,a.ensureBytes)("publicKey",n),r=k((0,a.ensureBytes)("message",r),l),"strict"in s)throw Error("options.strict was renamed to lowS");let c=void 0===u?function(t){let e,r="string"==typeof t||(0,a.isBytes)(t),n=!r&&null!==t&&"object"==typeof t&&"bigint"==typeof t.r&&"bigint"==typeof t.s;if(!r&&!n)throw Error("invalid signature, expected Uint8Array, hex string or Signature instance");if(n)e=new _(t.r,t.s);else if(r){try{e=_.fromBytes((0,a.ensureBytes)("sig",t),"der")}catch(t){if(!(t instanceof i.DER.Err))throw t}if(!e)try{e=_.fromBytes((0,a.ensureBytes)("sig",t),"compact")}catch(t){return!1}}return!!e&&e}(e):_.fromBytes((0,a.ensureBytes)("sig",e),u);if(!1===c)return!1;try{let e=t.fromBytes(n);if(o&&c.hasHighS())return!1;let{r:i,s:a}=c,s=P(r),l=p.inv(a),u=p.create(s*l),h=p.create(i*l),d=t.BASE.multiplyUnsafe(u).add(e.multiplyUnsafe(h));if(d.is0())return!1;return p.create(d.x)===i}catch(t){return!1}},recoverPublicKey:function(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},{prehash:r}=h(i,A);return e=k(e,r),_.fromBytes(t,"recovered").recoverPublicKey(e).toBytes()},Signature:_,hash:e})}function B(t){let e={a:t.a,b:t.b,p:t.Fp.ORDER,n:t.n,h:t.h,Gx:t.Gx,Gy:t.Gy},i=t.Fp,r=t.allowedPrivateKeyLengths?Array.from(new Set(t.allowedPrivateKeyLengths.map(t=>Math.ceil(t/2)))):void 0,n={Fp:i,Fn:(0,o.Field)(e.n,{BITS:t.nBitLength,allowedLengths:r,modFromBytes:t.wrapPrivateKey}),allowInfinityPoint:t.allowInfinityPoint,endo:t.endo,isTorsionFree:t.isTorsionFree,clearCofactor:t.clearCofactor,fromBytes:t.fromBytes,toBytes:t.toBytes};return{CURVE:e,curveOpts:n}}function A(t,e,i){return function(r){let n=t.sqr(r),a=t.mul(n,r);return t.add(t.add(a,t.mul(r,e)),i)}}},383753,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.getHash=function(t){return{hash:t}},i.createCurve=function(t,e){let i=e=>(0,r.weierstrass)({...t,hash:e});return{...i(e),create:i}};let r=t.r(176097)},138555,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i._DST_scalar=void 0,i.expand_message_xmd=u,i.expand_message_xof=c,i.hash_to_field=h,i.isogenyMap=function(t,e){let i=e.map(t=>Array.from(t).reverse());return(e,r)=>{let[a,s,o,l]=i.map(i=>i.reduce((i,r)=>t.add(t.mul(i,e),r))),[u,c]=(0,n.FpInvertBatch)(t,[s,l],!0);return e=t.mul(a,u),r=t.mul(r,t.mul(o,c)),{x:e,y:r}}},i.createHasher=function(t,e,r){if("function"!=typeof e)throw Error("mapToCurve() must be defined");function n(i){return t.fromAffine(e(i))}function a(e){let i=e.clearCofactor();return i.equals(t.ZERO)?t.ZERO:(i.assertValidity(),i)}return{defaults:r,hashToCurve(t,e){let i=h(t,2,Object.assign({},r,e)),s=n(i[0]),o=n(i[1]);return a(s.add(o))},encodeToCurve(t,e){let i=r.encodeDST?{DST:r.encodeDST}:{};return a(n(h(t,1,Object.assign({},r,i,e))[0]))},mapToCurve(t){if(!Array.isArray(t))throw Error("expected array of bigints");for(let e of t)if("bigint"!=typeof e)throw Error("expected array of bigints");return a(n(t))},hashToScalar:(e,n)=>h(e,1,Object.assign({},r,{p:t.Fn.ORDER,m:1,DST:i._DST_scalar},n))[0][0]}};let r=t.r(609074),n=t.r(284564),a=r.bytesToNumberBE;function s(t,e){if(o(t),o(e),t<0||t>=1<<8*e)throw Error("invalid I2OSP input: "+t);let i=Array.from({length:e}).fill(0);for(let r=e-1;r>=0;r--)i[r]=255&t,t>>>=8;return new Uint8Array(i)}function o(t){if(!Number.isSafeInteger(t))throw Error("number expected")}function l(t){if(!(0,r.isBytes)(t)&&"string"!=typeof t)throw Error("DST must be Uint8Array or string");return"string"==typeof t?(0,r.utf8ToBytes)(t):t}function u(t,e,i,n){(0,r.abytes)(t),o(i),(e=l(e)).length>255&&(e=n((0,r.concatBytes)((0,r.utf8ToBytes)("H2C-OVERSIZE-DST-"),e)));let{outputLen:a,blockLen:u}=n,c=Math.ceil(i/a);if(i>65535||c>255)throw Error("expand_message_xmd: invalid lenInBytes");let h=(0,r.concatBytes)(e,s(e.length,1)),p=s(0,u),d=s(i,2),f=Array(c),g=n((0,r.concatBytes)(p,t,d,s(0,1),h));f[0]=n((0,r.concatBytes)(g,s(1,1),h));for(let t=1;t<=c;t++){let e=[function(t,e){let i=new Uint8Array(t.length);for(let r=0;r<t.length;r++)i[r]=t[r]^e[r];return i}(g,f[t-1]),s(t+1,1),h];f[t]=n((0,r.concatBytes)(...e))}return(0,r.concatBytes)(...f).slice(0,i)}function c(t,e,i,n,a){if((0,r.abytes)(t),o(i),(e=l(e)).length>255){let t=Math.ceil(2*n/8);e=a.create({dkLen:t}).update((0,r.utf8ToBytes)("H2C-OVERSIZE-DST-")).update(e).digest()}if(i>65535||e.length>255)throw Error("expand_message_xof: invalid lenInBytes");return a.create({dkLen:i}).update(t).update(s(i,2)).update(e).update(s(e.length,1)).digest()}function h(t,e,i){let s;(0,r._validateObject)(i,{p:"bigint",m:"number",k:"number",hash:"function"});let{p:l,k:h,m:p,hash:d,expand:f,DST:g}=i;if(!(0,r.isHash)(i.hash))throw Error("expected valid hash");(0,r.abytes)(t),o(e);let m=Math.ceil((l.toString(2).length+h)/8),w=e*p*m;if("xmd"===f)s=u(t,g,w,d);else if("xof"===f)s=c(t,g,w,h,d);else if("_internal_pass"===f)s=t;else throw Error('expand must be "xmd" or "xof"');let y=Array(e);for(let t=0;t<e;t++){let e=Array(p);for(let i=0;i<p;i++){let r=m*(i+t*p),o=s.subarray(r,r+m);e[i]=(0,n.mod)(a(o),l)}y[t]=e}return y}i._DST_scalar=(0,r.utf8ToBytes)("HashToScalar-")},605957,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.encodeToCurve=i.hashToCurve=i.secp256k1_hasher=i.schnorr=i.secp256k1=void 0;let r=t.r(14582),n=t.r(857024),a=t.r(383753),s=t.r(138555),o=t.r(284564),l=t.r(176097),u=t.r(609074),c={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),n:BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),h:BigInt(1),a:BigInt(0),b:BigInt(7),Gx:BigInt("0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798"),Gy:BigInt("0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8")},h={beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),basises:[[BigInt("0x3086d221a7d46bcde86c90e49284eb15"),-BigInt("0xe4437ed6010e88286f547fa90abfe4c3")],[BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),BigInt("0x3086d221a7d46bcde86c90e49284eb15")]]},p=BigInt(0),d=BigInt(1),f=BigInt(2),g=(0,o.Field)(c.p,{sqrt:function(t){let e=c.p,i=BigInt(3),r=BigInt(6),n=BigInt(11),a=BigInt(22),s=BigInt(23),l=BigInt(44),u=BigInt(88),h=t*t*t%e,p=h*h*t%e,d=(0,o.pow2)(p,i,e)*p%e,m=(0,o.pow2)(d,i,e)*p%e,w=(0,o.pow2)(m,f,e)*h%e,y=(0,o.pow2)(w,n,e)*w%e,T=(0,o.pow2)(y,a,e)*y%e,S=(0,o.pow2)(T,l,e)*T%e,E=(0,o.pow2)(S,u,e)*S%e,I=(0,o.pow2)(E,l,e)*T%e,v=(0,o.pow2)(I,i,e)*p%e,b=(0,o.pow2)(v,s,e)*y%e,B=(0,o.pow2)(b,r,e)*h%e,A=(0,o.pow2)(B,f,e);if(!g.eql(g.sqr(A),t))throw Error("Cannot find square root");return A}});i.secp256k1=(0,a.createCurve)({...c,Fp:g,lowS:!0,endo:h},r.sha256);let m={};function w(t){for(var e=arguments.length,i=Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];let a=m[t];if(void 0===a){let e=(0,r.sha256)((0,u.utf8ToBytes)(t));a=(0,u.concatBytes)(e,e),m[t]=a}return(0,r.sha256)((0,u.concatBytes)(a,...i))}let y=t=>t.toBytes(!0).slice(1),T=i.secp256k1.Point;function S(t){let{Fn:e,BASE:i}=T,r=(0,l._normFnElement)(e,t),n=i.multiply(r);return{scalar:n.y%f===p?r:e.neg(r),bytes:y(n)}}function E(t){if(!g.isValidNot0(t))throw Error("invalid x: Fail if x  p");let e=g.create(t*t),i=g.create(e*t+BigInt(7)),r=g.sqrt(i);r%f!==p&&(r=g.neg(r));let n=T.fromAffine({x:t,y:r});return n.assertValidity(),n}let I=u.bytesToNumberBE;function v(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];return T.Fn.create(I(w("BIP0340/challenge",...e)))}function b(t){return S(t).bytes}function B(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:(0,n.randomBytes)(32),{Fn:r}=T,a=(0,u.ensureBytes)("message",t),{bytes:s,scalar:o}=S(e),l=(0,u.ensureBytes)("auxRand",i,32),c=r.toBytes(o^I(w("BIP0340/aux",l))),{bytes:h,scalar:p}=S(w("BIP0340/nonce",c,s,a)),d=v(h,s,a),f=new Uint8Array(64);if(f.set(h,0),f.set(r.toBytes(r.create(p+d*o)),32),!A(f,a,s))throw Error("sign: Invalid signature produced");return f}function A(t,e,i){let{Fn:r,BASE:n}=T,a=(0,u.ensureBytes)("signature",t,64),s=(0,u.ensureBytes)("message",e),o=(0,u.ensureBytes)("publicKey",i,32);try{let t=E(I(o)),e=I(a.subarray(0,32));if(!(0,u.inRange)(e,d,c.p))return!1;let i=I(a.subarray(32,64));if(!(0,u.inRange)(i,d,c.n))return!1;let l=v(r.toBytes(e),y(t),s),h=n.multiplyUnsafe(i).add(t.multiplyUnsafe(r.neg(l))),{x:g,y:m}=h.toAffine();if(h.is0()||m%f!==p||g!==e)return!1;return!0}catch(t){return!1}}i.schnorr=(()=>{let t=function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,n.randomBytes)(48);return(0,o.mapHashToField)(t,c.n)};return i.secp256k1.utils.randomSecretKey,{keygen:function(e){let i=t(e);return{secretKey:i,publicKey:b(i)}},getPublicKey:b,sign:B,verify:A,Point:T,utils:{randomSecretKey:t,randomPrivateKey:t,taggedHash:w,lift_x:E,pointToBytes:y,numberToBytesBE:u.numberToBytesBE,bytesToNumberBE:u.bytesToNumberBE,mod:o.mod},lengths:{secretKey:32,publicKey:32,publicKeyHasPrefix:!1,signature:64,seed:48}}})();let R=(0,s.isogenyMap)(g,[["0x8e38e38e38e38e38e38e38e38e38e38e38e38e38e38e38e38e38e38daaaaa8c7","0x7d3d4c80bc321d5b9f315cea7fd44c5d595d2fc0bf63b92dfff1044f17c6581","0x534c328d23f234e6e2a413deca25caece4506144037c40314ecbd0b53d9dd262","0x8e38e38e38e38e38e38e38e38e38e38e38e38e38e38e38e38e38e38daaaaa88c"],["0xd35771193d94918a9ca34ccbb7b640dd86cd409542f8487d9fe6b745781eb49b","0xedadc6f64383dc1df7c4b2d51b54225406d36b641f5e41bbc52a56612a8c6d14","0x0000000000000000000000000000000000000000000000000000000000000001"],["0x4bda12f684bda12f684bda12f684bda12f684bda12f684bda12f684b8e38e23c","0xc75e0c32d5cb7c0fa9d0a54b12a0a6d5647ab046d686da6fdffc90fc201d71a3","0x29a6194691f91a73715209ef6512e576722830a201be2018a765e85a9ecee931","0x2f684bda12f684bda12f684bda12f684bda12f684bda12f684bda12f38e38d84"],["0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffff93b","0x7a06534bb8bdb49fd5e9e6632722c2989467c1bfc8e8d978dfb425d2685c2573","0x6484aa716545ca2cf3a70c3fa8fe337e0a3d21162f0d6299a7bf8192bfd2a76f","0x0000000000000000000000000000000000000000000000000000000000000001"]].map(t=>t.map(t=>BigInt(t)))),C=(0,l.mapToCurveSimpleSWU)(g,{A:BigInt("0x3f8731abdd661adca08a5558f0f5d272e953d363cb6f0e5d405447c01a444533"),B:BigInt("1771"),Z:g.create(BigInt("-11"))});i.secp256k1_hasher=(0,s.createHasher)(i.secp256k1.Point,t=>{let{x:e,y:i}=C(g.create(t[0]));return R(e,i)},{DST:"secp256k1_XMD:SHA-256_SSWU_RO_",encodeDST:"secp256k1_XMD:SHA-256_SSWU_NU_",p:g.ORDER,m:1,k:128,expand:"xmd",hash:r.sha256}),i.hashToCurve=i.secp256k1_hasher.hashToCurve,i.encodeToCurve=i.secp256k1_hasher.encodeToCurve},532550,(t,e,i)=>{var r="__lodash_hash_undefined__",n="[object Arguments]",a="[object Boolean]",s="[object Date]",o="[object Function]",l="[object GeneratorFunction]",u="[object Map]",c="[object Number]",h="[object Object]",p="[object Promise]",d="[object RegExp]",f="[object Set]",g="[object String]",m="[object Symbol]",w="[object WeakMap]",y="[object ArrayBuffer]",T="[object DataView]",S="[object Float32Array]",E="[object Float64Array]",I="[object Int8Array]",v="[object Int16Array]",b="[object Int32Array]",B="[object Uint8Array]",A="[object Uint8ClampedArray]",R="[object Uint16Array]",C="[object Uint32Array]",_=/\w*$/,F=/^\[object .+?Constructor\]$/,P=/^(?:0|[1-9]\d*)$/,x={};x[n]=x["[object Array]"]=x[y]=x[T]=x[a]=x[s]=x[S]=x[E]=x[I]=x[v]=x[b]=x[u]=x[c]=x[h]=x[d]=x[f]=x[g]=x[m]=x[B]=x[A]=x[R]=x[C]=!0,x["[object Error]"]=x[o]=x[w]=!1;var D=t.g&&t.g.Object===Object&&t.g,k="object"==typeof self&&self&&self.Object===Object&&self,O=D||k||Function("return this")(),L=i&&!i.nodeType&&i,N=L&&e&&!e.nodeType&&e,M=N&&N.exports===L;function U(t,e){return t.set(e[0],e[1]),t}function q(t,e){return t.add(e),t}function W(t,e,i,r){var n=-1,a=t?t.length:0;for(r&&a&&(i=t[++n]);++n<a;)i=e(i,t[n],n,t);return i}function j(t){var e=!1;if(null!=t&&"function"!=typeof t.toString)try{e=!!(t+"")}catch(t){}return e}function H(t){var e=-1,i=Array(t.size);return t.forEach(function(t,r){i[++e]=[r,t]}),i}function V(t,e){return function(i){return t(e(i))}}function z(t){var e=-1,i=Array(t.size);return t.forEach(function(t){i[++e]=t}),i}var X=Array.prototype,K=Function.prototype,G=Object.prototype,Q=O["__core-js_shared__"],Z=function(){var t=/[^.]+$/.exec(Q&&Q.keys&&Q.keys.IE_PROTO||"");return t?"Symbol(src)_1."+t:""}(),Y=K.toString,J=G.hasOwnProperty,$=G.toString,tt=RegExp("^"+Y.call(J).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),te=M?O.Buffer:void 0,ti=O.Symbol,tr=O.Uint8Array,tn=V(Object.getPrototypeOf,Object),ta=Object.create,ts=G.propertyIsEnumerable,to=X.splice,tl=Object.getOwnPropertySymbols,tu=te?te.isBuffer:void 0,tc=V(Object.keys,Object),th=tD(O,"DataView"),tp=tD(O,"Map"),td=tD(O,"Promise"),tf=tD(O,"Set"),tg=tD(O,"WeakMap"),tm=tD(Object,"create"),tw=tN(th),ty=tN(tp),tT=tN(td),tS=tN(tf),tE=tN(tg),tI=ti?ti.prototype:void 0,tv=tI?tI.valueOf:void 0;function tb(t){var e=-1,i=t?t.length:0;for(this.clear();++e<i;){var r=t[e];this.set(r[0],r[1])}}function tB(t){var e=-1,i=t?t.length:0;for(this.clear();++e<i;){var r=t[e];this.set(r[0],r[1])}}function tA(t){var e=-1,i=t?t.length:0;for(this.clear();++e<i;){var r=t[e];this.set(r[0],r[1])}}function tR(t){this.__data__=new tB(t)}function tC(t,e,i){var r=t[e];J.call(t,e)&&tM(r,i)&&(void 0!==i||e in t)||(t[e]=i)}function t_(t,e){for(var i=t.length;i--;)if(tM(t[i][0],e))return i;return -1}function tF(t){var e=new t.constructor(t.byteLength);return new tr(e).set(new tr(t)),e}function tP(t,e,i,r){i||(i={});for(var n=-1,a=e.length;++n<a;){var s=e[n],o=r?r(i[s],t[s],s,i,t):void 0;tC(i,s,void 0===o?t[s]:o)}return i}function tx(t,e){var i,r,n=t.__data__;return("string"==(r=typeof(i=e))||"number"==r||"symbol"==r||"boolean"==r?"__proto__"!==i:null===i)?n["string"==typeof e?"string":"hash"]:n.map}function tD(t,e){var i,r=null==t?void 0:t[e];return!(!tH(r)||(i=r,Z&&Z in i))&&(tj(r)||j(r)?tt:F).test(tN(r))?r:void 0}tb.prototype.clear=function(){this.__data__=tm?tm(null):{}},tb.prototype.delete=function(t){return this.has(t)&&delete this.__data__[t]},tb.prototype.get=function(t){var e=this.__data__;if(tm){var i=e[t];return i===r?void 0:i}return J.call(e,t)?e[t]:void 0},tb.prototype.has=function(t){var e=this.__data__;return tm?void 0!==e[t]:J.call(e,t)},tb.prototype.set=function(t,e){return this.__data__[t]=tm&&void 0===e?r:e,this},tB.prototype.clear=function(){this.__data__=[]},tB.prototype.delete=function(t){var e=this.__data__,i=t_(e,t);return!(i<0)&&(i==e.length-1?e.pop():to.call(e,i,1),!0)},tB.prototype.get=function(t){var e=this.__data__,i=t_(e,t);return i<0?void 0:e[i][1]},tB.prototype.has=function(t){return t_(this.__data__,t)>-1},tB.prototype.set=function(t,e){var i=this.__data__,r=t_(i,t);return r<0?i.push([t,e]):i[r][1]=e,this},tA.prototype.clear=function(){this.__data__={hash:new tb,map:new(tp||tB),string:new tb}},tA.prototype.delete=function(t){return tx(this,t).delete(t)},tA.prototype.get=function(t){return tx(this,t).get(t)},tA.prototype.has=function(t){return tx(this,t).has(t)},tA.prototype.set=function(t,e){return tx(this,t).set(t,e),this},tR.prototype.clear=function(){this.__data__=new tB},tR.prototype.delete=function(t){return this.__data__.delete(t)},tR.prototype.get=function(t){return this.__data__.get(t)},tR.prototype.has=function(t){return this.__data__.has(t)},tR.prototype.set=function(t,e){var i=this.__data__;if(i instanceof tB){var r=i.__data__;if(!tp||r.length<199)return r.push([t,e]),this;i=this.__data__=new tA(r)}return i.set(t,e),this};var tk=tl?V(tl,Object):function(){return[]},tO=function(t){return $.call(t)};function tL(t){var e=t&&t.constructor;return t===("function"==typeof e&&e.prototype||G)}function tN(t){if(null!=t){try{return Y.call(t)}catch(t){}try{return t+""}catch(t){}}return""}function tM(t,e){return t===e||t!=t&&e!=e}(th&&tO(new th(new ArrayBuffer(1)))!=T||tp&&tO(new tp)!=u||td&&tO(td.resolve())!=p||tf&&tO(new tf)!=f||tg&&tO(new tg)!=w)&&(tO=function(t){var e=$.call(t),i=e==h?t.constructor:void 0,r=i?tN(i):void 0;if(r)switch(r){case tw:return T;case ty:return u;case tT:return p;case tS:return f;case tE:return w}return e});var tU=Array.isArray;function tq(t){var e;return null!=t&&"number"==typeof(e=t.length)&&e>-1&&e%1==0&&e<=0x1fffffffffffff&&!tj(t)}var tW=tu||function(){return!1};function tj(t){var e=tH(t)?$.call(t):"";return e==o||e==l}function tH(t){var e=typeof t;return!!t&&("object"==e||"function"==e)}function tV(t){return tq(t)?function(t,e){var i,r,a,s,o,l=tU(t)||(a=r=i=t)&&"object"==typeof a&&tq(r)&&J.call(i,"callee")&&(!ts.call(i,"callee")||$.call(i)==n)?function(t,e){for(var i=-1,r=Array(t);++i<t;)r[i]=e(i);return r}(t.length,String):[],u=l.length,c=!!u;for(var h in t){J.call(t,h)&&!(c&&("length"==h||(s=h,(o=null==(o=u)?0x1fffffffffffff:o)&&("number"==typeof s||P.test(s))&&s>-1&&s%1==0&&s<o)))&&l.push(h)}return l}(t):function(t){if(!tL(t))return tc(t);var e=[];for(var i in Object(t))J.call(t,i)&&"constructor"!=i&&e.push(i);return e}(t)}e.exports=function(t){return function t(e,i,r,p,w,F,P){if(p&&(D=F?p(e,w,F,P):p(e)),void 0!==D)return D;if(!tH(e))return e;var D,k=tU(e);if(k){if(L=(O=e).length,N=O.constructor(L),L&&"string"==typeof O[0]&&J.call(O,"index")&&(N.index=O.index,N.input=O.input),D=N,!i){var O,L,N,M=e,V=D,X=-1,K=M.length;for(V||(V=Array(K));++X<K;)V[X]=M[X];return V}}else{var G,Q,Z,Y,$,tt=tO(e),te=tt==o||tt==l;if(tW(e)){var ti=e,tr=i;if(tr)return ti.slice();var ts=new ti.constructor(ti.length);return ti.copy(ts),ts}if(tt==h||tt==n||te&&!F){if(j(e))return F?e:{};if(D="function"!=typeof(G=te?{}:e).constructor||tL(G)?{}:tH(Q=tn(G))?ta(Q):{},!i){return Z=e,Y=($=D)&&tP(e,tV(e),$),tP(Z,tk(Z),Y)}}else{if(!x[tt])return F?e:{};D=function(t,e,i,r){var n,o,l,h=t.constructor;switch(e){case y:return tF(t);case a:case s:return new h(+t);case T:return n=r?tF(t.buffer):t.buffer,new t.constructor(n,t.byteOffset,t.byteLength);case S:case E:case I:case v:case b:case B:case A:case R:case C:return o=r?tF(t.buffer):t.buffer,new t.constructor(o,t.byteOffset,t.length);case u:return W(r?i(H(t),!0):H(t),U,new t.constructor);case c:case g:return new h(t);case d:return(l=new t.constructor(t.source,_.exec(t))).lastIndex=t.lastIndex,l;case f:return W(r?i(z(t),!0):z(t),q,new t.constructor);case m:return tv?Object(tv.call(t)):{}}}(e,tt,t,i)}}P||(P=new tR);var to=P.get(e);if(to)return to;if(P.set(e,D),!k)var tl=r?function(t){var e;return e=tV(t),tU(t)?e:function(t,e){for(var i=-1,r=e.length,n=t.length;++i<r;)t[n+i]=e[i];return t}(e,tk(t))}(e):tV(e);return!function(t,e){for(var i=-1,r=t?t.length:0;++i<r&&!1!==e(t[i],i,t););}(tl||e,function(n,a){tl&&(n=e[a=n]),tC(D,a,t(n,i,r,p,a,e,P))}),D}(t,!0,!0)}},20349,(t,e,i)=>{"use strict";let r=t.r(186016).sha256,n=t.r(971501),a=t.r(242524).Buffer,s=t.r(460058),o=t.r(605957).secp256k1,l=t.r(532550),u={bech32:"bc",pubKeyHash:0,scriptHash:5,validWitnessVersions:[0,1],wif:128},c={bech32:"tb",pubKeyHash:111,scriptHash:196,validWitnessVersions:[0,1],wif:239},h={bech32:"bcrt",pubKeyHash:111,scriptHash:196,validWitnessVersions:[0,1],wif:239},p={bech32:"sb",pubKeyHash:63,scriptHash:123,validWitnessVersions:[0,1],wif:239},d={word_length:4,var_onion_optin:{required:!1,supported:!0},payment_secret:{required:!1,supported:!0}},f=["option_data_loss_protect","initial_routing_sync","option_upfront_shutdown_script","gossip_queries","var_onion_optin","gossip_queries_ex","option_static_remotekey","payment_secret","basic_mpp","option_support_large_channel"],g={m:1000n,u:1000000n,n:1000000000n,p:1000000000000n},m={payment_hash:1,payment_secret:16,description:13,payee_node_key:19,purpose_commit_hash:23,expire_time:6,min_final_cltv_expiry:24,fallback_address:9,routing_info:3,feature_bits:5,blinded_payinfo:20},w={};for(let t=0,e=Object.keys(m);t<e.length;t++){let i=e[t];w[m[e[t]].toString()]=i}let y={payment_hash:R,payment_secret:R,description:function(t){let e=a.from(t,"utf8");return n.toWords(e)},payee_node_key:R,purpose_commit_hash:function(t){let e;if(void 0!==t&&("string"==typeof t||t instanceof String))e=t.match(/^([a-zA-Z0-9]{2})*$/)?a.from(t,"hex"):v(a.from(t,"utf8"));else throw Error("purpose or purpose commit must be a string or hex string");return n.toWords(e)},expire_time:I,min_final_cltv_expiry:I,fallback_address:function(t,e){return[t.code].concat(R(t.addressHash))},routing_info:function(t){let e=a.from([]);return t.forEach(t=>{e=a.concat([e,A(t.pubkey)]),e=a.concat([e,A(t.short_channel_id)]),e=a.concat([e,a.from([0,0,0].concat(I(t.fee_base_msat,8)).slice(-4))]),e=a.concat([e,a.from([0,0,0].concat(I(t.fee_proportional_millionths,8)).slice(-4))]),e=a.concat([e,a.from([0].concat(I(t.cltv_expiry_delta,8)).slice(-2))])}),R(e)},feature_bits:function(t){let e=t.word_length,i=[];for(f.forEach(e=>{i.push(!!(t[e]||{}).required),i.push(!!(t[e]||{}).supported)});!1===i[i.length-1];)i.pop();for(;i.length%5!=0;)i.push(!1);if(t.extra_bits&&Array.isArray(t.extra_bits.bits)&&t.extra_bits.bits.length>0){for(;i.length<t.extra_bits.start_bit;)i.push(!1);i=i.concat(t.extra_bits.bits)}if(void 0!==e&&i.length/5>e)throw Error("word_length is too small to contain all featureBits");return void 0===e&&(e=Math.ceil(i.length/5)),Array(e).fill(0).map((t,e)=>i[5*e+4]<<4|i[5*e+3]<<3|i[5*e+2]<<2|i[5*e+1]<<1|(0|i[5*e])).reverse()}},T={1:t=>B(t,!0).toString("hex"),16:t=>B(t,!0).toString("hex"),13:t=>B(t,!0).toString("utf8"),19:t=>B(t,!0).toString("hex"),23:t=>B(t,!0).toString("hex"),6:E,24:E,9:function(t,e){let i=t[0],r=B(t=t.slice(1),!0),n=null;switch(i){case 17:n=s.Address(e).encode({type:"pkh",hash:r});break;case 18:n=s.Address(e).encode({type:"sh",hash:r});break;case 0:n=20===r.length?s.Address(e).encode({type:"wpkh",hash:r}):s.Address(e).encode({type:"wsh",hash:r});break;case 1:n=s.Address(e).encode({type:"tr",pubkey:r})}return{code:i,address:n,addressHash:r.toString("hex")}},3:function(t){let e,i,r,n,a,s=[],o=B(t,!0);for(;o.length>0;)e=o.slice(0,33).toString("hex"),i=o.slice(33,41).toString("hex"),r=parseInt(o.slice(41,45).toString("hex"),16),n=parseInt(o.slice(45,49).toString("hex"),16),a=parseInt(o.slice(49,51).toString("hex"),16),o=o.slice(51),s.push({pubkey:e,short_channel_id:i,fee_base_msat:r,fee_proportional_millionths:n,cltv_expiry_delta:a});return s},5:function(t){let e=t.slice().reverse().map(t=>[!!(1&t),!!(2&t),!!(4&t),!!(8&t),!!(16&t)]).reduce((t,e)=>t.concat(e),[]);for(;e.length<2*f.length;)e.push(!1);let i={word_length:t.length};if(f.forEach((t,r)=>{i[t]={required:e[2*r],supported:e[2*r+1]}}),e.length>2*f.length){let t=e.slice(2*f.length);i.extra_bits={start_bit:2*f.length,bits:t,has_required:t.reduce((t,e,i)=>i%2!=0?t||!1:t||e,!1)}}else i.extra_bits={start_bit:2*f.length,bits:[],has_required:!1};return i},20:function(t){let e=B(t,!0),i=e.readUInt32BE(0),r=e.readUInt32BE(4),n=e.readUInt16BE(8),a=BigInt("0x"+e.slice(10,18).toString("hex")),s=BigInt("0x"+e.slice(18,26).toString("hex")),o=e.readUInt16BE(26),l=28,u=[...e.slice(l,l+o)];l+=o;let c=e.slice(l,l+33).toString("hex");l+=33;let h=e.readUInt8(l);l++;let p=[];for(let t=0;t<h;t++){let[t,i]=function(t,e){let i=t.slice(e,e+33),[r,n]=function(t,e){let i=t.readUInt8(e);switch(e++,i){case 253:return[t.readUInt16BE(e),e+2];case 254:return[t.readUInt32BE(e),e+4];case 255:return[parseInt(t.slice(e,e+8).toString("hex"),16),e+8];default:return[i,e]}}(t,e+=33);e=n;let a=t.slice(e,e+r);return e+=r,[{blinded_node_pubkey:i.toString("hex"),cipher_text:a.toString("hex")},e]}(e,l);l=i,p.push(t)}return{fee_base_msat:i,fee_proportional_millionths:r,cltv_expiry_delta:n,htlc_minimum_msat:a,htlc_maximum_msat:s,features:u,first_ephemeral_blinding_point:c,blinded_hops:p,introduction_node:p[0].blinded_node_pubkey}}},S="unknownTag";function E(t){return t.reverse().reduce((t,e,i)=>t+e*Math.pow(32,i),0)}function I(t,e){let i=[];if(void 0===e&&(e=5),0===(t=Math.floor(t)))return[0];for(;t>0;)i.push(t&Math.pow(2,e)-1),t=Math.floor(t/Math.pow(2,e));return i.reverse()}function v(t){return a.from(r(t))}function b(t,e,i){let r=0,n=0,a=(1<<i)-1,s=[];for(let o=0;o<t.length;++o)for(r=r<<e|t[o],n+=e;n>=i;)s.push(r>>(n-=i)&a);return n>0&&s.push(r<<i-n&a),s}function B(t,e){let i=a.from(b(t,5,8,!0));return e&&5*t.length%8!=0&&(i=i.slice(0,-1)),i}function A(t){return void 0!==t&&("string"==typeof t||t instanceof String)&&t.match(/^([a-zA-Z0-9]{2})*$/)?a.from(t,"hex"):t}function R(t){let e=A(t);return n.toWords(e)}function C(t,e){let i=t.filter(t=>t.tagName===e);return i.length>0?i[0].data:null}function _(t,e){return null!==C(t,e)}function F(t,e){let i={};if(Object.keys(t).sort().forEach(e=>{i[e]=t[e]}),!0===e){let t="__tagsObject_cache";Object.defineProperty(i,"tagsObject",{get(){return this[t]||Object.defineProperty(this,t,{value:function(t){let e={};return t.forEach(t=>{t.tagName===S?(e.unknownTags||(e.unknownTags=[]),e.unknownTags.push(t.data)):"blinded_payinfo"===t.tagName?(null==e[t.tagName]&&(e[t.tagName]=[]),e[t.tagName].push(t.data)):e[t.tagName]=t.data}),e}(this.tags)}),this[t]}})}return i}function P(t){if(!t.toString().match(/^\d+$/))throw Error("satoshis must be an integer");return x(1000n*BigInt(t))}function x(t){let e,i;if(!t.toString().match(/^\d+$/))throw Error("millisatoshis must be an integer");let r=BigInt(t),n=r.toString(10),a=n.length;return a>11&&/0{11}$/.test(n)?(e="",i=(r/100000000000n).toString(10)):a>8&&/0{8}$/.test(n)?(e="m",i=(r/100000000n).toString(10)):a>5&&/0{5}$/.test(n)?(e="u",i=(r/100000n).toString(10)):a>2&&/0{2}$/.test(n)?(e="n",i=(r/100n).toString(10)):(e="p",i=(10n*r).toString(10)),i+e}function D(t,e){let i=k(t,!1);if(i%1000n!==0n)throw Error("Amount is outside of valid range");let r=i/1000n;return e?r.toString(10):r}function k(t,e){let i,r;if(t.slice(-1).match(/^[munp]$/))i=t.slice(-1),r=t.slice(0,-1);else if(t.slice(-1).match(/^[^munp0-9]$/))throw Error("Not a valid multiplier for the amount");else r=t;if(!r.match(/^\d+$/))throw Error("Not a valid human readable amount");let n=BigInt(r),a=i?100000000000n*n/g[i]:100000000000n*n;if("p"===i&&n%10n!==0n||a>0x1d24b2dfac520000n)throw Error("Amount is outside of valid range");return e?a.toString(10):a}e.exports={encode:function(t,e){let i,r,c,h,p,f,g,T,E=l(t);void 0===e&&(e=!0);let B=void 0!==E.signature&&void 0!==E.recoveryFlag;if(void 0!==E.network||B)if(void 0===E.network&&B)throw Error("Need network for proper payment request reconstruction");else{if(!E.network.bech32||void 0===E.network.pubKeyHash||void 0===E.network.scriptHash||!Array.isArray(E.network.validWitnessVersions)||void 0===E.network.wif)throw Error("Invalid network");i=E.network}else E.network=u,i=u;if(void 0!==E.timestamp||B){if(void 0===E.timestamp&&B)throw Error("Need timestamp for proper payment request reconstruction")}else E.timestamp=Math.floor(new Date().getTime()/1e3);if(void 0===E.tags)throw Error("Payment Requests need tags array");if(!_(E.tags,w["1"]))throw Error("Lightning Payment Request needs a payment hash");if(_(E.tags,w["16"]))if(_(E.tags,w["5"])){let t=C(E.tags,w["5"]);if(!t.payment_secret||!t.payment_secret.supported&&!t.payment_secret.required)throw Error("Payment request requires feature bits with at least payment secret support flagged if payment secret is included")}else if(e)E.tags.push({tagName:w["5"],data:d});else throw Error("Payment request requires feature bits with at least payment secret support flagged if payment secret is included");if(!_(E.tags,w["13"])&&!_(E.tags,w["23"]))if(e)E.tags.push({tagName:w["13"],data:""});else throw Error("Payment request requires description or purpose commit hash");if(_(E.tags,w["13"])&&a.from(C(E.tags,w["13"]),"utf8").length>639)throw Error("Description is too long: Max length 639 bytes");if(_(E.tags,w["6"])||B||!e||E.tags.push({tagName:w["6"],data:3600}),_(E.tags,w["24"])||B||!e||E.tags.push({tagName:w["24"],data:9}),_(E.tags,w["19"])&&(c=A(C(E.tags,w["19"]))),E.payeeNodeKey&&(r=A(E.payeeNodeKey)),r&&c&&!c.equals(r))throw Error("payeeNodeKey and tag payee node key do not match");if((r=r||c)&&(E.payeeNodeKey=r.toString("hex")),_(E.tags,w["9"])){let t=C(E.tags,w["9"]);if(f=t.address,p=t.addressHash,h=t.code,void 0===p||void 0===h){let e;try{e=s.Address(i).decode(f)}catch(t){throw Error("Fallback address invalid format")}switch(e.type){case"pkh":p=e.hash,h=17;break;case"sh":p=e.hash,h=18;break;case"wsh":case"wpkh":p=e.hash,h=0;break;case"tr":p=e.pubkey,h=1;break;default:throw Error("Fallback address format is unknown")}t.addressHash=a.from(p).toString("hex"),t.code=h}}_(E.tags,w["3"])&&C(E.tags,w["3"]).forEach(t=>{if(void 0===t.pubkey||void 0===t.short_channel_id||void 0===t.fee_base_msat||void 0===t.fee_proportional_millionths||void 0===t.cltv_expiry_delta)throw Error("Routing info is incomplete");try{o.ProjectivePoint.fromHex(A(t.pubkey))}catch(t){throw Error("Routing info pubkey is not a valid pubkey")}let e=A(t.short_channel_id);if(!(e instanceof a)||8!==e.length)throw Error("Routing info short channel id must be 8 bytes");if("number"!=typeof t.fee_base_msat||Math.floor(t.fee_base_msat)!==t.fee_base_msat)throw Error("Routing info fee base msat is not an integer");if("number"!=typeof t.fee_proportional_millionths||Math.floor(t.fee_proportional_millionths)!==t.fee_proportional_millionths)throw Error("Routing info fee proportional millionths is not an integer");if("number"!=typeof t.cltv_expiry_delta||Math.floor(t.cltv_expiry_delta)!==t.cltv_expiry_delta)throw Error("Routing info cltv expiry delta is not an integer")});let D="ln";if(D+=i.bech32,E.millisatoshis&&E.satoshis){if(g=x(BigInt(E.millisatoshis)),P(BigInt(E.satoshis))!==g)throw Error("satoshis and millisatoshis do not match")}else g=E.millisatoshis?x(BigInt(E.millisatoshis)):E.satoshis?P(BigInt(E.satoshis)):"";D+=g;let k=I(E.timestamp);for(;k.length<7;)k.unshift(0);let O=E.tags,L=[];O.forEach(t=>{let e,i=Object.keys(y);if(B&&i.push(S),-1===i.indexOf(t.tagName))throw Error("Unknown tag key: "+t.tagName);if(t.tagName!==S)L.push(m[t.tagName]),e=(0,y[t.tagName])(t.data);else{var r;let i=((r=t.data).words=n.decode(r.words,Number.MAX_SAFE_INTEGER).words,r);L.push(i.tagCode),e=i.words}L=(L=L.concat([0].concat(I(e.length)).slice(-2))).concat(e)});let N=k.concat(L),M=v(a.concat([a.from(D,"utf8"),a.from(b(N,5,8))]));if(B)if(r){let t=o.Signature.fromCompact(a.from(E.signature,"hex")).addRecoveryBit(E.recoveryFlag),e=a.from(t.recoverPublicKey(M).toRawBytes(!0));if(r&&!r.equals(e))throw Error("Signature, message, and recoveryID did not produce the same pubkey as payeeNodeKey");T=R(E.signature+"0"+E.recoveryFlag)}else throw Error("Reconstruction with signature and recoveryID requires payeeNodeKey to verify correctness of input data.");return T&&(N=N.concat(T)),_(E.tags,w["6"])&&(E.timeExpireDate=E.timestamp+C(E.tags,w["6"]),E.timeExpireDateString=new Date(1e3*E.timeExpireDate).toISOString()),E.timestampString=new Date(1e3*E.timestamp).toISOString(),E.complete=!!T,E.paymentRequest=E.complete?n.encode(D,N,Number.MAX_SAFE_INTEGER):"",E.prefix=D,E.wordsTemp=n.encode("temp",N,Number.MAX_SAFE_INTEGER),F(E)},decode:function(t,e){let i,r,s,l,d,f,g,m,y,I;if("string"!=typeof t)throw Error("Lightning Payment Request must be string");if("ln"!==t.slice(0,2).toLowerCase())throw Error("Not a proper lightning payment request");let A=n.decode(t,Number.MAX_SAFE_INTEGER);t=t.toLowerCase();let R=A.prefix,P=A.words,x=P.slice(-104),O=P.slice(0,-104);P=P.slice(0,-104);let L=B(x,!0),N=L.slice(-1)[0];if(L=L.slice(0,-1),!(N in[0,1,2,3])||64!==L.length)throw Error("Signature is missing or incorrect");let M=R.match(/^ln(\S+?)(\d*)([a-zA-Z]?)$/);if(M&&!M[2]&&(M=R.match(/^ln(\S+)$/)),!M)throw Error("Not a proper lightning payment request");let U=M[1];if(e){if(void 0===e.bech32||void 0===e.pubKeyHash||void 0===e.scriptHash||!Array.isArray(e.validWitnessVersions)||void 0===e.wif)throw Error("Invalid network");i=e}else switch(U){case u.bech32:i=u;break;case c.bech32:i=c;break;case h.bech32:i=h;break;case p.bech32:i=p}if(!i||i.bech32!==U)throw Error("Unknown coin bech32 prefix");let q=M[2];if(q){let t=M[3];try{r=parseInt(D(q+t,!0))}catch(t){r=null,l=!0}s=k(q+t,!0)}else r=null,s=null;let W=E(P.slice(0,7)),j=new Date(1e3*W).toISOString();P=P.slice(7);let H=[];for(;P.length>0;){let t=P[0].toString();d=w[t]||S,f=T[t]||function(t){return e=>({tagCode:parseInt(t),words:n.encode("unknown",e,Number.MAX_SAFE_INTEGER)})}(t),g=E((P=P.slice(1)).slice(0,2)),m=(P=P.slice(2)).slice(0,g),P=P.slice(g),H.push({tagName:d,data:f(m,i)})}_(H,w["6"])&&(I=new Date(1e3*(y=W+C(H,w["6"]))).toISOString());let V=v(a.concat([a.from(R,"utf8"),a.from(b(O,5,8))])),z=o.Signature.fromCompact(L).addRecoveryBit(N),X=a.from(z.recoverPublicKey(V).toRawBytes(!0));if(_(H,w["19"])&&C(H,w["19"])!==X.toString("hex"))throw Error("Lightning Payment Request signature pubkey does not match payee pubkey");let K={paymentRequest:t,complete:!0,prefix:R,wordsTemp:n.encode("temp",O.concat(x),Number.MAX_SAFE_INTEGER),network:i,satoshis:r,millisatoshis:s,timestamp:W,timestampString:j,payeeNodeKey:X.toString("hex"),signature:L.toString("hex"),recoveryFlag:N,tags:H};return l&&delete K.satoshis,y&&(K=Object.assign(K,{timeExpireDate:y,timeExpireDateString:I})),F(K,!0)},sign:function(t,e){let i,r,s=l(t),u=A(e);if(s.complete&&s.paymentRequest)return s;if(void 0===u||32!==u.length||!o.utils.isValidPrivateKey(u))throw Error("privateKey must be a 32 byte Buffer and valid private key");if(_(s.tags,w["19"])&&(r=A(C(s.tags,w["19"]))),s.payeeNodeKey&&(i=A(s.payeeNodeKey)),i&&r&&!r.equals(i))throw Error("payee node key tag and payeeNodeKey attribute must match");i=r||i;let c=a.from(o.getPublicKey(u,!0));if(i&&!c.equals(i))throw Error("The private key given is not the private key of the node public key given");let h=n.decode(s.wordsTemp,Number.MAX_SAFE_INTEGER).words,p=v(a.concat([a.from(s.prefix,"utf8"),B(h)])),d=o.sign(p,u,{lowS:!0});s.signature=a.from(d.toCompactRawBytes()).toString("hex");let f=R(s.signature+"0"+d.recovery);return s.payeeNodeKey=c.toString("hex"),s.recoveryFlag=d.recovery,s.wordsTemp=n.encode("temp",h.concat(f),Number.MAX_SAFE_INTEGER),s.complete=!0,s.paymentRequest=n.encode(s.prefix,h.concat(f),Number.MAX_SAFE_INTEGER),F(s)},satToHrp:P,millisatToHrp:x,hrpToSat:D,hrpToMillisat:k}},309959,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.IEscrowSwap=i.isIEscrowSwapInit=void 0;let r=t.r(958078),n=t.r(991989),a=t.r(559766),s=t.r(843943),o=t.r(768270);function l(t){return"object"==typeof t&&null!=t.feeRate&&(null==t.signatureData||"object"==typeof t.signatureData&&"string"==typeof t.signatureData.prefix&&"string"==typeof t.signatureData.timeout&&"string"==typeof t.signatureData.signature)&&(null==t.data||"object"==typeof t.data)&&(0,r.isISwapInit)(t)}i.isIEscrowSwapInit=l;class u extends r.ISwap{getIdentifierHash(){let t=s.Buffer.from(this.getClaimHash(),"hex");return null==this.randomNonce?t:s.Buffer.concat([t,s.Buffer.from(this.randomNonce,"hex")])}getIdentifierHashString(){let t=this.getIdentifierHash();return null==t?null:t.toString("hex")}_getEscrowHash(){var t;return null==(t=this.data)?void 0:t.getEscrowHash()}getEscrowHash(){return this._getEscrowHash()}getClaimHash(){var t;return null==(t=this.data)?void 0:t.getClaimHash()}getId(){return this.getIdentifierHashString()}async watchdogWaitTillSignatureExpiry(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5,i=!1;for(;!i;){await (0,a.timeoutPromise)(1e3*e,t);try{i=await this.wrapper.contract.isInitAuthorizationExpired(this.data,this.signatureData)}catch(t){this.logger.error("watchdogWaitTillSignatureExpiry(): Error when checking signature expiry: ",t)}}null!=t&&t.throwIfAborted()}async watchdogWaitTillCommited(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5,i={type:n.SwapCommitStateType.NOT_COMMITED};for(;(null==i?void 0:i.type)===n.SwapCommitStateType.NOT_COMMITED;){await (0,a.timeoutPromise)(1e3*e,t);try{if((null==(i=await this.wrapper.contract.getCommitStatus(this._getInitiator(),this.data))?void 0:i.type)===n.SwapCommitStateType.NOT_COMMITED&&await this.wrapper.contract.isInitAuthorizationExpired(this.data,this.signatureData))return!1}catch(t){this.logger.error("watchdogWaitTillCommited(): Error when fetching commit status or signature expiry: ",t)}}return null!=t&&t.throwIfAborted(),!0}async watchdogWaitTillResult(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5,i={type:n.SwapCommitStateType.COMMITED};for(;(null==i?void 0:i.type)===n.SwapCommitStateType.COMMITED||(null==i?void 0:i.type)===n.SwapCommitStateType.REFUNDABLE;){await (0,a.timeoutPromise)(1e3*e,t);try{i=await this.wrapper.contract.getCommitStatus(this._getInitiator(),this.data)}catch(t){this.logger.error("watchdogWaitTillResult(): Error when fetching commit status: ",t)}}return null!=t&&t.throwIfAborted(),i}async verifyQuoteDefinitelyExpired(){return(0,a.tryWithRetries)(()=>this.wrapper.contract.isInitAuthorizationExpired(this.data,this.signatureData))}async verifyQuoteValid(){try{return await (0,a.tryWithRetries)(()=>this.wrapper.contract.isValidInitAuthorization(this._getInitiator(),this.data,this.signatureData,this.feeRate),null,n.SignatureVerificationError),!0}catch(t){if(t instanceof n.SignatureVerificationError)return!1}}getCommitFee(){return this.wrapper.contract.getCommitFee(this.data,this.feeRate)}async getSmartChainNetworkFee(){let t=this.wrapper.contract;return(0,o.toTokenAmount)(await (null!=t.getRawCommitFee?t.getRawCommitFee(this.data,this.feeRate):t.getCommitFee(this.data,this.feeRate)),this.wrapper.getNativeToken(),this.wrapper.prices)}serialize(){var t,e,i;return{...super.serialize(),data:null!=this.data?this.data.serialize():null,prefix:null==(t=this.signatureData)?void 0:t.prefix,timeout:null==(e=this.signatureData)?void 0:e.timeout,signature:null==(i=this.signatureData)?void 0:i.signature,feeRate:null==this.feeRate?null:this.feeRate.toString(),commitTxId:this.commitTxId,claimTxId:this.claimTxId,refundTxId:this.refundTxId}}constructor(t,e){super(t,e),l(e)||(this.data=null!=e.data?new t.swapDataDeserializer(e.data):null,this.signatureData=null==e.signature?null:{prefix:e.prefix,timeout:e.timeout,signature:e.signature},this.feeRate=e.feeRate,this.commitTxId=e.commitTxId,this.claimTxId=e.claimTxId,this.refundTxId=e.refundTxId)}}i.IEscrowSwap=u},44237,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.FeeType=void 0,function(t){t[t.SWAP=0]="SWAP",t[t.NETWORK_OUTPUT=1]="NETWORK_OUTPUT"}(i.FeeType||(i.FeeType={}))},404023,(t,e,i)=>{"use strict";var r;Object.defineProperty(i,"__esModule",{value:!0}),i.ToBTCSwapState=i.IToBTCSwap=i.isIToBTCSwapInit=void 0;let n=t.r(991989),a=t.r(366913),s=t.r(145617),o=t.r(559766),l=t.r(768270),u=t.r(309959),c=t.r(44237),h=t.r(958078);function p(t){return"bigint"==typeof t.networkFee&&(null==t.networkFeeBtc||"bigint"==typeof t.networkFeeBtc)&&(0,u.isIEscrowSwapInit)(t)}i.isIToBTCSwapInit=p;class d extends u.IEscrowSwap{upgradeVersion(){if(null==this.version){switch(this.state){case -2:this.state=r.REFUNDED;break;case -1:this.state=r.QUOTE_EXPIRED;break;case 0:this.state=r.CREATED;break;case 1:this.state=r.COMMITED;break;case 2:this.state=r.CLAIMED;break;case 3:this.state=r.REFUNDABLE}this.version=1}}tryRecomputeSwapPrice(){null==this.swapFeeBtc&&(this.swapFeeBtc=this.swapFee*this.getOutput().rawAmount/this.getInputWithoutFee().rawAmount),null==this.networkFeeBtc&&(this.networkFeeBtc=this.networkFee*this.getOutput().rawAmount/this.getInputWithoutFee().rawAmount),super.tryRecomputeSwapPrice()}getLpIdentifier(){return this.getClaimHash()}getInputTxId(){return this.commitTxId}requiresAction(){return this.isRefundable()}isFinished(){return this.state===r.CLAIMED||this.state===r.REFUNDED||this.state===r.QUOTE_EXPIRED}isRefundable(){return this.state===r.REFUNDABLE}isQuoteExpired(){return this.state===r.QUOTE_EXPIRED}isQuoteSoftExpired(){return this.state===r.QUOTE_EXPIRED||this.state===r.QUOTE_SOFT_EXPIRED}isSuccessful(){return this.state===r.CLAIMED}isFailed(){return this.state===r.REFUNDED}_getInitiator(){return this.data.getOfferer()}getSwapFee(){let t=1000000n*(this.swapFeeBtc-this.pricingInfo.satsBaseFee)/this.getOutput().rawAmount;return{amountInSrcToken:(0,l.toTokenAmount)(this.swapFee,this.wrapper.tokens[this.data.getToken()],this.wrapper.prices),amountInDstToken:(0,l.toTokenAmount)(this.swapFeeBtc,this.outputToken,this.wrapper.prices),usdValue:(t,e)=>this.wrapper.prices.getBtcUsdValue(this.swapFeeBtc,t,e),composition:{base:(0,l.toTokenAmount)(this.pricingInfo.satsBaseFee,this.outputToken,this.wrapper.prices),percentage:(0,h.ppmToPercentage)(t)}}}getNetworkFee(){return{amountInSrcToken:(0,l.toTokenAmount)(this.networkFee,this.wrapper.tokens[this.data.getToken()],this.wrapper.prices),amountInDstToken:(0,l.toTokenAmount)(this.networkFeeBtc,this.outputToken,this.wrapper.prices),usdValue:(t,e)=>this.wrapper.prices.getBtcUsdValue(this.networkFeeBtc,t,e)}}getFee(){return{amountInSrcToken:(0,l.toTokenAmount)(this.swapFee+this.networkFee,this.wrapper.tokens[this.data.getToken()],this.wrapper.prices),amountInDstToken:(0,l.toTokenAmount)(this.swapFeeBtc+this.networkFeeBtc,this.outputToken,this.wrapper.prices),usdValue:(t,e)=>this.wrapper.prices.getBtcUsdValue(this.swapFeeBtc+this.networkFeeBtc,t,e)}}getFeeBreakdown(){return[{type:c.FeeType.SWAP,fee:this.getSwapFee()},{type:c.FeeType.NETWORK_OUTPUT,fee:this.getNetworkFee()}]}getInput(){return(0,l.toTokenAmount)(this.data.getAmount(),this.wrapper.tokens[this.data.getToken()],this.wrapper.prices)}getInputWithoutFee(){return(0,l.toTokenAmount)(this.data.getAmount()-(this.swapFee+this.networkFee),this.wrapper.tokens[this.data.getToken()],this.wrapper.prices)}async hasEnoughBalance(){let[t,e]=await Promise.all([this.wrapper.contract.getBalance(this._getInitiator(),this.data.getToken(),!1),this.data.getToken()===this.wrapper.chain.getNativeCurrencyAddress()?this.getCommitFee():Promise.resolve(null)]),i=this.data.getAmount();return null!=e&&(i+=e),{enoughBalance:t>=i,balance:(0,l.toTokenAmount)(t,this.wrapper.tokens[this.data.getToken()],this.wrapper.prices),required:(0,l.toTokenAmount)(i,this.wrapper.tokens[this.data.getToken()],this.wrapper.prices)}}async hasEnoughForTxFees(){let[t,e]=await Promise.all([this.wrapper.contract.getBalance(this._getInitiator(),this.wrapper.chain.getNativeCurrencyAddress(),!1),this.getCommitFee()]);return{enoughBalance:t>=e,balance:(0,l.toTokenAmount)(t,this.wrapper.getNativeToken(),this.wrapper.prices),required:(0,l.toTokenAmount)(e,this.wrapper.getNativeToken(),this.wrapper.prices)}}async txsCommit(t){if(this.state!==r.CREATED)throw Error("Must be in CREATED state!");return this.initiated||(this.initiated=!0,await this._saveAndEmit()),await this.wrapper.contract.txsInit(this._getInitiator(),this.data,this.signatureData,t,this.feeRate).catch(t=>Promise.reject(t instanceof n.SignatureVerificationError?Error("Request timed out"):t))}async commit(t,e,i){this.checkSigner(t);let n=await this.wrapper.chain.sendAndConfirm(t,await this.txsCommit(i),!0,e);return this.commitTxId=n[n.length-1],(this.state===r.CREATED||this.state===r.QUOTE_SOFT_EXPIRED||this.state===r.QUOTE_EXPIRED)&&await this._saveAndEmit(r.COMMITED),this.commitTxId}async waitTillCommited(t){if(this.state===r.COMMITED||this.state===r.CLAIMED)return Promise.resolve();if(this.state!==r.CREATED&&this.state!==r.QUOTE_SOFT_EXPIRED)throw Error("Invalid state (not CREATED)");let e=(0,o.extendAbortController)(t),i=await Promise.race([this.watchdogWaitTillCommited(e.signal),this.waitTillState(r.COMMITED,"gte",e.signal).then(()=>0)]);if(e.abort(),0===i&&this.logger.debug("waitTillCommited(): Resolved from state change"),!0===i&&this.logger.debug("waitTillCommited(): Resolved from watchdog - commited"),!1===i){if(this.logger.debug("waitTillCommited(): Resolved from watchdog - signature expiry"),this.state===r.QUOTE_SOFT_EXPIRED||this.state===r.CREATED)throw await this._saveAndEmit(r.QUOTE_EXPIRED),Error("Quote expired while waiting for transaction confirmation!");return}(this.state===r.QUOTE_SOFT_EXPIRED||this.state===r.CREATED||this.state===r.QUOTE_EXPIRED)&&await this._saveAndEmit(r.COMMITED)}async waitTillIntermediarySwapProcessed(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5,i={code:a.RefundAuthorizationResponseCodes.PENDING,msg:""};for(;!t.aborted&&(i.code===a.RefundAuthorizationResponseCodes.PENDING||i.code===a.RefundAuthorizationResponseCodes.NOT_FOUND);)(i=await a.IntermediaryAPI.getRefundAuthorization(this.url,this.getLpIdentifier(),this.data.getSequence())).code===a.RefundAuthorizationResponseCodes.PAID&&(await this._setPaymentResult(i.data,!0)?(this.state===r.COMMITED||this.state===r.REFUNDABLE)&&await this._saveAndEmit(r.SOFT_CLAIMED):i={code:a.RefundAuthorizationResponseCodes.PENDING,msg:""}),(i.code===a.RefundAuthorizationResponseCodes.PENDING||i.code===a.RefundAuthorizationResponseCodes.NOT_FOUND)&&await (0,o.timeoutPromise)(1e3*e,t);return i}async checkIntermediarySwapProcessed(){let t=!(arguments.length>0)||void 0===arguments[0]||arguments[0];if(this.state===r.CREATED||this.state==r.QUOTE_EXPIRED)return!1;if(this.isFinished()||this.isRefundable())return!0;let e=await a.IntermediaryAPI.getRefundAuthorization(this.url,this.getLpIdentifier(),this.data.getSequence());switch(e.code){case a.RefundAuthorizationResponseCodes.PAID:let i=await this._setPaymentResult(e.data,!0);return i&&(this.state=r.SOFT_CLAIMED,t&&await this._saveAndEmit()),i;case a.RefundAuthorizationResponseCodes.REFUND_DATA:return await (0,o.tryWithRetries)(()=>this.wrapper.contract.isValidRefundAuthorization(this.data,e.data),null,n.SignatureVerificationError),this.state=r.REFUNDABLE,t&&await this._saveAndEmit(),!0;default:return!1}}async waitForPayment(t,e){if(this.state===r.CLAIMED)return Promise.resolve(!0);if(this.state!==r.COMMITED&&this.state!==r.SOFT_CLAIMED)throw Error("Invalid state (not COMMITED)");let i=(0,o.extendAbortController)(t),l=await Promise.race([this.waitTillState(r.CLAIMED,"gte",i.signal),this.waitTillIntermediarySwapProcessed(i.signal,e)]);if(i.abort(),"object"!=typeof l){if(this.state===r.REFUNDABLE)throw Error("Swap expired");return this.logger.debug("waitTillRefunded(): Resolved from state change"),!0}switch(this.logger.debug("waitTillRefunded(): Resolved from intermediary response"),l.code){case a.RefundAuthorizationResponseCodes.PAID:return!0;case a.RefundAuthorizationResponseCodes.REFUND_DATA:return await (0,o.tryWithRetries)(()=>this.wrapper.contract.isValidRefundAuthorization(this.data,l.data),null,n.SignatureVerificationError,t),await this._saveAndEmit(r.REFUNDABLE),!1;case a.RefundAuthorizationResponseCodes.EXPIRED:if(await this.wrapper.contract.isExpired(this._getInitiator(),this.data))throw Error("Swap expired");throw new s.IntermediaryError("Swap expired");case a.RefundAuthorizationResponseCodes.NOT_FOUND:if(this.state===r.CLAIMED)return!0;throw Error("Intermediary swap not found")}}getRefundFee(){return this.wrapper.contract.getRefundFee(this.data)}async txsRefund(t){if(!this.isRefundable())throw Error("Must be in REFUNDABLE state or expired!");if(null!=t||(t=this._getInitiator()),await this.wrapper.contract.isExpired(this._getInitiator(),this.data))return await this.wrapper.contract.txsRefund(t,this.data,!0,!0);{let e=await a.IntermediaryAPI.getRefundAuthorization(this.url,this.getLpIdentifier(),this.data.getSequence());if(e.code===a.RefundAuthorizationResponseCodes.REFUND_DATA)return await this.wrapper.contract.txsRefundWithAuthorization(t,this.data,e.data,!0,!0);throw new s.IntermediaryError("Invalid intermediary cooperative message returned")}}async refund(t,e){let i=await this.wrapper.chain.sendAndConfirm(t,await this.txsRefund(t.getAddress()),!0,e);return this.refundTxId=i[0],(this.state===r.COMMITED||this.state===r.REFUNDABLE||this.state===r.SOFT_CLAIMED)&&await this._saveAndEmit(r.REFUNDED),i[0]}async waitTillRefunded(t){if(this.state===r.REFUNDED)return Promise.resolve();if(this.state!==r.COMMITED&&this.state!==r.SOFT_CLAIMED)throw Error("Invalid state (not COMMITED)");let e=new AbortController;null!=t&&t.addEventListener("abort",()=>e.abort(t.reason));let i=await Promise.race([this.watchdogWaitTillResult(e.signal),this.waitTillState(r.REFUNDED,"eq",e.signal).then(()=>0),this.waitTillState(r.CLAIMED,"eq",e.signal).then(()=>1)]);if(e.abort(),0===i)return void this.logger.debug("waitTillRefunded(): Resolved from state change (REFUNDED)");if(1===i)throw this.logger.debug("waitTillRefunded(): Resolved from state change (CLAIMED)"),Error("Tried to refund swap, but claimer claimed it in the meantime!");if(this.logger.debug("waitTillRefunded(): Resolved from watchdog"),(null==i?void 0:i.type)===n.SwapCommitStateType.PAID)throw null==this.claimTxId&&(this.claimTxId=await i.getClaimTxId()),await this._saveAndEmit(r.CLAIMED),Error("Tried to refund swap, but claimer claimed it in the meantime!");(null==i?void 0:i.type)===n.SwapCommitStateType.NOT_COMMITED&&(null==this.refundTxId&&null!=i.getRefundTxId&&(this.refundTxId=await i.getRefundTxId()),await this._saveAndEmit(r.REFUNDED))}serialize(){return{...super.serialize(),networkFee:null==this.networkFee?null:this.networkFee.toString(10),networkFeeBtc:null==this.networkFeeBtc?null:this.networkFeeBtc.toString(10)}}async syncStateFromChain(){if(this.state===r.CREATED||this.state===r.QUOTE_SOFT_EXPIRED||this.state===r.COMMITED||this.state===r.SOFT_CLAIMED||this.state===r.REFUNDABLE){let t=!1;(this.state===r.CREATED||this.state===r.QUOTE_SOFT_EXPIRED)&&(t=await this.verifyQuoteDefinitelyExpired());let e=await (0,o.tryWithRetries)(()=>this.wrapper.contract.getCommitStatus(this._getInitiator(),this.data));switch(null==e?void 0:e.type){case n.SwapCommitStateType.PAID:return null==this.claimTxId&&(this.claimTxId=await e.getClaimTxId()),this.state=r.CLAIMED,!0;case n.SwapCommitStateType.REFUNDABLE:return this.state=r.REFUNDABLE,!0;case n.SwapCommitStateType.EXPIRED:return null==this.refundTxId&&e.getRefundTxId&&(this.refundTxId=await e.getRefundTxId()),this.state=r.QUOTE_EXPIRED,!0;case n.SwapCommitStateType.NOT_COMMITED:if(null==this.refundTxId&&e.getRefundTxId&&(this.refundTxId=await e.getRefundTxId()),this.state===r.COMMITED||this.state===r.REFUNDABLE)return this.state=r.REFUNDED,!0;break;case n.SwapCommitStateType.COMMITED:if(this.state!==r.COMMITED&&this.state!==r.REFUNDABLE)return this.state=r.COMMITED,!0}if((this.state===r.CREATED||this.state===r.QUOTE_SOFT_EXPIRED)&&t)return this.state=r.QUOTE_EXPIRED,!0}}async _sync(t){let e=await this.syncStateFromChain();return(this.state===r.COMMITED||this.state===r.SOFT_CLAIMED)&&await this.checkIntermediarySwapProcessed(!1)&&(e=!0),t&&e&&await this._saveAndEmit(),e}async _tick(t){switch(this.state){case r.CREATED:if(this.expiry<Date.now())return this.state=r.QUOTE_SOFT_EXPIRED,t&&await this._saveAndEmit(),!0;break;case r.COMMITED:case r.SOFT_CLAIMED:if(await this.wrapper.contract.isExpired(this._getInitiator(),this.data))return this.state=r.REFUNDABLE,t&&await this._saveAndEmit(),!0}return!1}constructor(t,e){super(t,e),p(e)?this.state=r.CREATED:(this.networkFee=null==e.networkFee?null:BigInt(e.networkFee),this.networkFeeBtc=null==e.networkFeeBtc?null:BigInt(e.networkFeeBtc))}}i.IToBTCSwap=d,function(t){t[t.REFUNDED=-3]="REFUNDED",t[t.QUOTE_EXPIRED=-2]="QUOTE_EXPIRED",t[t.QUOTE_SOFT_EXPIRED=-1]="QUOTE_SOFT_EXPIRED",t[t.CREATED=0]="CREATED",t[t.COMMITED=1]="COMMITED",t[t.SOFT_CLAIMED=2]="SOFT_CLAIMED",t[t.CLAIMED=3]="CLAIMED",t[t.REFUNDABLE=4]="REFUNDABLE"}(r=i.ToBTCSwapState||(i.ToBTCSwapState={}))},772917,(t,e,i)=>{"use strict";function r(t){return t instanceof Uint8Array||ArrayBuffer.isView(t)&&"Uint8Array"===t.constructor.name}function n(t){if("boolean"!=typeof t)throw Error("boolean expected, not ".concat(t))}function a(t){if(!Number.isSafeInteger(t)||t<0)throw Error("positive integer expected, got "+t)}function s(t){for(var e=arguments.length,i=Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];if(!r(t))throw Error("Uint8Array expected");if(i.length>0&&!i.includes(t.length))throw Error("Uint8Array expected of length "+i+", got length="+t.length)}function o(t){return new DataView(t.buffer,t.byteOffset,t.byteLength)}Object.defineProperty(i,"__esModule",{value:!0}),i.wrapCipher=i.Hash=i.nextTick=i.isLE=void 0,i.isBytes=r,i.abool=n,i.anumber=a,i.abytes=s,i.ahash=function(t){if("function"!=typeof t||"function"!=typeof t.create)throw Error("Hash should be wrapped by utils.createHasher");a(t.outputLen),a(t.blockLen)},i.aexists=function(t){let e=!(arguments.length>1)||void 0===arguments[1]||arguments[1];if(t.destroyed)throw Error("Hash instance has been destroyed");if(e&&t.finished)throw Error("Hash#digest() has already been called")},i.aoutput=function(t,e){s(t);let i=e.outputLen;if(t.length<i)throw Error("digestInto() expects output buffer of length at least "+i)},i.u8=function(t){return new Uint8Array(t.buffer,t.byteOffset,t.byteLength)},i.u32=function(t){return new Uint32Array(t.buffer,t.byteOffset,Math.floor(t.byteLength/4))},i.clean=function(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];for(let t=0;t<e.length;t++)e[t].fill(0)},i.createView=o,i.bytesToHex=c,i.hexToBytes=d,i.hexToNumber=f,i.bytesToNumberBE=function(t){return f(c(t))},i.numberToBytesBE=function(t,e){return d(t.toString(16).padStart(2*e,"0"))},i.utf8ToBytes=g,i.bytesToUtf8=function(t){return new TextDecoder().decode(t)},i.toBytes=function(t){if("string"==typeof t)t=g(t);else if(r(t))t=T(t);else throw Error("Uint8Array expected, got "+typeof t);return t},i.overlapBytes=m,i.complexOverlapBytes=function(t,e){if(m(t,e)&&t.byteOffset<e.byteOffset)throw Error("complex overlap of input and output is not supported")},i.concatBytes=function(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];let r=0;for(let t=0;t<e.length;t++){let i=e[t];s(i),r+=i.length}let n=new Uint8Array(r);for(let t=0,i=0;t<e.length;t++){let r=e[t];n.set(r,i),i+=r.length}return n},i.checkOpts=function(t,e){if(null==e||"object"!=typeof e)throw Error("options must be defined");return Object.assign(t,e)},i.equalBytes=function(t,e){if(t.length!==e.length)return!1;let i=0;for(let r=0;r<t.length;r++)i|=t[r]^e[r];return 0===i},i.getOutput=function(t,e){let i=!(arguments.length>2)||void 0===arguments[2]||arguments[2];if(void 0===e)return new Uint8Array(t);if(e.length!==t)throw Error("invalid output length, expected "+t+", got: "+e.length);if(i&&!y(e))throw Error("invalid output, must be aligned");return e},i.setBigUint64=w,i.u64Lengths=function(t,e,i){n(i);let r=new Uint8Array(16),a=o(r);return w(a,0,BigInt(e),i),w(a,8,BigInt(t),i),r},i.isAligned32=y,i.copyBytes=T,i.isLE=68===new Uint8Array(new Uint32Array([0x11223344]).buffer)[0];let l="function"==typeof Uint8Array.from([]).toHex&&"function"==typeof Uint8Array.fromHex,u=Array.from({length:256},(t,e)=>e.toString(16).padStart(2,"0"));function c(t){if(s(t),l)return t.toHex();let e="";for(let i=0;i<t.length;i++)e+=u[t[i]];return e}let h={_0:48,_9:57,A:65,F:70,a:97,f:102};function p(t){return t>=h._0&&t<=h._9?t-h._0:t>=h.A&&t<=h.F?t-(h.A-10):t>=h.a&&t<=h.f?t-(h.a-10):void 0}function d(t){if("string"!=typeof t)throw Error("hex string expected, got "+typeof t);if(l)return Uint8Array.fromHex(t);let e=t.length,i=e/2;if(e%2)throw Error("hex string expected, got unpadded hex of length "+e);let r=new Uint8Array(i);for(let e=0,n=0;e<i;e++,n+=2){let i=p(t.charCodeAt(n)),a=p(t.charCodeAt(n+1));if(void 0===i||void 0===a)throw Error('hex string expected, got non-hex character "'+(t[n]+t[n+1])+'" at index '+n);r[e]=16*i+a}return r}function f(t){if("string"!=typeof t)throw Error("hex string expected, got "+typeof t);return BigInt(""===t?"0":"0x"+t)}function g(t){if("string"!=typeof t)throw Error("string expected");return new Uint8Array(new TextEncoder().encode(t))}function m(t,e){return t.buffer===e.buffer&&t.byteOffset<e.byteOffset+e.byteLength&&e.byteOffset<t.byteOffset+t.byteLength}function w(t,e,i,r){if("function"==typeof t.setBigUint64)return t.setBigUint64(e,i,r);let n=BigInt(32),a=BigInt(0xffffffff),s=Number(i>>n&a),o=Number(i&a),l=4*!!r,u=4*!r;t.setUint32(e+l,s,r),t.setUint32(e+u,o,r)}function y(t){return t.byteOffset%4==0}function T(t){return Uint8Array.from(t)}i.nextTick=async()=>{},i.Hash=class{},i.wrapCipher=(t,e)=>{function r(r){for(var n=arguments.length,a=Array(n>1?n-1:0),o=1;o<n;o++)a[o-1]=arguments[o];if(s(r),!i.isLE)throw Error("Non little-endian hardware is not yet supported");if(void 0!==t.nonceLength){let e=a[0];if(!e)throw Error("nonce / iv required");t.varSizeNonce?s(e):s(e,t.nonceLength)}let l=t.tagLength;l&&void 0!==a[1]&&s(a[1]);let u=e(r,...a),c=(t,e)=>{if(void 0!==e){if(2!==t)throw Error("cipher output not supported");s(e)}},h=!1;return{encrypt(t,e){if(h)throw Error("cannot encrypt() twice with same key + nonce");return h=!0,s(t),c(u.encrypt.length,e),u.encrypt(t,e)},decrypt(t,e){if(s(t),l&&t.length<l)throw Error("invalid ciphertext length: smaller than tagLength="+l);return c(u.decrypt.length,e),u.decrypt(t,e)}}}return Object.assign(r,t),r}},828160,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.polyval=i.ghash=void 0,i._toGHASHKey=l;let r=t.r(772917),n=new Uint8Array(16),a=(0,r.u32)(n),s=(t,e,i,r)=>({s3:i<<31|r>>>1,s2:e<<31|i>>>1,s1:t<<31|e>>>1,s0:t>>>1^-0x1f000000&-(1&r&1)}),o=t=>(t>>>0&255)<<24|(t>>>8&255)<<16|(t>>>16&255)<<8|t>>>24&255;function l(t){t.reverse();let e=1&t[15],i=0;for(let e=0;e<t.length;e++){let r=t[e];t[e]=r>>>1|i,i=(1&r)<<7}return t[0]^=225&-e,t}class u{_updateBlock(t,e,i,r){t^=this.s0,e^=this.s1,i^=this.s2,r^=this.s3;let{W:n,t:a,windowSize:s}=this,o=0,l=0,u=0,c=0,h=(1<<n)-1,p=0;for(let d of[t,e,i,r])for(let t=0;t<4;t++){let e=d>>>8*t&255;for(let t=8/n-1;t>=0;t--){let{s0:i,s1:r,s2:d,s3:f}=a[p*s+(e>>>n*t&h)];o^=i,l^=r,u^=d,c^=f,p+=1}}this.s0=o,this.s1=l,this.s2=u,this.s3=c}update(t){(0,r.aexists)(this),t=(0,r.toBytes)(t),(0,r.abytes)(t);let e=(0,r.u32)(t),i=Math.floor(t.length/16),s=t.length%16;for(let t=0;t<i;t++)this._updateBlock(e[4*t+0],e[4*t+1],e[4*t+2],e[4*t+3]);return s&&(n.set(t.subarray(16*i)),this._updateBlock(a[0],a[1],a[2],a[3]),(0,r.clean)(a)),this}destroy(){let{t}=this;for(let e of t)e.s0=0,e.s1=0,e.s2=0,e.s3=0}digestInto(t){(0,r.aexists)(this),(0,r.aoutput)(t,this),this.finished=!0;let{s0:e,s1:i,s2:n,s3:a}=this,s=(0,r.u32)(t);return s[0]=e,s[1]=i,s[2]=n,s[3]=a,t}digest(){let t=new Uint8Array(16);return this.digestInto(t),this.destroy(),t}constructor(t,e){this.blockLen=16,this.outputLen=16,this.s0=0,this.s1=0,this.s2=0,this.s3=0,this.finished=!1,t=(0,r.toBytes)(t),(0,r.abytes)(t,16);let i=(0,r.createView)(t),n=i.getUint32(0,!1),a=i.getUint32(4,!1),l=i.getUint32(8,!1),u=i.getUint32(12,!1),c=[];for(let t=0;t<128;t++)c.push({s0:o(n),s1:o(a),s2:o(l),s3:o(u)}),{s0:n,s1:a,s2:l,s3:u}=s(n,a,l,u);let h=(t=>t>65536?8:t>1024?4:2)(e||1024);if(![1,2,4,8].includes(h))throw Error("ghash: invalid window size, expected 2, 4 or 8");this.W=h;let p=128/h,d=this.windowSize=2**h,f=[];for(let t=0;t<p;t++)for(let e=0;e<d;e++){let i=0,r=0,n=0,a=0;for(let s=0;s<h;s++){if(!(e>>>h-s-1&1))continue;let{s0:o,s1:l,s2:u,s3:p}=c[h*t+s];i^=o,r^=l,n^=u,a^=p}f.push({s0:i,s1:r,s2:n,s3:a})}this.t=f}}class c extends u{update(t){t=(0,r.toBytes)(t),(0,r.aexists)(this);let e=(0,r.u32)(t),i=t.length%16,s=Math.floor(t.length/16);for(let t=0;t<s;t++)this._updateBlock(o(e[4*t+3]),o(e[4*t+2]),o(e[4*t+1]),o(e[4*t+0]));return i&&(n.set(t.subarray(16*s)),this._updateBlock(o(a[3]),o(a[2]),o(a[1]),o(a[0])),(0,r.clean)(a)),this}digestInto(t){(0,r.aexists)(this),(0,r.aoutput)(t,this),this.finished=!0;let{s0:e,s1:i,s2:n,s3:a}=this,s=(0,r.u32)(t);return s[0]=e,s[1]=i,s[2]=n,s[3]=a,t.reverse()}constructor(t,e){t=(0,r.toBytes)(t),(0,r.abytes)(t);let i=l((0,r.copyBytes)(t));super(i,e),(0,r.clean)(i)}}function h(t){let e=(e,i)=>t(i,e.length).update((0,r.toBytes)(e)).digest(),i=t(new Uint8Array(16),0);return e.outputLen=i.outputLen,e.blockLen=i.blockLen,e.create=(e,i)=>t(e,i),e}i.ghash=h((t,e)=>new u(t,e)),i.polyval=h((t,e)=>new c(t,e))},922507,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.unsafe=i.aeskwp=i.aeskw=i.siv=i.gcmsiv=i.gcm=i.cfb=i.cbc=i.ecb=i.ctr=void 0;let r=t.r(828160),n=t.r(772917),a=new Uint8Array(16);function s(t){return t<<1^283&-(t>>7)}function o(t,e){let i=0;for(;e>0;e>>=1)i^=t&-(1&e),t=s(t);return i}let l=(()=>{let t=new Uint8Array(256);for(let e=0,i=1;e<256;e++,i^=s(i))t[e]=i;let e=new Uint8Array(256);e[0]=99;for(let i=0;i<255;i++){let r=t[255-i];r|=r<<8,e[t[i]]=(r^r>>4^r>>5^r>>6^r>>7^99)&255}return(0,n.clean)(t),e})(),u=l.map((t,e)=>l.indexOf(e)),c=t=>t<<24|t>>>8,h=t=>t<<8|t>>>24,p=t=>t<<24&0xff000000|t<<8&0xff0000|t>>>8&65280|t>>>24&255;function d(t,e){if(256!==t.length)throw Error("Wrong sbox length");let i=new Uint32Array(256).map((i,r)=>e(t[r])),r=i.map(h),n=r.map(h),a=n.map(h),s=new Uint32Array(65536),o=new Uint32Array(65536),l=new Uint16Array(65536);for(let e=0;e<256;e++)for(let u=0;u<256;u++){let c=256*e+u;s[c]=i[e]^r[u],o[c]=n[e]^a[u],l[c]=t[e]<<8|t[u]}return{sbox:t,sbox2:l,T0:i,T1:r,T2:n,T3:a,T01:s,T23:o}}let f=d(l,t=>o(t,3)<<24|t<<16|t<<8|o(t,2)),g=d(u,t=>o(t,11)<<24|o(t,13)<<16|o(t,9)<<8|o(t,14)),m=(()=>{let t=new Uint8Array(16);for(let e=0,i=1;e<16;e++,i=s(i))t[e]=i;return t})();function w(t){(0,n.abytes)(t);let e=t.length;if(![16,24,32].includes(e))throw Error("aes: invalid key size, should be 16, 24 or 32, got "+e);let{sbox2:i}=f,r=[];(0,n.isAligned32)(t)||r.push(t=(0,n.copyBytes)(t));let a=(0,n.u32)(t),s=a.length,o=t=>S(i,t,t,t,t),l=new Uint32Array(e+28);l.set(a);for(let t=s;t<l.length;t++){let e=l[t-1];t%s==0?e=o(c(e))^m[t/s-1]:s>6&&t%s==4&&(e=o(e)),l[t]=l[t-s]^e}return(0,n.clean)(...r),l}function y(t){let e=w(t),i=e.slice(),r=e.length,{sbox2:a}=f,{T0:s,T1:o,T2:l,T3:u}=g;for(let t=0;t<r;t+=4)for(let n=0;n<4;n++)i[t+n]=e[r-t-4+n];(0,n.clean)(e);for(let t=4;t<r-4;t++){let e=i[t],r=S(a,e,e,e,e);i[t]=s[255&r]^o[r>>>8&255]^l[r>>>16&255]^u[r>>>24]}return i}function T(t,e,i,r,n,a){return t[i<<8&65280|r>>>8&255]^e[n>>>8&65280|a>>>24&255]}function S(t,e,i,r,n){return t[255&e|65280&i]|t[r>>>16&255|n>>>16&65280]<<16}function E(t,e,i,r,n){let{sbox2:a,T01:s,T23:o}=f,l=0;e^=t[l++],i^=t[l++],r^=t[l++],n^=t[l++];let u=t.length/4-2;for(let a=0;a<u;a++){let a=t[l++]^T(s,o,e,i,r,n),u=t[l++]^T(s,o,i,r,n,e),c=t[l++]^T(s,o,r,n,e,i),h=t[l++]^T(s,o,n,e,i,r);e=a,i=u,r=c,n=h}let c=t[l++]^S(a,e,i,r,n),h=t[l++]^S(a,i,r,n,e);return{s0:c,s1:h,s2:t[l++]^S(a,r,n,e,i),s3:t[l++]^S(a,n,e,i,r)}}function I(t,e,i,r,n){let{sbox2:a,T01:s,T23:o}=g,l=0;e^=t[l++],i^=t[l++],r^=t[l++],n^=t[l++];let u=t.length/4-2;for(let a=0;a<u;a++){let a=t[l++]^T(s,o,e,n,r,i),u=t[l++]^T(s,o,i,e,n,r),c=t[l++]^T(s,o,r,i,e,n),h=t[l++]^T(s,o,n,r,i,e);e=a,i=u,r=c,n=h}let c=t[l++]^S(a,e,n,r,i),h=t[l++]^S(a,i,e,n,r);return{s0:c,s1:h,s2:t[l++]^S(a,r,i,e,n),s3:t[l++]^S(a,n,r,i,e)}}function v(t,e,i,r){(0,n.abytes)(e,16),(0,n.abytes)(i);let a=i.length;r=(0,n.getOutput)(a,r),(0,n.complexOverlapBytes)(i,r);let s=(0,n.u32)(e),{s0:o,s1:l,s2:u,s3:c}=E(t,s[0],s[1],s[2],s[3]),h=(0,n.u32)(i),p=(0,n.u32)(r);for(let i=0;i+4<=h.length;i+=4){p[i+0]=h[i+0]^o,p[i+1]=h[i+1]^l,p[i+2]=h[i+2]^u,p[i+3]=h[i+3]^c;let r=1;for(let t=e.length-1;t>=0;t--)r=r+(255&e[t])|0,e[t]=255&r,r>>>=8;({s0:o,s1:l,s2:u,s3:c}=E(t,s[0],s[1],s[2],s[3]))}let d=16*Math.floor(h.length/4);if(d<a){let t=new Uint32Array([o,l,u,c]),e=(0,n.u8)(t);for(let t=d,n=0;t<a;t++,n++)r[t]=i[t]^e[n];(0,n.clean)(t)}return r}function b(t,e,i,r,a){(0,n.abytes)(i,16),(0,n.abytes)(r),a=(0,n.getOutput)(r.length,a);let s=(0,n.u32)(i),o=(0,n.createView)(i),l=(0,n.u32)(r),u=(0,n.u32)(a),c=12*!e,h=r.length,p=o.getUint32(c,e),{s0:d,s1:f,s2:g,s3:m}=E(t,s[0],s[1],s[2],s[3]);for(let i=0;i+4<=l.length;i+=4)u[i+0]=l[i+0]^d,u[i+1]=l[i+1]^f,u[i+2]=l[i+2]^g,u[i+3]=l[i+3]^m,p=p+1>>>0,o.setUint32(c,p,e),{s0:d,s1:f,s2:g,s3:m}=E(t,s[0],s[1],s[2],s[3]);let w=16*Math.floor(l.length/4);if(w<h){let t=new Uint32Array([d,f,g,m]),e=(0,n.u8)(t);for(let t=w,i=0;t<h;t++,i++)a[t]=r[t]^e[i];(0,n.clean)(t)}return a}function B(t){if((0,n.abytes)(t),t.length%16!=0)throw Error("aes-(cbc/ecb).decrypt ciphertext should consist of blocks with size 16")}function A(t,e,i){(0,n.abytes)(t);let r=t.length,a=r%16;if(!e&&0!==a)throw Error("aec/(cbc-ecb): unpadded plaintext with disabled padding");(0,n.isAligned32)(t)||(t=(0,n.copyBytes)(t));let s=(0,n.u32)(t);if(e){let t=16-a;t||(t=16),r+=t}return i=(0,n.getOutput)(r,i),(0,n.complexOverlapBytes)(t,i),{b:s,o:(0,n.u32)(i),out:i}}function R(t,e){if(!e)return t;let i=t.length;if(!i)throw Error("aes/pcks5: empty ciphertext not allowed");let r=t[i-1];if(r<=0||r>16)throw Error("aes/pcks5: wrong padding");let n=t.subarray(0,-r);for(let e=0;e<r;e++)if(t[i-e-1]!==r)throw Error("aes/pcks5: wrong padding");return n}function C(t){let e=new Uint8Array(16),i=(0,n.u32)(e);e.set(t);let r=16-t.length;for(let t=16-r;t<16;t++)e[t]=r;return i}function _(t,e,i,r,a){let s=a?a.length:0,o=t.create(i,r.length+s);a&&o.update(a);let l=(0,n.u64Lengths)(8*r.length,8*s,e);o.update(r),o.update(l);let u=o.digest();return(0,n.clean)(l),u}i.ctr=(0,n.wrapCipher)({blockSize:16,nonceLength:16},function(t,e){function i(i,r){if((0,n.abytes)(i),void 0!==r&&((0,n.abytes)(r),!(0,n.isAligned32)(r)))throw Error("unaligned destination");let a=w(t),s=(0,n.copyBytes)(e),o=[a,s];(0,n.isAligned32)(i)||o.push(i=(0,n.copyBytes)(i));let l=v(a,s,i,r);return(0,n.clean)(...o),l}return{encrypt:(t,e)=>i(t,e),decrypt:(t,e)=>i(t,e)}}),i.ecb=(0,n.wrapCipher)({blockSize:16},function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=!e.disablePadding;return{encrypt(e,r){let{b:a,o:s,out:o}=A(e,i,r),l=w(t),u=0;for(;u+4<=a.length;){let{s0:t,s1:e,s2:i,s3:r}=E(l,a[u+0],a[u+1],a[u+2],a[u+3]);s[u++]=t,s[u++]=e,s[u++]=i,s[u++]=r}if(i){let t=C(e.subarray(4*u)),{s0:i,s1:r,s2:n,s3:a}=E(l,t[0],t[1],t[2],t[3]);s[u++]=i,s[u++]=r,s[u++]=n,s[u++]=a}return(0,n.clean)(l),o},decrypt(e,r){B(e);let a=y(t);r=(0,n.getOutput)(e.length,r);let s=[a];(0,n.isAligned32)(e)||s.push(e=(0,n.copyBytes)(e)),(0,n.complexOverlapBytes)(e,r);let o=(0,n.u32)(e),l=(0,n.u32)(r);for(let t=0;t+4<=o.length;){let{s0:e,s1:i,s2:r,s3:n}=I(a,o[t+0],o[t+1],o[t+2],o[t+3]);l[t++]=e,l[t++]=i,l[t++]=r,l[t++]=n}return(0,n.clean)(...s),R(r,i)}}}),i.cbc=(0,n.wrapCipher)({blockSize:16,nonceLength:16},function(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=!i.disablePadding;return{encrypt(i,a){let s=w(t),{b:o,o:l,out:u}=A(i,r,a),c=e,h=[s];(0,n.isAligned32)(c)||h.push(c=(0,n.copyBytes)(c));let p=(0,n.u32)(c),d=p[0],f=p[1],g=p[2],m=p[3],y=0;for(;y+4<=o.length;)d^=o[y+0],f^=o[y+1],g^=o[y+2],m^=o[y+3],({s0:d,s1:f,s2:g,s3:m}=E(s,d,f,g,m)),l[y++]=d,l[y++]=f,l[y++]=g,l[y++]=m;if(r){let t=C(i.subarray(4*y));d^=t[0],f^=t[1],g^=t[2],m^=t[3],({s0:d,s1:f,s2:g,s3:m}=E(s,d,f,g,m)),l[y++]=d,l[y++]=f,l[y++]=g,l[y++]=m}return(0,n.clean)(...h),u},decrypt(i,a){B(i);let s=y(t),o=e,l=[s];(0,n.isAligned32)(o)||l.push(o=(0,n.copyBytes)(o));let u=(0,n.u32)(o);a=(0,n.getOutput)(i.length,a),(0,n.isAligned32)(i)||l.push(i=(0,n.copyBytes)(i)),(0,n.complexOverlapBytes)(i,a);let c=(0,n.u32)(i),h=(0,n.u32)(a),p=u[0],d=u[1],f=u[2],g=u[3];for(let t=0;t+4<=c.length;){let e=p,i=d,r=f,n=g;p=c[t+0],d=c[t+1];let{s0:a,s1:o,s2:l,s3:u}=I(s,p,d,f=c[t+2],g=c[t+3]);h[t++]=a^e,h[t++]=o^i,h[t++]=l^r,h[t++]=u^n}return(0,n.clean)(...l),R(a,r)}}}),i.cfb=(0,n.wrapCipher)({blockSize:16,nonceLength:16},function(t,e){function i(i,r,a){(0,n.abytes)(i);let s=i.length;if(a=(0,n.getOutput)(s,a),(0,n.overlapBytes)(i,a))throw Error("overlapping src and dst not supported.");let o=w(t),l=e,u=[o];(0,n.isAligned32)(l)||u.push(l=(0,n.copyBytes)(l)),(0,n.isAligned32)(i)||u.push(i=(0,n.copyBytes)(i));let c=(0,n.u32)(i),h=(0,n.u32)(a),p=r?h:c,d=(0,n.u32)(l),f=d[0],g=d[1],m=d[2],y=d[3];for(let t=0;t+4<=c.length;){let{s0:e,s1:i,s2:r,s3:n}=E(o,f,g,m,y);h[t+0]=c[t+0]^e,h[t+1]=c[t+1]^i,h[t+2]=c[t+2]^r,h[t+3]=c[t+3]^n,f=p[t++],g=p[t++],m=p[t++],y=p[t++]}let T=16*Math.floor(c.length/4);if(T<s){({s0:f,s1:g,s2:m,s3:y}=E(o,f,g,m,y));let t=(0,n.u8)(new Uint32Array([f,g,m,y]));for(let e=T,r=0;e<s;e++,r++)a[e]=i[e]^t[r];(0,n.clean)(t)}return(0,n.clean)(...u),a}return{encrypt:(t,e)=>i(t,!0,e),decrypt:(t,e)=>i(t,!1,e)}}),i.gcm=(0,n.wrapCipher)({blockSize:16,nonceLength:12,tagLength:16,varSizeNonce:!0},function(t,e,i){if(e.length<8)throw Error("aes/gcm: invalid nonce length");function s(t,e,n){let a=_(r.ghash,!1,t,n,i);for(let t=0;t<e.length;t++)a[t]^=e[t];return a}function o(){let i=w(t),s=a.slice(),o=a.slice();if(b(i,!1,o,o,s),12===e.length)o.set(e);else{let t=a.slice(),i=(0,n.createView)(t);(0,n.setBigUint64)(i,8,BigInt(8*e.length),!1);let l=r.ghash.create(s).update(e).update(t);l.digestInto(o),l.destroy()}let l=b(i,!1,o,a);return{xk:i,authKey:s,counter:o,tagMask:l}}return{encrypt(t){let{xk:e,authKey:i,counter:r,tagMask:a}=o(),l=new Uint8Array(t.length+16),u=[e,i,r,a];(0,n.isAligned32)(t)||u.push(t=(0,n.copyBytes)(t)),b(e,!1,r,t,l.subarray(0,t.length));let c=s(i,a,l.subarray(0,l.length-16));return u.push(c),l.set(c,t.length),(0,n.clean)(...u),l},decrypt(t){let{xk:e,authKey:i,counter:r,tagMask:a}=o(),l=[e,i,a,r];(0,n.isAligned32)(t)||l.push(t=(0,n.copyBytes)(t));let u=t.subarray(0,-16),c=t.subarray(-16),h=s(i,a,u);if(l.push(h),!(0,n.equalBytes)(h,c))throw Error("aes/gcm: invalid ghash tag");let p=b(e,!1,r,u);return(0,n.clean)(...l),p}}});let F=(t,e,i)=>r=>{if(!Number.isSafeInteger(r)||e>r||r>i)throw Error(""+t+": expected value in range "+("["+e+"..")+i+"], got "+r)};function P(t){return t instanceof Uint32Array||ArrayBuffer.isView(t)&&"Uint32Array"===t.constructor.name}function x(t,e){if((0,n.abytes)(e,16),!P(t))throw Error("_encryptBlock accepts result of expandKeyLE");let i=(0,n.u32)(e),{s0:r,s1:a,s2:s,s3:o}=E(t,i[0],i[1],i[2],i[3]);return i[0]=r,i[1]=a,i[2]=s,i[3]=o,e}function D(t,e){if((0,n.abytes)(e,16),!P(t))throw Error("_decryptBlock accepts result of expandKeyLE");let i=(0,n.u32)(e),{s0:r,s1:a,s2:s,s3:o}=I(t,i[0],i[1],i[2],i[3]);return i[0]=r,i[1]=a,i[2]=s,i[3]=o,e}i.gcmsiv=(0,n.wrapCipher)({blockSize:16,nonceLength:12,tagLength:16,varSizeNonce:!0},function(t,e,i){let a=F("AAD",0,0x1000000000),s=F("plaintext",0,0x1000000000),o=F("nonce",12,12),l=F("ciphertext",16,0x1000000000+16);function u(){let i=w(t),r=new Uint8Array(t.length),a=new Uint8Array(16),s=[i,r],o=e;(0,n.isAligned32)(o)||s.push(o=(0,n.copyBytes)(o));let l=(0,n.u32)(o),u=0,c=l[0],h=l[1],p=l[2],d=0;for(let t of[a,r].map(n.u32)){let e=(0,n.u32)(t);for(let t=0;t<e.length;t+=2){let{s0:r,s1:n}=E(i,u,c,h,p);e[t+0]=r,e[t+1]=n,u=++d}}let f={authKey:a,encKey:w(r)};return(0,n.clean)(...s),f}function c(t,a,s){let o=_(r.polyval,!0,a,s,i);for(let t=0;t<12;t++)o[t]^=e[t];o[15]&=127;let l=(0,n.u32)(o),u=l[0],c=l[1],h=l[2],p=l[3];return{s0:u,s1:c,s2:h,s3:p}=E(t,u,c,h,p),l[0]=u,l[1]=c,l[2]=h,l[3]=p,o}function h(t,e,i){let r=(0,n.copyBytes)(e);r[15]|=128;let a=b(t,!0,r,i);return(0,n.clean)(r),a}return(0,n.abytes)(t,16,24,32),o(e.length),void 0!==i&&a(i.length),{encrypt(t){s(t.length);let{encKey:e,authKey:i}=u(),r=c(e,i,t),a=[e,i,r];(0,n.isAligned32)(t)||a.push(t=(0,n.copyBytes)(t));let o=new Uint8Array(t.length+16);return o.set(r,t.length),o.set(h(e,r,t)),(0,n.clean)(...a),o},decrypt(t){l(t.length);let e=t.subarray(-16),{encKey:i,authKey:r}=u(),a=[i,r];(0,n.isAligned32)(t)||a.push(t=(0,n.copyBytes)(t));let s=h(i,e,t.subarray(0,-16)),o=c(i,r,s);if(a.push(o),!(0,n.equalBytes)(e,o))throw(0,n.clean)(...a),Error("invalid polyval tag");return(0,n.clean)(...a),s}}}),i.siv=i.gcmsiv;let k={encrypt(t,e){if(e.length>=0x100000000)throw Error("plaintext should be less than 4gb");let i=w(t);if(16===e.length)x(i,e);else{let t=(0,n.u32)(e),r=t[0],a=t[1];for(let e=0,n=1;e<6;e++)for(let e=2;e<t.length;e+=2,n++){let{s0:s,s1:o,s2:l,s3:u}=E(i,r,a,t[e],t[e+1]);r=s,a=o^p(n),t[e]=l,t[e+1]=u}t[0]=r,t[1]=a}i.fill(0)},decrypt(t,e){if(e.length-8>=0x100000000)throw Error("ciphertext should be less than 4gb");let i=y(t),r=e.length/8-1;if(1===r)D(i,e);else{let t=(0,n.u32)(e),a=t[0],s=t[1];for(let e=0,n=6*r;e<6;e++)for(let e=2*r;e>=1;e-=2,n--){let{s0:r,s1:o,s2:l,s3:u}=I(i,a,s^=p(n),t[e],t[e+1]);a=r,s=o,t[e]=l,t[e+1]=u}t[0]=a,t[1]=s}i.fill(0)}},O=new Uint8Array(8).fill(166);i.aeskw=(0,n.wrapCipher)({blockSize:8},t=>({encrypt(e){if(!e.length||e.length%8!=0)throw Error("invalid plaintext length");if(8===e.length)throw Error("8-byte keys not allowed in AESKW, use AESKWP instead");let i=(0,n.concatBytes)(O,e);return k.encrypt(t,i),i},decrypt(e){if(e.length%8!=0||e.length<24)throw Error("invalid ciphertext length");let i=(0,n.copyBytes)(e);if(k.decrypt(t,i),!(0,n.equalBytes)(i.subarray(0,8),O))throw Error("integrity check failed");return i.subarray(0,8).fill(0),i.subarray(8)}})),i.aeskwp=(0,n.wrapCipher)({blockSize:8},t=>({encrypt(e){if(!e.length)throw Error("invalid plaintext length");let i=new Uint8Array(8+8*Math.ceil(e.length/8));i.set(e,8);let r=(0,n.u32)(i);return r[0]=0xa65959a6,r[1]=p(e.length),k.encrypt(t,i),i},decrypt(e){if(e.length<16)throw Error("invalid ciphertext length");let i=(0,n.copyBytes)(e),r=(0,n.u32)(i);k.decrypt(t,i);let a=p(r[1])>>>0,s=8*Math.ceil(a/8);if(0xa65959a6!==r[0]||i.length-8!==s)throw Error("integrity check failed");for(let t=a;t<s;t++)if(0!==i[8+t])throw Error("integrity check failed");return i.subarray(0,8).fill(0),i.subarray(8,8+a)}})),i.unsafe={expandKeyLE:w,expandKeyDecLE:y,encrypt:E,decrypt:I,encryptBlock:x,decryptBlock:D,ctrCounter:v,ctr32:b}},54111,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.LNURL=i.MAIL_REGEX=i.BASE64_REGEX=i.isLNURLPaySuccessAction=i.isLNURLPayResult=i.isLNURLWithdrawParams=i.isLNURLPayParams=i.isLNURLError=i.isLNURLWithdraw=i.isLNURLPay=void 0;let r=t.r(686157),n=t.r(20349),a=t.r(17061),s=t.r(559766),o=t.r(732557),l=t.r(922507),u=t.r(843943),c=t.r(14582);function h(t){return"ERROR"===t.status&&(null==t.reason||"string"==typeof t.reason)}function p(t){return"payRequest"===t.tag}function d(t){return"withdrawRequest"===t.tag}function f(t,e){return"string"==typeof t.pr&&(null==t.routes||Array.isArray(t.routes))&&(null===t.disposable||void 0===t.disposable||"boolean"==typeof t.disposable)&&(null==t.successAction||g(t.successAction,e))}function g(t,e){if(null==t||"object"!=typeof t||"string"!=typeof t.tag)return!1;switch(t.tag){case"message":return null!=t.message&&t.message.length<=144;case"url":return null!=t.description&&t.description.length<=144&&null!=t.url&&(null==e||new URL(t.url).hostname===e);case"aes":return null!=t.description&&t.description.length<=144&&null!=t.ciphertext&&t.ciphertext.length<=4096&&i.BASE64_REGEX.test(t.ciphertext)&&null!=t.iv&&t.iv.length<=24&&i.BASE64_REGEX.test(t.iv);default:return!1}}i.isLNURLPay=function(t){return"object"==typeof t&&null!=t&&"pay"===t.type&&"bigint"==typeof t.min&&"bigint"==typeof t.max&&"number"==typeof t.commentMaxLength&&"string"==typeof t.shortDescription&&(void 0===t.longDescription||"string"==typeof t.longDescription)&&(void 0===t.icon||"string"==typeof t.icon)&&p(t.params)},i.isLNURLWithdraw=function(t){return"object"==typeof t&&null!=t&&"withdraw"===t.type&&"bigint"==typeof t.min&&"bigint"==typeof t.max&&d(t.params)},i.isLNURLError=h,i.isLNURLPayParams=p,i.isLNURLWithdrawParams=d,i.isLNURLPayResult=f,i.isLNURLPaySuccessAction=g,i.BASE64_REGEX=/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/,i.MAIL_REGEX=/(?:[A-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[A-z0-9!#$%&'*+/=?^_`{|}~-]+)*|"(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21\x23-\x5b\x5d-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])*")@(?:(?:[A-z0-9](?:[A-z0-9-]*[A-z0-9])?\.)+[A-z0-9](?:[A-z0-9-]*[A-z0-9])?|\[(?:(?:(2(5[0-5]|[0-4][0-9])|1[0-9][0-9]|[1-9]?[0-9]))\.){3}(?:(2(5[0-5]|[0-4][0-9])|1[0-9][0-9]|[1-9]?[0-9])|[A-z0-9-]*[A-z0-9]:(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21-\x5a\x53-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])+)\])/;class m{static findBech32LNURL(t){let e=/,*?((lnurl)([0-9]{1,}[a-z0-9]+){1})/.exec(t.toLowerCase());return null==e?null:e[1]}static isBech32LNURL(t){return null!=this.findBech32LNURL(t)}static isBareLNURL(t){try{return t.startsWith("lnurlw://")||t.startsWith("lnurlp://")}catch(t){}return!1}static isLightningAddress(t){return i.MAIL_REGEX.test(t)}static isLNURL(t){return m.isBech32LNURL(t)||m.isLightningAddress(t)||m.isBareLNURL(t)}static extractCallUrl(t){if(i.MAIL_REGEX.test(t)){let e=t.split("@"),i=e[0],r=e[1],n="https";return r.endsWith(".onion")&&(n="http"),n+"://"+r+"/.well-known/lnurlp/"+i}if(m.isBareLNURL(t)){let e=t.substring(9),i=new URL("http://"+e),r="https";return i.hostname.endsWith(".onion")&&(r="http"),r+"://"+e}{let e=m.findBech32LNURL(t);if(null!=e){let{prefix:t,words:i}=o.bech32.decode(e,2e3),r=o.bech32.fromWords(i);return u.Buffer.from(r).toString()}}return null}static async getLNURL(t){let e=!(arguments.length>1)||void 0===arguments[1]||arguments[1],i=arguments.length>2?arguments[2]:void 0,n=arguments.length>3?arguments[3]:void 0;null==e&&(e=!0);let a=m.extractCallUrl(t);if(null!=a){let o=()=>(0,s.httpGet)(a,i,n,!0),l=e?await (0,s.tryWithRetries)(o,null,r.RequestError,n):await o();if(h(l))return null;if("payRequest"===l.tag)try{l.decodedMetadata=JSON.parse(l.metadata)}catch(t){l.decodedMetadata=[]}return p(l)||d(l)?{...l,url:t}:null}}static async getLNURLType(t,e,i,r){let n=await m.getLNURL(t,e,i,r);if("payRequest"===n.tag){let t,e,i;return n.decodedMetadata.forEach(r=>{switch(r[0]){case"text/plain":t=r[1];break;case"text/long-desc":e=r[1];break;case"image/png;base64":case"image/jpeg;base64":i="data:"+r[0]+","+r[1]}}),{type:"pay",min:BigInt(n.minSendable)/1000n,max:BigInt(n.maxSendable)/1000n,commentMaxLength:n.commentAllowed||0,shortDescription:t,longDescription:e,icon:i,params:n}}return"withdrawRequest"===n.tag?{type:"withdraw",min:BigInt(n.minWithdrawable)/1000n,max:BigInt(n.maxWithdrawable)/1000n,params:n}:null}static async useLNURLPay(t,e,i,a,o){let l=["amount="+(1000n*e).toString(10)];null!=i&&l.push("comment="+encodeURIComponent(i));let p=(t.callback.includes("?")?"&":"?")+l.join("&"),d=await (0,s.tryWithRetries)(()=>(0,s.httpGet)(t.callback+p,a,o,!0),null,r.RequestError,o);if(h(d))throw new r.RequestError("LNURL callback error: "+d.reason,200);if(!f(d))throw new r.RequestError("Invalid LNURL response!",200);let g=(0,n.decode)(d.pr),m=u.Buffer.from((0,c.sha256)(t.metadata)).toString("hex");if(g.tagsObject.purpose_commit_hash!==m)throw new r.RequestError("Invalid invoice received (description hash)!",200);if(BigInt(g.millisatoshis)!==1000n*e)throw new r.RequestError("Invalid invoice received (amount)!",200);return{invoice:d.pr,parsedInvoice:g,successAction:d.successAction}}static async postInvoiceToLNURLWithdraw(t,e){let i=["pr="+e,"k1="+t.k1],n=(t.callback.includes("?")?"&":"?")+i.join("&"),a=await (0,s.tryWithRetries)(()=>(0,s.httpGet)(t.callback+n,null,null,!0),null,r.RequestError);if(h(a))throw new r.RequestError("LNURL callback error: "+a.reason,200)}static async useLNURLWithdraw(t,e){let i=BigInt(t.minWithdrawable)/1000n,r=BigInt(t.maxWithdrawable)/1000n,s=(BigInt((0,n.decode)(e).millisatoshis)+999n)/1000n;if(s<i)throw new a.UserError("Invoice amount less than minimum LNURL-withdraw limit");if(s>r)throw new a.UserError("Invoice amount more than maximum LNURL-withdraw limit");return await m.postInvoiceToLNURLWithdraw(t,e)}static decodeSuccessAction(t,e){if(null==e)return null;if("message"===t.tag)return{description:t.message};if("url"===t.tag)return{description:t.description,url:t.url};if("aes"===t.tag){let i=(0,l.cbc)(u.Buffer.from(e,"hex"),u.Buffer.from(t.iv,"hex")).decrypt(u.Buffer.from(t.ciphertext,"base64")),r=i.length,n=i[r-1];return{description:t.description,text:u.Buffer.from(i).toString("utf8",0,r-n)}}}}i.LNURL=m},301822,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.ToBTCLNSwap=i.isToBTCLNSwapInit=void 0;let r=t.r(20349),n=t.r(404023),a=t.r(865854),s=t.r(843943),o=t.r(14582),l=t.r(145617),u=t.r(54111),c=t.r(768270),h=t.r(559766);function p(t){return"number"==typeof t.confidence&&"string"==typeof t.pr&&(null==t.lnurl||"string"==typeof t.lnurl)&&(null==t.successAction||(0,u.isLNURLPaySuccessAction)(t.successAction))&&(0,n.isIToBTCSwapInit)(t)}i.isToBTCLNSwapInit=p;let d=new Set(["038f8f113c580048d847d6949371726653e02b928196bad310e3eda39ff61723f6","03a6ce61fcaacd38d31d4e3ce2d506602818e3856b4b44faff1dde9642ba705976"]);class f extends n.IToBTCSwap{_setPaymentResult(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(null==t)return Promise.resolve(!1);if(null==t.secret)throw new l.IntermediaryError("No payment secret returned!");if(e){let e=s.Buffer.from(t.secret,"hex");if(!s.Buffer.from((0,o.sha256)(e)).equals(this.getPaymentHash()))throw new l.IntermediaryError("Invalid payment secret returned")}return this.secret=t.secret,Promise.resolve(!0)}getOutput(){let t=(BigInt((0,r.decode)(this.pr).millisatoshis)+999n)/1000n;return(0,c.toTokenAmount)(t,this.outputToken,this.wrapper.prices)}getOutputTxId(){return this.getLpIdentifier()}getOutputAddress(){var t;return null!=(t=this.lnurl)?t:this.pr}getSecret(){return this.secret}getConfidence(){return this.confidence}willLikelyFail(){let t=(0,r.decode)(this.pr);if(null!=t.tagsObject.routing_info){for(let e of t.tagsObject.routing_info)if(d.has(e.pubkey))return!1}return 0===this.confidence}isPayingToNonCustodialWallet(){let t=(0,r.decode)(this.pr);return null!=t.tagsObject.routing_info&&t.tagsObject.routing_info.length>0}getIdentifierHash(){let t=this.getPaymentHash();return null==this.randomNonce?t:s.Buffer.concat([t,s.Buffer.from(this.randomNonce,"hex")])}getPaymentHash(){if(null==this.pr)return null;let t=(0,r.decode)(this.pr);return s.Buffer.from(t.tagsObject.payment_hash,"hex")}getLpIdentifier(){return null==this.pr?null:(0,r.decode)(this.pr).tagsObject.payment_hash}isLNURL(){return null!=this.lnurl}getLNURL(){return this.lnurl}hasSuccessAction(){return null!=this.successAction}getSuccessAction(){return u.LNURL.decodeSuccessAction(this.successAction,this.secret)}serialize(){return{...super.serialize(),paymentHash:this.getPaymentHash().toString("hex"),pr:this.pr,confidence:this.confidence,secret:this.secret,lnurl:this.lnurl,successAction:this.successAction}}constructor(t,e){p(e)&&(e.url+="/tobtcln"),super(t,e),this.outputToken=c.BitcoinTokens.BTCLN,this.TYPE=a.SwapType.TO_BTCLN,p(e)||(this.confidence=e.confidence,this.pr=e.pr,this.lnurl=e.lnurl,this.successAction=e.successAction,this.secret=e.secret),this.paymentHash=this.getPaymentHash().toString("hex"),this.logger=(0,h.getLogger)("ToBTCLN("+this.getIdentifierHashString()+"): "),this.tryRecomputeSwapPrice()}}i.ToBTCLNSwap=f},387951,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.IEscrowSwapWrapper=void 0;let r=t.r(462501),n=t.r(991989),a=t.r(559766);class s extends r.ISwapWrapper{preFetchSignData(t){return null==this.contract.preFetchForInitSignatureVerification?Promise.resolve(null):t.then(t=>null==t?null:this.contract.preFetchForInitSignatureVerification(t)).catch(t=>(this.logger.error("preFetchSignData(): Error: ",t),null))}async verifyReturnedSignature(t,e,i,r,s,o){let[l,u]=await Promise.all([r,s]);return await (0,a.tryWithRetries)(()=>this.contract.isValidInitAuthorization(t,e,i,l,u),null,n.SignatureVerificationError,o),await (0,a.tryWithRetries)(()=>this.contract.getInitAuthorizationExpiry(e,i,u),null,n.SignatureVerificationError,o)}async processEvent(t,e){var i,r,a;if(null==e)return;let s=!1;return t instanceof n.InitializeEvent&&(s=await this.processEventInitialize(e,t),(null==(i=t.meta)?void 0:i.txId)!=null&&e.commitTxId!==t.meta.txId&&(e.commitTxId=t.meta.txId,s||(s=!0))),t instanceof n.ClaimEvent&&(s=await this.processEventClaim(e,t),(null==(r=t.meta)?void 0:r.txId)!=null&&e.claimTxId!==t.meta.txId&&(e.claimTxId=t.meta.txId,s||(s=!0))),t instanceof n.RefundEvent&&(s=await this.processEventRefund(e,t),(null==(a=t.meta)?void 0:a.txId)!=null&&e.refundTxId!==t.meta.txId&&(e.refundTxId=t.meta.txId,s||(s=!0))),this.logger.info("processEvents(): "+t.constructor.name+" processed for "+e.getId()+" swap: ",e),s&&await e._saveAndEmit(),!0}constructor(t,e,i,r,n,a,s,o,l,u){super(t,e,i,r,a,s,l,u),this.swapDataDeserializer=o,this.contract=n}}i.IEscrowSwapWrapper=s},512302,(t,e,i)=>{"use strict";var r=t.i(467034);Object.defineProperty(i,"__esModule",{value:!0}),i.IToBTCWrapper=void 0;let n=t.r(404023),a=t.r(559766),s=t.r(145617),o=t.r(387951);class l extends o.IEscrowSwapWrapper{preFetchIntermediaryReputation(t,e,i){return e.getReputation(this.chainIdentifier,this.contract,[t.token.toString()],i.signal).then(t=>{if(null==t)throw new s.IntermediaryError("Invalid data returned - invalid LP vault");return t}).catch(t=>(this.logger.warn("preFetchIntermediaryReputation(): Error: ",t),i.abort(t),null))}preFetchFeeRate(t,e,i,r){return(0,a.tryWithRetries)(()=>this.contract.getInitPayInFeeRate(t,null,e.token,i),null,null,r.signal).catch(t=>(this.logger.warn("preFetchFeeRate(): Error: ",t),r.abort(t),null))}async processEventInitialize(t,e){if(t.state===n.ToBTCSwapState.CREATED||t.state===n.ToBTCSwapState.QUOTE_SOFT_EXPIRED){let i=await e.swapData();return(null==t.data||!!t.data.equals(i))&&((t.state===n.ToBTCSwapState.CREATED||t.state===n.ToBTCSwapState.QUOTE_SOFT_EXPIRED)&&(t.state=n.ToBTCSwapState.COMMITED),t.data=i,!0)}}processEventClaim(t,e){return t.state!==n.ToBTCSwapState.REFUNDED&&t.state!==n.ToBTCSwapState.CLAIMED?(t.state=n.ToBTCSwapState.CLAIMED,t._setPaymentResult({secret:e.result,txId:r.Buffer.from(e.result,"hex").reverse().toString("hex")}),Promise.resolve(!0)):Promise.resolve(!1)}processEventRefund(t,e){return t.state!==n.ToBTCSwapState.CLAIMED&&t.state!==n.ToBTCSwapState.REFUNDED?(t.state=n.ToBTCSwapState.REFUNDED,Promise.resolve(!0)):Promise.resolve(!1)}constructor(){super(...arguments),this.pendingSwapStates=[n.ToBTCSwapState.CREATED,n.ToBTCSwapState.QUOTE_SOFT_EXPIRED,n.ToBTCSwapState.COMMITED,n.ToBTCSwapState.SOFT_CLAIMED,n.ToBTCSwapState.REFUNDABLE],this.tickSwapState=[n.ToBTCSwapState.CREATED,n.ToBTCSwapState.COMMITED,n.ToBTCSwapState.SOFT_CLAIMED],this.refundableSwapStates=[n.ToBTCSwapState.REFUNDABLE]}}i.IToBTCWrapper=l},746894,(t,e,i)=>{"use strict";var r=t.i(467034);Object.defineProperty(i,"__esModule",{value:!0}),i.ToBTCLNWrapper=void 0;let n=t.r(20349),a=t.r(301822),s=t.r(512302),o=t.r(17061),l=t.r(991989),u=t.r(145617),c=t.r(865854),h=t.r(559766),p=t.r(366913),d=t.r(686157),f=t.r(54111),g=t.r(404023);class m extends s.IToBTCWrapper{async checkPaymentHashWasPaid(t){for(let e of(await this.unifiedStorage.query([[{key:"type",value:this.TYPE},{key:"paymentHash",value:t}]],t=>new this.swapDeserializer(this,t))))if(e.state===g.ToBTCSwapState.CLAIMED||e.state===g.ToBTCSwapState.SOFT_CLAIMED)throw new o.UserError("Lightning invoice was already paid!")}calculateFeeForAmount(t,e,i){return BigInt(null!=e?e:this.options.lightningBaseFee)+t*BigInt(null!=i?i:this.options.lightningFeePPM)/1000000n}async verifyReturnedData(t,e,i,n,a,s,o){if(t.routingFeeSats>await a.maxFee)throw new u.IntermediaryError("Invalid max fee sats returned");if(null!=o&&t.total!==o)throw new u.IntermediaryError("Invalid data returned - total amount");let c=this.contract.getHashForHtlc(r.Buffer.from(e.tagsObject.payment_hash,"hex"));if(s.getAmount()!==t.total||!r.Buffer.from(s.getClaimHash(),"hex").equals(c)||s.getExpiry()!==a.expiryTimestamp||s.getType()!==l.ChainSwapType.HTLC||!s.isPayIn()||!s.isToken(i)||s.getClaimer()!==n.getAddress(this.chainIdentifier))throw new u.IntermediaryError("Invalid data returned")}async getIntermediaryQuote(t,e,i,r,n,s,o,l,u){let f=l instanceof AbortController?l:(0,h.extendAbortController)(l);null!=o.reputationPromise||(o.reputationPromise=this.preFetchIntermediaryReputation(e,i,f));try{let{signDataPromise:l,resp:g}=await (0,h.tryWithRetries)(async n=>{let{signDataPrefetch:a,response:l}=p.IntermediaryAPI.initToBTCLN(this.chainIdentifier,i.url,{offerer:t,pr:r,maxFee:await s.maxFee,expiryTimestamp:s.expiryTimestamp,token:e.token,feeRate:o.feeRatePromise,additionalParams:u},this.options.postRequestTimeout,f.signal,!(n>0)&&null);return{signDataPromise:this.preFetchSignData(a),resp:await l}},null,t=>t instanceof d.RequestError,f.signal),m=(BigInt(n.millisatoshis)+999n)/1000n;g.swapFee,g.maxFee;let w=new this.swapDataDeserializer(g.data);w.setOfferer(t),await this.verifyReturnedData(g,n,e.token,i,s,w);let[y,T,S]=await Promise.all([this.verifyReturnedPrice(i.services[c.SwapType.TO_BTCLN],!0,m,w.getAmount(),e.token,{networkFee:g.maxFee},o.pricePreFetchPromise,f.signal),this.verifyReturnedSignature(t,w,g,o.feeRatePromise,l,f.signal),o.reputationPromise]);f.signal.throwIfAborted(),i.reputation[e.token.toString()]=S;let E=new a.ToBTCLNSwap(this,{pricingInfo:y,url:i.url,expiry:T,swapFee:g.swapFee,feeRate:await o.feeRatePromise,signatureData:g,data:w,networkFee:g.maxFee,networkFeeBtc:g.routingFeeSats,confidence:g.confidence,pr:r,exactIn:!1});return await E._save(),E}catch(t){throw f.abort(t),t}}async create(t,e,i,a,s,l,u,c){var p,d,f;null!=s||(s={}),null!=(p=s).expirySeconds||(p.expirySeconds=this.options.paymentTimeoutSeconds),null!=(d=s).expiryTimestamp||(d.expiryTimestamp=BigInt(Math.floor(Date.now()/1e3)+s.expirySeconds));let g=(0,n.decode)(e);if(null==g.millisatoshis)throw new o.UserError("Must be an invoice with amount");let m=(BigInt(g.millisatoshis)+999n)/1000n;null!=(f=s).maxFee||(f.maxFee=this.calculateFeeForAmount(m,s.maxRoutingBaseFee,s.maxRoutingPPM)),await this.checkPaymentHashWasPaid(g.tagsObject.payment_hash);let w=this.contract.getHashForHtlc(r.Buffer.from(g.tagsObject.payment_hash,"hex")),y=(0,h.extendAbortController)(u);return null==c&&(c={pricePreFetchPromise:this.preFetchPrice(i,y.signal),feeRatePromise:this.preFetchFeeRate(t,i,w.toString("hex"),y)}),a.map(r=>({intermediary:r,quote:this.getIntermediaryQuote(t,i,r,e,g,s,c,y.signal,l)}))}async getLNURLPay(t,e){if("string"!=typeof t)return t;let i=await f.LNURL.getLNURL(t,!0,this.options.getRequestTimeout,e);if(null==i)throw new o.UserError("Invalid LNURL");if("payRequest"!==i.tag)throw new o.UserError("Not a LNURL-pay");return i}async getIntermediaryQuoteExactIn(t,e,i,r,n,s,l,g,m){let w=(0,h.extendAbortController)(g),y=this.preFetchIntermediaryReputation(e,r,w);try{let{signDataPromise:T,prepareResp:S}=await (0,h.tryWithRetries)(async i=>{let{signDataPrefetch:a,response:o}=p.IntermediaryAPI.prepareToBTCLNExactIn(this.chainIdentifier,r.url,{token:e.token,offerer:t,pr:n,amount:e.amount,maxFee:await s.maxFee,expiryTimestamp:s.expiryTimestamp,additionalParams:m},this.options.postRequestTimeout,w.signal,!(i>0)&&null);return{signDataPromise:this.preFetchSignData(a),prepareResp:await o}},null,t=>t instanceof d.RequestError,w.signal);if(S.amount<=0n)throw new u.IntermediaryError("Invalid amount returned (zero or negative)");let E=BigInt(i.minSendable)/1000n,I=BigInt(i.maxSendable)/1000n;if(S.amount<E)throw new o.UserError("Amount less than minimum");if(S.amount>I)throw new o.UserError("Amount more than maximum");let{invoice:v,parsedInvoice:b,successAction:B}=await f.LNURL.useLNURLPay(i,S.amount,s.comment,this.options.getRequestTimeout,w.signal),A=await (0,h.tryWithRetries)(t=>p.IntermediaryAPI.initToBTCLNExactIn(r.url,{pr:v,reqId:S.reqId,feeRate:l.feeRatePromise,additionalParams:m},this.options.postRequestTimeout,w.signal,!(t>0)&&null),null,d.RequestError,w.signal);A.swapFee,A.maxFee;let R=new this.swapDataDeserializer(A.data);R.setOfferer(t),await this.verifyReturnedData(A,b,e.token,r,s,R,e.amount);let[C,_,F]=await Promise.all([this.verifyReturnedPrice(r.services[c.SwapType.TO_BTCLN],!0,S.amount,R.getAmount(),e.token,{networkFee:A.maxFee},l.pricePreFetchPromise,g),this.verifyReturnedSignature(t,R,A,l.feeRatePromise,T,w.signal),y]);w.signal.throwIfAborted(),r.reputation[e.token.toString()]=F;let P=new a.ToBTCLNSwap(this,{pricingInfo:C,url:r.url,expiry:_,swapFee:A.swapFee,feeRate:await l.feeRatePromise,signatureData:A,data:R,networkFee:A.maxFee,networkFeeBtc:A.routingFeeSats,confidence:A.confidence,pr:v,lnurl:i.url,successAction:B,exactIn:!0});return await P._save(),P}catch(t){throw w.abort(t),t}}async createViaLNURL(t,e,i,r,n,a,s){var l,u,c,p,d;if(!this.isInitialized)throw Error("Not initialized, call init() first!");null!=n||(n={}),null!=(l=n).expirySeconds||(l.expirySeconds=this.options.paymentTimeoutSeconds),null!=(u=n).expiryTimestamp||(u.expiryTimestamp=BigInt(Math.floor(Date.now()/1e3)+n.expirySeconds));let g=(0,h.extendAbortController)(s),m=this.preFetchPrice(i,g.signal),w=this.preFetchFeeRate(t,i,null,g);null!=(c=n).maxRoutingPPM||(c.maxRoutingPPM=BigInt(this.options.lightningFeePPM)),null!=(p=n).maxRoutingBaseFee||(p.maxRoutingBaseFee=BigInt(this.options.lightningBaseFee)),i.exactIn?null!=(d=n).maxFee||(d.maxFee=m.then(t=>this.prices.getFromBtcSwapAmount(this.chainIdentifier,n.maxRoutingBaseFee,i.token,s,t)).then(t=>this.calculateFeeForAmount(i.amount,t,n.maxRoutingPPM))):n.maxFee=this.calculateFeeForAmount(i.amount,n.maxRoutingBaseFee,n.maxRoutingPPM);try{let s=await this.getLNURLPay(e,g.signal);if(null!=n.comment&&(null==s.commentAllowed||n.comment.length>s.commentAllowed))throw new o.UserError("Comment not allowed or too long");if(i.exactIn){let{invoice:e}=await f.LNURL.useLNURLPay(s,BigInt(s.minSendable)/1000n,null,this.options.getRequestTimeout,g.signal);return r.map(r=>({quote:this.getIntermediaryQuoteExactIn(t,i,s,r,e,n,{pricePreFetchPromise:m,feeRatePromise:w},g.signal,a),intermediary:r}))}{let e=BigInt(s.minSendable)/1000n,l=BigInt(s.maxSendable)/1000n;if(i.amount<e)throw new o.UserError("Amount less than minimum");if(i.amount>l)throw new o.UserError("Amount more than maximum");let{invoice:u,parsedInvoice:c,successAction:h}=await f.LNURL.useLNURLPay(s,i.amount,n.comment,this.options.getRequestTimeout,g.signal);return(await this.create(t,u,i,r,n,a,g.signal,{feeRatePromise:w,pricePreFetchPromise:m})).map(t=>({quote:t.quote.then(t=>(t.lnurl=s.url,t.successAction=h,t)),intermediary:t.intermediary}))}}catch(t){throw g.abort(t),t}}constructor(t,e,i,r,n,s,o,l,u,h){var p,d,f;null==u&&(u={}),null!=(p=u).paymentTimeoutSeconds||(p.paymentTimeoutSeconds=345600),null!=(d=u).lightningBaseFee||(d.lightningBaseFee=10),null!=(f=u).lightningFeePPM||(f.lightningFeePPM=2e3),super(t,e,i,r,n,s,o,l,u,h),this.TYPE=c.SwapType.TO_BTCLN,this.swapDeserializer=a.ToBTCLNSwap}}i.ToBTCLNWrapper=m},263330,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.ToBTCSwap=i.isToBTCSwapInit=void 0;let r=t.r(404023),n=t.r(865854),a=t.r(843943),s=t.r(145617),o=t.r(768270),l=t.r(559766);function u(t){return"string"==typeof t.address&&"bigint"==typeof t.amount&&"number"==typeof t.confirmationTarget&&"number"==typeof t.satsPerVByte&&(0,r.isIToBTCSwapInit)(t)}i.isToBTCSwapInit=u;class c extends r.IToBTCSwap{async _setPaymentResult(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(null==t)return!1;if(null==t.txId)throw new s.IntermediaryError("No btc txId returned!");if(e){let e=await this.wrapper.btcRpc.getTransaction(t.txId);if(null==e)return!1;if(null==e.outs.find(t=>this.data.getClaimHash()===this.wrapper.contract.getHashForOnchain(a.Buffer.from(t.scriptPubKey.hex,"hex"),BigInt(t.value),this.requiredConfirmations,this.nonce).toString("hex")))throw new s.IntermediaryError("Invalid btc txId returned")}return this.txId=t.txId,!0}getOutput(){return(0,o.toTokenAmount)(this.amount,this.outputToken,this.wrapper.prices)}getOutputAddress(){return this.address}getOutputTxId(){return this.txId}getBitcoinFeeRate(){return this.satsPerVByte}serialize(){return{...super.serialize(),address:this.address,amount:this.amount.toString(10),confirmationTarget:this.confirmationTarget,satsPerVByte:this.satsPerVByte,nonce:null==this.nonce?null:this.nonce.toString(10),requiredConfirmations:this.requiredConfirmations,txId:this.txId}}constructor(t,e){if(u(e)&&(e.url+="/tobtc"),super(t,e),this.outputToken=o.BitcoinTokens.BTC,this.TYPE=n.SwapType.TO_BTC,!u(e)){var i,r;this.address=e.address,this.amount=BigInt(e.amount),this.confirmationTarget=e.confirmationTarget,this.satsPerVByte=e.satsPerVByte,this.txId=e.txId,this.requiredConfirmations=null!=(i=e.requiredConfirmations)?i:this.data.getConfirmationsHint(),this.nonce=null!=(r=null==e.nonce?null:BigInt(e.nonce))?r:this.data.getNonceHint()}this.logger=(0,l.getLogger)("ToBTC("+this.getIdentifierHashString()+"): "),this.tryRecomputeSwapPrice()}}i.ToBTCSwap=c},985960,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.ToBTCWrapper=void 0;let r=t.r(263330),n=t.r(512302),a=t.r(991989),s=t.r(17061),o=t.r(145617),l=t.r(865854),u=t.r(559766),c=t.r(366913),h=t.r(686157),p=t.r(446598);class d extends n.IToBTCWrapper{getRandomNonce(){return BigInt(Math.floor(Date.now()/1e3)-7e8)<<24n|a.BigIntBufferUtils.fromBuffer((0,u.randomBytes)(3))}btcAddressToOutputScript(t){try{return(0,u.toOutputScript)(this.options.bitcoinNetwork,t)}catch(t){throw new s.UserError("Invalid address specified")}}verifyReturnedData(t,e,i,r,n,s){if(t.totalFee!==t.swapFee+t.networkFee)throw new o.IntermediaryError("Invalid totalFee returned");if(e.exactIn){if(t.total!==e.amount)throw new o.IntermediaryError("Invalid total returned")}else if(t.amount!==e.amount)throw new o.IntermediaryError("Invalid amount returned");let l=BigInt(r.confirmations+r.confirmationTarget+this.options.maxExpectedOnchainSendGracePeriodBlocks)*BigInt(this.options.maxExpectedOnchainSendSafetyFactor)*BigInt(this.options.bitcoinBlocktime),u=BigInt(Math.floor(Date.now()/1e3));if(n.getExpiry()>u+l)throw new o.IntermediaryError("Expiry time returned too high!");if(n.getAmount()!==t.total||n.getClaimHash()!==s||n.getType()!==a.ChainSwapType.CHAIN_NONCED||!n.isPayIn()||!n.isToken(e.token)||n.getClaimer()!==i.getAddress(this.chainIdentifier))throw new o.IntermediaryError("Invalid data returned")}create(t,e,i,n,a,s,o){var p,d;if(!this.isInitialized)throw Error("Not initialized, call init() first!");null!=a||(a={}),null!=(p=a).confirmationTarget||(p.confirmationTarget=3),null!=(d=a).confirmations||(d.confirmations=2);let f=this.getRandomNonce(),g=this.btcAddressToOutputScript(e),m=i.exactIn?null:this.contract.getHashForOnchain(g,i.amount,a.confirmations,f).toString("hex"),w=(0,u.extendAbortController)(o),y=this.preFetchPrice(i,w.signal),T=this.preFetchFeeRate(t,i,m,w);return n.map(n=>({intermediary:n,quote:(async()=>{let o=(0,u.extendAbortController)(w.signal),p=this.preFetchIntermediaryReputation(i,n,o);try{var d;let{signDataPromise:w,resp:S}=await (0,u.tryWithRetries)(async r=>{let{signDataPrefetch:l,response:u}=c.IntermediaryAPI.initToBTC(this.chainIdentifier,n.url,{btcAddress:e,amount:i.amount,confirmationTarget:a.confirmationTarget,confirmations:a.confirmations,nonce:f,token:i.token,offerer:t,exactIn:i.exactIn,feeRate:T,additionalParams:s},this.options.postRequestTimeout,o.signal,!(r>0)&&null);return{signDataPromise:this.preFetchSignData(l),resp:await u}},null,h.RequestError,o.signal),E=i.exactIn?this.contract.getHashForOnchain(g,S.amount,a.confirmations,f).toString("hex"):m,I=new this.swapDataDeserializer(S.data);I.setOfferer(t),this.verifyReturnedData(S,i,n,a,I,E);let[v,b,B]=await Promise.all([this.verifyReturnedPrice(n.services[l.SwapType.TO_BTC],!0,S.amount,I.getAmount(),i.token,S,y,o.signal),this.verifyReturnedSignature(t,I,S,T,w,o.signal),p]);o.signal.throwIfAborted(),n.reputation[i.token.toString()]=B;let A=new r.ToBTCSwap(this,{pricingInfo:v,url:n.url,expiry:b,swapFee:S.swapFee,feeRate:await T,signatureData:S,data:I,networkFee:S.networkFee,address:e,amount:S.amount,confirmationTarget:a.confirmationTarget,satsPerVByte:Number(S.satsPervByte),exactIn:null!=(d=i.exactIn)&&d,requiredConfirmations:a.confirmations,nonce:f});return await A._save(),A}catch(t){throw o.abort(t),t}})()}))}constructor(t,e,i,n,a,s,o,u,c,h,d){var f;null==h&&(h={}),h.bitcoinNetwork=null!=(f=h.bitcoinNetwork)?f:p.TEST_NETWORK,h.safetyFactor=h.safetyFactor||2,h.maxConfirmations=h.maxConfirmations||6,h.bitcoinBlocktime=h.bitcoinBlocktime||600,h.maxExpectedOnchainSendSafetyFactor=h.maxExpectedOnchainSendSafetyFactor||4,h.maxExpectedOnchainSendGracePeriodBlocks=h.maxExpectedOnchainSendGracePeriodBlocks||12,super(t,e,i,n,a,s,o,u,h,d),this.TYPE=l.SwapType.TO_BTC,this.swapDeserializer=r.ToBTCSwap,this.btcRpc=c}}i.ToBTCWrapper=d},318749,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.IFromBTCSwap=void 0;let r=t.r(958078),n=t.r(991989),a=t.r(768270),s=t.r(309959),o=t.r(44237);class l extends s.IEscrowSwap{tryRecomputeSwapPrice(){null==this.swapFeeBtc&&(this.swapFeeBtc=this.swapFee*this.getInput().rawAmount/this.getOutAmountWithoutFee()),super.tryRecomputeSwapPrice()}getSwapData(){return this.data}_getInitiator(){return this.getSwapData().getClaimer()}getOutputTxId(){return this.claimTxId}getOutputAddress(){return this._getInitiator()}requiresAction(){return this.isClaimable()}getOutAmountWithoutFee(){return this.getSwapData().getAmount()+this.swapFee}getSwapFee(){let t=1000000n*(this.swapFeeBtc-this.pricingInfo.satsBaseFee)/this.getInputWithoutFee().rawAmount;return{amountInSrcToken:(0,a.toTokenAmount)(this.swapFeeBtc,this.inputToken,this.wrapper.prices),amountInDstToken:(0,a.toTokenAmount)(this.swapFee,this.wrapper.tokens[this.getSwapData().getToken()],this.wrapper.prices),usdValue:(t,e)=>this.wrapper.prices.getBtcUsdValue(this.swapFeeBtc,t,e),composition:{base:(0,a.toTokenAmount)(this.pricingInfo.satsBaseFee,this.inputToken,this.wrapper.prices),percentage:(0,r.ppmToPercentage)(t)}}}getFee(){return this.getSwapFee()}getFeeBreakdown(){return[{type:o.FeeType.SWAP,fee:this.getSwapFee()}]}getOutput(){return(0,a.toTokenAmount)(this.getSwapData().getAmount(),this.wrapper.tokens[this.getSwapData().getToken()],this.wrapper.prices)}getInputWithoutFee(){return(0,a.toTokenAmount)(this.getInput().rawAmount-this.swapFeeBtc,this.inputToken,this.wrapper.prices)}getSecurityDeposit(){return(0,a.toTokenAmount)(this.getSwapData().getSecurityDeposit(),this.wrapper.getNativeToken(),this.wrapper.prices)}getTotalDeposit(){return(0,a.toTokenAmount)(this.getSwapData().getTotalDeposit(),this.wrapper.getNativeToken(),this.wrapper.prices)}async hasEnoughForTxFees(){let[t,e]=await Promise.all([this.wrapper.contract.getBalance(this._getInitiator(),this.wrapper.chain.getNativeCurrencyAddress(),!1),this.getCommitFee()]),i=e+this.getSwapData().getTotalDeposit();return{enoughBalance:t>=i,balance:(0,a.toTokenAmount)(t,this.wrapper.getNativeToken(),this.wrapper.prices),required:(0,a.toTokenAmount)(i,this.wrapper.getNativeToken(),this.wrapper.prices)}}async txsCommit(t){if(!this.canCommit())throw Error("Must be in CREATED state!");return this.initiated||(this.initiated=!0,await this._saveAndEmit()),await this.wrapper.contract.txsInit(this._getInitiator(),this.data,this.signatureData,t,this.feeRate).catch(t=>Promise.reject(t instanceof n.SignatureVerificationError?Error("Request timed out"):t))}getClaimFee(){return this.wrapper.contract.getClaimFee(this._getInitiator(),this.getSwapData())}constructor(t,e){super(t,e)}}i.IFromBTCSwap=l},557456,(t,e,i)=>{"use strict";var r;Object.defineProperty(i,"__esModule",{value:!0}),i.FromBTCLNSwap=i.isFromBTCLNSwapInit=i.FromBTCLNSwapState=void 0;let n=t.r(20349),a=t.r(318749),s=t.r(865854),o=t.r(991989),l=t.r(843943),u=t.r(54111),c=t.r(17061),h=t.r(366913),p=t.r(145617),d=t.r(559766),f=t.r(768270),g=t.r(309959);function m(t){return"string"==typeof t.pr&&"string"==typeof t.secret&&(null==t.lnurl||"string"==typeof t.lnurl)&&(null==t.lnurlK1||"string"==typeof t.lnurlK1)&&(null==t.lnurlCallback||"string"==typeof t.lnurlCallback)&&(0,g.isIEscrowSwapInit)(t)}!function(t){t[t.FAILED=-4]="FAILED",t[t.QUOTE_EXPIRED=-3]="QUOTE_EXPIRED",t[t.QUOTE_SOFT_EXPIRED=-2]="QUOTE_SOFT_EXPIRED",t[t.EXPIRED=-1]="EXPIRED",t[t.PR_CREATED=0]="PR_CREATED",t[t.PR_PAID=1]="PR_PAID",t[t.CLAIM_COMMITED=2]="CLAIM_COMMITED",t[t.CLAIM_CLAIMED=3]="CLAIM_CLAIMED"}(r=i.FromBTCLNSwapState||(i.FromBTCLNSwapState={})),i.isFromBTCLNSwapInit=m;class w extends a.IFromBTCSwap{getSwapData(){var t;return null!=(t=this.data)?t:this.initialSwapData}upgradeVersion(){if(null==this.version){switch(this.state){case -2:this.state=r.QUOTE_EXPIRED;break;case -1:this.state=r.FAILED;break;case 0:this.state=r.PR_CREATED;break;case 1:this.state=r.PR_PAID;break;case 2:this.state=r.CLAIM_COMMITED;break;case 3:this.state=r.CLAIM_CLAIMED}this.version=1}}getIdentifierHash(){let t=this.getPaymentHash();return null==this.randomNonce?t:l.Buffer.concat([t,l.Buffer.from(this.randomNonce,"hex")])}getPaymentHash(){if(null==this.pr)return null;let t=(0,n.decode)(this.pr);return l.Buffer.from(t.tagsObject.payment_hash,"hex")}canCommit(){return this.state===r.PR_PAID}getInputTxId(){return this.getPaymentHash().toString("hex")}getAddress(){return this.pr}getHyperlink(){return"lightning:"+this.pr.toUpperCase()}getTimeoutTime(){return null==this.pr?null:1e3*(0,n.decode)(this.pr).timeExpireDate}getHtlcTimeoutTime(){return 1e3*Number(this.wrapper.getHtlcTimeout(this.data))}isFinished(){return this.state===r.CLAIM_CLAIMED||this.state===r.QUOTE_EXPIRED||this.state===r.FAILED}isClaimable(){return this.state===r.PR_PAID||this.state===r.CLAIM_COMMITED}isSuccessful(){return this.state===r.CLAIM_CLAIMED}isFailed(){return this.state===r.FAILED||this.state===r.EXPIRED}isQuoteExpired(){return this.state===r.QUOTE_EXPIRED}isQuoteSoftExpired(){return this.state===r.QUOTE_EXPIRED||this.state===r.QUOTE_SOFT_EXPIRED}verifyQuoteValid(){return this.state===r.PR_CREATED||this.state===r.QUOTE_SOFT_EXPIRED&&null==this.signatureData?Promise.resolve(this.getTimeoutTime()>Date.now()):super.verifyQuoteValid()}getInput(){let t=(BigInt((0,n.decode)(this.pr).millisatoshis)+999n)/1000n;return(0,f.toTokenAmount)(t,this.inputToken,this.wrapper.prices)}async getSmartChainNetworkFee(){return(0,f.toTokenAmount)(await this.getCommitAndClaimFee(),this.wrapper.getNativeToken(),this.wrapper.prices)}async hasEnoughForTxFees(){let[t,e]=await Promise.all([this.wrapper.contract.getBalance(this._getInitiator(),this.wrapper.chain.getNativeCurrencyAddress(),!1),null!=this.feeRate?Promise.resolve(this.feeRate):this.wrapper.contract.getInitFeeRate(this.getSwapData().getOfferer(),this.getSwapData().getClaimer(),this.getSwapData().getToken(),this.getSwapData().getClaimHash())]),i=await this.wrapper.contract.getCommitFee(this.getSwapData(),e)+await this.wrapper.contract.getClaimFee(this._getInitiator(),this.getSwapData(),e)+this.getSwapData().getTotalDeposit();return{enoughBalance:t>=i,balance:(0,f.toTokenAmount)(t,this.wrapper.getNativeToken(),this.wrapper.prices),required:(0,f.toTokenAmount)(i,this.wrapper.getNativeToken(),this.wrapper.prices)}}async checkIntermediaryPaymentReceived(){let t=!(arguments.length>0)||void 0===arguments[0]||arguments[0];if(this.state===r.PR_PAID||this.state===r.CLAIM_COMMITED||this.state===r.CLAIM_CLAIMED||this.state===r.FAILED)return!0;if(this.state===r.QUOTE_EXPIRED||this.state===r.QUOTE_SOFT_EXPIRED&&null!=this.signatureData)return!1;let e=await h.IntermediaryAPI.getPaymentAuthorization(this.url,this.getPaymentHash().toString("hex"));switch(e.code){case h.PaymentAuthorizationResponseCodes.AUTH_DATA:let i=new this.wrapper.swapDataDeserializer(e.data.data);try{return await this.checkIntermediaryReturnedAuthData(this._getInitiator(),i,e.data),this.expiry=await (0,d.tryWithRetries)(()=>this.wrapper.contract.getInitAuthorizationExpiry(i,e.data)),this.state=r.PR_PAID,delete this.initialSwapData,this.data=i,this.signatureData={prefix:e.data.prefix,timeout:e.data.timeout,signature:e.data.signature},this.initiated=!0,t&&await this._saveAndEmit(),!0}catch(t){}return null;case h.PaymentAuthorizationResponseCodes.EXPIRED:return this.state=r.QUOTE_EXPIRED,this.initiated=!0,t&&await this._saveAndEmit(),!1;default:return null}}async checkIntermediaryReturnedAuthData(t,e,i){if(e.setClaimer(t),e.getOfferer()!==this.getSwapData().getOfferer())throw new p.IntermediaryError("Invalid offerer used");if(!e.isToken(this.getSwapData().getToken()))throw new p.IntermediaryError("Invalid token used");if(e.getSecurityDeposit()>this.getSwapData().getSecurityDeposit())throw new p.IntermediaryError("Invalid security deposit!");if(e.getAmount()<this.getSwapData().getAmount())throw new p.IntermediaryError("Invalid amount received!");if(e.getClaimHash()!==this.getSwapData().getClaimHash())throw new p.IntermediaryError("Invalid payment hash used!");if(!e.isDepositToken(this.getSwapData().getDepositToken()))throw new p.IntermediaryError("Invalid deposit token used!");await Promise.all([(0,d.tryWithRetries)(()=>this.wrapper.contract.isValidInitAuthorization(this._getInitiator(),e,i,this.feeRate),null,o.SignatureVerificationError),(0,d.tryWithRetries)(()=>this.wrapper.contract.getCommitStatus(e.getClaimer(),e)).then(t=>{if((null==t?void 0:t.type)!==o.SwapCommitStateType.NOT_COMMITED)throw Error("Swap already committed on-chain!")})])}async waitForPayment(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5;if(this.state!==r.PR_CREATED&&(this.state!==r.QUOTE_SOFT_EXPIRED||null!=this.signatureData))throw Error("Must be in PR_CREATED state!");let i=new AbortController;null!=t&&t.addEventListener("abort",()=>i.abort(t.reason));let n=!1;null!=this.lnurl&&!this.prPosted&&(u.LNURL.postInvoiceToLNURLWithdraw({k1:this.lnurlK1,callback:this.lnurlCallback},this.pr).catch(t=>{this.lnurlFailSignal.abort(t)}),this.prPosted=!0,n||(n=!0)),!this.initiated&&(this.initiated=!0,n||(n=!0)),n&&await this._saveAndEmit();let a=()=>i.abort(this.lnurlFailSignal.signal.reason);this.lnurlFailSignal.signal.addEventListener("abort",a),this.lnurlFailSignal.signal.throwIfAborted();let s={code:h.PaymentAuthorizationResponseCodes.PENDING,msg:""};for(;!i.signal.aborted&&s.code===h.PaymentAuthorizationResponseCodes.PENDING;)(s=await h.IntermediaryAPI.getPaymentAuthorization(this.url,this.getPaymentHash().toString("hex"))).code===h.PaymentAuthorizationResponseCodes.PENDING&&await (0,d.timeoutPromise)(1e3*e,i.signal);if(this.lnurlFailSignal.signal.removeEventListener("abort",a),i.signal.throwIfAborted(),s.code===h.PaymentAuthorizationResponseCodes.AUTH_DATA){let t=s.data,e=new this.wrapper.swapDataDeserializer(s.data.data);return await this.checkIntermediaryReturnedAuthData(this._getInitiator(),e,t),this.expiry=await (0,d.tryWithRetries)(()=>this.wrapper.contract.getInitAuthorizationExpiry(e,t)),(this.state===r.PR_CREATED||this.state===r.QUOTE_SOFT_EXPIRED)&&(delete this.initialSwapData,this.data=e,this.signatureData={prefix:t.prefix,timeout:t.timeout,signature:t.signature},await this._saveAndEmit(r.PR_PAID)),!0}if(this.state===r.PR_CREATED||this.state===r.QUOTE_SOFT_EXPIRED)return s.code===h.PaymentAuthorizationResponseCodes.EXPIRED&&await this._saveAndEmit(r.QUOTE_EXPIRED),!1}async commit(t,e,i){this.checkSigner(t);let n=await this.wrapper.chain.sendAndConfirm(t,await this.txsCommit(i),!0,e);return this.commitTxId=n[0],(this.state===r.PR_PAID||this.state===r.QUOTE_SOFT_EXPIRED)&&await this._saveAndEmit(r.CLAIM_COMMITED),n[0]}async waitTillCommited(t){if(this.state===r.CLAIM_COMMITED||this.state===r.CLAIM_CLAIMED)return Promise.resolve();if(this.state!==r.PR_PAID&&this.state!==r.QUOTE_SOFT_EXPIRED&&null!=this.signatureData)throw Error("Invalid state");let e=(0,d.extendAbortController)(t),i=await Promise.race([this.watchdogWaitTillCommited(e.signal),this.waitTillState(r.CLAIM_COMMITED,"gte",e.signal).then(()=>0)]);if(e.abort(),0===i&&this.logger.debug("waitTillCommited(): Resolved from state changed"),!0===i&&this.logger.debug("waitTillCommited(): Resolved from watchdog - commited"),!1===i){this.logger.debug("waitTillCommited(): Resolved from watchdog - signature expired"),(this.state===r.PR_PAID||this.state===r.QUOTE_SOFT_EXPIRED)&&await this._saveAndEmit(r.QUOTE_EXPIRED);return}(this.state===r.PR_PAID||this.state===r.QUOTE_SOFT_EXPIRED)&&await this._saveAndEmit(r.CLAIM_COMMITED)}txsClaim(t){if(this.state!==r.CLAIM_COMMITED)throw Error("Must be in CLAIM_COMMITED state!");return this.wrapper.contract.txsClaimWithSecret(null!=t?t:this._getInitiator(),this.data,this.secret,!0,!0)}async claim(t,e){let i=await this.wrapper.chain.sendAndConfirm(t,await this.txsClaim(),!0,e);return this.claimTxId=i[0],(r.CLAIM_COMMITED||r.EXPIRED||r.FAILED)&&await this._saveAndEmit(r.CLAIM_CLAIMED),i[0]}async waitTillClaimed(t){if(this.state===r.CLAIM_CLAIMED)return Promise.resolve();if(this.state!==r.CLAIM_COMMITED)throw Error("Invalid state (not CLAIM_COMMITED)");let e=new AbortController;null!=t&&t.addEventListener("abort",()=>e.abort(t.reason));let i=await Promise.race([this.watchdogWaitTillResult(e.signal),this.waitTillState(r.CLAIM_CLAIMED,"eq",e.signal).then(()=>0),this.waitTillState(r.EXPIRED,"eq",e.signal).then(()=>1)]);if(e.abort(),0===i)return void this.logger.debug("waitTillClaimed(): Resolved from state change (CLAIM_CLAIMED)");if(1===i)throw this.logger.debug("waitTillClaimed(): Resolved from state change (EXPIRED)"),Error("Swap expired during claiming");this.logger.debug("waitTillClaimed(): Resolved from watchdog"),(null==i?void 0:i.type)===o.SwapCommitStateType.PAID&&this.state!==r.CLAIM_CLAIMED&&(this.claimTxId=await i.getClaimTxId(),await this._saveAndEmit(r.CLAIM_CLAIMED)),((null==i?void 0:i.type)===o.SwapCommitStateType.NOT_COMMITED||(null==i?void 0:i.type)===o.SwapCommitStateType.EXPIRED)&&this.state!==r.CLAIM_CLAIMED&&this.state!==r.FAILED&&(this.refundTxId=null==i.getRefundTxId?null:await i.getRefundTxId(),await this._saveAndEmit(r.FAILED))}async getCommitAndClaimFee(){var t;let e=this.wrapper.contract,i=null!=(t=this.feeRate)?t:await e.getInitFeeRate(this.getSwapData().getOfferer(),this.getSwapData().getClaimer(),this.getSwapData().getToken(),this.getSwapData().getClaimHash());return await (null!=e.getRawCommitFee?e.getRawCommitFee(this.getSwapData(),i):e.getCommitFee(this.getSwapData(),i))+await (null!=e.getRawClaimFee?e.getRawClaimFee(this._getInitiator(),this.getSwapData(),i):e.getClaimFee(this._getInitiator(),this.getSwapData(),i))}canCommitAndClaimInOneShot(){return null!=this.wrapper.contract.initAndClaimWithSecret}async txsCommitAndClaim(t){if(this.state===r.CLAIM_COMMITED)return await this.txsClaim();if(this.state!==r.PR_PAID&&(this.state!==r.QUOTE_SOFT_EXPIRED||null==this.signatureData))throw Error("Must be in PR_PAID state!");let e=await this.txsCommit(t),i=await this.wrapper.contract.txsClaimWithSecret(this._getInitiator(),this.data,this.secret,!0,!0,null,!0);return e.concat(i)}async commitAndClaim(t,e,i){if(!this.canCommitAndClaimInOneShot())throw Error("Cannot commitAndClaim in single action, please run commit and claim separately!");if(this.checkSigner(t),this.state===r.CLAIM_COMMITED)return[null,await this.claim(t)];let n=await this.wrapper.chain.sendAndConfirm(t,await this.txsCommitAndClaim(i),!0,e);return this.commitTxId=n[0]||this.commitTxId,this.claimTxId=n[n.length-1]||this.claimTxId,this.state!==r.CLAIM_CLAIMED&&await this._saveAndEmit(r.CLAIM_CLAIMED),n}isLNURL(){return null!=this.lnurl}getLNURL(){return this.lnurl}async settleWithLNURLWithdraw(t){let e;if(null!=this.lnurl)throw Error("Cannot settle LNURL-withdraw swap with different LNURL");if("string"==typeof t){let i=await u.LNURL.getLNURL(t);if(null==i||"withdrawRequest"!==i.tag)throw new c.UserError("Invalid LNURL-withdraw to settle the swap");e=i}else e=t.params;u.LNURL.useLNURLWithdraw(e,this.pr).catch(t=>this.lnurlFailSignal.abort(t)),this.lnurl=e.url,this.lnurlCallback=e.callback,this.lnurlK1=e.k1,this.prPosted=!0,await this._saveAndEmit()}serialize(){return{...super.serialize(),pr:this.pr,secret:this.secret,lnurl:this.lnurl,lnurlK1:this.lnurlK1,lnurlCallback:this.lnurlCallback,prPosted:this.prPosted,initialSwapData:null==this.initialSwapData?null:this.initialSwapData.serialize()}}async syncStateFromChain(){let t=!1;if((this.state===r.PR_PAID||this.state===r.QUOTE_SOFT_EXPIRED&&null!=this.signatureData)&&(t=await this.verifyQuoteDefinitelyExpired()),this.state===r.CLAIM_COMMITED||this.state===r.EXPIRED){let t=await (0,d.tryWithRetries)(()=>this.wrapper.contract.getCommitStatus(this._getInitiator(),this.data));if((null==t?void 0:t.type)===o.SwapCommitStateType.PAID)return null==this.claimTxId&&(this.claimTxId=await t.getClaimTxId()),this.state=r.CLAIM_CLAIMED,!0;if((null==t?void 0:t.type)===o.SwapCommitStateType.NOT_COMMITED||(null==t?void 0:t.type)===o.SwapCommitStateType.EXPIRED)return null==this.refundTxId&&t.getRefundTxId&&(this.refundTxId=await t.getRefundTxId()),this.state=r.FAILED,!0}if(this.state===r.PR_PAID||this.state===r.QUOTE_SOFT_EXPIRED&&null!=this.signatureData){let t=await (0,d.tryWithRetries)(()=>this.wrapper.contract.getCommitStatus(this._getInitiator(),this.data));switch(null==t?void 0:t.type){case o.SwapCommitStateType.COMMITED:return this.state=r.CLAIM_COMMITED,!0;case o.SwapCommitStateType.EXPIRED:return null==this.refundTxId&&t.getRefundTxId&&(this.refundTxId=await t.getRefundTxId()),this.state=r.QUOTE_EXPIRED,!0;case o.SwapCommitStateType.PAID:return null==this.claimTxId&&(this.claimTxId=await t.getClaimTxId()),this.state=r.CLAIM_CLAIMED,!0}}if((this.state===r.PR_PAID||this.state===r.QUOTE_SOFT_EXPIRED&&null!=this.signatureData)&&t)return this.state=r.QUOTE_EXPIRED,!0}async _sync(t){let e=!1;return(this.state===r.PR_CREATED||this.state===r.QUOTE_SOFT_EXPIRED&&null==this.signatureData)&&(this.getTimeoutTime()<Date.now()&&(this.state=r.QUOTE_SOFT_EXPIRED,e||(e=!0)),null!==await this.checkIntermediaryPaymentReceived(!1)&&(e||(e=!0))),await this.syncStateFromChain()&&(e=!0),t&&e&&await this._saveAndEmit(),e}async _tick(t){switch(this.state){case r.PR_CREATED:if(this.getTimeoutTime()<Date.now())return this.state=r.QUOTE_SOFT_EXPIRED,t&&await this._saveAndEmit(),!0;break;case r.PR_PAID:if(this.expiry<Date.now())return this.state=r.QUOTE_SOFT_EXPIRED,t&&await this._saveAndEmit(),!0;break;case r.CLAIM_COMMITED:if(await this.wrapper.contract.isExpired(this._getInitiator(),this.data))return this.state=r.EXPIRED,t&&await this._saveAndEmit(),!0}}constructor(t,e){m(e)&&(e.url+="/frombtcln"),super(t,e),this.inputToken=f.BitcoinTokens.BTCLN,this.TYPE=s.SwapType.FROM_BTCLN,this.lnurlFailSignal=new AbortController,this.prPosted=!1,m(e)?this.state=r.PR_CREATED:(this.pr=e.pr,this.secret=e.secret,this.initialSwapData=null==e.initialSwapData?null:o.SwapData.deserialize(e.initialSwapData),this.lnurl=e.lnurl,this.lnurlK1=e.lnurlK1,this.lnurlCallback=e.lnurlCallback,this.prPosted=e.prPosted,this.state===r.PR_CREATED&&null!=this.data&&(this.initialSwapData=this.data,delete this.data)),this.tryRecomputeSwapPrice(),this.logger=(0,d.getLogger)("FromBTCLN("+this.getIdentifierHashString()+"): ")}}i.FromBTCLNSwap=w},305822,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.IFromBTCWrapper=void 0;let r=t.r(145617),n=t.r(559766),a=t.r(991989),s=t.r(387951);class o extends s.IEscrowSwapWrapper{getRandomSequence(){return a.BigIntBufferUtils.fromBuffer((0,n.randomBytes)(8))}preFetchFeeRate(t,e,i,r){return(0,n.tryWithRetries)(()=>this.contract.getInitFeeRate(null,t,e.token,i),null,null,r.signal).catch(t=>(this.logger.warn("preFetchFeeRate(): Error: ",t),r.abort(t),null))}preFetchIntermediaryLiquidity(t,e,i){return e.getLiquidity(this.chainIdentifier,this.contract,t.token.toString(),i.signal).catch(t=>(this.logger.warn("preFetchIntermediaryLiquidity(): Error: ",t),i.abort(t),null))}async verifyIntermediaryLiquidity(t,e){if(await e<t)throw new r.IntermediaryError("Intermediary doesn't have enough liquidity")}}i.IFromBTCWrapper=o},321182,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.FromBTCLNWrapper=void 0;let r=t.r(557456),n=t.r(305822),a=t.r(20349),s=t.r(991989),o=t.r(843943),l=t.r(17061),u=t.r(14582),c=t.r(145617),h=t.r(865854),p=t.r(559766),d=t.r(366913),f=t.r(686157),g=t.r(54111);class m extends n.IFromBTCWrapper{processEventInitialize(t,e){return t.state===r.FromBTCLNSwapState.PR_PAID||t.state===r.FromBTCLNSwapState.QUOTE_SOFT_EXPIRED?(t.state=r.FromBTCLNSwapState.CLAIM_COMMITED,Promise.resolve(!0)):Promise.resolve(!1)}processEventClaim(t,e){return t.state!==r.FromBTCLNSwapState.FAILED&&t.state!==r.FromBTCLNSwapState.CLAIM_CLAIMED?(t.state=r.FromBTCLNSwapState.CLAIM_CLAIMED,Promise.resolve(!0)):Promise.resolve(!1)}processEventRefund(t,e){return t.state!==r.FromBTCLNSwapState.CLAIM_CLAIMED&&t.state!==r.FromBTCLNSwapState.FAILED?(t.state=r.FromBTCLNSwapState.FAILED,Promise.resolve(!0)):Promise.resolve(!1)}getHtlcTimeout(t){return t.getExpiry()-600n}getSecretAndHash(){let t=(0,p.randomBytes)(32),e=o.Buffer.from((0,u.sha256)(t));return{secret:t,paymentHash:e}}preFetchLnCapacity(t){return t.then(t=>null==t?null:this.lnApi.getLNNodeLiquidity(t)).catch(t=>(this.logger.warn("preFetchLnCapacity(): Error: ",t),null))}verifyReturnedData(t,e,i,r,n,a){if(i.getAddress(this.chainIdentifier)!==t.intermediaryKey)throw new c.IntermediaryError("Invalid intermediary address/pubkey");if(null!=r.descriptionHash&&n.tagsObject.purpose_commit_hash!==r.descriptionHash.toString("hex"))throw new c.IntermediaryError("Invalid pr returned - description hash");if(e.exactIn){if(a!==e.amount)throw new c.IntermediaryError("Invalid payment request returned, amount mismatch")}else if(t.total!=e.amount)throw new c.IntermediaryError("Invalid amount returned")}async verifyLnNodeCapacity(t,e,i,r,n){let a=null==r?null:await r;if(null==a&&(a=await this.lnApi.getLNNodeLiquidity(e.payeeNodeKey)),null!=n&&n.throwIfAborted(),null===a)throw new c.IntermediaryError("LP's lightning node not found in the lightning network graph!");if(t.lnData=a,e.payeeNodeKey!==a.publicKey)throw new c.IntermediaryError("Invalid pr returned - payee pubkey");if(a.capacity<i)throw new c.IntermediaryError("LP's lightning node doesn't have enough inbound capacity for the swap!");if(a.capacity/2n<i)throw Error("LP's lightning node probably doesn't have enough inbound capacity for the swap!")}create(t,e,i,n,o,u,c){var g,m,w;if(null==n&&(n={}),null!=(g=n).unsafeSkipLnNodeCheck||(g.unsafeSkipLnNodeCheck=this.options.unsafeSkipLnNodeCheck),null==c&&(c={}),null!=n.descriptionHash&&32!==n.descriptionHash.length)throw new l.UserError("Invalid description hash length");let{secret:y,paymentHash:T}=this.getSecretAndHash(),S=this.contract.getHashForHtlc(T),E=(0,p.extendAbortController)(u);null!=(m=c).pricePrefetchPromise||(m.pricePrefetchPromise=this.preFetchPrice(e,E.signal));let I=this.chain.getNativeCurrencyAddress();return null!=(w=c).feeRatePromise||(w.feeRatePromise=this.preFetchFeeRate(t,e,S.toString("hex"),E)),i.map(i=>({intermediary:i,quote:(async()=>{let l=(0,p.extendAbortController)(E.signal),u=this.preFetchIntermediaryLiquidity(e,i,l),{lnCapacityPromise:g,resp:m}=await (0,p.tryWithRetries)(async r=>{let{lnPublicKey:a,response:s}=d.IntermediaryAPI.initFromBTCLN(this.chainIdentifier,i.url,I,{paymentHash:T,amount:e.amount,claimer:t,token:e.token.toString(),descriptionHash:n.descriptionHash,exactOut:!e.exactIn,feeRate:c.feeRatePromise,additionalParams:o},this.options.postRequestTimeout,l.signal,!(r>0)&&null);return{lnCapacityPromise:n.unsafeSkipLnNodeCheck?null:this.preFetchLnCapacity(a),resp:await s}},null,f.RequestError,l.signal),w=(0,a.decode)(m.pr),v=(BigInt(w.millisatoshis)+999n)/1000n;try{var b;this.verifyReturnedData(m,e,i,n,w,v);let[a]=await Promise.all([this.verifyReturnedPrice(i.services[h.SwapType.FROM_BTCLN],!1,v,m.total,e.token,{},c.pricePrefetchPromise,l.signal),this.verifyIntermediaryLiquidity(m.total,u),n.unsafeSkipLnNodeCheck?Promise.resolve():this.verifyLnNodeCapacity(i,w,v,g,l.signal)]),o=new r.FromBTCLNSwap(this,{pricingInfo:a,url:i.url,expiry:1e3*w.timeExpireDate,swapFee:m.swapFee,feeRate:await c.feeRatePromise,initialSwapData:await this.contract.createSwapData(s.ChainSwapType.HTLC,i.getAddress(this.chainIdentifier),t,e.token,m.total,S.toString("hex"),this.getRandomSequence(),BigInt(Math.floor(Date.now()/1e3)),!1,!0,m.securityDeposit,0n,I),pr:m.pr,secret:y.toString("hex"),exactIn:null==(b=e.exactIn)||b});return await o._save(),o}catch(t){throw l.abort(t),t}})()}))}async getLNURLWithdraw(t,e){if("string"!=typeof t)return t;let i=await g.LNURL.getLNURL(t,!0,this.options.getRequestTimeout,e);if(null==i)throw new l.UserError("Invalid LNURL");if("withdrawRequest"!==i.tag)throw new l.UserError("Not a LNURL-withdrawal");return i}async createViaLNURL(t,e,i,r,n,a){if(!this.isInitialized)throw Error("Not initialized, call init() first!");let s=(0,p.extendAbortController)(a),o={pricePrefetchPromise:this.preFetchPrice(i,s.signal),feeRatePromise:this.preFetchFeeRate(t,i,null,s)};try{let u=i.exactIn?null:o.pricePrefetchPromise.then(t=>this.prices.getToBtcSwapAmount(this.chainIdentifier,i.amount,i.token,s.signal,t)).catch(t=>(s.abort(t),null)),c=await this.getLNURLWithdraw(e,s.signal),h=BigInt(c.minWithdrawable)/1000n,p=BigInt(c.maxWithdrawable)/1000n;if(i.exactIn){if(i.amount<h)throw new l.UserError("Amount less than LNURL-withdraw minimum");if(i.amount>p)throw new l.UserError("Amount more than LNURL-withdraw maximum")}else{let t=await u;if(s.signal.throwIfAborted(),95n*t/100n<h)throw new l.UserError("Amount less than LNURL-withdraw minimum");if(105n*t/100n>p)throw new l.UserError("Amount more than LNURL-withdraw maximum")}return this.create(t,i,r,null,n,a,o).map(t=>({quote:t.quote.then(t=>{t.lnurl=c.url,t.lnurlK1=c.k1,t.lnurlCallback=c.callback;let e=t.getInput().rawAmount;if(e<h)throw new l.UserError("Amount less than LNURL-withdraw minimum");if(e>p)throw new l.UserError("Amount more than LNURL-withdraw maximum");return t}),intermediary:t.intermediary}))}catch(t){throw s.abort(t),t}}constructor(t,e,i,n,a,s,o,l,u,c,p){super(t,e,i,n,a,s,o,l,c,p),this.TYPE=h.SwapType.FROM_BTCLN,this.swapDeserializer=r.FromBTCLNSwap,this.pendingSwapStates=[r.FromBTCLNSwapState.PR_CREATED,r.FromBTCLNSwapState.QUOTE_SOFT_EXPIRED,r.FromBTCLNSwapState.PR_PAID,r.FromBTCLNSwapState.CLAIM_COMMITED,r.FromBTCLNSwapState.EXPIRED],this.tickSwapState=[r.FromBTCLNSwapState.PR_CREATED,r.FromBTCLNSwapState.PR_PAID,r.FromBTCLNSwapState.CLAIM_COMMITED],this.lnApi=u}}i.FromBTCLNWrapper=m},912126,(t,e,i)=>{"use strict";var r;Object.defineProperty(i,"__esModule",{value:!0}),i.FromBTCSwap=i.isFromBTCSwapInit=i.FromBTCSwapState=void 0;let n=t.r(318749),a=t.r(865854),s=t.r(991989),o=t.r(843943),l=t.r(768270),u=t.r(559766),c=t.r(309959),h=t.r(548760),p=t.r(960474),d=t.r(902866);function f(t){return"string"==typeof t.address&&"bigint"==typeof t.amount&&(0,c.isIEscrowSwapInit)(t)}!function(t){t[t.FAILED=-4]="FAILED",t[t.EXPIRED=-3]="EXPIRED",t[t.QUOTE_EXPIRED=-2]="QUOTE_EXPIRED",t[t.QUOTE_SOFT_EXPIRED=-1]="QUOTE_SOFT_EXPIRED",t[t.PR_CREATED=0]="PR_CREATED",t[t.CLAIM_COMMITED=1]="CLAIM_COMMITED",t[t.BTC_TX_CONFIRMED=2]="BTC_TX_CONFIRMED",t[t.CLAIM_CLAIMED=3]="CLAIM_CLAIMED"}(r=i.FromBTCSwapState||(i.FromBTCSwapState={})),i.isFromBTCSwapInit=f;class g extends n.IFromBTCSwap{upgradeVersion(){if(null==this.version){switch(this.state){case -2:this.state=r.FAILED;break;case -1:this.state=r.QUOTE_EXPIRED;break;case 0:this.state=r.PR_CREATED;break;case 1:this.state=r.CLAIM_COMMITED;break;case 2:this.state=r.BTC_TX_CONFIRMED;break;case 3:this.state=r.CLAIM_CLAIMED}this.version=1}}getAddress(){return this.state===r.PR_CREATED?null:this.address}getHyperlink(){return this.state===r.PR_CREATED?null:"bitcoin:"+this.address+"?amount="+encodeURIComponent((Number(this.amount)/1e8).toString(10))}getInputTxId(){return this.txId}getTimeoutTime(){return 1e3*Number(this.wrapper.getOnchainSendTimeout(this.data,this.requiredConfirmations))}requiresAction(){return this.isClaimable()||this.state===r.CLAIM_COMMITED&&this.getTimeoutTime()>Date.now()}isFinished(){return this.state===r.CLAIM_CLAIMED||this.state===r.QUOTE_EXPIRED||this.state===r.FAILED}isClaimable(){return this.state===r.BTC_TX_CONFIRMED}isSuccessful(){return this.state===r.CLAIM_CLAIMED}isFailed(){return this.state===r.FAILED||this.state===r.EXPIRED&&null!=this.txId}isQuoteExpired(){return this.state===r.QUOTE_EXPIRED}isQuoteSoftExpired(){return this.state===r.QUOTE_EXPIRED||this.state===r.QUOTE_SOFT_EXPIRED}canCommit(){return this.state===r.PR_CREATED&&this.wrapper.getOnchainSendTimeout(this.data,this.requiredConfirmations)-BigInt(Math.floor(Date.now()/1e3))>=this.wrapper.options.minSendWindow}getInput(){return(0,l.toTokenAmount)(this.amount,this.inputToken,this.wrapper.prices)}getClaimerBounty(){return(0,l.toTokenAmount)(this.data.getClaimerBounty(),this.wrapper.tokens[this.data.getDepositToken()],this.wrapper.prices)}getRequiredConfirmationsCount(){return this.requiredConfirmations}async getBitcoinPayment(){let t=await this.wrapper.btcRpc.checkAddressTxos(this.address,o.Buffer.from(this.data.getTxoHashHint(),"hex"));return null==t?null:{txId:t.tx.txid,vout:t.vout,confirmations:t.tx.confirmations,targetConfirmations:this.requiredConfirmations}}async waitForBitcoinTransaction(t,e,i){if(this.state!==r.CLAIM_COMMITED&&this.state!==r.EXPIRED)throw Error("Must be in COMMITED state!");let n=await this.wrapper.btcRpc.waitForAddressTxo(this.address,o.Buffer.from(this.data.getTxoHashHint(),"hex"),this.requiredConfirmations,(t,e,r,n)=>{null!=i&&i(e,t,this.requiredConfirmations,n)},t,e);return null!=t&&t.throwIfAborted(),this.txId=n.tx.txid,this.vout=n.vout,this.state!==r.CLAIM_CLAIMED&&this.state!==r.FAILED&&(this.state=r.BTC_TX_CONFIRMED),await this._saveAndEmit(),n.tx.txid}async getFundedPsbt(t,e){let i;if(this.state!==r.CLAIM_COMMITED)throw Error("Swap not committed yet, please initiate the swap first with commit() call!");i=(0,h.isIBitcoinWallet)(t)?t:new d.SingleAddressBitcoinWallet(this.wrapper.btcRpc,this.wrapper.options.bitcoinNetwork,t),null==e&&(e=await i.getFeeRate());let n=new p.Transaction({allowUnknownOutputs:!0,allowLegacyWitnessUtxo:!0});n.addOutput({amount:this.amount,script:(0,u.toOutputScript)(this.wrapper.options.bitcoinNetwork,this.address)});let a=await i.fundPsbt(n,e),s=[];for(let t=0;t<a.inputsLength;t++)s.push(t);return{psbt:a,signInputs:s}}async submitPsbt(t){if(this.state!==r.CLAIM_COMMITED)throw Error("Swap not committed yet, please initiate the swap first with commit() call!");if(this.getTimeoutTime()<Date.now())throw Error("Swap address expired!");let e=t.getOutput(0);if(e.amount!==this.amount)throw Error("PSBT output amount invalid, expected: "+this.amount+" got: "+e.amount);if(!(0,u.toOutputScript)(this.wrapper.options.bitcoinNetwork,this.address).equals(e.script))throw Error("PSBT output script invalid!");return t.isFinal||t.finalize(),await this.wrapper.btcRpc.sendRawTransaction(o.Buffer.from(t.toBytes(!0,!0)).toString("hex"))}async estimateBitcoinFee(t,e){let i=await t.getTransactionFee(this.address,this.amount,e);return(0,l.toTokenAmount)(null==i?null:BigInt(i),l.BitcoinTokens.BTC,this.wrapper.prices)}async sendBitcoinTransaction(t,e){if(this.state!==r.CLAIM_COMMITED)throw Error("Swap not committed yet, please initiate the swap first with commit() call!");return await t.sendTransaction(this.address,this.amount,e)}async commit(t,e,i){this.checkSigner(t);let n=await this.wrapper.chain.sendAndConfirm(t,await this.txsCommit(i),!0,e);return this.commitTxId=n[0],(this.state===r.PR_CREATED||this.state===r.QUOTE_SOFT_EXPIRED)&&await this._saveAndEmit(r.CLAIM_COMMITED),n[0]}async waitTillCommited(t){if(this.state===r.CLAIM_COMMITED||this.state===r.CLAIM_CLAIMED)return Promise.resolve();if(this.state!==r.PR_CREATED&&this.state!==r.QUOTE_SOFT_EXPIRED)throw Error("Invalid state");let e=(0,u.extendAbortController)(t),i=await Promise.race([this.watchdogWaitTillCommited(e.signal),this.waitTillState(r.CLAIM_COMMITED,"gte",e.signal).then(()=>0)]);if(e.abort(),0===i&&this.logger.debug("waitTillCommited(): Resolved from state changed"),!0===i&&this.logger.debug("waitTillCommited(): Resolved from watchdog - commited"),!1===i){this.logger.debug("waitTillCommited(): Resolved from watchdog - signature expired"),(this.state===r.PR_CREATED||this.state===r.QUOTE_SOFT_EXPIRED)&&await this._saveAndEmit(r.QUOTE_EXPIRED);return}(this.state===r.PR_CREATED||this.state===r.QUOTE_SOFT_EXPIRED)&&await this._saveAndEmit(r.CLAIM_COMMITED)}async txsClaim(t){if(this.state!==r.BTC_TX_CONFIRMED)throw Error("Must be in BTC_TX_CONFIRMED state!");let e=await this.wrapper.btcRpc.getTransaction(this.txId);return await this.wrapper.contract.txsClaimWithTxData(null!=t?t:this._getInitiator(),this.data,{blockhash:e.blockhash,confirmations:e.confirmations,txid:e.txid,hex:e.hex,height:e.blockheight},this.requiredConfirmations,this.vout,null,this.wrapper.synchronizer,!0)}async claim(t,e){let i;try{i=await this.wrapper.chain.sendAndConfirm(t,await this.txsClaim(t),!0,e)}catch(e){if(this.logger.info("claim(): Failed to claim ourselves, checking swap claim state..."),this.state===r.CLAIM_CLAIMED)return this.logger.info("claim(): Transaction state is CLAIM_CLAIMED, swap was successfully claimed by the watchtower"),this.claimTxId;let t=await this.wrapper.contract.getCommitStatus(this._getInitiator(),this.data);if((null==t?void 0:t.type)===s.SwapCommitStateType.PAID)return this.logger.info("claim(): Transaction commit status is PAID, swap was successfully claimed by the watchtower"),null==this.claimTxId&&(this.claimTxId=await t.getClaimTxId()),await this._saveAndEmit(r.CLAIM_CLAIMED),this.claimTxId;throw e}return this.claimTxId=i[i.length-1],(this.state===r.CLAIM_COMMITED||this.state===r.BTC_TX_CONFIRMED||this.state===r.EXPIRED||this.state===r.FAILED)&&await this._saveAndEmit(r.CLAIM_CLAIMED),i[0]}async waitTillClaimed(t){if(this.state===r.CLAIM_CLAIMED)return Promise.resolve();if(this.state!==r.BTC_TX_CONFIRMED)throw Error("Invalid state (not BTC_TX_CONFIRMED)");let e=new AbortController;null!=t&&t.addEventListener("abort",()=>e.abort(t.reason));let i=await Promise.race([this.watchdogWaitTillResult(e.signal),this.waitTillState(r.CLAIM_CLAIMED,"eq",e.signal).then(()=>0),this.waitTillState(r.FAILED,"eq",e.signal).then(()=>1)]);if(e.abort(),0===i)return void this.logger.debug("waitTillClaimed(): Resolved from state change (CLAIM_CLAIMED)");if(1===i)throw this.logger.debug("waitTillClaimed(): Resolved from state change (FAILED)"),Error("Offerer refunded during claiming");this.logger.debug("waitTillClaimed(): Resolved from watchdog"),(null==i?void 0:i.type)===s.SwapCommitStateType.PAID&&this.state!==r.CLAIM_CLAIMED&&(this.claimTxId=await i.getClaimTxId(),await this._saveAndEmit(r.CLAIM_CLAIMED)),((null==i?void 0:i.type)===s.SwapCommitStateType.NOT_COMMITED||(null==i?void 0:i.type)===s.SwapCommitStateType.EXPIRED)&&this.state!==r.CLAIM_CLAIMED&&this.state!==r.FAILED&&(this.refundTxId=null==i.getRefundTxId?null:await i.getRefundTxId(),await this._saveAndEmit(r.FAILED))}serialize(){return{...super.serialize(),address:this.address,amount:this.amount.toString(10),requiredConfirmations:this.requiredConfirmations,txId:this.txId,vout:this.vout}}async syncStateFromChain(){if(this.state===r.PR_CREATED||this.state===r.QUOTE_SOFT_EXPIRED){let t=await this.verifyQuoteDefinitelyExpired(),e=await (0,u.tryWithRetries)(()=>this.wrapper.contract.getCommitStatus(this._getInitiator(),this.data));switch(null==e?void 0:e.type){case s.SwapCommitStateType.COMMITED:return this.state=r.CLAIM_COMMITED,!0;case s.SwapCommitStateType.EXPIRED:return null==this.refundTxId&&e.getRefundTxId&&(this.refundTxId=await e.getRefundTxId()),this.state=r.QUOTE_EXPIRED,!0;case s.SwapCommitStateType.PAID:return null==this.claimTxId&&(this.claimTxId=await e.getClaimTxId()),this.state=r.CLAIM_CLAIMED,!0}return!!t&&(this.state=r.QUOTE_EXPIRED,!0)}if(this.state===r.CLAIM_COMMITED||this.state===r.BTC_TX_CONFIRMED||this.state===r.EXPIRED){let t=await (0,u.tryWithRetries)(()=>this.wrapper.contract.getCommitStatus(this._getInitiator(),this.data));switch(null==t?void 0:t.type){case s.SwapCommitStateType.PAID:return null==this.claimTxId&&(this.claimTxId=await t.getClaimTxId()),this.state=r.CLAIM_CLAIMED,!0;case s.SwapCommitStateType.NOT_COMMITED:case s.SwapCommitStateType.EXPIRED:return null==this.refundTxId&&t.getRefundTxId&&(this.refundTxId=await t.getRefundTxId()),this.state=r.FAILED,!0;case s.SwapCommitStateType.COMMITED:let e=await this.getBitcoinPayment();if(null!=e&&e.confirmations>=this.requiredConfirmations)return this.txId=e.txId,this.vout=e.vout,this.state=r.BTC_TX_CONFIRMED,!0}}}async _sync(t){let e=await this.syncStateFromChain();return e&&t&&await this._saveAndEmit(),e}async _tick(t){switch(this.state){case r.PR_CREATED:if(this.expiry<Date.now())return this.state=r.QUOTE_SOFT_EXPIRED,t&&await this._saveAndEmit(),!0;break;case r.CLAIM_COMMITED:if(this.getTimeoutTime()<Date.now())return this.state=r.EXPIRED,t&&await this._saveAndEmit(),!0;case r.EXPIRED:if(Math.floor(Date.now()/1e3)%120==0)try{let e=await this.getBitcoinPayment();if(null!=e&&e.confirmations>=this.requiredConfirmations)return this.txId=e.txId,this.vout=e.vout,this.state=r.BTC_TX_CONFIRMED,t&&await this._saveAndEmit(),!0}catch(t){this.logger.warn("tickSwap("+this.getIdentifierHashString()+"): ",t)}}}constructor(t,e){if(f(e)&&(e.url+="/frombtc"),super(t,e),this.inputToken=l.BitcoinTokens.BTC,this.TYPE=a.SwapType.FROM_BTC,f(e))this.state=r.PR_CREATED;else{var i;this.address=e.address,this.amount=BigInt(e.amount),this.txId=e.txId,this.vout=e.vout,this.requiredConfirmations=null!=(i=e.requiredConfirmations)?i:this.data.getConfirmationsHint()}this.tryRecomputeSwapPrice(),this.logger=(0,u.getLogger)("FromBTC("+this.getIdentifierHashString()+"): ")}}i.FromBTCSwap=g},764557,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.FromBTCWrapper=void 0;let r=t.r(305822),n=t.r(912126),a=t.r(991989),s=t.r(843943),o=t.r(145617),l=t.r(865854),u=t.r(559766),c=t.r(366913),h=t.r(686157),p=t.r(446598);class d extends r.IFromBTCWrapper{processEventInitialize(t,e){return t.state===n.FromBTCSwapState.PR_CREATED||t.state===n.FromBTCSwapState.QUOTE_SOFT_EXPIRED?(t.state=n.FromBTCSwapState.CLAIM_COMMITED,Promise.resolve(!0)):Promise.resolve(!1)}processEventClaim(t,e){return t.state!==n.FromBTCSwapState.FAILED&&t.state!==n.FromBTCSwapState.CLAIM_CLAIMED?(t.state=n.FromBTCSwapState.CLAIM_CLAIMED,Promise.resolve(!0)):Promise.resolve(!1)}processEventRefund(t,e){return t.state!==n.FromBTCSwapState.CLAIM_CLAIMED&&t.state!==n.FromBTCSwapState.FAILED?(t.state=n.FromBTCSwapState.FAILED,Promise.resolve(!0)):Promise.resolve(!1)}getOnchainSendTimeout(t,e){let i=(this.options.blocksTillTxConfirms+e)*this.options.bitcoinBlocktime*this.options.safetyFactor;return t.getExpiry()-BigInt(i)}async preFetchClaimerBounty(t,e,i,r){let n=BigInt(Math.floor(Date.now()/1e3));if(i.unsafeZeroWatchtowerFee)return{feePerBlock:0n,safetyFactor:i.blockSafetyFactor,startTimestamp:n,addBlock:0,addFee:0n};let s=BigInt(Math.floor(0x1000000*Math.random())),o=await this.contract.createSwapData(a.ChainSwapType.CHAIN,t,t,e.token,s,this.contract.getHashForOnchain((0,u.randomBytes)(20),s,3).toString("hex"),this.getRandomSequence(),n,!1,!0,BigInt(Math.floor(65536*Math.random())),BigInt(Math.floor(65536*Math.random())));try{let[e,a,s,l]=await Promise.all([(0,u.tryWithRetries)(()=>this.btcRelay.getFeePerBlock(),null,null,r.signal),(0,u.tryWithRetries)(()=>this.btcRelay.getTipData(),null,null,r.signal),this.btcRpc.getTipHeight(),(0,u.tryWithRetries)(()=>this.contract.getClaimFee(t,o),null,null,r.signal)]),c=a.blockheight,h=Math.max(s-c,0);return{feePerBlock:e*i.feeSafetyFactor,safetyFactor:i.blockSafetyFactor,startTimestamp:n,addBlock:h,addFee:l*i.feeSafetyFactor}}catch(t){return r.abort(t),null}}getClaimerBounty(t,e,i){let r=(t.getExpiry()-i.startTimestamp)/BigInt(this.options.bitcoinBlocktime)*BigInt(e.blockSafetyFactor)+BigInt(i.addBlock);return i.addFee+r*i.feePerBlock}verifyReturnedData(t,e,i,r,n,c,h,p){var d;if(e.exactIn){if(t.amount!==e.amount)throw new o.IntermediaryError("Invalid amount returned")}else if(t.total!==e.amount)throw new o.IntermediaryError("Invalid total returned");let f=null!=(d=t.confirmations)?d:i.services[l.SwapType.FROM_BTC].data.confirmations;if(f>this.options.maxConfirmations)throw new o.IntermediaryError("Requires too many confirmations");let g=this.getClaimerBounty(n,r,h);if(n.getClaimerBounty()!==g||n.getType()!=a.ChainSwapType.CHAIN||n.getSequence()!==c||n.getAmount()!==t.total||n.isPayIn()||!n.isToken(e.token)||n.getOfferer()!==i.getAddress(this.chainIdentifier)||!n.isDepositToken(p))throw new o.IntermediaryError("Invalid data returned");if(this.getOnchainSendTimeout(n,f)-BigInt(Math.floor(Date.now()/1e3))<BigInt(this.options.minSendWindow))throw new o.IntermediaryError("Send window too low");let m=(0,u.toOutputScript)(this.options.bitcoinNetwork,t.btcAddress),w=this.contract.getExtraData(m,t.amount,f);if(!this.contract.getHashForOnchain(m,t.amount,f).equals(s.Buffer.from(n.getClaimHash(),"hex")))throw new o.IntermediaryError("Invalid claim hash returned!");if(!w.equals(s.Buffer.from(n.getExtraData(),"hex")))throw new o.IntermediaryError("Invalid extra data returned!")}create(t,e,i,r,a,s){var o,p;null!=r||(r={}),null!=(o=r).blockSafetyFactor||(o.blockSafetyFactor=1),null!=(p=r).feeSafetyFactor||(p.feeSafetyFactor=2n);let d=this.getRandomSequence(),f=(0,u.extendAbortController)(s),g=this.preFetchPrice(e,f.signal),m=this.preFetchClaimerBounty(t,e,r,f),w=this.chain.getNativeCurrencyAddress(),y=this.preFetchFeeRate(t,e,null,f);return i.map(i=>({intermediary:i,quote:(async()=>{let s=(0,u.extendAbortController)(f.signal),o=this.preFetchIntermediaryLiquidity(e,i,s);try{var p,T;let{signDataPromise:f,resp:S}=await (0,u.tryWithRetries)(async r=>{let{signDataPrefetch:n,response:o}=c.IntermediaryAPI.initFromBTC(this.chainIdentifier,i.url,w,{claimer:t,amount:e.amount,token:e.token.toString(),exactOut:!e.exactIn,sequence:d,claimerBounty:m,feeRate:y,additionalParams:a},this.options.postRequestTimeout,s.signal,!(r>0)&&null);return{signDataPromise:this.preFetchSignData(n),resp:await o}},null,t=>t instanceof h.RequestError,s.signal),E=new this.swapDataDeserializer(S.data);E.setClaimer(t),this.verifyReturnedData(S,e,i,r,E,d,await m,w);let[I,v]=await Promise.all([this.verifyReturnedPrice(i.services[l.SwapType.FROM_BTC],!1,S.amount,S.total,e.token,{},g,s.signal),this.verifyReturnedSignature(t,E,S,y,f,s.signal),this.verifyIntermediaryLiquidity(E.getAmount(),o)]),b=new n.FromBTCSwap(this,{pricingInfo:I,url:i.url,expiry:v,swapFee:S.swapFee,feeRate:await y,signatureData:S,data:E,address:S.btcAddress,amount:S.amount,exactIn:null==(p=e.exactIn)||p,requiredConfirmations:null!=(T=S.confirmations)?T:i.services[l.SwapType.FROM_BTC].data.confirmations});return await b._save(),b}catch(t){throw s.abort(t),t}})()}))}constructor(t,e,i,r,a,s,o,u,c,h,d,f,g){var m;null==f&&(f={}),f.bitcoinNetwork=null!=(m=f.bitcoinNetwork)?m:p.TEST_NETWORK,f.safetyFactor=f.safetyFactor||2,f.blocksTillTxConfirms=f.blocksTillTxConfirms||12,f.maxConfirmations=f.maxConfirmations||6,f.minSendWindow=f.minSendWindow||1800,f.bitcoinBlocktime=f.bitcoinBlocktime||600,super(t,e,i,r,a,s,o,u,f,g),this.TYPE=l.SwapType.FROM_BTC,this.swapDeserializer=n.FromBTCSwap,this.pendingSwapStates=[n.FromBTCSwapState.PR_CREATED,n.FromBTCSwapState.QUOTE_SOFT_EXPIRED,n.FromBTCSwapState.CLAIM_COMMITED,n.FromBTCSwapState.BTC_TX_CONFIRMED,n.FromBTCSwapState.EXPIRED],this.tickSwapState=[n.FromBTCSwapState.PR_CREATED,n.FromBTCSwapState.CLAIM_COMMITED,n.FromBTCSwapState.EXPIRED],this.btcRelay=c,this.synchronizer=h,this.btcRpc=d}}i.FromBTCWrapper=d},429970,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.TrustedIntermediaryAPI=i.InvoiceStatusResponseCodes=i.AddressStatusResponseCodes=void 0;let r=t.r(559766),n=t.r(686157),a=t.r(265005);!function(t){t[t.EXPIRED=10001]="EXPIRED",t[t.PAID=1e4]="PAID",t[t.AWAIT_PAYMENT=10010]="AWAIT_PAYMENT",t[t.AWAIT_CONFIRMATION=10011]="AWAIT_CONFIRMATION",t[t.PENDING=10013]="PENDING",t[t.TX_SENT=10012]="TX_SENT",t[t.REFUNDED=10014]="REFUNDED",t[t.DOUBLE_SPENT=10015]="DOUBLE_SPENT",t[t.REFUNDABLE=10016]="REFUNDABLE"}(i.AddressStatusResponseCodes||(i.AddressStatusResponseCodes={}));let s={paymentHash:a.FieldTypeEnum.String,sequence:a.FieldTypeEnum.BigInt,btcAddress:a.FieldTypeEnum.String,amountSats:a.FieldTypeEnum.BigInt,swapFeeSats:a.FieldTypeEnum.BigInt,swapFee:a.FieldTypeEnum.BigInt,total:a.FieldTypeEnum.BigInt,intermediaryKey:a.FieldTypeEnum.String,recommendedFee:a.FieldTypeEnum.Number,expiresAt:a.FieldTypeEnum.Number};!function(t){t[t.EXPIRED=10001]="EXPIRED",t[t.PAID=1e4]="PAID",t[t.AWAIT_PAYMENT=10010]="AWAIT_PAYMENT",t[t.PENDING=10011]="PENDING",t[t.TX_SENT=10012]="TX_SENT"}(i.InvoiceStatusResponseCodes||(i.InvoiceStatusResponseCodes={}));let o={pr:a.FieldTypeEnum.String,swapFee:a.FieldTypeEnum.BigInt,total:a.FieldTypeEnum.BigInt};i.TrustedIntermediaryAPI=class{static async getInvoiceStatus(t,e,i,a){return(0,r.tryWithRetries)(()=>(0,r.httpGet)(t+"/getInvoiceStatus?paymentHash="+encodeURIComponent(e),i,a),null,n.RequestError,a)}static async initTrustedFromBTCLN(t,e,i,s,l){let u=await (0,r.tryWithRetries)(()=>(0,r.httpGet)(e+"/lnforgas/createInvoice?address="+encodeURIComponent(i.address)+"&amount="+encodeURIComponent(i.amount.toString(10))+"&chain="+encodeURIComponent(t)+"&token="+encodeURIComponent(i.token),s,l),null,n.RequestError,l);if(1e4!==u.code)throw n.RequestError.parse(JSON.stringify(u),400);return(0,a.verifySchema)(u.data,o)}static async getAddressStatus(t,e,i,a,s){return(0,r.tryWithRetries)(()=>(0,r.httpGet)(t+"/getAddressStatus?paymentHash="+encodeURIComponent(e)+"&sequence="+encodeURIComponent(i.toString(10)),a,s),null,n.RequestError,s)}static async setRefundAddress(t,e,i,a,s,o){return(0,r.tryWithRetries)(()=>(0,r.httpGet)(t+"/setRefundAddress?paymentHash="+encodeURIComponent(e)+"&sequence="+encodeURIComponent(i.toString(10))+"&refundAddress="+encodeURIComponent(a),s,o),null,n.RequestError,o)}static async initTrustedFromBTC(t,e,i,o,l){let u=await (0,r.tryWithRetries)(()=>(0,r.httpGet)(e+"/frombtc_trusted/getAddress?chain="+encodeURIComponent(t)+"&address="+encodeURIComponent(i.address)+"&amount="+encodeURIComponent(i.amount.toString(10))+"&refundAddress="+encodeURIComponent(i.refundAddress)+"&exactIn=true&token="+encodeURIComponent(i.token),o,l),null,n.RequestError,l);if(1e4!==u.code)throw n.RequestError.parse(JSON.stringify(u),400);return(0,a.verifySchema)(u.data,s)}}},204708,(t,e,i)=>{"use strict";var r;Object.defineProperty(i,"__esModule",{value:!0}),i.LnForGasSwap=i.isLnForGasSwapInit=i.LnForGasSwapState=void 0;let n=t.r(20349),a=t.r(865854),s=t.r(930550),o=t.r(559766),l=t.r(958078),u=t.r(429970),c=t.r(768270),h=t.r(44237);function p(t){return"string"==typeof t.pr&&"bigint"==typeof t.outputAmount&&"string"==typeof t.recipient&&"string"==typeof t.token&&(0,l.isISwapInit)(t)}!function(t){t[t.EXPIRED=-2]="EXPIRED",t[t.FAILED=-1]="FAILED",t[t.PR_CREATED=0]="PR_CREATED",t[t.PR_PAID=1]="PR_PAID",t[t.FINISHED=2]="FINISHED"}(r=i.LnForGasSwapState||(i.LnForGasSwapState={})),i.isLnForGasSwapInit=p;class d extends l.ISwap{upgradeVersion(){1==this.version&&(1===this.state&&(this.state=r.FINISHED),this.version=2),null==this.version&&(this.version=1)}tryRecomputeSwapPrice(){null==this.swapFeeBtc&&(this.swapFeeBtc=this.swapFee*this.getInput().rawAmount/this.getOutAmountWithoutFee()),super.tryRecomputeSwapPrice()}_getEscrowHash(){return this.getId()}getOutputAddress(){return this.recipient}getInputTxId(){return this.getId()}getOutputTxId(){return this.scTxId}getId(){return null==this.pr?null:(0,n.decode)(this.pr).tagsObject.payment_hash}getAddress(){return this.pr}getHyperlink(){return"lightning:"+this.pr.toUpperCase()}requiresAction(){return!1}isFinished(){return this.state===r.FINISHED||this.state===r.FAILED||this.state===r.EXPIRED}isQuoteExpired(){return this.state===r.EXPIRED}isQuoteSoftExpired(){return this.expiry<Date.now()}isFailed(){return this.state===r.FAILED}isSuccessful(){return this.state===r.FINISHED}verifyQuoteValid(){return Promise.resolve(this.expiry>Date.now())}getOutAmountWithoutFee(){return this.outputAmount+this.swapFee}getOutput(){return(0,c.toTokenAmount)(this.outputAmount,this.wrapper.tokens[this.wrapper.chain.getNativeCurrencyAddress()],this.wrapper.prices)}getInput(){let t=(BigInt((0,n.decode)(this.pr).millisatoshis)+999n)/1000n;return(0,c.toTokenAmount)(t,c.BitcoinTokens.BTCLN,this.wrapper.prices)}getInputWithoutFee(){let t=(BigInt((0,n.decode)(this.pr).millisatoshis)+999n)/1000n;return(0,c.toTokenAmount)(t-this.swapFeeBtc,c.BitcoinTokens.BTCLN,this.wrapper.prices)}getSwapFee(){let t=1000000n*(this.swapFeeBtc-this.pricingInfo.satsBaseFee)/this.getInputWithoutFee().rawAmount;return{amountInSrcToken:(0,c.toTokenAmount)(this.swapFeeBtc,c.BitcoinTokens.BTCLN,this.wrapper.prices),amountInDstToken:(0,c.toTokenAmount)(this.swapFee,this.wrapper.tokens[this.wrapper.chain.getNativeCurrencyAddress()],this.wrapper.prices),usdValue:(t,e)=>this.wrapper.prices.getBtcUsdValue(this.swapFeeBtc,t,e),composition:{base:(0,c.toTokenAmount)(this.pricingInfo.satsBaseFee,c.BitcoinTokens.BTCLN,this.wrapper.prices),percentage:(0,l.ppmToPercentage)(t)}}}getFee(){return this.getSwapFee()}getFeeBreakdown(){return[{type:h.FeeType.SWAP,fee:this.getSwapFee()}]}async checkInvoicePaid(){let t=!(arguments.length>0)||void 0===arguments[0]||arguments[0];if(this.state===r.FAILED||this.state===r.EXPIRED)return!1;if(this.state===r.FINISHED)return!0;let e=(0,n.decode)(this.pr).tagsObject.payment_hash,i=await u.TrustedIntermediaryAPI.getInvoiceStatus(this.url,e,this.wrapper.options.getRequestTimeout);switch(this.logger.debug("checkInvoicePaid(): LP response: ",i),i.code){case u.InvoiceStatusResponseCodes.PAID:if(this.scTxId=i.data.txId,"success"===await this.wrapper.chain.getTxIdStatus(this.scTxId))return this.state=r.FINISHED,t&&await this._saveAndEmit(),!0;return null;case u.InvoiceStatusResponseCodes.EXPIRED:return this.state===r.PR_CREATED?this.state=r.EXPIRED:this.state=r.FAILED,t&&await this._saveAndEmit(),!1;case u.InvoiceStatusResponseCodes.TX_SENT:return this.scTxId=i.data.txId,this.state===r.PR_CREATED&&(this.state=r.PR_PAID,t&&await this._saveAndEmit()),null;case u.InvoiceStatusResponseCodes.PENDING:return this.state===r.PR_CREATED&&(this.state=r.PR_PAID,t&&await this._saveAndEmit()),null;case u.InvoiceStatusResponseCodes.AWAIT_PAYMENT:return null;default:return this.state=r.FAILED,t&&await this._saveAndEmit(),!1}}async waitForPayment(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5;if(this.state!==r.PR_CREATED)throw Error("Must be in PR_CREATED state!");for(this.initiated||(this.initiated=!0,await this._saveAndEmit());!t.aborted&&(this.state===r.PR_CREATED||this.state===r.PR_PAID);)await this.checkInvoicePaid(!0),(this.state===r.PR_CREATED||this.state===r.PR_PAID)&&await (0,o.timeoutPromise)(1e3*e,t);if(this.isFailed())throw new s.PaymentAuthError("Swap failed");return!this.isQuoteExpired()}serialize(){return{...super.serialize(),pr:this.pr,outputAmount:null==this.outputAmount?null:this.outputAmount.toString(10),recipient:this.recipient,token:this.token,scTxId:this.scTxId}}_getInitiator(){return this.recipient}async _sync(t){return this.state===r.PR_CREATED&&null!==await this.checkInvoicePaid(!1)&&(t&&await this._saveAndEmit(),!0)}_tick(t){return Promise.resolve(!1)}constructor(t,e){if(p(e)&&(e.url+="/lnforgas"),super(t,e),this.currentVersion=2,this.TYPE=a.SwapType.TRUSTED_FROM_BTCLN,p(e)?this.state=r.PR_CREATED:(this.pr=e.pr,this.outputAmount=null==e.outputAmount?null:BigInt(e.outputAmount),this.recipient=e.recipient,this.token=e.token,this.scTxId=e.scTxId),this.tryRecomputeSwapPrice(),null!=this.pr){let t=(0,n.decode)(this.pr);this.expiry=1e3*t.timeExpireDate}this.logger=(0,o.getLogger)("LnForGas("+this.getId()+"): ")}}i.LnForGasSwap=d},737628,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.LnForGasWrapper=void 0;let r=t.r(204708),n=t.r(462501),a=t.r(429970),s=t.r(20349),o=t.r(145617),l=t.r(865854);class u extends n.ISwapWrapper{async create(t,e,i){if(!this.isInitialized)throw Error("Not initialized, call init() first!");let n="string"==typeof i?i:i.url,u=this.chain.getNativeCurrencyAddress(),c=await a.TrustedIntermediaryAPI.initTrustedFromBTCLN(this.chainIdentifier,n,{address:t,amount:e,token:u},this.options.getRequestTimeout),h=(0,s.decode)(c.pr),p=(BigInt(h.millisatoshis)+999n)/1000n;if(c.total!==e)throw new o.IntermediaryError("Invalid total returned");let d=await this.verifyReturnedPrice("string"==typeof i?{swapFeePPM:1e4,swapBaseFee:10}:i.services[l.SwapType.TRUSTED_FROM_BTCLN],!1,p,e,u,{}),f=new r.LnForGasSwap(this,{pr:c.pr,outputAmount:c.total,recipient:t,pricingInfo:d,url:n,expiry:1e3*h.timeExpireDate,swapFee:c.swapFee,token:u,exactIn:!1});return await f._save(),f}constructor(){super(...arguments),this.TYPE=l.SwapType.TRUSTED_FROM_BTCLN,this.swapDeserializer=r.LnForGasSwap,this.pendingSwapStates=[r.LnForGasSwapState.PR_CREATED],this.tickSwapState=null,this.processEvent=null}}i.LnForGasWrapper=u},846223,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.wrapSwapWithSigner=void 0;let r=t.r(404023),n=t.r(318749),a=t.r(557456);i.wrapSwapWithSigner=function(t,e){return new Proxy(t,{get:(i,s,o)=>"commit"===s&&(t instanceof r.IToBTCSwap||t instanceof n.IFromBTCSwap)?(i,r)=>t.commit(e,i,r):"refund"===s&&t instanceof r.IToBTCSwap?i=>t.refund(e,i):"claim"===s&&t instanceof n.IFromBTCSwap?i=>t.claim(e,i):"commitAndClaim"===s&&t instanceof a.FromBTCLNSwap?(i,r)=>t.commitAndClaim(e,i,r):Reflect.get(i,s,o)})}},411456,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.SwapperWithSigner=void 0;let r=t.r(846223);i.SwapperWithSigner=class{get prices(){return this.swapper.prices}get intermediaryDiscovery(){return this.swapper.intermediaryDiscovery}get mempoolApi(){return this.swapper.mempoolApi}get bitcoinRpc(){return this.swapper.bitcoinRpc}get bitcoinNetwork(){return this.swapper.bitcoinNetwork}get Utils(){return this.swapper.Utils}get SwapTypeInfo(){return this.swapper.SwapTypeInfo}createToBTCSwap(t,e,i,n,a,s){return this.swapper.createToBTCSwap(this.signer.getAddress(),t,e,i,n,a,s).then(t=>(0,r.wrapSwapWithSigner)(t,this.signer))}createToBTCLNSwap(t,e,i,n){return this.swapper.createToBTCLNSwap(this.signer.getAddress(),t,e,i,n).then(t=>(0,r.wrapSwapWithSigner)(t,this.signer))}createToBTCLNSwapViaLNURL(t,e,i,n,a,s){return this.swapper.createToBTCLNSwapViaLNURL(this.signer.getAddress(),t,e,i,n,a,s).then(t=>(0,r.wrapSwapWithSigner)(t,this.signer))}createFromBTCSwap(t,e,i,n,a){return this.swapper.createFromBTCSwap(this.signer.getAddress(),t,e,i,n,a).then(t=>(0,r.wrapSwapWithSigner)(t,this.signer))}createFromBTCLNSwap(t,e,i,n,a){return this.swapper.createFromBTCLNSwap(this.signer.getAddress(),t,e,i,n,a).then(t=>(0,r.wrapSwapWithSigner)(t,this.signer))}createFromBTCLNSwapViaLNURL(t,e,i,n,a){return this.swapper.createFromBTCLNSwapViaLNURL(this.signer.getAddress(),t,e,i,n,a).then(t=>(0,r.wrapSwapWithSigner)(t,this.signer))}createTrustedLNForGasSwap(t,e){return this.swapper.createTrustedLNForGasSwap(this.signer.getAddress(),t,e)}createTrustedOnchainForGasSwap(t,e,i){return this.swapper.createTrustedOnchainForGasSwap(this.signer.getAddress(),t,e,i)}create(t,e,i,n,a){return this.swapper.create(this.signer.getAddress(),t,e,i,n,a).then(t=>(0,r.wrapSwapWithSigner)(t,this.signer))}getAllSwaps(){return this.swapper.getAllSwaps(this.signer.getAddress())}getActionableSwaps(){return this.swapper.getActionableSwaps(this.signer.getAddress())}getRefundableSwaps(){return this.swapper.getRefundableSwaps(this.signer.getAddress())}getSwapById(t){return this.swapper.getSwapById(t,this.signer.getAddress())}async _syncSwaps(){return this.swapper._syncSwaps(this.signer.getAddress())}supportsSwapType(t){return this.swapper.supportsSwapType(t)}getSwapType(t,e){return this.swapper.getSwapType(t,e)}getSwapLimits(t,e){return this.swapper.getSwapLimits(t,e)}getSwapCounterTokens(t,e){return this.swapper.getSwapCounterTokens(t,e)}getSwapBounds(){return this.swapper.getSwapBounds()}getMaximum(t,e){return this.swapper.getMaximum(t,e)}getMinimum(t,e){return this.swapper.getMinimum(t,e)}constructor(t,e){this.swapper=t,this.signer=e}}},736684,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.SwapperWithChain=void 0;let r=t.r(865854),n=t.r(424089),a=t.r(768270),s=t.r(411456);i.SwapperWithChain=class{get intermediaryDiscovery(){return this.swapper.intermediaryDiscovery}get mempoolApi(){return this.swapper.mempoolApi}get bitcoinRpc(){return this.swapper.bitcoinRpc}get bitcoinNetwork(){return this.swapper.bitcoinNetwork}get Utils(){return this.swapper.Utils}get SwapTypeInfo(){return this.swapper.SwapTypeInfo}createToBTCSwap(t,e,i,r,n,a,s){return this.swapper.createToBTCSwap(this.chainIdentifier,t,e,i,r,n,a,s)}createToBTCLNSwap(t,e,i,r,n){return this.swapper.createToBTCLNSwap(this.chainIdentifier,t,e,i,r,n)}createToBTCLNSwapViaLNURL(t,e,i,r,n,a,s){return this.swapper.createToBTCLNSwapViaLNURL(this.chainIdentifier,t,e,i,r,n,a,s)}createFromBTCSwap(t,e,i,r,n,a){return this.swapper.createFromBTCSwap(this.chainIdentifier,t,e,i,r,n,a)}createFromBTCLNSwap(t,e,i,r,n,a){return this.swapper.createFromBTCLNSwap(this.chainIdentifier,t,e,i,r,n,a)}createFromBTCLNSwapViaLNURL(t,e,i,r,n,a){return this.swapper.createFromBTCLNSwapViaLNURL(this.chainIdentifier,t,e,i,r,n,a)}createTrustedLNForGasSwap(t,e,i){return this.swapper.createTrustedLNForGasSwap(this.chainIdentifier,t,e,i)}createTrustedOnchainForGasSwap(t,e,i,r){return this.swapper.createTrustedOnchainForGasSwap(this.chainIdentifier,t,e,i,r)}create(t,e,i,r,n,a){return this.swapper.create(t,e,i,r,n,a)}swap(t,e,i,r,n,a,s){return this.swapper.swap(t,e,i,r,n,a,s)}getAllSwaps(t){return this.swapper.getAllSwaps(this.chainIdentifier,t)}getActionableSwaps(t){return this.swapper.getActionableSwaps(this.chainIdentifier,t)}getRefundableSwaps(t){return this.swapper.getRefundableSwaps(this.chainIdentifier,t)}getSwapById(t,e){return this.swapper.getSwapById(t,this.chainIdentifier,e)}async _syncSwaps(t){return this.swapper._syncSwaps(this.chainIdentifier,t)}supportsSwapType(t){return this.swapper.supportsSwapType(this.chainIdentifier,t)}getSwapType(t,e){return this.swapper.getSwapType(t,e)}getSwapLimits(t,e){return this.swapper.getSwapLimits(t,e)}getSupportedTokens(t){let e=[];return this.intermediaryDiscovery.intermediaries.forEach(i=>{let n=t;if((n===r.SwapType.FROM_BTC&&this.supportsSwapType(r.SwapType.SPV_VAULT_FROM_BTC)&&(n=r.SwapType.SPV_VAULT_FROM_BTC),null!=i.services[n])&&null!=i.services[n].chainTokens)for(let t of i.services[n].chainTokens[this.chainIdentifier]){var a,s;let i=null==(s=this.swapper.tokens)||null==(a=s[this.chainIdentifier])?void 0:a[t];null!=i&&e.push(i)}}),e}getSupportedTokenAddresses(t){let e=new Set;return this.intermediaryDiscovery.intermediaries.forEach(i=>{null!=i.services[t]&&null!=i.services[t].chainTokens&&null!=i.services[t].chainTokens[this.chainIdentifier]&&i.services[t].chainTokens[this.chainIdentifier].forEach(t=>e.add(t))}),e}getSwapCounterTokens(t,e){if((0,a.isSCToken)(t)){let i=[];if(e)this.getSupportedTokenAddresses(r.SwapType.TO_BTCLN).has(t.address)&&i.push(a.BitcoinTokens.BTCLN),this.getSupportedTokenAddresses(r.SwapType.TO_BTC).has(t.address)&&i.push(a.BitcoinTokens.BTC);else{this.getSupportedTokenAddresses(r.SwapType.FROM_BTCLN).has(t.address)&&i.push(a.BitcoinTokens.BTCLN);let e=this.supportsSwapType(r.SwapType.SPV_VAULT_FROM_BTC)?r.SwapType.SPV_VAULT_FROM_BTC:r.SwapType.FROM_BTC;this.getSupportedTokenAddresses(e).has(t.address)&&i.push(a.BitcoinTokens.BTC)}return i}if(e)if(t.lightning)return this.getSupportedTokens(r.SwapType.FROM_BTCLN);else return this.getSupportedTokens(r.SwapType.FROM_BTC);return t.lightning?this.getSupportedTokens(r.SwapType.TO_BTCLN):this.getSupportedTokens(r.SwapType.TO_BTC)}withChain(t){return new s.SwapperWithSigner(this,t)}getSwapBounds(){return this.swapper.getSwapBounds(this.chainIdentifier)}getMaximum(t,e){return this.swapper.getMaximum(this.chainIdentifier,t,e)}getMinimum(t,e){return this.swapper.getMinimum(this.chainIdentifier,t,e)}constructor(t,e){this.swapper=t,this.chainIdentifier=e,this.prices=new n.SwapPriceWithChain(t.prices,e)}}},570664,(t,e,i)=>{"use strict";var r;Object.defineProperty(i,"__esModule",{value:!0}),i.OnchainForGasSwap=i.isOnchainForGasSwapInit=i.OnchainForGasSwapState=void 0;let n=t.r(865854),a=t.r(930550),s=t.r(559766),o=t.r(958078),l=t.r(429970),u=t.r(768270),c=t.r(44237),h=t.r(548760),p=t.r(960474),d=t.r(902866),f=t.r(843943);function g(t){return"string"==typeof t.paymentHash&&"bigint"==typeof t.sequence&&"string"==typeof t.address&&"bigint"==typeof t.inputAmount&&"bigint"==typeof t.outputAmount&&"string"==typeof t.recipient&&"string"==typeof t.token&&(null==t.refundAddress||"string"==typeof t.refundAddress)&&(0,o.isISwapInit)(t)}!function(t){t[t.EXPIRED=-3]="EXPIRED",t[t.FAILED=-2]="FAILED",t[t.REFUNDED=-1]="REFUNDED",t[t.PR_CREATED=0]="PR_CREATED",t[t.FINISHED=1]="FINISHED",t[t.REFUNDABLE=2]="REFUNDABLE"}(r=i.OnchainForGasSwapState||(i.OnchainForGasSwapState={})),i.isOnchainForGasSwapInit=g;class m extends o.ISwap{upgradeVersion(){null==this.version&&(this.version=1)}tryRecomputeSwapPrice(){null==this.swapFeeBtc&&(this.swapFeeBtc=this.swapFee*this.getInput().rawAmount/this.getOutAmountWithoutFee()),super.tryRecomputeSwapPrice()}_getEscrowHash(){return this.paymentHash}getOutputAddress(){return this.recipient}getInputTxId(){return this.txId}getOutputTxId(){return this.scTxId}getId(){return this.paymentHash}getAddress(){return this.address}getHyperlink(){return"bitcoin:"+this.address+"?amount="+encodeURIComponent((Number(this.inputAmount)/1e8).toString(10))}requiresAction(){return this.state===r.REFUNDABLE}isFinished(){return this.state===r.FINISHED||this.state===r.FAILED||this.state===r.EXPIRED||this.state===r.REFUNDED}isQuoteExpired(){return this.state===r.EXPIRED}isQuoteSoftExpired(){return this.expiry<Date.now()}isFailed(){return this.state===r.FAILED}isSuccessful(){return this.state===r.FINISHED}verifyQuoteValid(){return Promise.resolve(this.expiry>Date.now())}getOutAmountWithoutFee(){return this.outputAmount+this.swapFee}getOutput(){return(0,u.toTokenAmount)(this.outputAmount,this.wrapper.tokens[this.wrapper.chain.getNativeCurrencyAddress()],this.wrapper.prices)}getInput(){return(0,u.toTokenAmount)(this.inputAmount,u.BitcoinTokens.BTC,this.wrapper.prices)}getInputWithoutFee(){return(0,u.toTokenAmount)(this.inputAmount-this.swapFeeBtc,u.BitcoinTokens.BTC,this.wrapper.prices)}getSwapFee(){let t=1000000n*(this.swapFeeBtc-this.pricingInfo.satsBaseFee)/this.getInputWithoutFee().rawAmount;return{amountInSrcToken:(0,u.toTokenAmount)(this.swapFeeBtc,u.BitcoinTokens.BTC,this.wrapper.prices),amountInDstToken:(0,u.toTokenAmount)(this.swapFee,this.wrapper.tokens[this.wrapper.chain.getNativeCurrencyAddress()],this.wrapper.prices),usdValue:(t,e)=>this.wrapper.prices.getBtcUsdValue(this.swapFeeBtc,t,e),composition:{base:(0,u.toTokenAmount)(this.pricingInfo.satsBaseFee,u.BitcoinTokens.BTC,this.wrapper.prices),percentage:(0,o.ppmToPercentage)(t)}}}getFee(){return this.getSwapFee()}getFeeBreakdown(){return[{type:c.FeeType.SWAP,fee:this.getSwapFee()}]}getRequiredConfirmationsCount(){return 1}async getFundedPsbt(t,e){let i;if(this.state!==r.PR_CREATED)throw Error("Swap already paid for!");i=(0,h.isIBitcoinWallet)(t)?t:new d.SingleAddressBitcoinWallet(this.wrapper.btcRpc,this.wrapper.options.bitcoinNetwork,t),null==e&&(e=await i.getFeeRate());let n=new p.Transaction({allowUnknownOutputs:!0,allowLegacyWitnessUtxo:!0});n.addOutput({amount:this.outputAmount,script:(0,s.toOutputScript)(this.wrapper.options.bitcoinNetwork,this.address)});let a=await i.fundPsbt(n,e),o=[];for(let t=0;t<a.inputsLength;t++)o.push(t);return{psbt:a,signInputs:o}}async submitPsbt(t){if(this.state!==r.PR_CREATED)throw Error("Swap already paid for!");if(this.expiry<Date.now())throw Error("Swap expired!");let e=t.getOutput(0);if(e.amount!==this.outputAmount)throw Error("PSBT output amount invalid, expected: "+this.outputAmount+" got: "+e.amount);if(!(0,s.toOutputScript)(this.wrapper.options.bitcoinNetwork,this.address).equals(e.script))throw Error("PSBT output script invalid!");return t.isFinal||t.finalize(),await this.wrapper.btcRpc.sendRawTransaction(f.Buffer.from(t.toBytes(!0,!0)).toString("hex"))}async estimateBitcoinFee(t,e){let i=await t.getTransactionFee(this.address,this.inputAmount,e);return(0,u.toTokenAmount)(null==i?null:BigInt(i),u.BitcoinTokens.BTC,this.wrapper.prices)}async sendBitcoinTransaction(t,e){if(this.state!==r.PR_CREATED)throw Error("Swap already paid for!");return await t.sendTransaction(this.address,this.inputAmount,e)}async checkAddress(){let t=!(arguments.length>0)||void 0===arguments[0]||arguments[0];if(this.state===r.FAILED||this.state===r.EXPIRED||this.state===r.REFUNDED||this.state===r.FINISHED)return!1;let e=await l.TrustedIntermediaryAPI.getAddressStatus(this.url,this.paymentHash,this.sequence,this.wrapper.options.getRequestTimeout);switch(e.code){case l.AddressStatusResponseCodes.AWAIT_PAYMENT:if(null!=this.txId)return this.txId=null,t&&await this._save(),!0;return!1;case l.AddressStatusResponseCodes.AWAIT_CONFIRMATION:case l.AddressStatusResponseCodes.PENDING:case l.AddressStatusResponseCodes.TX_SENT:let i=BigInt(e.data.adjustedAmount),n=BigInt(e.data.adjustedTotal),a=null==e.data.adjustedFee?null:BigInt(e.data.adjustedFee),s=null==e.data.adjustedFeeSats?null:BigInt(e.data.adjustedFeeSats),o=e.data.txId;if(this.txId!=o||this.inputAmount!==i||this.outputAmount!==n)return this.txId=o,this.inputAmount=i,this.outputAmount=n,null!=a&&(this.swapFee=a),null!=s&&(this.swapFeeBtc=s),t&&await this._save(),!0;return!1;case l.AddressStatusResponseCodes.PAID:if("success"===await this.wrapper.chain.getTxIdStatus(e.data.txId))return this.state=r.FINISHED,this.scTxId=e.data.txId,t&&await this._saveAndEmit(),!0;return!1;case l.AddressStatusResponseCodes.EXPIRED:return this.state=r.EXPIRED,t&&await this._saveAndEmit(),!0;case l.AddressStatusResponseCodes.REFUNDABLE:if(this.state===r.REFUNDABLE)return null;return this.state=r.REFUNDABLE,t&&await this._saveAndEmit(),!0;case l.AddressStatusResponseCodes.REFUNDED:return this.state=r.REFUNDED,this.refundTxId=e.data.txId,t&&await this._saveAndEmit(),!0;default:return this.state=r.FAILED,t&&await this._saveAndEmit(),!0}}async setRefundAddress(t){if(null!=this.refundAddress){if(this.refundAddress!==t)throw Error("Different refund address already set!");return}await l.TrustedIntermediaryAPI.setRefundAddress(this.url,this.paymentHash,this.sequence,t,this.wrapper.options.getRequestTimeout),this.refundAddress=t}async waitForBitcoinTransaction(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5,i=arguments.length>2?arguments[2]:void 0;if(this.state!==r.PR_CREATED)throw Error("Must be in PR_CREATED state!");for(this.initiated||(this.initiated=!0,await this._saveAndEmit());!t.aborted&&this.state===r.PR_CREATED;){if(await this.checkAddress(!0),null!=this.txId&&null!=i){let t=await this.wrapper.btcRpc.getTransaction(this.txId);if(null==t)i(null,null,1,null);else if(t.confirmations>0)i(t.txid,t.confirmations,1,0);else{let e=await this.wrapper.btcRpc.getConfirmationDelay(t,1);i(t.txid,0,1,e)}}this.state===r.PR_CREATED&&await (0,s.timeoutPromise)(1e3*e,t)}if(this.state===r.REFUNDABLE||this.state===r.REFUNDED)return this.txId;if(this.isQuoteExpired())throw new a.PaymentAuthError("Swap expired");if(this.isFailed())throw new a.PaymentAuthError("Swap failed");return this.txId}async waitTillRefunded(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5;if(this.state!==r.REFUNDED){if(this.state!==r.REFUNDABLE)throw Error("Must be in REFUNDABLE state!");for(;!t.aborted&&this.state===r.REFUNDABLE;)await this.checkAddress(!0),this.state===r.REFUNDABLE&&await (0,s.timeoutPromise)(1e3*e,t);if(this.isQuoteExpired())throw new a.PaymentAuthError("Swap expired");if(this.isFailed())throw new a.PaymentAuthError("Swap failed")}}async requestRefund(t,e){null!=t&&await this.setRefundAddress(t),await this.waitTillRefunded(e)}serialize(){return{...super.serialize(),paymentHash:this.paymentHash,sequence:null==this.sequence?null:this.sequence.toString(10),address:this.address,inputAmount:null==this.inputAmount?null:this.inputAmount.toString(10),outputAmount:null==this.outputAmount?null:this.outputAmount.toString(10),recipient:this.recipient,token:this.token,refundAddress:this.refundAddress,scTxId:this.scTxId,txId:this.txId,refundTxId:this.refundTxId}}_getInitiator(){return this.recipient}async _sync(t){return!!(this.state===r.PR_CREATED&&await this.checkAddress(!1))&&(t&&await this._saveAndEmit(),!0)}_tick(t){return Promise.resolve(!1)}constructor(t,e){g(e)&&(e.url+="/frombtc_trusted"),super(t,e),this.getSmartChainNetworkFee=null,this.TYPE=n.SwapType.TRUSTED_FROM_BTC,g(e)?this.state=r.PR_CREATED:(this.paymentHash=e.paymentHash,this.sequence=null==e.sequence?null:BigInt(e.sequence),this.address=e.address,this.inputAmount=null==e.inputAmount?null:BigInt(e.inputAmount),this.outputAmount=null==e.outputAmount?null:BigInt(e.outputAmount),this.recipient=e.recipient,this.token=e.token,this.refundAddress=e.refundAddress,this.scTxId=e.scTxId,this.txId=e.txId,this.refundTxId=e.refundTxId),this.logger=(0,s.getLogger)("OnchainForGas("+this.getId()+"): "),this.tryRecomputeSwapPrice()}}i.OnchainForGasSwap=m},78950,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.OnchainForGasWrapper=void 0;let r=t.r(462501),n=t.r(429970),a=t.r(145617),s=t.r(570664),o=t.r(865854);class l extends r.ISwapWrapper{async create(t,e,i,r){if(!this.isInitialized)throw Error("Not initialized, call init() first!");let l="string"==typeof i?i:i.url,u=this.chain.getNativeCurrencyAddress(),c=await n.TrustedIntermediaryAPI.initTrustedFromBTC(this.chainIdentifier,l,{address:t,amount:e,refundAddress:r,token:u},this.options.getRequestTimeout);if(c.total!==e)throw new a.IntermediaryError("Invalid total returned");let h=await this.verifyReturnedPrice("string"==typeof i?{swapFeePPM:1e4,swapBaseFee:10}:i.services[o.SwapType.TRUSTED_FROM_BTC],!1,c.amountSats,e,this.chain.getNativeCurrencyAddress(),{}),p=new s.OnchainForGasSwap(this,{paymentHash:c.paymentHash,sequence:c.sequence,address:c.btcAddress,inputAmount:c.amountSats,outputAmount:c.total,recipient:t,refundAddress:r,pricingInfo:h,url:l,expiry:c.expiresAt,swapFee:c.swapFee,swapFeeBtc:c.swapFeeSats,exactIn:!1,token:u});return await p._save(),p}constructor(t,e,i,r,n,a,l,u,c){super(t,e,i,r,n,a,u,c),this.TYPE=o.SwapType.TRUSTED_FROM_BTC,this.swapDeserializer=s.OnchainForGasSwap,this.pendingSwapStates=[s.OnchainForGasSwapState.PR_CREATED],this.tickSwapState=null,this.processEvent=null,this.btcRpc=l}}i.OnchainForGasWrapper=l},899600,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.IndexedDBUnifiedStorage=void 0;let r=t.r(559766),n={escrowHash:{key:"escrowHash",unique:!0},type:{key:"type",unique:!1},initiator:{key:"initiator",unique:!1},"initiator, id":{key:["initiator","id"],unique:!1},"type, state":{key:["type","state"],unique:!1},"type, paymentHash":{key:["type","paymentHash"],unique:!1},"type, initiator, state":{key:["type","initiator","state"],unique:!1}};i.IndexedDBUnifiedStorage=class{async tryMigrateLocalStorage(t,e,i){let r,n=window.localStorage.getItem(t);if(null==n)return!1;try{r=JSON.parse(n)}catch(e){return this.logger.warn("tryMigrate("+t+"): Tried to migrate the database, but cannot parse old local storage!"),!1}let a=Object.keys(r).map(t=>{let n=r[t];return n.type=e,i(n)});return await this.saveAll(a.map(t=>t.serialize())),window.localStorage.removeItem(t),this.logger.info("tryMigrate("+t+"): Database successfully migrated from localStorage to unifiedIndexedDB!"),!0}async tryMigrateOldIndexedDB(t,e,i){let r;if(null==(await window.indexedDB.databases()).find(e=>e.name===t))return this.logger.info("tryMigrateOldIndexedDB("+t+"): Old database not found!"),!1;this.logger.debug("tryMigrateOldIndexedDB("+t+"): Old database found!");try{r=await new Promise((e,i)=>{let r=window.indexedDB.open(t,1);r.onerror=t=>i(t),r.onsuccess=t=>e(t.target.result)})}catch(e){return this.logger.warn("tryMigrateOldIndexedDB("+t+"): Error opening old IndexedDB!",e),!1}this.logger.debug("tryMigrateOldIndexedDB("+t+"): Connection opened!");try{let n=await new Promise((t,e)=>{let i=r.transaction("swaps","readonly",{durability:"strict"}).objectStore("swaps").getAll();i.onsuccess=e=>t(e.target.result),i.onerror=t=>e(t)});this.logger.debug("tryMigrateOldIndexedDB("+t+"): Data retrieved!");let a=n.map(t=>{let{id:r,data:n}=t;return n.type=e,i(n)});return this.logger.debug("tryMigrateOldIndexedDB("+t+"): Data revived!"),await this.saveAll(a.map(t=>t.serialize())),this.logger.debug("tryMigrateOldIndexedDB("+t+"): Data saved!"),r.close(),this.logger.debug("tryMigrateOldIndexedDB("+t+"): DB connection closed!"),await new Promise((e,i)=>{let r=window.indexedDB.deleteDatabase(t);r.onsuccess=()=>e(),r.onerror=t=>i(t)}),this.logger.info("tryMigrateOldIndexedDB("+t+"): Database successfully migrated from oldIndexedDB to unifiedIndexedDB!"),!0}catch(e){return this.logger.warn("tryMigrateOldIndexedDB("+t+"): Tried to migrate the database, but cannot parse oldIndexedDB!",e),!1}}async tryMigrate(t,e){let i=!1;for(let r of t)this.logger.info("tryMigrate(): Trying to migrate...",r),await this.tryMigrateLocalStorage(r[0],r[1],e)&&(i=!0),await this.tryMigrateOldIndexedDB(r[0],r[1],e)&&(i=!0);return i}executeTransaction(t,e){return new Promise((i,r)=>{let n=t(this.db.transaction("swaps",e?"readonly":"readwrite",{durability:"strict"}).objectStore("swaps"));n.onsuccess=t=>i(t.target.result),n.onerror=t=>r(t)})}executeTransactionArr(t,e){return Promise.all(t(this.db.transaction("swaps",e?"readonly":"readwrite",{durability:"strict"}).objectStore("swaps")).map(t=>new Promise((e,i)=>{t.onsuccess=t=>e(t.target.result),t.onerror=t=>i(t)})))}executeTransactionWithCursor(t,e){return new Promise((i,r)=>{let n=t(this.db.transaction("swaps","readonly",{durability:"strict"}).objectStore("swaps")),a=[];for(let t of n)t.onsuccess=t=>{let r=t.target.result;if(null!=r){let t=r.value;e(t)&&a.push(t),r.continue()}else i(a)},t.onerror=t=>r(t)})}async init(){null==this.db&&(this.db=await new Promise((t,e)=>{let i=window.indexedDB.open(this.storageKey,1);i.onupgradeneeded=t=>{let e=t.target.result.createObjectStore("swaps",{keyPath:"id"});Object.keys(n).forEach(t=>{let i=n[t];e.createIndex(t,i.key,{unique:i.unique})})},i.onerror=t=>e(t),i.onsuccess=e=>t(e.target.result)}))}async query(t){return 0===t.length?await this.querySingle([]):Array.from(new Set((await Promise.all(t.map(t=>this.querySingle(t)))).flat()))}async querySingle(t){if(0===t.length)return await this.executeTransaction(t=>t.getAll(),!0);let e=t.map(t=>t.key).join(", ");if("id"===e){let e=Array.isArray(t[0].value)?t[0].value:[t[0].value];return(await this.executeTransactionArr(t=>e.map(e=>t.getAll(e)),!0)).flat()}if(null!=n[e]){let i=function t(e){if(0===e.length)return[];if(1===e.length)return e[0];{let i=[],r=e.shift(),n=t(e);for(let t of r)for(let e of n)i.push([t].concat(e));return i}}(t.map(t=>Array.isArray(t.value)?t.value:[t.value]));return(await this.executeTransactionArr(t=>{let r=t.index(e);return i.map(t=>r.getAll(t))},!0)).flat()}{this.logger.warn("query(): Index cannot be used for query, required index: "+e+" query params: ",t);let i=t.map(t=>({key:t.key,values:new Set(Array.isArray(t.value)?t.value:[t.value])}));return await this.executeTransactionWithCursor(t=>[t.openCursor()],t=>(function(t,e){for(let i of t){let t=e[i.key];if(!i.values.has(t))return!1}return!0})(i,t))}}async remove(t){await this.executeTransaction(e=>e.delete(t.id),!1).catch(()=>null)}async removeAll(t){0!==t.length&&await this.executeTransactionArr(e=>t.map(t=>e.delete(t.id)),!1)}async save(t){await this.executeTransaction(e=>e.put(t),!1)}async saveAll(t){0!==t.length&&await this.executeTransactionArr(e=>t.map(t=>e.put(t)),!1)}constructor(t){this.storageKey=t,this.logger=(0,r.getLogger)("IndexedDBUnifiedStorage("+this.storageKey+"): ")}}},951287,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.UnifiedSwapStorage=void 0;let r=(0,t.r(559766).getLogger)("UnifiedSwapStorage: "),n=[{key:"id",type:"string",unique:!0,nullable:!1},{key:"escrowHash",type:"string",unique:!0,nullable:!0},{key:"type",type:"number",unique:!1,nullable:!1},{key:"initiator",type:"string",unique:!1,nullable:!1},{key:"state",type:"number",unique:!1,nullable:!1},{key:"paymentHash",type:"string",unique:!1,nullable:!0}],a=[{keys:["initiator","id"],unique:!1},{keys:["type","state"],unique:!1},{keys:["type","paymentHash"],unique:!1},{keys:["type","initiator","state"],unique:!1}];i.UnifiedSwapStorage=class{init(){return this.storage.init(n,a)}async query(t,e){return(await this.storage.query(t)).map(t=>{if(!this.noWeakRefMap){var i;let e=null==(i=this.weakRefCache.get(t.id))?void 0:i.deref();if(null!=e)return e;r.debug("query(): Reviving new swap instance: "+t.id)}let n=e(t);return this.noWeakRefMap||this.weakRefCache.set(t.id,new WeakRef(n)),n})}save(t){return this.noWeakRefMap||this.weakRefCache.set(t.getId(),new WeakRef(t)),this.storage.save(t.serialize())}saveAll(t){return this.noWeakRefMap||t.forEach(t=>this.weakRefCache.set(t.getId(),new WeakRef(t))),this.storage.saveAll(t.map(t=>t.serialize()))}remove(t){return this.noWeakRefMap||this.weakRefCache.delete(t.getId()),this.storage.remove(t.serialize())}removeAll(t){return this.noWeakRefMap||t.forEach(t=>this.weakRefCache.delete(t.getId())),this.storage.removeAll(t.map(t=>t.serialize()))}constructor(t,e){this.weakRefCache=new Map,this.storage=t,this.noWeakRefMap=e}}},15567,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.UnifiedSwapEventListener=void 0;let r=t.r(991989);function n(t){return t instanceof r.SwapEvent?t.escrowHash:t instanceof r.SpvVaultFrontEvent||t instanceof r.SpvVaultClaimEvent||t instanceof r.SpvVaultCloseEvent?t.btcTxId:void 0}i.UnifiedSwapEventListener=class{async processEvents(t){let e={};for(let i of(t.forEach(t=>{e[n(t)]=null}),(await this.storage.query([[{key:"escrowHash",value:Object.keys(e)}]],t=>{let e=this.listeners[t.type];return null==e?null:new e.reviver(t)})).forEach(t=>e[t._getEscrowHash()]=t),t)){let t=e[n(i)];if(null==t)continue;let r=this.listeners[t.getType()];null!=r&&await r.listener(i,t)}}async start(){null==this.listener&&(await this.storage.init(),await this.events.init(),this.events.registerListener(this.listener=async t=>(await this.processEvents(t),!0)))}stop(){return this.events.unregisterListener(this.listener),this.events.stop()}registerListener(t,e,i){this.listeners[t]={listener:e,reviver:i}}unregisterListener(t){return!this.listeners[t]&&(delete this.listeners[t],!0)}constructor(t,e){this.listeners={},this.storage=t,this.events=e}}},348652,(t,e,i)=>{"use strict";var r;Object.defineProperty(i,"__esModule",{value:!0}),i.SpvFromBTCSwap=i.isSpvFromBTCSwapInit=i.SpvFromBTCSwapState=void 0;let n=t.r(958078),a=t.r(991989),s=t.r(865854),o=t.r(559766),l=t.r(960474),u=t.r(768270),c=t.r(843943),h=t.r(44237),p=t.r(548760),d=t.r(366913),f=t.r(902866);function g(t){return"object"==typeof t&&"string"==typeof t.quoteId&&"string"==typeof t.recipient&&"string"==typeof t.vaultOwner&&"bigint"==typeof t.vaultId&&"number"==typeof t.vaultRequiredConfirmations&&Array.isArray(t.vaultTokenMultipliers)&&t.vaultTokenMultipliers.reduce((t,e)=>t&&"bigint"==typeof e,!0)&&"string"==typeof t.vaultBtcAddress&&"string"==typeof t.vaultUtxo&&"bigint"==typeof t.vaultUtxoValue&&"string"==typeof t.btcDestinationAddress&&"bigint"==typeof t.btcAmount&&"bigint"==typeof t.btcAmountSwap&&"bigint"==typeof t.btcAmountGas&&"number"==typeof t.minimumBtcFeeRate&&"bigint"==typeof t.outputTotalSwap&&"string"==typeof t.outputSwapToken&&"bigint"==typeof t.outputTotalGas&&"string"==typeof t.outputGasToken&&"bigint"==typeof t.gasSwapFeeBtc&&"bigint"==typeof t.gasSwapFee&&"bigint"==typeof t.callerFeeShare&&"bigint"==typeof t.frontingFeeShare&&"bigint"==typeof t.executionFeeShare&&(0,n.isISwapInit)(t)}!function(t){t[t.CLOSED=-5]="CLOSED",t[t.FAILED=-4]="FAILED",t[t.DECLINED=-3]="DECLINED",t[t.QUOTE_EXPIRED=-2]="QUOTE_EXPIRED",t[t.QUOTE_SOFT_EXPIRED=-1]="QUOTE_SOFT_EXPIRED",t[t.CREATED=0]="CREATED",t[t.SIGNED=1]="SIGNED",t[t.POSTED=2]="POSTED",t[t.BROADCASTED=3]="BROADCASTED",t[t.FRONTED=4]="FRONTED",t[t.BTC_TX_CONFIRMED=5]="BTC_TX_CONFIRMED",t[t.CLAIMED=6]="CLAIMED"}(r=i.SpvFromBTCSwapState||(i.SpvFromBTCSwapState={})),i.isSpvFromBTCSwapInit=g;class m extends n.ISwap{upgradeVersion(){}tryCalculateSwapFee(){null==this.swapFeeBtc&&(this.swapFeeBtc=this.swapFee*this.btcAmountSwap/this.getOutputWithoutFee().rawAmount),null==this.pricingInfo.swapPriceUSatPerToken&&(this.pricingInfo=this.wrapper.prices.recomputePriceInfoReceive(this.chainIdentifier,this.btcAmountSwap,this.pricingInfo.satsBaseFee,this.pricingInfo.feePPM,this.getOutputWithoutFee().rawAmount,this.outputSwapToken))}async refreshPriceData(){if(null==this.pricingInfo)return null;this.pricingInfo=await this.wrapper.prices.isValidAmountReceive(this.chainIdentifier,this.btcAmountSwap,this.pricingInfo.satsBaseFee,this.pricingInfo.feePPM,this.getOutputWithoutFee().rawAmount,this.outputSwapToken)}_getInitiator(){return this.recipient}_getEscrowHash(){var t,e;return null==(e=this.data)||null==(t=e.btcTx)?void 0:t.txid}getId(){return this.quoteId+this.randomNonce}getQuoteExpiry(){return this.expiry-2e4}verifyQuoteValid(){return Promise.resolve(this.expiry>Date.now()&&(this.state===r.CREATED||this.state===r.QUOTE_SOFT_EXPIRED))}getOutputAddress(){return this.recipient}getOutputTxId(){var t;return null!=(t=this.frontTxId)?t:this.claimTxId}getInputTxId(){var t,e;return null==(e=this.data)||null==(t=e.btcTx)?void 0:t.txid}requiresAction(){return this.state===r.BTC_TX_CONFIRMED}isFinished(){return this.state===r.CLAIMED||this.state===r.QUOTE_EXPIRED||this.state===r.FAILED}isClaimable(){return this.state===r.BTC_TX_CONFIRMED}isSuccessful(){return this.state===r.FRONTED||this.state===r.CLAIMED}isFailed(){return this.state===r.FAILED||this.state===r.DECLINED||this.state===r.CLOSED}isQuoteExpired(){return this.state===r.QUOTE_EXPIRED}isQuoteSoftExpired(){return this.state===r.QUOTE_EXPIRED||this.state===r.QUOTE_SOFT_EXPIRED}getInputSwapAmountWithoutFee(){return(this.btcAmountSwap-this.swapFeeBtc)*100000n/(100000n+this.callerFeeShare+this.frontingFeeShare+this.executionFeeShare)}getInputGasAmountWithoutFee(){return(this.btcAmountGas-this.gasSwapFeeBtc)*100000n/(100000n+this.callerFeeShare+this.frontingFeeShare)}getInputAmountWithoutFee(){return this.getInputSwapAmountWithoutFee()+this.getInputGasAmountWithoutFee()}getOutputWithoutFee(){return(0,u.toTokenAmount)(this.outputTotalSwap*(100000n+this.callerFeeShare+this.frontingFeeShare+this.executionFeeShare)/100000n+this.swapFee,this.wrapper.tokens[this.outputSwapToken],this.wrapper.prices)}getSwapFee(){let t=this.wrapper.tokens[this.outputSwapToken],e=this.gasSwapFeeBtc*10n**BigInt(t.decimals)*1000000n/this.pricingInfo.swapPriceUSatPerToken,i=1000000n*(this.swapFeeBtc-this.pricingInfo.satsBaseFee)/(this.btcAmount-this.swapFeeBtc-this.gasSwapFeeBtc);return{amountInSrcToken:(0,u.toTokenAmount)(this.swapFeeBtc+this.gasSwapFeeBtc,u.BitcoinTokens.BTC,this.wrapper.prices),amountInDstToken:(0,u.toTokenAmount)(this.swapFee+e,t,this.wrapper.prices),usdValue:(t,e)=>this.wrapper.prices.getBtcUsdValue(this.swapFeeBtc+this.gasSwapFeeBtc,t,e),composition:{base:(0,u.toTokenAmount)(this.pricingInfo.satsBaseFee,u.BitcoinTokens.BTC,this.wrapper.prices),percentage:(0,n.ppmToPercentage)(i)}}}getWatchtowerFee(){let t=this.callerFeeShare+this.frontingFeeShare,e=this.wrapper.tokens[this.outputSwapToken],i=this.getInputGasAmountWithoutFee()*t*10n**BigInt(e.decimals)*1000000n/this.pricingInfo.swapPriceUSatPerToken/100000n,r=this.getInputAmountWithoutFee()*(t+this.executionFeeShare)/100000n;return{amountInSrcToken:(0,u.toTokenAmount)(r,u.BitcoinTokens.BTC,this.wrapper.prices),amountInDstToken:(0,u.toTokenAmount)(this.outputTotalSwap*(t+this.executionFeeShare)/100000n+i,e,this.wrapper.prices),usdValue:(t,e)=>this.wrapper.prices.getBtcUsdValue(r,t,e)}}getFee(){let t=this.getSwapFee(),e=this.getWatchtowerFee();return{amountInSrcToken:(0,u.toTokenAmount)(t.amountInSrcToken.rawAmount+e.amountInSrcToken.rawAmount,u.BitcoinTokens.BTC,this.wrapper.prices),amountInDstToken:(0,u.toTokenAmount)(t.amountInDstToken.rawAmount+e.amountInDstToken.rawAmount,this.wrapper.tokens[this.outputSwapToken],this.wrapper.prices),usdValue:(i,r)=>this.wrapper.prices.getBtcUsdValue(t.amountInSrcToken.rawAmount+e.amountInSrcToken.rawAmount,i,r)}}getFeeBreakdown(){return[{type:h.FeeType.SWAP,fee:this.getSwapFee()},{type:h.FeeType.NETWORK_OUTPUT,fee:this.getWatchtowerFee()}]}getOutput(){return(0,u.toTokenAmount)(this.outputTotalSwap,this.wrapper.tokens[this.outputSwapToken],this.wrapper.prices)}getGasDropOutput(){return(0,u.toTokenAmount)(this.outputTotalGas,this.wrapper.tokens[this.outputGasToken],this.wrapper.prices)}getInputWithoutFee(){return(0,u.toTokenAmount)(this.getInputAmountWithoutFee(),u.BitcoinTokens.BTC,this.wrapper.prices)}getInput(){return(0,u.toTokenAmount)(this.btcAmount,u.BitcoinTokens.BTC,this.wrapper.prices)}getRequiredConfirmationsCount(){return this.vaultRequiredConfirmations}async getTransactionDetails(){let[t,e]=this.vaultUtxo.split(":"),i=(0,o.toOutputScript)(this.wrapper.options.bitcoinNetwork,this.vaultBtcAddress),r=(0,o.toOutputScript)(this.wrapper.options.bitcoinNetwork,this.btcDestinationAddress),n=this.wrapper.contract.toOpReturnData(this.recipient,[this.outputTotalSwap/this.vaultTokenMultipliers[0],this.outputTotalGas/this.vaultTokenMultipliers[1]]),a=c.Buffer.concat([n.length>75?c.Buffer.from([106,76,n.length]):c.Buffer.from([106,n.length]),n]);if(this.callerFeeShare<0n||this.callerFeeShare>1048575n)throw Error("Caller fee out of bounds!");if(this.frontingFeeShare<0n||this.frontingFeeShare>1048575n)throw Error("Fronting fee out of bounds!");if(this.executionFeeShare<0n||this.executionFeeShare>1048575n)throw Error("Execution fee out of bounds!");let s=2147483648n|1048575n&this.callerFeeShare|(1047552n&this.frontingFeeShare)<<10n,l=2147483648n|1048575n&this.executionFeeShare|(1023n&this.frontingFeeShare)<<20n;return{in0txid:t,in0vout:parseInt(e),in0sequence:Number(s),vaultAmount:this.vaultUtxoValue,vaultScript:i,in1sequence:Number(l),out1script:a,out2amount:this.btcAmount,out2script:r,locktime:5e8+Math.floor(1e9*Math.random())}}async getPsbt(){let t=await this.getTransactionDetails(),e=new l.Transaction({allowUnknownOutputs:!0,allowLegacyWitnessUtxo:!0,lockTime:t.locktime});return e.addInput({txid:t.in0txid,index:t.in0vout,witnessUtxo:{amount:t.vaultAmount,script:t.vaultScript},sequence:t.in0sequence}),e.addOutput({amount:t.vaultAmount,script:t.vaultScript}),e.addOutput({amount:0n,script:t.out1script}),e.addOutput({amount:t.out2amount,script:t.out2script}),{psbt:e,in1sequence:t.in1sequence}}async getFundedPsbt(t,e){let i;if(i=(0,p.isIBitcoinWallet)(t)?t:new f.SingleAddressBitcoinWallet(this.wrapper.btcRpc,this.wrapper.options.bitcoinNetwork,t),null!=e){if(e<this.minimumBtcFeeRate)throw Error("Bitcoin tx fee needs to be at least "+this.minimumBtcFeeRate+" sats/vB")}else e=Math.max(this.minimumBtcFeeRate,await i.getFeeRate());let{psbt:r,in1sequence:n}=await this.getPsbt();(r=await i.fundPsbt(r,e)).updateInput(1,{sequence:n});let a=[];for(let t=1;t<r.inputsLength;t++)a.push(t);return{psbt:r,signInputs:a}}async submitPsbt(t){var e,i;if(this.expiry<Date.now())throw Error("Quote expired!");if(this.state!==r.QUOTE_SOFT_EXPIRED&&this.state!==r.CREATED)throw Error("Invalid swap state!");for(let e=1;e<t.inputsLength;e++){if("legacy"===(0,l.getInputType)(t.getInput(e)).txType)throw Error("Legacy (non-segwit) inputs are not allowed in the transaction!");t.finalizeIdx(e)}let n=await this.wrapper.btcRpc.parseTransaction(c.Buffer.from(t.toBytes(!0)).toString("hex")),a=await this.wrapper.contract.getWithdrawalData(n);if(this.logger.debug("submitPsbt(): parsed withdrawal data: ",a),!a.isRecipient(this.recipient)||a.rawAmounts[0]*this.vaultTokenMultipliers[0]!==this.outputTotalSwap||(null!=(e=a.rawAmounts[1])?e:0n)*this.vaultTokenMultipliers[1]!==this.outputTotalGas||a.callerFeeRate!==this.callerFeeShare||a.frontingFeeRate!==this.frontingFeeShare||a.executionFeeRate!==this.executionFeeShare||a.getSpentVaultUtxo()!==this.vaultUtxo||BigInt(a.getNewVaultBtcAmount())!==this.vaultUtxoValue||!a.getNewVaultScript().equals((0,o.toOutputScript)(this.wrapper.options.bitcoinNetwork,this.vaultBtcAddress))||null!=a.getExecutionData())throw Error("Invalid withdrawal tx data submitted!");let s=t.getOutput(2);if(s.amount!==this.btcAmount||!(0,o.toOutputScript)(this.wrapper.options.bitcoinNetwork,this.btcDestinationAddress).equals(c.Buffer.from(s.script)))throw Error("Invalid LP bitcoin output in transaction!");if(await this.wrapper.btcRpc.isSpent(this.vaultUtxo))throw Error("Vault UTXO already spent, please create new swap!");try{await this.wrapper.contract.checkWithdrawalTx(a)}catch(t){throw Error("Transaction not parsable by the contract: "+(null!=(i=t.message)?i:t.toString()))}if(this.expiry<Date.now())throw Error("Quote expired!");this.data=a,this.initiated=!0,await this._saveAndEmit(r.SIGNED);try{await d.IntermediaryAPI.initSpvFromBTC(this.chainIdentifier,this.url,{quoteId:this.quoteId,psbtHex:c.Buffer.from(t.toPSBT(0)).toString("hex")}),await this._saveAndEmit(r.POSTED)}catch(t){throw await this._saveAndEmit(r.DECLINED),t}return this.data.getTxId()}async estimateBitcoinFee(t,e){let i=await t.getFundedPsbtFee((await this.getPsbt()).psbt,e);return(0,u.toTokenAmount)(null==i?null:BigInt(i),u.BitcoinTokens.BTC,this.wrapper.prices)}async sendBitcoinTransaction(t,e){let{psbt:i,signInputs:r}=await this.getFundedPsbt(t,e);return i=await t.signPsbt(i,r),await this.submitPsbt(i)}async getBitcoinPayment(){var t,e,i,r;if((null==(e=this.data)||null==(t=e.btcTx)?void 0:t.txid)==null)return null;let n=await this.wrapper.btcRpc.getTransaction(null==(r=this.data)||null==(i=r.btcTx)?void 0:i.txid);return null==n?null:{txId:n.txid,confirmations:n.confirmations,targetConfirmations:this.vaultRequiredConfirmations}}async waitForBitcoinTransaction(t,e,i){if(this.state!==r.POSTED&&this.state!==r.BROADCASTED&&!(this.state===r.QUOTE_SOFT_EXPIRED&&this.initiated))throw Error("Must be in POSTED or BROADCASTED state!");let n=await this.wrapper.btcRpc.waitForTransaction(this.data.btcTx.txid,this.vaultRequiredConfirmations,(t,e,n)=>{null!=i&&i(e,t,this.vaultRequiredConfirmations,n),null!=e&&(this.state===r.POSTED||this.state==r.QUOTE_SOFT_EXPIRED)&&this._saveAndEmit(r.BROADCASTED)},t,e);return null!=t&&t.throwIfAborted(),this.state!==r.FRONTED&&this.state!==r.CLAIMED&&await this._saveAndEmit(r.BTC_TX_CONFIRMED),n.txid}async txsClaim(t){if(!this.isClaimable())throw Error("Must be in BTC_TX_CONFIRMED state!");let e=await this.wrapper.contract.getVaultData(this.vaultOwner,this.vaultId),i=[await this.wrapper.btcRpc.getTransaction(this.data.btcTx.txid)],r=e.getUtxo();for(;i[0].ins[0].txid+":"+i[0].ins[0].vout!==r;)i.unshift(await this.wrapper.btcRpc.getTransaction(i[0].ins[0].txid));let n=[];for(let t of i)n.push(await this.wrapper.contract.getWithdrawalData(t));return await this.wrapper.contract.txsClaim(null==t?this._getInitiator():t.getAddress(),e,n.map(t=>({tx:t})),this.wrapper.synchronizer,!0)}async claim(t,e){let i;try{i=await this.wrapper.chain.sendAndConfirm(t,await this.txsClaim(t),!0,e)}catch(e){if(this.logger.info("claim(): Failed to claim ourselves, checking swap claim state..."),this.state===r.CLAIMED)return this.logger.info("claim(): Transaction state is CLAIMED, swap was successfully claimed by the watchtower"),this.claimTxId;let t=await this.wrapper.contract.getWithdrawalState(this.data.btcTx.txid);if(t.type===a.SpvWithdrawalStateType.CLAIMED)return this.logger.info("claim(): Transaction status is CLAIMED, swap was successfully claimed by the watchtower"),this.claimTxId=t.txId,await this._saveAndEmit(r.CLAIMED),null;throw e}return this.claimTxId=i[0],(this.state===r.POSTED||this.state===r.BROADCASTED||this.state===r.BTC_TX_CONFIRMED||this.state===r.FAILED||this.state===r.FRONTED)&&await this._saveAndEmit(r.CLAIMED),i[0]}async watchdogWaitTillResult(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5,i={type:a.SpvWithdrawalStateType.NOT_FOUND};for(;i.type===a.SpvWithdrawalStateType.NOT_FOUND;){await (0,o.timeoutPromise)(1e3*e,t);try{i=await this.wrapper.contract.getWithdrawalState(this.data.btcTx.txid)}catch(t){this.logger.error("watchdogWaitTillResult(): Error when fetching commit status: ",t)}}return null!=t&&t.throwIfAborted(),i}async waitTillClaimedOrFronted(t){if(this.state===r.CLAIMED||this.state===r.FRONTED)return Promise.resolve();let e=new AbortController;null!=t&&t.addEventListener("abort",()=>e.abort(t.reason));let i=await Promise.race([this.watchdogWaitTillResult(e.signal),this.waitTillState(r.CLAIMED,"eq",e.signal).then(()=>0),this.waitTillState(r.FRONTED,"eq",e.signal).then(()=>1),this.waitTillState(r.FAILED,"eq",e.signal).then(()=>2)]);if(e.abort(),"number"==typeof i){if(0===i)return void this.logger.debug("waitTillClaimedOrFronted(): Resolved from state change (CLAIMED)");if(1===i)return void this.logger.debug("waitTillClaimedOrFronted(): Resolved from state change (FRONTED)");if(2===i)throw this.logger.debug("waitTillClaimedOrFronted(): Resolved from state change (FAILED)"),Error("Swap failed while waiting for claim or front");return}this.logger.debug("waitTillClaimedOrFronted(): Resolved from watchdog"),i.type===a.SpvWithdrawalStateType.FRONTED&&(this.state!==r.FRONTED||this.state!==r.CLAIMED)&&(this.frontTxId=i.txId,await this._saveAndEmit(r.FRONTED)),i.type===a.SpvWithdrawalStateType.CLAIMED&&this.state!==r.CLAIMED&&(this.claimTxId=i.txId,await this._saveAndEmit(r.FRONTED)),i.type===a.SpvWithdrawalStateType.CLOSED&&this.state!==r.CLOSED&&await this._saveAndEmit(r.CLOSED)}async waitTillExecuted(t,e,i){await this.waitForBitcoinTransaction(t,e,i),await this.waitTillClaimedOrFronted(t)}serialize(){var t;return{...super.serialize(),quoteId:this.quoteId,recipient:this.recipient,vaultOwner:this.vaultOwner,vaultId:this.vaultId.toString(10),vaultRequiredConfirmations:this.vaultRequiredConfirmations,vaultTokenMultipliers:this.vaultTokenMultipliers.map(t=>t.toString(10)),vaultBtcAddress:this.vaultBtcAddress,vaultUtxo:this.vaultUtxo,vaultUtxoValue:this.vaultUtxoValue.toString(10),btcDestinationAddress:this.btcDestinationAddress,btcAmount:this.btcAmount.toString(10),btcAmountSwap:this.btcAmountSwap.toString(10),btcAmountGas:this.btcAmountGas.toString(10),minimumBtcFeeRate:this.minimumBtcFeeRate,outputTotalSwap:this.outputTotalSwap.toString(10),outputSwapToken:this.outputSwapToken,outputTotalGas:this.outputTotalGas.toString(10),outputGasToken:this.outputGasToken,gasSwapFeeBtc:this.gasSwapFeeBtc.toString(10),gasSwapFee:this.gasSwapFee.toString(10),callerFeeShare:this.callerFeeShare.toString(10),frontingFeeShare:this.frontingFeeShare.toString(10),executionFeeShare:this.executionFeeShare.toString(10),claimTxId:this.claimTxId,frontTxId:this.frontTxId,data:null==(t=this.data)?void 0:t.serialize()}}async syncStateFromBitcoin(t){var e;if((null==(e=this.data)?void 0:e.btcTx)==null)return!1;let i=await this.getBitcoinPayment();if(null==i){for(let e of this.data.btcTx.ins)if(await this.wrapper.btcRpc.isSpent(e.txid+":"+e.vout,!0))return this.state===r.SIGNED||this.state===r.POSTED||this.state===r.QUOTE_SOFT_EXPIRED||this.state===r.DECLINED?this.state=r.QUOTE_EXPIRED:this.state=r.FAILED,t&&await this._saveAndEmit(),!0}else if(i.confirmations>=this.vaultRequiredConfirmations){if(this.state!==r.FRONTED&&this.state!==r.CLAIMED)return this.state=r.BTC_TX_CONFIRMED,t&&await this._saveAndEmit(),!0}else if(this.state===r.QUOTE_SOFT_EXPIRED||this.state===r.POSTED||this.state===r.SIGNED||this.state===r.DECLINED)return this.state=r.BROADCASTED,t&&await this._saveAndEmit(),!0;return!1}async syncStateFromChain(){let t=!1;if((this.state===r.SIGNED||this.state===r.POSTED||this.state===r.BROADCASTED||this.state===r.QUOTE_SOFT_EXPIRED||this.state===r.DECLINED)&&await this.syncStateFromBitcoin(!1)&&(t||(t=!0)),this.state===r.BROADCASTED||this.state===r.BTC_TX_CONFIRMED){let e=await this.wrapper.contract.getWithdrawalState(this.data.btcTx.txid);switch(this.logger.debug("syncStateFromChain(): status of "+this.data.btcTx.txid,e),e.type){case a.SpvWithdrawalStateType.FRONTED:this.frontTxId=e.txId,this.state=r.FRONTED,t||(t=!0);break;case a.SpvWithdrawalStateType.CLAIMED:this.claimTxId=e.txId,this.state=r.CLAIMED,t||(t=!0);break;case a.SpvWithdrawalStateType.CLOSED:this.state=r.CLOSED,t||(t=!0)}}return(this.state===r.CREATED||this.state===r.SIGNED||this.state===r.POSTED)&&this.expiry<Date.now()&&(this.state===r.CREATED?this.state=r.QUOTE_EXPIRED:this.state=r.QUOTE_SOFT_EXPIRED,t||(t=!0)),t}async _sync(t){let e=await this.syncStateFromChain();return e&&t&&await this._saveAndEmit(),e}async _tick(t){if((this.state===r.CREATED||this.state===r.SIGNED)&&this.getQuoteExpiry()<Date.now())return this.state=r.QUOTE_SOFT_EXPIRED,t&&await this._saveAndEmit(),!0;if(this.state===r.QUOTE_SOFT_EXPIRED&&!this.initiated&&this.expiry<Date.now())return this.state=r.QUOTE_EXPIRED,t&&await this._saveAndEmit(),!0;if(Math.floor(Date.now()/1e3)%120==0&&(this.state===r.POSTED||this.state===r.BROADCASTED))try{return await this.syncStateFromBitcoin(t)}catch(t){this.logger.error("tickSwap("+this.getId()+"): ",t)}}constructor(t,e){if(g(e)&&(e.url+="/frombtc_spv"),super(t,e),this.TYPE=s.SwapType.SPV_VAULT_FROM_BTC,g(e)){this.state=r.CREATED;let t=(0,o.toCoinselectAddressType)((0,o.toOutputScript)(this.wrapper.options.bitcoinNetwork,this.vaultBtcAddress));if("p2tr"!==t&&"p2wpkh"!==t&&"p2wsh"!==t)throw Error("Vault address type must be of witness type: p2tr, p2wpkh, p2wsh")}else this.quoteId=e.quoteId,this.recipient=e.recipient,this.vaultOwner=e.vaultOwner,this.vaultId=BigInt(e.vaultId),this.vaultRequiredConfirmations=e.vaultRequiredConfirmations,this.vaultTokenMultipliers=e.vaultTokenMultipliers.map(t=>BigInt(t)),this.vaultBtcAddress=e.vaultBtcAddress,this.vaultUtxo=e.vaultUtxo,this.vaultUtxoValue=BigInt(e.vaultUtxoValue),this.btcDestinationAddress=e.btcDestinationAddress,this.btcAmount=BigInt(e.btcAmount),this.btcAmountSwap=BigInt(e.btcAmountSwap),this.btcAmountGas=BigInt(e.btcAmountGas),this.minimumBtcFeeRate=e.minimumBtcFeeRate,this.outputTotalSwap=BigInt(e.outputTotalSwap),this.outputSwapToken=e.outputSwapToken,this.outputTotalGas=BigInt(e.outputTotalGas),this.outputGasToken=e.outputGasToken,this.gasSwapFeeBtc=BigInt(e.gasSwapFeeBtc),this.gasSwapFee=BigInt(e.gasSwapFee),this.callerFeeShare=BigInt(e.callerFeeShare),this.frontingFeeShare=BigInt(e.frontingFeeShare),this.executionFeeShare=BigInt(e.executionFeeShare),this.claimTxId=e.claimTxId,this.frontTxId=e.frontTxId,this.data=null==e.data?null:new this.wrapper.spvWithdrawalDataDeserializer(e.data);this.tryCalculateSwapFee(),this.logger=(0,o.getLogger)("SPVFromBTC("+this.getId()+"): ")}}i.SpvFromBTCSwap=m},75357,(t,e,i)=>{"use strict";var r=t.i(467034);Object.defineProperty(i,"__esModule",{value:!0}),i.SpvFromBTCWrapper=void 0;let n=t.r(462501),a=t.r(991989),s=t.r(348652),o=t.r(446598),l=t.r(865854),u=t.r(559766),c=t.r(366913),h=t.r(686157),p=t.r(145617),d=t.r(960474);class f extends n.ISwapWrapper{processEventFront(t,e){return(e.state===s.SpvFromBTCSwapState.SIGNED||e.state===s.SpvFromBTCSwapState.POSTED||e.state===s.SpvFromBTCSwapState.BROADCASTED||e.state===s.SpvFromBTCSwapState.DECLINED||e.state===s.SpvFromBTCSwapState.QUOTE_SOFT_EXPIRED||e.state===s.SpvFromBTCSwapState.BTC_TX_CONFIRMED)&&(e.state=s.SpvFromBTCSwapState.FRONTED,!0)}processEventClaim(t,e){return(e.state===s.SpvFromBTCSwapState.SIGNED||e.state===s.SpvFromBTCSwapState.POSTED||e.state===s.SpvFromBTCSwapState.BROADCASTED||e.state===s.SpvFromBTCSwapState.DECLINED||e.state===s.SpvFromBTCSwapState.QUOTE_SOFT_EXPIRED||e.state===s.SpvFromBTCSwapState.BTC_TX_CONFIRMED)&&(e.state=s.SpvFromBTCSwapState.CLAIMED,!0)}processEventClose(t,e){return(e.state===s.SpvFromBTCSwapState.SIGNED||e.state===s.SpvFromBTCSwapState.POSTED||e.state===s.SpvFromBTCSwapState.BROADCASTED||e.state===s.SpvFromBTCSwapState.DECLINED||e.state===s.SpvFromBTCSwapState.QUOTE_SOFT_EXPIRED||e.state===s.SpvFromBTCSwapState.BTC_TX_CONFIRMED)&&(e.state=s.SpvFromBTCSwapState.CLOSED,!0)}async processEvent(t,e){var i,r;if(null==e)return;let n=!1;return t instanceof a.SpvVaultFrontEvent&&(n=this.processEventFront(t,e),(null==(i=t.meta)?void 0:i.txId)!=null&&e.frontTxId!==t.meta.txId&&(e.frontTxId=t.meta.txId,n||(n=!0))),t instanceof a.SpvVaultClaimEvent&&(n=this.processEventClaim(t,e),(null==(r=t.meta)?void 0:r.txId)!=null&&e.claimTxId!==t.meta.txId&&(e.claimTxId=t.meta.txId,n||(n=!0))),t instanceof a.SpvVaultCloseEvent&&(n=this.processEventClose(t,e)),this.logger.info("processEvents(): "+t.constructor.name+" processed for "+e.getId()+" swap: ",e),n&&await e._saveAndEmit(),!0}async preFetchCallerFeeShare(t,e,i,r,n,a){if(i.unsafeZeroWatchtowerFee||0n===e.amount)return 0n;try{let t,[s,o,l,c,h]=await Promise.all([(0,u.tryWithRetries)(()=>this.btcRelay.getFeePerBlock(),null,null,a.signal),(0,u.tryWithRetries)(()=>this.btcRelay.getTipData(),null,null,a.signal),this.btcRpc.getTipHeight(),(0,u.tryWithRetries)(()=>this.contract.getClaimFee(this.chain.randomAddress(),null,null),null,null,a.signal),null!=n?n:e.token===this.chain.getNativeCurrencyAddress()?r:this.prices.preFetchPrice(this.chainIdentifier,this.chain.getNativeCurrencyAddress(),a.signal)]),p=o.blockheight,d=Math.max(l-p+this.options.maxConfirmations,0),f=(BigInt(d)*s+c*BigInt(this.options.maxTransactionsDelta))*BigInt(Math.floor(1e6*i.feeSafetyFactor))/1000000n;if(e.exactIn)t=await this.prices.getFromBtcSwapAmount(this.chainIdentifier,e.amount,this.chain.getNativeCurrencyAddress(),a.signal,h)-f;else if(e.token===this.chain.getNativeCurrencyAddress())t=e.amount;else{let i=await this.prices.getToBtcSwapAmount(this.chainIdentifier,e.amount,e.token,a.signal,await r);t=await this.prices.getFromBtcSwapAmount(this.chainIdentifier,i,this.chain.getNativeCurrencyAddress(),a.signal,h)}this.logger.debug("preFetchCallerFeeShare(): Caller fee in native token: "+f.toString(10)+" total payout in native token: "+t.toString(10));let g=(100000n*f+t-1n)/t;if(g<0n)return 0n;if(g>=2n**20n)return 2n**20n-1n;return g}catch(t){return a.abort(t),null}}async verifyReturnedData(t,e,i,r,n,a){let s,o,l,c,h;if(t.btcFeeRate>await a)throw new p.IntermediaryError("Bitcoin fee rate returned too high!");try{s=(0,u.toOutputScript)(this.options.bitcoinNetwork,t.vaultBtcAddress),o=(0,u.toCoinselectAddressType)(s),l=(0,u.toOutputScript)(this.options.bitcoinNetwork,t.btcAddress)}catch(t){throw new p.IntermediaryError("Invalid btc address data returned!")}let d=t.btcUtxo.split(":");if(t.address!==i.getAddress(this.chainIdentifier)||t.vaultId<0n||null==s||null==l||"p2pkh"===o||"p2sh-p2wpkh"===o||2!==d.length||64!==d[0].length||isNaN(parseInt(d[1]))||t.btcFeeRate<1||t.btcFeeRate>1e4)throw new p.IntermediaryError("Invalid vault data returned!");if(t.btcAmountSwap+t.btcAmountGas!==t.btcAmount)throw Error("Btc amount mismatch");if(t.swapFeeBtc+t.gasSwapFeeBtc!==t.totalFeeBtc)throw Error("Btc fee mismatch");if(t.callerFeeShare!==n||0n!==t.frontingFeeShare||0n!==t.executionFeeShare)throw new p.IntermediaryError("Invalid caller/fronting/execution fee returned");if(t.expiry<Math.floor(Date.now()/1e3))throw new p.IntermediaryError("Quote already expired");try{c=await this.contract.getVaultData(t.address,t.vaultId)}catch(e){throw this.logger.error("Error getting spv vault (owner: "+t.address+" vaultId: "+t.vaultId.toString(10)+"): ",e),new p.IntermediaryError("Spv swap vault not found!")}if(!c.isOpened())throw new p.IntermediaryError("Returned spv swap vault is not opened!");if(c.getConfirmations()>this.options.maxConfirmations)throw new p.IntermediaryError("SPV swap vault needs too many confirmations: "+c.getConfirmations());let f=c.getTokenData();if(e.exactIn){if(t.btcAmount!==e.amount)throw new p.IntermediaryError("Invalid amount returned")}else{let i=e.amount/f[0].multiplier*f[0].multiplier;if((e.amount-i)*1000000n/e.amount>this.options.maxRawAmountAdjustmentDifferencePPM)throw new p.IntermediaryError("Invalid amount0 multiplier used, rawAmount diff too high");if(t.total!==i)throw new p.IntermediaryError("Invalid total returned")}if(null==r.gasAmount||0n===r.gasAmount){if(0n!==t.totalGas)throw new p.IntermediaryError("Invalid gas total returned")}else{let e=r.gasAmount/f[0].multiplier*f[0].multiplier;if((r.gasAmount-e)*1000000n/r.gasAmount>this.options.maxRawAmountAdjustmentDifferencePPM)throw new p.IntermediaryError("Invalid amount1 multiplier used, rawAmount diff too high");if(t.totalGas!==e)throw new p.IntermediaryError("Invalid gas total returned")}let g=t.btcUtxo.toLowerCase(),[m,w]=g.split(":"),y=await this.btcRpc.getTransaction(m);if(null==y.confirmations||y.confirmations<1)throw new p.IntermediaryError("SPV vault UTXO not confirmed");let T=parseInt(w);if(null==y.outs[T])throw new p.IntermediaryError("Invalid UTXO, doesn't exist");let S=y.outs[T].value;if(await this.btcRpc.isSpent(g))throw new p.IntermediaryError("Returned spv vault UTXO is already spent");this.logger.debug("verifyReturnedData(): Vault UTXO: "+c.getUtxo()+" current utxo: "+g);let E=[];for(;c.getUtxo()!==g;){let[t,e]=g.split(":");y.txid!==t&&(y=await this.btcRpc.getTransaction(t));let i=await this.contract.getWithdrawalData(y);if(E.unshift(i),g=E[0].getSpentVaultUtxo(),this.logger.debug("verifyReturnedData(): Vault UTXO: "+c.getUtxo()+" current utxo: "+g),E.length>=this.options.maxTransactionsDelta)throw new p.IntermediaryError("BTC <> SC state difference too deep, maximum: "+this.options.maxTransactionsDelta)}try{h=c.calculateStateAfter(E)}catch(e){throw this.logger.error("Error calculating spv vault balance (owner: "+t.address+" vaultId: "+t.vaultId.toString(10)+"): ",e),new p.IntermediaryError("Spv swap vault balance prediction failed!")}if(h.balances[0].scaledAmount<t.total)throw new p.IntermediaryError("SPV swap vault, insufficient balance, required: "+t.total.toString(10)+" has: "+h.balances[0].scaledAmount.toString(10));if(h.balances[1].scaledAmount<t.totalGas)throw new p.IntermediaryError("SPV swap vault, insufficient balance, required: "+t.totalGas.toString(10)+" has: "+h.balances[1].scaledAmount.toString(10));try{for(let t of E)await this.contract.checkWithdrawalTx(t)}catch(e){throw this.logger.error("Error calculating spv vault balance (owner: "+t.address+" vaultId: "+t.vaultId.toString(10)+"): ",e),new p.IntermediaryError("Spv swap vault balance prediction failed!")}return{vault:c,vaultUtxoValue:S}}create(t,e,i,r,n,a){var o,p;null!=r||(r={}),null!=(o=r).gasAmount||(o.gasAmount=0n),null!=(p=r).feeSafetyFactor||(p.feeSafetyFactor=1.25);let d=(0,u.extendAbortController)(a),f=this.preFetchPrice(e,d.signal),g=this.chain.getNativeCurrencyAddress(),m=0n===r.gasAmount?null:this.preFetchPrice({token:g},d.signal),w=this.preFetchCallerFeeShare(t,e,r,f,m,d),y=null!=r.maxAllowedNetworkFeeRate?Promise.resolve(r.maxAllowedNetworkFeeRate):this.btcRpc.getFeeRate().then(t=>this.options.maxBtcFeeOffset+t*this.options.maxBtcFeeMultiplier).catch(t=>(d.abort(t),null));return i.map(i=>({intermediary:i,quote:(async()=>{let a=(0,u.extendAbortController)(d.signal);try{var o;let p=await (0,u.tryWithRetries)(async s=>await c.IntermediaryAPI.prepareSpvFromBTC(this.chainIdentifier,i.url,{address:t,amount:e.amount,token:e.token.toString(),exactOut:!e.exactIn,gasToken:g,gasAmount:r.gasAmount,callerFeeRate:w,frontingFeeRate:0n,additionalParams:n},this.options.postRequestTimeout,a.signal,!(s>0)&&null),null,t=>t instanceof h.RequestError,a.signal);this.logger.debug("create("+i.url+"): LP response: ",p);let d=await w,[T,S,{vault:E,vaultUtxoValue:I}]=await Promise.all([this.verifyReturnedPrice(i.services[l.SwapType.SPV_VAULT_FROM_BTC],!1,p.btcAmountSwap,p.total*(100000n+d)/100000n,e.token,{},f,a.signal),0n===r.gasAmount?Promise.resolve():this.verifyReturnedPrice({...i.services[l.SwapType.SPV_VAULT_FROM_BTC],swapBaseFee:0},!1,p.btcAmountGas,p.totalGas*(100000n+d)/100000n,g,{},m,a.signal),this.verifyReturnedData(p,e,i,r,d,y)]),v={pricingInfo:T,url:i.url,expiry:1e3*p.expiry,swapFee:p.swapFee,swapFeeBtc:p.swapFeeBtc,exactIn:null==(o=e.exactIn)||o,quoteId:p.quoteId,recipient:t,vaultOwner:p.address,vaultId:p.vaultId,vaultRequiredConfirmations:E.getConfirmations(),vaultTokenMultipliers:E.getTokenData().map(t=>t.multiplier),vaultBtcAddress:p.vaultBtcAddress,vaultUtxo:p.btcUtxo,vaultUtxoValue:BigInt(I),btcDestinationAddress:p.btcAddress,btcAmount:p.btcAmount,btcAmountSwap:p.btcAmountSwap,btcAmountGas:p.btcAmountGas,minimumBtcFeeRate:p.btcFeeRate,outputTotalSwap:p.total,outputSwapToken:e.token,outputTotalGas:p.totalGas,outputGasToken:g,gasSwapFeeBtc:p.gasSwapFeeBtc,gasSwapFee:p.gasSwapFee,callerFeeShare:p.callerFeeShare,frontingFeeShare:p.frontingFeeShare,executionFeeShare:p.executionFeeShare},b=new s.SpvFromBTCSwap(this,v);return await b._save(),b}catch(t){throw a.abort(t),t}})()}))}getDummySwapPsbt(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],e=new d.Transaction({allowUnknownInputs:!0,allowLegacyWitnessUtxo:!0,allowUnknownOutputs:!0}),i=d.OutScript.encode({type:"tr",pubkey:r.Buffer.from("0101010101010101010101010101010101010101010101010101010101010101","hex")});e.addInput({txid:(0,u.randomBytes)(32),index:0,witnessUtxo:{script:i,amount:600n}}),e.addOutput({script:i,amount:600n});let n=this.contract.toOpReturnData(this.chain.randomAddress(),t?[0xffffffffffffffffn,0xffffffffffffffffn]:[0xffffffffffffffffn]);return e.addOutput({script:r.Buffer.concat([n.length<=75?r.Buffer.from([106,n.length]):r.Buffer.from([106,76,n.length]),n]),amount:0n}),e}constructor(t,e,i,r,n,a,u,c,h,p,d,f,g){var m,w,y,T,S,E,I;null==f&&(f={}),null!=(m=f).bitcoinNetwork||(m.bitcoinNetwork=o.TEST_NETWORK),null!=(w=f).maxConfirmations||(w.maxConfirmations=6),null!=(y=f).bitcoinBlocktime||(y.bitcoinBlocktime=600),null!=(T=f).maxTransactionsDelta||(T.maxTransactionsDelta=3),null!=(S=f).maxRawAmountAdjustmentDifferencePPM||(S.maxRawAmountAdjustmentDifferencePPM=100),null!=(E=f).maxBtcFeeOffset||(E.maxBtcFeeOffset=5),null!=(I=f).maxBtcFeeMultiplier||(I.maxBtcFeeMultiplier=1.5),super(t,e,i,r,a,u,f,g),this.TYPE=l.SwapType.SPV_VAULT_FROM_BTC,this.swapDeserializer=s.SpvFromBTCSwap,this.pendingSwapStates=[s.SpvFromBTCSwapState.CREATED,s.SpvFromBTCSwapState.SIGNED,s.SpvFromBTCSwapState.POSTED,s.SpvFromBTCSwapState.QUOTE_SOFT_EXPIRED,s.SpvFromBTCSwapState.BROADCASTED,s.SpvFromBTCSwapState.DECLINED,s.SpvFromBTCSwapState.BTC_TX_CONFIRMED],this.tickSwapState=[s.SpvFromBTCSwapState.CREATED,s.SpvFromBTCSwapState.QUOTE_SOFT_EXPIRED,s.SpvFromBTCSwapState.SIGNED,s.SpvFromBTCSwapState.POSTED,s.SpvFromBTCSwapState.BROADCASTED],this.spvWithdrawalDataDeserializer=c,this.contract=n,this.btcRelay=h,this.synchronizer=p,this.btcRpc=d}}i.SpvFromBTCWrapper=f},920002,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.SwapperUtils=void 0;let r=t.r(20349),n=t.r(960474),a=t.r(54111),s=t.r(865854),o=t.r(768270),l=t.r(902866),u=t.r(991989),c=t.r(559766);i.SwapperUtils=class{isLightningInvoice(t){try{return(0,r.decode)(t),!0}catch(t){}return!1}isValidBitcoinAddress(t){try{return(0,n.Address)(this.bitcoinNetwork).decode(t),!0}catch(t){return!1}}isValidLightningInvoice(t){try{let e=(0,r.decode)(t);if(null!=e.millisatoshis)return!0}catch(t){}return!1}isValidLNURL(t){return a.LNURL.isLNURL(t)}getLNURLTypeAndData(t,e){return a.LNURL.getLNURLType(t,e)}getLightningInvoiceValue(t){let e=(0,r.decode)(t);return null!=e.millisatoshis?(BigInt(e.millisatoshis)+999n)/1000n:null}parseBitcoinAddress(t){let e=null;if(t.includes("?")){let i=t.split("?");for(let r of(t=i[0],i[1].split("&"))){let t=r.split("="),i=t[0],n=decodeURIComponent(t[1]);"amount"===i&&(e=(0,o.fromDecimal)(parseFloat(n).toFixed(8),8))}}if(this.isValidBitcoinAddress(t))return{address:t,type:"BITCOIN",swapType:s.SwapType.TO_BTC,amount:(0,o.toTokenAmount)(e,o.BitcoinTokens.BTC,this.root.prices)}}parseLNURLSync(t){if(this.isValidLNURL(t))return{address:t,type:"LNURL",swapType:null}}async parseLNURL(t){if(this.isValidLNURL(t))try{let e=await this.getLNURLTypeAndData(t);if(null==e)throw Error("Invalid LNURL specified!");let i={address:t,type:"LNURL",swapType:(0,a.isLNURLPay)(e)?s.SwapType.TO_BTCLN:(0,a.isLNURLWithdraw)(e)?s.SwapType.FROM_BTCLN:null,lnurl:e};if(e.min===e.max)return{...i,amount:(0,o.toTokenAmount)(e.min,o.BitcoinTokens.BTCLN,this.root.prices)};return{...i,min:(0,o.toTokenAmount)(e.min,o.BitcoinTokens.BTCLN,this.root.prices),max:(0,o.toTokenAmount)(e.max,o.BitcoinTokens.BTCLN,this.root.prices)}}catch(t){throw Error("Failed to contact LNURL service, check your internet connection and retry later.")}}parseLightningInvoice(t){if(this.isLightningInvoice(t))if(this.isValidLightningInvoice(t)){let e=this.getLightningInvoiceValue(t);return{address:t,type:"LIGHTNING",swapType:s.SwapType.TO_BTCLN,amount:(0,o.toTokenAmount)(e,o.BitcoinTokens.BTCLN,this.root.prices)}}else throw Error("Lightning invoice needs to contain an amount!")}parseSmartchainAddress(t){for(let e of this.root.getSmartChains())if(this.root.chains[e].chainInterface.isValidAddress(t))if(this.root.supportsSwapType(e,s.SwapType.SPV_VAULT_FROM_BTC))return{address:t,type:e,swapType:s.SwapType.SPV_VAULT_FROM_BTC};else return{address:t,type:e,swapType:null}}async parseAddress(t){if(t.startsWith("bitcoin:")){let e=this.parseBitcoinAddress(t.substring(8));if(null!=e)return e;throw Error("Invalid bitcoin address!")}let e=this.parseBitcoinAddress(t);if(null!=e)return e;if(t.startsWith("lightning:")){let e=t.substring(10),i=await this.parseLNURL(e);if(null!=i)return i;let r=this.parseLightningInvoice(e);if(null!=r)return r;throw Error("Invalid lightning network invoice or LNURL!")}let i=await this.parseLNURL(t);if(null!=i)return i;let r=this.parseLightningInvoice(t);return null!=r?r:this.parseSmartchainAddress(t)}parseAddressSync(t){if(t.startsWith("bitcoin:")){let e=this.parseBitcoinAddress(t.substring(8));if(null!=e)return e;throw Error("Invalid bitcoin address!")}let e=this.parseBitcoinAddress(t);if(null!=e)return e;if(t.startsWith("lightning:")){let e=t.substring(10),i=this.parseLNURLSync(e);if(null!=i)return i;let r=this.parseLightningInvoice(e);if(null!=r)return r;throw Error("Invalid lightning network invoice or LNURL!")}let i=this.parseLNURLSync(t);if(null!=i)return i;let r=this.parseLightningInvoice(t);return null!=r?r:this.parseSmartchainAddress(t)}getRandomSpvVaultPsbt(t,e){let i=this.root.chains[t].wrappers[s.SwapType.SPV_VAULT_FROM_BTC];if(null==i)throw Error("Chain doesn't support spv vault swaps!");return i.getDummySwapPsbt(e)}async getBitcoinSpendableBalance(t,e,i){var r;let n,a;if("string"!=typeof t&&null==t.getTransactionFee)throw Error("Wallet must be a string address or IBitcoinWallet");n="string"==typeof t?new l.SingleAddressBitcoinWallet(this.root.bitcoinRpc,this.bitcoinNetwork,t):t;let u=null!=(r=null==i?void 0:i.feeRate)?r:await n.getFeeRate();return(null==i?void 0:i.minFeeRate)!=null&&(u=Math.max(u,i.minFeeRate)),a=null!=e&&this.root.supportsSwapType(e,s.SwapType.SPV_VAULT_FROM_BTC)?await n.getSpendableBalance(this.getRandomSpvVaultPsbt(e,null==i?void 0:i.gasDrop),u):await n.getSpendableBalance(void 0,u),{balance:(0,o.toTokenAmount)(a.balance,o.BitcoinTokens.BTC,this.root.prices),feeRate:a.feeRate}}async getSpendableBalance(t,e,i){let r;if("string"!=typeof t&&null==t.getAddress)throw Error("Signer must be a string or smart chain signer");if(null==this.root.chains[e.chainId])throw Error("Invalid chain identifier! Unknown chain: "+e.chainId);let{swapContract:n,chainInterface:a}=this.root.chains[e.chainId],s="string"==typeof t?t:t.getAddress();if(a.getNativeCurrencyAddress()!==e.address)r=await a.getBalance(s,e.address);else{let[t,o]=await Promise.all([a.getBalance(s,e.address),n.getCommitFee(await n.createSwapData(u.ChainSwapType.HTLC,s,null,e.address,0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffn,n.getHashForHtlc((0,c.randomBytes)(32)).toString("hex"),u.BigIntBufferUtils.fromBuffer((0,c.randomBytes)(8)),BigInt(Math.floor(Date.now()/1e3)),!0,!1,u.BigIntBufferUtils.fromBuffer((0,c.randomBytes)(2)),u.BigIntBufferUtils.fromBuffer((0,c.randomBytes)(2))),null==i?void 0:i.feeRate)]);(null==i?void 0:i.feeMultiplier)!=null&&(o=o*BigInt(Math.floor(1e6*i.feeMultiplier))/1000000n),r=(0,c.bigIntMax)(t-o,0n)}return(0,o.toTokenAmount)(r,e,this.root.prices)}getNativeToken(t){if(null==this.root.chains[t])throw Error("Invalid chain identifier! Unknown chain: "+t);return this.root.tokens[t][this.root.chains[t].chainInterface.getNativeCurrencyAddress()]}randomSigner(t){if(null==this.root.chains[t])throw Error("Invalid chain identifier! Unknown chain: "+t);return this.root.chains[t].chainInterface.randomSigner()}randomAddress(t){if(null==this.root.chains[t])throw Error("Invalid chain identifier! Unknown chain: "+t);return this.root.chains[t].chainInterface.randomAddress()}constructor(t){this.bitcoinNetwork=t.bitcoinNetwork,this.root=t}}},790036,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.Swapper=void 0;let r=t.r(991989),n=t.r(746894),a=t.r(985960),s=t.r(321182),o=t.r(764557),l=t.r(22436),u=t.r(20349),c=t.r(145617),h=t.r(865854),p=t.r(55532),d=t.r(737628),f=t.r(219298),g=t.r(54111),m=t.r(559766),w=t.r(686157),y=t.r(736684),T=t.r(768270),S=t.r(78950),E=t.r(446598),I=t.r(899600),v=t.r(951287),b=t.r(15567),B=t.r(75357),A=t.r(920002);class R extends f.EventEmitter{async init(){for(let t in this.chains){let{swapContract:e,unifiedChainEvents:i,unifiedSwapStorage:r,wrappers:n,reviver:a}=this.chains[t];if(await e.start(),this.logger.debug("init(): Intialized swap contract: "+t),await r.init(),r.storage instanceof I.IndexedDBUnifiedStorage){let e="SOLANA"===t?"SOLv4-"+this._bitcoinNetwork+"-Swaps-":"atomiqsdk-"+this._bitcoinNetwork+t+"-Swaps-";await r.storage.tryMigrate([[e+"FromBTC",h.SwapType.FROM_BTC],[e+"FromBTCLN",h.SwapType.FROM_BTCLN],[e+"ToBTC",h.SwapType.TO_BTC],[e+"ToBTCLN",h.SwapType.TO_BTCLN]],t=>{let e=a(t);if(null==e.randomNonce){let t=e.getId();e.randomNonce=(0,m.randomBytes)(16).toString("hex");let i=e.getId();this.logger.info("init(): Found older swap version without randomNonce, replacing, old hash: "+t+" new hash: "+i)}return e})}for(let e in this.options.noEvents||await i.start(),this.logger.debug("init(): Intialized events: "+t),n)await n[e].init(this.options.noTimers,this.options.dontCheckPastSwaps)}this.logger.debug("init(): Initializing intermediary discovery"),this.options.dontFetchLPs||await this.intermediaryDiscovery.init(),null!=this.options.defaultTrustedIntermediaryUrl&&(this.defaultTrustedIntermediary=await this.intermediaryDiscovery.getIntermediary(this.options.defaultTrustedIntermediaryUrl))}async stop(){for(let t in this.chains){let{wrappers:e,unifiedChainEvents:i}=this.chains[t];for(let t in e)e[t].events.removeListener("swapState",this.swapStateListener),await e[t].stop();await i.stop()}}async createSwap(t,e,i,r){let n,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:2e3;if(null==this.chains[t])throw Error("Invalid chain identifier! Unknown chain: "+t);let s=r===h.SwapType.TO_BTCLN||r===h.SwapType.TO_BTC?!i.exactIn:i.exactIn;n=s?this.intermediaryDiscovery.getSwapCandidates(t,r,i.token,i.amount):this.intermediaryDiscovery.getSwapCandidates(t,r,i.token);let o=!1;if(0===n.length){if(this.logger.warn("createSwap(): No valid intermediary found, reloading intermediary database..."),await this.intermediaryDiscovery.reloadIntermediaries(),o=!0,s){if(0===(n=this.intermediaryDiscovery.getSwapCandidates(t,r,i.token,i.amount)).length){let e=this.intermediaryDiscovery.getSwapMinimum(t,r,i.token),n=this.intermediaryDiscovery.getSwapMaximum(t,r,i.token);if(null!=e&&null!=n){if(i.amount<BigInt(e))throw new w.OutOfBoundsError("Amount too low!",200,BigInt(e),BigInt(n));if(i.amount>BigInt(n))throw new w.OutOfBoundsError("Amount too high!",200,BigInt(e),BigInt(n))}}}else n=this.intermediaryDiscovery.getSwapCandidates(t,r,i.token);if(0===n.length)throw Error("No intermediary found!")}let l=new AbortController;this.logger.debug("createSwap() Swap candidates: ",n.map(t=>t.url).join());let u=await e(n,l.signal,this.chains[t]),p=new Promise((e,n)=>{let s,h,p,d,f=0,g=[];u.forEach(y=>{y.quote.then(t=>{if(0===f&&(d=setTimeout(()=>{l.abort(Error("Timed out waiting for quote!")),e(g)},a)),f++,g.push({quote:t,intermediary:y.intermediary}),f===u.length){clearTimeout(d),e(g);return}}).catch(a=>{if(f++,a instanceof c.IntermediaryError)this.intermediaryDiscovery.removeIntermediary(y.intermediary),o=!0;else if(a instanceof w.OutOfBoundsError){var l,T,S,E,I;null==s||null==h?(s=a.min,h=a.max):(s=(0,m.bigIntMin)(s,a.min),h=(0,m.bigIntMax)(h,a.max)),null!=(l=y.intermediary.swapBounds)[r]||(l[r]={}),null!=(T=y.intermediary.swapBounds[r])[t]||(T[t]={});let e=null!=(I=(S=y.intermediary.swapBounds[r][t])[E=i.token])?I:S[E]={input:null,output:null};i.exactIn?e.input={min:a.min,max:a.max}:e.output={min:a.min,max:a.max},o=!0}if(this.logger.warn("createSwap(): Intermediary "+y.intermediary.url+" error: ",a),p=a,f===u.length){if(null!=d&&clearTimeout(d),g.length>0)return void e(g);if(null!=s&&null!=h)return void n(new w.OutOfBoundsError("Out of bounds",400,s,h));n(p)}})})});try{let t=await p;t.sort((t,e)=>i.exactIn?(0,m.bigIntCompare)(e.quote.getOutput().rawAmount,t.quote.getOutput().rawAmount):(0,m.bigIntCompare)(t.quote.getInput().rawAmount,e.quote.getInput().rawAmount)),this.logger.debug("createSwap(): Sorted quotes, best price to worst: ",t),o&&this.emit("swapLimitsChanged");let e=t[0].quote;return this.options.saveUninitializedSwaps&&(e._setInitiated(),await e._save()),e}catch(t){throw o&&this.emit("swapLimitsChanged"),t}}createToBTCSwap(t,e,i,r,n,a){var s,o;let l=arguments.length>6&&void 0!==arguments[6]?arguments[6]:this.options.defaultAdditionalParameters,u=arguments.length>7?arguments[7]:void 0;if(null==this.chains[t])throw Error("Invalid chain identifier! Unknown chain: "+t);if(r.startsWith("bitcoin:")&&(r=r.substring(8).split("?")[0]),!this.Utils.isValidBitcoinAddress(r))throw Error("Invalid bitcoin address");if(!this.chains[t].chainInterface.isValidAddress(e))throw Error("Invalid "+t+" address");null!=u||(u={}),null!=(s=u).confirmationTarget||(s.confirmationTarget=3),null!=(o=u).confirmations||(o.confirmations=2);let c={amount:n,token:i,exactIn:a};return this.createSwap(t,(t,i,n)=>Promise.resolve(n.wrappers[h.SwapType.TO_BTC].create(e,r,c,t,u,l,i)),c,h.SwapType.TO_BTC)}async createToBTCLNSwap(t,e,i,r){var n;let a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:this.options.defaultAdditionalParameters,s=arguments.length>5?arguments[5]:void 0;if(null==this.chains[t])throw Error("Invalid chain identifier! Unknown chain: "+t);if(null!=s||(s={}),r.startsWith("lightning:")&&(r=r.substring(10)),!this.Utils.isValidLightningInvoice(r))throw Error("Invalid lightning network invoice");if(!this.chains[t].chainInterface.isValidAddress(e))throw Error("Invalid "+t+" address");let o={amount:(BigInt((0,u.decode)(r).millisatoshis)+999n)/1000n,token:i,exactIn:!1};return null!=(n=s).expirySeconds||(n.expirySeconds=432e3),this.createSwap(t,(t,i,n)=>n.wrappers[h.SwapType.TO_BTCLN].create(e,r,o,t,s,a,i),o,h.SwapType.TO_BTCLN)}async createToBTCLNSwapViaLNURL(t,e,i,r,n,a){var s;let o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:this.options.defaultAdditionalParameters,l=arguments.length>7?arguments[7]:void 0;if(null==this.chains[t])throw Error("Invalid chain identifier! Unknown chain: "+t);if("string"==typeof r&&!this.Utils.isValidLNURL(r))throw Error("Invalid LNURL-pay link");if(!this.chains[t].chainInterface.isValidAddress(e))throw Error("Invalid "+t+" address");null!=l||(l={});let u={amount:n,token:i,exactIn:a};return null!=(s=l).expirySeconds||(s.expirySeconds=432e3),this.createSwap(t,(t,i,n)=>n.wrappers[h.SwapType.TO_BTCLN].createViaLNURL(e,"string"==typeof r?r.startsWith("lightning:")?r.substring(10):r:r.params,u,t,l,o,i),u,h.SwapType.TO_BTCLN)}async createFromBTCSwapNew(t,e,i,r,n){let a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:this.options.defaultAdditionalParameters,s=arguments.length>6?arguments[6]:void 0;if(null==this.chains[t])throw Error("Invalid chain identifier! Unknown chain: "+t);if(!this.chains[t].chainInterface.isValidAddress(e))throw Error("Invalid "+t+" address");let o={amount:r,token:i,exactIn:!n};return this.createSwap(t,(t,i,r)=>Promise.resolve(r.wrappers[h.SwapType.SPV_VAULT_FROM_BTC].create(e,o,t,s,a,i)),o,h.SwapType.SPV_VAULT_FROM_BTC)}async createFromBTCSwap(t,e,i,r,n){let a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:this.options.defaultAdditionalParameters,s=arguments.length>6?arguments[6]:void 0;if(null==this.chains[t])throw Error("Invalid chain identifier! Unknown chain: "+t);if(!this.chains[t].chainInterface.isValidAddress(e))throw Error("Invalid "+t+" address");let o={amount:r,token:i,exactIn:!n};return this.createSwap(t,(t,i,r)=>Promise.resolve(r.wrappers[h.SwapType.FROM_BTC].create(e,o,t,s,a,i)),o,h.SwapType.FROM_BTC)}async createFromBTCLNSwap(t,e,i,r,n){let a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:this.options.defaultAdditionalParameters,s=arguments.length>6?arguments[6]:void 0;if(null==this.chains[t])throw Error("Invalid chain identifier! Unknown chain: "+t);if(!this.chains[t].chainInterface.isValidAddress(e))throw Error("Invalid "+t+" address");let o={amount:r,token:i,exactIn:!n};return this.createSwap(t,(t,i,r)=>Promise.resolve(r.wrappers[h.SwapType.FROM_BTCLN].create(e,o,t,s,a,i)),o,h.SwapType.FROM_BTCLN)}async createFromBTCLNSwapViaLNURL(t,e,i,r,n,a){let s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:this.options.defaultAdditionalParameters;if(null==this.chains[t])throw Error("Invalid chain identifier! Unknown chain: "+t);if("string"==typeof r&&!this.Utils.isValidLNURL(r))throw Error("Invalid LNURL-withdraw link");if(!this.chains[t].chainInterface.isValidAddress(e))throw Error("Invalid "+t+" address");let o={amount:n,token:i,exactIn:!a};return this.createSwap(t,(t,i,n)=>n.wrappers[h.SwapType.FROM_BTCLN].createViaLNURL(e,"string"==typeof r?r.startsWith("lightning:")?r.substring(10):r:r.params,o,t,s,i),o,h.SwapType.FROM_BTCLN)}createTrustedLNForGasSwap(t,e,i,r){var n;if(null==this.chains[t])throw Error("Invalid chain identifier! Unknown chain: "+t);if(!this.chains[t].chainInterface.isValidAddress(e))throw Error("Invalid "+t+" address");let a=null!=(n=null!=r?r:this.defaultTrustedIntermediary)?n:this.options.defaultTrustedIntermediaryUrl;if(null==a)throw Error("No trusted intermediary specified!");return this.chains[t].wrappers[h.SwapType.TRUSTED_FROM_BTCLN].create(e,i,a)}createTrustedOnchainForGasSwap(t,e,i,r,n){var a;if(null==this.chains[t])throw Error("Invalid chain identifier! Unknown chain: "+t);if(!this.chains[t].chainInterface.isValidAddress(e))throw Error("Invalid "+t+" address");let s=null!=(a=null!=n?n:this.defaultTrustedIntermediary)?a:this.options.defaultTrustedIntermediaryUrl;if(null==s)throw Error("No trusted intermediary specified!");return this.chains[t].wrappers[h.SwapType.TRUSTED_FROM_BTC].create(e,i,s,r)}create(t,e,i,r,n,a){return"BTC"===e.chain?this.swap(e,i,r,n,a,t):this.swap(e,i,r,n,t,a)}swap(t,e,i,r,n,a,s){if("BTC"===t.chain){if("SC"===e.chain){if("string"!=typeof a)throw Error("Destination for BTC/BTC-LN -> smart chain swaps must be a smart chain address!");if(t.lightning)if(null==n)return this.createFromBTCLNSwap(e.chainId,a,e.address,i,!r,void 0,s);else{if("string"!=typeof n&&!(0,g.isLNURLWithdraw)(n))throw Error("LNURL must be a string or LNURLWithdraw object!");return this.createFromBTCLNSwapViaLNURL(e.chainId,a,e.address,n,i,!r)}return this.supportsSwapType(e.chainId,h.SwapType.SPV_VAULT_FROM_BTC)?this.createFromBTCSwapNew(e.chainId,a,e.address,i,!r,void 0,s):this.createFromBTCSwap(e.chainId,a,e.address,i,!r,void 0,s)}}else if("BTC"===e.chain){if("string"!=typeof n)throw Error("Source address for BTC/BTC-LN -> smart chain swaps must be a smart chain address!");if(e.lightning){if("string"!=typeof a&&!(0,g.isLNURLPay)(a))throw Error("Destination LNURL link/lightning invoice must be a string or LNURLPay object!");if((0,g.isLNURLPay)(a)||this.Utils.isValidLNURL(a))return this.createToBTCLNSwapViaLNURL(t.chainId,n,t.address,a,i,r,void 0,s);if(this.Utils.isLightningInvoice(a)){if(!this.Utils.isValidLightningInvoice(a))throw Error("Invalid lightning invoice specified, lightning invoice MUST contain pre-set amount!");if(r)throw Error("Only exact out swaps are possible with lightning invoices, use LNURL links for exact in lightning swaps!");return this.createToBTCLNSwap(t.chainId,n,t.address,a,void 0,s)}throw Error("Supplied parameter is not LNURL link nor lightning invoice (bolt11)!")}if("string"!=typeof a)throw Error("Destination bitcoin address must be a string!");return this.createToBTCSwap(t.chainId,n,t.address,a,i,r,void 0,s)}throw Error("Unsupported swap type")}async getAllSwaps(t,e){let i=[];if(null!=e&&i.push({key:"intiator",value:e}),null==t)return(await Promise.all(Object.keys(this.chains).map(t=>{let{unifiedSwapStorage:e,reviver:r}=this.chains[t];return e.query([i],r)}))).flat();{let{unifiedSwapStorage:e,reviver:r}=this.chains[t];return await e.query([i],r)}}async getActionableSwaps(t,e){if(null==t)return(await Promise.all(Object.keys(this.chains).map(t=>{let{unifiedSwapStorage:i,reviver:r,wrappers:n}=this.chains[t],a=[];for(let t in n){let i=n[t],r=[{key:"type",value:i.TYPE}];null!=e&&r.push({key:"intiator",value:e}),r.push({key:"state",value:i.pendingSwapStates}),a.push(r)}return i.query(a,r)}))).flat().filter(t=>t.requiresAction());{let{unifiedSwapStorage:i,reviver:r,wrappers:n}=this.chains[t],a=[];for(let t in n){let i=n[t],r=[{key:"type",value:i.TYPE}];null!=e&&r.push({key:"intiator",value:e}),r.push({key:"state",value:i.pendingSwapStates}),a.push(r)}return(await i.query(a,r)).filter(t=>t.requiresAction())}}async getRefundableSwaps(t,e){if(null==t)return(await Promise.all(Object.keys(this.chains).map(t=>{let{unifiedSwapStorage:i,reviver:r,wrappers:n}=this.chains[t],a=[];for(let t of[n[h.SwapType.TO_BTCLN],n[h.SwapType.TO_BTC]]){let i=[{key:"type",value:t.TYPE}];null!=e&&i.push({key:"initiator",value:e}),i.push({key:"state",value:t.refundableSwapStates}),a.push(i)}return i.query(a,r)}))).flat().filter(t=>t.isRefundable());{let{unifiedSwapStorage:i,reviver:r,wrappers:n}=this.chains[t],a=[];for(let t of[n[h.SwapType.TO_BTCLN],n[h.SwapType.TO_BTC]]){let i=[{key:"type",value:t.TYPE}];null!=e&&i.push({key:"initiator",value:e}),i.push({key:"state",value:t.refundableSwapStates}),a.push(i)}return(await i.query(a,r)).filter(t=>t.isRefundable())}}async getSwapById(t,e,i){var r,n;if(null!=e)for(let n in this.chains[e].wrappers){let a=null==(r=this.chains[e].wrappers[n].pendingSwaps.get(t))?void 0:r.deref();if(null!=a){if(null==i)return a;else if(a._getInitiator()===i)return a}}else for(let e in this.chains)for(let r in this.chains[e].wrappers){let a=null==(n=this.chains[e].wrappers[r].pendingSwaps.get(t))?void 0:n.deref();if(null!=a){if(null==i)return a;else if(a._getInitiator()===i)return a}}let a=[];if(null!=i&&a.push({key:"intiator",value:i}),a.push({key:"id",value:t}),null==e)return(await Promise.all(Object.keys(this.chains).map(t=>{let{unifiedSwapStorage:e,reviver:i}=this.chains[t];return e.query([a],i)}))).flat()[0];{let{unifiedSwapStorage:t,reviver:i}=this.chains[e];return(await t.query([a],i))[0]}}async _syncSwaps(t,e){if(null==t)await Promise.all(Object.keys(this.chains).map(async t=>{let{unifiedSwapStorage:i,reviver:r,wrappers:n}=this.chains[t],a=[];for(let t in n){let i=n[t],r=[{key:"type",value:i.TYPE}];null!=e&&r.push({key:"intiator",value:e}),r.push({key:"state",value:i.pendingSwapStates}),a.push(r)}this.logger.debug("_syncSwaps(): Querying swaps swaps for chain "+t+"!");let s=await i.query(a,r);this.logger.debug("_syncSwaps(): Syncing "+s.length+" swaps!");let o=[],l=[];for(let t of s){this.logger.debug("_syncSwaps(): Syncing swap: "+t.getId());let e=await t._sync(!1).catch(e=>this.logger.warn("_syncSwaps(): Error in swap: "+t.getId(),e));this.logger.debug("_syncSwaps(): Synced swap: "+t.getId()),t.isQuoteExpired()?l.push(t):e&&o.push(t)}this.logger.debug("_syncSwaps(): Done syncing "+s.length+" swaps, saving "+o.length+" changed swaps, removing "+l.length+" swaps!"),await i.saveAll(o),await i.removeAll(l)}));else{let{unifiedSwapStorage:i,reviver:r,wrappers:n}=this.chains[t],a=[];for(let t in n){let i=n[t],r=[{key:"type",value:i.TYPE}];null!=e&&r.push({key:"intiator",value:e}),r.push({key:"state",value:i.pendingSwapStates}),a.push(r)}this.logger.debug("_syncSwaps(): Querying swaps swaps for chain "+t+"!");let s=await i.query(a,r);this.logger.debug("_syncSwaps(): Syncing "+s.length+" swaps!");let o=[],l=[];for(let t of s){this.logger.debug("_syncSwaps(): Syncing swap: "+t.getId());let e=await t._sync(!1).catch(e=>this.logger.warn("_syncSwaps(): Error in swap: "+t.getId(),e));this.logger.debug("_syncSwaps(): Synced swap: "+t.getId()),t.isQuoteExpired()?l.push(t):e&&o.push(t)}this.logger.debug("_syncSwaps(): Done syncing "+s.length+" swaps, saving "+o.length+" changed swaps, removing "+l.length+" swaps!"),await i.saveAll(o),await i.removeAll(l)}}withChain(t){if(null==this.chains[t])throw Error("Invalid chain identifier! Unknown chain: "+t);return new y.SwapperWithChain(this,t)}getSmartChains(){return Object.keys(this.chains)}supportsSwapType(t,e){var i;return(null==(i=this.chains[t])?void 0:i.wrappers[e])!=null}getSwapType(t,e){if((0,T.isSCToken)(t)){if(!(0,T.isBtcToken)(e))throw Error("Swap not supported");return e.lightning?h.SwapType.TO_BTCLN:h.SwapType.TO_BTC}if((0,T.isBtcToken)(t)){if(!(0,T.isSCToken)(e))throw Error("Swap not supported");return t.lightning?h.SwapType.FROM_BTCLN:this.supportsSwapType(e.chainId,h.SwapType.SPV_VAULT_FROM_BTC)?h.SwapType.SPV_VAULT_FROM_BTC:h.SwapType.FROM_BTC}return null}getSwapLimits(t,e){var i,r;let n=this.getSwapType(t,e),a=(0,T.isSCToken)(t)?t:(0,T.isSCToken)(e)?e:null,s={min:null,max:null},o={min:null,max:null};for(let t of this.intermediaryDiscovery.intermediaries){let e=t.getSwapLimits(n,a.chainId,a.address);null!=e&&(s.min=null==s.min?e.input.min:(0,m.bigIntMin)(s.min,e.input.min),s.max=null==s.max?e.input.max:(0,m.bigIntMax)(s.max,e.input.max),o.min=null==o.min?e.output.min:(0,m.bigIntMin)(o.min,e.output.min),o.max=null==o.max?e.output.max:(0,m.bigIntMax)(o.max,e.output.max))}return{input:{min:(0,T.toTokenAmount)(null!=(i=s.min)?i:1n,t,this.prices),max:(0,T.toTokenAmount)(s.max,t,this.prices)},output:{min:(0,T.toTokenAmount)(null!=(r=o.min)?r:1n,e,this.prices),max:(0,T.toTokenAmount)(o.max,e,this.prices)}}}getSupportedTokens(t){let e={},i=!1,r=!1;this.intermediaryDiscovery.intermediaries.forEach(n=>{for(let a of[h.SwapType.TO_BTC,h.SwapType.TO_BTCLN,h.SwapType.FROM_BTC,h.SwapType.FROM_BTCLN,h.SwapType.SPV_VAULT_FROM_BTC])if(null!=n.services[a]&&null!=n.services[a].chainTokens){for(let s of this.getSmartChains())if((this.supportsSwapType(s,h.SwapType.SPV_VAULT_FROM_BTC)?a!==h.SwapType.FROM_BTC:a!==h.SwapType.SPV_VAULT_FROM_BTC)&&null!=n.services[a].chainTokens[s])for(let o of n.services[a].chainTokens[s])t?((a===h.SwapType.TO_BTC||a===h.SwapType.TO_BTCLN)&&(null!=e[s]||(e[s]=new Set),e[s].add(o)),a===h.SwapType.FROM_BTCLN&&(i=!0),(a===h.SwapType.FROM_BTC||a===h.SwapType.SPV_VAULT_FROM_BTC)&&(r=!0)):((a===h.SwapType.FROM_BTCLN||a===h.SwapType.FROM_BTC||a===h.SwapType.SPV_VAULT_FROM_BTC)&&(null!=e[s]||(e[s]=new Set),e[s].add(o)),a===h.SwapType.TO_BTCLN&&(i=!0),a===h.SwapType.TO_BTC&&(r=!0))}});let n=[];for(let t in i&&n.push(T.BitcoinTokens.BTCLN),r&&n.push(T.BitcoinTokens.BTC),e)e[t].forEach(e=>{var i,r;let a=null==(r=this.tokens)||null==(i=r[t])?void 0:i[e];null!=a&&n.push(a)});return n}getSupportedTokensForSwapType(t){let e={};this.intermediaryDiscovery.intermediaries.forEach(i=>{for(let r of this.getSmartChains()){let n=t;if(n===h.SwapType.FROM_BTC&&this.supportsSwapType(r,h.SwapType.SPV_VAULT_FROM_BTC)&&(n=h.SwapType.SPV_VAULT_FROM_BTC),null==i.services[n]||null==i.services[n].chainTokens)break;if(null!=i.services[n].chainTokens[r])for(let t of i.services[n].chainTokens[r])null!=e[r]||(e[r]=new Set),e[r].add(t)}});let i=[];for(let t in e)e[t].forEach(e=>{var r,n;let a=null==(n=this.tokens)||null==(r=n[t])?void 0:r[e];null!=a&&i.push(a)});return i}getSupportedTokenAddresses(t,e){let i=new Set;return this.intermediaryDiscovery.intermediaries.forEach(r=>{null!=r.services[e]&&null!=r.services[e].chainTokens&&null!=r.services[e].chainTokens[t]&&r.services[e].chainTokens[t].forEach(t=>i.add(t))}),i}getSwapCounterTokens(t,e){if((0,T.isSCToken)(t)){let i=[];if(e)this.getSupportedTokenAddresses(t.chainId,h.SwapType.TO_BTCLN).has(t.address)&&i.push(T.BitcoinTokens.BTCLN),this.getSupportedTokenAddresses(t.chainId,h.SwapType.TO_BTC).has(t.address)&&i.push(T.BitcoinTokens.BTC);else{this.getSupportedTokenAddresses(t.chainId,h.SwapType.FROM_BTCLN).has(t.address)&&i.push(T.BitcoinTokens.BTCLN);let e=this.supportsSwapType(t.chainId,h.SwapType.SPV_VAULT_FROM_BTC)?h.SwapType.SPV_VAULT_FROM_BTC:h.SwapType.FROM_BTC;this.getSupportedTokenAddresses(t.chainId,e).has(t.address)&&i.push(T.BitcoinTokens.BTC)}return i}if(e)if(t.lightning)return this.getSupportedTokensForSwapType(h.SwapType.FROM_BTCLN);else return this.getSupportedTokensForSwapType(h.SwapType.FROM_BTC);return t.lightning?this.getSupportedTokensForSwapType(h.SwapType.TO_BTCLN):this.getSupportedTokensForSwapType(h.SwapType.TO_BTC)}getSwapBounds(t){if(null!=this.intermediaryDiscovery)if(null==t)return this.intermediaryDiscovery.getMultichainSwapBounds();else return this.intermediaryDiscovery.getSwapBounds(t);return null}getMaximum(t,e,i){if(null!=this.intermediaryDiscovery){let r=this.intermediaryDiscovery.getSwapMaximum(t,e,i);if(null!=r)return BigInt(r)}return 0n}getMinimum(t,e,i){if(null!=this.intermediaryDiscovery){let r=this.intermediaryDiscovery.getSwapMinimum(t,e,i);if(null!=r)return BigInt(r)}return 0n}constructor(t,e,i,u,c){var f,g;super(),this.logger=(0,m.getLogger)(this.constructor.name+": "),this.SwapTypeInfo={[h.SwapType.TO_BTC]:{requiresInputWallet:!0,requiresOutputWallet:!1,supportsGasDrop:!1},[h.SwapType.TO_BTCLN]:{requiresInputWallet:!0,requiresOutputWallet:!1,supportsGasDrop:!1},[h.SwapType.FROM_BTC]:{requiresInputWallet:!1,requiresOutputWallet:!0,supportsGasDrop:!1},[h.SwapType.FROM_BTCLN]:{requiresInputWallet:!1,requiresOutputWallet:!0,supportsGasDrop:!1},[h.SwapType.SPV_VAULT_FROM_BTC]:{requiresInputWallet:!0,requiresOutputWallet:!1,supportsGasDrop:!0},[h.SwapType.TRUSTED_FROM_BTC]:{requiresInputWallet:!1,requiresOutputWallet:!1,supportsGasDrop:!1},[h.SwapType.TRUSTED_FROM_BTCLN]:{requiresInputWallet:!1,requiresOutputWallet:!1,supportsGasDrop:!1}};let w=null!=(f=null==c?void 0:c.storagePrefix)?f:"atomiq-";for(let e of(c.bitcoinNetwork=null==c.bitcoinNetwork?r.BitcoinNetwork.TESTNET:c.bitcoinNetwork,null!=c.swapStorage||(c.swapStorage=t=>new I.IndexedDBUnifiedStorage(t)),this._bitcoinNetwork=c.bitcoinNetwork,this.bitcoinNetwork=c.bitcoinNetwork===r.BitcoinNetwork.MAINNET?E.NETWORK:c.bitcoinNetwork===r.BitcoinNetwork.TESTNET||c.bitcoinNetwork===r.BitcoinNetwork.TESTNET4?E.TEST_NETWORK:{bech32:"bcrt",pubKeyHash:111,scriptHash:196,wif:239},this.Utils=new A.SwapperUtils(this),this.prices=i,this.bitcoinRpc=t,this.mempoolApi=t.api,this.options=c,this.tokens={},u))for(let t in e.chains){let i=e.chains[t];null!=(g=this.tokens)[t]||(g[t]={}),this.tokens[t][i.address]={chain:"SC",chainId:t,ticker:e.ticker,name:e.name,decimals:i.decimals,displayDecimals:i.displayDecimals,address:i.address}}this.swapStateListener=t=>{this.emit("swapState",t)},this.chains=(0,m.objectMap)(e,(e,l)=>{let{swapContract:f,chainEvents:g,btcRelay:m,chainInterface:y,spvVaultContract:T,spvVaultWithdrawalDataConstructor:E}=e,I=new p.MempoolBtcRelaySynchronizer(m,t),A=c.swapStorage(w+e.chainId),R=new v.UnifiedSwapStorage(A,this.options.noSwapCache),C=new b.UnifiedSwapEventListener(R,g),_={};return _[h.SwapType.TO_BTCLN]=new n.ToBTCLNWrapper(l,R,C,y,f,i,u,e.swapDataConstructor,{getRequestTimeout:c.getRequestTimeout,postRequestTimeout:c.postRequestTimeout}),_[h.SwapType.TO_BTC]=new a.ToBTCWrapper(l,R,C,y,f,i,u,e.swapDataConstructor,this.bitcoinRpc,{getRequestTimeout:c.getRequestTimeout,postRequestTimeout:c.postRequestTimeout,bitcoinNetwork:this.bitcoinNetwork}),_[h.SwapType.FROM_BTCLN]=new s.FromBTCLNWrapper(l,R,C,y,f,i,u,e.swapDataConstructor,t,{getRequestTimeout:c.getRequestTimeout,postRequestTimeout:c.postRequestTimeout,unsafeSkipLnNodeCheck:this._bitcoinNetwork===r.BitcoinNetwork.TESTNET4||this._bitcoinNetwork===r.BitcoinNetwork.REGTEST}),_[h.SwapType.FROM_BTC]=new o.FromBTCWrapper(l,R,C,y,f,i,u,e.swapDataConstructor,m,I,this.bitcoinRpc,{getRequestTimeout:c.getRequestTimeout,postRequestTimeout:c.postRequestTimeout,bitcoinNetwork:this.bitcoinNetwork}),_[h.SwapType.TRUSTED_FROM_BTCLN]=new d.LnForGasWrapper(l,R,C,y,i,u,{getRequestTimeout:c.getRequestTimeout,postRequestTimeout:c.postRequestTimeout}),_[h.SwapType.TRUSTED_FROM_BTC]=new S.OnchainForGasWrapper(l,R,C,y,i,u,t,{getRequestTimeout:c.getRequestTimeout,postRequestTimeout:c.postRequestTimeout,bitcoinNetwork:this.bitcoinNetwork}),null!=T&&(_[h.SwapType.SPV_VAULT_FROM_BTC]=new B.SpvFromBTCWrapper(l,R,C,y,T,i,u,E,m,I,t,{getRequestTimeout:c.getRequestTimeout,postRequestTimeout:c.postRequestTimeout,bitcoinNetwork:this.bitcoinNetwork})),Object.keys(_).forEach(t=>_[t].events.on("swapState",this.swapStateListener)),{chainEvents:g,spvVaultContract:T,swapContract:f,chainInterface:y,btcRelay:m,synchronizer:I,wrappers:_,unifiedChainEvents:C,unifiedSwapStorage:R,reviver:t=>{let e=_[t.type];return null==e?null:new e.swapDeserializer(e,t)}}});let y=(0,m.objectMap)(e,t=>t.swapContract);null!=c.intermediaryUrl?this.intermediaryDiscovery=new l.IntermediaryDiscovery(y,c.registryUrl,Array.isArray(c.intermediaryUrl)?c.intermediaryUrl:[c.intermediaryUrl],c.getRequestTimeout):this.intermediaryDiscovery=new l.IntermediaryDiscovery(y,c.registryUrl,null,c.getRequestTimeout),this.intermediaryDiscovery.on("removed",t=>{this.emit("lpsRemoved",t)}),this.intermediaryDiscovery.on("added",t=>{this.emit("lpsAdded",t)})}}i.Swapper=R},54097,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0})},259933,(t,e,i)=>{"use strict";var r=t.e&&t.e.__createBinding||(Object.create?function(t,e,i,r){void 0===r&&(r=i);var n=Object.getOwnPropertyDescriptor(e,i);(!n||("get"in n?!e.__esModule:n.writable||n.configurable))&&(n={enumerable:!0,get:function(){return e[i]}}),Object.defineProperty(t,r,n)}:function(t,e,i,r){void 0===r&&(r=i),t[r]=e[i]}),n=t.e&&t.e.__exportStar||function(t,e){for(var i in t)"default"===i||Object.prototype.hasOwnProperty.call(e,i)||r(e,t,i)};Object.defineProperty(i,"__esModule",{value:!0}),n(t.r(55532),i),n(t.r(948839),i),n(t.r(806667),i),n(t.r(123304),i),n(t.r(705423),i),n(t.r(601612),i),n(t.r(548760),i),n(t.r(154732),i),n(t.r(902866),i),n(t.r(431626),i),n(t.r(145617),i),n(t.r(930550),i),n(t.r(686157),i),n(t.r(17061),i),n(t.r(506498),i),n(t.r(22436),i),n(t.r(966025),i),n(t.r(588164),i),n(t.r(375581),i),n(t.r(414539),i),n(t.r(434482),i),n(t.r(382469),i),n(t.r(388938),i),n(t.r(466577),i),n(t.r(963868),i),n(t.r(527556),i),n(t.r(719555),i),n(t.r(756491),i),n(t.r(424089),i),n(t.r(768270),i),n(t.r(958078),i),n(t.r(307440),i),n(t.r(462501),i),n(t.r(790036),i),n(t.r(736684),i),n(t.r(411456),i),n(t.r(920002),i),n(t.r(865854),i),n(t.r(127644),i),n(t.r(387951),i),n(t.r(309959),i),n(t.r(404023),i),n(t.r(512302),i),n(t.r(301822),i),n(t.r(746894),i),n(t.r(263330),i),n(t.r(985960),i),n(t.r(318749),i),n(t.r(305822),i),n(t.r(557456),i),n(t.r(321182),i),n(t.r(912126),i),n(t.r(764557),i),n(t.r(204708),i),n(t.r(737628),i),n(t.r(570664),i),n(t.r(78950),i),n(t.r(348652),i),n(t.r(75357),i),n(t.r(54111),i),n(t.r(54097),i),n(t.r(899600),i),n(t.r(44237),i)},659250,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.SmartChainAssets=void 0,i.SmartChainAssets={_TESTNET_WBTC_VESU:{pricing:{binancePair:"WBTCBTC",okxPair:"WBTC-BTC",coinGeckoCoinId:"wrapped-bitcoin",coinPaprikaCoinId:"wbtc-wrapped-bitcoin",krakenPair:"WBTCXBT"},name:"Wrapped BTC (WBTC)"},WBTC:{pricing:{binancePair:"WBTCBTC",okxPair:"WBTC-BTC",coinGeckoCoinId:"wrapped-bitcoin",coinPaprikaCoinId:"wbtc-wrapped-bitcoin",krakenPair:"WBTCXBT"},name:"Wrapped BTC (WBTC)"},TBTC:{pricing:{binancePair:null,okxPair:null,coinGeckoCoinId:"tbtc",coinPaprikaCoinId:"tbtc-tbtc",krakenPair:null},name:"Threshold BTC (tBTC)"},USDC:{pricing:{binancePair:"!BTCUSDC",okxPair:"!BTC-USDC",coinGeckoCoinId:"usd-coin",coinPaprikaCoinId:"usdc-usd-coin",krakenPair:"!XBTUSDC"},name:"USD Circle"},USDT:{pricing:{binancePair:"!BTCUSDT",okxPair:"!BTC-USDT",coinGeckoCoinId:"tether",coinPaprikaCoinId:"usdt-tether",krakenPair:"!XBTUSDT"},name:"Tether USD"},SOL:{pricing:{binancePair:"SOLBTC",okxPair:"SOL-BTC",coinGeckoCoinId:"solana",coinPaprikaCoinId:"sol-solana",krakenPair:"SOLXBT"},name:"Solana"},BONK:{pricing:{binancePair:"BONKUSDC;!BTCUSDC",okxPair:"BONK-USDT;!BTC-USDT",coinGeckoCoinId:"bonk",coinPaprikaCoinId:"bonk-bonk",krakenPair:"BONKUSD;!XXBTZUSD"},name:"Bonk"},ETH:{pricing:{binancePair:"ETHBTC",okxPair:"ETH-BTC",coinGeckoCoinId:"ethereum",coinPaprikaCoinId:"eth-ethereum",krakenPair:"XETHXXBT"},name:"Ether"},STRK:{pricing:{binancePair:"STRKUSDT;!BTCUSDT",okxPair:"STRK-USDT;!BTC-USDT",coinGeckoCoinId:"starknet",coinPaprikaCoinId:"strk-starknet",krakenPair:"STRKUSD;!XXBTZUSD"},name:"Starknet"}}},837748,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.LocalStorageManager=void 0,i.LocalStorageManager=class{init(){let t=window.localStorage.getItem(this.storageKey);return null!=t?(this.rawData=JSON.parse(t),null==this.rawData&&(this.rawData={})):this.rawData={},Promise.resolve()}saveData(t,e){return this.data[t]=e,this.rawData[t]=e.serialize(),this.save()}saveDataArr(t){return t.forEach(t=>{this.data[t.id]=t.object,this.rawData[t.id]=t.object.serialize()}),this.save()}removeData(t){return null!=this.rawData[t]?(null!=this.data[t]&&delete this.data[t],delete this.rawData[t],this.save()):Promise.resolve()}removeDataArr(t){return t.forEach(t=>{null!=this.rawData[t]&&(null!=this.data[t]&&delete this.data[t],delete this.rawData[t])}),this.save()}loadData(t){return Promise.resolve(Object.keys(this.rawData).map(e=>{let i=new t(this.rawData[e]);return this.data[e]=i,i}))}save(){return window.localStorage.setItem(this.storageKey,JSON.stringify(this.rawData)),Promise.resolve()}constructor(t){this.rawData=null,this.data={},this.storageKey=t}}},293442,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.SwapperFactory=void 0;let r=t.r(991989),n=t.r(259933),a=t.r(659250),s=t.r(837748),o={[r.BitcoinNetwork.MAINNET]:"https://api.github.com/repos/adambor/SolLightning-registry/contents/registry-mainnet.json?ref=main",[r.BitcoinNetwork.TESTNET]:"https://api.github.com/repos/adambor/SolLightning-registry/contents/registry.json?ref=main",[r.BitcoinNetwork.TESTNET4]:"https://api.github.com/repos/adambor/SolLightning-registry/contents/registry-testnet4.json?ref=main"},l={[r.BitcoinNetwork.MAINNET]:"https://node3.gethopa.com:34100",[r.BitcoinNetwork.TESTNET]:"https://node3.gethopa.com:24100"},u={[r.BitcoinNetwork.MAINNET]:["https://mempool.space/api/","https://mempool.holdings/api/","https://mempool.fra.mempool.space/api/","https://mempool.va1.mempool.space/api/","https://mempool.tk7.mempool.space/api/"],[r.BitcoinNetwork.TESTNET]:["https://mempool.space/testnet/api/","https://mempool.holdings/testnet/api/","https://mempool.fra.mempool.space/testnet/api/","https://mempool.va1.mempool.space/testnet/api/","https://mempool.tk7.mempool.space/testnet/api/"],[r.BitcoinNetwork.TESTNET4]:["https://mempool.space/testnet4/api/","https://mempool.holdings/testnet4/api/","https://mempool.fra.mempool.space/testnet4/api/","https://mempool.va1.mempool.space/testnet4/api/","https://mempool.tk7.mempool.space/testnet4/api/"]};i.SwapperFactory=class{newSwapper(t){var e,i,c;null!=t.bitcoinNetwork||(t.bitcoinNetwork=r.BitcoinNetwork.MAINNET),null!=t.storagePrefix||(t.storagePrefix="atomiqsdk-"+t.bitcoinNetwork+"-"),null!=t.defaultTrustedIntermediaryUrl||(t.defaultTrustedIntermediaryUrl=l[t.bitcoinNetwork]),null!=t.registryUrl||(t.registryUrl=o[t.bitcoinNetwork]);let h=null!=(e=t.mempoolApi)?e:new n.MempoolBitcoinRpc(u[t.bitcoinNetwork]),p=h instanceof n.MempoolBitcoinRpc?h:new n.MempoolBitcoinRpc(h),d=[];Object.keys(a.SmartChainAssets).forEach(t=>{let e={};for(let{tokens:i,chainId:r}of this.initializers)null!=i[t]&&(e[r]=i[t]);let i=a.SmartChainAssets[t];d.push({...i.pricing,chains:e,ticker:t,name:i.name})}),null!=t.chainStorageCtor||(t.chainStorageCtor=t=>new s.LocalStorageManager(t));let f={};for(let{initializer:e,chainId:i}of this.initializers)null!=t.chains[i]&&(f[i]=e(t.chains[i],p,t.bitcoinNetwork,t.chainStorageCtor));let g=null!=t.getPriceFn?new n.SingleSwapPrice(null!=(i=t.pricingFeeDifferencePPM)?i:10000n,new n.CustomPriceProvider(d.map(t=>({coinId:t.ticker,chains:t.chains})),t.getPriceFn)):n.RedundantSwapPrice.createFromTokenMap(null!=(c=t.pricingFeeDifferencePPM)?c:10000n,d);return new n.Swapper(p,f,g,d,t)}constructor(t){this.initializers=t,this.Tokens={BITCOIN:n.BitcoinTokens},this.TokenResolver={},this.initializers=t,t.forEach(t=>{let e={};for(let n in this.Tokens[t.chainId]={},t.tokens){var i,r;let s=t.tokens[n];this.Tokens[t.chainId][n]=e[s.address]={chain:"SC",chainId:t.chainId,address:s.address,name:null!=(r=null==(i=a.SmartChainAssets[n])?void 0:i.name)?r:n,decimals:s.decimals,displayDecimals:s.displayDecimals,ticker:n}}this.TokenResolver[t.chainId]={getToken:t=>e[t]}})}}},717268,(t,e,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.timeoutSignal=i.fromHumanReadableString=i.toHumanReadableString=void 0;let r=t.r(259933);i.toHumanReadableString=function(t,e){return null==t?null:(0,r.toDecimal)(t,e.decimals,void 0,e.displayDecimals)},i.fromHumanReadableString=function(t,e){return""===t||null==t?null:(0,r.fromDecimal)(t,e.decimals)},i.timeoutSignal=function(t,e,i){if(null==t)return i;let r=new AbortController,n=setTimeout(()=>r.abort(e||Error("Timed out")),t);return null!=i&&i.addEventListener("abort",()=>{clearTimeout(n),r.abort(i.reason)}),r.signal}},831313,(t,e,i)=>{"use strict";var r=t.e&&t.e.__createBinding||(Object.create?function(t,e,i,r){void 0===r&&(r=i);var n=Object.getOwnPropertyDescriptor(e,i);(!n||("get"in n?!e.__esModule:n.writable||n.configurable))&&(n={enumerable:!0,get:function(){return e[i]}}),Object.defineProperty(t,r,n)}:function(t,e,i,r){void 0===r&&(r=i),t[r]=e[i]}),n=t.e&&t.e.__exportStar||function(t,e){for(var i in t)"default"===i||Object.prototype.hasOwnProperty.call(e,i)||r(e,t,i)};Object.defineProperty(i,"__esModule",{value:!0}),n(t.r(991989),i),n(t.r(259933),i),n(t.r(293442),i),n(t.r(717268),i),n(t.r(837748),i)},516687,t=>{"use strict";t.s(["RealAtomiqSwapClient",()=>o]);var e=t.i(299749),i=t.i(831313),r=t.i(582399),n=t.i(518299),a=t.i(68043),s=t.i(615245);class o{async initializeForBrowser(){try{this.factory=new i.SwapperFactory([n.StarknetInitializer]),this.tokens=this.factory.Tokens,this.initializationPromise=this.initializeAtomiqFactory()}catch(t){console.error(" Failed to create Atomiq factory:",t)}}setupTestMode(){if(this.isNodeJs)return void console.log(" Test mode setup: Atomiq SDK requires browser environment");throw this.initialized=!1,console.error(" Atomiq SDK initialization failed and simulation mode is disabled"),Error("Atomiq SDK initialization failed - simulation mode disabled")}async initializeAtomiqFactory(){try{if(console.log(" Initializing Atomiq SDK with Starknet + Lightning support..."),!this.factory)throw Error("Factory not initialized - browser environment required");let t=new n.RpcProviderWithRetries({nodeUrl:this.starknetRpc}),e={chains:{STARKNET:{rpcUrl:t,fees:new n.StarknetFees(t)}},bitcoinNetwork:"MAINNET"===this.network?i.BitcoinNetwork.MAINNET:i.BitcoinNetwork.TESTNET};this.isNodeJs&&console.log(" Using memory storage for Node.js testing environment"),console.log(" Configured storage for privacy mixer environment"),this.swapper=this.factory.newSwapper(e),console.log(" Atomiq Swapper created for Starknet  Lightning"),await this.swapper.init(),console.log(" Atomiq SDK initialized - ready for STRK  Lightning swaps"),this.initialized=!0}catch(t){throw console.error(" Failed to initialize Atomiq SDK:",t instanceof Error?t.message:String(t)),console.error("Full error:",t),t}}async ensureInitialized(){if(this.isNodeJs)throw Error("Atomiq SDK requires browser environment - Node.js not supported");if(!this.initialized){if(this.initializationPromise)return void await this.initializationPromise;throw Error("Atomiq SDK not initialized and no initialization promise found")}}async swapStrkToLightning(t,e,i){try{var n;let a;await this.ensureInitialized();try{let t=await this.getSwapLimits("STRK","BTC_LN"),i=(()=>{try{return r.decode(e)}catch(t){return null}})(),n=(null==i?void 0:i.millisatoshis)?BigInt(i.millisatoshis):void 0,a=n?Number(n/1000n):void 0;console.log(" Preflight limits check (STRK input limits):",{invoiceSats:a,strkMaxLimit:t.max.toString(),strkMinLimit:t.min.toString(),note:"STRK input will be calculated by SDK based on invoice amount"})}catch(t){console.warn(" Preflight limits check failed, proceeding with swap:",t)}console.log(" Starting STRK  Lightning swap for amount: ".concat(t));let o=i.trim().toLowerCase();o.startsWith("0x")||(o="0x"+o);let l=o.slice(2);if(!/^[0-9a-f]+$/.test(l))return{success:!1,amount:t,fromCurrency:"STRK",toCurrency:"Lightning",route:"starknet-to-lightning",error:"Source Starknet address contains non-hex characters"};if(l.length<64)o="0x"+l.padStart(64,"0");else if(l.length>64)return{success:!1,amount:t,fromCurrency:"STRK",toCurrency:"Lightning",route:"starknet-to-lightning",error:"Source Starknet address length invalid (>64 hex chars)"};console.log(" Normalized Starknet source address:",o);let u=e.trim();if(!/^(lnbc|lntb|lnbcrt)[0-9a-z]+$/i.test(u))return{success:!1,amount:t,fromCurrency:"STRK",toCurrency:"Lightning",route:"starknet-to-lightning",error:"Provided value is not a valid BOLT11 invoice. Generate invoice from Cashu mint first."};try{let e=r.decode(u).millisatoshis;if(!e)return{success:!1,amount:t,fromCurrency:"STRK",toCurrency:"Lightning",route:"starknet-to-lightning",error:"Invoice missing fixed amount (amountless invoices not supported yet)"};if((a=BigInt(e)/BigInt(1e3))===BigInt(0))return{success:!1,amount:t,fromCurrency:"STRK",toCurrency:"Lightning",route:"starknet-to-lightning",error:"Invoice amount is zero"};console.log(" Invoice amount parsed: ".concat(a.toString()," sats"))}catch(i){let e=i instanceof Error?i.message:String(i);return{success:!1,amount:t,fromCurrency:"STRK",toCurrency:"Lightning",route:"starknet-to-lightning",error:"Failed to decode invoice: ".concat(e)}}console.log(" Creating STRK  Lightning swap (exactOut): ".concat(a.toString()," sats output"));let c=await this.swapper.swap(this.tokens.STARKNET.STRK,this.tokens.BITCOIN.BTCLN,void 0,!1,o,u);console.log(" STRK  Lightning swap created:",c.getId()),console.log(" Swap details:"),console.log("   Input: "+c.getInputWithoutFee()),console.log("   Fees: "+c.getFee().amountInSrcToken),console.log("   Total input: "+c.getInput()),console.log("   Output: "+c.getOutput()),console.log("   Quote expiry: "+c.getQuoteExpiry()+" (in "+(c.getQuoteExpiry()-Date.now())/1e3+" seconds)");let h=(0,s.getSharedSwapAccount)();if(h)console.log(" Committing swap with shared account:",h.getAddress().slice(0,10)+"..."),await c.commit(h);else throw Error("No shared swap account configured - cannot commit swap");if(console.log(" Waiting for Lightning payment..."),!await c.waitForPayment())return console.log(" Lightning payment failed, refunding..."),h&&(await c.refund(h),console.log(" Swap refunded successfully")),{success:!1,amount:t,fromCurrency:"STRK",toCurrency:"Lightning",route:"starknet-to-lightning",error:"Lightning payment failed and refunded"};return{success:!0,txId:(null==(n=c.getBitcoinTxId)?void 0:n.call(c))||c.getId(),amount:t,fromCurrency:"STRK",toCurrency:"Lightning",route:"starknet-to-lightning"}}catch(i){let e=i instanceof Error?i.message:String(i);if(/amount too high/i.test(e))try{let t=await this.getSwapLimits("STRK","BTC_LN");e="".concat(e," (max sats: ").concat(t.max.toString(),", consider reducing invoice amount)")}catch(t){}return console.error(" STRK  Lightning swap failed:",e),{success:!1,error:e,amount:t,fromCurrency:"STRK",toCurrency:"Lightning",route:"starknet-to-lightning"}}}async swapLightningToStrk(t,e){try{await this.ensureInitialized(),console.log(" Starting Lightning  STRK swap for amount: ".concat(t));let r=await this.swapper.swap(this.tokens.BITCOIN.BTCLN,this.tokens.STARKNET.STRK,BigInt(t),!0,void 0,e);console.log(" Lightning  STRK swap created:",r.getId());let n=r.getAddress();if(console.log(" Lightning invoice to pay:",n),await this.simulateLightningPayment(n),await r.waitForPayment()){var i;return{success:!0,txId:(null==(i=r.getBitcoinTxId)?void 0:i.call(r))||r.getId(),amount:t,fromCurrency:"Lightning",toCurrency:"STRK",route:"lightning-to-starknet"}}throw Error("Swap execution failed")}catch(i){let e=i instanceof Error?i.message:String(i);return console.error(" Lightning  STRK swap failed:",e),{success:!1,error:e,amount:t,fromCurrency:"Lightning",toCurrency:"STRK",route:"lightning-to-starknet"}}}async beginLightningToStrkSwap(t,e){await this.ensureInitialized(),console.log(" (begin) Lightning  STRK swap for amount: ".concat(t));let i=await this.swapper.swap(this.tokens.BITCOIN.BTCLN,this.tokens.STARKNET.STRK,BigInt(t),!0,void 0,e),r=i.getAddress(),n=i.getId();return console.log(" (begin) Lightning invoice created:",{id:n,invoice:"string"==typeof r?r.slice(0,50)+"":String(r)}),{id:n,invoice:r}}async waitLightningToStrkCompletion(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3e5;return this.waitForCompletion(t,e)}async claimLightningToStrkSwap(e){if(await this.ensureInitialized(),!this.swapper||!this.initialized)throw Error("Atomiq SDK not initialized - simulation mode disabled");let i=await this.swapper.getSwapById(e);if(!i)throw Error("Swap ".concat(e," not found"));let r=(0,s.getSharedSwapAccount)();if(!r)throw Error("No shared swap account configured - cannot claim swap");try{let{validateSharedSwapSigner:e}=await t.A(507770),i=await e();if(!i.ok)throw Error("Invalid signer provided: ".concat(i.reason||"unknown reason").concat(i.address?" (address: ".concat(i.address,")"):""))}catch(e){let t=e instanceof Error?e.message:String(e);throw Error(t.includes("Invalid signer provided")?t:"Invalid signer provided! ".concat(t))}try{var n,a;"function"==typeof i.canCommitAndClaimInOneShot&&i.canCommitAndClaimInOneShot()?await i.commitAndClaim(r):(await i.commit(r),await i.claim(r));let t=(null==(n=i.getBitcoinTxId)?void 0:n.call(i))||(null==(a=i.getOutputTxId)?void 0:a.call(i))||void 0;return console.log(" Claimed Lightning  STRK swap on Starknet",{id:e,txId:t}),{txId:t}}catch(i){let t=i instanceof Error?i.message:String(i);throw console.error(" Claim Lightning  STRK failed:",t),Error("Claim failed for swap ".concat(e,": ").concat(t))}}async getQuote(t,e,i){let r=!(arguments.length>3)||void 0===arguments[3]||arguments[3],n=arguments.length>4?arguments[4]:void 0;await this.ensureInitialized(),console.log(" Getting real-time quote for ".concat(t," -> ").concat(e,", amount: ").concat(i,", exactIn: ").concat(r));try{if(!this.swapper||!this.tokens)throw Error("Atomiq SDK not properly initialized");let a=this.mapToAtomiqToken(t),s=this.mapToAtomiqToken(e),o=await this.swapper.swap(a,s,i,r,n||void 0,void 0),l=o.getPriceInfo(),u=o.getInput(),c=o.getOutput(),h=o.getFee(),p=o.getQuoteExpiry();return console.log(" Real-time quote received:",{swapPrice:l.swapPrice,marketPrice:l.marketPrice,difference:l.difference,input:u.toString(),output:c.toString(),fee:h.amountInSrcToken.toString(),expiry:new Date(p).toISOString()}),{id:o.getId(),from:t,to:e,amountIn:BigInt(u.toString()),amountOut:BigInt(c.toString()),fee:BigInt(h.amountInSrcToken.toString()),swapPrice:l.swapPrice,marketPrice:l.marketPrice,difference:l.difference,expiry:p,createdAt:Date.now()}}catch(l){let n,s;console.warn(" Failed to get real-time quote, falling back to estimate:",l);let o=a.ENV.STRK_SATS_RATE||125;return r?(n=BigInt(Math.floor(Number(i)/1e18*o)),s=i):(s=BigInt(Math.floor(1e18*(Number(i)/o))),n=i),{id:"quote_fallback_".concat(Date.now()),from:t,to:e,amountIn:s,amountOut:n,fee:i/100n,swapPrice:r?.001:1e3,marketPrice:r?.001:1e3,difference:0,expiry:Date.now()+6e5,createdAt:Date.now()}}}async getStrkToLightningQuote(t){try{let e=BigInt(Math.floor(1e18*t)),i=(0,s.getSharedSwapAccount)(),r=(null==i?void 0:i.getAddress())||void 0,n=await this.getQuote("STRK","BTC_LN",e,!0,r),a=Number(n.amountOut);return console.log(" STRK  Lightning quote: ".concat(t," STRK  ").concat(a," sats")),{satsOut:a,quote:n}}catch(i){console.warn(" Failed to get STRK  Lightning quote, using fallback:",i);let e=Math.floor(t*(a.ENV.STRK_SATS_RATE||125));return{satsOut:e,quote:{id:"fallback_".concat(Date.now()),from:"STRK",to:"BTC_LN",amountIn:BigInt(Math.floor(1e18*t)),amountOut:BigInt(e),fee:BigInt(Math.floor(.01*e)),swapPrice:e/t,marketPrice:e/t,difference:0,expiry:Date.now()+6e5,createdAt:Date.now()}}}}async estimateLightningSatsFromStrk(t){try{let{satsOut:e,quote:i}=await this.getStrkToLightningQuote(t),r=e/Math.max(1e-9,t);return console.log(" Dynamic STRKsats estimate (realtime):",{strkAmount:t,satsOut:e,rate:r}),{satsOut:e,rate:r,source:"realtime",quote:i}}catch(r){let e=Math.floor(t*(a.ENV.STRK_SATS_RATE||125)),i=e/Math.max(1e-9,t);return console.warn(" Dynamic estimate fallback used:",{strkAmount:t,satsOut:e,rate:i}),{satsOut:e,rate:i,source:"fallback"}}}async execute(t,e,i){return await this.ensureInitialized(),console.log(" Executing simplified swap ".concat(t)),{id:t,txId:"tx_".concat(Date.now()),status:"CLAIMED",amountOut:BigInt(1e6)}}async createLightningInvoice(t,e){try{console.log(" Creating Lightning invoice for ".concat(t," sats to ").concat(e));let i=Math.floor(Date.now()/1e3),r="lntb".concat(t,"u1p").concat(i.toString(16),"h0s9ywmm8dfjk7unn2v4ehgcm00u93b2g3r");return console.log(" Lightning invoice created for privacy mixer"),r}catch(t){throw console.error(" Failed to create Lightning invoice:",t),Error("Lightning invoice creation failed: ".concat(t instanceof Error?t.message:String(t)))}}async simulateLightningPayment(t){console.log(" Simulating Lightning payment for invoice: ".concat(t.slice(0,20),"...")),await new Promise(t=>setTimeout(t,2e3)),console.log(" Lightning payment simulation completed")}async getStatus(t){if(await this.ensureInitialized(),!this.swapper||!this.initialized)throw Error("Atomiq SDK not initialized - simulation mode disabled");try{var e,i,r;let n,a=await this.swapper.getSwapById(t);if(!a)throw Error("Swap with ID ".concat(t," not found"));let s=a.getState(),o=this.mapSwapState(s);if("CLAIMED"===o)try{let t=null!=(r=null==(i=a.getOutput)?void 0:i.call(a))?r:void 0;n=this.parseStrkAmountToWei(t)}catch(t){console.warn(" Failed to parse STRK output amount to Wei:",t instanceof Error?t.message:String(t)),n=void 0}return{id:t,status:o,txId:(null==(e=a.getBitcoinTxId)?void 0:e.call(a))||void 0,amountOut:n,lightningPaymentHash:void 0}}catch(t){throw console.error(" Failed to get swap status:",t),Error("Failed to get swap status: ".concat(t instanceof Error?t.message:String(t)))}}parseStrkAmountToWei(t){var e;if("bigint"==typeof t)return t;if("number"==typeof t)return this.decimalStrToWei(String(t));let i=null==t||null==(e=t.toString)?void 0:e.call(t);if("string"!=typeof i||0===i.length)throw SyntaxError("Unknown STRK amount format");let r=i.replace(/STRK/gi,"").replace(/sats/gi,"").trim();return/^\d+$/.test(r)?BigInt(r):this.decimalStrToWei(r)}decimalStrToWei(t){if(!/^\d*(?:\.\d+)?$/.test(t)){let e=t.match(/\d+(?:\.\d+)?/);if(!e)throw SyntaxError("Cannot convert ".concat(t," to a BigInt"));t=e[0]}let[e,i=""]=t.split("."),r=(i+"0".repeat(18)).slice(0,18);return(e?0xde0b6b3a7640000n*BigInt(e):0n)+(r?BigInt(r):0n)}async refund(t,e){if(await this.ensureInitialized(),!this.swapper||!this.initialized)throw Error("Atomiq SDK not initialized - simulation mode disabled");try{var i;let r=await this.swapper.getSwapById(t);if(!r)throw Error("Swap with ID ".concat(t," not found"));console.log(" Refunding swap ".concat(t)),await r.refund(e);let n=(null==(i=r.getBitcoinTxId)?void 0:i.call(r))||"refund_".concat(t);return console.log(" Refund completed with txId: ".concat(n)),{txId:n}}catch(t){throw console.error(" Refund failed:",t),Error("Failed to refund swap: ".concat(t instanceof Error?t.message:String(t)))}}async waitForCompletion(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3e5;if(await this.ensureInitialized(),!this.swapper||!this.initialized)throw Error("Atomiq SDK not initialized - simulation mode disabled");try{let i=await this.swapper.getSwapById(t);if(!i)throw Error("Swap with ID ".concat(t," not found"));return console.log(" Waiting for swap ".concat(t," completion (timeout: ").concat(e,"ms)")),await i.waitForPayment()}catch(t){return console.error(" Wait for completion failed:",t),!1}}async getInvoice(t){if(await this.ensureInitialized(),!this.swapper||!this.initialized)throw Error("Atomiq SDK not initialized - simulation mode disabled");try{let e=await this.swapper.getSwapById(t);if(!e)throw Error("Swap with ID ".concat(t," not found"));let i=e.getAddress();return console.log(" Generated Lightning invoice: ".concat(i)),i}catch(t){throw console.error(" Failed to get invoice:",t),Error("Failed to get invoice: ".concat(t instanceof Error?t.message:String(t)))}}async payInvoice(t,e){if(await this.ensureInitialized(),!this.swapper||!this.initialized)throw Error("Atomiq SDK not initialized - simulation mode disabled");try{console.log(" Creating STRK -> Lightning swap for invoice payment");let r=await this.swapper.swap(this.tokens.STARKNET.STRK,this.tokens.BITCOIN.BTCLN,void 0,!1,void 0,t);if(await r.commit(e),await r.waitForPayment()){var i;let t=(null==(i=r.getSecret)?void 0:i.call(r))||"preimage_".concat(Date.now());return console.log(" Lightning payment completed with preimage: ".concat(t.slice(0,10),"...")),{preimage:t}}throw Error("Lightning payment failed")}catch(t){throw console.error(" Lightning payment failed:",t),Error("Failed to pay Lightning invoice: ".concat(t instanceof Error?t.message:String(t)))}}async getSwapLimits(t,e){if(await this.ensureInitialized(),!this.swapper||!this.initialized)throw Error("Atomiq SDK not initialized - simulation mode disabled");try{let i=this.mapToAtomiqToken(t),r=this.mapToAtomiqToken(e);console.log(" Getting swap limits for ".concat(t," -> ").concat(e));let n=this.swapper.getSwapLimits(i,r);console.log(" Raw limits from Atomiq:",{inputMin:n.input.min,inputMax:n.input.max,inputMinType:typeof n.input.min,inputMaxType:typeof n.input.max});let a=this.parseAtomiqAmount(n.input.min)||1000n,s=this.parseAtomiqAmount(n.input.max)||1000000n;return{min:a,max:s}}catch(t){throw console.error(" Failed to get swap limits:",t),Error("Failed to get swap limits: ".concat(t instanceof Error?t.message:String(t)))}}parseAtomiqAmount(t){try{if(null==t)return null;if("number"==typeof t)return BigInt(Math.floor(t));if("bigint"==typeof t)return t;if("string"==typeof t){let e=t.replace(/[A-Za-z\s]/g,"").trim();if(!e||"0"===e||0===parseFloat(e))return 0n;let i=parseFloat(e);if(isNaN(i))return null;return BigInt(Math.floor(i))}return null}catch(e){return console.warn(" Failed to parse Atomiq amount:",{value:t,error:e}),null}}mapToAtomiqToken(t){if(!this.tokens)throw Error("Atomiq SDK tokens not available - SDK not properly initialized");switch(t){case"STRK":return this.tokens.STARKNET.STRK;case"BTC":return this.tokens.BITCOIN.BTC;case"BTC_LN":return this.tokens.BITCOIN.BTCLN;default:throw Error("Unsupported token: ".concat(t))}}mapSwapState(t){if("number"==typeof t)switch(t){case 0:return"CREATED";case 1:return"COMMITED";case 2:return"SOFT_CLAIMED";case 3:return"CLAIMED";case 4:return"REFUNDABLE";case -1:case -2:return"EXPIRED";case -3:return"REFUNDED";default:return"FAILED"}if("string"==typeof t)switch(t.toUpperCase()){case"CREATED":break;case"COMMITED":return"COMMITED";case"SOFT_CLAIMED":return"SOFT_CLAIMED";case"CLAIMED":return"CLAIMED";case"REFUNDABLE":return"REFUNDABLE";case"REFUNDED":return"REFUNDED";case"EXPIRED":return"EXPIRED";default:return"FAILED"}return"CREATED"}constructor(t=a.ENV.NETWORK,i){(0,e._)(this,"swapper",null),(0,e._)(this,"factory",null),(0,e._)(this,"initialized",!1),(0,e._)(this,"network",void 0),(0,e._)(this,"starknetRpc",void 0),(0,e._)(this,"isNodeJs",void 0),(0,e._)(this,"tokens",null),(0,e._)(this,"initializationPromise",null),this.network=t,this.starknetRpc=i||(0,a.getStarknetRpc)(),this.isNodeJs=!1,console.log(" Initializing Atomiq client for ".concat(t," using RPC: ").concat(this.starknetRpc)),this.isNodeJs?console.log(" Node.js environment detected - Atomiq SDK will initialize when needed"):this.initializeForBrowser()}}new o("MAINNET"===a.ENV.NETWORK?"MAINNET":"TESTNET",(0,a.getStarknetRpc)())}]);